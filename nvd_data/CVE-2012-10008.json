{
  "cve_id": "CVE-2012-10008",
  "github_data": {
    "repository": "uakfdotb/oneapp",
    "fix_commit": "5413ac804f1b09f9decc46a6c37b08352c49669c",
    "related_commits": [
      "5413ac804f1b09f9decc46a6c37b08352c49669c",
      "5413ac804f1b09f9decc46a6c37b08352c49669c"
    ],
    "patch_url": "https://github.com/uakfdotb/oneapp/commit/5413ac804f1b09f9decc46a6c37b08352c49669c.patch",
    "fix_commit_details": {
      "sha": "5413ac804f1b09f9decc46a6c37b08352c49669c",
      "commit_date": "2012-05-10T03:21:00Z",
      "author": {
        "login": "perennate",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "All users are now unified in the users table. Club and site administrators are determined by associations with groups in the user_groups table. Additionally, a few critical MySQL injection vulnerabilities are fixed in this revision.",
        "length": 232,
        "has_description": false,
        "references_issue": true
      },
      "stats": {
        "total": 836,
        "additions": 427,
        "deletions": 409
      },
      "files": [
        {
          "filename": "admin/comments.php",
          "status": "modified",
          "additions": 5,
          "deletions": 5,
          "patch": "@@ -5,15 +5,15 @@\n include(\"../include/session.php\");\n \n //check for $_REQUEST['id'] here because this page should never be accessed without an id set\n-if(isset($_SESSION['admin_id']) && $_REQUEST['id']) {\n-\t$club_id = escape(getAdminClub($_SESSION['admin_id']));\n-\t$admin_id = escape($_SESSION['admin_id']);\n+if(isset($_SESSION['admin']) && isset($_REQUEST['id'])) {\n+\t$club_id = $_SESSION['admin_club_id'];\n+\t$user_id = $_SESSION['user_id'];\n \t$app_id = escape($_REQUEST['id']);\n \t\n \tif($club_id != 0) {\n \t\t//retrieve and display comments (if not found in table, comments have not been set yet so default to blank)\n \t\t$current_comments = \"\";\n-\t\t$result = mysql_query(\"SELECT comments FROM club_notes WHERE application_id='$app_id' AND admin_id='$admin_id'\");\n+\t\t$result = mysql_query(\"SELECT comments FROM club_notes WHERE application_id='$app_id' AND user_id='$user_id'\");\n \t\tif($row = mysql_fetch_array($result)) {\n \t\t\t$current_comments = $row[0];\n \t\t}\n@@ -23,6 +23,6 @@\n \t\tget_page_advanced(\"index\", \"admin\", array('warning' => \"General application admin does not have comments!\"));\n \t}\n } else {\n-\theader('Location: index.php?error=' . urlencode(\"You are not logged in!\"));\n+\theader('Location: index.php');\n }\n ?>"
        },
        {
          "filename": "admin/easy_question.php",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -7,8 +7,8 @@\n include(\"../include/apply_gen.php\");\n include(\"../include/latex.php\");\n \n-if(isset($_SESSION['admin_id'])) {\n-\t$club_id = escape(getAdminClub($_SESSION['admin_id']));\n+if(isset($_SESSION['admin'])) {\n+\t$club_id = $_SESSION['admin_club_id'];\n \t\n \tif(isset($_REQUEST['type'])) {\n \t\tif(isset($_REQUEST['done'])) {"
        },
        {
          "filename": "admin/gen_pdf.php",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -7,8 +7,8 @@\n include(\"../include/apply_gen.php\");\n include(\"../include/latex.php\");\n \n-if(isset($_SESSION['admin_id'])) {\n-\t$club_id = escape(getAdminClub($_SESSION['admin_id']));\n+if(isset($_SESSION['admin'])) {\n+\t$club_id = $_SESSION['admin_club_id'];\n \tinclude(\"category_manager.php\"); //sets database and whereString based on club/category\n \t\n \t$message = \"\";"
        },
        {
          "filename": "admin/index.php",
          "status": "modified",
          "additions": 65,
          "deletions": 15,
          "patch": "@@ -8,28 +8,78 @@\n \t$error = $_REQUEST['error'];\n }\n \n-if(isset($_REQUEST['username']) && isset($_REQUEST['password'])) {\n-\t$checkResult = checkAdmin($_REQUEST['username'], $_REQUEST['password']);\n+if(!isset($_SESSION['admin']) && (isset($_SESSION['user_id']) || isset($_REQUEST['username'])) && isset($_REQUEST['password']) && isset($_REQUEST['club'])) {\n+\tif(!isset($_SESSION['user_id'])) {\n+\t\t//log in first\n+\t\t$loginResult = checkLogin($_REQUEST['username'], $_REQUEST['password']);\n+\t\t\n+\t\tif($result >= 0) {\n+\t\t\t$_SESSION['user_id'] = $loginResult;\n+\t\t} else if($result == -2) {\n+\t\t\t$error = \"Please try again later (you are locked out for too many failed attempts).\";\n+\t\t} else if($result == -3) {\n+\t\t\t$error = \"Login and registration are currently disabled.\";\n+\t\t} else if($result == -1) {\n+\t\t\t$error = \"Login information is not correct.\";\n+\t\t} else {\n+\t\t\t$error = \"Internal error!\";\n+\t\t}\n+\t}\n \t\n-\tif($checkResult !== FALSE) {\n-\t\t$_SESSION['admin_id'] = $checkResult;\n-\t} else {\n-\t\t$error = \"Incorrect username/password. You may be locked from your account. \";\n+\t//only continue if we haven't failed already\n+\tif(isset($_SESSION['user_id'])) {\n+\t\t$attempt_club_id = escape(intval($_REQUEST['club']));\n+\t\t$checkResult = checkAdminLogin($_SESSION['user_id'], $_REQUEST['password'], $attempt_club_id);\n+\t\t\n+\t\tif($checkResult === TRUE) {\n+\t\t\t$_SESSION['admin'] = true;\n+\t\t\t$_SESSION['admin_club_id'] = $attempt_club_id;\n+\t\t\t\n+\t\t\t//make sure a admin_notes_settings entry exists for this user\n+\t\t\t$result = mysql_query(\"SELECT COUNT(*) FROM admin_notes_settings WHERE user_id = '\" . $_SESSION['user_id'] . \"'\");\n+\t\t\t$row = mysql_fetch_row($result);\n+\t\t\n+\t\t\tif($row[0] == 0) {\n+\t\t\t\tmysql_query(\"INSERT INTO admin_notes_settings (user_id, box_enabled, cat_enabled, comment_enabled) VALUES ('\" . $_SESSION['user_id'] . \"', '0', '0', '0')\");\n+\t\t\t}\n+\t\t} else if($checkResult === -1) {\n+\t\t\t$error = \"Login information is not correct.\";\n+\t\t} else if($checkResult === -2) {\n+\t\t\t$error = \"Please try again later (you are locked out for too many failed attempts).\";\n+\t\t} else if($checkResult === 1) {\n+\t\t\t$error = \"Invalid club specified.\";\n+\t\t}\n \t}\n-} else if(isset($_REQUEST['action']) && isset($_SESSION['admin_id'])) {\n+} else if(isset($_REQUEST['action']) && isset($_SESSION['admin'])) {\n \tif($_REQUEST['action'] == 'logout') {\n-\t\t$success = \"You are now logged out.\";\n-\t\tsession_unset();\n+\t\t$success = \"You are now logged out of the club administration area.\";\n+\t\tunset($_SESSION['admin']);\n+\t\tunset($_SESSION['admin_club_id']);\n \t}\n }\n \n-if(isset($_SESSION['admin_id'])) {\n-\tget_page_advanced(\"index\", \"admin\");\n-} else if(isset($error)) {\n-\tget_page_advanced(\"index_login\", \"admin\", array('error' => $error));\n+$parameters = array();\n+\n+if(isset($error)) {\n+\t$parameters['error'] = $error;\n } else if(isset($success)) {\n-\tget_page_advanced(\"index_login\", \"admin\", array('success' => $success));\n+\t$parameters['success'] = $success;\n+}\n+\n+if(isset($_SESSION['admin'])) {\n+\tget_page_advanced(\"index\", \"admin\", $parameters);\n } else {\n-\tget_page_advanced(\"index_login\", \"admin\");\n+\tif(isset($_SESSION['user_id'])) {\n+\t\t$parameters['user_loggedin'] = true;\n+\t\t$parameters['clubs'] = getAdminClubs($_SESSION['user_id']);\n+\t} else {\n+\t\t$parameters['user_loggedin'] = false;\n+\t\t\n+\t\t//list normal clubs, and general application\n+\t\t$parameters['clubs'] = listClubsIdName();\n+\t\t$parameters['clubs'][0] = 'General application';\n+\t}\n+\t\n+\tget_page_advanced(\"index_login\", \"admin\", $parameters);\n }\n ?>"
        },
        {
          "filename": "admin/man_club.php",
          "status": "modified",
          "additions": 24,
          "deletions": 46,
          "patch": "@@ -4,65 +4,43 @@\n include(\"../include/db_connect.php\");\n include(\"../include/session.php\");\n \n-if(isset($_SESSION['admin_id'])) {\n-\t$club_id = escape(getAdminClub($_SESSION['admin_id']));\n-\t$admin_id = escape($_SESSION['admin_id']);\n+if(isset($_SESSION['admin'])) {\n+\t$club_id = $_SESSION['admin_club_id'];\n+\t$user_id = $_SESSION['user_id'];\n \t\n \tif($club_id != 0) {\n-\t\tif(isset($_REQUEST['action'])){\n-\t\t\t$currpass = mysql_query(\"SELECT password FROM admins WHERE id='\" . $_SESSION['admin_id'] . \"'\");\n-\t\t\t$currpass = mysql_fetch_array($currpass);\n-\t\t\tif($_REQUEST['old_password']==$currpass[0]){\n-\t\t\t\tif(isset($_REQUEST['description']) && isset($_REQUEST['view_time']) && isset($_REQUEST['open_time']) && isset($_REQUEST['close_time']) && isset($_REQUEST['user_type'])) {\n-\t\t\t\t\t$description = escape($_REQUEST['description']);\n-\t\t\t\t\t$view_time = strtotime($_REQUEST['view_time']);\n-\t\t\t\t\t$open_time = strtotime($_REQUEST['open_time']);\n-\t\t\t\t\t$close_time = strtotime($_REQUEST['close_time']);\n-\t\t\t\t\t$num_recommend = escape($_REQUEST['num_recommend']);\n-\t\t\t\t\t$user_type = escape($_REQUEST['user_type']);\n-\t\t\t\t\tif($user_type == \"Name\"){\n-\t\t\t\t\t\t$usernot = 1;\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\t$usernot = 0;\n-\t\t\t\t\t}\n-\t\t\n-\t\t\t\t\tmysql_query(\"UPDATE clubs SET description='$description', view_time='$view_time', open_time='$open_time', close_time='$close_time', num_recommend='$num_recommend' WHERE id='$club_id'\");\n-\t\t\t\t\t$success = \"Account Updated!\";\n-\t\t\t\t}\n-\t\t\t\tif(isset($_REQUEST['new_password'])) {\n-\t\t\t\t\t$changepass = changeAdminPass($admin_id,$_REQUEST['new_password'],$_REQUEST['new_password_conf']);\n-\t\t\t\t\tif($changepass == 1){\n-\t\t\t\t\t\t$success = \"Password Updated!\";\n-\t\t\t\t\t} else if($changepass == -2){\n-\t\t\t\t\t\t$error = \"New password does not match!\";\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\t$error = \"Invaid new password!\";\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\t\t\t} else {\n-\t\t\t\t$error = \"Incorrect password! If you have forgotten this password, contact your rood advisor.\";\n-\t\t\t}\n-\t\t} else {\n-\t\t\t$info = \"You need your current password to make any changes!\";\n+\t\tif(isset($_REQUEST['description']) && isset($_REQUEST['view_time']) && isset($_REQUEST['open_time']) && isset($_REQUEST['close_time'])) {\n+\t\t\t$description = escape($_REQUEST['description']);\n+\t\t\t$view_time = strtotime($_REQUEST['view_time']);\n+\t\t\t$open_time = strtotime($_REQUEST['open_time']);\n+\t\t\t$close_time = strtotime($_REQUEST['close_time']);\n+\t\t\t$num_recommend = escape($_REQUEST['num_recommend']);\n+\n+\t\t\tmysql_query(\"UPDATE clubs SET description='$description', view_time='$view_time', open_time='$open_time', close_time='$close_time', num_recommend='$num_recommend' WHERE id='$club_id'\");\n+\t\t\t$success = \"Club updated successfully.\";\n \t\t}\n \t\t\n-\t\t$result = mysql_query(\"SELECT c.name, a.email, c.description, c.view_time, c.open_time, c.close_time, c.num_recommend FROM clubs c, admins a WHERE c.id='$club_id' AND a.id='$admin_id'\");\n+\t\t$result = mysql_query(\"SELECT name, description, view_time, open_time, close_time, num_recommend FROM clubs WHERE id='$club_id'\");\n \t\n \t\tif($row = mysql_fetch_array($result)) {\n-\t\t\tif( isset($error) ) {\n-\t\t\t\tget_page_advanced(\"man_club\", \"admin\", array('error'=> $error, 'email' => $row['email'], 'club_name' => $row['name'], 'description' => $row['description'], 'view_time' => $row['view_time'], 'open_time' => $row['open_time'], 'close_time' => $row['close_time'], 'num_recommend' => $row['num_recommend']));\n+\t\t\t$parameters = array('club_name' => $row['name'], 'description' => $row['description'], 'view_time' => $row['view_time'], 'open_time' => $row['open_time'], 'close_time' => $row['close_time'], 'num_recommend' => $row['num_recommend']);\n+\t\t\t\n+\t\t\tif(isset($error)) {\n+\t\t\t\t$parameters['error'] = $error;\n \t\t\t} else if( isset($success) ){\n-\t\t\t\tget_page_advanced(\"man_club\", \"admin\", array('success' => $success, 'email' => $row['email'], 'club_name' => $row['name'], 'description' => $row['description'], 'view_time' => $row['view_time'], 'open_time' => $row['open_time'], 'close_time' => $row['close_time'], 'num_recommend' => $row['num_recommend']));\n+\t\t\t\t$parameters['success'] = $success;\n \t\t\t} else if( isset($info) ){\n-\t\t\t\tget_page_advanced(\"man_club\", \"admin\", array('info' => $info, 'email' => $row['email'], 'club_name' => $row['name'], 'description' => $row['description'], 'view_time' => $row['view_time'], 'open_time' => $row['open_time'], 'close_time' => $row['close_time'], 'num_recommend' => $row['num_recommend']));\n+\t\t\t\t$parameters['info'] = $info;\n \t\t\t} else if( isset($warning) ){\n-\t\t\t\tget_page_advanced(\"man_club\", \"admin\", array('warning' => $warning, 'email' => $row['email'], 'club_name' => $row['name'], 'description' => $row['description'], 'view_time' => $row['view_time'], 'open_time' => $row['open_time'], 'close_time' => $row['close_time'], 'num_recommend' => $row['num_recommend']));\n-\t\t\t} else {\n-\t\t\t\tget_page_advanced(\"man_club\", \"admin\", array('email' => $row['email'], 'club_name' => $row['name'], 'description' => $row['description'], 'view_time' => $row['view_time'], 'open_time' => $row['open_time'], 'close_time' => $row['close_time'], 'num_recommend' => $row['num_recommend']));\n+\t\t\t\t$parameters['warning'] = $warning;\n \t\t\t}\n+\t\t\t\n+\t\t\tget_page_advanced(\"man_club\", \"admin\", $parameters);\n \t\t} else {\n \t\t\tget_page_advanced(\"message\", \"admin\", array('message' => \"Error: your club cannot be found in the clubs table.\", 'title' => \"Manage Club\"));\n \t\t}\n+\t} else {\n+\t\t\tget_page_advanced(\"message\", \"admin\", array('message' => \"Error: general application does not have club settings.\", 'title' => \"Manage Club\"));\n \t}\n } else {\n \theader('Location: index.php?error=' . urlencode(\"You are not logged in!\"));"
        },
        {
          "filename": "admin/man_notes.php",
          "status": "modified",
          "additions": 9,
          "deletions": 9,
          "patch": "@@ -4,9 +4,9 @@\n include(\"../include/db_connect.php\");\n include(\"../include/session.php\");\n \n-if(isset($_SESSION['admin_id'])) {\n-\t$club_id = escape(getAdminClub($_SESSION['admin_id']));\n-\t$admin_id = escape($_SESSION['admin_id']);\n+if(isset($_SESSION['admin'])) {\n+\t$club_id = $_SESSION['admin_club_id'];\n+\t$user_id = $_SESSION['user_id'];\n \t\n \tif($club_id != 0) {\n \t\t//first, notes enabled/disabled settings\n@@ -15,11 +15,11 @@\n \t\t\t$cat_enabled = isset($_REQUEST['cat_enabled']) ? 1 : 0;\n \t\t\t$comment_enabled = isset($_REQUEST['comment_enabled']) ? 1 : 0;\n \t\t\t\n-\t\t\tmysql_query(\"UPDATE admins SET box_enabled = '$box_enabled', cat_enabled = '$cat_enabled', comment_enabled = '$comment_enabled' WHERE id = '\" . $_SESSION['admin_id'] . \"'\");\n+\t\t\tmysql_query(\"UPDATE admin_notes_settings SET box_enabled = '$box_enabled', cat_enabled = '$cat_enabled', comment_enabled = '$comment_enabled' WHERE user_id = '$user_id'\");\n \t\t\t$success = \"Note preferences updated successfully!\";\n \t\t}\n \t\t\n-\t\t$result = mysql_query(\"SELECT box_enabled, cat_enabled, comment_enabled FROM admins WHERE id='\" . $_SESSION['admin_id'] . \"'\");\n+\t\t$result = mysql_query(\"SELECT box_enabled, cat_enabled, comment_enabled FROM admin_notes_settings WHERE user_id='$user_id'\");\n \t\t\n \t\t$box_enabled = false;\n \t\t$cat_enabled = false;\n@@ -37,20 +37,20 @@\n \t\t\t$catName = escape($_REQUEST['name']);\n \t\t\t\n \t\t\tif($_REQUEST['action'] == \"delete\") {\n-\t\t\t\tmysql_query(\"DELETE FROM club_notes_categories WHERE admin_id = '$admin_id' AND name = '$catName'\");\n+\t\t\t\tmysql_query(\"DELETE FROM club_notes_categories WHERE club_id = '$club_id' AND name = '$catName'\");\n \t\t\t\t$success = \"Category deleted!\";\n \t\t\t} else if($_REQUEST['action'] == \"add\") {\n-\t\t\t\t$result = mysql_query(\"SELECT name FROM club_notes_categories WHERE admin_id = '$admin_id' AND name = '$catName'\");\n+\t\t\t\t$result = mysql_query(\"SELECT name FROM club_notes_categories WHERE club_id = '$club_id' AND name = '$catName'\");\n \t\t\t\tif($row = mysql_fetch_array($result)) {\n \t\t\t\t\t$error = \"Category already exists!\";\n \t\t\t\t} else {\n-\t\t\t\t\tmysql_query(\"INSERT INTO club_notes_categories (name, admin_id) VALUES ('$catName', '$admin_id')\");\n+\t\t\t\t\tmysql_query(\"INSERT INTO club_notes_categories (name, club_id) VALUES ('$catName', '$club_id')\");\n \t\t\t\t\t$success = \"Category added!\";\n \t\t\t\t}\n \t\t\t}\n \t\t}\n \t\t\n-\t\t$result = mysql_query(\"SELECT name FROM club_notes_categories WHERE admin_id = '$admin_id'\");\n+\t\t$result = mysql_query(\"SELECT name FROM club_notes_categories WHERE club_id = '$club_id'\");\n \t\t$categories = array();\n \t\t\n \t\twhile($row = mysql_fetch_array($result)) {"
        },
        {
          "filename": "admin/man_questions.php",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -7,8 +7,8 @@\n include(\"../include/apply_gen.php\");\n include(\"../include/apply_admin.php\");\n \n-if(isset($_SESSION['admin_id'])) {\n-\t$club_id = escape(getAdminClub($_SESSION['admin_id']));\n+if(isset($_SESSION['admin'])) {\n+\t$club_id = $_SESSION['admin_club_id'];\n \tinclude(\"category_manager.php\");\n \t\n \t$message = \"\";"
        },
        {
          "filename": "admin/preview.php",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -6,8 +6,8 @@\n \n include(\"../include/apply_gen.php\");\n \n-if(isset($_SESSION['admin_id'])) {\n-\t$club_id = escape(getAdminClub($_SESSION['admin_id']));\n+if(isset($_SESSION['admin'])) {\n+\t$club_id = $_SESSION['admin_club_id'];\n \tinclude(\"category_manager.php\");\n \t\n \t$result = mysql_query(\"SELECT varname, vardesc, vartype FROM $database WHERE $whereString ORDER BY orderId\");"
        },
        {
          "filename": "admin/statistics.php",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -7,8 +7,8 @@\n include(\"../include/apply_gen.php\");\n include(\"../include/statistics.php\");\n \n-if(isset($_SESSION['admin_id'])) {\n-\t$club_id = escape(getAdminClub($_SESSION['admin_id']));\n+if(isset($_SESSION['admin'])) {\n+\t$club_id = $_SESSION['club_id'];\n \t\n \t$adminStat = adminStatistics($club_id);\n \t$responseStat = responseStatistics($club_id, true, 8);"
        },
        {
          "filename": "admin/user_detail.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -4,7 +4,7 @@\n include(\"../include/db_connect.php\");\n include(\"../include/session.php\");\n \n-if(isset($_SESSION['admin_id']) && isset($_REQUEST['id'])) {\n+if(isset($_SESSION['admin']) && isset($_REQUEST['id'])) {\n \t//todo: admins currently can get information of users that didn't apply to their club\n \t$user_id = escape($_REQUEST['id']);\n \t$userinfo = getUserInformation($user_id); //userinfo is array(username, email)"
        },
        {
          "filename": "admin/view_recommendation.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -4,7 +4,7 @@\n include(\"../include/db_connect.php\");\n include(\"../include/session.php\");\n \n-if(isset($_SESSION['admin_id']) && isset($_REQUEST['peer_pdf']) && isset($_REQUEST['user_id'])) {\n+if(isset($_SESSION['admin']) && isset($_REQUEST['peer_pdf']) && isset($_REQUEST['user_id'])) {\n \t//todo: admins can see any peer recommendations if they know the user ID\n \t$peer_pdf = escape($_REQUEST['peer_pdf']);\n \t$user_id = escape($_REQUEST['user_id']);"
        },
        {
          "filename": "admin/view_submit.php",
          "status": "modified",
          "additions": 9,
          "deletions": 8,
          "patch": "@@ -6,14 +6,15 @@\n \n include(\"../include/apply_submit.php\");\n \n-if(isset($_SESSION['admin_id'])) {\n-\t$club_id = escape(getAdminClub($_SESSION['admin_id']));\n-\t$admin_id = escape($_SESSION['admin_id']);\n+if(isset($_SESSION['admin'])) {\n+\t$club_id = $_SESSION['admin_club_id'];\n+\t$user_id = $_SESSION['user_id'];\n \t\n \tif($club_id != 0) {\n \t\t//check if this admin is using textboxes and categories\n-\t\t$result = mysql_query(\"SELECT box_enabled, cat_enabled, comment_enabled FROM admins WHERE id='\" . escape($_SESSION['admin_id']) . \"'\");\n+\t\t$result = mysql_query(\"SELECT box_enabled, cat_enabled, comment_enabled FROM admin_notes_settings WHERE user_id='$user_id'\");\n \t\t$row = mysql_fetch_array($result);\n+\t\t\n \t\t$box_enabled = ($row['box_enabled'] == 1) ? true : false;\n \t\t$cat_enabled = ($row['cat_enabled'] == 1) ? true : false;\n \t\t$comment_enabled = ($row['comment_enabled'] == 1) ? true : false;\n@@ -27,7 +28,7 @@\n \t\t//we will need to construct a map from the application database IDs to the box and category note values if enabled\n \t\t// we do this now so that we can check if an entry exists already for updating the notes table\n \t\tif($box_enabled || $cat_enabled || $comment_enabled) {\n-\t\t\t$toolsResult = mysql_query(\"SELECT application_id, box, category, comments FROM club_notes WHERE admin_id = '$admin_id'\");\n+\t\t\t$toolsResult = mysql_query(\"SELECT application_id, box, category, comments FROM club_notes WHERE club_id = '$club_id'\");\n \t\n \t\t\twhile($row = mysql_fetch_array($toolsResult)) {\n \t\t\t\t$toolsMap[$row['application_id']] = array($row['box'], $row['category'], $row['comments']);\n@@ -46,7 +47,7 @@\n \t\t\t\t\t//if the tools map does not contain the ID, then we have to add it to database\n \t\t\t\t\tif(!isset($toolsMap[$application_id])) {\n \t\t\t\t\t\t$toolsMap[$application_id] = array('', '');\n-\t\t\t\t\t\tmysql_query(\"INSERT INTO club_notes (application_id, admin_id) VALUES ('$application_id', '$admin_id')\");\n+\t\t\t\t\t\tmysql_query(\"INSERT INTO club_notes (application_id, club_id) VALUES ('$application_id', '$club_id')\");\n \t\t\t\t\t}\n \t\t\t\t\n \t\t\t\t\t//now we check what needs to be updated\n@@ -71,7 +72,7 @@\n \t\t\t\n \t\t\t\t\tif(strlen($updateString) > 0) {\n \t\t\t\t\t\t$updateString = substr($updateString, 0, -2);\n-\t\t\t\t\t\tmysql_query(\"UPDATE club_notes SET $updateString WHERE application_id='$application_id' AND admin_id='$admin_id'\");\n+\t\t\t\t\t\tmysql_query(\"UPDATE club_notes SET $updateString WHERE application_id='$application_id' AND club_id='$club_id'\");\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t}\n@@ -95,7 +96,7 @@\n \t\t//category filter manager\n \t\tif($cat_enabled) {\n \t\t\t//first, we retrieve a list of categories (this will be used in dropdown as well)\n-\t\t\t$catResult = mysql_query(\"SELECT name FROM club_notes_categories WHERE admin_id = '$admin_id'\");\n+\t\t\t$catResult = mysql_query(\"SELECT name FROM club_notes_categories WHERE club_id = '$club_id'\");\n \t\n \t\t\twhile($row = mysql_fetch_array($catResult)) {\n \t\t\t\tarray_push($catList, $row[0]);"
        },
        {
          "filename": "astyle/one/admin/index_login.php",
          "status": "modified",
          "additions": 11,
          "deletions": 1,
          "patch": "@@ -1,6 +1,6 @@\n <h1>Administrator Page</h1>\n \n-<p>Log in with the administrator username and password. These are added through <b>Admin Management</b> in the root administration section. If you do not know your username and password, then you should contact your root administrator.</p>\n+<p>Use the form below to log in to the club administration area.</p>\n \n <div id=\"admin_table\">\n <div id=\"admin_login\">\n@@ -10,14 +10,24 @@\n \n \t<form method=\"POST\" action=\"index.php\">\n \t<table>\n+\t<? if(!$user_loggedin) { ?>\n \t<tr id=\"admin_username\">\n \t<td><p id=\"admin_username\" align=\"right\">Username:</p></td>\n \t<td><input type=\"text\" name=\"username\"/></td>\n \t</tr>\n+\t<? } ?>\n \t<tr id=\"admin_password\">\n \t<td><p id=\"admin_password\" align=\"right\">Password:</p></td>\n \t<td><input type=\"password\" name=\"password\"/></td>\n \t</tr>\n+\t<tr id=\"admin_username\">\n+\t<td><p id=\"admin_username\" align=\"right\">Club:</p></td>\n+\t<td><select name=\"club\">\n+\t\t<? foreach($clubs as $club_id => $club_name) { ?>\n+\t\t\t<option value=\"<?= $club_id ?>\"><?= $club_name ?></option>\n+\t\t<? } ?>\n+\t</select></td>\n+\t</tr>\n \t<tr id=\"admin_submit\">\n \t<td colspan=\"2\" align=\"right\"><input type=\"submit\" value=\"Submit\" align=\"center\"/></td>\n \t</tr>"
        },
        {
          "filename": "astyle/one/admin/man_club.php",
          "status": "modified",
          "additions": 0,
          "deletions": 1,
          "patch": "@@ -15,7 +15,6 @@\n <tr><td><p>Open time</p></td><td><input type=\"text\" id=\"open_time\" name=\"open_time\" value=\"<?= date('m/d/y H:i:s', $open_time) ?>\" /><img src=\"<?= $stylePath ?>/datetimepicker/images/cal.gif\" onclick=\"javascript:NewCssCal('open_time', 'MMddyyyy', 'arrow', true)\" style=\"cursor:pointer\"/></td></tr>\n <tr><td><p>Close time</p></td><td><input type=\"text\" id=\"close_time\" name=\"close_time\" value=\"<?= date('m/d/y H:i:s', $close_time) ?>\" /><img src=\"<?= $stylePath ?>/datetimepicker/images/cal.gif\" onclick=\"javascript:NewCssCal('close_time', 'MMddyyyy', 'arrow', true)\" style=\"cursor:pointer\"/></td></tr>\n <tr><td><p>Number of recommenations</p></td><td><input type=\"text\" name=\"num_recommend\" value=\"<?= $num_recommend ?>\" /></td></tr>\n-<tr><td><p>Update Password</p></td><td><input type=\"password\" name=\"new_password\"></td></tr>\n <tr><td colspan =\"2\" align=\"right\"><input type=\"submit\" value=\"Update\" /></td></tr>\n </table>\n </form>"
        },
        {
          "filename": "astyle/one/root/index_login.php",
          "status": "modified",
          "additions": 5,
          "deletions": 2,
          "patch": "@@ -3,6 +3,9 @@\n <p>Please login with your root password to access the root administration area. Your root password can be reset manually in config.php.</p>\n \n <form method=\"POST\" action=\"index.php\">\n-Password: <input type=\"password\" name=\"password\"><br>\n-<input type=\"submit\" name=\"submit\" value=\"Submit\">\n+<? if(!$user_loggedin) { ?>\n+Username: <input type=\"text\" name=\"username\" /><br />\n+<? } ?>\n+Password: <input type=\"password\" name=\"password\" /><br />\n+<input type=\"submit\" name=\"submit\" value=\"Submit\" />\n </form>"
        },
        {
          "filename": "astyle/one/root/man_admins.php",
          "status": "modified",
          "additions": 18,
          "deletions": 44,
          "patch": "@@ -16,28 +16,15 @@\n \t<td align=\"right\"><p class=\"admin_table_entry\">Admin username</p></td>\n \t<td><input type=\"text\" name=\"username\" style=\"width:100%\"></td>\n </tr>\n-<tr>\n-\t<td align=\"right\"><p class=\"admin_table_entry\">Password</p></td>\n-\t<td><input type=\"password\" name=\"password\" style=\"width:100%\"></td>\n-</tr>\n-<tr>\n-\t<td align=\"right\"><p class=\"admin_table_entry\">Email address</p></td>\n-\t<td><input type=\"text\" name=\"email\" style=\"width:100%\"></td>\n-</tr>\n <tr>\n \t<td align=\"right\"><p class=\"admin_table_entry\">Club</p></td>\n \t<td><select name=\"club_id\">\n-\t\t\t<option value=\"0\">General Application</option>\n \t\t<?\n-\t\t\t\n-\t\t\t$result = mysql_query(\"SELECT id, name FROM clubs ORDER BY name\");\n-\n-\t\t\twhile($row = mysql_fetch_array($result))\n-\t\t\t  {\n-\t\t\t\techo \"<option value=\\\"\".$row['id'].\"\\\">\".$row['name'].\"</option>\";\n-\t\t\t  }\n-\n+\t\t\tforeach($clubsList as $club_id => $club_name) {\n+\t\t\t\techo \"<option value=\\\"\" . $club_id . \"\\\">\" . $club_name . \"</option>\";\n+ \t\t\t}\n \t\t?>\n+\t\t<option value=\"0\">General Application</option>\n \t</select></td>\n </tr>\n <tr><td align=\"right\" colspan=\"2\"><input type=\"submit\" value=\"Add admin\"></td></tr>\n@@ -46,55 +33,42 @@\n \n <table width=100%>\n <tr>\n-\t<th><p class=\"admin_table_header\">Club ID</th></p>\n+\t\n \t<th><p class=\"admin_table_header\">Username</p></th>\n-\t<th><p class=\"admin_table_header\">Email</p></th>\n-\t<th><p class=\"admin_table_header\">Change pass</p></th>\n+\t<th><p class=\"admin_table_header\">Club</p></th>\n \t<th><p class=\"admin_table_header\">Update</p></th>\n-\t<th><p class=\"admin_table_header\">Delete</p></th>\n+\t<th><p class=\"admin_table_header\">Remove</p></th>\n </tr>\n \n <?\n foreach($adminList as $item) {\n ?>\n \t<form method=\"post\" action=\"man_admins.php\">\n \t<input type=\"hidden\" name=\"id\" value=\"<?= $item[0] ?>\">\n+\t<input type=\"hidden\" name=\"club_id_orig\" value=\"<?= $item[1] ?>\">\n \t<tr>\n+\t\t<td><input type=\"text\" name=\"username\" value=\"<?= $item[2] ?>\" style=\"width:100%\"></td>\n \t\t<td><select name=\"club_id\" style=\"width:100%\">\n \t\t\t\t\t\t<option value=\"<?= $item[1] ?>\">\n \t\t\t<?\n \t\t\t\tif ($item[1] == 0) {\n-\t\t\t\t   echo \"General App\";\n-\t\t\t\t}\n-\t\t\t\telse {\n-\t\t\t\t\t $result = mysql_query(\"SELECT id, name FROM clubs WHERE id = '$item[1]'\");\n-\t\t\t\t\t $row = mysql_fetch_array($result);\n-\t\t\t\t\t echo $row['name'];\n+\t\t\t\t   echo \"General Application\";\n+\t\t\t\t} else {\n+\t\t\t\t\t echo $clubsList[$item[1]];\n \t\t\t\t}\n \t\t\t?>\n \t\t\t</option>\n \t\t\t\t<?\n-\n-\t\t\t\t\t$result = mysql_query(\"SELECT id, name FROM clubs ORDER BY name\");\n-\n-\t\t\t\t\twhile($row = mysql_fetch_array($result)) {\n-\t\t\t\t\t\tif ($row['id']!=$item[1]) {\n-\t\t\t\t\t\t\techo \"<option value=\\\"\".$row['id'].\"\\\">\".$row['name'].\"</option>\";\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\n-\t\t\t\t\tif ($item[1] > 0) {\n-\t\t\t\t\t   echo \"<option value=\\\"0\\\">General Application</option>\";\n-\t\t\t\t\t}\n-\n+\t\t\t\tforeach($clubsList as $club_id => $club_name) {\n+\t\t\t\t\techo \"<option value=\\\"\" . $club_id . \"\\\">\" . $club_name . \"</option>\";\n+ \t\t\t\t}\n+ \t\t\t\t\n+ \t\t\t\techo \"<option value=\\\"0\\\">General Application</option>\";\n \t\t\t\t?>\n </select>\n </td>\n-\t\t<td><input type=\"text\" name=\"username\" value=\"<?= $item[2] ?>\" style=\"width:100%\"></td>\n-\t\t<td><input type=\"text\" name=\"email\" value=\"<?= $item[3] ?>\" style=\"width:100%\"></td>\n-\t\t<td><input type=\"password\" name=\"password\" style=\"width:100%\"></td>\n \t\t<td><input type=\"submit\" name=\"action\" value=\"update\"></td>\n-\t\t<td><input type=\"submit\" name=\"action\" value=\"delete\"></td>\n+\t\t<td><input type=\"submit\" name=\"action\" value=\"remove\"></td>\n \t</tr>\n \t</form>\n <?"
        },
        {
          "filename": "astyle/two/admin/index_login.php",
          "status": "modified",
          "additions": 10,
          "deletions": 0,
          "patch": "@@ -4,14 +4,24 @@\n <br />\n <table width=60% class=\"log_in\">\n \t<form method=\"POST\" action=\"index.php\">\n+\t<? if(!$user_loggedin) { ?>\n \t<tr>\n \t\t<td width=20%><p class=\"name\">Username</p></td>\n \t\t<td align=\"right\"><input type=\"text\" name=\"username\"/></td>\n \t</tr>\n+\t<? } ?>\n \t<tr>\n \t\t<td><p class=\"name\">Password</p></td>\n \t\t<td align=\"right\"><input type=\"password\" name=\"password\"/></td>\n \t</tr>\n+\t<tr>\n+\t\t<td><p class=\"name\">Club:</p></td>\n+\t\t<td align=\"right\"><select name=\"club\">\n+\t\t<? foreach($clubs as $club_id => $club_name) { ?>\n+\t\t\t<option value=\"<?= $club_id ?>\"><?= $club_name ?></option>\n+\t\t<? } ?>\n+\t\t</select></td>\n+\t</tr>\n \t<tr class=\"club_info\">\n \t\t<td colspan=\"2\" align=\"right\"><input type=\"submit\" value=\"Log In\" class=\"positive\"/></td>\n \t</tr>"
        },
        {
          "filename": "astyle/two/root/index_login.php",
          "status": "modified",
          "additions": 3,
          "deletions": 0,
          "patch": "@@ -4,6 +4,9 @@\n \n <form method=\"POST\" action=\"index.php\">\n <table class=\"center\"><tr>\n+<? if(!$user_loggedin) { ?>\n+<td>Username <input type=\"text\" name=\"username\" /></td>\n+<? } ?>\n <td>Password <input type=\"password\" name=\"password\"></td>\n <td><input type=\"submit\" name=\"submit\" value=\"Submit\"></td>\n </tr></table>"
        },
        {
          "filename": "astyle/two/root/man_admins.php",
          "status": "modified",
          "additions": 18,
          "deletions": 41,
          "patch": "@@ -10,26 +10,15 @@\n \t<td style=\"padding-right:10px\">Admin username</td>\n \t<td><input type=\"text\" name=\"username\"></td>\n </tr>\n-<tr>\n-\t<td>Password</p></td>\n-\t<td><input type=\"password\" name=\"password\"></td>\n-</tr>\n-<tr>\n-\t<td>Email address</td>\n-\t<td><input type=\"text\" name=\"email\"></td>\n-</tr>\n <tr>\n \t<td>Club</td>\n \t<td><select name=\"club_id\">\n-\t\t<option value=\"0\">General Application</option>\n \t\t<?\n-\t\t\t$result = mysql_query(\"SELECT id, name FROM clubs ORDER BY name\");\n-\n-\t\t\twhile($row = mysql_fetch_array($result))\n-\t\t\t{\n-\t\t\t\techo \"<option value=\\\"\".$row['id'].\"\\\">\".$row['name'].\"</option>\";\n+\t\t\tforeach($clubsList as $club_id => $club_name) {\n+\t\t\t\techo \"<option value=\\\"\" . $club_id . \"\\\">\" . $club_name . \"</option>\";\n \t\t\t}\n \t\t?>\n+\t\t<option value=\"0\">General Application</option>\n \t</select></td>\n </tr>\n <tr>\n@@ -54,10 +43,8 @@ function OnBlurInput (input) {\n \n <table class=\"tbl_repeat\">\n <tr>\n-\t<th>Club</th>\n \t<th align=\"left\">Username</th>\n-\t<th align=\"left\">Email</th>\n-\t<th align=\"left\">Change pass</th>\n+\t<th>Club</th>\n \t<th></th>\n \t<th></th>\n </tr>\n@@ -67,41 +54,31 @@ function OnBlurInput (input) {\n ?>\n \t<form method=\"post\" action=\"man_admins.php\">\n \t<input type=\"hidden\" name=\"id\" value=\"<?= $item[0] ?>\">\n+\t<input type=\"hidden\" name=\"club_id_orig\" value=\"<?= $item[1] ?>\">\n \t<tr>\n+\t\t<td><input class=\"slide\" onfocus=\"OnFocusInput (this)\" onblur=\"OnBlurInput (this)\" type=\"text\" name=\"username\" value=\"<?= $item[2] ?>\"></td>\n \t\t<td><select name=\"club_id\">\n \t\t\t<option value=\"<?= $item[1] ?>\">\n \t\t\t<?\n \t\t\t\tif ($item[1] == 0) {\n-\t\t\t\t   echo \"General App\";\n-\t\t\t\t}\n-\t\t\t\telse {\n-\t\t\t\t\t//todo: terribly inefficient\n-\t\t\t\t\t$result = mysql_query(\"SELECT id, name FROM clubs WHERE id = '$item[1]'\");\n-\t\t\t\t\t$row = mysql_fetch_array($result);\n-\t\t\t\t\techo $row['name'];\n+\t\t\t\t   echo \"General Application\";\n+\t\t\t\t} else {\n+\t\t\t\t\techo $clubsList[$item[1]];\n \t\t\t\t}\n \t\t\t?>\n \t\t\t</option>\n-\t\t\n+\t\t\t\n \t\t\t<?\n-\t\t\t\t$result = mysql_query(\"SELECT id, name FROM clubs ORDER BY name\");\n-\n-\t\t\t\twhile($row = mysql_fetch_array($result)) {\n-\t\t\t\t\tif ($row['id']!=$item[1]) {\n-\t\t\t\t\t\techo \"<option value=\\\"\" . $row['id'] . \"\\\">\" . $row['name'] . \"</option>\";\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\t\t\t\tif ($item[1] > 0) {\n-\t\t\t\t   echo \"<option value=\\\"0\\\">General Application</option>\";\n+\t\t\t\tforeach($clubsList as $club_id => $club_name) {\n+\t\t\t\t\techo \"<option value=\\\"\" . $club_id . \"\\\">\" . $club_name . \"</option>\";\n \t\t\t\t}\n+\n+\t\t\t\techo \"<option value=\\\"0\\\">General Application</option>\";\n \t\t\t?>\n-\t\t\t</select>\n-\t\t\t</td>\n-\t\t\t<td><input class=\"slide\" onfocus=\"OnFocusInput (this)\" onblur=\"OnBlurInput (this)\" type=\"text\" name=\"username\" value=\"<?= $item[2] ?>\"></td>\n-\t\t\t<td><input class=\"slide\" onfocus=\"OnFocusInput (this)\" onblur=\"OnBlurInput (this)\" type=\"text\" name=\"email\" value=\"<?= $item[3] ?>\" size=\"10\"></td>\n-\t\t\t<td><input class=\"slide\" onfocus=\"OnFocusInput (this)\" onblur=\"OnBlurInput (this)\" type=\"password\" name=\"password\"></td>\n-\t\t\t<td><input type=\"submit\" name=\"action\" value=\"Update\" class=\"update\"></td>\n-\t\t\t<td><input type=\"submit\" name=\"action\" value=\"Delete\" class=\"delete negative\"></td>\n+\t\t</select>\n+\t\t</td>\n+\t\t<td><input type=\"submit\" name=\"action\" value=\"Update\" class=\"update\"></td>\n+\t\t<td><input type=\"submit\" name=\"action\" value=\"Remove\" class=\"delete negative\"></td>\n \t\t</tr>\n \t\t</tr>\n \t</form>"
        },
        {
          "filename": "include/common.php",
          "status": "modified",
          "additions": 119,
          "deletions": 101,
          "patch": "@@ -514,7 +514,7 @@ function updateAccount($user_id, $oldPassword, $newPassword, $newPasswordConfirm\n \n //user id: success; -1: invalid login; -2: try again later; -3: login disabled\n function checkLogin($username, $password) {\n-\tif(!lockAction(\"checkuser\")) {\n+\tif(!checkLock(\"checkuser\")) {\n \t\treturn -2;\n \t}\n \t\n@@ -536,9 +536,11 @@ function checkLogin($username, $password) {\n \t\t\t\n \t\t\treturn $row['id'];\n \t\t} else {\n+\t\t\tlockAction(\"checkuser\");\n \t\t\treturn -1;\n \t\t}\n \t} else {\n+\t\tlockAction(\"checkuser\");\n \t\treturn -1;\n \t}\n }\n@@ -572,23 +574,22 @@ function getProfile($userid) {\n \treturn $profile;\n }\n \n-//returns array (username, email address, name)\n-function getUserInformation($user_id) {\n-\t$user_id = escape($user_id);\n-\t$result = mysql_query(\"SELECT username, email, name FROM users WHERE id='$user_id'\");\n+//returns user_id, or FALSE on failure\n+function getUserId($username) {\n+\t$username = escape($username);\n+\t$result = mysql_query(\"SELECT id FROM users WHERE username = '$username'\");\n \t\n-\tif($row = mysql_fetch_array($result)) {\n-\t\treturn array($row[0], $row[1], $row[2]);\n+\tif($row = mysql_fetch_row($result)) {\n+\t\treturn $row[0];\n \t} else {\n \t\treturn FALSE;\n \t}\n }\n \n-//returns array (username, email address, club name)\n-function getAdminInformation($admin_id) {\n-\t$admin_id = escape($admin_id);\n-\t$club_id = getAdminClub($admin_id);\n-\t$result = mysql_query(\"SELECT a.username, a.email, c.name FROM admins a, clubs c WHERE a.id='$admin_id' AND c.id='$club_id'\");\n+//returns array (username, email address, name)\n+function getUserInformation($user_id) {\n+\t$user_id = escape($user_id);\n+\t$result = mysql_query(\"SELECT username, email, name FROM users WHERE id='$user_id'\");\n \t\n \tif($row = mysql_fetch_array($result)) {\n \t\treturn array($row[0], $row[1], $row[2]);\n@@ -599,7 +600,7 @@ function getAdminInformation($admin_id) {\n \n //true: success; -1: invalid login; -2: try again later\n function verifyLogin($user_id, $password) {\n-\tif(!lockAction(\"checkuser\")) {\n+\tif(!checkLock(\"checkuser\")) {\n \t\treturn -2;\n \t}\n \t\n@@ -612,124 +613,129 @@ function verifyLogin($user_id, $password) {\n \t\tif($password == $row['password']) {\n \t\t\treturn true;\n \t\t} else {\n+\t\t\tlockAction(\"checkuser\");\n \t\t\treturn -1;\n \t\t}\n \t} else {\n+\t\tlockAction(\"checkuser\");\n \t\treturn -1;\n \t}\n }\n \n-function addAdmin($username, $password, $email, $club_id) {\n-\t$username = escape($username);\n-\t$password = escape(chash($password));\n-\t$email = escape($email);\n+//true: success; -1: invalid login; -2: try again later; 1: invalid club\n+function checkAdminLogin($user_id, $password, $club_id) {\n+\t$user_id = escape($user_id);\n \t$club_id = escape($club_id);\n-\t\n-\t$result = mysql_query(\"INSERT INTO admins (username, password, email, club_id) VALUES ('$username', '$password', '$email', '$club_id')\");\n-}\n-\n-function updateAdmin($admin_id, $username, $password, $email, $club_id) {\n-\t$admin_id = escape($admin_id);\n-\t$setString = \"\";\n-\t\n-\tif(strlen($username) > 0) {\n-\t\t$setString .= \", username = '\" . escape($username) . \"'\";\n-\t}\n-\t\n-\tif(strlen($password) > 0) {\n-\t\t$setString .= \", password = '\" . escape(chash($password)) . \"'\";\n-\t}\n-\t\n-\tif(strlen($email) > 0) {\n-\t\t$setString .= \", email = '\" . escape($email) . \"'\";\n-\t}\n-\t\n-\tif(strlen($club_id) > 0) {\n-\t\t$setString .= \", club_id = '\" . escape($club_id) . \"'\";\n-\t}\n-\t\n-\tif(strlen($setString) > 0) {\n-\t\t$setString = substr($setString, 2);\n-\t\t$result = mysql_query(\"UPDATE admins SET $setString WHERE id='$admin_id'\");\n-\t}\n-}\n \n-function checkAdmin($username, $password) {\n-\tif(!checkLock(\"checkadmin\")) {\n-\t\treturn FALSE;\n-\t}\n+\t//first verify login information\n+\t$login_result = verifyLogin($user_id, $password);\n \t\n-\t$username = escape($username);\n-\t$password = escape(chash($password));\n-\t\n-\t$result = mysql_query(\"SELECT id, password FROM admins WHERE username='\" . $username . \"'\");\n-\t\n-\tif($row = mysql_fetch_array($result)) {\n-\t\tif(strcmp($password, $row['password']) == 0) {\n-\t\t\treturn $row['id'];\n+\tif($login_result === TRUE) {\n+\t\t//check that admin owns the club\n+\t\t$result = mysql_query(\"SELECT COUNT(*) FROM user_groups WHERE user_id = '$user_id' AND `group` = '$club_id' AND `group` >= '0'\");\n+\t\t$row = mysql_fetch_row($result);\n+\t\t\n+\t\tif($row[0] == 0) {\n+\t\t\treturn 1;\n \t\t} else {\n-\t\t\tlockAction(\"checkadmin\");\n-\t\t\treturn FALSE;\n+\t\t\treturn TRUE;\n \t\t}\n \t} else {\n-\t\tlockAction(\"checkadmin\");\n-\t\treturn FALSE;\n+\t\treturn $login_result;\n \t}\n }\n \n-//returns admin ID, or false on failure\n-function getAdminClub($admin_id) {\n-\t$admin_id = escape($admin_id);\n-\t$result = mysql_query(\"SELECT club_id FROM admins WHERE id='$admin_id'\");\n+//true: success; -1: invalid login; -2: try again later; 1: not root administrator\n+function checkRootLogin($user_id, $password) {\n+\t$user_id = escape($user_id);\n+\n+\t//first verify login information\n+\t$login_result = verifyLogin($user_id, $password);\n \t\n-\tif($row = mysql_fetch_array($result)) {\n-\t\treturn $row[0];\n+\tif($login_result === TRUE) {\n+\t\t//check that admin is a root administrator\n+\t\t$result = mysql_query(\"SELECT COUNT(*) FROM user_groups WHERE `group` = '-1' AND user_id = '$user_id'\");\n+\t\t$row = mysql_fetch_row($result);\n+\t\t\n+\t\tif($row[0] == 0) {\n+\t\t\treturn 1;\n+\t\t} else {\n+\t\t\treturn TRUE;\n+\t\t}\n \t} else {\n-\t\treturn FALSE;\n+\t\treturn $login_result;\n \t}\n }\n \n-function checkRoot($password) {\n-\tif(!checkLock(\"root\")) {\n-\t\treturn FALSE;\n-\t}\n+//returns list of club_id => club_name that admin can manage, or empty list of none\n+function getAdminClubs($user_id) {\n+\t$user_id = escape($user_id);\n \t\n-\t$config = $GLOBALS['config'];\n+\t//first add regular clubs\n+\t$result = mysql_query(\"SELECT `group`, clubs.name FROM user_groups LEFT JOIN clubs ON clubs.id = `group` WHERE user_id='$user_id' AND `group` > '0'\");\n \t\n-\t$root_password = $config['root_password'];\n-\tif(substr($root_password, 0, 1) == ':') { //rest of root password is actually a hash\n-\t\t$root_password = substr($root_password, 1);\n-\t\t$password = chash($config['root_password_salt'] . $password);\n+\t$clubs_array = array();\n+\t\n+\twhile($row = mysql_fetch_row($result)) {\n+\t\t$clubs_array[$row[0]] = $row[1];\n \t}\n \t\n-\tif($password == $root_password) {\n-\t\treturn true;\n-\t} else {\n-\t\tlockAction(\"root\");\n-\t\treturn false;\n+\t//add general application if needed\n+\t$result = mysql_query(\"SELECT COUNT(*) FROM user_groups WHERE user_id =' $user_id' AND `group` = '0'\");\n+\t$row = mysql_fetch_row($result);\n+\t\n+\tif($row[0] > 0) {\n+\t\t$clubs_array[0] = 'General application';\n \t}\n+\t\n+\treturn $clubs_array;\n }\n \n-//1: success; -1: invalid password\n-function changeAdminPassword($admin_id, $password){\n-\tif(validPassword($password) != 0) {\n-\t\treturn -1;\n-\t} else {\n-\t\tmysql_query(\"UPDATE admins SET password = '\" . escape(chash($password)) . \"' WHERE id='\" . $admin_id . \"'\");\n-\t\treturn 1;\n+//can be used to add, remove, or alter a user group association\n+// if club_id = -1 or association doesn't exist, association will be added\n+// if new_club_id = -1, association will be removed\n+// otherwise, association will be altered\n+//returns TRUE in success, FALSE on failure\n+function alterAdminClubs($user_id, $club_id, $new_club_id) {\n+\t$user_id = escape($user_id);\n+\t$club_id = escape($club_id);\n+\t$new_club_id = escape($new_club_id);\n+\t\n+\t$old_association = FALSE;\n+\t\n+\t//verify existing association\n+\tif($club_id != -1) {\n+\t\t$result = mysql_query(\"SELECT COUNT(*) FROM user_groups WHERE user_id = '$user_id' AND `group` = '$club_id'\");\n+\t\t$row = mysql_fetch_row($result);\n+\t\t\n+\t\tif($row[0] > 0) {\n+\t\t\t$old_association = TRUE;\n+\t\t}\n \t}\n-}\n-\n-//1: success; -1: invalid password, -2 password doesnt match\n-function changeAdminPass($admin_id, $password, $verify){\n-\tif($password != $verify){\n-\t\treturn -2;\n-\t} else if(validPassword($password) != 0) {\n-\t\treturn -1;\n-\t} else {\n-\t\tmysql_query(\"UPDATE admins SET password = '\" . escape(chash($password)) . \"' WHERE id='\" . $admin_id . \"'\");\n-\t\treturn 1;\n+\t\n+\t//invalidate new_club_id if it exists already\n+\t// in this case, we just delete club_id association\n+\tif($new_club_id != -1) {\n+\t\t$result = mysql_query(\"SELECT COUNT(*) FROM user_groups WHERE user_id = '$user_id' AND `group` = '$new_club_id'\");\n+\t\t$row = mysql_fetch_row($result);\n+\t\t\n+\t\tif($row[0] > 0) {\n+\t\t\t$new_club_id = -1;\n+\t\t}\n+\t}\n+\t\n+\tif($old_association) {\n+\t\t//update or delete existing association\n+\t\tif($new_club_id == -1) {\n+\t\t\tmysql_query(\"DELETE FROM user_groups WHERE user_id = '$user_id' AND `group` = '$club_id'\");\n+\t\t} else {\n+\t\t\tmysql_query(\"UPDATE user_groups SET `group` = '$new_club_id' WHERE user_id = '$user_id' AND `group` = '$club_id'\");\n+\t\t}\n+\t} else if($new_club_id != -1) { //only add an association if we're not trying to delete it!\n+\t\tmysql_query(\"INSERT INTO user_groups (user_id, `group`) VALUES ('$user_id', '$new_club_id')\");\n \t}\n+\t\n+\treturn TRUE;\n }\n \n //returns array of (club id, club name, club description, user's application id)\n@@ -771,6 +777,18 @@ function clubInfo($club_id) {\n \t}\n }\n \n+//returns array of club_id => club_name\n+function listClubsIdName() {\n+\t$result = mysql_query(\"SELECT id, name FROM clubs\");\n+\t$array = array();\n+\t\n+\twhile($row = mysql_fetch_row($result)) {\n+\t\t$array[$row[0]] = $row[1];\n+\t}\n+\t\n+\treturn $array;\n+}\n+\n //returns boolean: true=proceed, false=lock up; the difference between this and lockAction is that this can be used for repeated tasks, like admin\n // then, only if action was unsuccessful would lockAction be called\n function checkLock($action) {"
        },
        {
          "filename": "install.sql",
          "status": "modified",
          "additions": 4,
          "deletions": 3,
          "patch": "@@ -1,16 +1,17 @@\n CREATE TABLE baseapp (id INT PRIMARY KEY AUTO_INCREMENT, category INT, orderId INT, varname VARCHAR(1024), vardesc VARCHAR(1024), vartype VARCHAR(1024));\n CREATE TABLE basecat (id INT PRIMARY KEY AUTO_INCREMENT, name VARCHAR(32), orderId INT);\n CREATE TABLE users (id INT PRIMARY KEY AUTO_INCREMENT, username VARCHAR(64), password VARCHAR(128), name VARCHAR(128), email VARCHAR(256), register_time INT, accessed INT);\n+CREATE TABLE user_groups (user_id INT, `group` INT);\n CREATE TABLE reset (user_id INT PRIMARY KEY, time INT, auth VARCHAR(64));\n CREATE TABLE profiles (user_id INT, var_id INT, val VARCHAR(256));\n CREATE TABLE clubs (id INT PRIMARY KEY AUTO_INCREMENT, name VARCHAR(32), description TEXT, view_time INT, open_time INT, close_time INT, num_recommend INT);\n-CREATE TABLE admins (id INT PRIMARY KEY AUTO_INCREMENT, club_id INT, username VARCHAR(64), password VARCHAR(128), email VARCHAR(256), box_enabled INT, cat_enabled INT, comment_enabled INT);\n CREATE TABLE supplements (id INT PRIMARY KEY AUTO_INCREMENT, club_id INT, orderId INT, varname VARCHAR(1024), vardesc TEXT, vartype VARCHAR(1024));\n CREATE TABLE applications (id INT PRIMARY KEY AUTO_INCREMENT, user_id INT, club_id INT, submitted VARCHAR(512));\n CREATE TABLE answers (id INT PRIMARY KEY AUTO_INCREMENT, application_id INT, var_id INT, val TEXT);\n CREATE TABLE recommendations (id INT PRIMARY KEY AUTO_INCREMENT, user_id INT, author VARCHAR(64), email VARCHAR(256), auth VARCHAR(64), status INT, filename VARCHAR(32));\n CREATE TABLE recommender_answers (id INT PRIMARY KEY AUTO_INCREMENT, recommend_id INT, var_id INT, val TEXT);\n CREATE TABLE pages (id INT PRIMARY KEY AUTO_INCREMENT, name VARCHAR(32), text TEXT);\n-CREATE TABLE club_notes (application_id INT, admin_id INT, box TEXT, category VARCHAR(16), rank INT, comments TEXT);\n-CREATE TABLE club_notes_categories (admin_id INT, name VARCHAR(16));\n+CREATE TABLE club_notes (application_id INT, user_id INT, box TEXT, category VARCHAR(16), rank INT, comments TEXT);\n+CREATE TABLE club_notes_categories (club_id INT, name VARCHAR(16));\n+CREATE TABLE admin_notes_settings (user_id INT, box_enabled INT, cat_enabled INT, comment_enabled INT);\n CREATE TABLE locks (id INT NOT NULL PRIMARY KEY AUTO_INCREMENT, ip VARCHAR(16), time INT, action VARCHAR(16), num INT);"
        },
        {
          "filename": "install/install.php",
          "status": "added",
          "additions": 18,
          "deletions": 0,
          "patch": "@@ -0,0 +1,18 @@\n+<?php\n+include(\"../include/common.php\");\n+include(\"../config.php\");\n+include(\"../include/db_connect.php\");\n+include(\"../include/session.php\");\n+\n+//make sure that users aren't set up yet\n+$result = mysql_query(\"SELECT COUNT(*) FROM users\");\n+$row = mysql_fetch_row($result);\n+\n+if($row[0] == 0) {\n+\tmysql_query(\"INSERT INTO users (username, password, name, email, register_time, accessed) VALUES ('admin', '\" . chash(\"\") . \"', 'Site Administrator', 'admin@example.com', '0', '0')\");\n+\t$admin_id = escape(mysql_insert_id());\n+\tmysql_query(\"INSERT INTO user_groups (user_id, `group`) VALUES ('$admin_id', '0')\");\n+\tmysql_query(\"INSERT INTO user_groups (user_id, `group`) VALUES ('$admin_id', '-1')\");\n+}\n+\n+?>"
        },
        {
          "filename": "login.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -8,6 +8,7 @@\n \tget_page(\"message\", array(\"title\" => \"Logged In\", \"message\" => \"You are already logged in! Click <a href=\\\"application/\\\">here</a> to continue.\"));\n } else if(isset($_REQUEST['username']) && isset($_REQUEST['password'])) {\n \t$result = checkLogin($_REQUEST['username'], $_REQUEST['password']);\n+\t\n \tif($result >= 0) {\n \t\t$_SESSION['user_id'] = $result;\n \t\tget_page(\"login\", array(\"title\" => \"Logged In\", \"message\" => \"You are now logged in. Click <a href=\\\"application/\\\">here</a> to continue.\", \"redirect\" => \"application/\"));"
        },
        {
          "filename": "page/admin/index_login.php",
          "status": "modified",
          "additions": 11,
          "deletions": 1,
          "patch": "@@ -1,19 +1,29 @@\n <h1>Administrator Page</h1>\n \n-<p>Log in with the administrator username and password. These are added through <b>Admin Management</b> in the root administration section. If you do not know your username and password, then you should contact your root administrator.</p>\n+<p>Use the form below to log in to the club administration area.</p>\n \n <table>\n \t<tr>\n \t\t<form method=\"POST\" action=\"index.php\">\n \t\t<table>\n+\t\t\t<? if(!$user_loggedin) { ?>\n \t\t\t<tr>\n \t\t\t\t<td>Username:</td>\n \t\t\t\t<td><input type=\"text\" name=\"username\"/></td>\n \t\t\t</tr>\n+\t\t\t<? } ?>\n \t\t\t<tr>\n \t\t\t\t<td>Password:</td>\n \t\t\t\t<td><input type=\"password\" name=\"password\"/></td>\n \t\t\t</tr>\n+\t\t\t<tr>\n+\t\t\t\t<td>Club:</td>\n+\t\t\t\t<td><select name=\"club\">\n+\t\t\t\t<? foreach($clubs as $club_id => $club_name) { ?>\n+\t\t\t\t\t<option value=\"<?= $club_id ?>\"><?= $club_name ?></option>\n+\t\t\t\t<? } ?>\n+\t\t\t\t</select></td>\n+\t\t\t</tr>\n \t\t\t<tr>\n \t\t\t\t<td colspan=\"2\"><input type=\"submit\" value=\"Submit\" align=\"center\"/></td>\n \t\t\t</tr>"
        },
        {
          "filename": "page/admin/man_club.php",
          "status": "modified",
          "additions": 0,
          "deletions": 13,
          "patch": "@@ -31,16 +31,3 @@\n </tr>\n </table>\n </form>\n-\n-<h3>Administrator password</h3>\n-<form method=\"post\" action=\"man_club.php\">\n-<table>\n-<tr>\n-\t<td>Update Password</td>\n-\t<td><input type=\"password\" name=\"new_password\"></td>\n-</tr>\n-<tr>\n-\t<td colspan=\"2\"><input type=\"submit\" value=\"Update\" /></td>\n-</tr>\n-</table>\n-</form>"
        },
        {
          "filename": "page/root/index_login.php",
          "status": "modified",
          "additions": 5,
          "deletions": 2,
          "patch": "@@ -3,6 +3,9 @@\n <p>Please login with your root password to access the root administration area. Your root password can be reset manually in config.php.</p>\n \n <form method=\"POST\" action=\"index.php\">\n-Password: <input type=\"password\" name=\"password\"><br>\n-<input type=\"submit\" name=\"submit\" value=\"Submit\">\n+<? if(!$user_loggedin) { ?>\n+Username: <input type=\"text\" name=\"username\" /><br />\n+<? } ?>\n+Password: <input type=\"password\" name=\"password\" /><br />\n+<input type=\"submit\" name=\"submit\" value=\"Submit\" />\n </form>"
        },
        {
          "filename": "page/root/man_admins.php",
          "status": "modified",
          "additions": 14,
          "deletions": 38,
          "patch": "@@ -16,26 +16,15 @@\n \t<td>Admin username</td>\n \t<td><input type=\"text\" name=\"username\"></td>\n </tr>\n-<tr>\n-\t<td>Password</p></td>\n-\t<td><input type=\"password\" name=\"password\"></td>\n-</tr>\n-<tr>\n-\t<td>Email address</td>\n-\t<td><input type=\"text\" name=\"email\"></td>\n-</tr>\n <tr>\n \t<td>Club</td>\n \t<td><select name=\"club_id\">\n-\t\t<option value=\"0\">General Application</option>\n \t\t<?\n-\t\t\t$result = mysql_query(\"SELECT id, name FROM clubs ORDER BY name\");\n-\n-\t\t\twhile($row = mysql_fetch_array($result))\n-\t\t\t{\n-\t\t\t\techo \"<option value=\\\"\".$row['id'].\"\\\">\".$row['name'].\"</option>\";\n+\t\t\tforeach($clubsList as $club_id => $club_name) {\n+\t\t\t\techo \"<option value=\\\"\" . $club_id . \"\\\">\" . $club_name . \"</option>\";\n \t\t\t}\n \t\t?>\n+\t\t<option value=\"0\">General Application</option>\n \t</select></td>\n </tr>\n <tr>\n@@ -46,55 +35,42 @@\n \n <table>\n <tr>\n-\t<th>Club ID</th>\n \t<th>Username</th>\n-\t<th>Email</th>\n-\t<th>Change pass</th>\n+\t<th>Club</th>\n \t<th>Update</th>\n-\t<th>Delete</th>\n+\t<th>Remove</th>\n </tr>\n \n <?\n foreach($adminList as $item) {\n ?>\n \t<form method=\"post\" action=\"man_admins.php\">\n \t<input type=\"hidden\" name=\"id\" value=\"<?= $item[0] ?>\">\n+\t<input type=\"hidden\" name=\"club_id_orig\" value=\"<?= $item[1] ?>\">\n \t<tr>\n+\t\t<td><input type=\"text\" name=\"username\" value=\"<?= $item[2] ?>\"></td>\n \t\t<td><select name=\"club_id\">\n \t\t\t<option value=\"<?= $item[1] ?>\">\n \t\t\t<?\n \t\t\t\tif ($item[1] == 0) {\n-\t\t\t\t   echo \"General App\";\n-\t\t\t\t}\n-\t\t\t\telse {\n-\t\t\t\t\t//todo: terribly inefficient\n-\t\t\t\t\t$result = mysql_query(\"SELECT id, name FROM clubs WHERE id = '$item[1]'\");\n-\t\t\t\t\t$row = mysql_fetch_array($result);\n-\t\t\t\t\techo $row['name'];\n+\t\t\t\t   echo \"General Application\";\n+\t\t\t\t} else {\n+\t\t\t\t\techo $clubsList[$item[1]];\n \t\t\t\t}\n \t\t\t?>\n \t\t\t</option>\n \t\t\t\n \t\t\t<?\n-\t\t\t\t$result = mysql_query(\"SELECT id, name FROM clubs ORDER BY name\");\n-\n-\t\t\t\twhile($row = mysql_fetch_array($result)) {\n-\t\t\t\t\tif ($row['id']!=$item[1]) {\n-\t\t\t\t\t\techo \"<option value=\\\"\" . $row['id'] . \"\\\">\" . $row['name'] . \"</option>\";\n-\t\t\t\t\t}\n+\t\t\t\tforeach($clubsList as $club_id => $club_name) {\n+\t\t\t\t\techo \"<option value=\\\"\" . $club_id . \"\\\">\" . $club_name . \"</option>\";\n \t\t\t\t}\n \n-\t\t\t\tif ($item[1] > 0) {\n-\t\t\t\t   echo \"<option value=\\\"0\\\">General Application</option>\";\n-\t\t\t\t}\n+\t\t\t\techo \"<option value=\\\"0\\\">General Application</option>\";\n \t\t\t?>\n \t\t</select>\n \t\t</td>\n-\t\t<td><input type=\"text\" name=\"username\" value=\"<?= $item[2] ?>\"></td>\n-\t\t<td><input type=\"text\" name=\"email\" value=\"<?= $item[3] ?>\"></td>\n-\t\t<td><input type=\"password\" name=\"password\"></td>\n \t\t<td><input type=\"submit\" name=\"action\" value=\"update\"></td>\n-\t\t<td><input type=\"submit\" name=\"action\" value=\"delete\"></td>\n+\t\t<td><input type=\"submit\" name=\"action\" value=\"remove\"></td>\n \t</tr>\n \t</form>\n <?"
        },
        {
          "filename": "root/index.php",
          "status": "modified",
          "additions": 41,
          "deletions": 17,
          "patch": "@@ -4,27 +4,51 @@\n include(\"../include/db_connect.php\");\n include(\"../include/session.php\");\n \n-if(isset($_SESSION['admin_id']) || isset($_SESSION['id'] ) ) {\n-\tsession_unset();\n-\t$warning = \"You have been logged out! You may not log in as two different account types at once!\";\n-\tget_page_advanced(\"index_login\", \"root\", array(\"warning\" => $warning));\n-}\n+$parameters = array();\n \n-if(isset($_REQUEST['action'])) {\n+if(isset($_REQUEST['action']) && isset($_SESSION['root'])) {\n \tif($_REQUEST['action'] == 'logout') {\n-\t\tsession_unset();\n-\t\tget_page_advanced(\"index_login\", \"root\", array('success' => \"You have been logged out!\"));\n+\t\tunset($_SESSION['root']);\n+\t\t$parameters['success'] = \"You are now logged out of the site administration area.\";\n+\t}\n+} else if(!isset($_SESSION['root']) && (isset($_SESSION['user_id']) || isset($_REQUEST['username'])) && isset($_REQUEST['password'])) {\n+\tif(!isset($_SESSION['user_id'])) {\n+\t\t//log in first\n+\t\t$loginResult = checkLogin($_REQUEST['username'], $_REQUEST['password']);\n+\t\t\n+\t\tif($loginResult >= 0) {\n+\t\t\t$_SESSION['user_id'] = $loginResult;\n+\t\t} else if($loginResult == -2) {\n+\t\t\t$parameters['error'] = \"Please try again later (you are locked out for too many failed attempts).\";\n+\t\t} else if($loginResult == -3) {\n+\t\t\t$parameters['error'] = \"Login and registration are currently disabled.\";\n+\t\t} else if($loginResult == -1) {\n+\t\t\t$parameters['error'] = \"Login information is not correct.\";\n+\t\t} else {\n+\t\t\t$parameters['error'] = \"Internal error!\";\n+\t\t}\n \t}\n-} else if(isset($_REQUEST['password'])) {\n-\tif(checkRoot($_REQUEST['password'])) {\n-\t\t$_SESSION['root'] = true;\n-\t\tget_page_advanced(\"index\", \"root\", array('success' => \"You are now logged in!\"));\n-\t} else {\n-\t\tget_page_advanced(\"index_login\", \"root\", array('error' => \"Password is incorrect or you have been locked out.\"));\n+\t\n+\t//only continue if we haven't failed already\n+\tif(isset($_SESSION['user_id'])) {\n+\t\t$checkResult = checkRootLogin($_SESSION['user_id'], $_REQUEST['password']);\n+\t\t\n+\t\tif($checkResult === TRUE) {\n+\t\t\t$_SESSION['root'] = true;\n+\t\t} else if($checkResult === -1) {\n+\t\t\t$parameters['error'] = \"Login information is not correct.\";\n+\t\t} else if($checkResult === -2) {\n+\t\t\t$parameters['error'] = \"Please try again later (you are locked out for too many failed attempts).\";\n+\t\t} else if($checkResult === 1) {\n+\t\t\t$parameters['error'] = \"You are not a root administrator.\";\n+\t\t}\n \t}\n-} else if(isset($_SESSION['root'])) {\n-\tget_page_advanced(\"index\", \"root\");\n+}\n+\n+if(isset($_SESSION['root'])) {\n+\tget_page_advanced(\"index\", \"root\", $parameters);\n } else {\n-\tget_page_advanced(\"index_login\", \"root\");\n+\t$parameters['user_loggedin'] = isset($_SESSION['user_id']);\n+\tget_page_advanced(\"index_login\", \"root\", $parameters);\n }\n ?>"
        },
        {
          "filename": "root/man_admins.php",
          "status": "modified",
          "additions": 25,
          "deletions": 50,
          "patch": "@@ -9,67 +9,42 @@\n \tif(isset($_REQUEST['action'])) {\n \t\t$action = $_REQUEST['action'];\n \t\t\n-\t\tif($action == 'add') {\n-\t\t\tif($_REQUEST['username'] != \"\" && $_REQUEST['password'] != \"\") {\n-\t\t\t\t$result = mysql_query(\"SELECT id FROM admins WHERE username='\" . $_REQUEST['username'] . \"'\");\n-\t\t\t\tif($row = mysql_fetch_array($result)){\n-\t\t\t\t\t$error = \"Username already in use!\";\n-\t\t\t\t} else {\n-\t\t\t\t\tif($_REQUEST['email'] != \"\") {\n-\t\t\t\t\t\t$result = mysql_query(\"SELECT id FROM admins WHERE email='\" . $_REQUEST['email'] . \"'\");\n-\t\t\t\t\t\tif($row = mysql_fetch_array($result)){\n-\t\t\t\t\t\t\t$error = \"Email already in use!\";\n-\t\t\t\t\t\t} else {\n-\t\t\t\t\t\t\taddAdmin($_REQUEST['username'], $_REQUEST['password'], $_REQUEST['email'], $_REQUEST['club_id']);\n-\t\t\t\t\t\t\t$success = \"Admin added successfully!\";\n-\t\t\t\t\t\t}\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\taddAdmin($_REQUEST['username'], $_REQUEST['password'], $_REQUEST['email'], $_REQUEST['club_id']);\n-\t\t\t\t\t\t$success = \"Admin added successfully!\";\n-\t\t\t\t\t}\n-\t\t\t\t}\n+\t\tif($action == 'add' && isset($_REQUEST['username']) && isset($_REQUEST['club_id'])) {\n+\t\t\t$user_id = getUserId($_REQUEST['username']);\n+\t\t\t\n+\t\t\tif($user_id !== FALSE) {\n+\t\t\t\talterAdminClubs($user_id, -1, $_REQUEST['club_id']);\n \t\t\t} else {\n-\t\t\t\t$error = \"You need a username and password!\";\n-\t\t\t}\n-\t\t} else if($action == 'delete' || $action == 'Delete') {\n-\t\t\t$admin_id = escape($_REQUEST['id']);\n-\t\t\tmysql_query(\"DELETE FROM admins WHERE id='$admin_id'\");\n-\t\t\t$success =  \"Admin deleted successfully!\";\n-\t\t} else if($action == 'update' || $action == 'Update') {\n-\t\t\t$result = mysql_query(\"SELECT id FROM admins WHERE username='\" . $_REQUEST['username'] . \"'\");\n-\t\t\tif($row = mysql_fetch_array($result)){\n-\t\t\t\t$error = \"Username already in use!\";\n-\t\t\t} else {\n-\t\t\t\tif($_REQUEST['email'] != \"\") {\n-\t\t\t\t\t$result = mysql_query(\"SELECT id FROM admins WHERE email='\" . $_REQUEST['email'] . \"'\");\n-\t\t\t\t\tif($row = mysql_fetch_array($result)){\n-\t\t\t\t\t\t$error = \"Email already in use!\";\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tupdateAdmin($_REQUEST['id'], $_REQUEST['username'], $_REQUEST['password'], $_REQUEST['email'], $_REQUEST['club_id']);\n-\t\t\t\t\t\t$success =  \"Admin updated successfully!\";\n-\t\t\t\t\t}\n-\t\t\t\t} else {\n-\t\t\t\t\tupdateAdmin($_REQUEST['id'], $_REQUEST['username'], $_REQUEST['password'], $_REQUEST['email'], $_REQUEST['club_id']);\n-\t\t\t\t\t$success =  \"Admin updated successfully!\";\n-\t\t\t\t}\n+\t\t\t\t$error = \"Username not found.\";\n \t\t\t}\n+\t\t} else if(($action == 'remove' || $action == \"Remove\") && isset($_REQUEST['id']) && isset($_REQUEST['club_id_orig'])) {\n+\t\t\talterAdminClubs($_REQUEST['id'], $_REQUEST['club_id_orig'], -1);\n+\t\t\t$success =  \"Admin removed successfully.\";\n+\t\t} else if(($action == 'update' || $action == 'Update') && isset($_REQUEST['id']) && isset($_REQUEST['club_id_orig']) && isset($_REQUEST['club_id'])) {\n+\t\t\talterAdminClubs($_REQUEST['id'], $_REQUEST['club_id_orig'], $_REQUEST['club_id']);\n+\t\t\t$success = \"Admin updated successfully.\";\n \t\t}\n \t}\n \t\n-\t$result = mysql_query(\"SELECT id, club_id, username, email FROM admins ORDER BY club_id\");\n+\t$clubsList = listClubsIdName();\n+\t$result = mysql_query(\"SELECT user_groups.user_id, user_groups.`group`, users.username FROM user_groups LEFT JOIN users ON user_groups.user_id = users.id WHERE user_groups.`group` >= '0' ORDER BY user_groups.`group`\");\n \t$adminList = array();\n \t\n \twhile($row = mysql_fetch_array($result)) {\n-\t\tarray_push($adminList, array($row[0], $row[1], $row[2], $row[3]));\n+\t\tarray_push($adminList, array($row[0], $row[1], $row[2]));\n \t}\n \t\n-\tif(isset($error)){\n-\t\tget_page_advanced(\"man_admins\", \"root\", array('error' => $error, 'adminList' => $adminList));\n-\t} else if(isset($success)){\n-\t\tget_page_advanced(\"man_admins\", \"root\", array('success' => $success, 'adminList' => $adminList));\n-\t} else {\n-\t\tget_page_advanced(\"man_admins\", \"root\", array('adminList' => $adminList));\n+\t$parameters = array();\n+\t$parameters['adminList'] = $adminList;\n+\t$parameters['clubsList'] = $clubsList;\n+\t\n+\tif(isset($error)) {\n+\t\t$parameters['error'] = $error;\n+\t} else if(isset($success)) {\n+\t\t$parameters['success'] = $success;\n \t}\n+\t\n+\tget_page_advanced(\"man_admins\", \"root\", $parameters);\n } else {\n \theader('Location: index.php');\n }"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 11,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "a22aeb0e991ed1476f858ff4ba27588c222c4bf6",
            "date": "2013-02-25T20:40:53Z",
            "author_login": "perennate"
          },
          {
            "sha": "d5255dff5f2d937f235df4ed1e2e243e3471f77d",
            "date": "2013-02-25T20:40:17Z",
            "author_login": "perennate"
          },
          {
            "sha": "93421a229cbeb17d2d608a82ac96ddefc92e65d8",
            "date": "2012-09-26T01:50:58Z",
            "author_login": "perennate"
          },
          {
            "sha": "413b0dbcbfebcf41b367bad38a175304144e2fa0",
            "date": "2012-09-15T14:23:26Z",
            "author_login": "perennate"
          },
          {
            "sha": "d69e95b7cf6cb34c518197ab439366a835c65ba7",
            "date": "2012-08-07T23:02:42Z",
            "author_login": "hellovai"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.3,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L",
    "cwe_id": "CWE-89",
    "description": "A vulnerability, which was classified as critical, has been found in uakfdotb oneapp. This issue affects some unknown processing. The manipulation leads to sql injection. The attack may be initiated remotely. This product does not use versioning. This is why information about affected and unaffected releases are unavailable. The patch is named 5413ac804f1b09f9decc46a6c37b08352c49669c. It is recommended to apply a patch to fix this issue. The associated identifier of this vulnerability is VDB-221483.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-02-20T07:15:21.817",
    "last_modified": "2024-11-21T01:36:08.500",
    "fix_date": "2012-05-10T03:21:00Z"
  },
  "references": [
    {
      "url": "https://github.com/uakfdotb/oneapp/commit/5413ac804f1b09f9decc46a6c37b08352c49669c",
      "source": "cna@vuldb.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://vuldb.com/?ctiid.221483",
      "source": "cna@vuldb.com",
      "tags": [
        "Permissions Required",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://vuldb.com/?id.221483",
      "source": "cna@vuldb.com",
      "tags": [
        "Permissions Required",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/uakfdotb/oneapp/commit/5413ac804f1b09f9decc46a6c37b08352c49669c",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://vuldb.com/?ctiid.221483",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Permissions Required",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://vuldb.com/?id.221483",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Permissions Required",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:05:04.080795",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "oneapp",
    "owner": "uakfdotb",
    "created_at": "2015-07-23T20:30:10Z",
    "updated_at": "2015-07-23T20:33:00Z",
    "pushed_at": "2015-07-23T20:34:12Z",
    "size": 2452,
    "stars": 0,
    "forks": 0,
    "open_issues": 0,
    "watchers": 0,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "PHP": 667830,
      "JavaScript": 273648,
      "CSS": 135538,
      "TeX": 1454,
      "HTML": 505
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "gpl-3.0"
    },
    "collected_at": "2025-01-14T14:10:17.645432"
  }
}