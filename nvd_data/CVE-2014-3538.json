{
  "cve_id": "CVE-2014-3538",
  "github_data": {
    "repository": "file/file",
    "fix_commit": "4a284c89d6ef11aca34da65da7d673050a5ea320",
    "related_commits": [
      "4a284c89d6ef11aca34da65da7d673050a5ea320",
      "69a5a43b3b71f53b0577f41264a073f495799610",
      "71a8b6c0d758acb0f73e2e51421a711b5e9d6668",
      "74cafd7de9ec99a14f4480927580e501c8f852c3",
      "758e066df72fb1ac08d2eea91ddc3973d259e991",
      "4a284c89d6ef11aca34da65da7d673050a5ea320",
      "69a5a43b3b71f53b0577f41264a073f495799610",
      "71a8b6c0d758acb0f73e2e51421a711b5e9d6668",
      "74cafd7de9ec99a14f4480927580e501c8f852c3",
      "758e066df72fb1ac08d2eea91ddc3973d259e991"
    ],
    "patch_url": "https://github.com/file/file/commit/4a284c89d6ef11aca34da65da7d673050a5ea320.patch",
    "fix_commit_details": {
      "sha": "4a284c89d6ef11aca34da65da7d673050a5ea320",
      "commit_date": "2014-06-03T19:01:34Z",
      "author": {
        "login": "zoulasc",
        "type": "User",
        "stats": {
          "total_commits": 4283,
          "average_weekly_commits": 2.1941598360655736,
          "total_additions": 256557,
          "total_deletions": 169759,
          "weeks_active": 926
        }
      },
      "commit_message": {
        "title": "* Enforce limit of 8K on regex searches that have no limits",
        "length": 406,
        "has_description": true,
        "references_issue": false
      },
      "stats": {
        "total": 168,
        "additions": 105,
        "deletions": 63
      },
      "files": [
        {
          "filename": "ChangeLog",
          "status": "modified",
          "additions": 9,
          "deletions": 0,
          "patch": "@@ -1,3 +1,12 @@\n+2014-06-02  14:50  Christos Zoulas <christos@zoulas.com>\n+\n+\t* Enforce limit of 8K on regex searches that have no limits\n+\t* Allow the l modifier for regex to mean line count. Default\n+\t  to byte count. If line count is specified, assume a max\n+\t  of 80 characters per line to limit the byte count.\n+\t* Don't allow conversions to be used for dates, allowing\n+\t  the mask field to be used as an offset.\n+\n 2014-05-30  12:51  Christos Zoulas <christos@zoulas.com>\n \n \t* Make the range operator limit the length of the"
        },
        {
          "filename": "doc/magic.man",
          "status": "modified",
          "additions": 14,
          "deletions": 2,
          "patch": "@@ -1,4 +1,4 @@\n-.\\\" $File: magic.man,v 1.82 2014/05/30 16:51:23 christos Exp $\n+.\\\" $File: magic.man,v 1.83 2014/06/03 17:36:13 christos Exp $\n .Dd June 3, 2014\n .Dt MAGIC __FSECTION__\n .Os\n@@ -232,12 +232,21 @@ The size of the string to search should also be limited by specifying\n .Dv /<length> ,\n to avoid performance issues scanning long files.\n The type specification can also be optionally followed by\n-.Dv /[c][s] .\n+.Dv /[c][s][l] .\n The\n .Dq c\n flag makes the match case insensitive, while the\n .Dq s\n flag update the offset to the start offset of the match, rather than the end.\n+The\n+.Dq l\n+modifier, changes the limit of length to mean number of lines instead of a\n+byte count.\n+Lines are delimited by the platforms native line delimiter.\n+When a line count is specified, an implicit byte count also computed assuming\n+each line is 80 characters long.\n+If neither a byte or line count is specified, the search is limited automatically\n+to 8KiB.\n .Dv ^\n and\n .Dv $\n@@ -406,6 +415,9 @@ is octal, and\n .Dv 0x13\n is hexadecimal.\n .Pp\n+Numeric operations are not performed on date types, instead the numeric\n+value is interpreted as an offset.\n+.Pp\n For string values, the string from the\n file must match the specified string.\n The operators"
        },
        {
          "filename": "magic/Magdir/android",
          "status": "modified",
          "additions": 7,
          "deletions": 7,
          "patch": "@@ -1,6 +1,6 @@\n \n #------------------------------------------------------------\n-# $File: android,v 1.2 2013/11/05 14:00:25 christos Exp $\n+# $File: android,v 1.3 2013/11/08 01:24:22 christos Exp $\n # Various android related magic entries\n #------------------------------------------------------------\n \n@@ -89,12 +89,12 @@\n >17\tstring\t\t0\\n\t\t\t\\b, Not-Compressed\n >17\tstring\t\t1\\n\t\t\t\\b, Compressed\n # any string as long as it's not the word none (which is matched below)\n->>19    regex/1\t\t\\^([^n\\n]|n[^o]|no[^n]|non[^e]|none.+).*\t\\b, Encrypted (%s)\n+>>19    regex/1l\t\\^([^n\\n]|n[^o]|no[^n]|non[^e]|none.+).*\t\\b, Encrypted (%s)\n >>19\tstring\t\tnone\\n\t\t\t\\b, Not-Encrypted\n # Commented out because they don't seem useful to print\n # (but they are part of the header - the tar file comes after them):\n-#>>>&1\t\tregex/1 .*\t\\b, Password salt: %s\n-#>>>>&1\t\tregex/1 .*\t\\b, Master salt: %s\n-#>>>>>&1\tregex/1 .*\t\\b, PBKDF2 rounds: %s\n-#>>>>>>&1\tregex/1 .*\t\\b, IV: %s\n-#>>>>>>>&1\tregex/1 .*\t\\b, Key: %s\n+#>>>&1\t\tregex/1l .*\t\\b, Password salt: %s\n+#>>>>&1\t\tregex/1l .*\t\\b, Master salt: %s\n+#>>>>>&1\tregex/1l .*\t\\b, PBKDF2 rounds: %s\n+#>>>>>>&1\tregex/1l .*\t\\b, IV: %s\n+#>>>>>>>&1\tregex/1l .*\t\\b, Key: %s"
        },
        {
          "filename": "magic/Magdir/fortran",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -1,7 +1,7 @@\n \n #------------------------------------------------------------------------------\n-# $File: fortran,v 1.6 2009/09/19 16:28:09 christos Exp $\n+# $File: fortran,v 1.7 2012/06/21 01:55:02 christos Exp $\n # FORTRAN source\n-0\tregex/100\t\\^[Cc][\\ \\t]\tFORTRAN program\n+0\tregex/100l\t\\^[Cc][\\ \\t]\tFORTRAN program\n !:mime\ttext/x-fortran\n !:strength - 5"
        },
        {
          "filename": "magic/Magdir/graphviz",
          "status": "modified",
          "additions": 3,
          "deletions": 3,
          "patch": "@@ -1,12 +1,12 @@\n \n #------------------------------------------------------------------------------\n-# $File$\n+# $File: graphviz,v 1.7 2009/09/19 16:28:09 christos Exp $\n # graphviz:  file(1) magic for http://www.graphviz.org/\n \n # FIXME: These patterns match too generally. For example, the first\n # line matches a LaTeX file containing the word \"graph\" (with a {\n # following later) and the second line matches this file.\n-#0\tregex/100\t[\\r\\n\\t\\ ]*graph[\\r\\n\\t\\ ]+.*\\\\{\tgraphviz graph text\n+#0\tregex/100l\t[\\r\\n\\t\\ ]*graph[\\r\\n\\t\\ ]+.*\\\\{\tgraphviz graph text\n #!:mime\ttext/vnd.graphviz\n-#0\tregex/100\t[\\r\\n\\t\\ ]*digraph[\\r\\n\\t\\ ]+.*\\\\{\tgraphviz digraph text\n+#0\tregex/100l\t[\\r\\n\\t\\ ]*digraph[\\r\\n\\t\\ ]+.*\\\\{\tgraphviz digraph text\n #!:mime\ttext/vnd.graphviz"
        },
        {
          "filename": "magic/Magdir/marc21",
          "status": "modified",
          "additions": 6,
          "deletions": 6,
          "patch": "@@ -12,17 +12,17 @@\n 20\tstring\t45\t\n \n # leader starts with 5 digits, followed by codes specific to MARC format\n->0\tregex/1\t(^[0-9]{5})[acdnp][^bhlnqsu-z]\tMARC21 Bibliographic\n+>0\tregex/1l\t(^[0-9]{5})[acdnp][^bhlnqsu-z]\tMARC21 Bibliographic\n !:mime\tapplication/marc\n->0\tregex/1\t(^[0-9]{5})[acdnosx][z]\tMARC21 Authority\n+>0\tregex/1l\t(^[0-9]{5})[acdnosx][z]\tMARC21 Authority\n !:mime\tapplication/marc\n->0\tregex/1\t(^[0-9]{5})[cdn][uvxy]\tMARC21 Holdings\n+>0\tregex/1l\t(^[0-9]{5})[cdn][uvxy]\tMARC21 Holdings\n !:mime\tapplication/marc\n-0\tregex/1\t(^[0-9]{5})[acdn][w]\tMARC21 Classification\n+0\tregex/1l\t(^[0-9]{5})[acdn][w]\tMARC21 Classification\n !:mime\tapplication/marc\n->0\tregex/1\t(^[0-9]{5})[cdn][q]\tMARC21 Community\n+>0\tregex/1l\t(^[0-9]{5})[cdn][q]\tMARC21 Community\n !:mime\tapplication/marc\n \n # leader position 22-23, should be \"00\" but is it?\n->0\tregex/1\t(^.{21})([^0]{2})\t(non-conforming)\n+>0\tregex/1l\t(^.{21})([^0]{2})\t(non-conforming)\n !:mime\tapplication/marc"
        },
        {
          "filename": "magic/Magdir/scientific",
          "status": "modified",
          "additions": 6,
          "deletions": 6,
          "patch": "@@ -1,6 +1,6 @@\n \n #------------------------------------------------------------------------------\n-# $File: scientific,v 1.7 2010/09/20 19:19:17 rrt Exp $\n+# $File: scientific,v 1.8 2014/01/06 17:46:23 rrt Exp $\n # scientific:  file(1) magic for scientific formats \n #\n # From: Joe Krahn <krahn@niehs.nih.gov>\n@@ -91,12 +91,12 @@\n # uppercase letters. However, examples have been seen without the date string,\n # e.g., the example on the chemime site.\n 0\tstring\tHEADER\\ \\ \\ \\ \n->&0\tregex/1\t\\^.{40}\n->>&0\tregex/1\t[0-9]{2}-[A-Z]{3}-[0-9]{2}\\ {3}\n->>>&0\tregex/1s\t[A-Z0-9]{4}.{14}$\n->>>>&0\tregex/1\t[A-Z0-9]{4}\tProtein Data Bank data, ID Code %s\n+>&0\tregex/1l\t\\^.{40}\n+>>&0\tregex/1l\t[0-9]{2}-[A-Z]{3}-[0-9]{2}\\ {3}\n+>>>&0\tregex/1ls\t[A-Z0-9]{4}.{14}$\n+>>>>&0\tregex/1l\t[A-Z0-9]{4}\tProtein Data Bank data, ID Code %s\n !:mime\tchemical/x-pdb\n->>>>0\tregex/1\t[0-9]{2}-[A-Z]{3}-[0-9]{2}\t\\b, %s\n+>>>>0\tregex/1l\t[0-9]{2}-[A-Z]{3}-[0-9]{2}\t\\b, %s\n \n # Type:\tGDSII Stream file\n 0\tbelong\t0x00060002\tGDSII Stream file"
        },
        {
          "filename": "magic/Magdir/troff",
          "status": "modified",
          "additions": 3,
          "deletions": 3,
          "patch": "@@ -1,6 +1,6 @@\n \n #------------------------------------------------------------------------------\n-# $File$\n+# $File: troff,v 1.10 2009/09/19 16:28:12 christos Exp $\n # troff:  file(1) magic for *roff\n #\n # updated by Daniel Quinlan (quinlan@yggdrasil.com)\n@@ -16,9 +16,9 @@\n !:mime\ttext/troff\n 0\tsearch/1\t'''\t\ttroff or preprocessor input text\n !:mime\ttext/troff\n-0\tregex/20\t\\^\\\\.[A-Za-z0-9][A-Za-z0-9][\\ \\t]\ttroff or preprocessor input text\n+0\tregex/20l\t\\^\\\\.[A-Za-z0-9][A-Za-z0-9][\\ \\t]\ttroff or preprocessor input text\n !:mime\ttext/troff\n-0\tregex/20\t\\^\\\\.[A-Za-z0-9][A-Za-z0-9]$\ttroff or preprocessor input text\n+0\tregex/20l\t\\^\\\\.[A-Za-z0-9][A-Za-z0-9]$\ttroff or preprocessor input text\n !:mime\ttext/troff\n \n # ditroff intermediate output text"
        },
        {
          "filename": "src/apprentice.c",
          "status": "modified",
          "additions": 9,
          "deletions": 3,
          "patch": "@@ -32,7 +32,7 @@\n #include \"file.h\"\n \n #ifndef\tlint\n-FILE_RCSID(\"@(#)$File: apprentice.c,v 1.209 2014/05/13 16:42:17 christos Exp $\")\n+FILE_RCSID(\"@(#)$File: apprentice.c,v 1.210 2014/05/14 23:15:42 christos Exp $\")\n #endif\t/* lint */\n \n #include \"magic.h\"\n@@ -1382,7 +1382,8 @@ string_modifier_check(struct magic_set *ms, struct magic *m)\n \tif ((ms->flags & MAGIC_CHECK) == 0)\n \t\treturn 0;\n \n-\tif (m->type != FILE_PSTRING && (m->str_flags & PSTRING_LEN) != 0) {\n+\tif ((m->type != FILE_REGEX || (m->str_flags & REGEX_LINE_COUNT) == 0) &&\n+\t    (m->type != FILE_PSTRING && (m->str_flags & PSTRING_LEN) != 0)) {\n \t\tfile_magwarn(ms,\n \t\t    \"'/BHhLl' modifiers are only allowed for pascal strings\\n\");\n \t\treturn -1;\n@@ -1875,8 +1876,13 @@ parse(struct magic_set *ms, struct magic_entry *me, const char *line,\n \t\t\t\t\tm->str_flags = (m->str_flags & ~PSTRING_LEN) | PSTRING_4_BE;\n \t\t\t\t\tbreak;\n \t\t\t\tcase CHAR_PSTRING_4_LE:\n-\t\t\t\t\tif (m->type != FILE_PSTRING)\n+\t\t\t\t\tswitch (m->type) {\n+\t\t\t\t\tcase FILE_PSTRING:\n+\t\t\t\t\tcase FILE_REGEX:\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t\tdefault:\n \t\t\t\t\t\tgoto bad;\n+\t\t\t\t\t}\n \t\t\t\t\tm->str_flags = (m->str_flags & ~PSTRING_LEN) | PSTRING_4_LE;\n \t\t\t\t\tbreak;\n \t\t\t\tcase CHAR_PSTRING_LENGTH_INCLUDES_ITSELF:"
        },
        {
          "filename": "src/file.h",
          "status": "modified",
          "additions": 3,
          "deletions": 2,
          "patch": "@@ -27,7 +27,7 @@\n  */\n /*\n  * file.h - definitions for file(1) program\n- * @(#)$File: file.h,v 1.150 2014/05/05 20:53:10 christos Exp $\n+ * @(#)$File: file.h,v 1.151 2014/05/14 23:15:42 christos Exp $\n  */\n \n #ifndef __file_h__\n@@ -133,7 +133,7 @@\n #define MAXstring 64\t\t/* max len of \"string\" types */\n \n #define MAGICNO\t\t0xF11E041C\n-#define VERSIONNO\t11\n+#define VERSIONNO\t12\n #define FILE_MAGICSIZE\t248\n \n #define\tFILE_LOAD\t0\n@@ -321,6 +321,7 @@ struct magic {\n #define PSTRING_2_LE\t\t\t\tBIT(9)\n #define PSTRING_4_BE\t\t\t\tBIT(10)\n #define PSTRING_4_LE\t\t\t\tBIT(11)\n+#define REGEX_LINE_COUNT\t\t\tBIT(11)\n #define PSTRING_LEN\t\\\n     (PSTRING_1_BE|PSTRING_2_LE|PSTRING_2_BE|PSTRING_4_LE|PSTRING_4_BE)\n #define PSTRING_LENGTH_INCLUDES_ITSELF\t\tBIT(12)"
        },
        {
          "filename": "src/softmagic.c",
          "status": "modified",
          "additions": 43,
          "deletions": 29,
          "patch": "@@ -32,7 +32,7 @@\n #include \"file.h\"\n \n #ifndef\tlint\n-FILE_RCSID(\"@(#)$File: softmagic.c,v 1.188 2014/05/14 23:15:42 christos Exp $\")\n+FILE_RCSID(\"@(#)$File: softmagic.c,v 1.189 2014/05/30 16:47:44 christos Exp $\")\n #endif\t/* lint */\n \n #include \"magic.h\"\n@@ -57,7 +57,7 @@ private int32_t mprint(struct magic_set *, struct magic *);\n private int32_t moffset(struct magic_set *, struct magic *);\n private void mdebug(uint32_t, const char *, size_t);\n private int mcopy(struct magic_set *, union VALUETYPE *, int, int,\n-    const unsigned char *, uint32_t, size_t, size_t);\n+    const unsigned char *, uint32_t, size_t, struct magic *);\n private int mconvert(struct magic_set *, struct magic *, int);\n private int print_sep(struct magic_set *, int);\n private int handle_annotation(struct magic_set *, struct magic *);\n@@ -540,7 +540,7 @@ mprint(struct magic_set *ms, struct magic *m)\n \tcase FILE_LEDATE:\n \tcase FILE_MEDATE:\n \t\tif (file_printf(ms, F(ms, m, \"%s\"),\n-\t\t    file_fmttime(p->l, FILE_T_LOCAL, tbuf)) == -1)\n+\t\t    file_fmttime(p->l + m->num_mask, FILE_T_LOCAL, tbuf)) == -1)\n \t\t\treturn -1;\n \t\tt = ms->offset + sizeof(uint32_t);\n \t\tbreak;\n@@ -550,7 +550,7 @@ mprint(struct magic_set *ms, struct magic *m)\n \tcase FILE_LELDATE:\n \tcase FILE_MELDATE:\n \t\tif (file_printf(ms, F(ms, m, \"%s\"),\n-\t\t    file_fmttime(p->l, 0, tbuf)) == -1)\n+\t\t    file_fmttime(p->l + m->num_mask, 0, tbuf)) == -1)\n \t\t\treturn -1;\n \t\tt = ms->offset + sizeof(uint32_t);\n \t\tbreak;\n@@ -559,7 +559,7 @@ mprint(struct magic_set *ms, struct magic *m)\n \tcase FILE_BEQDATE:\n \tcase FILE_LEQDATE:\n \t\tif (file_printf(ms, F(ms, m, \"%s\"),\n-\t\t    file_fmttime(p->q, FILE_T_LOCAL, tbuf)) == -1)\n+\t\t    file_fmttime(p->q + m->num_mask, FILE_T_LOCAL, tbuf)) == -1)\n \t\t\treturn -1;\n \t\tt = ms->offset + sizeof(uint64_t);\n \t\tbreak;\n@@ -568,7 +568,7 @@ mprint(struct magic_set *ms, struct magic *m)\n \tcase FILE_BEQLDATE:\n \tcase FILE_LEQLDATE:\n \t\tif (file_printf(ms, F(ms, m, \"%s\"),\n-\t\t    file_fmttime(p->q, 0, tbuf)) == -1)\n+\t\t    file_fmttime(p->q + m->num_mask, 0, tbuf)) == -1)\n \t\t\treturn -1;\n \t\tt = ms->offset + sizeof(uint64_t);\n \t\tbreak;\n@@ -577,7 +577,7 @@ mprint(struct magic_set *ms, struct magic *m)\n \tcase FILE_BEQWDATE:\n \tcase FILE_LEQWDATE:\n \t\tif (file_printf(ms, F(ms, m, \"%s\"),\n-\t\t    file_fmttime(p->q, FILE_T_WINDOWS, tbuf)) == -1)\n+\t\t    file_fmttime(p->q + m->num_mask, FILE_T_WINDOWS, tbuf)) == -1)\n \t\t\treturn -1;\n \t\tt = ms->offset + sizeof(uint64_t);\n \t\tbreak;\n@@ -912,8 +912,9 @@ private int\n mconvert(struct magic_set *ms, struct magic *m, int flip)\n {\n \tunion VALUETYPE *p = &ms->ms_value;\n+\tuint8_t type;\n \n-\tswitch (cvt_flip(m->type, flip)) {\n+\tswitch (type = cvt_flip(m->type, flip)) {\n \tcase FILE_BYTE:\n \t\tcvt_8(p, m);\n \t\treturn 1;\n@@ -957,7 +958,8 @@ mconvert(struct magic_set *ms, struct magic *m, int flip)\n \tcase FILE_BELDATE:\n \t\tp->l = (int32_t)\n \t\t    ((p->hl[0]<<24)|(p->hl[1]<<16)|(p->hl[2]<<8)|(p->hl[3]));\n-\t\tcvt_32(p, m);\n+\t\tif (type == FILE_BELONG)\n+\t\t\tcvt_32(p, m);\n \t\treturn 1;\n \tcase FILE_BEQUAD:\n \tcase FILE_BEQDATE:\n@@ -968,7 +970,8 @@ mconvert(struct magic_set *ms, struct magic *m, int flip)\n \t\t     ((uint64_t)p->hq[2]<<40)|((uint64_t)p->hq[3]<<32)|\n \t\t     ((uint64_t)p->hq[4]<<24)|((uint64_t)p->hq[5]<<16)|\n \t\t     ((uint64_t)p->hq[6]<<8)|((uint64_t)p->hq[7]));\n-\t\tcvt_64(p, m);\n+\t\tif (type == FILE_BEQUAD)\n+\t\t\tcvt_64(p, m);\n \t\treturn 1;\n \tcase FILE_LESHORT:\n \t\tp->h = (short)((p->hs[1]<<8)|(p->hs[0]));\n@@ -979,7 +982,8 @@ mconvert(struct magic_set *ms, struct magic *m, int flip)\n \tcase FILE_LELDATE:\n \t\tp->l = (int32_t)\n \t\t    ((p->hl[3]<<24)|(p->hl[2]<<16)|(p->hl[1]<<8)|(p->hl[0]));\n-\t\tcvt_32(p, m);\n+\t\tif (type == FILE_LELONG)\n+\t\t\tcvt_32(p, m);\n \t\treturn 1;\n \tcase FILE_LEQUAD:\n \tcase FILE_LEQDATE:\n@@ -990,14 +994,16 @@ mconvert(struct magic_set *ms, struct magic *m, int flip)\n \t\t     ((uint64_t)p->hq[5]<<40)|((uint64_t)p->hq[4]<<32)|\n \t\t     ((uint64_t)p->hq[3]<<24)|((uint64_t)p->hq[2]<<16)|\n \t\t     ((uint64_t)p->hq[1]<<8)|((uint64_t)p->hq[0]));\n-\t\tcvt_64(p, m);\n+\t\tif (type == FILE_LEQUAD)\n+\t\t\tcvt_64(p, m);\n \t\treturn 1;\n \tcase FILE_MELONG:\n \tcase FILE_MEDATE:\n \tcase FILE_MELDATE:\n \t\tp->l = (int32_t)\n \t\t    ((p->hl[1]<<24)|(p->hl[0]<<16)|(p->hl[3]<<8)|(p->hl[2]));\n-\t\tcvt_32(p, m);\n+\t\tif (type == FILE_MELONG)\n+\t\t\tcvt_32(p, m);\n \t\treturn 1;\n \tcase FILE_FLOAT:\n \t\tcvt_float(p, m);\n@@ -1054,7 +1060,7 @@ mdebug(uint32_t offset, const char *str, size_t len)\n \n private int\n mcopy(struct magic_set *ms, union VALUETYPE *p, int type, int indir,\n-    const unsigned char *s, uint32_t offset, size_t nbytes, size_t linecnt)\n+    const unsigned char *s, uint32_t offset, size_t nbytes, struct magic *m)\n {\n \t/*\n \t * Note: FILE_SEARCH and FILE_REGEX do not actually copy\n@@ -1074,15 +1080,29 @@ mcopy(struct magic_set *ms, union VALUETYPE *p, int type, int indir,\n \t\t\tconst char *last;\t/* end of search region */\n \t\t\tconst char *buf;\t/* start of search region */\n \t\t\tconst char *end;\n-\t\t\tsize_t lines;\n+\t\t\tsize_t lines, linecnt, bytecnt;\n \n \t\t\tif (s == NULL) {\n \t\t\t\tms->search.s_len = 0;\n \t\t\t\tms->search.s = NULL;\n \t\t\t\treturn 0;\n \t\t\t}\n+\n+\t\t\tif (m->str_flags & REGEX_LINE_COUNT) {\n+\t\t\t\tlinecnt = m->str_range;\n+\t\t\t\tbytecnt = linecnt * 80;\n+\t\t\t} else {\n+\t\t\t\tlinecnt = 0;\n+\t\t\t\tbytecnt = m->str_range;\n+\t\t\t}\n+\n+\t\t\tif (bytecnt == 0)\n+\t\t\t\tbytecnt = 8192;\n+\t\t\tif (bytecnt > nbytes)\n+\t\t\t\tbytecnt = nbytes;\n+\n \t\t\tbuf = RCAST(const char *, s) + offset;\n-\t\t\tend = last = RCAST(const char *, s) + nbytes;\n+\t\t\tend = last = RCAST(const char *, s) + bytecnt;\n \t\t\t/* mget() guarantees buf <= last */\n \t\t\tfor (lines = linecnt, b = buf; lines && b < end &&\n \t\t\t     ((b = CAST(const char *,\n@@ -1095,7 +1115,7 @@ mcopy(struct magic_set *ms, union VALUETYPE *p, int type, int indir,\n \t\t\t\t\tb++;\n \t\t\t}\n \t\t\tif (lines)\n-\t\t\t\tlast = RCAST(const char *, s) + nbytes;\n+\t\t\t\tlast = RCAST(const char *, s) + bytecnt;\n \n \t\t\tms->search.s = buf;\n \t\t\tms->search.s_len = last - buf;\n@@ -1166,7 +1186,6 @@ mget(struct magic_set *ms, const unsigned char *s, struct magic *m,\n     int *need_separator, int *returnval)\n {\n \tuint32_t soffset, offset = ms->offset;\n-\tuint32_t count = m->str_range;\n \tuint32_t lhs;\n \tint rv, oneed_separator, in_type;\n \tchar *sbuf, *rbuf;\n@@ -1179,13 +1198,12 @@ mget(struct magic_set *ms, const unsigned char *s, struct magic *m,\n \t}\n \n \tif (mcopy(ms, p, m->type, m->flag & INDIR, s, (uint32_t)(offset + o),\n-\t    (uint32_t)nbytes, count) == -1)\n+\t    (uint32_t)nbytes, m) == -1)\n \t\treturn -1;\n \n \tif ((ms->flags & MAGIC_DEBUG) != 0) {\n \t\tfprintf(stderr, \"mget(type=%d, flag=%x, offset=%u, o=%zu, \"\n-\t\t    \"nbytes=%zu, count=%u)\\n\", m->type, m->flag, offset, o,\n-\t\t    nbytes, count);\n+\t\t    \"nbytes=%zu)\\n\", m->type, m->flag, offset, o, nbytes);\n \t\tmdebug(offset, (char *)(void *)p, sizeof(union VALUETYPE));\n #ifndef COMPILE_ONLY\n \t\tfile_mdump(m);\n@@ -1550,7 +1568,7 @@ mget(struct magic_set *ms, const unsigned char *s, struct magic *m,\n \t\t\tif ((ms->flags & MAGIC_DEBUG) != 0)\n \t\t\t\tfprintf(stderr, \"indirect +offs=%u\\n\", offset);\n \t\t}\n-\t\tif (mcopy(ms, p, m->type, 0, s, offset, nbytes, count) == -1)\n+\t\tif (mcopy(ms, p, m->type, 0, s, offset, nbytes, m) == -1)\n \t\t\treturn -1;\n \t\tms->offset = offset;\n \n@@ -1906,7 +1924,8 @@ magiccheck(struct magic_set *ms, struct magic *m)\n \t\t\tif (slen + idx > ms->search.s_len)\n \t\t\t\tbreak;\n \n-\t\t\tv = file_strncmp(m->value.s, ms->search.s + idx, slen, m->str_flags);\n+\t\t\tv = file_strncmp(m->value.s, ms->search.s + idx, slen,\n+\t\t\t    m->str_flags);\n \t\t\tif (v == 0) {\t/* found match */\n \t\t\t\tms->search.offset += idx;\n \t\t\t\tbreak;\n@@ -1929,16 +1948,11 @@ magiccheck(struct magic_set *ms, struct magic *m)\n \t\t\tfile_regerror(&rx, rc, ms);\n \t\t\tv = (uint64_t)-1;\n \t\t} else {\n-#ifndef REG_STARTEND\n-\t\t\tchar c;\n-#endif\n \t\t\tregmatch_t pmatch[1];\n \t\t\tsize_t slen = ms->search.s_len;\n-\t\t\t/* Limit by offset if requested */\n-\t\t\tif (m->str_range > 0)\n-\t\t\t\tslen = MIN(slen, m->str_range);\n #ifndef REG_STARTEND\n #define\tREG_STARTEND\t0\n+\t\t\tchar c;\n \t\t\tif (slen != 0)\n \t\t\t\tslen--;\n \t\t\tc = ms->search.s[slen];"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 4,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "1778642b8ba3d947a779a36fcd81f8e807220a19",
            "date": "2024-12-31T19:57:14Z",
            "author_login": "zoulasc"
          },
          {
            "sha": "3dc6947b16641458a600bdfb7a23db5064887019",
            "date": "2024-12-31T19:50:33Z",
            "author_login": "zoulasc"
          },
          {
            "sha": "54b98feb13b49ec3a66cb151c4321629424a5e74",
            "date": "2024-12-31T19:41:08Z",
            "author_login": "zoulasc"
          },
          {
            "sha": "81e3eb0ca228239f5f2edccb2196da8e430f44bf",
            "date": "2024-12-31T19:38:03Z",
            "author_login": "zoulasc"
          },
          {
            "sha": "48b38ab6e30d113b68a200d29c237b97fdd531e8",
            "date": "2024-12-31T19:02:48Z",
            "author_login": "zoulasc"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": null,
    "cvss_vector": null,
    "cwe_id": "CWE-399",
    "description": "file before 5.19 does not properly restrict the amount of data read during a regex search, which allows remote attackers to cause a denial of service (CPU consumption) via a crafted file that triggers backtracking during processing of an awk rule.  NOTE: this vulnerability exists because of an incomplete fix for CVE-2013-7345.",
    "attack_vector": null,
    "attack_complexity": null
  },
  "temporal_data": {
    "published_date": "2014-07-03T14:55:07.537",
    "last_modified": "2024-11-21T02:08:19.783",
    "fix_date": "2014-06-03T19:01:34Z"
  },
  "references": [
    {
      "url": "http://lists.apple.com/archives/security-announce/2015/Apr/msg00001.html",
      "source": "secalert@redhat.com",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://mx.gw.com/pipermail/file/2014/001553.html",
      "source": "secalert@redhat.com",
      "tags": [
        "Broken Link"
      ]
    },
    {
      "url": "http://openwall.com/lists/oss-security/2014/06/30/7",
      "source": "secalert@redhat.com",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://rhn.redhat.com/errata/RHSA-2014-1327.html",
      "source": "secalert@redhat.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://rhn.redhat.com/errata/RHSA-2014-1765.html",
      "source": "secalert@redhat.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://rhn.redhat.com/errata/RHSA-2014-1766.html",
      "source": "secalert@redhat.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://rhn.redhat.com/errata/RHSA-2016-0760.html",
      "source": "secalert@redhat.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://secunia.com/advisories/60696",
      "source": "secalert@redhat.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.debian.org/security/2014/dsa-3008",
      "source": "secalert@redhat.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.debian.org/security/2014/dsa-3021",
      "source": "secalert@redhat.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.oracle.com/technetwork/security-advisory/cpuoct2017-3236626.html",
      "source": "secalert@redhat.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.oracle.com/technetwork/topics/security/bulletinjan2015-2370101.html",
      "source": "secalert@redhat.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.oracle.com/technetwork/topics/security/linuxbulletinapr2016-2952096.html",
      "source": "secalert@redhat.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.oracle.com/technetwork/topics/security/linuxbulletinoct2015-2719645.html",
      "source": "secalert@redhat.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.securityfocus.com/bid/68348",
      "source": "secalert@redhat.com",
      "tags": [
        "Third Party Advisory",
        "VDB Entry"
      ]
    },
    {
      "url": "https://bugzilla.redhat.com/show_bug.cgi?id=1098222",
      "source": "secalert@redhat.com",
      "tags": [
        "Issue Tracking",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/file/file/commit/4a284c89d6ef11aca34da65da7d673050a5ea320",
      "source": "secalert@redhat.com",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/file/file/commit/69a5a43b3b71f53b0577f41264a073f495799610",
      "source": "secalert@redhat.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/file/file/commit/71a8b6c0d758acb0f73e2e51421a711b5e9d6668",
      "source": "secalert@redhat.com",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/file/file/commit/74cafd7de9ec99a14f4480927580e501c8f852c3",
      "source": "secalert@redhat.com",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/file/file/commit/758e066df72fb1ac08d2eea91ddc3973d259e991",
      "source": "secalert@redhat.com",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://support.apple.com/HT204659",
      "source": "secalert@redhat.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://lists.apple.com/archives/security-announce/2015/Apr/msg00001.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://mx.gw.com/pipermail/file/2014/001553.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Broken Link"
      ]
    },
    {
      "url": "http://openwall.com/lists/oss-security/2014/06/30/7",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://rhn.redhat.com/errata/RHSA-2014-1327.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://rhn.redhat.com/errata/RHSA-2014-1765.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://rhn.redhat.com/errata/RHSA-2014-1766.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://rhn.redhat.com/errata/RHSA-2016-0760.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://secunia.com/advisories/60696",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.debian.org/security/2014/dsa-3008",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.debian.org/security/2014/dsa-3021",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.oracle.com/technetwork/security-advisory/cpuoct2017-3236626.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.oracle.com/technetwork/topics/security/bulletinjan2015-2370101.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.oracle.com/technetwork/topics/security/linuxbulletinapr2016-2952096.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.oracle.com/technetwork/topics/security/linuxbulletinoct2015-2719645.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.securityfocus.com/bid/68348",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory",
        "VDB Entry"
      ]
    },
    {
      "url": "https://bugzilla.redhat.com/show_bug.cgi?id=1098222",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Issue Tracking",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/file/file/commit/4a284c89d6ef11aca34da65da7d673050a5ea320",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/file/file/commit/69a5a43b3b71f53b0577f41264a073f495799610",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/file/file/commit/71a8b6c0d758acb0f73e2e51421a711b5e9d6668",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/file/file/commit/74cafd7de9ec99a14f4480927580e501c8f852c3",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/file/file/commit/758e066df72fb1ac08d2eea91ddc3973d259e991",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://support.apple.com/HT204659",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T22:58:25.508790",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "file",
    "owner": "file",
    "created_at": "2011-01-28T15:20:14Z",
    "updated_at": "2025-01-14T07:46:32Z",
    "pushed_at": "2024-12-31T20:00:10Z",
    "size": 10253,
    "stars": 1318,
    "forks": 380,
    "open_issues": 0,
    "watchers": 1318,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "C": 578279,
      "Makefile": 18126,
      "Python": 15517,
      "M4": 14679,
      "Shell": 3261,
      "Dockerfile": 870
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T13:14:52.128425"
  }
}