{
  "cve_id": "CVE-2014-3772",
  "github_data": {
    "repository": "nilsteampassnet/TeamPass",
    "fix_commit": "7715512f2bd5659cc69e063a1c513c19e384340f",
    "related_commits": [
      "7715512f2bd5659cc69e063a1c513c19e384340f",
      "7715512f2bd5659cc69e063a1c513c19e384340f"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "7715512f2bd5659cc69e063a1c513c19e384340f",
      "commit_date": "2014-04-18T09:55:28Z",
      "author": {
        "login": "nilsteampassnet",
        "type": "User",
        "stats": {
          "total_commits": 2012,
          "average_weekly_commits": 2.9415204678362574,
          "total_additions": 5301385,
          "total_deletions": 4813706,
          "weeks_active": 411
        }
      },
      "commit_message": {
        "title": "2.1.20",
        "length": 6,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 1832,
        "additions": 1477,
        "deletions": 355
      },
      "files": [
        {
          "filename": "admin.php",
          "status": "modified",
          "additions": 13,
          "deletions": 1,
          "patch": "@@ -12,10 +12,22 @@\n  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n  */\n \n-if (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1) {\n+if (\n+    !isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 || \n+    !isset($_SESSION['user_id']) || empty($_SESSION['user_id']) || \n+    !isset($_SESSION['key']) || empty($_SESSION['key'])) \n+{\n     die('Hacking attempt...');\n }\n \n+/* do checks */\n+require_once $_SESSION['settings']['cpassman_dir'].'/sources/checks.php';\n+if (!checkUser($_SESSION['user_id'], $_SESSION['key'], \"users.php\")) {\n+    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n+    include 'error.php';\n+    exit();\n+}\n+\n echo '\n     <div class=\"title ui-widget-content ui-corner-all\">'.$txt['admin'].'</div>\n     <div style=\"width:900px;margin-left:50px; line-height:25px;height:100%;overflow:auto;\">';"
        },
        {
          "filename": "admin.settings.php",
          "status": "modified",
          "additions": 34,
          "deletions": 4,
          "patch": "@@ -13,10 +13,22 @@\n  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n  */\n \n-if (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1) {\n+if (\n+    !isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 || \n+    !isset($_SESSION['user_id']) || empty($_SESSION['user_id']) || \n+    !isset($_SESSION['key']) || empty($_SESSION['key'])) \n+{\n     die('Hacking attempt...');\n }\n \n+/* do checks */\n+require_once $_SESSION['settings']['cpassman_dir'].'/sources/checks.php';\n+if (!checkUser($_SESSION['user_id'], $_SESSION['key'], curPage())) {\n+    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n+    include 'error.php';\n+    exit();\n+}\n+\n /*\n * FUNCTION permitting to store into DB the settings changes\n */\n@@ -37,7 +49,14 @@ function updateSettings ($setting, $val, $type = '')\n     $db->connect();\n \n     // Check if setting is already in DB. If NO then insert, if YES then update.\n-    $data = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"misc WHERE type='\".$type.\"' AND intitule = '\".$setting.\"'\");\n+    //$data = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"misc WHERE type='\".$type.\"' AND intitule = '\".$setting.\"'\");\n+    $data = $db->queryCount(\n+        \"misc\",\n+        array(\n+            \"type\" => $type,\n+            \"intitule\" => $setting\n+        )\n+    );\n     if ($data[0] == 0) {\n         $db->queryInsert(\n             \"misc\",\n@@ -69,7 +88,14 @@ function updateSettings ($setting, $val, $type = '')\n         // in case of stats enabled, update the actual time\n         if ($setting == 'send_stats') {\n             // Check if previous time exists, if not them insert this value in DB\n-            $data_time = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"misc WHERE type='\".$type.\"' AND intitule = '\".$setting.\"_time'\");\n+            //$data_time = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"misc WHERE type='\".$type.\"' AND intitule = '\".$setting.\"_time'\");\n+            $data_time = $db->queryCount(\n+                \"misc\",\n+                array(\n+                    \"type\" => $type,\n+                    \"intitule\" => $setting.\"_time\"\n+                )\n+            );\n             if ($data_time[0] == 0) {\n                 $db->queryInsert(\n                     \"misc\",\n@@ -1843,7 +1869,11 @@ function updateSettings ($setting, $val, $type = '')\n                         </td>\n                     </tr>';\n // Send emails backlog\n-$nb_emails = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"emails WHERE status = 'not_sent' OR status = ''\");\n+//$nb_emails = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"emails WHERE status = 'not_sent' OR status = ''\");\n+$nb_emails = $db->queryCount(\n+    \"emails\",\n+    \"status = 'not_sent' OR status = ''\"\n+);\n echo '\n                     <tr style=\"margin-bottom:3px\">\n                         <td>"
        },
        {
          "filename": "admin.settings_categories.php",
          "status": "modified",
          "additions": 8,
          "deletions": 1,
          "patch": "@@ -189,7 +189,14 @@\n         <select id=\"cat_folders_selection\" multiple size=\"12\">';\n         $folders = $tree->getDescendants();\n         foreach ($folders as $folder) {\n-            $data = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"nested_tree WHERE personal_folder=0 AND id = \".$folder->id);\n+            //$data = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"nested_tree WHERE personal_folder=0 AND id = \".$folder->id);\n+            $data = $db->queryCount(\n+                \"nested_tree\",\n+                array(\n+                    \"personal_folder\" => 0,\n+                    \"id\" => $folder->id\n+                )\n+            );\n             if ($data[0] > 0) {\n                 echo '\n                 <option value=\"'.$folder->id.'\">'.str_replace(\"&\", \"&amp;\", $folder->title).'</option>';"
        },
        {
          "filename": "changelog.md",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -12,6 +12,7 @@\n  #472 - Error on line 582 index.php\n  #474 - Set default to checked for secure passwords\n  #497 - Moved GA QR code creation to administration\n+ #xxx - Off-line mode, link make the page scroll up\n  Fork from slimm609 - Encrypted Sessions and CSRFGuard enabled\n  Issues with folder creation in \"personal folder\"\n "
        },
        {
          "filename": "datatable.logs.php",
          "status": "modified",
          "additions": 19,
          "deletions": 7,
          "patch": "@@ -1,9 +1,9 @@\n <?php\n /**\n- * @file          datatable.users_logged.php\n- * @author        Nils Laumaill\ufffd\n+ * @file          datatable.logs.php\n+ * @author        Nils Laumaill\u00e9\n  * @version       2.1.19\n- * @copyright     (c) 2009-2014 Nils Laumaill\ufffd\n+ * @copyright     (c) 2009-2014 Nils Laumaill\u00e9\n  * @licensing     GNU AFFERO GPL 3.0\n  * @link          http://www.teampass.net\n  *\n@@ -14,10 +14,22 @@\n \n require_once('sources/sessions.php');\n session_start();\n-if (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1) {\n+if (\n+    !isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 ||\n+    !isset($_SESSION['user_id']) || empty($_SESSION['user_id']) || \n+    !isset($_SESSION['key']) || empty($_SESSION['key']))\n+{\n     die('Hacking attempt...');\n }\n \n+/* do checks */\n+require_once $_SESSION['settings']['cpassman_dir'].'/sources/checks.php';\n+if (!checkUser($_SESSION['user_id'], $_SESSION['key'], \"manage_views\")) {\n+    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n+    include 'error.php';\n+    exit();\n+}\n+\n require_once $_SESSION['settings']['cpassman_dir'].'/sources/SplClassLoader.php';\n \n global $k, $settings;\n@@ -42,7 +54,7 @@\n     //Paging\n     $sLimit = \"\";\n     if (isset($_GET['iDisplayStart']) && $_GET['iDisplayLength'] != '-1') {\n-        $sLimit = \"LIMIT \". $_GET['iDisplayStart'] .\", \". $_GET['iDisplayLength'] ;\n+        $sLimit = \"LIMIT \". mysql_real_escape_string($_GET['iDisplayStart']) .\", \". mysql_real_escape_string($_GET['iDisplayLength']) .\"\" ;\n     }\n \n     //Ordering\n@@ -51,8 +63,8 @@\n         $sOrder = \"ORDER BY  \";\n         for ($i=0; $i<intval($_GET['iSortingCols']); $i++) {\n             if ($_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == \"true\") {\n-                $sOrder .= $aColumns[ intval($_GET['iSortCol_'.$i]) ].\"\n-                        \".mysql_real_escape_string($_GET['sSortDir_'.$i]) .\", \";\n+                $sOrder .= $aColumns[ intval(mysql_real_escape_string($_GET['iSortCol_'.$i])) ].\"\n+                        '\".mysql_real_escape_string($_GET['sSortDir_'.$i]) .\"', \";\n             }\n         }\n "
        },
        {
          "filename": "error.php",
          "status": "modified",
          "additions": 3,
          "deletions": 0,
          "patch": "@@ -63,6 +63,9 @@\n     } elseif (@$_SESSION['error']['code'] == ERR_NO_MCRYPT) {\n         echo '\n         <div class=\"ui-state-error ui-corner-all error\" style=\"text-align:center;\" >'.$txt['error_mcrypt_not_loaded'].'<br /><br /><a href=\"index.php\" />'.$txt['home'] .'</a></div>';\n+    } elseif (@$_SESSION['error']['code'] == ERR_VALID_SESSION) {\n+        echo '\n+        <div class=\"ui-state-error ui-corner-all error\" style=\"text-align:center;\" >'.$txt['error_not_authorized'].'<br /><br /><a href=\"index.php\" />'.$txt['home'] .'</a></div>';\n     }\n }\n "
        },
        {
          "filename": "find.php",
          "status": "modified",
          "additions": 13,
          "deletions": 1,
          "patch": "@@ -9,10 +9,22 @@\n  * @link\n  */\n \n-if (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1) {\n+if (\n+    !isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 || \n+    !isset($_SESSION['user_id']) || empty($_SESSION['user_id']) || \n+    !isset($_SESSION['key']) || empty($_SESSION['key'])) \n+{\n     die('Hacking attempt...');\n }\n \n+/* do checks */\n+require_once $_SESSION['settings']['cpassman_dir'].'/sources/checks.php';\n+if (!checkUser($_SESSION['user_id'], $_SESSION['key'], curPage())) {\n+    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n+    include 'error.php';\n+    exit();\n+}\n+\n require_once $_SESSION['settings']['cpassman_dir'].'/sources/SplClassLoader.php';\n \n // Build list of visible folders"
        },
        {
          "filename": "folders.php",
          "status": "modified",
          "additions": 81,
          "deletions": 34,
          "patch": "@@ -13,10 +13,22 @@\n  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n  */\n \n-if (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1) {\n+if (\n+    !isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 || \n+    !isset($_SESSION['user_id']) || empty($_SESSION['user_id']) || \n+    !isset($_SESSION['key']) || empty($_SESSION['key'])) \n+{\n     die('Hacking attempt...');\n }\n \n+/* do checks */\n+require_once $_SESSION['settings']['cpassman_dir'].'/sources/checks.php';\n+if (!checkUser($_SESSION['user_id'], $_SESSION['key'], curPage())) {\n+    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n+    include 'error.php';\n+    exit();\n+}\n+\n require_once $_SESSION['settings']['cpassman_dir'].'/sources/SplClassLoader.php';\n \n /* load help*/\n@@ -89,7 +101,16 @@\n foreach ($tst as $t) {\n     if (in_array($t->id, $_SESSION['groupes_visibles']) && !in_array($t->id, $_SESSION['personal_visible_groups'])) {\n         // r?cup $t->parent_id\n-        $data = $db->fetchRow(\"SELECT title FROM \".$pre.\"nested_tree WHERE id = \".$t->parent_id);\n+        //$data = $db->fetchRow(\"SELECT title FROM \".$pre.\"nested_tree WHERE id = \".$t->parent_id);\n+        $data = $db->queryGetRow(\n+            \"nested_tree\",\n+            array(\n+                \"title\"\n+            ),\n+            array(\n+                \"id\" => intval($t->parent_id)\n+            )\n+        );\n         if ($t->nlevel == 1) {\n             $data[0] = $txt['root'];\n         }\n@@ -105,48 +126,74 @@\n             $ident .= \"&nbsp;&nbsp;\";\n         }\n         // Get some elements from DB concerning this node\n-        $node_data = $db->fetchRow(\n+        /*$node_data = $db->fetchRow(\n             \"SELECT m.valeur as valeur, n.renewal_period as renewal_period\n             FROM \".$pre.\"misc as m,\n             \".$pre.\"nested_tree as n\n             WHERE m.type='complex'\n             AND m.intitule = n.id\n             AND m.intitule = \".$t->id\n+        );*/\n+        $node_data = $db->queryGetRow(\n+            array(\n+                \"misc\" => \"m\",\n+                \"nested_tree\" => \"n\"\n+            ),\n+            array(\n+                \"m.valeur\" => \"valeur\",\n+                \"n.renewal_period\" => \"renewal_period\"\n+            ),\n+            array(\n+                \"m.type\" => \"complex\",\n+                \"m.intitule\" => intval(n.id),\n+                \"m.intitule\" => intval($t->id)\n+            )\n         );\n \n-        echo '<tr class=\"ligne0\" id=\"row_'.$t->id.'\">\n-                        <td align=\"center\" onclick=\"open_edit_folder_dialog('.$t->id.')\">'.$t->id.'</td>\n-                        <td width=\"50%\" onclick=\"open_edit_folder_dialog('.$t->id.')\">\n-                            '.$ident.'<span id=\"title_'.$t->id.'\">'.$t->title.'</span>\n-                        </td>\n-                        <td align=\"center\" onclick=\"open_edit_folder_dialog('.$t->id.')\">\n-                            <span id=\"complexite_'.$t->id.'\">'.@$pwComplexity[$node_data[0]][1].'</span>\n-                        </td>\n-                        <td align=\"center\" onclick=\"open_edit_folder_dialog('.$t->id.')\">\n-                            <span id=\"parent_'.$t->id.'\">'.$data[0].'</span>\n-                        </td>\n-                        <td align=\"center\" onclick=\"open_edit_folder_dialog('.$t->id.')\">\n-                            '.$t->nlevel.'\n-                        </td>\n-                        <td align=\"center\" onclick=\"open_edit_folder_dialog('.$t->id.')\">\n-                            <span id=\"renewal_'.$t->id.'\">'.$node_data[1].'</span>\n-                        </td>\n-                        <td align=\"center\">\n-                            <img src=\"includes/images/folder--minus.png\" onclick=\"supprimer_groupe(\\''.$t->id.'\\')\" style=\"cursor:pointer;\" />\n-                        </td>';\n+        echo '\n+                <tr class=\"ligne0\" id=\"row_'.$t->id.'\">\n+                    <td align=\"center\" onclick=\"open_edit_folder_dialog('.$t->id.')\">'.$t->id.'</td>\n+                    <td width=\"50%\" onclick=\"open_edit_folder_dialog('.$t->id.')\">\n+                        '.$ident.'<span id=\"title_'.$t->id.'\">'.$t->title.'</span>\n+                    </td>\n+                    <td align=\"center\" onclick=\"open_edit_folder_dialog('.$t->id.')\">\n+                        <span id=\"complexite_'.$t->id.'\">'.@$pwComplexity[$node_data[0]][1].'</span>\n+                    </td>\n+                    <td align=\"center\" onclick=\"open_edit_folder_dialog('.$t->id.')\">\n+                        <span id=\"parent_'.$t->id.'\">'.$data[0].'</span>\n+                    </td>\n+                    <td align=\"center\" onclick=\"open_edit_folder_dialog('.$t->id.')\">\n+                        '.$t->nlevel.'\n+                    </td>\n+                    <td align=\"center\" onclick=\"open_edit_folder_dialog('.$t->id.')\">\n+                        <span id=\"renewal_'.$t->id.'\">'.$node_data[1].'</span>\n+                    </td>\n+                    <td align=\"center\">\n+                        <img src=\"includes/images/folder--minus.png\" onclick=\"supprimer_groupe(\\''.$t->id.'\\')\" style=\"cursor:pointer;\" />\n+                    </td>';\n \n-        $data3 = $db->fetchRow(\"SELECT bloquer_creation,bloquer_modification FROM \".$pre.\"nested_tree WHERE id = \".$t->id);\n+        //$data3 = $db->fetchRow(\"SELECT bloquer_creation,bloquer_modification FROM \".$pre.\"nested_tree WHERE id = \".$t->id);\n+        $data3 = $db->queryGetRow(\n+            array(\n+                \"bloquer_creation\",\n+                \"bloquer_modification\"\n+            ),\n+            \"nested_tree\",\n+            array(\n+                \"id\" => intval($t->id)\n+            )\n+        );\n         echo '\n-                        <td align=\"center\">\n-                            <input type=\"checkbox\" id=\"cb_droit_'.$t->id.'\" onchange=\"Changer_Droit_Complexite(\\''.$t->id.'\\',\\'creation\\')\"', isset($data3[0]) && $data3[0] == 1 ? 'checked' : '', ' />\n-                        </td>\n-                        <td align=\"center\">\n-                            <input type=\"checkbox\" id=\"cb_droit_modif_'.$t->id.'\" onchange=\"Changer_Droit_Complexite(\\''.$t->id.'\\',\\'modification\\')\"', isset($data3[1]) && $data3[1] == 1 ? 'checked' : '', ' />\n-                        </td>\n-                        <td>\n-                            <input type=\"hidden\"  id=\"parent_id_'.$t->id.'\" value=\"'.$t->parent_id.'\" />\n-                            <input type=\"hidden\"  id=\"renewal_id_'.$t->id.'\" value=\"'.$node_data[0].'\" />\n-                        </td>\n+                    <td align=\"center\">\n+                        <input type=\"checkbox\" id=\"cb_droit_'.$t->id.'\" onchange=\"Changer_Droit_Complexite(\\''.$t->id.'\\',\\'creation\\')\"', isset($data3[0]) && $data3[0] == 1 ? 'checked' : '', ' />\n+                    </td>\n+                    <td align=\"center\">\n+                        <input type=\"checkbox\" id=\"cb_droit_modif_'.$t->id.'\" onchange=\"Changer_Droit_Complexite(\\''.$t->id.'\\',\\'modification\\')\"', isset($data3[1]) && $data3[1] == 1 ? 'checked' : '', ' />\n+                    </td>\n+                    <td>\n+                        <input type=\"hidden\"  id=\"parent_id_'.$t->id.'\" value=\"'.$t->parent_id.'\" />\n+                        <input type=\"hidden\"  id=\"renewal_id_'.$t->id.'\" value=\"'.$node_data[0].'\" />\n+                    </td>\n                 </tr>';\n         array_push($arr_ids, $t->id);\n         $x++;"
        },
        {
          "filename": "home.php",
          "status": "modified",
          "additions": 8,
          "deletions": 1,
          "patch": "@@ -73,7 +73,14 @@\n         $cpt=1;\n         $rows = $db->fetchAllArray($sql);\n         foreach ($rows as $record) {\n-            $data = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"log_items WHERE id_item = '\".$record['id'].\"' AND action = 'at_delete'\");\n+            //$data = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"log_items WHERE id_item = '\".$record['id'].\"' AND action = 'at_delete'\");\n+            $data = $db->queryCount(\n+                \"log_items\",\n+                array(\n+                    \"id_item\" => intval($record['id']),\n+                    \"action\" => \"at_delete\"\n+                )\n+            );\n             if ($data[0] == 0) {\n                 echo '<span class=\"ui-icon ui-icon-tag\" style=\"float: left; margin-right: .3em;\">&nbsp;</span>\n                 <a href=\"#\" onClick=\"javascript:$(\\'#menu_action\\').val(\\'action\\');window.location.href =\\'index.php?page=items&amp;group='.$record['id_tree'].'&amp;id='.$record['id'].'\\';\" style=\"cursor:pointer;\">'.stripslashes($record['label']).'</a><br />';"
        },
        {
          "filename": "includes/images/ajax-loader.gif",
          "status": "modified",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "includes/images/ajax-loader_old.gif",
          "status": "removed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "includes/images/phone.png",
          "status": "removed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "includes/images/phone_add.png",
          "status": "removed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "includes/images/phone_sound.png",
          "status": "removed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "includes/images/ui-toolbar-bookmark.png",
          "status": "added",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "includes/include.php",
          "status": "modified",
          "additions": 0,
          "deletions": 1,
          "patch": "@@ -13,7 +13,6 @@\n \n $k['version'] = \"2.1.20\";\n $k['tool_name'] = \"TeamPass\";\n-$k['copyright'] = \"&nbsp;&copy;&nbsp;copyright 2009-2014\";\n $k['jquery-version'] = \"1.9.1\";\n $k['jquery-ui-version'] = \"1.10.3\";\n $k['jquery-ui-theme'] = \"overcast\";"
        },
        {
          "filename": "includes/language/english.php",
          "status": "modified",
          "additions": 1,
          "deletions": 8,
          "patch": "@@ -6,13 +6,6 @@\n     $TeamPass_url = $_SESSION['settings']['cpassman_url'];\n }\n \n-$txt['user_ga_code'] = \"Send GoogleAuthenticator to user by email\";\n-$txt['send_ga_code'] = \"Google Authenticator for user\";\n-$txt['error_no_email'] = \"This user has no email set!\";\n-$txt['error_no_user'] = \"No user found!\";\n-$txt['email_ga_subject'] = \"Your Google Authenticator flash code for Teampass\";\n-$txt['email_ga_text'] = \"Hello,<br><br>Please click this <a href='#link#'>LINK</a> and flash it with GoogleAuthenticator application to get your OTP credentials for Teampass.<br /><br />Cheers\";\n-\n $txt['settings_attachments_encryption'] = \"Enable encryption of Items attachments\";\n $txt['settings_attachments_encryption_tip'] = \"THIS OPTION COULD BREAK EXISTING ATTACHMENTS, please read carefully the next. If enabled, Items attachments are stored encrypted on the server. The ecryption uses the SALT defined for Teampass. This requieres more server ressources. WARNING: once you change strategy, it is mandatory to run the script to adapt existing attachments. See tab 'Specific Actions'.\";\n $txt['admin_action_attachments_cryption'] = \"Encrypt or Decrypt the Items attachments\";\n@@ -99,7 +92,7 @@\n $txt['purge_log'] = \"Purge logs from\";\n $txt['to'] = \"to\";\n $txt['purge_now'] = \"Purge Now!\";\n-$txt['purge_done'] = \"Purge done! Number of elements deleted: \";\n+$txt['purge_done'] = \"The purge has been performed!<br />Number of elements deleted: \";\n \n $txt['settings_upload_maxfilesize_tip'] = \"Maximum file size you allow. It should be coherant with your server settings.\";\n $txt['settings_upload_docext_tip'] = \"Document types. Indicate the file extensions allowed separated with a coma (,)\";"
        },
        {
          "filename": "includes/libraries/Authentication/GoogleAuthenticator/GoogleAuthenticator.php",
          "status": "modified",
          "additions": 2,
          "deletions": 12,
          "patch": "@@ -38,24 +38,14 @@ public function __construct($passCodeLength = 6, $secretLength = 10)\n      * @param $code\n      * @return bool\n      */\n-    public function checkCode($secret, $code, $discrepancy = 3)\n+    public function checkCode($secret, $code)\n     {\n-        /*\n-       $time = floor(time() / 30);\n+        $time = floor(time() / 30);\n         for ($i = -1; $i <= 1; $i++) {\n             if ($this->getCode($secret, $time + $i) == $code) {\n                 return true;\n             }\n         }\n-   \t\t*/\n-    \t$currentTimeSlice = floor(time() / 30);\n-\n-    \tfor ($i = -$discrepancy; $i <= $discrepancy; $i++) {\n-    \t\t$calculatedCode = $this->getCode($secret, $currentTimeSlice + $i);\n-    \t\tif ($calculatedCode == $code ) {\n-    \t\t\treturn true;\n-    \t\t}\n-    \t}\n \n         return false;\n     }"
        },
        {
          "filename": "includes/libraries/Database/Core/DbCore.php",
          "status": "modified",
          "additions": 145,
          "deletions": 4,
          "patch": "@@ -167,7 +167,148 @@ public function fetchRow($sql)\n         $this->freeResult($query_id);\n \n         return $record;\n-    }#-#fetchArray()\n+    }#-#fetchRow()\n+\n+    #-#############################################\n+    # desc: builds the sql query\n+    # param: tables, inputs, conditions, extras\n+    # return: string SQL query\n+    public function prepareData($table, $data, $where, $extra = \"\", $inner = \"\")\n+    {\n+        $q = \"SELECT \";\n+\n+        // data\n+        $d = \"\";\n+        if (is_array($data)) {\n+            foreach ($data as $key => $val) {\n+                if (is_int($key)) {\n+                    $d .= \"`\".$this->escape($val).\"`, \";\n+                } else {\n+                    if (strpos($key,'.') === false) {\n+                        $d .= \"`$key` AS $val, \";\n+                    } else {\n+                        $d .= \"$key AS $val, \";\n+                    }\n+                }\n+            }\n+            $q .= substr_replace($d, \"\", -2);\n+        } else {\n+            $d = $data.\" \";\n+        }\n+\n+        // table\n+        if (is_array($table)) {\n+            $t = \"\";\n+            $q .= \" FROM \";\n+            foreach ($table as $key => $val) {\n+                $t .= \"`\".$this->pre.$key.\"` AS \".$this->escape($val).\", \";\n+            }\n+            $q .= substr_replace($t, \"\", -2).\" \";\n+        } else {\n+            $q .= \" FROM `\".$this->pre.$table.\"` \";\n+        }\n+\n+        // inner join conditions\n+        if (!empty($inner)) {\n+            $i = \"\";\n+            foreach ($inner as $key => $val) {\n+                $i .= \"INNER JOIN \".$this->pre.$key.\" ON \".$val.\" \";\n+            }\n+            $q .= $i;\n+        }\n+\n+        // where\n+        $w = \"\";\n+        foreach ($where as $key => $val) {\n+            if (strtolower($val) == 'null') {\n+                $w .= \"`$key` = NULL, \";\n+            } elseif (strtolower($val)=='now()') {\n+                $w .= \"`$key` = NOW(), \";\n+            } else {\n+                if (strpos($key,'.') === false) {\n+                    $w .= \"`$key` = '\".$this->escape($val).\"' AND \";\n+                } else {\n+                    $w .= \"$key = '\".$this->escape($val).\"' AND \";\n+                }\n+            }\n+        }\n+\n+        // compile\n+        return rtrim($q, ', ').' WHERE '. rtrim($w, ' AND ') . $extra .';';\n+    }#-#prepareData()\n+\n+    #-#############################################\n+    # desc: fetches and return result of one line\n+    # param: table (no prefix), array of fields to return, array for where conditions\n+    # return: (array) fetched record\n+    public function queryGetRow($table, $data, $where, $extra = \"\", $inner = \"\")\n+    {\n+        $q =  $this->prepareData($table, $data, $where, $extra, $inner);\n+\n+        $query_id = $this->query($q);\n+\n+        if (isset($this->query_id)) {\n+            $record = mysql_fetch_row($this->query_id);\n+        } else {\n+            $this->oops(\"Invalid query_id: <b>$this->query_id</b>. Records could not be fetched.\");\n+        }\n+\n+        $this->freeResult($query_id);\n+\n+        return $record;\n+    }#-#queryGetRow()\n+\n+    #-#############################################\n+    # desc: fetches and return result of one line\n+    # param: table (no prefix), array of fields to return, array for where conditions\n+    # return: (array) fetched record\n+    public function queryGetArray($table, $data, $where, $extra = \"\", $inner = \"\")\n+    {\n+        $q =  $this->prepareData($table, $data, $where, $extra, $inner);\n+\n+        $query_id = $this->query($q);\n+\n+        if (isset($this->query_id)) {\n+            $record = mysql_fetch_assoc($this->query_id) or die(mysql_error().\" | \".$q);\n+        } else {\n+            $this->oops(\"Invalid query_id: <b>$this->query_id</b>. Records could not be fetched.\");\n+        }\n+\n+        $this->freeResult($query_id);\n+\n+        return $record;\n+    }#-#queryGetRow()\n+\n+    #-#############################################\n+    # desc: fetches and return the number of lines\n+    # param: table (no prefix), array of fields to return, array for where conditions\n+    # return: (array) fetched record\n+    public function queryCount($table, $where)\n+    {\n+        $q = \"SELECT COUNT(*) FROM `\".$this->pre.$table.\"` \";\n+\n+        if (is_array($where)) {\n+            $w = \"\";\n+            foreach ($where as $key => $val) {\n+                if (strtolower($val) == 'null') {\n+                    $w .= \"`$key` = NULL, \";\n+                } elseif (strtolower($val)=='now()') {\n+                    $w .= \"`$key` = NOW(), \";\n+                } else {\n+                    $w .= \"`$key`='\".$this->escape($val).\"' AND \";\n+                }\n+            }\n+        } else {\n+            $w = $where;\n+        }\n+        $q = rtrim($q, ', ').' WHERE '. rtrim($w, ' AND ') .';';\n+\n+        $query_id = $this->query($q);\n+        $out = mysql_fetch_row($query_id);\n+        $this->freeResult($query_id);\n+\n+        return $out;\n+    }\n \n \n     #-#############################################\n@@ -289,12 +430,12 @@ public function queryInsert($table, $data)\n         }\n \n         $q .= \"(\". rtrim($n, ', ') .\") VALUES (\". rtrim($v, ', ') .\");\";\n-        \n+\n         $this->query($q);\n-        \n+\n         if (isset($this->link_id)) {\n             return mysql_insert_id($this->link_id);\n-        } else {            \n+        } else {\n             $this->oops(\"Result ID: <b>$this->query_id</b> could not be executed.\");\n             return false;\n         }"
        },
        {
          "filename": "includes/settings.php",
          "status": "modified",
          "additions": 3,
          "deletions": 3,
          "patch": "@@ -6,10 +6,10 @@\n $server = \"localhost\";\n $user = \"root\";\n $pass = \"\";\n-$database = \"tp\";\n+$database = \"tpssl\";\n $pre = \"teampass_\";\n \n @date_default_timezone_set($_SESSION['settings']['timezone']);\n-@define('SECUREPATH', 'E:/xampp/security');\n-require_once \"E:/xampp/security/sk.php\";\n+@define('SECUREPATH', 'C:/nils.laumaille/utils/xamppssl/security');\n+require_once \"C:/nils.laumaille/utils/xamppssl/security/sk.php\";\n @define('COST', '13'); // Don't change this.\n\\ No newline at end of file"
        },
        {
          "filename": "index.php",
          "status": "modified",
          "additions": 25,
          "deletions": 3,
          "patch": "@@ -22,6 +22,7 @@\n \n $_SESSION['CPM'] = 1;\n session_id();\n+\n // Test if settings.file exists, if not then install\n if (!file_exists('includes/settings.php')) {\n     echo '\n@@ -54,11 +55,21 @@\n /* DEFINE WHAT LANGUAGE TO USE */\n if (!isset($_SESSION['user_id']) && !isset($_POST['language'])) {\n     //get default language\n-    $dataLanguage =\n+    /*$dataLanguage =\n         $db->fetchRow(\n             \"SELECT valeur FROM \".$pre.\"misc\n             WHERE type = 'admin' AND intitule = 'default_language'\"\n-        );\n+        );*/\n+    $dataLanguage = $db->queryGetRow(\n+        \"misc\",\n+        array(\n+            \"valeur\"\n+        ),\n+        array(\n+            \"type\" => \"admin\",\n+            \"intitule\" => \"default_language\"\n+        )\n+    );\n     if (empty($dataLanguage[0])) {\n         $_SESSION['user_language'] = \"english\";\n         $_SESSION['user_language_flag'] = \"us.png\";\n@@ -278,7 +289,9 @@\n             <br />\n             <button title=\"'.$txt['pw_copy_clipboard'].'\" id=\"menu_button_copy_pw\" class=\"copy_clipboard\"><img src=\"includes/images/ui-text-field-password.png\" id=\"div_copy_pw\" alt=\"\" /></button>\n             <br />\n-            <button title=\"'.$txt['login_copy'].'\" style=\"margin-bottom:5px;\" id=\"menu_button_copy_login\" class=\"copy_clipboard\"><img src=\"includes/images/ui-text-field.png\" id=\"div_copy_login\" alt=\"\" /></button>\n+            <button title=\"'.$txt['login_copy'].'\" id=\"menu_button_copy_login\" class=\"copy_clipboard\"><img src=\"includes/images/ui-text-field.png\" id=\"div_copy_login\" alt=\"\" /></button>\n+            <br />\n+            <button title=\"'.$txt['url_copy'].'\" style=\"margin-bottom:5px;\" id=\"menu_button_copy_url\" class=\"copy_clipboard\"><img src=\"includes/images/ui-toolbar-bookmark.png\" id=\"div_copy_url\" alt=\"\" /></button>\n             <br />\n             <button title=\"'.$txt['mask_pw'].'\" style=\"margin-bottom:5px;\" id=\"menu_button_show_pw\" onclick=\"ShowPassword()\"><img src=\"includes/images/eye.png\" alt=\"\" /></button>\n             <br />\n@@ -443,6 +456,15 @@ class=\"ui-state-highlight ui-corner-all\" id=\"div_maintenance\">\n     $_SESSION['error']['code'] = ERR_SESS_EXPIRED;\n     $_SESSION['initial_url'] = substr($_SERVER[\"REQUEST_URI\"], strpos($_SERVER[\"REQUEST_URI\"], \"index.php?\"));\n     include 'error.php';\n+} elseif ((!isset($_SESSION['validite_pw']) || empty($_SESSION['validite_pw']) || empty($_SESSION['user_id'])) && isset($_GET['otv']) && $_GET['otv'] == \"true\") {\n+    // case where one-shot viewer\n+    if (isset($_GET['session']) && !empty($_GET['session'])) {\n+        include 'otv.php?session='.$_GET['session'];\n+    } else {\n+        $_SESSION['error']['code'] = ERR_VALID_SESSION;\n+        $_SESSION['initial_url'] = substr($_SERVER[\"REQUEST_URI\"], strpos($_SERVER[\"REQUEST_URI\"], \"index.php?\"));\n+        include 'error.php';\n+    }    \n } elseif (empty($_SESSION['user_id']) && isset($_GET['action']) && $_GET['action'] == \"password_recovery\") {\n     // Case where user has asked new PW\n     echo '"
        },
        {
          "filename": "items.load.php",
          "status": "modified",
          "additions": 20,
          "deletions": 6,
          "patch": "@@ -339,9 +339,9 @@ function pwGenerate(elem)\n     $(\"#\"+elem+\"pw_wait\").show();\n \n     $.post(\n-        \"sources/items.queries.php\",\n+        \"sources/main.queries.php\",\n         {\n-            type    : \"pw_generate\",\n+            type    : \"generate_a_password\",\n             size      : $(\"#\"+elem+'pw_size').val(),\n             num      : $(\"#\"+elem+'pw_numerics').prop(\"checked\"),\n             maj      : $(\"#\"+elem+'pw_maj').prop(\"checked\"),\n@@ -351,9 +351,14 @@ function pwGenerate(elem)\n             force      : \"false\"\n         },\n         function(data) {\n-        \tdata = prepareExchangedData(data, \"decode\");\n-            $(\"#\"+elem+\"pw1\").val(data.key).focus();\n-\t\t\t$(\"#visible_pw\").text(data.key);\n+\t\t\tdata = prepareExchangedData(data, \"decode\");\n+           \tif (data.error == \"true\") {\n+           \t\t$(\"#div_dialog_message_text\").html(data.error_msg);\n+           \t\t$(\"#div_dialog_message\").dialog(\"open\");\n+           \t} else {\n+           \t\t$(\"#\"+elem+\"pw1\").val(data.key).focus();\n+\t\t\t\t$(\"#visible_pw\").text(data.key);\n+           \t}\n             $(\"#\"+elem+\"pw_wait\").hide();\n         }\n    );\n@@ -929,7 +934,7 @@ function AfficherDetailsItem(id, salt_key_required, expired_item, restricted, di\n         $(\"#item_details_ok\").hide();\n         $(\"#item_details_expired\").hide();\n         $(\"#item_details_expired_full\").hide();\n-        $(\"#menu_button_edit_item, #menu_button_del_item, #menu_button_copy_item, #menu_button_add_fav, #menu_button_del_fav, #menu_button_show_pw, #menu_button_copy_pw, #menu_button_copy_login, #menu_button_copy_link\").attr(\"disabled\",\"disabled\");\n+        $(\"#menu_button_edit_item, #menu_button_del_item, #menu_button_copy_item, #menu_button_add_fav, #menu_button_del_fav, #menu_button_show_pw, #menu_button_copy_pw, #menu_button_copy_login, menu_button_copy_url, #menu_button_copy_link\").attr(\"disabled\",\"disabled\");\n         $(\"#request_ongoing\").val(\"\");\n         return false;\n     }\n@@ -1157,6 +1162,15 @@ function(data) {\n                             });\n                             clip.glue('menu_button_copy_login');\n                         }\n+                        // #XXX\n+                        if (data.url != \"\") {\n+                            var clip = new ZeroClipboard.Client();\n+                            clip.setText(data.url);\n+                            clip.addEventListener('complete', function(client, text) {\n+                                    $(\"#message_box\").html(\"<?php echo addslashes($txt['url_copied_clipboard']);?>\").show().fadeOut(1000);\n+                            });\n+                            clip.glue('menu_button_copy_url');\n+                        }\n                         //prepare link to clipboard\n                         var clip = new ZeroClipboard.Client();\n                         clip.setText(\"<?php echo $_SESSION['settings']['cpassman_url'];?>/index.php?page=items&group=\"+data.folder+\"&id=\"+data.id);"
        },
        {
          "filename": "items.php",
          "status": "modified",
          "additions": 28,
          "deletions": 6,
          "patch": "@@ -13,12 +13,20 @@\n  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n  */\n \n-if (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1) {\n+if (\n+    !isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 || \n+    !isset($_SESSION['user_id']) || empty($_SESSION['user_id']) || \n+    !isset($_SESSION['key']) || empty($_SESSION['key'])) \n+{\n     die('Hacking attempt...');\n }\n \n-if (!isset($_SESSION['login'])) {\n-    break;\n+/* do checks */\n+require_once $_SESSION['settings']['cpassman_dir'].'/sources/checks.php';\n+if (!checkUser($_SESSION['user_id'], $_SESSION['key'], curPage())) {\n+    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n+    //include 'error.php';\n+    exit();\n }\n \n require_once $_SESSION['settings']['cpassman_dir'].'/sources/SplClassLoader.php';\n@@ -167,7 +175,14 @@\n         foreach ($nodeDescendants as $node) {\n             // manage tree counters\n             if (isset($_SESSION['settings']['tree_counters']) && $_SESSION['settings']['tree_counters'] == 1) {\n-                $data = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"items WHERE inactif=0 AND id_tree = \".$node);\n+                //$data = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"items WHERE inactif=0 AND id_tree = \".$node);\n+                $data = $db->queryCount(\n+                    \"items\",\n+                    array(\n+                        \"inactif\" => 0,\n+                        \"id_tree\" => intval($node)\n+                    )\n+                );\n                 $nbChildrenItems += $data[0];\n             }\n             if (\n@@ -189,7 +204,14 @@\n                 $ident .= \"&nbsp;&nbsp;\";\n             }\n \n-            $data = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"items WHERE inactif=0 AND id_tree = \".$folder->id);\n+            //$data = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"items WHERE inactif=0 AND id_tree = \".$folder->id);\n+            $data = $db->queryCount(\n+                \"items\",\n+                array(\n+                    \"inactif\" => 0,\n+                    \"id_tree\" => intval($folder->id)\n+                )\n+            );\n             $itemsNb = $data[0];\n \n             // get 1st folder\n@@ -1010,6 +1032,6 @@\n echo '\n <div id=\"div_item_updated\" style=\"display:none;\">\n     <div style=\"\">'.$txt['item_updated_text'].'</div>\n-</div>';\n+</div><br />';\n \n require_once 'items.load.php';"
        },
        {
          "filename": "kb.php",
          "status": "modified",
          "additions": 14,
          "deletions": 3,
          "patch": "@@ -12,13 +12,24 @@\n  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n  */\n \n-if (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1\n+if (\n+        !isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 ||\n+        !isset($_SESSION['user_id']) || empty($_SESSION['user_id']) ||\n+        !isset($_SESSION['key']) || empty($_SESSION['key'])\n         || !isset($_SESSION['settings']['enable_kb'])\n-        || $_SESSION['settings']['enable_kb'] != 1\n-) {\n+        || $_SESSION['settings']['enable_kb'] != 1)\n+{\n     die('Hacking attempt...');\n }\n \n+/* do checks */\n+require_once $_SESSION['settings']['cpassman_dir'].'/sources/checks.php';\n+if (!checkUser($_SESSION['user_id'], $_SESSION['key'], curPage())) {\n+    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n+    include 'error.php';\n+    exit();\n+}\n+\n //load language\n require_once $_SESSION['settings']['cpassman_dir'].'/includes/language/'.$_SESSION['user_language'].'_kb.php';\n "
        },
        {
          "filename": "load.php",
          "status": "modified",
          "additions": 7,
          "deletions": 4,
          "patch": "@@ -234,11 +234,13 @@ function(data) {\n     function GenerateNewPassword(key, login)\n     {\n         $(\"#ajax_loader_send_mail\").show();\n+        // prepare data\n+        data = \\'{\"login\":\"\\'+sanitizeString(login)+\\'\" ,\\'+\n+            \\'\"key\":\"\\'+sanitizeString(key)+\\'\"}\\';\n         //send query\n         $.post(\"sources/main.queries.php\", {\n                 type :    \"generate_new_password\",\n-                login:    login,\n-                key :    key\n+    \t\t    data : prepareExchangedData(data, \"encode\")\n             },\n             function(data) {\n                 if (data == \"done\") {\n@@ -284,11 +286,12 @@ function OpenDialogBox(id)\n     function ChangeLanguage(lang)\n     {\n         $(\"#language\").val(lang);\n+        data = \\'{\"lang\":\"\\'+sanitizeString(lang)+\\'\"}\\';    \t\t        \n         $.post(\n             \"sources/main.queries.php\",\n             {\n-                type    : \"change_user_language\",\n-                lang    : lang\n+                type : \"change_user_language\",\n+                data : prepareExchangedData(data, \"encode\")\n             },\n             function(data) {\n             \tif (data == \"done\") {"
        },
        {
          "filename": "patch.php",
          "status": "removed",
          "additions": 0,
          "deletions": 37,
          "patch": "@@ -1,37 +0,0 @@\n-<?php\n-session_start();\n-\n-include './includes/settings.php';\n-include './sources/main.functions.php';\n-\n-require_once './sources/SplClassLoader.php';\n-\n-// connect to the server\n-$db = new SplClassLoader('Database\\Core', './includes/libraries');\n-$db->register();\n-$db = new Database\\Core\\DbCore($server, $user, $pass, $database, $pre);\n-$db->connect();\n-\n-$rows = $db->fetchAllArray(\"SELECT id, pw FROM \".$pre.\"items WHERE perso = '0'\");\n-foreach ($rows as $reccord) {\n-\t$pw = decrypt($reccord['pw']);\n-\tif (!empty($pw) && strlen($pw) > 30 && isutf8($pw)) {\n-\n-\t\t$key = substr($pw, 0, 15);\n-\t\t$pw = substr($pw,30);\n-\n-\t\t$pw = $key . $pw;\n-\n-\t\t$pw = encrypt($pw);\n-\n-\t\t$db->queryUpdate(\n-\t\t\t'items',\n-\t\t\tarray(\n-\t\t\t    'pw' => $pw\n-\t\t\t),\n-\t\t\t\"id='\".$reccord['id'].\"'\"\n-\t\t);\n-\t}\n-}\n-\n-?>\n\\ No newline at end of file"
        },
        {
          "filename": "roles.php",
          "status": "modified",
          "additions": 13,
          "deletions": 1,
          "patch": "@@ -12,10 +12,22 @@\n  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n  */\n \n-if (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1) {\n+if (\n+    !isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 || \n+    !isset($_SESSION['user_id']) || empty($_SESSION['user_id']) || \n+    !isset($_SESSION['key']) || empty($_SESSION['key'])\n+){\n     die('Hacking attempt...');\n }\n \n+/* do checks */\n+require_once $_SESSION['settings']['cpassman_dir'].'/sources/checks.php';\n+if (!checkUser($_SESSION['user_id'], $_SESSION['key'], curPage())) {\n+    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n+    include 'error.php';\n+    exit();\n+}\n+\n //load help\n require_once $_SESSION['settings']['cpassman_dir'].'/includes/language/'.$_SESSION['user_language'].'_admin_help.php';\n "
        },
        {
          "filename": "sources/admin.queries.php",
          "status": "modified",
          "additions": 45,
          "deletions": 5,
          "patch": "@@ -15,10 +15,22 @@\n \n require_once('sessions.php');\n session_start();\n-if (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 || !isset($_SESSION['key']) || empty($_SESSION['key'])) {\n+if (\n+    !isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 || \n+    !isset($_SESSION['user_id']) || empty($_SESSION['user_id']) || \n+    !isset($_SESSION['key']) || empty($_SESSION['key'])) \n+{\n     die('Hacking attempt...');\n }\n \n+/* do checks */\n+require_once $_SESSION['settings']['cpassman_dir'].'/sources/checks.php';\n+if (!checkUser($_SESSION['user_id'], $_SESSION['key'], \"manage_settings\")) {\n+    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n+    include 'error.php';\n+    exit();\n+}\n+\n include $_SESSION['settings']['cpassman_dir'].'/includes/language/'.$_SESSION['user_language'].'.php';\n include $_SESSION['settings']['cpassman_dir'].'/includes/settings.php';\n include $_SESSION['settings']['cpassman_dir'].'/includes/include.php';\n@@ -118,7 +130,14 @@\n             );\n \n             //if folder doesn't exist then create it\n-            $data = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"nested_tree WHERE title = '\".$record['id'].\"' AND parent_id = 0\");\n+            //$data = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"nested_tree WHERE title = '\".$record['id'].\"' AND parent_id = 0\");\n+            $data = $db->queryCount(\n+                \"nested_tree\",\n+                array(\n+                    \"title\" => $record['id'],\n+                    \"parent_id\" => 0\n+                )\n+            );\n             if ($data[0] == 0) {\n                 //If not exist then add it\n                 $db->queryInsert(\n@@ -194,7 +213,14 @@\n             ORDER BY id ASC\"\n         );\n         foreach ($rows as $item) {\n-            $row = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"log_items WHERE id_item=\".$item['id'].\" AND action = 'at_creation'\");\n+            //$row = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"log_items WHERE id_item=\".$item['id'].\" AND action = 'at_creation'\");\n+            $row = $db->queryCount(\n+                \"log_items\",\n+                array(\n+                    \"id_item\" => $item['id'],\n+                    \"action\" => \"at_creation\"\n+                )\n+            );\n             if ($row[0] == 0) {\n                 $db->query(\"DELETE FROM \".$pre.\"items WHERE id = \".$item['id']);\n                 $db->query(\"DELETE FROM \".$pre.\"categories_items WHERE item_id = \".$item['id']);\n@@ -370,7 +396,14 @@\n             ORDER BY id ASC\"\n         );\n         foreach ($rows as $item) {\n-            $row = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"log_items WHERE id_item=\".$item['id'].\" AND action = 'at_creation'\");\n+            //$row = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"log_items WHERE id_item=\".$item['id'].\" AND action = 'at_creation'\");\n+            $row = $db->queryCount(\n+                \"log_items\",\n+                array(\n+                    \"id_item\" => $item['id'],\n+                    \"action\" => \"at_creation\"\n+                )\n+            );\n             if ($row[0] == 0) {\n                 //Create new at_creation entry\n                 $rowTmp = $db->queryFirst(\"SELECT date FROM \".$pre.\"log_items WHERE id_item=\".$item['id'].\" ORDER BY date ASC\");\n@@ -619,7 +652,14 @@\n         $rows = $db->fetchAllArray(\"SELECT id, pw FROM \".$pre.\"items WHERE perso = '0'\");\n         foreach ($rows as $reccord) {\n             // check if key exists for this item\n-            $row = @$db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"keys WHERE `id`='\".$reccord['id'].\"' AND `table` = 'items'\");\n+            //$row = @$db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"keys WHERE `id`='\".$reccord['id'].\"' AND `table` = 'items'\");\n+            $row = $db->queryCount(\n+                \"keys\",\n+                array(\n+                    \"id\" => $reccord['id'],\n+                    \"table\" => \"items\"\n+                )\n+            );\n             if ($row[0] == 0) {\n                 $storePrefix = false;\n                 // decrypt pw"
        },
        {
          "filename": "sources/categories.queries.php",
          "status": "modified",
          "additions": 24,
          "deletions": 2,
          "patch": "@@ -12,11 +12,24 @@\n  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n  */\n \n+require_once('sessions.php');\n session_start();\n-if (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 || !isset($_SESSION['key']) || empty($_SESSION['key'])) {\n+if (\n+    !isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 || \n+    !isset($_SESSION['user_id']) || empty($_SESSION['user_id']) || \n+    !isset($_SESSION['key']) || empty($_SESSION['key'])) \n+{\n     die('Hacking attempt...');\n }\n \n+/* do checks */\n+require_once $_SESSION['settings']['cpassman_dir'].'/sources/checks.php';\n+if (!checkUser($_SESSION['user_id'], $_SESSION['key'], \"manage_settings\")) {\n+    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n+    include 'error.php';\n+    exit();\n+}\n+\n include $_SESSION['settings']['cpassman_dir'].'/includes/language/'.$_SESSION['user_language'].'.php';\n include $_SESSION['settings']['cpassman_dir'].'/includes/settings.php';\n header(\"Content-type: text/html; charset==utf-8\");\n@@ -183,7 +196,16 @@\n                     );\n                     \n                     // prepare a list\n-                    $row = $db->fetchRow(\"SELECT title FROM \".$pre.\"nested_tree WHERE id=\".$folder);\n+                    //$row = $db->fetchRow(\"SELECT title FROM \".$pre.\"nested_tree WHERE id=\".$folder);\n+                    $row = $db->queryGetRow(\n+                        \"nested_tree\",\n+                        array(\n+                            \"title\"\n+                        ),\n+                        array(\n+                            \"id\" => intval($folder)\n+                        )\n+                    );\n                     if (empty($list)) {\n                         $list = $row[0];\n                     } else {"
        },
        {
          "filename": "sources/checks.php",
          "status": "added",
          "additions": 84,
          "deletions": 0,
          "patch": "@@ -0,0 +1,84 @@\n+<?php\n+/**\n+ *\n+ * @file          checks.php\n+ * @author        Nils Laumaill\u00e9\n+ * @version       2.1.20\n+ * @copyright     (c) 2009-2014 Nils Laumaill\u00e9\n+ * @licensing     GNU AFFERO GPL 3.0\n+ * @link\t\t  http://www.teampass.net\n+ *\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n+ */\n+\n+$pagesRights = array(\n+    \"user\" => array(\n+        \"home\", \"items\", \"find\", \"kb\", \"favourites\"\n+    ),\n+    \"manager\" => array(\n+        \"home\", \"items\", \"find\", \"kb\", \"favourites\", \"manage_roles\", \"manage_folders\", \"manage_views\", \"manage_users\"\n+    ),\n+    \"admin\" => array(\n+        \"home\", \"items\", \"find\", \"kb\", \"favourites\", \"manage_roles\", \"manage_folders\", \"manage_views\", \"manage_users\", \"manage_settings\", \"manage_main\"\n+    )\n+);\n+\n+function curPage()\n+{\n+    parse_str(substr($_SERVER[\"REQUEST_URI\"], strpos($_SERVER[\"REQUEST_URI\"], \"?\")+1), $result);\n+    return $result['page'];\n+}\n+\n+function checkUser($userId, $userKey, $pageVisited)\n+{\n+    global $pagesRights;\n+\n+    if (empty($userId) || empty($pageVisited) || empty($userKey)) {\n+        return false;\n+    }\n+\n+    include $_SESSION['settings']['cpassman_dir'].'/includes/settings.php';\n+    require_once $_SESSION['settings']['cpassman_dir'].'/includes/language/'.$_SESSION['user_language'].'.php';\n+    require_once $_SESSION['settings']['cpassman_dir'].'/sources/SplClassLoader.php';\n+\n+    // Connect to mysql server\n+    $db = new SplClassLoader('Database\\Core', $_SESSION['settings']['cpassman_dir'].'/includes/libraries');\n+    $db->register();\n+    $db = new Database\\Core\\DbCore($server, $user, $pass, $database, $pre);\n+    $db->connect();\n+\n+    // load user's data\n+    /*$sql = \"SELECT * FROM \".$pre.\"users WHERE id = '$userId'\";\n+    $row = $db->query($sql);\n+    $data = $db->fetchArray($row);*/\n+    $data = $db->queryGetArray(\n+        \"users\",\n+        array(\n+            \"login\",\n+            \"key_tempo\",\n+            \"admin\",\n+            \"gestionnaire\"\n+        ),\n+        array(\n+            \"id\" => intval($userId)\n+        )\n+    );\n+\n+    // check if user exists and tempo key is coherant\n+    if (empty($data['login']) || empty($data['key_tempo']) || $data['key_tempo'] != $userKey) {\n+        return false;\n+    }\n+\n+    // check if user is allowed to see this page\n+    if (empty($data['admin']) && empty($data['gestionnaire']) && !in_array($pageVisited, $pagesRights['user'])) {\n+        return false;\n+    } else if (empty($data['admin']) && !empty($data['gestionnaire']) && !in_array($pageVisited, $pagesRights['manager'])) {\n+        return false;\n+    } else if (!empty($data['admin']) && !in_array($pageVisited, $pagesRights['admin'])) {\n+        return false;\n+    }\n+\n+    return true;\n+}\n\\ No newline at end of file"
        },
        {
          "filename": "sources/core.php",
          "status": "modified",
          "additions": 35,
          "deletions": 6,
          "patch": "@@ -145,7 +145,16 @@ function redirect($url)\n \n /* CHECK IF SESSION EXISTS AND IF SESSION IS VALID */\n if (!empty($_SESSION['fin_session'])) {\n-    $dataSession = $db->fetchRow(\"SELECT key_tempo FROM \".$pre.\"users WHERE id=\".$_SESSION['user_id']);\n+    //$dataSession = $db->fetchRow(\"SELECT key_tempo FROM \".$pre.\"users WHERE id=\".$_SESSION['user_id']);\n+    $dataSession = $db->queryGetRow(\n+        \"users\",\n+        array(\n+            \"key_tempo\"\n+        ),\n+        array(\n+            \"id\" => intval($_SESSION['user_id'])\n+        )\n+    );\n } else {\n     $dataSession[0] = \"\";\n }\n@@ -191,7 +200,17 @@ function redirect($url)\n     isset($_SESSION['settings']['update_needed']) && ($_SESSION['settings']['update_needed'] != false\n     || empty($_SESSION['settings']['update_needed']))\n ) {\n-    $row = $db->fetchRow(\"SELECT valeur FROM \".$pre.\"misc WHERE type = 'admin' AND intitule = 'cpassman_version'\");\n+    //$row = $db->fetchRow(\"SELECT valeur FROM \".$pre.\"misc WHERE type = 'admin' AND intitule = 'cpassman_version'\");\n+    $row = $db->queryGetRow(\n+        \"misc\",\n+        array(\n+            \"valeur\"\n+        ),\n+        array(\n+            \"type\" => \"admin\",\n+            \"intitule\" => \"cpassman_version\"\n+        )\n+    );\n     if ($row[0] != $k['version']) {\n         $_SESSION['settings']['update_needed'] = true;\n     } else {\n@@ -285,9 +304,19 @@ function redirect($url)\n /* LOAD INFORMATION CONCERNING USER */\n if (isset($_SESSION['user_id']) && !empty($_SESSION['user_id'])) {\n     // query on user\n-    $sql=\"SELECT * FROM \".$pre.\"users WHERE id = '\".$_SESSION['user_id'].\"'\";\n-    $row = $db->query($sql);\n-    $data = $db->fetchArray($row);\n+    $data = $db->queryGetArray(\n+        \"users\",\n+        array(\n+            \"admin\",\n+            \"gestionnaire\",\n+            \"groupes_visibles\",\n+            \"groupes_interdits\",\n+            \"fonction_id\"\n+        ),\n+        array(\n+            \"id\" => intval($_SESSION['user_id'])\n+        )\n+    );\n \n     //Check if user has been deleted or unlogged\n     if (empty($data)) {\n@@ -417,5 +446,5 @@ function redirect($url)\n }\n \n /* CHECK NUMBER OF USER ONLINE */\n-$queryCount = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"users WHERE timestamp >= '\".(time() - 600).\"'\");\n+$queryCount = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"users WHERE timestamp >= '\".intval((time() - 600)).\"'\");\n $_SESSION['nb_users_online'] = $queryCount[0];\n\\ No newline at end of file"
        },
        {
          "filename": "sources/datatable/datatable.item_edition.php",
          "status": "modified",
          "additions": 1,
          "deletions": 2,
          "patch": "@@ -48,7 +48,7 @@\n     $sOrder = \"ORDER BY  \";\n     for ($i=0; $i<intval($_GET['iSortingCols']); $i++) {\n         if ($_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == \"true\") {\n-            $sOrder .= $aColumns[ intval($_GET['iSortCol_'.$i]) ].\"\n+            $sOrder .= $aColumns[ intval(mysql_real_escape_string($_GET['iSortCol_'.$i])) ].\"\n             \".mysql_real_escape_string($_GET['sSortDir_'.$i]) .\", \";\n         }\n     }\n@@ -68,7 +68,6 @@\n if ($_GET['sSearch'] != \"\") {\n     $sWhere = \" WHERE (\";\n     for ($i=0; $i<count($aColumns); $i++) {\n-        $sWhere .= $aColumns[$i].\" LIKE '%\".mysql_real_escape_string($_GET['sSearch']).\"%' OR \";\n     }\n     $sWhere = substr_replace($sWhere, \"\", -3).\") \";\n }"
        },
        {
          "filename": "sources/datatable/datatable.kb.php",
          "status": "modified",
          "additions": 23,
          "deletions": 4,
          "patch": "@@ -39,7 +39,8 @@\n //Paging\n $sLimit = \"\";\n if (isset($_GET['iDisplayStart']) && $_GET['iDisplayLength'] != '-1') {\n-    $sLimit = \"LIMIT \". $_GET['iDisplayStart'] .\", \". $_GET['iDisplayLength'] ;\n+    $sLimit = \"LIMIT \". mysql_real_escape_string($_GET['iDisplayStart']) .\", \"\n+            . mysql_real_escape_string($_GET['iDisplayLength']) ;\n }\n \n //Ordering\n@@ -48,7 +49,7 @@\n     $sOrder = \"ORDER BY  \";\n     for ($i=0; $i<intval($_GET['iSortingCols']); $i++) {\n         if ($_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == \"true\") {\n-            $sOrder .= $aColumns[ intval($_GET['iSortCol_'.$i]) ].\"\n+            $sOrder .= $aColumns[ intval(mysql_real_escape_string($_GET['iSortCol_'.$i])) ].\"\n                     \".mysql_real_escape_string($_GET['sSortDir_'.$i]) .\", \";\n         }\n     }\n@@ -133,7 +134,16 @@\n     $sOutput .= '\",';\n \n     //col2\n-    $ret_cat = $db->fetchRow(\"SELECT category FROM \".$pre.\"kb_categories WHERE id = \".$reccord['category_id']);\n+    //$ret_cat = $db->fetchRow(\"SELECT category FROM \".$pre.\"kb_categories WHERE id = \".$reccord['category_id']);\n+    $ret_cat = $db->queryGetRow(\n+        \"kb_categories\",\n+        array(\n+            \"category\"\n+        ),\n+        array(\n+            \"id\" => intval($reccord['category_id'])\n+        )\n+    );\n     $sOutput .= '\"'.htmlspecialchars(stripslashes($ret_cat[0]), ENT_QUOTES).'\",';\n \n     //col3\n@@ -147,7 +157,16 @@\n     }\n     */\n     //col5\n-    $ret_author = $db->fetchRow(\"SELECT login FROM \".$pre.\"users WHERE id = \".$reccord['author_id']);\n+    //$ret_author = $db->fetchRow(\"SELECT login FROM \".$pre.\"users WHERE id = \".$reccord['author_id']);\n+    $ret_author = $db->queryGetRow(\n+        \"users\",\n+        array(\n+            \"login\"\n+        ),\n+        array(\n+            \"id\" => intval($reccord['author_id'])\n+        )\n+    );\n     $sOutput .= '\"'.html_entity_decode($ret_author[0], ENT_NOQUOTES).'\"';\n \n     //Finish the line"
        },
        {
          "filename": "sources/datatable/datatable.logs.php",
          "status": "modified",
          "additions": 3,
          "deletions": 2,
          "patch": "@@ -41,7 +41,8 @@\n     //Paging\n     $sLimit = \"\";\n     if (isset($_GET['iDisplayStart']) && $_GET['iDisplayLength'] != '-1') {\n-        $sLimit = \"LIMIT \". $_GET['iDisplayStart'] .\", \". $_GET['iDisplayLength'] ;\n+        $sLimit = \"LIMIT \". mysql_real_escape_string($_GET['iDisplayStart']) .\", \"\n+                . mysql_real_escape_string($_GET['iDisplayLength']) ;\n     }\n \n     //Ordering\n@@ -50,7 +51,7 @@\n         $sOrder = \"ORDER BY  \";\n         for ($i=0; $i<intval($_GET['iSortingCols']); $i++) {\n             if ($_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == \"true\") {\n-                $sOrder .= $aColumns[ intval($_GET['iSortCol_'.$i]) ].\"\n+                $sOrder .= $aColumns[ intval(mysql_real_escape_string($_GET['iSortCol_'.$i])) ].\"\n                     \".mysql_real_escape_string($_GET['sSortDir_'.$i]) .\", \";\n             }\n         }"
        },
        {
          "filename": "sources/datatable/datatable.users_logged.php",
          "status": "modified",
          "additions": 3,
          "deletions": 2,
          "patch": "@@ -41,7 +41,8 @@\n //Paging\n $sLimit = \"\";\n if (isset($_GET['iDisplayStart']) && $_GET['iDisplayLength'] != '-1') {\n-    $sLimit = \"LIMIT \". $_GET['iDisplayStart'] .\", \". $_GET['iDisplayLength'] ;\n+    $sLimit = \"LIMIT \". mysql_real_escape_string($_GET['iDisplayStart']) .\", \"\n+            . mysql_real_escape_string($_GET['iDisplayLength']);\n }\n \n //Ordering\n@@ -50,7 +51,7 @@\n     $sOrder = \"ORDER BY  \";\n     for ($i=0; $i<intval($_GET['iSortingCols']); $i++) {\n         if ($_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == \"true\") {\n-            $sOrder .= $aColumns[ intval($_GET['iSortCol_'.$i]) ].\"\n+            $sOrder .= $aColumns[ intval(mysql_real_escape_string($_GET['iSortCol_'.$i])) ].\"\n             \".mysql_real_escape_string($_GET['sSortDir_'.$i]) .\", \";\n         }\n     }"
        },
        {
          "filename": "sources/export.queries.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -472,7 +472,7 @@ function outPutCsv(&$vals, $key, $filehandler)\n \t\t\tfputs($outstream, '\n \t\t<tr class=\"'.$lineType.'\">\n \t\t    <td>'.addslashes($elem['label']).'</td>\n-\t\t\t<td align=\"center\"><span class=\"span_pw\" id=\"span_'.$elem['id'].'\"><a href=\"#\" onclick=\"decryptme('.$elem['id'].', \\''.$encPw.'\\')\">Decrypt </a></span><input type=\"hidden\" id=\"hide_'.$elem['id'].'\" value=\"'.$encPw.'\" /></td>\n+\t\t\t<td align=\"center\"><span class=\"span_pw\" id=\"span_'.$elem['id'].'\"><a href=\"#\" onclick=\"decryptme('.$elem['id'].', \\''.$encPw.'\\');return false;\">Decrypt </a></span><input type=\"hidden\" id=\"hide_'.$elem['id'].'\" value=\"'.$encPw.'\" /></td>\n \t\t    <td>'.$desc.'</td>\n \t\t    <td align=\"center\">'.$login.'</td>\n \t\t    <td align=\"center\">'.$rest.'</td>"
        },
        {
          "filename": "sources/favourites.queries.php",
          "status": "modified",
          "additions": 10,
          "deletions": 1,
          "patch": "@@ -34,7 +34,16 @@\n         #CASE adding a new function\n         case \"del_fav\":\n             //Get actual favourites\n-            $data = $db->fetchRow(\"SELECT favourites FROM \".$pre.\"users WHERE id = '\".$_SESSION['user_id'].\"'\");\n+            //$data = $db->fetchRow(\"SELECT favourites FROM \".$pre.\"users WHERE id = '\".$_SESSION['user_id'].\"'\");\n+            $data = $db->queryGetRow(\n+                \"users\",\n+                array(\n+                    \"favourites\"\n+                ),\n+                array(\n+                    \"id\" => intval($_SESSION['user_id'])\n+                )\n+            );\n             $tmp = explode(\";\", $data[0]);\n             $favs = \"\";\n             $tab_favs = array();"
        },
        {
          "filename": "sources/find.queries.php",
          "status": "modified",
          "additions": 33,
          "deletions": 21,
          "patch": "@@ -38,33 +38,45 @@\n $sWhere = \"id_tree IN(\".implode(', ', $_SESSION['groupes_visibles']).\")\";    //limit search to the visible folders\n \n //Get current user \"personal folder\" ID\n-$row = $db->fetchRow(\"SELECT id FROM \".$pre.\"nested_tree WHERE title = \".$_SESSION['user_id']);\n+// $row = $db->fetchRow(\"SELECT id FROM \".$pre.\"nested_tree WHERE title = '\".intval($_SESSION['user_id']).\"'\");\n+$row = $db->queryGetRow(\n+    \"nested_tree\",\n+    array(\n+        \"id\"\n+    ),\n+    array(\n+        \"title\" => intval($_SESSION['user_id'])\n+    )\n+);\n \n //get list of personal folders\n $arrayPf = array();\n $listPf = \"\";\n-$rows = $db->fetchAllArray(\n-    \"SELECT id FROM \".$pre.\"nested_tree WHERE personal_folder=1 AND NOT parent_id = \".$row[0].\n-    \" AND NOT title = \".$_SESSION['user_id']\n-);\n-foreach ($rows as $reccord) {\n-    if (!in_array($reccord['id'], $arrayPf)) {\n-        //build an array of personal folders ids\n-        array_push($arrayPf, $reccord['id']);\n-        //build also a string with those ids\n-        if (empty($listPf)) {\n-            $listPf = $reccord['id'];\n-        } else {\n-            $listPf .= ', '.$reccord['id'];\n-        }\n-    }\n+if (empty($row[0])) {\n+\t$rows = $db->fetchAllArray(\n+\t    \"SELECT id FROM \".$pre.\"nested_tree WHERE personal_folder=1 AND NOT parent_id = '\".intval($row[0]).\n+\t    \"' AND NOT title = '\".intval($_SESSION['user_id']).\"'\"\n+\t);\n+\tforeach ($rows as $reccord) {\n+\t\tif (!in_array($reccord['id'], $arrayPf)) {\n+\t\t\t//build an array of personal folders ids\n+\t\t\tarray_push($arrayPf, $reccord['id']);\n+\t\t\t//build also a string with those ids\n+\t\t\tif (empty($listPf)) {\n+\t\t\t\t$listPf = $reccord['id'];\n+\t\t\t} else {\n+\t\t\t\t$listPf .= ', '.$reccord['id'];\n+\t\t\t}\n+\t\t}\n+\t}\n }\n \n+\n /* BUILD QUERY */\n //Paging\n $sLimit = \"\";\n if (isset($_GET['iDisplayStart']) && $_GET['iDisplayLength'] != '-1') {\n-    $sLimit = \"LIMIT \". intval($_GET['iDisplayStart']) .\", \". intval($_GET['iDisplayLength']);\n+    $sLimit = \"LIMIT \". intval($_GET['iDisplayStart']) .\", \". intval($_GET['iDisplayLength']).\"\";\n }\n \n //Ordering\n@@ -75,8 +87,8 @@\n             $_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == \"true\" &&\n             preg_match(\"#^(asc|desc)\\$#i\", $_GET['sSortDir_'.$i])\n         ) {\n-            $sOrder .= $aColumns[ intval($_GET['iSortCol_'.$i]) ].\"\n-            \".$_GET['sSortDir_'.$i] .\", \";\n+            $sOrder .= \"\".$aColumns[ intval($_GET['iSortCol_'.$i]) ].\" \"\n+            .mysql_real_escape_string($_GET['sSortDir_'.$i]) .\", \";\n         }\n     }\n \n@@ -85,7 +97,7 @@\n             $sOrder = \"\";\n     }\n }\n-\n+//echo $sOrder;\n /*\n  * Filtering\n  * NOTE this does not match the built-in DataTables filtering which does it\n@@ -164,7 +176,7 @@\n     //get restriction from ROles\n     $restrictedToRole = false;\n     $rTmp = mysql_query(\n-        \"SELECT role_id FROM \".$pre.\"restriction_to_roles WHERE item_id = \".$reccord['id']\n+        \"SELECT role_id FROM \".$pre.\"restriction_to_roles WHERE item_id = '\".$reccord['id'].\"'\"\n     ) or die(mysql_error());\n     while ($aTmp = mysql_fetch_row($rTmp)) {\n         if ($aTmp[0] != \"\") {"
        },
        {
          "filename": "sources/folders.queries.php",
          "status": "modified",
          "additions": 71,
          "deletions": 8,
          "patch": "@@ -14,10 +14,22 @@\n \n require_once('sessions.php');\n session_start();\n-if (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 || !isset($_SESSION['key']) || empty($_SESSION['key'])) {\n+if (\n+    !isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 || \n+    !isset($_SESSION['user_id']) || empty($_SESSION['user_id']) || \n+    !isset($_SESSION['key']) || empty($_SESSION['key'])) \n+{\n     die('Hacking attempt...');\n }\n \n+/* do checks */\n+require_once $_SESSION['settings']['cpassman_dir'].'/sources/checks.php';\n+if (!checkUser($_SESSION['user_id'], $_SESSION['key'], \"manage_folders\")) {\n+    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n+    include 'error.php';\n+    exit();\n+}\n+\n include $_SESSION['settings']['cpassman_dir'].'/includes/language/'.$_SESSION['user_language'].'.php';\n include $_SESSION['settings']['cpassman_dir'].'/includes/settings.php';\n header(\"Content-type: text/html; charset==utf-8\");\n@@ -86,7 +98,16 @@\n         \"id=\".$id[1]\n     );\n     //Get the title to display it\n-    $data = $db->fetchRow(\"SELECT title FROM \".$pre.\"nested_tree WHERE id = \".$_POST['newparent_id']);\n+    // $data = $db->fetchRow(\"SELECT title FROM \".$pre.\"nested_tree WHERE id = \".$_POST['newparent_id']);\n+    $row = $db->queryGetRow(\n+        \"nested_tree\",\n+        array(\n+            \"title\"\n+        ),\n+        array(\n+            \"id\" => $_POST['newparent_id']\n+        )\n+    );\n     //show value\n     echo ($data[0]);\n     //rebuild the tree grid\n@@ -98,7 +119,14 @@\n     $id = explode('_', $_POST['id']);\n \n     //Check if group exists\n-    $tmp = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"misc WHERE type = 'complex' AND intitule = '\".$id[1].\"'\");\n+    //$tmp = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"misc WHERE type = 'complex' AND intitule = '\".$id[1].\"'\");\n+    $tmp = $db->queryCount(\n+        \"misc\",\n+        array(\n+            \"intitule\" => $id[1],\n+            \"type\" => \"complex\"\n+        )\n+    );\n     if ($tmp[0] == 0) {\n         //Insert into DB\n         $db->queryInsert(\n@@ -210,8 +238,14 @@\n             //Check if duplicate folders name are allowed\n             $createNewFolder = true;\n             if (isset($_SESSION['settings']['duplicate_folder']) && $_SESSION['settings']['duplicate_folder'] == 0) {\n-                $data = $db->fetchRow(\n-                    \"SELECT COUNT(*) FROM \".$pre.\"nested_tree WHERE title = '\".addslashes($title).\"'\"\n+                //$data = $db->fetchRow(\n+                //    \"SELECT COUNT(*) FROM \".$pre.\"nested_tree WHERE title = '\".addslashes($title).\"'\"\n+                //);\n+                $data = $db->queryCount(\n+                    \"nested_tree\",\n+                    array(\n+                        \"title\" => addslashes($title)\n+                    )\n                 );\n                 if ($data[0] != 0) {\n                     $error = 'error_group_exist';\n@@ -221,7 +255,16 @@\n \n             if ($createNewFolder == true) {\n                 //check if parent folder is personal\n-                $data = $db->fetchRow(\"SELECT personal_folder FROM \".$pre.\"nested_tree WHERE id = '\".$parentId.\"'\");\n+                // $data = $db->fetchRow(\"SELECT personal_folder FROM \".$pre.\"nested_tree WHERE id = '\".$parentId.\"'\");\n+                $row = $db->queryGetRow(\n+                    \"nested_tree\",\n+                    array(\n+                        \"personal_folder\"\n+                    ),\n+                    array(\n+                        \"id\" => intval($parentId)\n+                    )\n+                );\n                 if ($data[0] == 1) {\n                     $isPersonal = 1;\n                 } else {\n@@ -319,8 +362,18 @@\n             //Check if duplicate folders name are allowed\n             $createNewFolder = true;\n             if (isset($_SESSION['settings']['duplicate_folder']) && $_SESSION['settings']['duplicate_folder'] == 0) {\n-                $data = $db->fetchRow(\n+                /*$data = $db->fetchRow(\n                     \"SELECT id, title FROM \".$pre.\"nested_tree WHERE title = '\".addslashes($title).\"'\"\n+                );*/\n+                $data = $db->queryGetRow(\n+                    \"nested_tree\",\n+                    array(\n+                        \"id\",\n+                        \"title\"\n+                    ),\n+                    array(\n+                        \"title\" => addslashes($title)\n+                    )\n                 );\n                 if (!empty($data[0]) && $dataReceived['id'] != $data[0] && $title != $data[1] ) {\n                     echo '[ { \"error\" : \"error_group_exist\" } ]';\n@@ -367,7 +420,17 @@\n             $val = explode(';', $_POST['valeur']);\n             $valeur = $_POST['valeur'];\n             //Check if ID already exists\n-            $data = $db->fetchRow(\"SELECT authorized FROM \".$pre.\"rights WHERE tree_id = '\".$val[0].\"' AND fonction_id= '\".$val[1].\"'\");\n+            // $data = $db->fetchRow(\"SELECT authorized FROM \".$pre.\"rights WHERE tree_id = '\".$val[0].\"' AND fonction_id= '\".$val[1].\"'\");\n+            $data = $db->queryGetRow(\n+                \"rights\",\n+                array(\n+                    \"authorized\"\n+                ),\n+                array(\n+                    \"tree_id\" => intval($val[0]),\n+                    \"fonction_id\" => intval($val[1])\n+                )\n+            );\n             if (empty($data[0])) {\n                 //Insert into DB\n                 $db->queryInsert("
        },
        {
          "filename": "sources/import.queries.php",
          "status": "modified",
          "additions": 49,
          "deletions": 6,
          "patch": "@@ -173,7 +173,16 @@\n         } else {\n             $personalFolder = 0;\n         }\n-        $data_fld = $db->fetchRow(\"SELECT title FROM \".$pre.\"nested_tree WHERE id = '\".$_POST['folder'].\"'\");\n+        // $data_fld = $db->fetchRow(\"SELECT title FROM \".$pre.\"nested_tree WHERE id = '\".$_POST['folder'].\"'\");\n+        $data_fld = $db->queryGetRow(\n+            \"nested_tree\",\n+            array(\n+                \"title\"\n+            ),\n+            array(\n+                \"id\" => intval($_POST['folder'])\n+            )\n+        );\n \n         //Prepare variables\n         $listItems = htmlspecialchars_decode($dataReceived);\n@@ -613,7 +622,15 @@ function recursiveKeepassXML($xmlRoot, $xmlLevel = 0)\n                     }\n \n                     //create folder - if not exists at the same level\n-                    $data = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"nested_tree WHERE nlevel = \".($folderLevel+$startPathLevel).\" AND title = \\\"\".$fold.\"\\\" AND parent_id = \".$parent_id);\n+                    //$data = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"nested_tree WHERE nlevel = \".($folderLevel+$startPathLevel).\" AND title = \\\"\".$fold.\"\\\" AND parent_id = \".$parent_id);\n+                    $data = $db->queryCount(\n+                        \"nested_tree\",\n+                        array(\n+                            \"nlevel\" => intval($folderLevel+$startPathLevel),\n+                            \"title\" => $fold,\n+                            \"parent_id\" => intval(parent_id)\n+                        )\n+                    );\n                     if ($data[0] == 0) {\n                         //do query\n                         $id = $db->queryInsert(\n@@ -654,7 +671,18 @@ function recursiveKeepassXML($xmlRoot, $xmlLevel = 0)\n                         $nbFoldersImported++;\n                     } else {\n                         //get forlder actual ID\n-                        $data = $db->fetchRow(\"SELECT id FROM \".$pre.\"nested_tree WHERE nlevel = '\".($folderLevel+$startPathLevel).\"' AND title = '\".$fold.\"' AND parent_id = '\".$parent_id.\"'\");\n+                        // $data = $db->fetchRow(\"SELECT id FROM \".$pre.\"nested_tree WHERE nlevel = '\".($folderLevel+$startPathLevel).\"' AND title = '\".$fold.\"' AND parent_id = '\".$parent_id.\"'\");\n+                        $row = $db->queryGetRow(\n+                            \"nested_tree\",\n+                            array(\n+                                \"id\"\n+                            ),\n+                            array(\n+                                \"nlevel\" => intval($folderLevel+$startPathLevel),\n+                                \"title\" => $fold,\n+                                \"parent_id\" => intval($parent_id)\n+                            )\n+                        );\n                         $id = $data[0];\n                     }\n \n@@ -705,8 +733,14 @@ function recursiveKeepassXML($xmlRoot, $xmlLevel = 0)\n \n                 if (!empty($item[2])) {\n                     //check if not exists\n-                    $data = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"items WHERE id_tree = '\".$foldersArray[$item[1]]['id'].\"' AND label = \\\"\".$item[2].\"\\\"\");\n-\n+                    //$data = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"items WHERE id_tree = '\".$foldersArray[$item[1]]['id'].\"' AND label = \\\"\".$item[2].\"\\\"\");\n+                    $data = $db->queryCount(\n+                        \"items\",\n+                        array(\n+                            \"id_tree\" => intval($foldersArray[$item[1]]['id']),\n+                            \"label\" => $item[2]\n+                        )\n+                    );\n                     if ($data[0] == 0) {\n                         //Encryption key\n                         $randomKey = generateKey();\n@@ -767,7 +801,16 @@ function recursiveKeepassXML($xmlRoot, $xmlLevel = 0)\n                         } else {\n                             $folderId = $foldersArray[$item[1]]['id'];\n                         }\n-                        $data = $db->fetchRow(\"SELECT title FROM \".$pre.\"nested_tree WHERE id = '\".$folderId.\"'\");\n+                        // $data = $db->fetchRow(\"SELECT title FROM \".$pre.\"nested_tree WHERE id = '\".$folderId.\"'\");\n+                        $data = $db->queryGetRow(\n+                            \"nested_tree\",\n+                            array(\n+                                \"title\"\n+                            ),\n+                            array(\n+                                \"id\" => intval($folderId)\n+                            )\n+                        );\n \n                         //Add entry to cache table\n                         $db->queryInsert("
        },
        {
          "filename": "sources/items.queries.php",
          "status": "modified",
          "additions": 142,
          "deletions": 45,
          "patch": "@@ -18,6 +18,14 @@\n     die('Hacking attempt...');\n }\n \n+/* do checks */\n+require_once $_SESSION['settings']['cpassman_dir'].'/sources/checks.php';\n+if (!checkUser($_SESSION['user_id'], $_SESSION['key'], \"home\")) {\n+    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n+    //include 'error.php';\n+    exit();\n+}\n+\n /**\n  * Define Timezone\n  */\n@@ -102,7 +110,14 @@\n                 // ;check if element doesn't already exist\n                 $itemExists = 0;\n                 $newID = \"\";\n-                $data = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"items WHERE label = '\".addslashes($label).\"' AND inactif=0\");\n+                //$data = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"items WHERE label = '\".addslashes($label).\"' AND inactif=0\");\n+                $data = $db->queryCount(\n+                    \"items\",\n+                    array(\n+                        \"label\" => addslashes($label),\n+                        \"inactif\" => \"0\"\n+                    )\n+                );\n                 if ($data[0] != 0) {\n                     $itemExists = 1;\n                 } else {\n@@ -491,8 +506,8 @@\n                                     \"SELECT c.title AS title, i.data AS data\n                                     FROM \".$pre.\"categories_items AS i\n                                     INNER JOIN \".$pre.\"categories AS c ON (i.field_id=c.id)\n-                                    WHERE i.field_id = '\".$field_data[0].\"'\n-                                    AND i.item_id=\".$dataReceived['id']\n+                                    WHERE i.field_id = '\".intval($field_data[0]).\"'\n+                                    AND i.item_id=\".intval($dataReceived['id'])\n                                 );\n                                 // store Field text in DB\n                                 if (count($dataTmp[0]) == 0) {\n@@ -567,7 +582,13 @@\n                     // Update automatic deletion - Only by the creator of the Item\n                     if (isset($_SESSION['settings']['enable_delete_after_consultation']) && $_SESSION['settings']['enable_delete_after_consultation'] == 1) {\n                         // check if elem exists in Table. If not add it or update it.\n-                        $dataTmp = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"automatic_del WHERE item_id = '\".$dataReceived['id'].\"'\");\n+                        //$dataTmp = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"automatic_del WHERE item_id = '\".$dataReceived['id'].\"'\");\n+                        $dataTmp = $db->queryCount(\n+                            \"automatic_del\",\n+                            array(\n+                                \"item_id\" => $dataReceived['id']\n+                            )\n+                        );\n                         if ($dataTmp[0] == 0) {\n                             // No automatic deletion for this item\n                             if (!empty($dataReceived['to_be_deleted']) || ($dataReceived['to_be_deleted'] > 0 && is_numeric($dataReceived['to_be_deleted']))) {\n@@ -1024,8 +1045,22 @@\n             // return ID\n             $arrData['id'] = $_POST['id'];\n             // Check if item is deleted\n-            $dataDeleted = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"log_items WHERE id_item = '\".$_POST['id'].\"' AND action = 'at_delete'\");\n-            $dataRestored = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"log_items WHERE id_item = '\".$_POST['id'].\"' AND action = 'at_restored'\");\n+            //$dataDeleted = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"log_items WHERE id_item = '\".$_POST['id'].\"' AND action = 'at_delete'\");\n+            //$dataRestored = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"log_items WHERE id_item = '\".$_POST['id'].\"' AND action = 'at_restored'\");\n+            $dataDeleted = $db->queryCount(\n+                \"log_items\",\n+                array(\n+                    \"id_item\" => $_POST['id'],\n+                     \"action\" => \"at_delete\"\n+                )\n+            );\n+            $dataRestored = $db->queryCount(\n+                \"log_items\",\n+                array(\n+                    \"id_item\" => $_POST['id'],\n+                     \"action\" => \"at_restored\"\n+                )\n+            );\n             if ($dataDeleted[0] != 0 && $dataDeleted[0] > $dataRestored[0]) {\n                 // This item is deleted => exit\n                 echo prepareExchangedData(array('show_detail_option' => 2), \"encode\");\n@@ -1384,7 +1419,7 @@\n         case \"showDetailsStep2\":\n         \t// get Item info\n         \t$dataItem = $db->queryFirst(\n-        \t\"SELECT *\n+        \t    \"SELECT *\n                 FROM \".$pre.\"items\n                 WHERE id=\".$_POST['id']\n         \t);\n@@ -1528,34 +1563,6 @@\n         \t);\n         \tbreak;\n \n-            /*\n-        * CASE\n-        * Generate a password\n-        */\n-        case \"pw_generate\":\n-            $pwgen = new SplClassLoader('Encryption\\PwGen', '../includes/libraries');\n-            $pwgen->register();\n-            $pwgen = new Encryption\\PwGen\\pwgen();\n-            // Set pw size\n-            $pwgen->setLength($_POST['size']);\n-            // Include at least one number in the password\n-            $pwgen->setNumerals(($_POST['num'] == \"true\")? true : false);\n-            // Include at least one capital letter in the password\n-            $pwgen->setCapitalize(($_POST['maj'] == \"true\")? true : false);\n-            // Include at least one symbol in the password\n-            $pwgen->setSymbols(($_POST['symb'] == \"true\")? true : false);\n-            // Complete random, hard to memorize password\n-            if (isset($_POST['secure']) && $_POST['secure'] == \"true\") {\n-                $pwgen->setSecure(true);\n-                $pwgen->setSymbols(true);\n-                $pwgen->setCapitalize(true);\n-                $pwgen->setNumerals(true);\n-            } else {\n-                $pwgen->setSecure(false);\n-            }\n-            echo prepareExchangedData(array(\"key\" => $pwgen->generate()), \"encode\");\n-            break;\n-\n         /*\n          * CASE\n          * Delete an item\n@@ -1610,15 +1617,36 @@\n             // Check if duplicate folders name are allowed\n             $createNewFolder = true;\n             if (isset($_SESSION['settings']['duplicate_folder']) && $_SESSION['settings']['duplicate_folder'] == 0) {\n-                $data = $db->fetchRow(\"SELECT id, title FROM \".$pre.\"nested_tree WHERE title = '\".addslashes($title).\"'\");\n+                // $data = $db->fetchRow(\"SELECT id, title FROM \".$pre.\"nested_tree WHERE title = '\".addslashes($title).\"'\");\n+                $data = $db->queryGetRow(\n+                    \"nested_tree\",\n+                    array(\n+                        \"title\",\n+                        \"id\"\n+                    ),\n+                    array(\n+                        \"title\" => addslashes($title)\n+                    )\n+                );\n                 if (!empty($data[0]) && $dataReceived['folder'] != $data[0]) {\n                     echo '[ { \"error\" : \"'.addslashes($txt['error_group_exist']).'\" } ]';\n                     break;\n                 }\n             }\n             // update Folders table\n-            $tmp = $db->fetchRow(\n+            /*$tmp = $db->fetchRow(\n                 \"SELECT title, parent_id, personal_folder FROM \".$pre.\"nested_tree WHERE id = \".$dataReceived['folder']\n+            );*/\n+            $tmp = $db->queryGetRow(\n+                \"nested_tree\",\n+                array(\n+                    \"title\",\n+                    \"parent_id\",\n+                    \"personal_folder\"\n+                ),\n+                array(\n+                    \"id\" => intval($dataReceived['folder'])\n+                )\n             );\n             if ( $tmp[1] != 0 || $tmp[0] != $_SESSION['user_id'] || $tmp[2] != 1 ) {\n                 $db->queryUpdate(\n@@ -1724,8 +1752,14 @@\n             \techo prepareExchangedData(array(\"error\" => \"not_authorized\"), \"encode\");\n                 break;\n             } else {\n-                $data_count = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"items WHERE inactif = 0\");\n-                $whereArg = \" AND i.id_tree=\".$_POST['id'];\n+                //$data_count = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"items WHERE inactif = 0\");\n+                $data_count = $db->queryCount(\n+                    \"items\",\n+                    array(\n+                        \"inactif\" => \"0\"\n+                    )\n+                );\n+                $whereArg = \" AND i.id_tree=\".intval($_POST['id']);\n             }\n \n             if ($data_count[0] > 0 && empty($showError)) {\n@@ -2106,7 +2140,17 @@\n         case \"recup_complex\":\n             if (isset($_POST['item_id']) && !empty($_POST['item_id'])) {\n                 // Lock Item (if already locked), go back and warn\n-                $dataTmp = $db->fetchRow(\"SELECT timestamp, user_id FROM \".$pre.\"items_edition WHERE item_id = '\".$_POST['item_id'].\"'\");//echo \">\".$dataTmp[0];\n+                // $dataTmp = $db->fetchRow(\"SELECT timestamp, user_id FROM \".$pre.\"items_edition WHERE item_id = '\".$_POST['item_id'].\"'\");//echo \">\".$dataTmp[0];\n+                $dataTmp = $db->queryGetRow(\n+                    \"items_edition\",\n+                    array(\n+                        \"timestamp\",\n+                        \"user_id\"\n+                    ),\n+                    array(\n+                        \"item_id\" => intval($_POST['item_id'])\n+                    )\n+                );\n \n                 // If token is taken for this Item and delay is passed then delete it.\n                 if (isset($_SESSION['settings']['delay_item_edition']) &&\n@@ -2115,7 +2159,17 @@\n                 ) {\n                     $db->query(\"DELETE FROM \".$pre.\"items_edition WHERE item_id = '\".$_POST['item_id'].\"'\");\n                     //reload the previous data\n-                    $dataTmp = $db->fetchRow(\"SELECT timestamp, user_id FROM \".$pre.\"items_edition WHERE item_id = '\".$_POST['item_id'].\"'\");\n+                    // $dataTmp = $db->fetchRow(\"SELECT timestamp, user_id FROM \".$pre.\"items_edition WHERE item_id = '\".$_POST['item_id'].\"'\");\n+                    $dataTmp = $db->queryGetRow(\n+                        \"items_edition\",\n+                        array(\n+                            \"timestamp\",\n+                            \"user_id\"\n+                        ),\n+                        array(\n+                            \"item_id\" => intval($_POST['item_id'])\n+                        )\n+                    );\n                 }\n \n                 // If edition by same user (and token not freed before for any reason, then update timestamp)\n@@ -2143,7 +2197,17 @@\n             }\n \n             // Get required Complexity for this Folder\n-            $data = $db->fetchRow(\"SELECT valeur FROM \".$pre.\"misc WHERE type='complex' AND intitule = '\".$_POST['groupe'].\"'\");\n+            // $data = $db->fetchRow(\"SELECT valeur FROM \".$pre.\"misc WHERE type='complex' AND intitule = '\".$_POST['groupe'].\"'\");\n+            $data = $db->queryGetRow(\n+                \"misc\",\n+                array(\n+                    \"valeur\"\n+                ),\n+                array(\n+                    \"intitule\" => $_POST['groupe'],\n+                    \"type\" => \"complex\"\n+                )\n+            );\n \n             if (isset($data[0]) && (!empty($data[0]) || $data[0] == 0)) {\n                 $complexity = $pwComplexity[$data[0]][1];\n@@ -2211,7 +2275,18 @@\n         */\n         case \"delete_attached_file\":\n             // Get some info before deleting\n-            $data = $db->fetchRow(\"SELECT name,id_item,file FROM \".$pre.\"files WHERE id = '\".$_POST['file_id'].\"'\");\n+            // $data = $db->fetchRow(\"SELECT name,id_item,file FROM \".$pre.\"files WHERE id = '\".$_POST['file_id'].\"'\");\n+            $data = $db->queryGetRow(\n+                \"files\",\n+                array(\n+                    \"name\",\n+                    \"id_item\",\n+                    \"file\"\n+                ),\n+                array(\n+                    \"id\" => intval($_POST['file_id'])\n+                )\n+            );\n             if (!empty($data[1])) {\n                 // Delete from FILES table\n                 $db->query(\"DELETE FROM \".$pre.\"files WHERE id = '\".$_POST['file_id'].\"'\");\n@@ -2582,7 +2657,18 @@\n         * Check if Item has been changed since loaded\n         */\n         case \"is_item_changed\":\n-            $data = $db->fetchRow(\"SELECT date FROM \".$pre.\"log_items WHERE action = 'at_modification' AND id_item = '\".$_POST['item_id'].\"' ORDER BY date DESC\");\n+            // $data = $db->fetchRow(\"SELECT date FROM \".$pre.\"log_items WHERE action = 'at_modification' AND id_item = '\".$_POST['item_id'].\"' ORDER BY date DESC\");\n+            $data = $db->queryGetRow(\n+                \"log_items\",\n+                array(\n+                    \"date\"\n+                ),\n+                array(\n+                    \"action\" => \"at_modification\",\n+                    \"id_item\" => intval($_POST['item_id'])\n+                ),\n+                \" ORDER BY date DESC\"\n+            );\n             // Check if it's in a personal folder. If yes, then force complexity overhead.\n             if ($data[0] > $_POST['timestamp']) {\n                 echo '{ \"modified\" : \"1\" }';\n@@ -2623,7 +2709,18 @@\n function recupDroitCreationSansComplexite($groupe)\n {\n     global $db, $pre;\n-    $data = $db->fetchRow(\"SELECT bloquer_creation,bloquer_modification,personal_folder FROM \".$pre.\"nested_tree WHERE id = '\".$groupe.\"'\");\n+    // $data = $db->fetchRow(\"SELECT bloquer_creation,bloquer_modification,personal_folder FROM \".$pre.\"nested_tree WHERE id = '\".$groupe.\"'\");\n+    $data = $db->queryGetRow(\n+        \"nested_tree\",\n+        array(\n+            \"bloquer_creation\",\n+            \"bloquer_modification\",\n+            \"personal_folder\"\n+        ),\n+        array(\n+            \"id\" => intval($groupe)\n+        )\n+    );\n     // Check if it's in a personal folder. If yes, then force complexity overhead.\n     if ($data[2] == 1) {\n         return array(\"bloquer_modification_complexite\" => 1, \"bloquer_creation_complexite\" => 1);"
        },
        {
          "filename": "sources/kb.queries.php",
          "status": "modified",
          "additions": 53,
          "deletions": 14,
          "patch": "@@ -15,12 +15,23 @@\n require_once('sessions.php');\n session_start();\n if (\n-        !isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 || !isset($_SESSION['key']) || empty($_SESSION['key'])\n-        || !isset($_SESSION['settings']['enable_kb']) || $_SESSION['settings']['enable_kb'] != 1\n-) {\n+        !isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 ||\n+        !isset($_SESSION['user_id']) || empty($_SESSION['user_id']) ||\n+        !isset($_SESSION['key']) || empty($_SESSION['key'])\n+        || !isset($_SESSION['settings']['enable_kb'])\n+        || $_SESSION['settings']['enable_kb'] != 1)\n+{\n     die('Hacking attempt...');\n }\n \n+/* do checks */\n+require_once $_SESSION['settings']['cpassman_dir'].'/sources/checks.php';\n+if (!checkUser($_SESSION['user_id'], $_SESSION['key'], \"kb\")) {\n+    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n+    include 'error.php';\n+    exit();\n+}\n+\n require_once $_SESSION['settings']['cpassman_dir'].'/includes/language/'.$_SESSION['user_language'].'.php';\n include $_SESSION['settings']['cpassman_dir'].'/includes/settings.php';\n require_once $_SESSION['settings']['cpassman_dir'].'/includes/include.php';\n@@ -69,8 +80,16 @@ function utf8Urldecode($value)\n \n             //check if allowed to modify\n             if (isset($id) && !empty($id)) {\n-                $row = $db->query(\"SELECT anyone_can_modify, author_id FROM \".$pre.\"kb WHERE id = \".$id);\n-                $ret = $db->fetchArray($row);\n+                $ret = $db->queryGetArray(\n+                    \"kb\",\n+                    array(\n+                        \"anyone_can_modify\",\n+                        \"author_id\"\n+                    ),\n+                    array(\n+                        \"id\" => intval($id)\n+                    )\n+                );\n                 if ($ret['anyone_can_modify'] == 1 || $ret['author_id'] == $_SESSION['user_id']) {\n                     $manage_kb = true;\n                 } else {\n@@ -81,7 +100,13 @@ function utf8Urldecode($value)\n             }\n             if ($manage_kb == true) {\n                 //Add category if new\n-                $data = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"kb_categories WHERE category = '\".mysql_real_escape_string($category).\"'\");\n+                //$data = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"kb_categories WHERE category = '\".mysql_real_escape_string($category).\"'\");\n+                $data = $db->queryCount(\n+                    \"kb_categories\",\n+                    array(\n+                        \"category\" => $category\n+                    )\n+                );\n                 if ($data[0] == 0) {\n                     $cat_id = $db->queryInsert(\n                         \"kb_categories\",\n@@ -155,15 +180,29 @@ function utf8Urldecode($value)\n                 echo '[ { \"error\" : \"key_not_conform\" } ]';\n                 break;\n             }\n-            $row = $db->query(\n-                \"SELECT k.id as id, k.label as label, k.description as description, k.category_id as category_id, k.author_id as author_id, k.anyone_can_modify as anyone_can_modify,\n-                u.login as login, c.category as category\n-                FROM \".$pre.\"kb as k\n-                INNER JOIN \".$pre.\"kb_categories as c ON (c.id = k.category_id)\n-                INNER JOIN \".$pre.\"users as u ON (u.id = k.author_id)\n-                WHERE k.id = '\".$_POST['id'].\"'\"\n+            $ret = $db->queryGetArray(\n+                array(\n+                    \"kb\" => \"k\"\n+                ),\n+                array(\n+                    \"k.id\" => \"id\",\n+                    \"k.label\" => \"label\",\n+                    \"k.description\" => \"description\",\n+                    \"k.category_id\" => \"category_id\",\n+                    \"k.author_id\" => \"author_id\",\n+                    \"k.anyone_can_modify\" => \"anyone_can_modify\",\n+                    \"u.login\" => \"login\",\n+                    \"c.category\" => \"category\"\n+                ),\n+                array(\n+                    \"k.id\" => intval($_POST['id'])\n+                ),\n+                \"\",\n+                array(\n+                    \"kb_categories AS c\" => \"(c.id = k.category_id)\",\n+                    \"users AS u\" => \"(u.id = k.author_id)\"\n+                )\n             );\n-            $ret = $db->fetchArray($row);\n \n             //select associated items\n             $rows = $db->fetchAllArray("
        },
        {
          "filename": "sources/logs.queries.php",
          "status": "modified",
          "additions": 13,
          "deletions": 1,
          "patch": "@@ -14,10 +14,22 @@\n \n require_once('sessions.php');\n session_start();\n-if (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 || !isset($_SESSION['key']) || empty($_SESSION['key'])) {\n+if (\n+    !isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 || \n+    !isset($_SESSION['user_id']) || empty($_SESSION['user_id']) || \n+    !isset($_SESSION['key']) || empty($_SESSION['key'])) \n+{\n     die('Hacking attempt...');\n }\n \n+/* do checks */\n+require_once $_SESSION['settings']['cpassman_dir'].'/sources/checks.php';\n+if (!checkUser($_SESSION['user_id'], $_SESSION['key'], \"manage_views\")) {\n+    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n+    include 'error.php';\n+    exit();\n+}\n+\n global $k, $settings;\n include $_SESSION['settings']['cpassman_dir'].'/includes/settings.php';\n header(\"Content-type: text/html; charset==utf-8\");"
        },
        {
          "filename": "sources/main.functions.php",
          "status": "modified",
          "additions": 63,
          "deletions": 8,
          "patch": "@@ -12,6 +12,7 @@\n if (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1) {\n     die('Hacking attempt...');\n }\n+\n //define pbkdf2 iteration count\n @define('ITCOUNT', '2072');\n \n@@ -299,7 +300,16 @@ function identifyUserRights($groupesVisiblesUser, $groupesInterditsUser, $isAdmi\n             $sql .= \" AND title != '\".$_SESSION['user_id'].\"'\";\n         }\n         // Get ID of personal folder\n-        $pf = $db->fetchRow(\"SELECT id FROM \".$pre.\"nested_tree WHERE title = '\".$_SESSION['user_id'].\"'\");\n+        // $pf = $db->fetchRow(\"SELECT id FROM \".$pre.\"nested_tree WHERE title = '\".$_SESSION['user_id'].\"'\");\n+        $pf = $db->queryGetRow(\n+            \"nested_tree\",\n+            array(\n+                \"id\"\n+            ),\n+            array(\n+                \"title\" => $_SESSION['user_id']\n+            )\n+        );\n         if (!empty($pf[0])) {\n             if (!in_array($pf[0], $_SESSION['groupes_visibles'])) {\n                 array_push($_SESSION['groupes_visibles'], $pf[0]);\n@@ -433,7 +443,16 @@ function identifyUserRights($groupesVisiblesUser, $groupesInterditsUser, $isAdmi\n             isset($_SESSION['personal_folder']) &&\n             $_SESSION['personal_folder'] == 1\n         ) {\n-            $pf = $db->fetchRow(\"SELECT id FROM \".$pre.\"nested_tree WHERE title = '\".$_SESSION['user_id'].\"'\");\n+        // $pf = $db->fetchRow(\"SELECT id FROM \".$pre.\"nested_tree WHERE title = '\".$_SESSION['user_id'].\"'\");\n+        $pf = $db->queryGetRow(\n+            \"nested_tree\",\n+            array(\n+                \"id\"\n+            ),\n+            array(\n+                \"title\" => intval($_SESSION['user_id'])\n+            )\n+        );\n             if (!empty($pf[0])) {\n                 if (!in_array($pf[0], $listAllowedFolders)) {\n                     // get all descendants\n@@ -560,14 +579,28 @@ function updateCacheTable($action, $id = \"\")\n         // UPDATE an item\n     } elseif ($action == \"update_value\") {\n         // get new value from db\n-        $sql = \"SELECT label, description, id_tree, perso, restricted_to, login\n+        /*$sql = \"SELECT label, description, id_tree, perso, restricted_to, login\n                 FROM \".$pre.\"items\n                 WHERE id=\".$id;\n         $row = $db->query($sql);\n-        $data = $db->fetchArray($row);\n+        $data = $db->fetchArray($row);*/\n+        $ret = $db->queryGetArray(\n+            \"items\",\n+            array(\n+                \"label\",\n+                \"description\",\n+                \"id_tree\",\n+                \"perso\",\n+                \"restricted_to\",\n+                \"login\"\n+            ),\n+            array(\n+                \"id\" => intval($id)\n+            )\n+        );\n         // Get all TAGS\n         $tags = \"\";\n-        $itemTags = $db->fetchAllArray(\"SELECT tag FROM \".$pre.\"tags WHERE item_id=\".$id);\n+        $itemTags = $db->fetchAllArray(\"SELECT tag FROM \".$pre.\"tags WHERE item_id=\".intval($id));\n         foreach ($itemTags as $itemTag) {\n             if (!empty($itemTag['tag'])) {\n                 $tags .= $itemTag['tag'].\" \";\n@@ -600,18 +633,40 @@ function updateCacheTable($action, $id = \"\")\n                 'folder' => $folder,\n                 'author' => $_SESSION['user_id'],\n                ),\n-            \"id='\".$id.\"'\"\n+            \"id='\".intval($id).\"'\"\n         );\n         // ADD an item\n     } elseif ($action == \"add_value\") {\n         // get new value from db\n-        $sql = \"SELECT i.label, i.description, i.id_tree as id_tree, i.perso, i.restricted_to, i.id, i.login\n+        /*$sql = \"SELECT i.label, i.description, i.id_tree as id_tree, i.perso, i.restricted_to, i.id, i.login\n                 FROM \".$pre.\"items as i\n                 INNER JOIN \".$pre.\"log_items as l ON (l.id_item = i.id)\n                 WHERE i.id=\".$id.\"\n                 AND l.action = 'at_creation'\";\n         $row = $db->query($sql);\n-        $data = $db->fetchArray($row);\n+        $data = $db->fetchArray($row);*/\n+        $data = $db->queryGetArray(\n+            array(\n+                \"items\" => \"i\"\n+            ),\n+            array(\n+                \"i.label\" => \"label\",\n+                \"i.description\" => \"description\",\n+                \"i.id_tree\" => id_tree,\n+                \"i.perso\" => \"perso\",\n+                \"i.restricted_to\" => \"restricted_to\",\n+                \"i.login\" => \"login\",\n+                \"i.id\" => \"id\"\n+            ),\n+            array(\n+                \"i.id\" => intval($id),\n+                \"l.action\" => \"at_creation\"\n+            ),\n+            \"\",\n+            array(\n+                \"log_items as l\" => \"(l.id_item = i.id)\"\n+            )\n+        );\n         // Get all TAGS\n         $tags = \"\";\n         $itemTags = $db->fetchAllArray(\"SELECT tag FROM \".$pre.\"tags WHERE item_id=\".$id);"
        },
        {
          "filename": "sources/main.queries.php",
          "status": "modified",
          "additions": 104,
          "deletions": 33,
          "patch": "@@ -2,9 +2,9 @@\n /**\n  *\n  * @file          main.queries.php\n- * @author        Nils Laumaill\u00e9\n+ * @author        Nils Laumaill\u00c3\u00a9\n  * @version       2.1.19\n- * @copyright     (c) 2009-2014 Nils Laumaill\u00e9\n+ * @copyright     (c) 2009-2014 Nils Laumaill\u00c3\u00a9\n  * @licensing     GNU AFFERO GPL 3.0\n  * @link          http://www.teampass.net\n  *\n@@ -144,7 +144,16 @@\n                    )\n             );\n             //Send email to user\n-            $row = $db->fetchRow(\"SELECT email FROM \".$pre.\"users WHERE id=\".$dataReceived['user_id']);\n+            // $row = $db->fetchRow(\"SELECT email FROM \".$pre.\"users WHERE id=\".$dataReceived['user_id']);\n+            $row = $db->queryGetRow(\n+                \"users\",\n+                array(\n+                    \"email\"\n+                ),\n+                array(\n+                    \"id\" => intval($dataReceived['user_id'])\n+                )\n+            );\n             if (!empty($row[0])) {\n                 sendEmail(\n                     $txt['forgot_pw_email_subject'],\n@@ -780,27 +789,36 @@\n         $key = $pwgen->generate();\n \n         // Get account and pw associated to email\n-        $data = $db->fetchRow(\n-            \"SELECT COUNT(*) FROM \".$pre.\"users WHERE email = '\".\n-            mysql_real_escape_string(stripslashes(($_POST['email']))).\"'\"\n+        $data = $db->queryCount(\n+            \"users\",\n+            array(\n+                \"email\" => mysql_real_escape_string(stripslashes($_POST['email']))\n+            )\n         );\n         $textMail = $txt['forgot_pw_email_body_1'].\" <a href=\\\"\".\n             $_SESSION['settings']['cpassman_url'].\"/index.php?action=password_recovery&key=\".$key.\n-            \"&login=\".$_POST['login'].\"\\\">\".$_SESSION['settings']['cpassman_url'].\n-            \"/index.php?action=password_recovery&key=\".$key.\"&login=\".$_POST['login'].\"</a>.<br><br>\".$txt['thku'];\n-        $textMailAlt = $txt['forgot_pw_email_altbody_1'].\" \".$txt['at_login'].\" : \".$data['login'].\" - \".\n+            \"&login=\".mysql_real_escape_string($_POST['login']).\"\\\">\".$_SESSION['settings']['cpassman_url'].\n+            \"/index.php?action=password_recovery&key=\".$key.\"&login=\".mysql_real_escape_string($_POST['login']).\"</a>.<br><br>\".$txt['thku'];\n+        $textMailAlt = $txt['forgot_pw_email_altbody_1'].\" \".$txt['at_login'].\" : \".mysql_real_escape_string($_POST['login']).\" - \".\n             $txt['index_password'].\" : \".md5($data['pw']);\n \n         if ($data[0] != 0) {\n             $data = $db->fetchArray(\n                 \"SELECT login,pw FROM \".$pre.\"users WHERE email = '\".\n-                mysql_real_escape_string(stripslashes(($_POST['email']))).\"'\"\n+                mysql_real_escape_string(stripslashes($_POST['email'])).\"'\"\n             );\n \n             // Check if email has already a key in DB\n-            $data = $db->fetchRow(\n-                \"SELECT COUNT(*) FROM \".$pre.\"misc WHERE intitule = '\".\n-                $_POST['login'].\"' AND type = 'password_recovery'\"\n+            //$data = $db->fetchRow(\n+            //    \"SELECT COUNT(*) FROM \".$pre.\"misc WHERE intitule = '\".\n+            //    mysql_real_escape_string($_POST['login']).\"' AND type = 'password_recovery'\"\n+            //);\n+            $data = $db->queryCount(\n+                \"misc\",\n+                array(\n+                    \"intitule\" => $_POST['login'],\n+                    \"type\" => \"password_recovery\"\n+                )\n             );\n             if ($data[0] != 0) {\n                 $db->queryUpdate(\n@@ -810,7 +828,7 @@\n                     ),\n                     array(\n                             'type' => 'password_recovery',\n-                            'intitule' => $_POST['login']\n+                            'intitule' => mysql_real_escape_string($_POST['login'])\n                     )\n                 );\n             } else {\n@@ -819,7 +837,7 @@\n                     'misc',\n                     array(\n                             'type' => 'password_recovery',\n-                            'intitule' => $_POST['login'],\n+                            'intitule' => mysql_real_escape_string($_POST['login']),\n                             'valeur' => $key\n                     )\n                 );\n@@ -833,12 +851,27 @@\n         break;\n     // Send to user his new pw if key is conform\n     case \"generate_new_password\":\n+        // decrypt and retreive data in JSON format\n+        $dataReceived = prepareExchangedData($_POST['data'], \"decode\");\n+        // Prepare variables\n+        $login = htmlspecialchars_decode($dataReceived['login']);\n+        $key = htmlspecialchars_decode($dataReceived['key']);\n         // check if key is okay\n-        $data = $db->fetchRow(\n+        /*$data = $db->fetchRow(\n             \"SELECT valeur FROM \".$pre.\"misc WHERE intitule = '\".\n-            $_POST['login'].\"' AND type = 'password_recovery'\"\n+            mysql_real_escape_string($login).\"' AND type = 'password_recovery'\"\n+        );*/\n+        $data = $db->queryGetRow(\n+            \"misc\",\n+            array(\n+                \"valeur\"\n+            ),\n+            array(\n+                \"type\" => \"password_recovery\",\n+                \"intitule\" => $login\n+            )\n         );\n-        if ($_POST['key'] == $data[0]) {\n+        if ($key == $data[0]) {\n             //Load PWGEN\n             $pwgen = new SplClassLoader('Encryption\\PwGen', '../includes/libraries');\n             $pwgen->register();\n@@ -860,19 +893,19 @@\n                 array(\n                     'pw' => $newPw\n                    ),\n-                \"login = '\".$_POST['login'].\"'\"\n+                \"login = '\".mysql_real_escape_string($login).\"'\"\n             );\n             // Delete recovery in DB\n             $db->queryDelete(\n                 \"misc\",\n                 array(\n                     'type' => 'password_recovery',\n-                    'intitule' => $_POST['login'],\n+                    'intitule' => mysql_real_escape_string($login),\n                     'valeur' => $key\n                    )\n             );\n             // Get email\n-            $dataUser = $db->queryFirst(\"SELECT email FROM \".$pre.\"users WHERE login = '\".$_POST['login'].\"'\");\n+            $dataUser = $db->queryFirst(\"SELECT email FROM \".$pre.\"users WHERE login = '\".mysql_real_escape_string($login).\"'\");\n \n             $_SESSION['validite_pw'] = false;\n             // send to user\n@@ -1018,18 +1051,22 @@\n      */\n     case \"change_user_language\":\n         if (!empty($_SESSION['user_id'])) {\n+            // decrypt and retreive data in JSON format\n+            $dataReceived = prepareExchangedData($_POST['data'], \"decode\");\n+            // Prepare variables\n+            $language = $dataReceived['lang'];\n             // update DB\n             $db->queryUpdate(\n                 \"users\",\n                 array(\n-                    'user_language' => $_POST['lang']\n+                    'user_language' => $language\n                    ),\n                 \"id = \".$_SESSION['user_id']\n             );\n-            $_SESSION['user_language'] = $_POST['lang'];\n+            $_SESSION['user_language'] = $language;\n         \techo \"done\";\n         } else {\n-            $_SESSION['user_language'] = $_POST['lang'];\n+            $_SESSION['user_language'] = $language;\n             echo \"done\";\n         }\n         break;\n@@ -1125,26 +1162,60 @@\n      * Generate a password generic\n      */\n     case \"generate_a_password\":\n+    \tif ($_POST['size'] > $_SESSION['settings']['pwd_maximum_length']) {\n+    \t\techo prepareExchangedData(\n+\t    \t\tarray(\n+\t\t    \t\t\"error_msg\" => \"Password length is too long!\",\n+\t\t    \t\t\"error\" => \"true\"\n+\t    \t\t),\n+\t    \t\t\"encode\"\n+    \t\t);\n+    \t\tbreak;\n+    \t}\n+\n         //Load PWGEN\n         $pwgen = new SplClassLoader('Encryption\\PwGen', '../includes/libraries');\n         $pwgen->register();\n         $pwgen = new Encryption\\PwGen\\pwgen();\n-        //Generate\n-        $pwgen->setLength($_POST['length']);\n-        $pwgen->setSecure($_POST['secure']);\n-        $pwgen->setSymbols($_POST['symbols']);\n-        $pwgen->setCapitalize($_POST['capitalize']);\n-        $pwgen->setNumerals($_POST['numerals']);\n \n-        echo Encryption\\Crypt\\aesctr::encrypt($pwgen->generate(), $_SESSION['key'], 256);\n+    \t$pwgen->setLength($_POST['size']);\n+    \tif (isset($_POST['secure']) && $_POST['secure'] == \"true\") {\n+    \t\t$pwgen->setSecure(true);\n+    \t\t$pwgen->setSymbols(true);\n+    \t\t$pwgen->setCapitalize(true);\n+    \t\t$pwgen->setNumerals(true);\n+    \t} else {\n+    \t\t$pwgen->setSecure(($_POST['secure'] == \"true\")? true : false);\n+    \t\t$pwgen->setNumerals(($_POST['numerals'] == \"true\")? true : false);\n+    \t\t$pwgen->setCapitalize(($_POST['capitalize'] == \"true\")? true : false);\n+    \t\t$pwgen->setSymbols(($_POST['symbols'] == \"true\")? true : false);\n+    \t}\n+\n+        echo prepareExchangedData(\n+        \tarray(\n+\t        \t\"key\" => $pwgen->generate(),\n+\t        \t\"error\" => \"\"\n+        \t),\n+        \t\"encode\"\n+        );\n         break;\n     /**\n      * Check if user exists and send back if psk is set\n      */\n     case \"check_login_exists\":\n-        $sql = \"SELECT * FROM \".$pre.\"users WHERE login = '\".addslashes($_POST['userId']).\"'\";\n+        /*$sql = \"SELECT * FROM \".$pre.\"users WHERE login = '\".addslashes($_POST['userId']).\"'\";\n         $row = $db->query($sql);\n-        $data = $db->fetchArray($row);\n+        $data = $db->fetchArray($row);*/\n+        $data = $db->queryGetArray(\n+            \"users\",\n+            array(\n+                \"login\",\n+                \"psk\"\n+            ),\n+            array(\n+                \"login\" => $_POST['userId']\n+            )\n+        );\n         if (empty($data['login'])) {\n             $userOk = false;\n         } else {"
        },
        {
          "filename": "sources/roles.queries.php",
          "status": "modified",
          "additions": 36,
          "deletions": 4,
          "patch": "@@ -14,10 +14,22 @@\n \n require_once('sessions.php');\n session_start();\n-if (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 || !isset($_SESSION['key']) || empty($_SESSION['key'])) {\n+if (\n+    !isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 || \n+    !isset($_SESSION['user_id']) || empty($_SESSION['user_id']) || \n+    !isset($_SESSION['key']) || empty($_SESSION['key'])) \n+{\n     die('Hacking attempt...');\n }\n \n+/* do checks */\n+require_once $_SESSION['settings']['cpassman_dir'].'/sources/checks.php';\n+if (!checkUser($_SESSION['user_id'], $_SESSION['key'], \"manage_roles\")) {\n+    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n+    include 'error.php';\n+    exit();\n+}\n+\n include $_SESSION['settings']['cpassman_dir'].'/includes/language/'.$_SESSION['user_language'].'.php';\n include $_SESSION['settings']['cpassman_dir'].'/includes/settings.php';\n header(\"Content-type: text/html; charset=utf-8\");\n@@ -41,7 +53,13 @@\n         #CASE adding a new role\n         case \"add_new_role\":\n             //Check if role already exist : No similar roles\n-            $tmp = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"roles_title WHERE title = '\".mysql_real_escape_string(stripslashes($_POST['name'])).\"'\");\n+            //$tmp = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"roles_title WHERE title = '\".mysql_real_escape_string(stripslashes($_POST['name'])).\"'\");\n+            $tmp = $db->queryCount(\n+                \"roles_title\",\n+                array(\n+                    \"title\" => stripslashes($_POST['name'])\n+                )\n+            );\n             if ($tmp[0] == 0) {\n                 $role_id = $db->queryInsert(\n                         'roles_title',\n@@ -79,7 +97,14 @@\n         #CASE editing a role\n         case \"edit_role\":\n             //Check if role already exist : No similar roles\n-            $tmp = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"roles_title WHERE id != '\".$_POST['id'].\"' AND title = '\".mysql_real_escape_string(stripslashes($_POST['title'])).\"'\");\n+            //$tmp = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"roles_title WHERE id != '\".$_POST['id'].\"' AND title = '\".mysql_real_escape_string(stripslashes($_POST['title'])).\"'\");\n+            $tmp = $db->queryCount(\n+                \"roles_title\",\n+                array(\n+                    \"title\" => stripslashes($_POST['title']),\n+                    \"id\" => intval($_POST['id'])\n+                )\n+            );\n             if ($tmp[0] == 0) {\n                 $db->queryUpdate(\n                     \"roles_title\",\n@@ -221,7 +246,14 @@\n                     foreach ($arrRoles as $role) {\n                         //check if this role has access or not\n                         // if not then color is red; if yes then color is green\n-                        $count = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"roles_values WHERE folder_id = \".$node->id.\" AND role_id = \".$role);\n+                        //$count = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"roles_values WHERE folder_id = \".$node->id.\" AND role_id = \".$role);\n+                        $count = $db->queryCount(\n+                            \"roles_values\",\n+                            array(\n+                                \"folder_id\" => intval($node->id),\n+                                \"role_id\" => intval($role)\n+                            )\n+                        );\n                         if ($count[0] > 0) {\n                             $couleur = '#008000';\n                             $allowed = 1;"
        },
        {
          "filename": "sources/upload/upload.attachments.php",
          "status": "modified",
          "additions": 13,
          "deletions": 1,
          "patch": "@@ -14,10 +14,22 @@\n \n require_once('../sessions.php');\n session_start();\n-if (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1) {\n+if (\n+        !isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 ||\n+        !isset($_SESSION['user_id']) || empty($_SESSION['user_id']) ||\n+        !isset($_SESSION['key']) || empty($_SESSION['key'])\n+) {\n     die('Hacking attempt...');\n }\n \n+/* do checks */\n+require_once $_SESSION['settings']['cpassman_dir'].'/sources/checks.php';\n+if (!checkUser($_SESSION['user_id'], $_SESSION['key'], \"items\")) {\n+    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n+    handleError('Not allowed to ...', 110);\n+    exit();\n+}\n+\n //check for session\n if (isset($_POST['PHPSESSID'])) {\n     session_id($_POST['PHPSESSID']);"
        },
        {
          "filename": "sources/upload/upload.files.php",
          "status": "modified",
          "additions": 13,
          "deletions": 1,
          "patch": "@@ -14,10 +14,22 @@\n \n require_once('../sessions.php');\n session_start();\n-if (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1) {\n+if (\n+        !isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 ||\n+        !isset($_SESSION['user_id']) || empty($_SESSION['user_id']) ||\n+        !isset($_SESSION['key']) || empty($_SESSION['key'])\n+) {\n     die('Hacking attempt...');\n }\n \n+/* do checks */\n+require_once $_SESSION['settings']['cpassman_dir'].'/sources/checks.php';\n+if (!checkUser($_SESSION['user_id'], $_SESSION['key'], \"items\")) {\n+    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n+    handleError('Not allowed to ...', 110);\n+    exit();\n+}\n+\n //check for session\n if (isset($_POST['PHPSESSID'])) {\n     session_id($_POST['PHPSESSID']);"
        },
        {
          "filename": "sources/users.queries.php",
          "status": "modified",
          "additions": 123,
          "deletions": 23,
          "patch": "@@ -6,15 +6,31 @@\n  * @version       2.1.20\n  * @copyright     (c) 2009-2014 Nils Laumaill\u00e9\n  * @licensing     GNU AFFERO GPL 3.0\n- * @link          http://www.teampass.net\n+ * @link\t\thttp://www.teampass.net\n+ *\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n  */\n \n require_once('sessions.php');\n session_start();\n-if (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 || !isset($_SESSION['key']) || empty($_SESSION['key'])) {\n+if (\n+    !isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 || \n+    !isset($_SESSION['user_id']) || empty($_SESSION['user_id']) || \n+    !isset($_SESSION['key']) || empty($_SESSION['key'])) \n+{\n     die('Hacking attempt...');\n }\n \n+/* do checks */\n+require_once $_SESSION['settings']['cpassman_dir'].'/sources/checks.php';\n+if (!checkUser($_SESSION['user_id'], $_SESSION['key'], \"manage_users\")) {\n+    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n+    include 'error.php';\n+    exit();\n+}\n+\n include $_SESSION['settings']['cpassman_dir'].'/includes/settings.php';\n header(\"Content-type: text/html; charset=utf-8\");\n require_once $_SESSION['settings']['cpassman_dir'].'/includes/language/'.$_SESSION['user_language'].'.php';\n@@ -44,7 +60,16 @@\n             $val = explode(';', $_POST['valeur']);\n             $valeur = $_POST['valeur'];\n             // Check if id folder is already stored\n-            $data = $db->fetchRow(\"SELECT \".$_POST['type'].\" FROM \".$pre.\"users WHERE id = \".$val[0]);\n+            // $data = $db->fetchRow(\"SELECT \".$_POST['type'].\" FROM \".$pre.\"users WHERE id = \".$val[0]);\n+            $data = $db->queryGetRow(\n+                \"users\",\n+                array(\n+                    $_POST['type']\n+                ),\n+                array(\n+                    \"id\" => intval($val[0])\n+                )\n+            );\n             $new_groupes = $data[0];\n             if (!empty($data[0])) {\n                 $groupes = explode(';', $data[0]);\n@@ -74,7 +99,16 @@\n             $val = explode(';', $_POST['valeur']);\n             $valeur = $_POST['valeur'];\n             // v?rifier si l'id est d?j? pr?sent\n-            $data = $db->fetchRow(\"SELECT fonction_id FROM \".$pre.\"users WHERE id = $val[0]\");\n+            // $data = $db->fetchRow(\"SELECT fonction_id FROM \".$pre.\"users WHERE id = $val[0]\");\n+            $data = $db->queryGetRow(\n+                \"users\",\n+                array(\n+                    \"fonction_id\"\n+                ),\n+                array(\n+                    \"id\" => intval($val[0])\n+                )\n+            );\n             $new_fonctions = $data[0];\n             if (!empty($data[0])) {\n                 $fonctions = explode(';', $data[0]);\n@@ -239,7 +273,17 @@\n                        )\n                 );\n                 // delete personal folder and subfolders\n-                $data = $db->fetchRow(\"SELECT id FROM \".$pre.\"nested_tree WHERE title = '\".$_POST['id'].\"' AND personal_folder = 1\");    // Get personal folder ID\n+                // $data = $db->fetchRow(\"SELECT id FROM \".$pre.\"nested_tree WHERE title = '\".$_POST['id'].\"' AND personal_folder = 1\");    // Get personal folder ID\n+                $data = $db->queryGetRow(\n+                    \"nested_tree\",\n+                    array(\n+                        \"id\"\n+                    ),\n+                    array(\n+                        \"title\" => intval($_POST['id']),\n+                        \"personal_folder\" => \"1\"\n+                    )\n+                );\n                 // Get through each subfolder\n                 if (!empty($data[0])) {\n                     $folders = $tree->getDescendants($data[0], true);\n@@ -304,7 +348,16 @@\n                 echo '[ { \"error\" : \"yes\" } ]';\n             }\n             // Get old email\n-            $data = $db->fetchRow(\"SELECT email FROM \".$pre.\"users WHERE id = '\".$_POST['id'].\"'\");\n+            // $data = $db->fetchRow(\"SELECT email FROM \".$pre.\"users WHERE id = '\".$_POST['id'].\"'\");\n+            $data = $db->queryGetRow(\n+                \"users\",\n+                array(\n+                    \"email\"\n+                ),\n+                array(\n+                    \"id\" => intval($_POST['id'])\n+                )\n+            );\n \n             $db->queryUpdate(\n                 \"users\",\n@@ -423,7 +476,16 @@\n         case \"open_div_functions\";\n             $text = \"\";\n             // Refresh list of existing functions\n-            $data_user = $db->fetchRow(\"SELECT fonction_id FROM \".$pre.\"users WHERE id = \".$_POST['id']);\n+            // $data_user = $db->fetchRow(\"SELECT fonction_id FROM \".$pre.\"users WHERE id = \".$_POST['id']);\n+            $data = $db->queryGetRow(\n+                \"users\",\n+                array(\n+                    \"fonction_id\"\n+                ),\n+                array(\n+                    \"id\" => intval($_POST['id'])\n+                )\n+            );\n             $users_functions = explode(';', $data_user[0]);\n             // array of roles for actual user\n             $my_functions = explode(';', $_SESSION['fonction_id']);\n@@ -484,7 +546,16 @@\n         case \"open_div_autgroups\";\n             $text = \"\";\n             // Refresh list of existing functions\n-            $data_user = $db->fetchRow(\"SELECT groupes_visibles FROM \".$pre.\"users WHERE id = \".$_POST['id']);\n+            // $data_user = $db->fetchRow(\"SELECT groupes_visibles FROM \".$pre.\"users WHERE id = \".$_POST['id']);\n+            $data_user = $db->queryGetRow(\n+                \"users\",\n+                array(\n+                    \"groupes_visibles\"\n+                ),\n+                array(\n+                    \"id\" => intval($_POST['id'])\n+                )\n+            );\n             $user = explode(';', $data_user[0]);\n \n             $tree_desc = $tree->getDescendants();\n@@ -574,7 +645,16 @@\n \n             $text = \"\";\n             // Refresh list of existing functions\n-            $data_user = $db->fetchRow(\"SELECT groupes_interdits FROM \".$pre.\"users WHERE id = \".$_POST['id']);\n+            // $data_user = $db->fetchRow(\"SELECT groupes_interdits FROM \".$pre.\"users WHERE id = \".$_POST['id']);\n+            $data_user = $db->queryGetRow(\n+                \"users\",\n+                array(\n+                    \"groupes_interdits\"\n+                ),\n+                array(\n+                    \"id\" => intval($_POST['id'])\n+                )\n+            );\n             $user = explode(';', $data_user[0]);\n \n             $tree_desc = $tree->getDescendants();\n@@ -662,14 +742,27 @@\n         case \"check_domain\":\n             $return = array();\n             // Check if folder exists\n-            $data = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"nested_tree WHERE title = '\".$_POST['domain'].\"' AND parent_id = 0\");\n+            //$data = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"nested_tree WHERE title = '\".$_POST['domain'].\"' AND parent_id = 0\");\n+            $data = $db->queryCount(\n+                \"nested_tree\",\n+                array(\n+                    \"title\" => $_POST['domain'],\n+                    \"parent_id\" => \"0\"\n+                )\n+            );\n             if ($data[0] != 0) {\n                 $return[\"folder\"] = \"exists\";\n             } else {\n                 $return[\"folder\"] = \"not_exists\";\n             }\n             // Check if role exists\n-            $data = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"roles_title WHERE title = '\".$_POST['domain'].\"'\");\n+            //$data = $db->fetchRow(\"SELECT COUNT(*) FROM \".$pre.\"roles_title WHERE title = '\".$_POST['domain'].\"'\");\n+            $data = $db->queryCount(\n+                \"roles_title\",\n+                array(\n+                    \"title\" => $_POST['domain']\n+                )\n+            );\n             if ($data[0] != 0) {\n                 $return[\"role\"] = \"exists\";\n             } else {\n@@ -697,7 +790,7 @@\n                     FROM \".$pre.\"log_items as l\n                     INNER JOIN \".$pre.\"items as i ON (l.id_item=i.id)\n                     INNER JOIN \".$pre.\"users as u ON (l.id_user=u.id)\n-                    WHERE l.id_user = \".$_POST['id'].$sql_filter\n+                    WHERE l.id_user = \".intval($_POST['id'].$sql_filter)\n                 );\n                 // define query limits\n                 if (isset($_POST['page']) && $_POST['page'] > 1) {\n@@ -711,16 +804,23 @@\n                     FROM \".$pre.\"log_items as l\n                     INNER JOIN \".$pre.\"items as i ON (l.id_item=i.id)\n                     INNER JOIN \".$pre.\"users as u ON (l.id_user=u.id)\n-                    WHERE l.id_user = \".$_POST['id'].$sql_filter.\"\n+                    WHERE l.id_user = \".intval($_POST['id'].$sql_filter).\"\n                     ORDER BY date DESC\n-                    LIMIT $start,\".$_POST['nb_items_by_page']\n+                    LIMIT \".intval($start).\",\".intval($_POST['nb_items_by_page'])\n                 );\n             } else {\n                 // get number of pages\n-                $data = $db->fetchRow(\n-                    \"SELECT COUNT(*)\n-                    FROM \".$pre.\"log_system\n-                    WHERE type = 'user_mngt' AND field_1=\".$_POST['id']\n+                //$data = $db->fetchRow(\n+                //    \"SELECT COUNT(*)\n+                //    FROM \".$pre.\"log_system\n+                //    WHERE type = 'user_mngt' AND field_1=\".$_POST['id']\n+                //);\n+                $data = $db->queryCount(\n+                    \"log_system\",\n+                    array(\n+                        \"type\" => \"user_mngt\",\n+                        \"field_1\" => $_POST['id']\n+                    )\n                 );\n                 // define query limits\n                 if (isset($_POST['page']) && $_POST['page'] > 1) {\n@@ -779,9 +879,9 @@\n                 echo '[ { \"error\" : \"no_user_id\" } ]';\n             } else {\n                 // Get folder id for Admin\n-                $admin_folder = $db->queryFirst(\"SELECT id FROM \".$pre.\"nested_tree WHERE title='\".$_SESSION['user_id'].\"' AND personal_folder = 1\");\n+                $admin_folder = $db->queryFirst(\"SELECT id FROM \".$pre.\"nested_tree WHERE title='\".intval($_SESSION['user_id']).\"' AND personal_folder = 1\");\n                 // Get folder id for User\n-                $user_folder = $db->queryFirst(\"SELECT id FROM \".$pre.\"nested_tree WHERE title='\".$user_id.\"' AND personal_folder = 1\");\n+                $user_folder = $db->queryFirst(\"SELECT id FROM \".$pre.\"nested_tree WHERE title='\".intval($user_id).\"' AND personal_folder = 1\");\n                 // Get through each subfolder\n                 foreach ($tree->getDescendants($admin_folder['id'], true) as $folder) {\n                     // Create folder if necessary\n@@ -800,7 +900,7 @@\n                         \"SELECT i.pw, i.label, l.id_user\n                         FROM \".$pre.\"items as i\n                         LEFT JOIN \".$pre.\"log_items as l ON (l.id_item=i.id)\n-                        WHERE l.action = 'at_creation' AND i.perso=1 AND i.id_tree=\".$folder->id\n+                        WHERE l.action = 'at_creation' AND i.perso=1 AND i.id_tree=\".intval($folder->id)\n                     );\n                     foreach ($rows as $reccord) {\n                         echo $reccord['label'].\" - \";\n@@ -841,7 +941,7 @@\n                         'key_tempo' => \"\",\n                         'session_end' => \"\"\n                        ),\n-                    \"id = \".$_POST['user_id']\n+                    \"id = \".intval($_POST['user_id'])\n                 );\n             break;\n \n@@ -864,7 +964,7 @@\n                         'key_tempo' => \"\",\n                         'session_end' => \"\"\n                        ),\n-                    \"id = \".$reccord['id']\n+                    \"id = \".intval($reccord['id'])\n                 );\n             }\n             break;"
        },
        {
          "filename": "sources/views.queries.php",
          "status": "modified",
          "additions": 24,
          "deletions": 12,
          "patch": "@@ -14,10 +14,22 @@\n \n require_once('sessions.php');\n session_start();\n-if (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 || !isset($_SESSION['key']) || empty($_SESSION['key'])) {\n+if (\n+    !isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 || \n+    !isset($_SESSION['user_id']) || empty($_SESSION['user_id']) || \n+    !isset($_SESSION['key']) || empty($_SESSION['key'])) \n+{\n     die('Hacking attempt...');\n }\n \n+/* do checks */\n+require_once $_SESSION['settings']['cpassman_dir'].'/sources/checks.php';\n+if (!checkUser($_SESSION['user_id'], $_SESSION['key'], \"manage_views\")) {\n+    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n+    include 'error.php';\n+    exit();\n+}\n+\n include $_SESSION['settings']['cpassman_dir'].'/includes/language/'.$_SESSION['user_language'].'.php';\n include $_SESSION['settings']['cpassman_dir'].'/includes/settings.php';\n include $_SESSION['settings']['cpassman_dir'].'/includes/include.php';\n@@ -371,7 +383,7 @@\n             FROM \".$pre.\"log_items as l\n             INNER JOIN \".$pre.\"items as i ON (l.id_item=i.id)\n             INNER JOIN \".$pre.\"users as u ON (l.id_user=u.id)\n-            WHERE l.action = 'at_shown'\".$sqlFilter\n+            WHERE l.action = 'at_shown'\".mysql_real_escape_string($sqlFilter)\n         );\n         if ($data[0] != 0) {\n             $nbPages = ceil($data[0]/$nbElements);\n@@ -426,7 +438,7 @@\n             FROM \".$pre.\"log_items as l\n             INNER JOIN \".$pre.\"items as i ON (l.id_item=i.id)\n             INNER JOIN \".$pre.\"users as u ON (l.id_user=u.id)\n-            WHERE l.action = 'at_copy'\".$sqlFilter\n+            WHERE l.action = 'at_copy'\".mysql_real_escape_string($sqlFilter)\n         );\n         if ($data[0] != 0) {\n             $nbPages = ceil($data[0]/$nbElements);\n@@ -482,7 +494,7 @@\n             FROM \".$pre.\"log_items as l\n             INNER JOIN \".$pre.\"items as i ON (l.id_item=i.id)\n             INNER JOIN \".$pre.\"users as u ON (l.id_user=u.id)\n-            WHERE i.label LIKE '%\".$_POST['filter'].\"%'\"\n+            WHERE i.label LIKE '%\".mysql_real_escape_string($_POST['filter']).\"%'\"\n         );\n         if ($data[0] != 0) {\n             $nbPages = ceil($data[0]/$nbElements);\n@@ -543,7 +555,7 @@\n             \"SELECT COUNT(*)\n             FROM \".$pre.\"log_system as l\n             INNER JOIN \".$pre.\"users as u ON (l.qui=u.id)\n-            WHERE l.type = 'admin_action'\".$sqlFilter\n+            WHERE l.type = 'admin_action'\".mysql_real_escape_string($sqlFilter)\n         );\n         if ($data[0] != 0) {\n             $nbPages = ceil($data[0]/$nbElements);\n@@ -685,7 +697,7 @@\n             if ($_POST['logType'] == \"items_logs\") {\n                 $nbElements = $db->fetchRow(\n                     \"SELECT COUNT(*) FROM \".$pre.\"log_items WHERE action='at_shown' \".\n-                    \"AND date BETWEEN '\".strtotime($_POST['purgeFrom']).\"' AND '\".strtotime($_POST['purgeTo']).\"'\"\n+                    \"AND date BETWEEN '\".intval(strtotime($_POST['purgeFrom'])).\"' AND '\".intval(strtotime($_POST['purgeTo'])).\"'\"\n                 );\n                 // Delete\n                 $db->query(\n@@ -695,8 +707,8 @@\n             } elseif ($_POST['logType'] == \"connections_logs\") {\n                 $nbElements = $db->fetchRow(\n                     \"SELECT COUNT(*) FROM \".$pre.\"log_system WHERE type='user_connection' \".\n-                    \"AND date BETWEEN '\".strtotime($_POST['purgeFrom']).\"' AND '\".\n-                    strtotime($_POST['purgeTo']).\"'\"\n+                    \"AND date BETWEEN '\".intval(strtotime($_POST['purgeFrom'])).\"' AND '\".\n+                    intval(strtotime($_POST['purgeTo'])).\"'\"\n                 );\n                 // Delete\n                 $db->query(\n@@ -706,8 +718,8 @@\n             } elseif ($_POST['logType'] == \"errors_logs\") {\n                 $nbElements = $db->fetchRow(\n                     \"SELECT COUNT(*) FROM \".$pre.\"log_system WHERE type='error' \".\n-                    \"AND date BETWEEN '\".strtotime($_POST['purgeFrom']).\"' AND '\".\n-                    strtotime($_POST['purgeTo']).\"'\"\n+                    \"AND date BETWEEN '\".intval(strtotime($_POST['purgeFrom'])).\"' AND '\".\n+                    intval(strtotime($_POST['purgeTo'])).\"'\"\n                 );\n                 // Delete\n                 $db->query(\n@@ -717,8 +729,8 @@\n             } elseif ($_POST['logType'] == \"copy_logs\") {\n                 $nbElements = $db->fetchRow(\n                     \"SELECT COUNT(*) FROM \".$pre.\"log_items WHERE action='at_copy' \".\n-                    \"AND date BETWEEN '\".strtotime($_POST['purgeFrom']).\"' AND '\".\n-                    strtotime($_POST['purgeTo']).\"'\"\n+                    \"AND date BETWEEN '\".intval(strtotime($_POST['purgeFrom'])).\"' AND '\".\n+                    intval(strtotime($_POST['purgeTo'])).\"'\"\n                 );\n                 // Delete\n                 $db->query("
        },
        {
          "filename": "users.load.php",
          "status": "modified",
          "additions": 18,
          "deletions": 8,
          "patch": "@@ -256,12 +256,17 @@ function(data) {\n                             secure     : true,\n                             symbols    : false,\n                             capitalize : true,\n-                            numerals   : true,\n+                            numerals   : true\n                         },\n                         function(data) {\n-                            var pw = htmlspecialchars_decode(aes_decrypt(data));\n-                        \t$(\"#change_user_pw_newpw_confirm, #change_user_pw_newpw\").val(pw);\n-                    \t\t$(\"#change_user_pw_newpw\").focus();\n+                        \tdata = prepareExchangedData(data, \"decode\");\n+                        \tif (data.error == \"true\") {\n+                        \t\t$(\"#div_dialog_message_text\").html(data.error_msg);\n+                        \t\t$(\"#div_dialog_message\").dialog(\"open\");\n+                        \t} else {\n+                        \t\t$(\"#change_user_pw_newpw_confirm, #change_user_pw_newpw\").val(pw);\n+                        \t\t$(\"#change_user_pw_newpw\").focus();\n+                        \t}\n                     \t\t$(\"#change_user_pw_wait\").hide();\n                         }\n                    );\n@@ -407,9 +412,9 @@ function(data) {\n function pwGenerate(elem)\n {\n     $.post(\n-        \"sources/items.queries.php\",\n+        \"sources/main.queries.php\",\n         {\n-            type    : \"pw_generate\",\n+            type    : \"generate_a_password\",\n             size    : Math.floor((8-5)*Math.random()) + 6,\n             num        : true,\n             maj        : true,\n@@ -419,8 +424,13 @@ function pwGenerate(elem)\n             force    : false\n         },\n         function(data) {\n-            data = $.parseJSON(data);\n-            $(\"#\"+elem).val(data.key).focus();\n+        \tdata = prepareExchangedData(data, \"decode\");\n+        \tif (data.error == \"true\") {\n+        \t\t$(\"#div_dialog_message_text\").html(data.error_msg);\n+        \t\t$(\"#div_dialog_message\").dialog(\"open\");\n+        \t} else {\n+        \t\t$(\"#\"+elem).val(data.key).focus();\n+        \t}\n         }\n    );\n }"
        },
        {
          "filename": "users.php",
          "status": "modified",
          "additions": 13,
          "deletions": 1,
          "patch": "@@ -13,10 +13,22 @@\n  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n  */\n \n-if (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1) {\n+if (\n+    !isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 || \n+    !isset($_SESSION['user_id']) || empty($_SESSION['user_id']) || \n+    !isset($_SESSION['key']) || empty($_SESSION['key'])) \n+{\n     die('Hacking attempt...');\n }\n \n+/* do checks */\n+require_once $_SESSION['settings']['cpassman_dir'].'/sources/checks.php';\n+if (!checkUser($_SESSION['user_id'], $_SESSION['key'], curPage())) {\n+    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n+    include 'error.php';\n+    exit();\n+}\n+\n require_once $_SESSION['settings']['cpassman_dir'].'/sources/SplClassLoader.php';\n \n // Load file"
        },
        {
          "filename": "views.php",
          "status": "modified",
          "additions": 13,
          "deletions": 1,
          "patch": "@@ -12,10 +12,22 @@\n  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n  */\n \n-if (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1) {\n+if (\n+    !isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 || \n+    !isset($_SESSION['user_id']) || empty($_SESSION['user_id']) || \n+    !isset($_SESSION['key']) || empty($_SESSION['key'])) \n+{\n     die('Hacking attempt...');\n }\n \n+/* do checks */\n+require_once $_SESSION['settings']['cpassman_dir'].'/sources/checks.php';\n+if (!checkUser($_SESSION['user_id'], $_SESSION['key'], curPage())) {\n+    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n+    include 'error.php';\n+    exit();\n+}\n+\n //Load file\n require_once 'views.load.php';\n "
        },
        {
          "filename": "views_database.php",
          "status": "modified",
          "additions": 16,
          "deletions": 5,
          "patch": "@@ -1,9 +1,9 @@\n <?php\n /**\n  * @file          views_database.php\n- * @author        Nils Laumaill\u00e9\n+ * @author        Nils Laumaill\u00c3\u00a9\n  * @version       2.1.19\n- * @copyright     (c) 2009-2014 Nils Laumaill\u00e9\n+ * @copyright     (c) 2009-2014 Nils Laumaill\u00c3\u00a9\n  * @licensing     GNU AFFERO GPL 3.0\n  * @link          http://www.teampass.net\n  *\n@@ -14,14 +14,25 @@\n \n require_once('sources/sessions.php');\n session_start();\n-\n-if (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1) {\n+if (\n+    !isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 ||\n+    !isset($_SESSION['user_id']) || empty($_SESSION['user_id']) ||\n+    !isset($_SESSION['key']) || empty($_SESSION['key']))\n+{\n     die('Hacking attempt...');\n }\n \n+/* do checks */\n+include $_SESSION['settings']['cpassman_dir'].'/includes/include.php';\n+require_once $_SESSION['settings']['cpassman_dir'].'/sources/checks.php';\n+if (!checkUser($_SESSION['user_id'], $_SESSION['key'], \"manage_views\")) {\n+    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n+    include 'error.php';\n+    exit();\n+}\n+\n include $_SESSION['settings']['cpassman_dir'].'/includes/language/'.$_SESSION['user_language'].'.php';\n include $_SESSION['settings']['cpassman_dir'].'/includes/settings.php';\n-include $_SESSION['settings']['cpassman_dir'].'/includes/include.php';\n header(\"Content-type: text/html; charset=utf-8\");\n include $_SESSION['settings']['cpassman_dir'].'/sources/main.functions.php';\n "
        },
        {
          "filename": "views_logs.php",
          "status": "modified",
          "additions": 13,
          "deletions": 1,
          "patch": "@@ -15,10 +15,22 @@\n require_once('sources/sessions.php');\n session_start();\n \n-if (!isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1) {\n+if (\n+    !isset($_SESSION['CPM']) || $_SESSION['CPM'] != 1 || \n+    !isset($_SESSION['user_id']) || empty($_SESSION['user_id']) || \n+    !isset($_SESSION['key']) || empty($_SESSION['key'])) \n+{\n     die('Hacking attempt...');\n }\n \n+/* do checks */\n+require_once $_SESSION['settings']['cpassman_dir'].'/sources/checks.php';\n+if (!checkUser($_SESSION['user_id'], $_SESSION['key'], \"manage_views\")) {\n+    $_SESSION['error']['code'] = ERR_NOT_ALLOWED; //not allowed page\n+    include 'error.php';\n+    exit();\n+}\n+\n include $_SESSION['settings']['cpassman_dir'].'/includes/language/'.$_SESSION['user_language'].'.php';\n include $_SESSION['settings']['cpassman_dir'].'/includes/settings.php';\n include $_SESSION['settings']['cpassman_dir'].'/includes/include.php';"
        }
      ],
      "file_patterns": {
        "security_files": 1,
        "config_files": 3,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 9,
        "max_directory_depth": 4
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "aacdf6a3f2daf9b52a826d4b3d8a39873e2e2062",
            "date": "2025-01-13T17:24:23Z",
            "author_login": "nilsteampassnet"
          },
          {
            "sha": "eb95bc3e37f6e1f19fce98aa4c44c251f2084cd7",
            "date": "2025-01-13T17:20:31Z",
            "author_login": "nilsteampassnet"
          },
          {
            "sha": "9969d0ef636e28c1afcdb047aac2d2a5387b62b5",
            "date": "2025-01-12T17:29:37Z",
            "author_login": "nilsteampassnet"
          },
          {
            "sha": "4963736272bc4b281586f8ad4dcee70015d595b1",
            "date": "2025-01-12T17:22:24Z",
            "author_login": "nilsteampassnet"
          },
          {
            "sha": "b5a997952a43e4760c9eaceedfd9a7ba4a5683d2",
            "date": "2025-01-10T16:06:22Z",
            "author_login": "nilsteampassnet"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": null,
    "cvss_vector": null,
    "cwe_id": "CWE-264",
    "description": "TeamPass before 2.1.20 allows remote attackers to bypass access restrictions via a request to index.php followed by a direct request to a file that calls the session_start function before checking the CPM key, as demonstrated by a request to sources/upload/upload.files.php.",
    "attack_vector": null,
    "attack_complexity": null
  },
  "temporal_data": {
    "published_date": "2014-08-07T11:13:35.140",
    "last_modified": "2024-11-21T02:08:48.040",
    "fix_date": "2014-04-18T09:55:28Z"
  },
  "references": [
    {
      "url": "http://teampass.net/installation/2.1.20-released.html",
      "source": "cve@mitre.org",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2014/05/18/2",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2014/05/19/5",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "https://github.com/nilsteampassnet/TeamPass/commit/7715512f2bd5659cc69e063a1c513c19e384340f",
      "source": "cve@mitre.org",
      "tags": [
        "Exploit",
        "Patch"
      ]
    },
    {
      "url": "http://teampass.net/installation/2.1.20-released.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2014/05/18/2",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2014/05/19/5",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://github.com/nilsteampassnet/TeamPass/commit/7715512f2bd5659cc69e063a1c513c19e384340f",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Patch"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T22:58:25.519660",
    "processing_status": "enhanced"
  }
}