{
  "cve_id": "CVE-2014-3774",
  "github_data": {
    "repository": "nilsteampassnet/TeamPass",
    "fix_commit": "8820c8934d9ba0508ac345e73ad0be29049ec6de",
    "related_commits": [
      "8820c8934d9ba0508ac345e73ad0be29049ec6de",
      "fd549b245c0f639a8d47bf4f74f92c37c053706f",
      "8820c8934d9ba0508ac345e73ad0be29049ec6de",
      "fd549b245c0f639a8d47bf4f74f92c37c053706f"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "8820c8934d9ba0508ac345e73ad0be29049ec6de",
      "commit_date": "2014-05-03T06:06:26Z",
      "author": {
        "login": "nilsteampassnet",
        "type": "User",
        "stats": {
          "total_commits": 2012,
          "average_weekly_commits": 2.9415204678362574,
          "total_additions": 5301385,
          "total_deletions": 4813706,
          "weeks_active": 411
        }
      },
      "commit_message": {
        "title": "Security/API (beta) improvements",
        "length": 32,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 196,
        "additions": 112,
        "deletions": 84
      },
      "files": [
        {
          "filename": "admin.php",
          "status": "modified",
          "additions": 0,
          "deletions": 2,
          "patch": "@@ -42,8 +42,6 @@\n             <h3>Some instructions</h3>\n             <span class=\"ui-icon ui-icon-wrench\" style=\"float: left; margin-right: .3em;\">&nbsp;</span>\n                 Access to <a target=\"_blank\" href=\"http://www.teampass.net\" style=\"font-weight:bold;font-style:italic;\">TeamPass website</a><br />\n-            <span class=\"ui-icon ui-icon-wrench\" style=\"float: left; margin-right: .3em;\">&nbsp;</span>\n-                For any kind of Help and Support, please use the <a target=\"_blank\" href=\"http://www.teampass.net/forum\" style=\"font-weight:bold;font-style:italic;\">Forum</a><br />\n             <span class=\"ui-icon ui-icon-wrench\" style=\"float: left; margin-right: .3em;\">&nbsp;</span>\n                 You discovered a Bug or you have an improvement Proposal, please use the <a target=\"_blank\" href=\"https://github.com/nilsteampassnet/TeamPass/issues\" style=\"font-weight:bold;font-style:italic;\">Github channel</a>. <i>If you are not sure, always use the Forum before to obtain a confirmation. This will prevent having to much open tickets at Github</i>.<br />\n             <div style=\"text-align:center;margin-top:10px;\">"
        },
        {
          "filename": "admin.settings_api.php",
          "status": "modified",
          "additions": 2,
          "deletions": 1,
          "patch": "@@ -230,7 +230,7 @@ function newIPDB()\n \n function ip_update(id, value, ip)\n {\n-    $(\"#api_db_type\").val(\"admin_action_api_save_key\");\n+    $(\"#api_db_type\").val(\"admin_action_api_save_ip\");\n     $(\"#api_db_id\").val(id);\n     $(\"#api_db_action\").val(\"update\");\n     $(\"#div_key\").show();\n@@ -261,6 +261,7 @@ function ip_update(id, value, ip)\n \t\t\t\t\t$(\"#api_db_message\").html(\"'.$txt['error_too_long'].'\");\n \t\t\t\t\texit;\n \t\t\t\t}\n+\n                 $(\"#div_loading\").show();\n                 var $this = $(this);\n             \t// send query"
        },
        {
          "filename": "api/config.php",
          "status": "removed",
          "additions": 0,
          "deletions": 9,
          "patch": "@@ -1,9 +0,0 @@\n-<?php\n-\n-// Set Teampass path\n-$teampass_path = \"E:/xampp/htdocs/Teampass\";\n-// Set Teampass config file\n-$teampass_config_file = $teampass_path.\"/includes/settings.php\";\n-// Set Teampass secure keys file path\n-$teampass_sk_file = \"/space/private/teampass/sk.php\";\n-?>"
        },
        {
          "filename": "api/functions.php",
          "status": "modified",
          "additions": 23,
          "deletions": 27,
          "patch": "@@ -1,4 +1,19 @@\n <?php\n+/**\n+ *\n+ * @file          configapi.php\n+ * @author        Nils Laumaill\u00e9\n+ * @version       2.1.20\n+ * @copyright     (c) 2009-2014 Nils Laumaill\u00e9\n+ * @licensing     GNU AFFERO GPL 3.0\n+ * @link\t\t  http://www.teampass.net\n+ *\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n+ */\n+\n+$teampass_config_file = \"../includes/settings.php\";\n \n function teampass_api_enabled() {\n \t$bdd = teampass_connect();\n@@ -9,7 +24,7 @@ function teampass_api_enabled() {\n function teampass_whitelist() {\n     $bdd = teampass_connect();\n \t$apiip_pool = teampass_get_ips();\n-\tif (count($apiip_pool) > 0 && !array_search($_SERVER['REMOTE_ADDR'], $apiip_pool)) {\n+\tif (count($apiip_pool) > 0 && array_search($_SERVER['REMOTE_ADDR'], $apiip_pool) === false) {\n \t\trest_error('IPWHITELIST');\n \t}\n }\n@@ -169,36 +184,19 @@ function rest_get () {\n \n \t\tif ($GLOBALS['request'][0] == \"read\") {\n \t\t\tif($GLOBALS['request'][1] == \"category\") {\n-\t\t\t\t$array_category = explode(';',$GLOBALS['request'][2]);\n-\n-\t\t\t\tforeach($array_category as $category) {\n-\t\t\t\t\tif(!preg_match_all(\"/^([\\w\\:\\'\\-\\s\u00e0\u00e1\u00e2\u00e3\u00e4\u00e5\u00e7\u00e8\u00e9\u00ea\u00eb\u00ec\u00ed\u00ee\u00ef\u00f0\u00f2\u00f3\u00f4\u00f5\u00f6\u00f9\u00fa\u00fb\u00fc\u00fd\u00ff]+)$/i\", $category,$result)) {\n-\t\t\t\t\t\trest_error('CATEGORY_MALFORMED');\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\n-\t\t\t\tif(count($array_category) > 1 && count($array_category) < 5) {\n-\t\t\t\t\tfor ($i = count($array_category); $i > 0; $i--) {\n-\t\t\t\t\t\t$slot = $i - 1;\n-\t\t\t\t\t\tif (!$slot) {\n-\t\t\t\t\t\t\t$category_query .= \"select id from \".$GLOBALS['pre'].\"nested_tree where title LIKE '\".$array_category[$slot].\"' AND parent_id = 0\";\n-\t\t\t\t\t\t} else {\n-\t\t\t\t\t\t\t$category_query .= \"select id from \".$GLOBALS['pre'].\"nested_tree where title LIKE '\".$array_category[$slot].\"' AND parent_id = (\";\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\t\t\t\t\tfor ($i = 1; $i < count($array_category); $i++) { $category_query .= \")\"; }\n-\t\t\t\t} elseif (count($array_category) == 1) {\n-\t\t\t\t\t$category_query = \"select id from \".$GLOBALS['pre'].\"nested_tree where title LIKE '\".$array_category[0].\"' AND parent_id = 0\";\n+\t\t\t\t// get ids\n+\t\t\t\tif (strpos($GLOBALS['request'][2],\",\") > 0) {\n+\t\t\t\t\t$condition = \"id_tree IN (\".$GLOBALS['request'][2].\")\";\n \t\t\t\t} else {\n-\t\t\t\t\trest_error ('NO_CATEGORY');\n+\t\t\t\t\t$condition = \"id_tree = '\".$GLOBALS['request'][2].\"'\";\n \t\t\t\t}\n-\t\t\t\t$response = $bdd->query(\"select id,label,login,pw from \".$GLOBALS['pre'].\"items where id_tree = (\".$category_query.\")\");\n+\t\t\t\t$response = $bdd->query(\"select id,label,login,pw from \".$GLOBALS['pre'].\"items where \".$condition);\n \t\t\t\twhile ($data = $response->fetch())\n \t\t\t\t{\n \t\t\t\t\t$id = $data['id'];\n \t\t\t\t\t$json[$id]['label'] = utf8_encode($data['label']);\n \t\t\t\t\t$json[$id]['login'] = utf8_encode($data['login']);\n-//\t\t\t\t\t$json[$id]['pw'] = teampass_decrypt_pw($data['pw'],SALT,$rand_key);\n+\t\t\t\t\t$json[$id]['pw'] = teampass_decrypt_pw($data['pw'],SALT,$rand_key);\n \t\t\t\t}\n \t\t\t} elseif($GLOBALS['request'][1] == \"item\") {\n \t\t\t\t$array_category = explode(';',$GLOBALS['request'][2]);\n@@ -325,6 +323,4 @@ function teampass_decrypt_pw($encrypted, $salt, $rand_key, $itcount = 2072)\n     $encrypted = substr($encrypted, 0, -64);\n     if ($mac !== hash_hmac('sha256', $encrypted, $salt)) return null;\n     return substr(rtrim(mcrypt_decrypt(MCRYPT_RIJNDAEL_256, $key, $encrypted, 'ctr', $iv), \"\\0\\4\"), strlen($rand_key));\n-}\n-\n-?>\n+}\n\\ No newline at end of file"
        },
        {
          "filename": "api/index.php",
          "status": "modified",
          "additions": 14,
          "deletions": 1,
          "patch": "@@ -1,6 +1,19 @@\n <?php\n+/**\n+ *\n+ * @file          indexapi.php\n+ * @author        Nils Laumaill\ufffd\n+ * @version       2.1.20\n+ * @copyright     (c) 2009-2014 Nils Laumaill\ufffd\n+ * @licensing     GNU AFFERO GPL 3.0\n+ * @link\t\t  http://www.teampass.net\n+ *\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n+ */\n \n-require_once('config.php');\n+//require_once('config.php');\n require_once('functions.php');\n \n header('Content-Type: application/json');"
        },
        {
          "filename": "includes/include.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -39,4 +39,4 @@\n     'manage_views' => 'views.php',\n     'manage_main' => 'admin.php',\n     'manage_settings' => 'admin.settings.php'\n-);\n+);\n\\ No newline at end of file"
        },
        {
          "filename": "items.load.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -2617,6 +2617,7 @@ function prepareOneTimeView()\n         function(data) {\n             //check if format error\n             if (data[0].error == \"\") {\n+\t\t\t\t$(\"#div_dialog_message\").dialog({minHeight:500,minWidth:750});\n                 $(\"#div_dialog_message\").dialog('open');\n                 $(\"#div_dialog_message_text\").html(data[0].url);\n             } else {"
        },
        {
          "filename": "items.php",
          "status": "modified",
          "additions": 9,
          "deletions": 9,
          "patch": "@@ -96,13 +96,13 @@\n <input type=\"hidden\" id=\"pf_selected\" />';\n // Hidden objects for Item search\n if (isset($_GET['group']) && isset($_GET['id'])) {\n-    echo '<input type=\"hidden\" name=\"open_folder\" id=\"open_folder\" value=\"'.$_GET['group'].'\" />';\n-    echo '<input type=\"hidden\" name=\"open_id\" id=\"open_id\" value=\"'.$_GET['id'].'\" />';\n-    echo '<input type=\"hidden\" name=\"recherche_group_pf\" id=\"recherche_group_pf\" value=\"', in_array($_GET['group'], $_SESSION['personal_visible_groups']) ? '1' : '', '\" />';\n+    echo '<input type=\"hidden\" name=\"open_folder\" id=\"open_folder\" value=\"'.htmlspecialchars($_GET['group']).'\" />';\n+    echo '<input type=\"hidden\" name=\"open_id\" id=\"open_id\" value=\"'.htmlspecialchars($_GET['id']).'\" />';\n+    echo '<input type=\"hidden\" name=\"recherche_group_pf\" id=\"recherche_group_pf\" value=\"', in_array(htmlspecialchars($_GET['group']), $_SESSION['personal_visible_groups']) ? '1' : '', '\" />';\n } elseif (isset($_GET['group']) && !isset($_GET['id'])) {\n-    echo '<input type=\"hidden\" name=\"open_folder\" id=\"open_folder\" value=\"'.$_GET['group'].'\" />';\n+    echo '<input type=\"hidden\" name=\"open_folder\" id=\"open_folder\" value=\"'.htmlspecialchars($_GET['group']).'\" />';\n     echo '<input type=\"hidden\" name=\"open_id\" id=\"open_id\" value=\"\" />';\n-    echo '<input type=\"hidden\" name=\"recherche_group_pf\" id=\"recherche_group_pf\" value=\"', in_array($_GET['group'], $_SESSION['personal_visible_groups']) ? '1' : '', '\" />';\n+    echo '<input type=\"hidden\" name=\"recherche_group_pf\" id=\"recherche_group_pf\" value=\"', in_array(htmlspecialchars($_GET['group']), $_SESSION['personal_visible_groups']) ? '1' : '', '\" />';\n } else {\n     echo '<input type=\"hidden\" name=\"open_folder\" id=\"open_folder\" value=\"\" />';\n     echo '<input type=\"hidden\" name=\"open_id\" id=\"open_id\" value=\"\" />';\n@@ -230,7 +230,7 @@\n         \t}\n             // Prepare folder\n             $folderTxt = '\n-                    <li class=\"jstreeopen\" id=\"li_'.$folder->id.'\">';\n+                    <li class=\"jstreeopen\" id=\"li_'.$folder->id.'\" title=\"ID ['.$folder->id.']\">';\n             if (in_array($folder->id, $_SESSION['groupes_visibles'])) {\n                 $folderTxt .= '\n                             <a id=\"fld_'.$folder->id.'\" class=\"folder\" onclick=\"ListerItems(\\''.$folder->id.'\\', \\'\\', 0);\">'.$fldTitle.' (<span class=\"items_count\" id=\"itcount_'.$folder->id.'\">'.$itemsNb.'</span>';\n@@ -358,7 +358,7 @@\n                 <tr>\n                     <td valign=\"top\" class=\"td_title\"><span class=\"ui-icon ui-icon-carat-1-e\" style=\"float: left; margin-right: .3em;\">&nbsp;</span>'.$txt['label'].' :</td>\n                     <td>\n-                        <input type=\"hidden\" id=\"hid_label\" value=\"', isset($dataItem) ? $dataItem['label'] : '', '\" />\n+                        <input type=\"hidden\" id=\"hid_label\" value=\"', isset($dataItem) ? htmlspecialchars($dataItem['label']) : '', '\" />\n                         <div id=\"id_label\" style=\"display:inline;\"></div>\n                     </td>\n                 </tr>';\n@@ -367,7 +367,7 @@\n                 <tr>\n                     <td valign=\"top\" class=\"td_title\"><span class=\"ui-icon ui-icon-carat-1-e\" style=\"float: left; margin-right: .3em;\">&nbsp;</span>'.$txt['description'].' :</td>\n                     <td>\n-                        <div id=\"id_desc\" style=\"font-style:italic;display:inline;\"></div><input type=\"hidden\" id=\"hid_desc\" value=\"', isset($dataItem) ? $dataItem['description'] : '', '\" />\n+                        <div id=\"id_desc\" style=\"font-style:italic;display:inline;\"></div><input type=\"hidden\" id=\"hid_desc\" value=\"', isset($dataItem) ? htmlspecialchars($dataItem['description']) : '', '\" />\n                     </td>\n                 </tr>';\n // Line for PW\n@@ -455,7 +455,7 @@\n                     <tr class=\"tr_fields itemCatName_'.$itemCatName.'\">\n                         <td valign=\"top\" class=\"td_title\">&nbsp;&nbsp;<span class=\"ui-icon ui-icon-carat-1-e\" style=\"float: left; margin: 0 .3em 0 15px; font-size:9px;\">&nbsp;</span><i>'.$field[1].'</i> :</td>\n                         <td>\n-                            <div id=\"id_field_'.$field[0].'\" style=\"display:inline;\" class=\"fields_div\"></div><input type=\"hidden\" id=\"hid_field_'.$field[0].'\" class=\"fields\" />\n+                            <div id=\"id_field_'.$field[0].'\" style=\"display:inline;\" class=\"fields_div\"></div><input type=\"hidden\" id=\"hid_field_'.htmlspecialchars($field[0]).'\" class=\"fields\" />\n                         </td>\n                     </tr>';\n         }"
        },
        {
          "filename": "otv.php",
          "status": "modified",
          "additions": 7,
          "deletions": 0,
          "patch": "@@ -70,6 +70,13 @@\n \n             // get data\n             $pw = decrypt($dataItem['pw']);\n+\n+        \t// get key for original pw\n+        \t$originalKey = $db->queryFirst('SELECT rand_key FROM `'.$pre.'keys` WHERE `table` LIKE \"items\" AND `id` ='.intval($_GET['item_id']));\n+        \t// unsalt previous pw\n+        \t$pw = substr(decrypt($dataItem['pw']), strlen($originalKey['rand_key']));\n+\n+\n             $label = $dataItem['label'];\n             $email = $dataItem['email'];\n             $url = $dataItem['url'];"
        },
        {
          "filename": "sources/admin.queries.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -919,6 +919,7 @@\n \t\t\t\t'api',\n \t\t\t\tarray(\n \t\t\t\t    'label'     => $_POST['label'],\n+\t\t\t\t\t'value'     => $_POST['key'],\n \t\t\t\t    'timestamp' => time()\n \t\t\t\t),\n \t\t\t\t\"id='\".intval($_POST['id']).\"'\""
        },
        {
          "filename": "sources/datatable/datatable.item_edition.php",
          "status": "modified",
          "additions": 15,
          "deletions": 3,
          "patch": "@@ -31,6 +31,7 @@\n \n //Columns name\n $aColumns = array('e.timestamp', 'u.login', 'i.label', 'u.name', 'u.lastname');\n+$aSortTypes = array('ASC', 'DESC');\n \n //init SQL variables\n $sOrder = $sLimit = $sWhere = \"\";\n@@ -39,19 +40,30 @@\n //Paging\n $sLimit = \"\";\n if (isset($_GET['iDisplayStart']) && $_GET['iDisplayLength'] != '-1') {\n-    $sLimit = \"LIMIT \". $_GET['iDisplayStart'] .\", \". $_GET['iDisplayLength'] ;\n+    $sLimit = \"LIMIT \". filter_var($_GET['iDisplayStart'], FILTER_SANITIZE_NUMBER_INT) .\", \". filter_var($_GET['iDisplayLength'], FILTER_SANITIZE_NUMBER_INT).\"\";\n }\n \n //Ordering\n \n-if (isset($_GET['iSortCol_0'])) {\n+if (isset($_GET['iSortCol_0']) && in_array($_GET['iSortCol_0'], $aSortTypes)) {\n     $sOrder = \"ORDER BY  \";\n-    for ($i=0; $i<intval($_GET['iSortingCols']); $i++) {\n+/*\n+for ($i=0; $i<intval($_GET['iSortingCols']); $i++) {\n         if ($_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == \"true\") {\n             $sOrder .= $aColumns[ intval(mysql_real_escape_string($_GET['iSortCol_'.$i])) ].\"\n             \".mysql_real_escape_string($_GET['sSortDir_'.$i]) .\", \";\n         }\n     }\n+*/\n+\tfor ($i=0; $i<intval($_GET['iSortingCols']); $i++) {\n+\t\tif (\n+\t\t\t$_GET[ 'bSortable_'.filter_var($_GET['iSortCol_'.$i], FILTER_SANITIZE_NUMBER_INT)] == \"true\" &&\n+\t\t\tpreg_match(\"#^(asc|desc)\\$#i\", $_GET['sSortDir_'.$i])\n+\t\t) {\n+\t\t\t$sOrder .= \"\".$aColumns[ filter_var($_GET['iSortCol_'.$i], FILTER_SANITIZE_NUMBER_INT) ].\" \"\n+\t\t\t.mysql_real_escape_string($_GET['sSortDir_'.$i]) .\", \";\n+\t\t}\n+\t}\n \n     $sOrder = substr_replace($sOrder, \"\", -2);\n     if ($sOrder == \"ORDER BY\") {"
        },
        {
          "filename": "sources/datatable/datatable.kb.php",
          "status": "modified",
          "additions": 12,
          "deletions": 9,
          "patch": "@@ -31,6 +31,7 @@\n \n //Columns name\n $aColumns = array('id', 'category_id', 'label', 'description', 'author_id');\n+$aSortTypes = array('ASC', 'DESC');\n \n //init SQL variables\n $sWhere = $sOrder = $sLimit = \"\";\n@@ -39,20 +40,22 @@\n //Paging\n $sLimit = \"\";\n if (isset($_GET['iDisplayStart']) && $_GET['iDisplayLength'] != '-1') {\n-    $sLimit = \"LIMIT \". mysql_real_escape_string($_GET['iDisplayStart']) .\", \"\n-            . mysql_real_escape_string($_GET['iDisplayLength']) ;\n+    $sLimit = \"LIMIT \". filter_var($_GET['iDisplayStart'], FILTER_SANITIZE_NUMBER_INT) .\", \". filter_var($_GET['iDisplayLength'], FILTER_SANITIZE_NUMBER_INT).\"\";\n }\n \n //Ordering\n \n-if (isset($_GET['iSortCol_0'])) {\n+if (isset($_GET['iSortCol_0']) && in_array($_GET['iSortCol_0'], $aSortTypes)) {\n     $sOrder = \"ORDER BY  \";\n-    for ($i=0; $i<intval($_GET['iSortingCols']); $i++) {\n-        if ($_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == \"true\") {\n-            $sOrder .= $aColumns[ intval(mysql_real_escape_string($_GET['iSortCol_'.$i])) ].\"\n-                    \".mysql_real_escape_string($_GET['sSortDir_'.$i]) .\", \";\n-        }\n-    }\n+\tfor ($i=0; $i<intval($_GET['iSortingCols']); $i++) {\n+\t\tif (\n+\t\t\t$_GET[ 'bSortable_'.filter_var($_GET['iSortCol_'.$i], FILTER_SANITIZE_NUMBER_INT)] == \"true\" &&\n+\t\t\tpreg_match(\"#^(asc|desc)\\$#i\", $_GET['sSortDir_'.$i])\n+\t\t) {\n+\t\t\t$sOrder .= \"\".$aColumns[ filter_var($_GET['iSortCol_'.$i], FILTER_SANITIZE_NUMBER_INT) ].\" \"\n+\t\t\t.mysql_real_escape_string($_GET['sSortDir_'.$i]) .\", \";\n+\t\t}\n+\t}\n \n     $sOrder = substr_replace($sOrder, \"\", -2);\n     if ($sOrder == \"ORDER BY\") {"
        },
        {
          "filename": "sources/datatable/datatable.logs.php",
          "status": "modified",
          "additions": 12,
          "deletions": 9,
          "patch": "@@ -33,6 +33,7 @@\n if (isset($_GET['action']) && $_GET['action'] == \"connections\") {\n     //Columns name\n     $aColumns = array('l.date', 'l.label', 'l.qui', 'u.login');\n+\t$aSortTypes = array('ASC', 'DESC');\n \n     //init SQL variables\n     $sWhere = $sOrder = $sLimit = \"\";\n@@ -41,20 +42,22 @@\n     //Paging\n     $sLimit = \"\";\n     if (isset($_GET['iDisplayStart']) && $_GET['iDisplayLength'] != '-1') {\n-        $sLimit = \"LIMIT \". mysql_real_escape_string($_GET['iDisplayStart']) .\", \"\n-                . mysql_real_escape_string($_GET['iDisplayLength']) ;\n+        $sLimit = \"LIMIT \". filter_var($_GET['iDisplayStart'], FILTER_SANITIZE_NUMBER_INT) .\", \". filter_var($_GET['iDisplayLength'], FILTER_SANITIZE_NUMBER_INT).\"\";\n     }\n \n     //Ordering\n \n-    if (isset($_GET['iSortCol_0'])) {\n+    if (isset($_GET['iSortCol_0']) && in_array($_GET['iSortCol_0'], $aSortTypes)) {\n         $sOrder = \"ORDER BY  \";\n-        for ($i=0; $i<intval($_GET['iSortingCols']); $i++) {\n-            if ($_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == \"true\") {\n-                $sOrder .= $aColumns[ intval(mysql_real_escape_string($_GET['iSortCol_'.$i])) ].\"\n-                    \".mysql_real_escape_string($_GET['sSortDir_'.$i]) .\", \";\n-            }\n-        }\n+    \tfor ($i=0; $i<intval($_GET['iSortingCols']); $i++) {\n+    \t\tif (\n+    \t\t\t$_GET[ 'bSortable_'.filter_var($_GET['iSortCol_'.$i], FILTER_SANITIZE_NUMBER_INT)] == \"true\" &&\n+    \t\t\tpreg_match(\"#^(asc|desc)\\$#i\", $_GET['sSortDir_'.$i])\n+    \t\t) {\n+    \t\t\t$sOrder .= \"\".$aColumns[ filter_var($_GET['iSortCol_'.$i], FILTER_SANITIZE_NUMBER_INT) ].\" \"\n+    \t\t\t.mysql_real_escape_string($_GET['sSortDir_'.$i]) .\", \";\n+    \t\t}\n+    \t}\n \n         $sOrder = substr_replace($sOrder, \"\", -2);\n         if ($sOrder == \"ORDER BY\") {"
        },
        {
          "filename": "sources/datatable/datatable.users_logged.php",
          "status": "modified",
          "additions": 12,
          "deletions": 9,
          "patch": "@@ -33,6 +33,7 @@\n \n //Columns name\n $aColumns = array('login', 'name', 'lastname', 'timestamp', 'last_connexion');\n+$aSortTypes = array('ASC', 'DESC');\n \n //init SQL variables\n $sOrder = $sLimit = \"\";\n@@ -41,20 +42,22 @@\n //Paging\n $sLimit = \"\";\n if (isset($_GET['iDisplayStart']) && $_GET['iDisplayLength'] != '-1') {\n-    $sLimit = \"LIMIT \". mysql_real_escape_string($_GET['iDisplayStart']) .\", \"\n-            . mysql_real_escape_string($_GET['iDisplayLength']);\n+    $sLimit = \"LIMIT \". filter_var($_GET['iDisplayStart'], FILTER_SANITIZE_NUMBER_INT) .\", \". filter_var($_GET['iDisplayLength'], FILTER_SANITIZE_NUMBER_INT).\"\";\n }\n \n //Ordering\n \n-if (isset($_GET['iSortCol_0'])) {\n+if (isset($_GET['iSortCol_0']) && in_array($_GET['iSortCol_0'], $aSortTypes)) {\n     $sOrder = \"ORDER BY  \";\n-    for ($i=0; $i<intval($_GET['iSortingCols']); $i++) {\n-        if ($_GET[ 'bSortable_'.intval($_GET['iSortCol_'.$i]) ] == \"true\") {\n-            $sOrder .= $aColumns[ intval(mysql_real_escape_string($_GET['iSortCol_'.$i])) ].\"\n-            \".mysql_real_escape_string($_GET['sSortDir_'.$i]) .\", \";\n-        }\n-    }\n+\tfor ($i=0; $i<intval($_GET['iSortingCols']); $i++) {\n+\t\tif (\n+\t\t\t$_GET[ 'bSortable_'.filter_var($_GET['iSortCol_'.$i], FILTER_SANITIZE_NUMBER_INT)] == \"true\" &&\n+\t\t\tpreg_match(\"#^(asc|desc)\\$#i\", $_GET['sSortDir_'.$i])\n+\t\t) {\n+\t\t\t$sOrder .= \"\".$aColumns[ filter_var($_GET['iSortCol_'.$i], FILTER_SANITIZE_NUMBER_INT) ].\" \"\n+\t\t\t.mysql_real_escape_string($_GET['sSortDir_'.$i]) .\", \";\n+\t\t}\n+\t}\n \n     $sOrder = substr_replace($sOrder, \"\", -2);\n     if ($sOrder == \"ORDER BY\") {"
        },
        {
          "filename": "sources/find.queries.php",
          "status": "modified",
          "additions": 0,
          "deletions": 1,
          "patch": "@@ -84,7 +84,6 @@\n if (isset($_GET['iSortCol_0']) && in_array($_GET['iSortCol_0'], $aSortTypes)) {\n     $sOrder = \"ORDER BY  \";\n     for ($i=0; $i<intval($_GET['iSortingCols']); $i++) {\n-\n         if (\n             $_GET[ 'bSortable_'.filter_var($_GET['iSortCol_'.$i], FILTER_SANITIZE_NUMBER_INT)] == \"true\" &&\n             preg_match(\"#^(asc|desc)\\$#i\", $_GET['sSortDir_'.$i])"
        },
        {
          "filename": "sources/items.queries.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -1249,7 +1249,7 @@\n                     $arrData['link'] = \"&nbsp;<a href='\".$dataItem['url'].\"' target='_blank'><img src='includes/images/arrow_skip.png' style='border:0px;' title='\".$txt['open_url_link'].\"'></a>\";\n                 }\n \n-                $arrData['description'] = preg_replace('/(?<!\\\\r)\\\\n+(?!\\\\r)/', '', strip_tags($dataItem['description'], $allowedTags));\n+                $arrData['description'] = preg_replace('/(?<!\\\\r)\\\\n+(?!\\\\r)/', '', strip_tags($dataItem['description'], $k['allowedTags']));\n                 $arrData['login'] = str_replace('\"', '&quot;', $dataItem['login']);\n                 $arrData['id_restricted_to'] = $listeRestriction;\n                 $arrData['id_restricted_to_roles'] = count($listRestrictionRoles) > 0 ? implode(\";\", $listRestrictionRoles).\";\" : \"\";"
        },
        {
          "filename": "sources/users.queries.php",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -373,8 +373,8 @@\n                     'type' => 'user_mngt',\n                     'date' => time(),\n                     'label' => 'at_user_email_changed:'.$data[0],\n-                    'qui' => $_SESSION['user_id'],\n-                    'field_1' => $_POST['id']\n+                    'qui' => intval($_SESSION['user_id']),\n+                    'field_1' => intval($_POST['id'])\n                    )\n             );\n         \techo '[{\"error\" : \"no\"}]';"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 2,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 5,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "aacdf6a3f2daf9b52a826d4b3d8a39873e2e2062",
            "date": "2025-01-13T17:24:23Z",
            "author_login": "nilsteampassnet"
          },
          {
            "sha": "eb95bc3e37f6e1f19fce98aa4c44c251f2084cd7",
            "date": "2025-01-13T17:20:31Z",
            "author_login": "nilsteampassnet"
          },
          {
            "sha": "9969d0ef636e28c1afcdb047aac2d2a5387b62b5",
            "date": "2025-01-12T17:29:37Z",
            "author_login": "nilsteampassnet"
          },
          {
            "sha": "4963736272bc4b281586f8ad4dcee70015d595b1",
            "date": "2025-01-12T17:22:24Z",
            "author_login": "nilsteampassnet"
          },
          {
            "sha": "b5a997952a43e4760c9eaceedfd9a7ba4a5683d2",
            "date": "2025-01-10T16:06:22Z",
            "author_login": "nilsteampassnet"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": null,
    "cvss_vector": null,
    "cwe_id": "CWE-79",
    "description": "Multiple cross-site scripting (XSS) vulnerabilities in items.php in TeamPass before 2.1.20 allow remote attackers to inject arbitrary web script or HTML via the group parameter, which is not properly handled in a (1) hid_cat or (2) open_folder form element, or (3) id parameter, which is not properly handled in the open_id form element.",
    "attack_vector": null,
    "attack_complexity": null
  },
  "temporal_data": {
    "published_date": "2014-08-07T11:13:35.267",
    "last_modified": "2024-11-21T02:08:48.330",
    "fix_date": "2014-05-03T06:06:26Z"
  },
  "references": [
    {
      "url": "http://teampass.net/installation/2.1.20-released.html",
      "source": "cve@mitre.org",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2014/05/18/2",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2014/05/19/5",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "https://github.com/nilsteampassnet/TeamPass/commit/8820c8934d9ba0508ac345e73ad0be29049ec6de",
      "source": "cve@mitre.org",
      "tags": [
        "Exploit",
        "Patch"
      ]
    },
    {
      "url": "https://github.com/nilsteampassnet/TeamPass/commit/fd549b245c0f639a8d47bf4f74f92c37c053706f",
      "source": "cve@mitre.org",
      "tags": [
        "Exploit",
        "Patch"
      ]
    },
    {
      "url": "http://teampass.net/installation/2.1.20-released.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2014/05/18/2",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2014/05/19/5",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://github.com/nilsteampassnet/TeamPass/commit/8820c8934d9ba0508ac345e73ad0be29049ec6de",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Patch"
      ]
    },
    {
      "url": "https://github.com/nilsteampassnet/TeamPass/commit/fd549b245c0f639a8d47bf4f74f92c37c053706f",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Patch"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T22:58:25.519951",
    "processing_status": "enhanced"
  }
}