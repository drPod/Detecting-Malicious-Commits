{
  "cve_id": "CVE-2015-1334",
  "github_data": {
    "repository": "lxc/lxc",
    "fix_commit": "5c3fcae78b63ac9dd56e36075903921bd9461f9e",
    "related_commits": [
      "5c3fcae78b63ac9dd56e36075903921bd9461f9e",
      "5c3fcae78b63ac9dd56e36075903921bd9461f9e"
    ],
    "patch_url": "https://github.com/lxc/lxc/commit/5c3fcae78b63ac9dd56e36075903921bd9461f9e.patch",
    "fix_commit_details": {
      "sha": "5c3fcae78b63ac9dd56e36075903921bd9461f9e",
      "commit_date": "2015-07-16T20:37:51Z",
      "author": {
        "login": "stgraber",
        "type": "User",
        "stats": {
          "total_commits": 2019,
          "average_weekly_commits": 2.441354292623942,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 450
        }
      },
      "commit_message": {
        "title": "CVE-2015-1334: Don't use the container's /proc during attach",
        "length": 361,
        "has_description": true,
        "references_issue": false
      },
      "stats": {
        "total": 106,
        "additions": 93,
        "deletions": 13
      },
      "files": [
        {
          "filename": "src/lxc/attach.c",
          "status": "modified",
          "additions": 93,
          "deletions": 13,
          "patch": "@@ -76,6 +76,82 @@\n \n lxc_log_define(lxc_attach, lxc);\n \n+int lsm_set_label_at(int procfd, int on_exec, char* lsm_label) {\n+\tint labelfd = -1;\n+\tint ret = 0;\n+\tconst char* name;\n+\tchar* command = NULL;\n+\n+\tname = lsm_name();\n+\n+\tif (strcmp(name, \"nop\") == 0)\n+\t\tgoto out;\n+\n+\tif (strcmp(name, \"none\") == 0)\n+\t\tgoto out;\n+\n+\t/* We don't support on-exec with AppArmor */\n+\tif (strcmp(name, \"AppArmor\") == 0)\n+\t\ton_exec = 0;\n+\n+\tif (on_exec) {\n+\t\tlabelfd = openat(procfd, \"self/attr/exec\", O_RDWR);\n+\t}\n+\telse {\n+\t\tlabelfd = openat(procfd, \"self/attr/current\", O_RDWR);\n+\t}\n+\n+\tif (labelfd < 0) {\n+\t\tSYSERROR(\"Unable to open LSM label\");\n+\t\tret = -1;\n+\t\tgoto out;\n+\t}\n+\n+\tif (strcmp(name, \"AppArmor\") == 0) {\n+\t\tint size;\n+\n+\t\tcommand = malloc(strlen(lsm_label) + strlen(\"changeprofile \") + 1);\n+\t\tif (!command) {\n+\t\t\tSYSERROR(\"Failed to write apparmor profile\");\n+\t\t\tret = -1;\n+\t\t\tgoto out;\n+\t\t}\n+\n+\t\tsize = sprintf(command, \"changeprofile %s\", lsm_label);\n+\t\tif (size < 0) {\n+\t\t\tSYSERROR(\"Failed to write apparmor profile\");\n+\t\t\tret = -1;\n+\t\t\tgoto out;\n+\t\t}\n+\n+\t\tif (write(labelfd, command, size + 1) < 0) {\n+\t\t\tSYSERROR(\"Unable to set LSM label\");\n+\t\t\tret = -1;\n+\t\t\tgoto out;\n+\t\t}\n+\t}\n+\telse if (strcmp(name, \"SELinux\") == 0) {\n+\t\tif (write(labelfd, lsm_label, strlen(lsm_label) + 1) < 0) {\n+\t\t\tSYSERROR(\"Unable to set LSM label\");\n+\t\t\tret = -1;\n+\t\t\tgoto out;\n+\t\t}\n+\t}\n+\telse {\n+\t\tERROR(\"Unable to restore label for unknown LSM: %s\", name);\n+\t\tret = -1;\n+\t\tgoto out;\n+\t}\n+\n+out:\n+\tfree(command);\n+\n+\tif (labelfd != -1)\n+\t\tclose(labelfd);\n+\n+\treturn ret;\n+}\n+\n static struct lxc_proc_context_info *lxc_proc_get_context_info(pid_t pid)\n {\n \tstruct lxc_proc_context_info *info = calloc(1, sizeof(*info));\n@@ -570,6 +646,7 @@ struct attach_clone_payload {\n \tstruct lxc_proc_context_info* init_ctx;\n \tlxc_attach_exec_t exec_function;\n \tvoid* exec_payload;\n+\tint procfd;\n };\n \n static int attach_child_main(void* data);\n@@ -622,6 +699,7 @@ int lxc_attach(const char* name, const char* lxcpath, lxc_attach_exec_t exec_fun\n \tchar* cwd;\n \tchar* new_cwd;\n \tint ipc_sockets[2];\n+\tint procfd;\n \tsigned long personality;\n \n \tif (!options)\n@@ -833,6 +911,13 @@ int lxc_attach(const char* name, const char* lxcpath, lxc_attach_exec_t exec_fun\n \t\trexit(-1);\n \t}\n \n+\tprocfd = open(\"/proc\", O_DIRECTORY | O_RDONLY);\n+\tif (procfd < 0) {\n+\t\tSYSERROR(\"Unable to open /proc\");\n+\t\tshutdown(ipc_sockets[1], SHUT_RDWR);\n+\t\trexit(-1);\n+\t}\n+\n \t/* attach now, create another subprocess later, since pid namespaces\n \t * only really affect the children of the current process\n \t */\n@@ -860,7 +945,8 @@ int lxc_attach(const char* name, const char* lxcpath, lxc_attach_exec_t exec_fun\n \t\t\t.options = options,\n \t\t\t.init_ctx = init_ctx,\n \t\t\t.exec_function = exec_function,\n-\t\t\t.exec_payload = exec_payload\n+\t\t\t.exec_payload = exec_payload,\n+\t\t\t.procfd = procfd\n \t\t};\n \t\t/* We use clone_parent here to make this subprocess a direct child of\n \t\t * the initial process. Then this intermediate process can exit and\n@@ -898,6 +984,7 @@ static int attach_child_main(void* data)\n {\n \tstruct attach_clone_payload* payload = (struct attach_clone_payload*)data;\n \tint ipc_socket = payload->ipc_socket;\n+\tint procfd = payload->procfd;\n \tlxc_attach_options_t* options = payload->options;\n \tstruct lxc_proc_context_info* init_ctx = payload->init_ctx;\n #if HAVE_SYS_PERSONALITY_H\n@@ -1038,21 +1125,11 @@ static int attach_child_main(void* data)\n \tclose(ipc_socket);\n \n \t/* set new apparmor profile/selinux context */\n-\tif ((options->namespaces & CLONE_NEWNS) && (options->attach_flags & LXC_ATTACH_LSM)) {\n+\tif ((options->namespaces & CLONE_NEWNS) && (options->attach_flags & LXC_ATTACH_LSM) && init_ctx->lsm_label) {\n \t\tint on_exec;\n-\t\tint proc_mounted;\n \n \t\ton_exec = options->attach_flags & LXC_ATTACH_LSM_EXEC ? 1 : 0;\n-\t\tproc_mounted = mount_proc_if_needed(\"/\");\n-\t\tif (proc_mounted == -1) {\n-\t\t\tERROR(\"Error mounting a sane /proc\");\n-\t\t\trexit(-1);\n-\t\t}\n-\t\tret = lsm_process_label_set(init_ctx->lsm_label,\n-\t\t\t\tinit_ctx->container->lxc_conf, 0, on_exec);\n-\t\tif (proc_mounted)\n-\t\t\tumount(\"/proc\");\n-\t\tif (ret < 0) {\n+\t\tif (lsm_set_label_at(procfd, on_exec, init_ctx->lsm_label) < 0) {\n \t\t\trexit(-1);\n \t\t}\n \t}\n@@ -1103,6 +1180,9 @@ static int attach_child_main(void* data)\n \t\t}\n \t}\n \n+\t/* we don't need proc anymore */\n+\tclose(procfd);\n+\n \t/* we're done, so we can now do whatever the user intended us to do */\n \trexit(payload->exec_function(payload->exec_payload));\n }"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 1,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "040e006d5d5c2cdccf2bcdda4f7c68b635509371",
            "date": "2025-01-09T23:24:26Z",
            "author_login": "stgraber"
          },
          {
            "sha": "4a4ba051aab0e45f1beac8b4222a230a3e6848de",
            "date": "2025-01-09T23:05:20Z",
            "author_login": "stgraber"
          },
          {
            "sha": "8d8fd27b57bf1ebc9cdbf129547961339dd45b8b",
            "date": "2025-01-08T23:07:17Z",
            "author_login": "sdanailo-42"
          },
          {
            "sha": "844c49fcf356a55b83a26a0bb8a5e6d25039f549",
            "date": "2025-01-08T22:51:15Z",
            "author_login": "sdanailo-42"
          },
          {
            "sha": "4c4636830528300d122d2a0b4aa540b61e2e7128",
            "date": "2025-01-08T23:05:26Z",
            "author_login": "sdanailo-42"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": null,
    "cvss_vector": null,
    "cwe_id": "CWE-17",
    "description": "attach.c in LXC 1.1.2 and earlier uses the proc filesystem in a container, which allows local container users to escape AppArmor or SELinux confinement by mounting a proc filesystem with a crafted (1) AppArmor profile or (2) SELinux label.",
    "attack_vector": null,
    "attack_complexity": null
  },
  "temporal_data": {
    "published_date": "2015-08-12T14:59:05.590",
    "last_modified": "2024-11-21T02:25:11.530",
    "fix_date": "2015-07-16T20:37:51Z"
  },
  "references": [
    {
      "url": "http://lists.opensuse.org/opensuse-security-announce/2019-05/msg00073.html",
      "source": "security@ubuntu.com",
      "tags": []
    },
    {
      "url": "http://lists.opensuse.org/opensuse-updates/2015-07/msg00066.html",
      "source": "security@ubuntu.com",
      "tags": []
    },
    {
      "url": "http://lists.opensuse.org/opensuse-updates/2015-07/msg00067.html",
      "source": "security@ubuntu.com",
      "tags": []
    },
    {
      "url": "http://www.debian.org/security/2015/dsa-3317",
      "source": "security@ubuntu.com",
      "tags": []
    },
    {
      "url": "http://www.securityfocus.com/bid/75998",
      "source": "security@ubuntu.com",
      "tags": []
    },
    {
      "url": "http://www.ubuntu.com/usn/USN-2675-1",
      "source": "security@ubuntu.com",
      "tags": []
    },
    {
      "url": "https://github.com/lxc/lxc/commit/5c3fcae78b63ac9dd56e36075903921bd9461f9e",
      "source": "security@ubuntu.com",
      "tags": []
    },
    {
      "url": "https://service.ait.ac.at/security/2015/LxcSecurityAnalysis.html",
      "source": "security@ubuntu.com",
      "tags": []
    },
    {
      "url": "http://lists.opensuse.org/opensuse-security-announce/2019-05/msg00073.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "http://lists.opensuse.org/opensuse-updates/2015-07/msg00066.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "http://lists.opensuse.org/opensuse-updates/2015-07/msg00067.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "http://www.debian.org/security/2015/dsa-3317",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "http://www.securityfocus.com/bid/75998",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "http://www.ubuntu.com/usn/USN-2675-1",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://github.com/lxc/lxc/commit/5c3fcae78b63ac9dd56e36075903921bd9461f9e",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://service.ait.ac.at/security/2015/LxcSecurityAnalysis.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T22:58:35.798424",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "lxc",
    "owner": "lxc",
    "created_at": "2012-09-07T18:50:27Z",
    "updated_at": "2025-01-14T11:54:42Z",
    "pushed_at": "2025-01-09T23:24:26Z",
    "size": 35605,
    "stars": 4741,
    "forks": 1125,
    "open_issues": 176,
    "watchers": 4741,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [
      "main",
      "stable-0.7.4",
      "stable-1.0",
      "stable-1.1"
    ],
    "languages": {
      "C": 2574680,
      "Shell": 196933,
      "Meson": 74020,
      "Python": 5129,
      "Makefile": 300,
      "SmPL": 251
    },
    "commit_activity": {
      "total_commits_last_year": 159,
      "avg_commits_per_week": 3.0576923076923075,
      "days_active_last_year": 61
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T13:06:03.413007"
  }
}