{
  "cve_id": "CVE-2016-2539",
  "github_data": {
    "repository": "atutor/ATutor",
    "fix_commit": "bfc6c80c6c217c5515172f3cc949e13dfa1a92ac",
    "related_commits": [
      "bfc6c80c6c217c5515172f3cc949e13dfa1a92ac",
      "bfc6c80c6c217c5515172f3cc949e13dfa1a92ac"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "bfc6c80c6c217c5515172f3cc949e13dfa1a92ac",
      "commit_date": "2016-03-05T19:12:46Z",
      "author": {
        "login": "gregrgay",
        "type": "User",
        "stats": {
          "total_commits": 352,
          "average_weekly_commits": 0.318552036199095,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 55
        }
      },
      "commit_message": {
        "title": "5632,5644 removed array_multisort to fix module install issues, and added csrftoken to fix postential CSRF attack",
        "length": 113,
        "has_description": false,
        "references_issue": true
      },
      "stats": {
        "total": 47,
        "additions": 39,
        "deletions": 8
      },
      "files": [
        {
          "filename": "mods/_core/modules/install_modules.php",
          "status": "modified",
          "additions": 23,
          "deletions": 7,
          "patch": "@@ -18,6 +18,8 @@\n require(AT_INCLUDE_PATH.'../mods/_core/modules/classes/ModuleListParser.class.php');\n require_once(AT_INCLUDE_PATH.'../mods/_core/file_manager/filemanager.inc.php');\n // delete all folders and files in $dir\n+\n+\n function clear_dir($dir)\n {\n \tif ($dh = opendir($dir)) \n@@ -154,8 +156,15 @@ function clear_dir($dir)\n \n \t\t\tif (!$msg->containsErrors())\n \t\t\t{\n-\t\t\t\theader('Location: module_install_step_1.php?mod='.urlencode($module_folder).SEP.'new=1');\n-\t\t\t\texit;\n+\t\t\t        if($_POST['csrftoken'] != $_SESSION['token']){\n+                        $msg->addError('ACCESS_DENIED');\n+                    } else {\n+                    \n+                        header('Location: module_install_step_1.php?mod='.urlencode($module_folder).SEP.'new=1');                        \n+                        exit;\n+                    }\n+\t\t\t\t//header('Location: module_install_step_1.php?mod='.urlencode($module_folder).SEP.'new=1');\n+\t\t\t\t//exit;\n \t\t\t}\n \t\t}\n \t\t\n@@ -181,8 +190,13 @@ function clear_dir($dir)\n \t$dir_name = str_replace(array('.','..'), '', $_POST['mod']);\n \n \tif (isset($_POST['install_manually'])) {\n-\t\theader('Location: '.AT_BASE_HREF.'mods/_core/modules/module_install_step_2.php?mod='.urlencode($dir_name).SEP.'new=1'.SEP.'mod_in=1');\n-\t\texit;\n+\t// Check for potential  CSRF\n+        if($_POST['csrftoken'] != $_SESSION['token']){\n+                $msg->addError('ACCESS_DENIED');\n+        } else {\n+            header('Location: '.AT_BASE_HREF.'mods/_core/modules/module_install_step_2.php?mod='.urlencode($dir_name).SEP.'new=1'.SEP.'mod_in=1');\n+            exit;\n+        }\n \t}\n \n } else if (isset($_POST['install_manually'])) {\n@@ -255,16 +269,18 @@ function validate_filename() {\n \n     // Add $module_list_array as the last parameter, to sort by the common key\n     // Sorts by original $module_list_array by reference, then returns true|false\n-    $sort_by_version = array_multisort($version, SORT_DESC, $module_list_array);\n+    //$sort_by_version = array_multisort($version, SORT_DESC, $module_list_array);\n \n // Create menu for filter ATutor versions\n-function select_atversion(){ \n+function select_atversion($v=0){ \n     global $sort_versions;\n     $menu = '<form action=\"'.$_SERVER['PHP_SELF'].'\" method=\"post\">'; \n     $menu.= '<select name=\"atversions\">';\n     $menu.= '<option value=\"0\">'._AT(\"all\").'</option>';\n     foreach($sort_versions as $version){\n-        if($version == VERSION){\n+        if($version == $v){\n+            $menu .= '<option value=\"'.$version.'\" selected=\"selected\">'.$version.'</option>';\n+        }else if($version == VERSION){\n             $menu .= '<option value=\"'.$version.'\" selected=\"selected\">'.$version.'</option>';\n         }else{\n             $menu .= '<option value=\"'.$version.'\" >'.$version.'</option>';"
        },
        {
          "filename": "themes/default/admin/modules/install_modules.tmpl.php",
          "status": "modified",
          "additions": 16,
          "deletions": 1,
          "patch": "@@ -8,6 +8,7 @@\n \n \t\t<div class=\"row\">\n \t\t\t<input type=\"hidden\" name=\"MAX_FILE_SIZE\" value=\"52428800\" />\n+\t\t\t<input type=\"hidden\" name=\"csrftoken\"  value=\"<?php echo $_SESSION['token'];?>\" />\n \t\t\t<input type=\"file\" name=\"modulefile\"  size=\"50\" />\n \t\t</div>\n \t\t\n@@ -26,6 +27,7 @@\n {\n ?>\n <form action=\"<?php echo $_SERVER['PHP_SELF']; ?>\" method=\"post\" name=\"installform\">\n+<input type=\"hidden\" name=\"csrftoken\"  value=\"<?php echo $_SESSION['token'];?>\" />\n <table class=\"data\" summary=\"\">\n <thead>\n <tr>\n@@ -82,10 +84,23 @@\n     <div class=\"row\">\n     <?php echo _AT('old_module_notes'); ?>\n     </div>\n-<?php echo select_atversion(); ?>\n+<?php \n+\n+if(isset($_POST['atversions'])){\n+    $v = htmlspecialchars($_POST['atversions']);\n+    $_SESSION['atversion'] = $_POST['atversions'];\n+} elseif(isset($_SESSION['atversion'] )){\n+    $v = substr($_SESSION['atversion'], 0, 3);\n+} else {\n+    $v = substr(VERSION, 0, 3);\n+}\n+echo select_atversion($v); \n+\n+?>\n </div>\n </fieldset>\n <form action=\"<?php echo $_SERVER['PHP_SELF']; ?>\" method=\"post\" name=\"form\">\n+<input type=\"hidden\" name=\"csrftoken\"  value=\"<?php echo $_SESSION['token'];?>\" />\n <table class=\"data\" summary=\"\">\n <thead>\n \t<tr>"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 2,
        "max_directory_depth": 4
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "333030fcd1112208506947f266598a9c5fe9fbe6",
            "date": "2023-02-12T19:12:02Z",
            "author_login": "atutor"
          },
          {
            "sha": "0d8065412d8aa97649920cca8e359f1a9f10a11c",
            "date": "2023-02-08T20:10:02Z",
            "author_login": "alyssafoglia"
          },
          {
            "sha": "f29cd2534b9574ce223f22a6e0e8e2a9457c45a4",
            "date": "2023-02-08T18:44:59Z",
            "author_login": "alyssafoglia"
          },
          {
            "sha": "2f571d0e7fe6911442316de060697ebef6b500a9",
            "date": "2023-02-08T18:44:38Z",
            "author_login": "alyssafoglia"
          },
          {
            "sha": "44240cb64caff4907b3c4e8b5729270ad839da11",
            "date": "2023-02-08T18:42:03Z",
            "author_login": "alyssafoglia"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": null,
    "cvss_vector": null,
    "cwe_id": "CWE-352",
    "description": "Cross-site request forgery (CSRF) vulnerability in install_modules.php in ATutor before 2.2.2 allows remote attackers to hijack the authentication of users for requests that upload arbitrary files and execute arbitrary PHP code via vectors involving a crafted zip file.",
    "attack_vector": null,
    "attack_complexity": null
  },
  "temporal_data": {
    "published_date": "2017-02-07T15:59:00.257",
    "last_modified": "2024-11-21T02:48:39.140",
    "fix_date": "2016-03-05T19:12:46Z"
  },
  "references": [
    {
      "url": "https://github.com/atutor/ATutor/commit/bfc6c80c6c217c5515172f3cc949e13dfa1a92ac",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://packetstormsecurity.com/files/136109/ATutor-LMS-2.2.1-CSRF-Remote-Code-Execution.html",
      "source": "cve@mitre.org",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory",
        "VDB Entry"
      ]
    },
    {
      "url": "https://www.exploit-db.com/exploits/39524/",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "https://github.com/atutor/ATutor/commit/bfc6c80c6c217c5515172f3cc949e13dfa1a92ac",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://packetstormsecurity.com/files/136109/ATutor-LMS-2.2.1-CSRF-Remote-Code-Execution.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory",
        "VDB Entry"
      ]
    },
    {
      "url": "https://www.exploit-db.com/exploits/39524/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T22:58:52.213488",
    "processing_status": "enhanced"
  }
}