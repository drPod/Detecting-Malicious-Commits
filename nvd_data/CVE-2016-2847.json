{
  "cve_id": "CVE-2016-2847",
  "github_data": {
    "repository": "torvalds/linux",
    "fix_commit": "759c01142a5d0f364a462346168a56de28a80f52",
    "related_commits": [
      "759c01142a5d0f364a462346168a56de28a80f52",
      "759c01142a5d0f364a462346168a56de28a80f52"
    ],
    "patch_url": "https://github.com/torvalds/linux/commit/759c01142a5d0f364a462346168a56de28a80f52.patch",
    "fix_commit_details": {
      "sha": "759c01142a5d0f364a462346168a56de28a80f52",
      "commit_date": "2016-01-18T15:36:09Z",
      "author": {
        "login": "wtarreau",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "pipe: limit the per-user amount of pages allocated in pipes",
        "length": 1670,
        "has_description": true,
        "references_issue": false
      },
      "stats": {
        "total": 89,
        "additions": 87,
        "deletions": 2
      },
      "files": [
        {
          "filename": "Documentation/sysctl/fs.txt",
          "status": "modified",
          "additions": 23,
          "deletions": 0,
          "patch": "@@ -32,6 +32,8 @@ Currently, these files are in /proc/sys/fs:\n - nr_open\n - overflowuid\n - overflowgid\n+- pipe-user-pages-hard\n+- pipe-user-pages-soft\n - protected_hardlinks\n - protected_symlinks\n - suid_dumpable\n@@ -159,6 +161,27 @@ The default is 65534.\n \n ==============================================================\n \n+pipe-user-pages-hard:\n+\n+Maximum total number of pages a non-privileged user may allocate for pipes.\n+Once this limit is reached, no new pipes may be allocated until usage goes\n+below the limit again. When set to 0, no limit is applied, which is the default\n+setting.\n+\n+==============================================================\n+\n+pipe-user-pages-soft:\n+\n+Maximum total number of pages a non-privileged user may allocate for pipes\n+before the pipe size gets limited to a single page. Once this limit is reached,\n+new pipes will be limited to a single page in size for this user in order to\n+limit total memory usage, and trying to increase them using fcntl() will be\n+denied until usage goes below the limit again. The default value allows to\n+allocate up to 1024 pipes at their default size. When set to 0, no limit is\n+applied.\n+\n+==============================================================\n+\n protected_hardlinks:\n \n A long-standing class of security issues is the hardlink-based"
        },
        {
          "filename": "fs/pipe.c",
          "status": "modified",
          "additions": 45,
          "deletions": 2,
          "patch": "@@ -38,6 +38,12 @@ unsigned int pipe_max_size = 1048576;\n  */\n unsigned int pipe_min_size = PAGE_SIZE;\n \n+/* Maximum allocatable pages per user. Hard limit is unset by default, soft\n+ * matches default values.\n+ */\n+unsigned long pipe_user_pages_hard;\n+unsigned long pipe_user_pages_soft = PIPE_DEF_BUFFERS * INR_OPEN_CUR;\n+\n /*\n  * We use a start+len construction, which provides full use of the \n  * allocated memory.\n@@ -583,20 +589,49 @@ pipe_fasync(int fd, struct file *filp, int on)\n \treturn retval;\n }\n \n+static void account_pipe_buffers(struct pipe_inode_info *pipe,\n+                                 unsigned long old, unsigned long new)\n+{\n+\tatomic_long_add(new - old, &pipe->user->pipe_bufs);\n+}\n+\n+static bool too_many_pipe_buffers_soft(struct user_struct *user)\n+{\n+\treturn pipe_user_pages_soft &&\n+\t       atomic_long_read(&user->pipe_bufs) >= pipe_user_pages_soft;\n+}\n+\n+static bool too_many_pipe_buffers_hard(struct user_struct *user)\n+{\n+\treturn pipe_user_pages_hard &&\n+\t       atomic_long_read(&user->pipe_bufs) >= pipe_user_pages_hard;\n+}\n+\n struct pipe_inode_info *alloc_pipe_info(void)\n {\n \tstruct pipe_inode_info *pipe;\n \n \tpipe = kzalloc(sizeof(struct pipe_inode_info), GFP_KERNEL);\n \tif (pipe) {\n-\t\tpipe->bufs = kzalloc(sizeof(struct pipe_buffer) * PIPE_DEF_BUFFERS, GFP_KERNEL);\n+\t\tunsigned long pipe_bufs = PIPE_DEF_BUFFERS;\n+\t\tstruct user_struct *user = get_current_user();\n+\n+\t\tif (!too_many_pipe_buffers_hard(user)) {\n+\t\t\tif (too_many_pipe_buffers_soft(user))\n+\t\t\t\tpipe_bufs = 1;\n+\t\t\tpipe->bufs = kzalloc(sizeof(struct pipe_buffer) * pipe_bufs, GFP_KERNEL);\n+\t\t}\n+\n \t\tif (pipe->bufs) {\n \t\t\tinit_waitqueue_head(&pipe->wait);\n \t\t\tpipe->r_counter = pipe->w_counter = 1;\n-\t\t\tpipe->buffers = PIPE_DEF_BUFFERS;\n+\t\t\tpipe->buffers = pipe_bufs;\n+\t\t\tpipe->user = user;\n+\t\t\taccount_pipe_buffers(pipe, 0, pipe_bufs);\n \t\t\tmutex_init(&pipe->mutex);\n \t\t\treturn pipe;\n \t\t}\n+\t\tfree_uid(user);\n \t\tkfree(pipe);\n \t}\n \n@@ -607,6 +642,8 @@ void free_pipe_info(struct pipe_inode_info *pipe)\n {\n \tint i;\n \n+\taccount_pipe_buffers(pipe, pipe->buffers, 0);\n+\tfree_uid(pipe->user);\n \tfor (i = 0; i < pipe->buffers; i++) {\n \t\tstruct pipe_buffer *buf = pipe->bufs + i;\n \t\tif (buf->ops)\n@@ -998,6 +1035,7 @@ static long pipe_set_size(struct pipe_inode_info *pipe, unsigned long nr_pages)\n \t\t\tmemcpy(bufs + head, pipe->bufs, tail * sizeof(struct pipe_buffer));\n \t}\n \n+\taccount_pipe_buffers(pipe, pipe->buffers, nr_pages);\n \tpipe->curbuf = 0;\n \tkfree(pipe->bufs);\n \tpipe->bufs = bufs;\n@@ -1069,6 +1107,11 @@ long pipe_fcntl(struct file *file, unsigned int cmd, unsigned long arg)\n \t\tif (!capable(CAP_SYS_RESOURCE) && size > pipe_max_size) {\n \t\t\tret = -EPERM;\n \t\t\tgoto out;\n+\t\t} else if ((too_many_pipe_buffers_hard(pipe->user) ||\n+\t\t\t    too_many_pipe_buffers_soft(pipe->user)) &&\n+\t\t           !capable(CAP_SYS_RESOURCE) && !capable(CAP_SYS_ADMIN)) {\n+\t\t\tret = -EPERM;\n+\t\t\tgoto out;\n \t\t}\n \t\tret = pipe_set_size(pipe, nr_pages);\n \t\tbreak;"
        },
        {
          "filename": "include/linux/pipe_fs_i.h",
          "status": "modified",
          "additions": 4,
          "deletions": 0,
          "patch": "@@ -42,6 +42,7 @@ struct pipe_buffer {\n  *\t@fasync_readers: reader side fasync\n  *\t@fasync_writers: writer side fasync\n  *\t@bufs: the circular array of pipe buffers\n+ *\t@user: the user who created this pipe\n  **/\n struct pipe_inode_info {\n \tstruct mutex mutex;\n@@ -57,6 +58,7 @@ struct pipe_inode_info {\n \tstruct fasync_struct *fasync_readers;\n \tstruct fasync_struct *fasync_writers;\n \tstruct pipe_buffer *bufs;\n+\tstruct user_struct *user;\n };\n \n /*\n@@ -123,6 +125,8 @@ void pipe_unlock(struct pipe_inode_info *);\n void pipe_double_lock(struct pipe_inode_info *, struct pipe_inode_info *);\n \n extern unsigned int pipe_max_size, pipe_min_size;\n+extern unsigned long pipe_user_pages_hard;\n+extern unsigned long pipe_user_pages_soft;\n int pipe_proc_fn(struct ctl_table *, int, void __user *, size_t *, loff_t *);\n \n "
        },
        {
          "filename": "include/linux/sched.h",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -835,6 +835,7 @@ struct user_struct {\n #endif\n \tunsigned long locked_shm; /* How many pages of mlocked shm ? */\n \tunsigned long unix_inflight;\t/* How many files in flight in unix sockets */\n+\tatomic_long_t pipe_bufs;  /* how many pages are allocated in pipe buffers */\n \n #ifdef CONFIG_KEYS\n \tstruct key *uid_keyring;\t/* UID specific keyring */"
        },
        {
          "filename": "kernel/sysctl.c",
          "status": "modified",
          "additions": 14,
          "deletions": 0,
          "patch": "@@ -1757,6 +1757,20 @@ static struct ctl_table fs_table[] = {\n \t\t.proc_handler\t= &pipe_proc_fn,\n \t\t.extra1\t\t= &pipe_min_size,\n \t},\n+\t{\n+\t\t.procname\t= \"pipe-user-pages-hard\",\n+\t\t.data\t\t= &pipe_user_pages_hard,\n+\t\t.maxlen\t\t= sizeof(pipe_user_pages_hard),\n+\t\t.mode\t\t= 0644,\n+\t\t.proc_handler\t= proc_doulongvec_minmax,\n+\t},\n+\t{\n+\t\t.procname\t= \"pipe-user-pages-soft\",\n+\t\t.data\t\t= &pipe_user_pages_soft,\n+\t\t.maxlen\t\t= sizeof(pipe_user_pages_soft),\n+\t\t.mode\t\t= 0644,\n+\t\t.proc_handler\t= proc_doulongvec_minmax,\n+\t},\n \t{ }\n };\n "
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 4,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "7f5b6a8ec18e3add4c74682f60b90c31bdf849f2",
            "date": "2025-01-14T19:32:14Z",
            "author_login": "torvalds"
          },
          {
            "sha": "c3812b15000cc5b7b17c7238f8b12f6a22df0b1d",
            "date": "2025-01-14T18:07:40Z",
            "author_login": "torvalds"
          },
          {
            "sha": "79a1d390f879563119bf2848b621bc7eed228c7d",
            "date": "2025-01-14T17:54:57Z",
            "author_login": "torvalds"
          },
          {
            "sha": "c45323b7560ec87c37c729b703c86ee65f136d75",
            "date": "2025-01-13T17:03:18Z",
            "author_login": "torvalds"
          },
          {
            "sha": "34c8e74cd6667ef5da90d448a1af702c4b873bd3",
            "date": "2025-01-13T08:52:08Z",
            "author_login": "YageGeng"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": null,
    "cvss_vector": null,
    "cwe_id": "CWE-399",
    "description": "fs/pipe.c in the Linux kernel before 4.5 does not limit the amount of unread data in pipes, which allows local users to cause a denial of service (memory consumption) by creating many pipes with non-default sizes.",
    "attack_vector": null,
    "attack_complexity": null
  },
  "temporal_data": {
    "published_date": "2016-04-27T17:59:21.947",
    "last_modified": "2024-11-21T02:48:56.010",
    "fix_date": "2016-01-18T15:36:09Z"
  },
  "references": [
    {
      "url": "http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=759c01142a5d0f364a462346168a56de28a80f52",
      "source": "secalert@redhat.com",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "http://lists.opensuse.org/opensuse-security-announce/2016-05/msg00060.html",
      "source": "secalert@redhat.com",
      "tags": []
    },
    {
      "url": "http://lists.opensuse.org/opensuse-security-announce/2016-06/msg00052.html",
      "source": "secalert@redhat.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://lists.opensuse.org/opensuse-security-announce/2016-06/msg00054.html",
      "source": "secalert@redhat.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://lists.opensuse.org/opensuse-security-announce/2016-06/msg00056.html",
      "source": "secalert@redhat.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://lists.opensuse.org/opensuse-security-announce/2016-06/msg00059.html",
      "source": "secalert@redhat.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://lists.opensuse.org/opensuse-security-announce/2016-08/msg00000.html",
      "source": "secalert@redhat.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://lists.opensuse.org/opensuse-security-announce/2016-08/msg00038.html",
      "source": "secalert@redhat.com",
      "tags": []
    },
    {
      "url": "http://rhn.redhat.com/errata/RHSA-2016-2574.html",
      "source": "secalert@redhat.com",
      "tags": []
    },
    {
      "url": "http://rhn.redhat.com/errata/RHSA-2016-2584.html",
      "source": "secalert@redhat.com",
      "tags": []
    },
    {
      "url": "http://rhn.redhat.com/errata/RHSA-2017-0217.html",
      "source": "secalert@redhat.com",
      "tags": []
    },
    {
      "url": "http://www.debian.org/security/2016/dsa-3503",
      "source": "secalert@redhat.com",
      "tags": []
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2016/03/01/3",
      "source": "secalert@redhat.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "http://www.oracle.com/technetwork/topics/security/linuxbulletinjul2016-3090544.html",
      "source": "secalert@redhat.com",
      "tags": []
    },
    {
      "url": "http://www.oracle.com/technetwork/topics/security/ovmbulletinoct2016-3090547.html",
      "source": "secalert@redhat.com",
      "tags": []
    },
    {
      "url": "http://www.securityfocus.com/bid/83870",
      "source": "secalert@redhat.com",
      "tags": []
    },
    {
      "url": "http://www.ubuntu.com/usn/USN-2946-1",
      "source": "secalert@redhat.com",
      "tags": []
    },
    {
      "url": "http://www.ubuntu.com/usn/USN-2946-2",
      "source": "secalert@redhat.com",
      "tags": []
    },
    {
      "url": "http://www.ubuntu.com/usn/USN-2947-1",
      "source": "secalert@redhat.com",
      "tags": []
    },
    {
      "url": "http://www.ubuntu.com/usn/USN-2947-2",
      "source": "secalert@redhat.com",
      "tags": []
    },
    {
      "url": "http://www.ubuntu.com/usn/USN-2947-3",
      "source": "secalert@redhat.com",
      "tags": []
    },
    {
      "url": "http://www.ubuntu.com/usn/USN-2948-1",
      "source": "secalert@redhat.com",
      "tags": []
    },
    {
      "url": "http://www.ubuntu.com/usn/USN-2948-2",
      "source": "secalert@redhat.com",
      "tags": []
    },
    {
      "url": "http://www.ubuntu.com/usn/USN-2949-1",
      "source": "secalert@redhat.com",
      "tags": []
    },
    {
      "url": "http://www.ubuntu.com/usn/USN-2967-1",
      "source": "secalert@redhat.com",
      "tags": []
    },
    {
      "url": "http://www.ubuntu.com/usn/USN-2967-2",
      "source": "secalert@redhat.com",
      "tags": []
    },
    {
      "url": "https://bugzilla.redhat.com/show_bug.cgi?id=1313428",
      "source": "secalert@redhat.com",
      "tags": [
        "Issue Tracking"
      ]
    },
    {
      "url": "https://github.com/torvalds/linux/commit/759c01142a5d0f364a462346168a56de28a80f52",
      "source": "secalert@redhat.com",
      "tags": []
    },
    {
      "url": "http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=759c01142a5d0f364a462346168a56de28a80f52",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "http://lists.opensuse.org/opensuse-security-announce/2016-05/msg00060.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "http://lists.opensuse.org/opensuse-security-announce/2016-06/msg00052.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://lists.opensuse.org/opensuse-security-announce/2016-06/msg00054.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://lists.opensuse.org/opensuse-security-announce/2016-06/msg00056.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://lists.opensuse.org/opensuse-security-announce/2016-06/msg00059.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://lists.opensuse.org/opensuse-security-announce/2016-08/msg00000.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://lists.opensuse.org/opensuse-security-announce/2016-08/msg00038.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "http://rhn.redhat.com/errata/RHSA-2016-2574.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "http://rhn.redhat.com/errata/RHSA-2016-2584.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "http://rhn.redhat.com/errata/RHSA-2017-0217.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "http://www.debian.org/security/2016/dsa-3503",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2016/03/01/3",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "http://www.oracle.com/technetwork/topics/security/linuxbulletinjul2016-3090544.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "http://www.oracle.com/technetwork/topics/security/ovmbulletinoct2016-3090547.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "http://www.securityfocus.com/bid/83870",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "http://www.ubuntu.com/usn/USN-2946-1",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "http://www.ubuntu.com/usn/USN-2946-2",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "http://www.ubuntu.com/usn/USN-2947-1",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "http://www.ubuntu.com/usn/USN-2947-2",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "http://www.ubuntu.com/usn/USN-2947-3",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "http://www.ubuntu.com/usn/USN-2948-1",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "http://www.ubuntu.com/usn/USN-2948-2",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "http://www.ubuntu.com/usn/USN-2949-1",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "http://www.ubuntu.com/usn/USN-2967-1",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "http://www.ubuntu.com/usn/USN-2967-2",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://bugzilla.redhat.com/show_bug.cgi?id=1313428",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Issue Tracking"
      ]
    },
    {
      "url": "https://github.com/torvalds/linux/commit/759c01142a5d0f364a462346168a56de28a80f52",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T22:58:42.535230",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "linux",
    "owner": "torvalds",
    "created_at": "2011-09-04T22:48:12Z",
    "updated_at": "2025-01-14T12:39:03Z",
    "pushed_at": "2025-01-13T17:27:04Z",
    "size": 5361369,
    "stars": 185823,
    "forks": 54743,
    "open_issues": 437,
    "watchers": 185823,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "C": 1326937103,
      "Assembly": 9568292,
      "Shell": 5072004,
      "Python": 2974128,
      "Makefile": 2713905,
      "Perl": 1253637,
      "Rust": 807711,
      "Roff": 202277,
      "C++": 173382,
      "SmPL": 165946,
      "Yacc": 127472,
      "Lex": 71321,
      "Awk": 69539,
      "Jinja": 30138,
      "UnrealScript": 16848,
      "Gherkin": 10172,
      "M4": 3329,
      "MATLAB": 2482,
      "sed": 2433,
      "Clojure": 2411,
      "XS": 1239,
      "RPC": 962
    },
    "commit_activity": {
      "total_commits_last_year": 46007,
      "avg_commits_per_week": 884.75,
      "days_active_last_year": 359
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T12:53:59.486675"
  }
}