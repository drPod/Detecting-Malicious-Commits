{
  "cve_id": "CVE-2016-6494",
  "github_data": {
    "repository": "mongodb/mongo",
    "fix_commit": "035cf2afc04988b22cb67f4ebfd77e9b344cb6e0",
    "related_commits": [
      "035cf2afc04988b22cb67f4ebfd77e9b344cb6e0",
      "035cf2afc04988b22cb67f4ebfd77e9b344cb6e0"
    ],
    "patch_url": "https://github.com/mongodb/mongo/commit/035cf2afc04988b22cb67f4ebfd77e9b344cb6e0.patch",
    "fix_commit_details": {
      "sha": "035cf2afc04988b22cb67f4ebfd77e9b344cb6e0",
      "commit_date": "2016-09-06T01:44:20Z",
      "author": {
        "login": "devkev",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "SERVER-25335 avoid group and other permissions when creating .dbshell history file",
        "length": 82,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 117,
        "additions": 115,
        "deletions": 2
      },
      "files": [
        {
          "filename": "jstests/noPassthrough/shell_history.js",
          "status": "added",
          "additions": 103,
          "deletions": 0,
          "patch": "@@ -0,0 +1,103 @@\n+// Test that when running the shell for the first time creates the ~/.dbshell file, and it has\n+// appropriate permissions (where relevant).\n+\n+(function() {\n+    \"use strict\";\n+\n+    // Use dataPath because it includes the trailing \"/\" or \"\\\".\n+    var tmpHome = MongoRunner.dataPath;\n+    // Ensure it exists and is a dir (eg. if running without resmoke.py and /data/db doesn't exist).\n+    mkdir(tmpHome);\n+    removeFile(tmpHome + \".dbshell\");\n+\n+    var args = [];\n+    var cmdline = \"mongo --nodb\";\n+    var redirection = \"\";\n+    var env = {};\n+    if (_isWindows()) {\n+        args.push(\"cmd.exe\");\n+        args.push(\"/c\");\n+\n+        // Input is set to NUL.  The output must also be redirected to NUL, otherwise running the\n+        // jstest manually has strange terminal IO behaviour.\n+        redirection = \"< NUL > NUL\";\n+\n+        // USERPROFILE set to the tmp homedir.\n+        // Since NUL is a character device, isatty() will return true, which means that .mongorc.js\n+        // will be created in the HOMEDRIVE + HOMEPATH location, so we must set them also.\n+        if (tmpHome.match(\"^[a-zA-Z]:\")) {\n+            var tmpHomeDrive = tmpHome.substr(0, 2);\n+            var tmpHomePath = tmpHome.substr(2);\n+        } else {\n+            var _pwd = pwd();\n+            assert(_pwd.match(\"^[a-zA-Z]:\"), \"pwd must include drive\");\n+            var tmpHomeDrive = _pwd.substr(0, 2);\n+            var tmpHomePath = tmpHome;\n+        }\n+        env = {USERPROFILE: tmpHome, HOMEDRIVE: tmpHomeDrive, HOMEPATH: tmpHomePath};\n+\n+    } else {\n+        args.push(\"sh\");\n+        args.push(\"-c\");\n+\n+        // Use the mongo shell from the current dir, same as resmoke.py does.\n+        // Doesn't handle resmoke's --mongo= option.\n+        cmdline = \"./\" + cmdline;\n+\n+        // Set umask to 0 prior to running the shell.\n+        cmdline = \"umask 0 ; \" + cmdline;\n+\n+        // stdin is /dev/null.\n+        redirection = \"< /dev/null\";\n+\n+        // HOME set to the tmp homedir.\n+        if (!tmpHome.startsWith(\"/\")) {\n+            tmpHome = pwd() + \"/\" + tmpHome;\n+        }\n+        env = {HOME: tmpHome};\n+    }\n+\n+    // Add redirection to cmdline, and add cmdline to args.\n+    cmdline += \" \" + redirection;\n+    args.push(cmdline);\n+    jsTestLog(\"Running args:\\n    \" + tojson(args) + \"\\nwith env:\\n    \" + tojson(env));\n+    var pid = _startMongoProgram({args, env});\n+    var rc = waitProgram(pid);\n+\n+    assert.eq(rc, 0);\n+\n+    var files = listFiles(tmpHome);\n+    jsTestLog(tojson(files));\n+\n+    var findFile = function(baseName) {\n+        for (var i = 0; i < files.length; i++) {\n+            if (files[i].baseName === baseName) {\n+                return files[i];\n+            }\n+        }\n+        return undefined;\n+    };\n+\n+    var targetFile = \".dbshell\";\n+    var file = findFile(targetFile);\n+\n+    assert.neq(typeof(file), \"undefined\", targetFile + \" should exist, but it doesn't\");\n+    assert.eq(file.isDirectory, false, targetFile + \" should not be a directory, but it is\");\n+    assert.eq(file.size, 0, targetFile + \" should be empty, but it isn't\");\n+\n+    if (!_isWindows()) {\n+        // On Unix, check that the file has the correct mode (permissions).\n+        // The shell has no way to stat a file.\n+        // There is no stat utility in POSIX.\n+        // `ls -l` is POSIX, so this is the best that we have.\n+        // Check for exactly \"-rw-------\".\n+        clearRawMongoProgramOutput();\n+        var rc = runProgram(\"ls\", \"-l\", file.name);\n+        assert.eq(rc, 0);\n+        var output = rawMongoProgramOutput();\n+        var fields = output.split(\" \");\n+        // First field is the prefix, second field is the `ls -l` permissions.\n+        assert.eq(fields[1], \"-rw-------\", targetFile + \" has bad permissions\");\n+    }\n+\n+})();"
        },
        {
          "filename": "src/mongo/shell/linenoise.cpp",
          "status": "modified",
          "additions": 12,
          "deletions": 2,
          "patch": "@@ -2762,7 +2762,17 @@ int linenoiseHistorySetMaxLen(int len) {\n /* Save the history in the specified file. On success 0 is returned\n  * otherwise -1 is returned. */\n int linenoiseHistorySave(const char* filename) {\n-    FILE* fp = fopen(filename, \"wt\");\n+    FILE* fp;\n+#if _POSIX_C_SOURCE >= 1 || _XOPEN_SOURCE || _POSIX_SOURCE\n+    int fd = open(filename, O_CREAT, S_IRUSR | S_IWUSR);\n+    if (fd == -1) {\n+        // report errno somehow?\n+        return -1;\n+    }\n+    fp = fdopen(fd, \"wt\");\n+#else\n+    fp = fopen(filename, \"wt\");\n+#endif  // _POSIX_C_SOURCE >= 1 || _XOPEN_SOURCE || _POSIX_SOURCE\n     if (fp == NULL) {\n         return -1;\n     }\n@@ -2772,7 +2782,7 @@ int linenoiseHistorySave(const char* filename) {\n             fprintf(fp, \"%s\\n\", history[j]);\n         }\n     }\n-    fclose(fp);\n+    fclose(fp);  // Also causes fd to be closed.\n     return 0;\n }\n "
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 2,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "86a6da5aa243144ecabf5e4997c6b05f2420c709",
            "date": "2025-01-14T15:32:21Z",
            "author_login": "lynne-wang"
          },
          {
            "sha": "2132aecc0f2d5d8d26f9e4acfb8bb5411ac8c910",
            "date": "2025-01-14T15:10:42Z",
            "author_login": "dgomezferro"
          },
          {
            "sha": "eb5e4484879c7072229294a6a32edb0cddada05d",
            "date": "2025-01-14T14:56:54Z",
            "author_login": "bshteinfeld"
          },
          {
            "sha": "6997706255d42cccfb4b4aea4497fcb195fd7649",
            "date": "2025-01-14T14:51:26Z",
            "author_login": "enricogolfieri"
          },
          {
            "sha": "c443d02fd3bfd08168622fbe2243b0ea138c6150",
            "date": "2025-01-14T14:22:09Z",
            "author_login": "ppolato"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": null,
    "cvss_vector": null,
    "cwe_id": "CWE-200",
    "description": "The client in MongoDB uses world-readable permissions on .dbshell history files, which might allow local users to obtain sensitive information by reading these files.",
    "attack_vector": null,
    "attack_complexity": null
  },
  "temporal_data": {
    "published_date": "2016-10-03T18:59:10.523",
    "last_modified": "2024-11-21T02:56:13.820",
    "fix_date": "2016-09-06T01:44:20Z"
  },
  "references": [
    {
      "url": "http://www.openwall.com/lists/oss-security/2016/07/29/4",
      "source": "cve@mitre.org",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2016/07/29/8",
      "source": "cve@mitre.org",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.securityfocus.com/bid/92204",
      "source": "cve@mitre.org",
      "tags": [
        "Third Party Advisory",
        "VDB Entry"
      ]
    },
    {
      "url": "https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=832908",
      "source": "cve@mitre.org",
      "tags": [
        "Issue Tracking"
      ]
    },
    {
      "url": "https://bugzilla.redhat.com/show_bug.cgi?id=1362553",
      "source": "cve@mitre.org",
      "tags": [
        "Issue Tracking"
      ]
    },
    {
      "url": "https://github.com/mongodb/mongo/commit/035cf2afc04988b22cb67f4ebfd77e9b344cb6e0",
      "source": "cve@mitre.org",
      "tags": [
        "Issue Tracking",
        "Patch"
      ]
    },
    {
      "url": "https://jira.mongodb.org/browse/SERVER-25335",
      "source": "cve@mitre.org",
      "tags": [
        "Issue Tracking"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/5MCE2ZLFBNOK3TTWSTXZJQGZVP4EEJDL/",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2016/07/29/4",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2016/07/29/8",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.securityfocus.com/bid/92204",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory",
        "VDB Entry"
      ]
    },
    {
      "url": "https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=832908",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Issue Tracking"
      ]
    },
    {
      "url": "https://bugzilla.redhat.com/show_bug.cgi?id=1362553",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Issue Tracking"
      ]
    },
    {
      "url": "https://github.com/mongodb/mongo/commit/035cf2afc04988b22cb67f4ebfd77e9b344cb6e0",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Issue Tracking",
        "Patch"
      ]
    },
    {
      "url": "https://jira.mongodb.org/browse/SERVER-25335",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Issue Tracking"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/5MCE2ZLFBNOK3TTWSTXZJQGZVP4EEJDL/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T22:58:46.797818",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "mongo",
    "owner": "mongodb",
    "created_at": "2009-01-15T16:15:18Z",
    "updated_at": "2025-01-14T16:10:38Z",
    "pushed_at": "2025-01-14T16:10:33Z",
    "size": 1110497,
    "stars": 26632,
    "forks": 5615,
    "open_issues": 80,
    "watchers": 26632,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "5.2",
      "6/0",
      "20e0f0c3b5a141789e39b4c09656ee76",
      "36a47ec614d84e29b7d7ee8450fa8968",
      "99fbb14f767540d3a440151bab99f7cd",
      "102a4da3e3244c4f845a32d6068fd143",
      "BACKPORT-9765",
      "BACKPORT-9836",
      "BACKPORT-10624-v4.2",
      "BACKPORT-12771",
      "BACKPORT-14789-perf",
      "BACKPORT-14789-sys-perf",
      "BACKPORT-14790-perf",
      "CLOUDP-69887",
      "EVG-17874-taskgen-test",
      "PERF-4260-regression-7.0-changes",
      "SERVER-54990-refactor-TODO",
      "SERVER-56932-const-folding-error-code",
      "SERVER-57348",
      "SERVER-57643",
      "SERVER-61202",
      "SERVER-62595",
      "SERVER-64595",
      "SERVER-68365_collecting_config2",
      "SERVER-68365_collecting_configs",
      "SERVER-68365_testing3",
      "SERVER-68365_testing4",
      "SERVER-68365",
      "SERVER-71068-v6.0",
      "SERVER-71395"
    ],
    "languages": {
      "C++": 94494172,
      "JavaScript": 31251173,
      "Python": 5473529,
      "C": 1702928,
      "Starlark": 1585881,
      "Shell": 222839,
      "TLA": 81282,
      "Rich Text Format": 31575,
      "Dockerfile": 6136,
      "Smarty": 3893,
      "Batchfile": 2188,
      "HTML": 2134,
      "PowerShell": 1558,
      "GDB": 565
    },
    "commit_activity": {
      "total_commits_last_year": 8086,
      "avg_commits_per_week": 155.5,
      "days_active_last_year": 330
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": true,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T17:18:01.407498"
  }
}