{
  "cve_id": "CVE-2016-7111",
  "github_data": {
    "repository": "mantisbt/mantisbt",
    "fix_commit": "b3511d2f",
    "related_commits": [
      "b3511d2f",
      "b3511d2f"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "b3511d2f",
      "commit_date": "2016-08-27T21:01:15Z",
      "author": {
        "login": "dregad",
        "type": "User",
        "stats": {
          "total_commits": 3418,
          "average_weekly_commits": 2.886824324324324,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 500
        }
      },
      "commit_message": {
        "title": "Fix weakened CSP by Gravatar plugin",
        "length": 103,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 114,
        "additions": 91,
        "deletions": 23
      },
      "files": [
        {
          "filename": "core.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -274,6 +274,7 @@ function __autoload( $p_class ) {\n \n # Set HTTP response headers\n require_api( 'http_api.php' );\n+event_signal( 'EVENT_CORE_HEADERS' );\n http_all_headers();\n \n # Push default language to speed calls to lang_get"
        },
        {
          "filename": "core/events_inc.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -33,6 +33,7 @@\n \n \t# Events specific to the core system\n \t'EVENT_CORE_READY' => EVENT_TYPE_EXECUTE,\n+\t'EVENT_CORE_HEADERS' => EVENT_TYPE_EXECUTE,\n \n \t# MantisBT Layout Events\n \t'EVENT_LAYOUT_RESOURCES' => EVENT_TYPE_OUTPUT,"
        },
        {
          "filename": "core/http_api.php",
          "status": "modified",
          "additions": 73,
          "deletions": 15,
          "patch": "@@ -29,6 +29,12 @@\n \n require_api( 'config_api.php' );\n \n+/**\n+ * The Content-Security-Policy settings array.  Use http_csp_add() to update it.\n+ * @var array\n+ */\n+$g_csp = array();\n+\n /**\n  * Checks to see if script was queried through the HTTPS protocol\n  * @return boolean True if protocol is HTTPS\n@@ -138,6 +144,64 @@ function http_content_headers() {\n \t}\n }\n \n+/**\n+ * Add a Content-Security-Policy directive.\n+ *\n+ * @param  string $p_type  The directive type, e.g. style-src, script-src.\n+ * @param  string $p_value The directive value, e.g. 'self', https://ajax.googleapis.com\n+ * @return void\n+ */\n+function http_csp_add( $p_type, $p_value ) {\n+\tglobal $g_csp;\n+\n+\tif ( $g_csp === null ) {\n+\t\t# Development error, headers already emitted.\n+\t\ttrigger_error( ERROR_GENERIC, ERROR );\n+\t}\n+\n+\tif ( isset( $g_csp[$p_type] ) ) {\n+\t\tif ( !in_array( $p_value, $g_csp[$p_type] ) ) {\n+\t\t\t$g_csp[$p_type][] = $p_value;\n+\t\t}\n+\t} else {\n+\t\t$g_csp[$p_type] = array( $p_value );\n+\t}\n+}\n+\n+/**\n+ * Constructs the value of the CSP header.\n+ * @return string CSP header value.\n+ */\n+function http_csp_value() {\n+\tglobal $g_csp;\n+\n+\tif ( $g_csp === null ) {\n+\t\t# Development error, headers already emitted.\n+\t\ttrigger_error( ERROR_GENERIC, ERROR );\n+\t}\n+\n+\t$t_csp_value = '';\n+\n+\tforeach ( $g_csp as $t_key => $t_values ) {\n+\t\t$t_csp_value .= $t_key . ' ' . implode( ' ', $t_values ) . '; ';\n+\t}\n+\n+\t$t_csp_value = trim( $t_csp_value, '; ' );\n+\n+\treturn $t_csp_value;\n+}\n+\n+/**\n+ * Send header for Content-Security-Policy.\n+ * @return void\n+ */\n+function http_csp_emit_header() {\n+\theader( 'Content-Security-Policy: ' . http_csp_value() );\n+\n+\tglobal $g_csp;\n+\t$g_csp = null;\n+}\n+\n /**\n  * Set security headers (frame busting, clickjacking/XSS/CSRF protection).\n  * @return void\n@@ -147,32 +211,26 @@ function http_security_headers() {\n \t\theader( 'X-Frame-Options: DENY' );\n \n \t\t# Define Content Security Policy\n-\t\t$t_csp = array(\n-\t\t\t\"default-src 'self'\",\n-\t\t\t\"frame-ancestors 'none'\",\n-\t\t);\n-\n-\t\t$t_style_src = \"style-src 'self'\";\n-\t\t$t_script_src = \"script-src 'self'\";\n+\t\thttp_csp_add( 'default-src', \"'self'\" );\n+\t\thttp_csp_add( 'frame-ancestors', \"'none'\" );\n+\t\thttp_csp_add( 'style-src', \"'self'\" );\n+\t\thttp_csp_add( 'script-src', \"'self'\" );\n+\t\thttp_csp_add( 'img-src', \"'self'\" );\n \n \t\t# White list the CDN urls (if enabled)\n \t\tif ( config_get_global( 'cdn_enabled' ) == ON ) {\n \t\t\t$t_cdn_url = 'https://ajax.googleapis.com';\n-\t\t\t$t_style_src .= \" $t_cdn_url\";\n-\t\t\t$t_script_src .= \" $t_cdn_url\";\n+\t\t\thttp_csp_add( 'style-src', $t_cdn_url );\n+\t\t\thttp_csp_add( 'script-src', $t_cdn_url );\n \t\t}\n \n \t\t# Relaxing policy for roadmap page to allow inline styles\n \t\t# This is a workaround to fix the broken progress bars (see #19501)\n \t\tif( 'roadmap_page.php' == basename( $_SERVER['SCRIPT_NAME'] ) ) {\n-\t\t\t$t_style_src .= \" 'unsafe-inline'\";\n+\t\t\thttp_csp_add( 'style-src', \"'unsafe-inline'\" );\n \t\t}\n \n-\t\t$t_csp[] = $t_style_src;\n-\t\t$t_csp[] = $t_script_src;\n-\n-\t\t# Set CSP header\n-\t\theader( 'Content-Security-Policy: ' . implode('; ', $t_csp) );\n+\t\thttp_csp_emit_header();\n \n \t\tif( http_is_protocol_https() ) {\n \t\t\theader( 'Strict-Transport-Security: max-age=7776000' );"
        },
        {
          "filename": "docbook/Developers_Guide/en-US/Events_Reference.xml",
          "status": "modified",
          "additions": 13,
          "deletions": 0,
          "patch": "@@ -83,6 +83,19 @@\n \t\t\t</blockquote>\n \t\t</blockquote>\n \n+\t\t<blockquote id=\"dev.eventref.system.coreheaders\">\n+\t\t\t<title>EVENT_CORE_HEADERS (Execute)</title>\n+\n+\t\t\t<blockquote>\n+\t\t\t\t<para>\n+\t\t\t\t\tThis event is triggered by the MantisBT bootstrap process just before emitting the\n+\t\t\t\t\theaders.  This enables plugins to emit their own headers or use API that enables\n+\t\t\t\t\ttweaking values of headers emitted by core.  An example, of headers that can be\n+\t\t\t\t\ttweaked is Content-Security-Policy header which can be tweaked using http_csp_*() APIs.\n+\t\t\t\t</para>\n+\t\t\t</blockquote>\n+\t\t</blockquote>\n+\n \t\t<blockquote id=\"dev.eventref.system.coreready\">\n \t\t\t<title>EVENT_CORE_READY (Execute)</title>\n "
        },
        {
          "filename": "plugins/Gravatar/Gravatar.php",
          "status": "modified",
          "additions": 3,
          "deletions": 8,
          "patch": "@@ -106,21 +106,16 @@ function config() {\n \tfunction hooks() {\n \t\treturn array(\n \t\t\t'EVENT_USER_AVATAR' => 'user_get_avatar',\n-\t\t\t'EVENT_LAYOUT_RESOURCES' => 'csp_headers',\n+\t\t\t'EVENT_CORE_HEADERS' => 'csp_headers',\n \t\t);\n \t}\n \n \t/**\n-\t * Add Content-Security-Policy for retrieving Avatar images.\n-\t *\n-\t * @return void\n+\t * Register gravatar url as an img-src for CSP header\n \t */\n \tfunction csp_headers() {\n-\t\t# Policy for images: Allow gravatar URL\n \t\tif( config_get( 'show_avatar' ) !== OFF ) {\n-\t\t\t# Set CSP header\n-\t\t\theader( \"Content-Security-Policy: img-src 'self' \" .\n-\t\t\t\tself::getAvatarUrl() );\n+\t\t\thttp_csp_add( 'img-src', self::getAvatarUrl() );\n \t\t}\n \t}\n "
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 4,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "924fb05df417dc639fd50a518dba20531a322851",
            "date": "2025-01-23T12:46:58Z",
            "author_login": "dregad"
          },
          {
            "sha": "60cb1d4e48e3e4578a1b8f662e22ba59dea9cb21",
            "date": "2025-01-23T12:41:32Z",
            "author_login": "raspopov"
          },
          {
            "sha": "7626b72778eaa1d3767b21f613219b0d1c46d9ca",
            "date": "2025-01-23T12:29:11Z",
            "author_login": "dregad"
          },
          {
            "sha": "4994c09658dd16045cc2ff62f184842029fb43fc",
            "date": "2025-01-23T12:07:11Z",
            "author_login": "translatewiki"
          },
          {
            "sha": "64a6c746c971d6f7ecc3063f5bafe9cb357cca93",
            "date": "2025-01-20T12:07:27Z",
            "author_login": "translatewiki"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": null,
    "cvss_vector": null,
    "cwe_id": "CWE-79",
    "description": "MantisBT before 1.3.1 and 2.x before 2.0.0-beta.2 uses a weak Content Security Policy when using the Gravatar plugin, which allows remote attackers to conduct cross-site scripting (XSS) attacks via unspecified vectors.",
    "attack_vector": null,
    "attack_complexity": null
  },
  "temporal_data": {
    "published_date": "2017-02-17T17:59:01.170",
    "last_modified": "2024-11-21T02:57:29.107",
    "fix_date": "2016-08-27T21:01:15Z"
  },
  "references": [
    {
      "url": "http://www.openwall.com/lists/oss-security/2016/08/28/1",
      "source": "cve@mitre.org",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2016/08/29/2",
      "source": "cve@mitre.org",
      "tags": [
        "Mailing List",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/mantisbt/mantisbt/commit/b3511d2f",
      "source": "cve@mitre.org",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://mantisbt.org/bugs/view.php?id=21263",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2016/08/28/1",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2016/08/29/2",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/mantisbt/mantisbt/commit/b3511d2f",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://mantisbt.org/bugs/view.php?id=21263",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T22:58:52.229133",
    "processing_status": "enhanced"
  }
}