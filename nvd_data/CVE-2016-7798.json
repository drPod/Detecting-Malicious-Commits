{
  "cve_id": "CVE-2016-7798",
  "github_data": {
    "repository": "ruby/openssl",
    "fix_commit": "8108e0a6db133f3375608303fdd2083eb5115062",
    "related_commits": [
      "8108e0a6db133f3375608303fdd2083eb5115062",
      "8108e0a6db133f3375608303fdd2083eb5115062"
    ],
    "patch_url": "https://github.com/ruby/openssl/commit/8108e0a6db133f3375608303fdd2083eb5115062.patch",
    "fix_commit_details": {
      "sha": "8108e0a6db133f3375608303fdd2083eb5115062",
      "commit_date": "2016-09-20T12:27:28Z",
      "author": {
        "login": "rhenium",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "cipher: don't set dummy encryption key in Cipher#initialize",
        "length": 1201,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 54,
        "additions": 36,
        "deletions": 18
      },
      "files": [
        {
          "filename": "ext/openssl/ossl_cipher.c",
          "status": "modified",
          "additions": 13,
          "deletions": 12,
          "patch": "@@ -36,7 +36,7 @@\n  */\n VALUE cCipher;\n VALUE eCipherError;\n-static ID id_auth_tag_len;\n+static ID id_auth_tag_len, id_key_set;\n \n static VALUE ossl_cipher_alloc(VALUE klass);\n static void ossl_cipher_free(void *ptr);\n@@ -118,7 +118,6 @@ ossl_cipher_initialize(VALUE self, VALUE str)\n     EVP_CIPHER_CTX *ctx;\n     const EVP_CIPHER *cipher;\n     char *name;\n-    unsigned char dummy_key[EVP_MAX_KEY_LENGTH] = { 0 };\n \n     name = StringValueCStr(str);\n     GetCipherInit(self, ctx);\n@@ -129,16 +128,7 @@ ossl_cipher_initialize(VALUE self, VALUE str)\n     if (!(cipher = EVP_get_cipherbyname(name))) {\n \tossl_raise(rb_eRuntimeError, \"unsupported cipher algorithm (%\"PRIsVALUE\")\", str);\n     }\n-    /*\n-     * EVP_CipherInit_ex() allows to specify NULL to key and IV, however some\n-     * ciphers don't handle well (OpenSSL's bug). [Bug #2768]\n-     *\n-     * The EVP which has EVP_CIPH_RAND_KEY flag (such as DES3) allows\n-     * uninitialized key, but other EVPs (such as AES) does not allow it.\n-     * Calling EVP_CipherUpdate() without initializing key causes SEGV so we\n-     * set the data filled with \"\\0\" as the key by default.\n-     */\n-    if (EVP_CipherInit_ex(ctx, cipher, NULL, dummy_key, NULL, -1) != 1)\n+    if (EVP_CipherInit_ex(ctx, cipher, NULL, NULL, NULL, -1) != 1)\n \tossl_raise(eCipherError, NULL);\n \n     return self;\n@@ -251,6 +241,9 @@ ossl_cipher_init(int argc, VALUE *argv, VALUE self, int mode)\n \tossl_raise(eCipherError, NULL);\n     }\n \n+    if (p_key)\n+\trb_ivar_set(self, id_key_set, Qtrue);\n+\n     return self;\n }\n \n@@ -337,6 +330,8 @@ ossl_cipher_pkcs5_keyivgen(int argc, VALUE *argv, VALUE self)\n     OPENSSL_cleanse(key, sizeof key);\n     OPENSSL_cleanse(iv, sizeof iv);\n \n+    rb_ivar_set(self, id_key_set, Qtrue);\n+\n     return Qnil;\n }\n \n@@ -387,6 +382,9 @@ ossl_cipher_update(int argc, VALUE *argv, VALUE self)\n \n     rb_scan_args(argc, argv, \"11\", &data, &str);\n \n+    if (!RTEST(rb_attr_get(self, id_key_set)))\n+\tossl_raise(eCipherError, \"key not set\");\n+\n     StringValue(data);\n     in = (unsigned char *)RSTRING_PTR(data);\n     if ((in_len = RSTRING_LEN(data)) == 0)\n@@ -488,6 +486,8 @@ ossl_cipher_set_key(VALUE self, VALUE key)\n     if (EVP_CipherInit_ex(ctx, NULL, NULL, (unsigned char *)RSTRING_PTR(key), NULL, -1) != 1)\n \tossl_raise(eCipherError, NULL);\n \n+    rb_ivar_set(self, id_key_set, Qtrue);\n+\n     return key;\n }\n \n@@ -1082,4 +1082,5 @@ Init_ossl_cipher(void)\n     rb_define_method(cCipher, \"padding=\", ossl_cipher_set_padding, 1);\n \n     id_auth_tag_len = rb_intern_const(\"auth_tag_len\");\n+    id_key_set = rb_intern_const(\"key_set\");\n }"
        },
        {
          "filename": "test/test_cipher.rb",
          "status": "modified",
          "additions": 23,
          "deletions": 6,
          "patch": "@@ -90,6 +90,7 @@ def test_key_iv_set\n \n   def test_empty_data\n     @c1.encrypt\n+    @c1.random_key\n     assert_raise(ArgumentError){ @c1.update(\"\") }\n   end\n \n@@ -136,12 +137,10 @@ def test_AES\n     }\n   end\n \n-  def test_AES_crush\n-    500.times do\n-      assert_nothing_raised(\"[Bug #2768]\") do\n-        # it caused OpenSSL SEGV by uninitialized key\n-        OpenSSL::Cipher::AES128.new(\"ECB\").update \".\" * 17\n-      end\n+  def test_update_raise_if_key_not_set\n+    assert_raise(OpenSSL::Cipher::CipherError) do\n+      # it caused OpenSSL SEGV by uninitialized key [Bug #2768]\n+      OpenSSL::Cipher::AES128.new(\"ECB\").update \".\" * 17\n     end\n   end\n \n@@ -317,6 +316,24 @@ def test_aes_ocb_tag_len\n     }\n   end if has_cipher?(\"aes-128-ocb\")\n \n+  def test_aes_gcm_key_iv_order_issue\n+    pt = \"[ruby/openssl#49]\"\n+    cipher = OpenSSL::Cipher.new(\"aes-128-gcm\").encrypt\n+    cipher.key = \"x\" * 16\n+    cipher.iv = \"a\" * 12\n+    ct1 = cipher.update(pt) << cipher.final\n+    tag1 = cipher.auth_tag\n+\n+    cipher = OpenSSL::Cipher.new(\"aes-128-gcm\").encrypt\n+    cipher.iv = \"a\" * 12\n+    cipher.key = \"x\" * 16\n+    ct2 = cipher.update(pt) << cipher.final\n+    tag2 = cipher.auth_tag\n+\n+    assert_equal ct1, ct2\n+    assert_equal tag1, tag2\n+  end if has_cipher?(\"aes-128-gcm\")\n+\n   private\n \n   def new_encryptor(algo)"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 2,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "4831aee87ac7a618aeb4ccc46d84745b14f102ac",
            "date": "2025-01-14T12:38:10Z",
            "author_login": "rhenium"
          },
          {
            "sha": "a3e0c16b1616a3e07631ea6b13a95c9a0b573e64",
            "date": "2025-01-14T11:54:42Z",
            "author_login": "rhenium"
          },
          {
            "sha": "187b176ecd73664dd3f5bb30d472bf975101e4bf",
            "date": "2025-01-14T11:42:48Z",
            "author_login": "rhenium"
          },
          {
            "sha": "2733bea5c83c9cc0f89a0b487003c20c909ee825",
            "date": "2025-01-14T00:02:29Z",
            "author_login": "hsbt"
          },
          {
            "sha": "ee01e10467ca8289c443304ee6263c4701e0de58",
            "date": "2025-01-13T09:21:00Z",
            "author_login": "dependabot[bot]"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 7.5,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N",
    "cwe_id": "CWE-326",
    "description": "The openssl gem for Ruby uses the same initialization vector (IV) in GCM Mode (aes-*-gcm) when the IV is set before the key, which makes it easier for context-dependent attackers to bypass the encryption protection mechanism.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2017-01-30T22:59:00.747",
    "last_modified": "2024-11-21T02:58:29.117",
    "fix_date": "2016-09-20T12:27:28Z"
  },
  "references": [
    {
      "url": "http://www.openwall.com/lists/oss-security/2016/09/19/9",
      "source": "cve@mitre.org",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2016/09/30/6",
      "source": "cve@mitre.org",
      "tags": [
        "Mailing List",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2016/10/01/2",
      "source": "cve@mitre.org",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.securityfocus.com/bid/93031",
      "source": "cve@mitre.org",
      "tags": [
        "Third Party Advisory",
        "VDB Entry"
      ]
    },
    {
      "url": "https://github.com/ruby/openssl/commit/8108e0a6db133f3375608303fdd2083eb5115062",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/ruby/openssl/issues/49",
      "source": "cve@mitre.org",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2018/07/msg00012.html",
      "source": "cve@mitre.org",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.debian.org/security/2017/dsa-3966",
      "source": "cve@mitre.org",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2016/09/19/9",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2016/09/30/6",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2016/10/01/2",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.securityfocus.com/bid/93031",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory",
        "VDB Entry"
      ]
    },
    {
      "url": "https://github.com/ruby/openssl/commit/8108e0a6db133f3375608303fdd2083eb5115062",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/ruby/openssl/issues/49",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2018/07/msg00012.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.debian.org/security/2017/dsa-3966",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T22:58:49.848683",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "openssl",
    "owner": "ruby",
    "created_at": "2014-10-27T02:12:48Z",
    "updated_at": "2025-01-14T12:38:15Z",
    "pushed_at": "2025-01-14T12:38:10Z",
    "size": 5014,
    "stars": 239,
    "forks": 171,
    "open_issues": 77,
    "watchers": 239,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "C": 763432,
      "Ruby": 482152
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T14:37:00.445048"
  }
}