{
  "cve_id": "CVE-2017-15278",
  "github_data": {
    "repository": "nilsteampassnet/TeamPass",
    "fix_commit": "f5a765381f051fe624386866ddb1f6b5e7eb929b",
    "related_commits": [
      "f5a765381f051fe624386866ddb1f6b5e7eb929b",
      "f5a765381f051fe624386866ddb1f6b5e7eb929b"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "f5a765381f051fe624386866ddb1f6b5e7eb929b",
      "commit_date": "2017-10-11T17:29:26Z",
      "author": {
        "login": "nilsteampassnet",
        "type": "User",
        "stats": {
          "total_commits": 2012,
          "average_weekly_commits": 2.9415204678362574,
          "total_additions": 5301385,
          "total_deletions": 4813706,
          "weeks_active": 411
        }
      },
      "commit_message": {
        "title": "2.1.27",
        "length": 157,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 152,
        "additions": 117,
        "deletions": 35
      },
      "files": [
        {
          "filename": "changelog.md",
          "status": "modified",
          "additions": 2,
          "deletions": 0,
          "patch": "@@ -9,8 +9,10 @@\n  Fixed some other security failures (credit to \u200bsecurity at Amossys)\n  Improved security regarding uploading files\n  Fixed issue while restoring DB from administration page\n+ Fixed \"PW copy to clipboard\" log unconsistency in specific case\n  Improved / Fixed administration task for encrypting/decrypting files\n  Improved security regarding item history display\n+ Improved the possibility to define the access level on Roles when creating new folder\n  Added filter in Roles\n  New: confirm deletion of attachment\n  #1956 Warning appears on Category and API pages in admin mode"
        },
        {
          "filename": "folders.load.php",
          "status": "modified",
          "additions": 12,
          "deletions": 2,
          "patch": "@@ -20,6 +20,7 @@\n <script type=\"text/javascript\">\n //<![CDATA[\n $(function() {\n+    $(\"#span_new_rep_roles\").hide();\n \n     //Launch the datatables pluggin\n     var tableFolders = $(\"#t_folders\").dataTable({\n@@ -61,7 +62,7 @@\n             $(\"#new_folder_wait\").hide();\n \n             //empty dialogbox\n-            $(\"#div_add_group input, #div_add_group select\").val(\"\");\n+            $(\"#div_add_group input, #div_add_group select, #new_rep_roles\").val(\"\");\n             $(\"#add_node_renewal_period\").val(\"0\");\n             $(\"#folder_block_modif, #folder_block_creation\").val(\"0\");\n             $(\"#parent_id\").val(\"na\");\n@@ -89,7 +90,8 @@\n                             \"parent_id\": $('#parent_id').val().replace(/\"/g,'&quot;') ,\n                             \"renewal_period\": $('#add_node_renewal_period').val().replace(/\"/g,'&quot;') ,\n                             \"block_creation\": $(\"#folder_block_creation\").val() ,\n-                            \"block_modif\": $(\"#folder_block_modif\").val()\n+                            \"block_modif\": $(\"#folder_block_modif\").val(),\n+                            \"access_level\": $(\"#new_rep_roles\").val()\n                         };\n \n                         //send query\n@@ -334,6 +336,14 @@ function(data) {\n     $(\"#click_refresh_folders_list\").click(function() {\n         tableFolders.api().ajax.reload();\n     });\n+\n+    $(\"#parent_id\").change(function() {\n+        if ($(this).val() === \"0\") {\n+            $(\"#span_new_rep_roles\").show();\n+        } else {\n+            $(\"#span_new_rep_roles\").hide();\n+        }\n+    })\n });\n \n "
        },
        {
          "filename": "folders.php",
          "status": "modified",
          "additions": 14,
          "deletions": 5,
          "patch": "@@ -116,33 +116,42 @@\n <div id=\"div_add_group\" style=\"display:none;\">\n     <div id=\"addgroup_show_error\" style=\"text-align:center;margin:2px;display:none;\" class=\"ui-state-error ui-corner-all\"></div>\n \n-    <label for=\"ajouter_groupe_titre\" class=\"label_cpm\">'.$LANG['group_title'].'</label>\n+    <label for=\"ajouter_groupe_titre\" class=\"label_cpm\">'.addslashes($LANG['group_title']).'</label>\n     <input type=\"text\" id=\"ajouter_groupe_titre\" class=\"input_text text ui-widget-content ui-corner-all\" />\n \n     <label for=\"parent_id\" class=\"label_cpm\">'.addslashes($LANG['group_parent']).'</label>\n     <select id=\"parent_id\" class=\"input_text text ui-widget-content ui-corner-all\">\n         '.$droplist.'\n     </select>\n \n-    <label for=\"new_rep_complexite\" class=\"label_cpm\">'.$LANG['complex_asked'].'</label>\n+    <label for=\"new_rep_complexite\" class=\"label_cpm\">'.addslashes($LANG['complex_asked']).'</label>\n     <select id=\"new_rep_complexite\" class=\"input_text text ui-widget-content ui-corner-all\">';\n foreach ($SETTINGS_EXT['pwComplexity'] as $complex) {\n     echo '<option value=\"'.$complex[0].'\">'.$complex[1].'</option>';\n }\n echo '\n     </select>\n \n-    <label for=\"add_node_renewal_period\" class=\"label_cpm\">'.$LANG['group_pw_duration'].'</label>\n+    <span id=\"span_new_rep_roles\">\n+    <label for=\"new_rep_roles\" class=\"label_cpm\">'.addslashes($LANG['access_level_for_roles']).'</label>\n+    <select id=\"new_rep_roles\" class=\"input_text text ui-widget-content ui-corner-all\">\n+        <option value=\"\">'.$LANG['no_access'].'</option>\n+        <option value=\"R\">'.$LANG['read'].'</option>\n+        <option value=\"W\">'.$LANG['write'].'</option>\n+    </select>\n+    </span>\n+\n+    <label for=\"add_node_renewal_period\" class=\"label_cpm\">'.addslashes($LANG['group_pw_duration']).'</label>\n     <input type=\"text\" id=\"add_node_renewal_period\" value=\"0\" class=\"input_text text ui-widget-content ui-corner-all\" />\n \n-    <label for=\"folder_block_creation\" class=\"\">'.$LANG['auth_creation_without_complexity'].'</label>\n+    <label for=\"folder_block_creation\" class=\"\">'.addslashes($LANG['auth_creation_without_complexity']).'</label>\n     <select id=\"folder_block_creation\" class=\"ui-widget-content ui-corner-all\">\n         <option value=\"0\">'.$LANG['no'].'</option>\n         <option value=\"1\">'.$LANG['yes'].'</option>\n     </select>\n \n     <div style=\"margin-top:10px;\">\n-        <label for=\"folder_block_modif\">'.$LANG['auth_modification_without_complexity'].'</label>\n+        <label for=\"folder_block_modif\">'.addslashes($LANG['auth_modification_without_complexity']).'</label>\n         <select id=\"folder_block_modif\" class=\"ui-widget-content ui-corner-all\">\n             <option value=\"0\">'.$LANG['no'].'</option>\n             <option value=\"1\">'.$LANG['yes'].'</option>"
        },
        {
          "filename": "includes/language/arabic.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -14,6 +14,7 @@\n  */\n global $LANG;\n $LANG = array (\n+    'access_level_for_roles' => 'Associated access for Roles',\n     'admin_script_backup_secret' => 'Passkey for backup execution',\n     'admin_script_backup_secret_tip' => 'The backup passkey needs to be provided to start the backup. It has to be added a key parameter to script.backup.php. Example:scripts.backup.php?key=your_passkey',\n     'text' => 'Text',"
        },
        {
          "filename": "includes/language/bulgarian.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -14,6 +14,7 @@\n  */\n global $LANG;\n $LANG = array (\n+    'access_level_for_roles' => 'Associated access for Roles',\n     'admin_script_backup_secret' => 'Passkey for backup execution',\n     'admin_script_backup_secret_tip' => 'The backup passkey needs to be provided to start the backup. It has to be added a key parameter to script.backup.php. Example:scripts.backup.php?key=your_passkey',\n     'text' => 'Text',"
        },
        {
          "filename": "includes/language/catalan.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -14,6 +14,7 @@\n  */\n global $LANG;\n $LANG = array (\n+    'access_level_for_roles' => 'Associated access for Roles',\n     'admin_script_backup_secret' => 'Passkey for backup execution',\n     'admin_script_backup_secret_tip' => 'The backup passkey needs to be provided to start the backup. It has to be added a key parameter to script.backup.php. Example:scripts.backup.php?key=your_passkey',\n     'text' => 'Text',"
        },
        {
          "filename": "includes/language/chinese.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -14,6 +14,7 @@\n  */\n global $LANG;\n $LANG = array (\n+    'access_level_for_roles' => 'Associated access for Roles',\n     'admin_script_backup_secret' => 'Passkey for backup execution',\n     'admin_script_backup_secret_tip' => 'The backup passkey needs to be provided to start the backup. It has to be added a key parameter to script.backup.php. Example:scripts.backup.php?key=your_passkey',\n     'text' => 'Text',"
        },
        {
          "filename": "includes/language/czech.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -14,6 +14,7 @@\n  */\n global $LANG;\n $LANG = array (\n+    'access_level_for_roles' => 'Associated access for Roles',\n     'admin_script_backup_secret' => 'Passkey for backup execution',\n     'admin_script_backup_secret_tip' => 'The backup passkey needs to be provided to start the backup. It has to be added a key parameter to script.backup.php. Example:scripts.backup.php?key=your_passkey',\n     'text' => 'Text',"
        },
        {
          "filename": "includes/language/dutch.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -14,6 +14,7 @@\n  */\n global $LANG;\n $LANG = array (\n+    'access_level_for_roles' => 'Associated access for Roles',\n     'admin_script_backup_secret' => 'Passkey for backup execution',\n     'admin_script_backup_secret_tip' => 'The backup passkey needs to be provided to start the backup. It has to be added a key parameter to script.backup.php. Example:scripts.backup.php?key=your_passkey',\n     'text' => 'Text',"
        },
        {
          "filename": "includes/language/english.php",
          "status": "modified",
          "additions": 2,
          "deletions": 1,
          "patch": "@@ -1,4 +1,4 @@\n-<?php \n+<?php\n /**\n  *\n  * @file          english.php\n@@ -14,6 +14,7 @@\n  */\n global $LANG;\n $LANG = array (\n+    'access_level_for_roles' => 'Associated access for Roles',\n     'admin_script_backup_secret' => 'Passkey for backup execution',\n     'admin_script_backup_secret_tip' => 'The backup passkey needs to be provided to start the backup. It has to be added a key parameter to script.backup.php. Example:scripts.backup.php?key=your_passkey',\n     'user_ga_code' => 'Email Google Authentication to user',"
        },
        {
          "filename": "includes/language/estonian.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -14,6 +14,7 @@\n  */\n global $LANG;\n $LANG = array (\n+    'access_level_for_roles' => 'Associated access for Roles',\n     'admin_script_backup_secret' => 'Passkey for backup execution',\n     'admin_script_backup_secret_tip' => 'The backup passkey needs to be provided to start the backup. It has to be added a key parameter to script.backup.php. Example:scripts.backup.php?key=your_passkey',\n     'text' => 'Text',"
        },
        {
          "filename": "includes/language/french.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -14,6 +14,7 @@\n  */\n global $LANG;\n $LANG = array (\n+    'access_level_for_roles' => 'Droit associ\u00e9 des Roles',\n     'user_ga_code' => 'Envoyer le code Google Authenticator \u00e0 l\\'utilisateur par email',\n     'send_ga_code' => 'Google Authenticator pour l\\'utilisateur',\n     'error_no_email' => 'Cet utilisateur n\\'a pas de courriel de d\u00e9fini !',"
        },
        {
          "filename": "includes/language/german.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -14,6 +14,7 @@\n  */\n global $LANG;\n $LANG = array (\n+    'access_level_for_roles' => 'Associated access for Roles',\n     'admin_script_backup_secret' => 'Passkey for backup execution',\n     'admin_script_backup_secret_tip' => 'The backup passkey needs to be provided to start the backup. It has to be added a key parameter to script.backup.php. Example:scripts.backup.php?key=your_passkey',\n     'text' => 'Text',"
        },
        {
          "filename": "includes/language/greek.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -14,6 +14,7 @@\n  */\n global $LANG;\n $LANG = array (\n+    'access_level_for_roles' => 'Associated access for Roles',\n     'admin_script_backup_secret' => 'Passkey for backup execution',\n     'admin_script_backup_secret_tip' => 'The backup passkey needs to be provided to start the backup. It has to be added a key parameter to script.backup.php. Example:scripts.backup.php?key=your_passkey',\n     'text' => 'Text',"
        },
        {
          "filename": "includes/language/hungarian.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -14,6 +14,7 @@\n  */\n global $LANG;\n $LANG = array (\n+    'access_level_for_roles' => 'Associated access for Roles',\n     'admin_script_backup_secret' => 'Passkey for backup execution',\n     'admin_script_backup_secret_tip' => 'The backup passkey needs to be provided to start the backup. It has to be added a key parameter to script.backup.php. Example:scripts.backup.php?key=your_passkey',\n     'text' => 'Text',"
        },
        {
          "filename": "includes/language/italian.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -14,6 +14,7 @@\n  */\n global $LANG;\n $LANG = array (\n+    'access_level_for_roles' => 'Associated access for Roles',\n     'admin_script_backup_secret' => 'Passkey for backup execution',\n     'admin_script_backup_secret_tip' => 'The backup passkey needs to be provided to start the backup. It has to be added a key parameter to script.backup.php. Example:scripts.backup.php?key=your_passkey',\n     'text' => 'Text',"
        },
        {
          "filename": "includes/language/japanese.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -14,6 +14,7 @@\n  */\n global $LANG;\n $LANG = array (\n+    'access_level_for_roles' => 'Associated access for Roles',\n     'admin_script_backup_secret' => 'Passkey for backup execution',\n     'admin_script_backup_secret_tip' => 'The backup passkey needs to be provided to start the backup. It has to be added a key parameter to script.backup.php. Example:scripts.backup.php?key=your_passkey',\n     'text' => 'Text',"
        },
        {
          "filename": "includes/language/norwegian.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -14,6 +14,7 @@\n  */\n global $LANG;\n $LANG = array (\n+    'access_level_for_roles' => 'Associated access for Roles',\n     'admin_script_backup_secret' => 'Passkey for backup execution',\n     'admin_script_backup_secret_tip' => 'The backup passkey needs to be provided to start the backup. It has to be added a key parameter to script.backup.php. Example:scripts.backup.php?key=your_passkey',\n     'text' => 'Text',"
        },
        {
          "filename": "includes/language/polish.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -14,6 +14,7 @@\n  */\n global $LANG;\n $LANG = array (\n+    'access_level_for_roles' => 'Associated access for Roles',\n     'admin_script_backup_secret' => 'Passkey for backup execution',\n     'admin_script_backup_secret_tip' => 'The backup passkey needs to be provided to start the backup. It has to be added a key parameter to script.backup.php. Example:scripts.backup.php?key=your_passkey',\n     'text' => 'Text',"
        },
        {
          "filename": "includes/language/portuguese.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -14,6 +14,7 @@\n  */\n global $LANG;\n $LANG = array (\n+    'access_level_for_roles' => 'Associated access for Roles',\n     'admin_script_backup_secret' => 'Passkey for backup execution',\n     'admin_script_backup_secret_tip' => 'The backup passkey needs to be provided to start the backup. It has to be added a key parameter to script.backup.php. Example:scripts.backup.php?key=your_passkey',\n     'text' => 'Text',"
        },
        {
          "filename": "includes/language/portuguese_br.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -14,6 +14,7 @@\n  */\n global $LANG;\n $LANG = array (\n+    'access_level_for_roles' => 'Associated access for Roles',\n     'admin_script_backup_secret' => 'Passkey for backup execution',\n     'admin_script_backup_secret_tip' => 'The backup passkey needs to be provided to start the backup. It has to be added a key parameter to script.backup.php. Example:scripts.backup.php?key=your_passkey',\n     'text' => 'Text',"
        },
        {
          "filename": "includes/language/romanian.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -14,6 +14,7 @@\n  */\n global $LANG;\n $LANG = array (\n+    'access_level_for_roles' => 'Associated access for Roles',\n     'admin_script_backup_secret' => 'Passkey for backup execution',\n     'admin_script_backup_secret_tip' => 'The backup passkey needs to be provided to start the backup. It has to be added a key parameter to script.backup.php. Example:scripts.backup.php?key=your_passkey',\n     'text' => 'Text',"
        },
        {
          "filename": "includes/language/russian.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -14,6 +14,7 @@\n  */\n global $LANG;\n $LANG = array (\n+    'access_level_for_roles' => 'Associated access for Roles',\n     'admin_script_backup_secret' => 'Passkey for backup execution',\n     'admin_script_backup_secret_tip' => 'The backup passkey needs to be provided to start the backup. It has to be added a key parameter to script.backup.php. Example:scripts.backup.php?key=your_passkey',\n     'text' => 'Text',"
        },
        {
          "filename": "includes/language/spanish.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -14,6 +14,7 @@\n  */\n global $LANG;\n $LANG = array (\n+    'access_level_for_roles' => 'Associated access for Roles',\n     'admin_script_backup_secret' => 'Passkey for backup execution',\n     'admin_script_backup_secret_tip' => 'The backup passkey needs to be provided to start the backup. It has to be added a key parameter to script.backup.php. Example:scripts.backup.php?key=your_passkey',\n     'text' => 'Text',"
        },
        {
          "filename": "includes/language/swedish.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -14,6 +14,7 @@\n  */\n global $LANG;\n $LANG = array (\n+    'access_level_for_roles' => 'Associated access for Roles',\n     'admin_script_backup_secret' => 'Passkey for backup execution',\n     'admin_script_backup_secret_tip' => 'The backup passkey needs to be provided to start the backup. It has to be added a key parameter to script.backup.php. Example:scripts.backup.php?key=your_passkey',\n     'text' => 'Text',"
        },
        {
          "filename": "includes/language/turkish.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -14,6 +14,7 @@\n  */\n global $LANG;\n $LANG = array (\n+    'access_level_for_roles' => 'Associated access for Roles',\n     'admin_script_backup_secret' => 'Passkey for backup execution',\n     'admin_script_backup_secret_tip' => 'The backup passkey needs to be provided to start the backup. It has to be added a key parameter to script.backup.php. Example:scripts.backup.php?key=your_passkey',\n     'text' => 'Text',"
        },
        {
          "filename": "includes/language/ukrainian.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -14,6 +14,7 @@\n  */\n global $LANG;\n $LANG = array (\n+    'access_level_for_roles' => 'Associated access for Roles',\n     'admin_script_backup_secret' => 'Passkey for backup execution',\n     'admin_script_backup_secret_tip' => 'The backup passkey needs to be provided to start the backup. It has to be added a key parameter to script.backup.php. Example:scripts.backup.php?key=your_passkey',\n     'text' => 'Text',"
        },
        {
          "filename": "includes/language/vietnamese.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -14,6 +14,7 @@\n  */\n global $LANG;\n $LANG = array (\n+    'access_level_for_roles' => 'Associated access for Roles',\n     'admin_script_backup_secret' => 'Passkey for backup execution',\n     'admin_script_backup_secret_tip' => 'The backup passkey needs to be provided to start the backup. It has to be added a key parameter to script.backup.php. Example:scripts.backup.php?key=your_passkey',\n     'text' => 'Text',"
        },
        {
          "filename": "items.load.php",
          "status": "modified",
          "additions": 6,
          "deletions": 4,
          "patch": "@@ -3932,15 +3932,17 @@ function() {\n /*\n * permits to save\n */\n-function itemLog(log_case)\n+function itemLog(log_case, item_id)\n {\n+    console.log(\"> \"+item_id);\n+    item_id = item_id || $('#id_item').val();\n     $.post(\n         \"sources/items.logs.php\",\n         {\n             type        : log_case,\n-            id_item     : $('#id_item').val(),\n+            id_item     : item_id,\n             folder_id   : $('#hid_cat').val(),\n-        hid_label   : $('#hid_label').val(),\n+            hid_label   : $('#hid_label').val(),\n             key         : \"<?php echo $_SESSION['key']; ?>\"\n         }\n     );\n@@ -4025,7 +4027,7 @@ function proceed_list_update(stop_proceeding)\n         var clipboard = new Clipboard('.mini_pw');\n         clipboard.on('success', function(e) {\n             $(\"#message_box\").html(\"<?php echo addslashes($LANG['pw_copied_clipboard']); ?>\").show().fadeOut(1000);\n-            itemLog(\"item_password_copied\");\n+            itemLog(\"item_password_copied\", e.trigger.dataset.clipboardId);\n             e.clearSelection();\n         });\n "
        },
        {
          "filename": "profile.php",
          "status": "modified",
          "additions": 12,
          "deletions": 0,
          "patch": "@@ -92,6 +92,16 @@\n     $arraFlags[$record['label']] = $record['label'];\n }\n \n+// Prepare Headers\n+header('Access-Control-Allow-Origin: *');\n+echo '\n+<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n+<html>\n+    <head>\n+        <title>User Profile</title>\n+    </head>\n+<body>';\n+\n echo '\n <input type=\"hidden\" id=\"profile_user_token\" value=\"\" />\n <table style=\"margin-left:7px;\">\n@@ -717,3 +727,5 @@ function(data){\n     );\n }\n </script>\n+</body>\n+</html>"
        },
        {
          "filename": "sources/folders.queries.php",
          "status": "modified",
          "additions": 40,
          "deletions": 21,
          "patch": "@@ -438,6 +438,19 @@\n             $complexity = htmlspecialchars_decode($dataReceived['complexity']);\n             $parentId = htmlspecialchars_decode($dataReceived['parent_id']);\n             $renewalPeriod = htmlspecialchars_decode($dataReceived['renewal_period']);\n+            if ($parentId === \"0\") {\n+                if (isset($dataReceived['access_level']) === true) {\n+                    $access_level_by_role = filter_var(htmlspecialchars_decode($dataReceived['access_level']), FILTER_SANITIZE_STRING);\n+                } else {\n+                    if ($_SESSION['user_manager'] === \"1\") {\n+                        $access_level_by_role = \"W\";\n+                    } else {\n+                        $access_level_by_role = \"\";\n+                    }\n+                }\n+            } else {\n+                $access_level_by_role = \"\";\n+            }\n \n             //Check if title doesn't contains html codes\n             if (preg_match_all(\"|<[^>]+>(.*)</[^>]+>|U\", $title, $out)) {\n@@ -544,46 +557,52 @@\n                     $tree = new Tree\\NestedTree\\NestedTree(prefix_table(\"nested_tree\"), 'id', 'parent_id', 'title');\n                     $tree->rebuild();\n \n-                    if ($isPersonal !== 1\n-                        && isset($SETTINGS['subfolder_rights_as_parent'])\n-                        && $SETTINGS['subfolder_rights_as_parent'] === 1\n-                        || ($isPersonal !== 1 && $parentId === \"0\")\n-                    ) {\n+                    // Add right to see this folder\n+                    if ($_SESSION['is_admin'] === \"1\" || $_SESSION['user_manager'] === \"1\") {\n                         //Get user's rights\n                         identifyUserRights(\n-                            array_push($_SESSION['groupes_visibles'], $newId),\n+                            $_SESSION['groupes_visibles'],\n                             implode(\";\", $_SESSION['groupes_interdits']),\n                             $_SESSION['is_admin'],\n-                            $_SESSION['fonction_id']\n+                            is_array($_SESSION['fonction_id']) === true ? implode(\";\", $_SESSION['fonction_id']) : $_SESSION['fonction_id']\n                         );\n+                    }\n \n+                    if ($isPersonal !== 1\n+                        && $parentId === \"0\"\n+                    ) {\n                         //add access to this new folder\n                         foreach (explode(';', $_SESSION['fonction_id']) as $role) {\n-                            if (!empty($role)) {\n+                            if (empty($role) === false && empty($access_level_by_role) === false) {\n                                 DB::insert(\n                                     prefix_table(\"roles_values\"),\n                                     array(\n                                         'role_id' => $role,\n                                         'folder_id' => $newId,\n-                                        'type' => \"W\"\n+                                        'type' => $access_level_by_role\n                                     )\n                                 );\n                             }\n                         }\n                     }\n \n-                    //If it is a subfolder, then give access to it for all roles that allows the parent folder\n-                    $rows = DB::query(\"SELECT role_id, type FROM \".prefix_table(\"roles_values\").\" WHERE folder_id = %i\", $parentId);\n-                    foreach ($rows as $record) {\n-                        //add access to this subfolder\n-                        DB::insert(\n-                            prefix_table(\"roles_values\"),\n-                            array(\n-                                'role_id' => $record['role_id'],\n-                                'folder_id' => $newId,\n-                                'type' => $record['type']\n-                            )\n-                        );\n+\n+                    if (isset($SETTINGS['subfolder_rights_as_parent']) === true\n+                        && $SETTINGS['subfolder_rights_as_parent'] === \"1\"\n+                    ) {\n+                        //If it is a subfolder, then give access to it for all roles that allows the parent folder\n+                        $rows = DB::query(\"SELECT role_id, type FROM \".prefix_table(\"roles_values\").\" WHERE folder_id = %i\", $parentId);\n+                        foreach ($rows as $record) {\n+                            //add access to this subfolder\n+                            DB::insert(\n+                                prefix_table(\"roles_values\"),\n+                                array(\n+                                    'role_id' => $record['role_id'],\n+                                    'folder_id' => $newId,\n+                                    'type' => $record['type']\n+                                )\n+                            );\n+                        }\n                     }\n \n                     // if parent folder has Custom Fields Categories then add to this child one too"
        },
        {
          "filename": "sources/items.queries.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -2695,7 +2695,7 @@\n                                     $new_line .= '<i class=\"fa fa-sm fa-user mi-black mini_login\" data-clipboard-text=\"'.strtr($record['login'], '\"', \"&quot;\").'\" title=\"'.$LANG['item_menu_copy_login'].'\"></i>&nbsp;';\n                                 }\n                                 if (empty($pw) === false) {\n-                                    $new_line .= '<i class=\"fa fa-sm fa-lock mi-black mini_pw\" data-clipboard-text=\"'.strtr($pw, '\"', \"&quot;\").'\" title=\"'.$LANG['item_menu_copy_pw'].'\"></i>&nbsp;';\n+                                    $new_line .= '<i class=\"fa fa-sm fa-lock mi-black mini_pw\" data-clipboard-text=\"'.strtr($pw, '\"', \"&quot;\").'\" title=\"'.$LANG['item_menu_copy_pw'].'\" data-clipboard-id=\"'.$record['id'].'\"></i>&nbsp;';\n                                 }\n                             }\n                         }"
        },
        {
          "filename": "sources/main.functions.php",
          "status": "modified",
          "additions": 4,
          "deletions": 1,
          "patch": "@@ -510,6 +510,9 @@ function defuse_return_decrypted($value)\n function trimElement($chaine, $element)\n {\n     if (!empty($chaine)) {\n+        if (is_array($chaine) === true) {\n+            $chaine = implode(\";\", $chaine);\n+        }\n         $chaine = trim($chaine);\n         if (substr($chaine, 0, 1) == $element) {\n             $chaine = substr($chaine, 1);\n@@ -658,7 +661,7 @@ function identifyUserRights($groupesVisiblesUser, $groupesInterditsUser, $isAdmi\n         $_SESSION['read_only_folders'] = array();\n         $_SESSION['fonction_id'] = $idFonctions;\n         $groupesInterdits = array();\n-        if (!is_array($groupesInterditsUser)) {\n+        if (is_array($groupesInterditsUser) === false) {\n             $groupesInterditsUser = explode(';', trimElement($groupesInterditsUser, \";\"));\n         }\n         if (!empty($groupesInterditsUser) && count($groupesInterditsUser) > 0) {"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 3,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "aacdf6a3f2daf9b52a826d4b3d8a39873e2e2062",
            "date": "2025-01-13T17:24:23Z",
            "author_login": "nilsteampassnet"
          },
          {
            "sha": "eb95bc3e37f6e1f19fce98aa4c44c251f2084cd7",
            "date": "2025-01-13T17:20:31Z",
            "author_login": "nilsteampassnet"
          },
          {
            "sha": "9969d0ef636e28c1afcdb047aac2d2a5387b62b5",
            "date": "2025-01-12T17:29:37Z",
            "author_login": "nilsteampassnet"
          },
          {
            "sha": "4963736272bc4b281586f8ad4dcee70015d595b1",
            "date": "2025-01-12T17:22:24Z",
            "author_login": "nilsteampassnet"
          },
          {
            "sha": "b5a997952a43e4760c9eaceedfd9a7ba4a5683d2",
            "date": "2025-01-10T16:06:22Z",
            "author_login": "nilsteampassnet"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": null,
    "cvss_vector": null,
    "cwe_id": "CWE-79",
    "description": "Cross-Site Scripting (XSS) was discovered in TeamPass before 2.1.27.9. The vulnerability exists due to insufficient filtration of data (in /sources/folders.queries.php). An attacker could execute arbitrary HTML and script code in a browser in the context of the vulnerable website.",
    "attack_vector": null,
    "attack_complexity": null
  },
  "temporal_data": {
    "published_date": "2017-10-12T08:29:00.353",
    "last_modified": "2024-11-21T03:14:22.390",
    "fix_date": "2017-10-11T17:29:26Z"
  },
  "references": [
    {
      "url": "https://github.com/nilsteampassnet/TeamPass/blob/master/changelog.md",
      "source": "cve@mitre.org",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/nilsteampassnet/TeamPass/commit/f5a765381f051fe624386866ddb1f6b5e7eb929b",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/nilsteampassnet/TeamPass/releases/tag/2.1.27.9",
      "source": "cve@mitre.org",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/nilsteampassnet/TeamPass/blob/master/changelog.md",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/nilsteampassnet/TeamPass/commit/f5a765381f051fe624386866ddb1f6b5e7eb929b",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/nilsteampassnet/TeamPass/releases/tag/2.1.27.9",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T22:59:07.418384",
    "processing_status": "enhanced"
  }
}