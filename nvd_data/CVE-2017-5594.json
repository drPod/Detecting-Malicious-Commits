{
  "cve_id": "CVE-2017-5594",
  "github_data": {
    "repository": "pagekit/pagekit",
    "fix_commit": "e0454f9c037c427a5ff76a57e78dbf8cc00c268b",
    "related_commits": [
      "e0454f9c037c427a5ff76a57e78dbf8cc00c268b",
      "e0454f9c037c427a5ff76a57e78dbf8cc00c268b"
    ],
    "patch_url": "https://github.com/pagekit/pagekit/commit/e0454f9c037c427a5ff76a57e78dbf8cc00c268b.patch",
    "fix_commit_details": {
      "sha": "e0454f9c037c427a5ff76a57e78dbf8cc00c268b",
      "commit_date": "2017-01-20T13:15:58Z",
      "author": {
        "login": "malte-christian",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Merge branch 'release/1.0.11'",
        "length": 29,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 43,
        "additions": 29,
        "deletions": 14
      },
      "files": [
        {
          "filename": "CHANGELOG.md",
          "status": "modified",
          "additions": 5,
          "deletions": 0,
          "patch": "@@ -1,5 +1,10 @@\n # Changelog\n \n+## 1.0.11 (January 20, 2017)\n+\n+### Security\n+- Fixed replay attack with password reset links when debug toolbar is enabled, discovered by SecureLayer7 \n+\n ## 1.0.10 (December 22, 2016)\n \n ### Fixed"
        },
        {
          "filename": "app/system/config.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -4,7 +4,7 @@\n \n     'application' => [\n \n-        'version' => '1.0.10'\n+        'version' => '1.0.11'\n \n     ],\n "
        },
        {
          "filename": "app/system/modules/settings/app/components/system.vue",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -34,6 +34,7 @@\n                 <label><input type=\"checkbox\" value=\"1\" v-model=\"$root.config.debug.enabled\" :disabled=\"!sqlite\"> {{ 'Enable debug toolbar' | trans }}</label>\n             </p>\n             <p class=\"uk-form-help-block\" v-if=\"!sqlite\">{{ 'Please enable the SQLite database extension.' | trans }}</p>\n+            <p class=\"uk-form-help-block\" v-if=\"$root.config.application.debug || $root.config.debug.enabled\">{{ 'Please note that enabling debug mode or toolbar has serious security implications.' | trans }}</p>\n         </div>\n     </div>\n "
        },
        {
          "filename": "app/system/modules/user/src/Controller/ResetPasswordController.php",
          "status": "modified",
          "additions": 21,
          "deletions": 12,
          "patch": "@@ -25,7 +25,7 @@ public function indexAction()\n     }\n \n     /**\n-     * @Request({\"email\": \"string\"})\n+     * @Request({\"email\"})\n      */\n     public function requestAction($email)\n     {\n@@ -51,9 +51,8 @@ public function requestAction($email)\n                 throw new Exception(__('Your account has not been activated or is blocked.'));\n             }\n \n-            $user->activation = App::get('auth.random')->generateString(32);\n-\n-            $url = App::url('@user/resetpassword/confirm', ['user' => $user->username, 'key' => $user->activation], 0);\n+            $key = App::get('auth.random')->generateString(32);\n+            $url = App::url('@user/resetpassword/confirm', compact('key'), 0);\n \n             try {\n \n@@ -67,6 +66,7 @@ public function requestAction($email)\n                 throw new Exception(__('Unable to send confirmation link.'));\n             }\n \n+            $user->activation = $key;\n             $user->save();\n \n             App::message()->success(__('Check your email for the confirmation link.'));\n@@ -85,15 +85,26 @@ public function requestAction($email)\n     }\n \n     /**\n-     * @Request({\"user\", \"key\"})\n+     * @Request({\"key\", \"password\"})\n      */\n-    public function confirmAction($username = \"\", $activation = \"\")\n+    public function confirmAction($activation = '', $password = '')\n     {\n-        if (empty($username) || empty($activation) || !$user = User::where(compact('username', 'activation'))->first()) {\n+        if ($activation and $user = User::where(compact('activation'))->first()) {\n+\n+            App::session()->set('activation', [\n+                'key' => $activation,\n+                'user' => $user->id,\n+            ]);\n+\n+            $user->activation = null;\n+            $user->save();\n+        }\n+\n+        if (!$data = App::session()->get('activation') or $data['key'] != $activation) {\n             App::abort(400, __('Invalid key.'));\n         }\n \n-        if ($user->isBlocked()) {\n+        if (!$user = User::find($data['user']) or $user->isBlocked()) {\n             App::abort(400, __('Your account has not been activated or is blocked.'));\n         }\n \n@@ -105,8 +116,6 @@ public function confirmAction($username = \"\", $activation = \"\")\n                     throw new Exception(__('Invalid token. Please try again.'));\n                 }\n \n-                $password = App::request()->request->get('password');\n-\n                 if (empty($password)) {\n                     throw new Exception(__('Enter password.'));\n                 }\n@@ -115,10 +124,11 @@ public function confirmAction($username = \"\", $activation = \"\")\n                     throw new Exception(__('Invalid password.'));\n                 }\n \n-                $user->password = App::get('auth.password')->hash($password);\n                 $user->activation = null;\n+                $user->password = App::get('auth.password')->hash($password);\n                 $user->save();\n \n+                App::session()->remove('activation');\n                 App::message()->success(__('Your password has been reset.'));\n \n                 return App::redirect('@user/login');\n@@ -133,7 +143,6 @@ public function confirmAction($username = \"\", $activation = \"\")\n                 'title' => __('Reset Confirm'),\n                 'name' => 'system/user/reset-confirm.php'\n             ],\n-            'username' => $username,\n             'activation' => $activation,\n             'error' => isset($error) ? $error : ''\n         ];"
        },
        {
          "filename": "app/system/modules/user/views/reset-confirm.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -1,6 +1,6 @@\n <?php $view->script('uikit-form-password') ?>\n \n-<form class=\"pk-user pk-user-reset uk-form uk-form-stacked uk-width-medium-1-2 uk-width-large-1-3 uk-container-center\" action=\"<?= $view->url('@user/resetpassword/confirm', ['user' => $username, 'key' => $activation]) ?>\" method=\"post\">\n+<form class=\"pk-user pk-user-reset uk-form uk-form-stacked uk-width-medium-1-2 uk-width-large-1-3 uk-container-center\" action=\"<?= $view->url('@user/resetpassword/confirm', ['key' => $activation]) ?>\" method=\"post\">\n \n     <?php if($error): ?>\n     <div class=\"uk-alert uk-alert-danger\">"
        }
      ],
      "file_patterns": {
        "security_files": 1,
        "config_files": 2,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 5,
        "max_directory_depth": 6
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "6fc7aa13653a35c29217d031d8ab09b2a1124f2d",
            "date": "2020-01-20T14:57:36Z",
            "author_login": "malte-christian"
          },
          {
            "sha": "9f1c03940b2c34fe5a25d213c26705c930478a8d",
            "date": "2020-01-20T14:56:29Z",
            "author_login": "malte-christian"
          },
          {
            "sha": "3b61be14f936019746721b32a25d33237fdfcf67",
            "date": "2020-01-20T14:54:16Z",
            "author_login": "malte-christian"
          },
          {
            "sha": "cd827f35f7f502bac2857afa2503697d029abf9b",
            "date": "2020-01-20T14:46:48Z",
            "author_login": "malte-christian"
          },
          {
            "sha": "dbff4d4ea374af7edda037d4fc979a9212db3ef3",
            "date": "2019-07-11T11:39:58Z",
            "author_login": "malte-christian"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 7.5,
    "cvss_vector": "CVSS:3.1/AV:N/AC:H/PR:N/UI:R/S:U/C:H/I:H/A:H",
    "cwe_id": "CWE-640",
    "description": "An issue was discovered in Pagekit CMS before 1.0.11. In this vulnerability the remote attacker is able to reset the registered user's password, when the debug toolbar is enabled. The password is successfully recovered using this exploit. The SecureLayer7 ID is SL7_PGKT_01.",
    "attack_vector": "NETWORK",
    "attack_complexity": "HIGH"
  },
  "temporal_data": {
    "published_date": "2017-01-25T18:59:00.153",
    "last_modified": "2024-11-21T03:27:57.580",
    "fix_date": "2017-01-20T13:15:58Z"
  },
  "references": [
    {
      "url": "http://www.securityfocus.com/bid/95806",
      "source": "cve@mitre.org",
      "tags": [
        "Third Party Advisory",
        "VDB Entry"
      ]
    },
    {
      "url": "https://github.com/pagekit/pagekit/commit/e0454f9c037c427a5ff76a57e78dbf8cc00c268b",
      "source": "cve@mitre.org",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://securelayer7.net/download/pdf/SecureLayer7-Pentest-report-Pagekit-CMS.pdf",
      "source": "cve@mitre.org",
      "tags": [
        "Technical Description",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://securelayer7.net/download/poc/password-reset-vulnerability-exploit-ruby-pagekit-cms.rb.txt",
      "source": "cve@mitre.org",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.exploit-db.com/exploits/41143/",
      "source": "cve@mitre.org",
      "tags": [
        "Exploit",
        "Third Party Advisory",
        "VDB Entry"
      ]
    },
    {
      "url": "http://www.securityfocus.com/bid/95806",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory",
        "VDB Entry"
      ]
    },
    {
      "url": "https://github.com/pagekit/pagekit/commit/e0454f9c037c427a5ff76a57e78dbf8cc00c268b",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://securelayer7.net/download/pdf/SecureLayer7-Pentest-report-Pagekit-CMS.pdf",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Technical Description",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://securelayer7.net/download/poc/password-reset-vulnerability-exploit-ruby-pagekit-cms.rb.txt",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.exploit-db.com/exploits/41143/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Third Party Advisory",
        "VDB Entry"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T22:58:49.843651",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "pagekit",
    "owner": "pagekit",
    "created_at": "2014-03-06T17:30:55Z",
    "updated_at": "2025-01-13T15:17:58Z",
    "pushed_at": "2022-09-30T19:04:02Z",
    "size": 16759,
    "stars": 5513,
    "forks": 648,
    "open_issues": 178,
    "watchers": 5513,
    "has_security_policy": false,
    "default_branch": "develop",
    "protected_branches": [],
    "languages": {
      "PHP": 2633202,
      "JavaScript": 164724,
      "Vue": 161125,
      "CSS": 152490,
      "HTML": 6669
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-14T16:19:35.248780"
  }
}