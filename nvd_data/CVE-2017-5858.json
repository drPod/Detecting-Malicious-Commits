{
  "cve_id": "CVE-2017-5858",
  "github_data": {
    "repository": "jcbrand/converse.js",
    "fix_commit": "42f249cabbbf5c026398e6d3b350f6f9536ea572",
    "related_commits": [
      "42f249cabbbf5c026398e6d3b350f6f9536ea572",
      "42f249cabbbf5c026398e6d3b350f6f9536ea572"
    ],
    "patch_url": "https://github.com/jcbrand/converse.js/commit/42f249cabbbf5c026398e6d3b350f6f9536ea572.patch",
    "fix_commit_details": {
      "sha": "42f249cabbbf5c026398e6d3b350f6f9536ea572",
      "commit_date": "2017-01-31T22:18:26Z",
      "author": {
        "login": "jcbrand",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Prevent forging of messages via carbons.",
        "length": 40,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 55,
        "additions": 53,
        "deletions": 2
      },
      "files": [
        {
          "filename": "docs/CHANGES.md",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -10,6 +10,7 @@\n - Bugfix. Login form wasn't rendered after logging out (when `auto_reconnect` is `true`). [jcbrand]\n - Bugfix. Properly disconnect upon \"host-unknown\" error. [jcbrand]\n - Bugfix. Minimized chats weren't removed when logging out. [jcbrand]\n+- Security fix: Prevent message forging via carbons. (Thanks to ge0rg) [jcbrand]\n \n ## 2.0.4 (2016-12-13)\n - #737: Bugfix. Translations weren't being applied. [jcbrand]"
        },
        {
          "filename": "spec/chatbox.js",
          "status": "modified",
          "additions": 44,
          "deletions": 1,
          "patch": "@@ -766,7 +766,7 @@\n                     var msgtext = 'This is a carbon message';\n                     var sender_jid = mock.cur_names[1].replace(/ /g,'.').toLowerCase() + '@localhost';\n                     var msg = $msg({\n-                            'from': converse.bare_jid,\n+                            'from': sender_jid,\n                             'id': (new Date()).getTime(),\n                             'to': converse.connection.jid,\n                             'type': 'chat',\n@@ -844,6 +844,49 @@\n                     expect(msg_txt).toEqual(msgtext);\n                 }));\n \n+                it(\"will be discarded if it's a malicious message meant to look like a carbon copy\", mock.initConverse(function (converse) {\n+                    test_utils.createContacts(converse, 'current');\n+                    test_utils.openControlBox();\n+                    test_utils.openContactsPanel(converse);\n+                    /* <message from=\"mallory@evil.example\" to=\"b@xmpp.example\">\n+                     *    <received xmlns='urn:xmpp:carbons:2'>\n+                     *      <forwarded xmlns='urn:xmpp:forward:0'>\n+                     *          <message from=\"alice@xmpp.example\" to=\"bob@xmpp.example/client1\">\n+                     *              <body>Please come to Creepy Valley tonight, alone!</body>\n+                     *          </message>\n+                     *      </forwarded>\n+                     *    </received>\n+                     * </message>\n+                     */\n+                    spyOn(converse, 'log');\n+                    var msgtext = 'Please come to Creepy Valley tonight, alone!';\n+                    var sender_jid = mock.cur_names[1].replace(/ /g,'.').toLowerCase() + '@localhost';\n+                    var impersonated_jid = mock.cur_names[2].replace(/ /g,'.').toLowerCase() + '@localhost';\n+                    var msg = $msg({\n+                            'from': sender_jid,\n+                            'id': (new Date()).getTime(),\n+                            'to': converse.connection.jid,\n+                            'type': 'chat',\n+                            'xmlns': 'jabber:client'\n+                        }).c('received', {'xmlns': 'urn:xmpp:carbons:2'})\n+                          .c('forwarded', {'xmlns': 'urn:xmpp:forward:0'})\n+                          .c('message', {\n+                                'xmlns': 'jabber:client',\n+                                'from': impersonated_jid,\n+                                'to': converse.connection.jid,\n+                                'type': 'chat'\n+                        }).c('body').t(msgtext).tree();\n+                    converse.chatboxes.onMessage(msg);\n+\n+                    // Check that chatbox for impersonated user is not created.\n+                    var chatbox = converse.chatboxes.get(impersonated_jid);\n+                    expect(chatbox).not.toBeDefined();\n+\n+                    // Check that the chatbox for the malicous user is not created\n+                    chatbox = converse.chatboxes.get(sender_jid);\n+                    expect(chatbox).not.toBeDefined();\n+                }));\n+\n                 it(\"received for a minimized chat box will increment a counter on its header\", mock.initConverse(function (converse) {\n                     test_utils.createContacts(converse, 'current');\n                     test_utils.openControlBox();"
        },
        {
          "filename": "src/converse-core.js",
          "status": "modified",
          "additions": 8,
          "deletions": 1,
          "patch": "@@ -1447,7 +1447,14 @@\n                 }\n                 $forwarded = $message.find('forwarded');\n                 if ($forwarded.length) {\n-                    $message = $forwarded.children('message');\n+                    var $forwarded_message = $forwarded.children('message');\n+                    if (Strophe.getBareJidFromJid($forwarded_message.attr('from')) !== from_jid) {\n+                        // Prevent message forging via carbons\n+                        //\n+                        // https://xmpp.org/extensions/xep-0280.html#security\n+                        return true;\n+                    }\n+                    $message = $forwarded_message;\n                     $delay = $forwarded.children('delay');\n                     from_jid = $message.attr('from');\n                     to_jid = $message.attr('to');"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 3,
        "max_directory_depth": 1
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "6e4ad8de3df4187c21fad294b267cea4e1946c18",
            "date": "2025-01-12T19:39:29Z",
            "author_login": "jcbrand"
          },
          {
            "sha": "cff07d779cdeb626e6d3f9b6e0e13556110f4b1b",
            "date": "2022-10-26T08:20:37Z",
            "author_login": "jcbrand"
          },
          {
            "sha": "ed82a023adbe6ed379168f0fab78655c3f82fce9",
            "date": "2025-01-10T22:54:01Z",
            "author_login": "jcbrand"
          },
          {
            "sha": "30e6d844f3a938d6e6027741309143f623871f0a",
            "date": "2025-01-10T21:47:40Z",
            "author_login": "jcbrand"
          },
          {
            "sha": "a980dd01187f4819520988a72c64583e2de2a123",
            "date": "2025-01-10T22:24:47Z",
            "author_login": "jcbrand"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": null,
    "cvss_vector": null,
    "cwe_id": "CWE-20",
    "description": "An incorrect implementation of \"XEP-0280: Message Carbons\" in multiple XMPP clients allows a remote attacker to impersonate any user, including contacts, in the vulnerable application's display. This allows for various kinds of social engineering attacks. This CVE is for Converse.js (0.8.0 - 1.0.6, 2.0.0 - 2.0.4).",
    "attack_vector": null,
    "attack_complexity": null
  },
  "temporal_data": {
    "published_date": "2017-02-09T20:59:00.577",
    "last_modified": "2024-11-21T03:28:32.940",
    "fix_date": "2017-01-31T22:18:26Z"
  },
  "references": [
    {
      "url": "http://openwall.com/lists/oss-security/2017/02/09/29",
      "source": "cve@mitre.org",
      "tags": [
        "Exploit",
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.securityfocus.com/bid/96183",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "https://github.com/jcbrand/converse.js/commit/42f249cabbbf5c026398e6d3b350f6f9536ea572",
      "source": "cve@mitre.org",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://rt-solutions.de/en/2017/02/CVE-2017-5589_xmpp_carbons/",
      "source": "cve@mitre.org",
      "tags": [
        "Exploit",
        "Technical Description",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://rt-solutions.de/wp-content/uploads/2017/02/CVE-2017-5589_xmpp_carbons.pdf",
      "source": "cve@mitre.org",
      "tags": [
        "Exploit",
        "Technical Description",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://openwall.com/lists/oss-security/2017/02/09/29",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.securityfocus.com/bid/96183",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://github.com/jcbrand/converse.js/commit/42f249cabbbf5c026398e6d3b350f6f9536ea572",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://rt-solutions.de/en/2017/02/CVE-2017-5589_xmpp_carbons/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Technical Description",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://rt-solutions.de/wp-content/uploads/2017/02/CVE-2017-5589_xmpp_carbons.pdf",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Technical Description",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T22:58:52.219101",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "converse.js",
    "owner": "jcbrand",
    "created_at": "2012-07-21T09:14:22Z",
    "updated_at": "2025-01-12T20:18:46Z",
    "pushed_at": "2025-01-14T16:18:53Z",
    "size": 312447,
    "stars": 3103,
    "forks": 776,
    "open_issues": 288,
    "watchers": 3103,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "JavaScript": 3195776,
      "SCSS": 166627,
      "HTML": 39898,
      "TypeScript": 17637,
      "Makefile": 9157,
      "CSS": 59
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "mpl-2.0"
    },
    "collected_at": "2025-01-14T21:58:47.252899"
  }
}