{
  "cve_id": "CVE-2017-7481",
  "github_data": {
    "repository": "ansible/ansible",
    "fix_commit": "ed56f51f185a1ffd7ea57130d260098686fcc7c2",
    "related_commits": [
      "ed56f51f185a1ffd7ea57130d260098686fcc7c2",
      "ed56f51f185a1ffd7ea57130d260098686fcc7c2"
    ],
    "patch_url": "https://github.com/ansible/ansible/commit/ed56f51f185a1ffd7ea57130d260098686fcc7c2.patch",
    "fix_commit_details": {
      "sha": "ed56f51f185a1ffd7ea57130d260098686fcc7c2",
      "commit_date": "2017-05-08T15:37:10Z",
      "author": {
        "login": "jimi-c",
        "type": "User",
        "stats": {
          "total_commits": 2825,
          "average_weekly_commits": 4.178994082840236,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 212
        }
      },
      "commit_message": {
        "title": "Fixing security issue with lookup returns not tainting the jinja2 environment",
        "length": 564,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 34,
        "additions": 31,
        "deletions": 3
      },
      "files": [
        {
          "filename": "docs/docsite/rst/intro_configuration.rst",
          "status": "modified",
          "additions": 14,
          "deletions": 0,
          "patch": "@@ -86,6 +86,20 @@ different locations::\n Most users will not need to use this feature.  See :doc:`dev_guide/developing_plugins` for more details.\n \n \n+.. _allow_unsafe_lookups:\n+\n+allow_unsafe_lookups\n+====================\n+\n+.. versionadded:: 2.2.3, 2.3.1\n+\n+When enabled, this option allows lookup plugins (whether used in variables as `{{lookup('foo')}}` or as a loop as `with_foo`) to return data that is **not** marked \"unsafe\". By default, such data is marked as unsafe to prevent the templating engine from evaluating any jinja2 templating language, as this could represent a security risk.\n+\n+This option is provided to allow for backwards-compatibility, however users should first consider adding `allow_unsafe=True` to any lookups which may be expected to contain data which may be run through the templating engine later. For example::\n+\n+    {{lookup('pipe', '/path/to/some/command', allow_unsafe=True)}}\n+\n+\n .. _allow_world_readable_tmpfiles:\n \n allow_world_readable_tmpfiles"
        },
        {
          "filename": "examples/ansible.cfg",
          "status": "modified",
          "additions": 7,
          "deletions": 1,
          "patch": "@@ -282,7 +282,7 @@\n # Controls showing custom stats at the end, off by default\n #show_custom_stats = True\n \n-# Controlls which files to ignore when using a directory as inventory with\n+# Controls which files to ignore when using a directory as inventory with\n # possibly multiple sources (both static and dynamic)\n #inventory_ignore_extensions = ~, .orig, .bak, .ini, .cfg, .retry, .pyc, .pyo\n \n@@ -294,6 +294,12 @@\n # Setting to True keeps them under the ansible_facts namespace, the default is False\n #restrict_facts_namespace: True\n \n+# When enabled, this option allows lookups (via variables like {{lookup('foo')}} or when used as\n+# a loop with `with_foo`) to return data that is not marked \"unsafe\". This means the data may contain\n+# jinja2 templating language which will be run through the templating engine.\n+# ENABLING THIS COULD BE A SECURITY RISK\n+#allow_unsafe_lookups = False\n+\n [privilege_escalation]\n #become=True\n #become_method=sudo"
        },
        {
          "filename": "lib/ansible/constants.py",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -236,6 +236,7 @@ def load_config_file():\n                                        [\"~\", \".orig\", \".bak\", \".ini\", \".cfg\", \".retry\", \".pyc\", \".pyo\"], value_type='list')\n DEFAULT_VAR_COMPRESSION_LEVEL = get_config(p, DEFAULTS, 'var_compression_level', 'ANSIBLE_VAR_COMPRESSION_LEVEL', 0, value_type='integer')\n DEFAULT_INTERNAL_POLL_INTERVAL = get_config(p, DEFAULTS, 'internal_poll_interval', None, 0.001, value_type='float')\n+DEFAULT_ALLOW_UNSAFE_LOOKUPS = get_config(p, DEFAULTS, 'allow_unsafe_lookups', None, False, value_type='boolean')\n ERROR_ON_MISSING_HANDLER  = get_config(p, DEFAULTS, 'error_on_missing_handler', 'ANSIBLE_ERROR_ON_MISSING_HANDLER', True, value_type='boolean')\n SHOW_CUSTOM_STATS = get_config(p, DEFAULTS, 'show_custom_stats', 'ANSIBLE_SHOW_CUSTOM_STATS', False, value_type='boolean')\n NAMESPACE_FACTS = get_config(p, DEFAULTS, 'restrict_facts_namespace', 'ANSIBLE_RESTRICT_FACTS', False, value_type='boolean')"
        },
        {
          "filename": "lib/ansible/template/__init__.py",
          "status": "modified",
          "additions": 9,
          "deletions": 2,
          "patch": "@@ -252,6 +252,9 @@ def __init__(self, loader, shared_loader_obj=None, variables=dict()):\n             loader=FileSystemLoader(self._basedir),\n         )\n \n+        # the current rendering context under which the templar class is working\n+        self.cur_context = None\n+\n         self.SINGLE_VAR = re.compile(r\"^%s\\s*(\\w*)\\s*%s$\" % (self.environment.variable_start_string, self.environment.variable_end_string))\n \n         self._clean_regex   = re.compile(r'(?:%s|%s|%s|%s)' % (\n@@ -574,6 +577,7 @@ def _lookup(self, name, *args, **kwargs):\n \n         if instance is not None:\n             wantlist = kwargs.pop('wantlist', False)\n+            allow_unsafe = kwargs.pop('allow_unsafe', C.DEFAULT_ALLOW_UNSAFE_LOOKUPS)\n \n             from ansible.utils.listify import listify_lookup_plugin_terms\n             loop_terms = listify_lookup_plugin_terms(terms=args, templar=self, loader=self._loader, fail_on_undefined=True, convert_bare=False)\n@@ -588,7 +592,8 @@ def _lookup(self, name, *args, **kwargs):\n                                        \"original message: %s\" % (name, type(e), e))\n                 ran = None\n \n-            if ran:\n+            if ran and not allow_unsafe:\n+                from ansible.vars.unsafe_proxy import UnsafeProxy, wrap_var\n                 if wantlist:\n                     ran = wrap_var(ran)\n                 else:\n@@ -600,6 +605,8 @@ def _lookup(self, name, *args, **kwargs):\n                         else:\n                             ran = wrap_var(ran)\n \n+                if self.cur_context:\n+                    self.cur_context.unsafe = True\n             return ran\n         else:\n             raise AnsibleError(\"lookup plugin (%s) not found\" % name)\n@@ -656,7 +663,7 @@ def do_template(self, data, preserve_trailing_newlines=True, escape_backslashes=\n \n             jvars = AnsibleJ2Vars(self, t.globals)\n \n-            new_context = t.new_context(jvars, shared=True)\n+            self.cur_context = new_context = t.new_context(jvars, shared=True)\n             rf = t.root_render_func(new_context)\n \n             try:"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 1,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 4,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "a046ef5a95b3011bff097c0c709680324ab27c2c",
            "date": "2025-01-14T15:46:52Z",
            "author_login": "bcoca"
          },
          {
            "sha": "73180c0630244519c632c2a43c3ed3d794953010",
            "date": "2025-01-14T15:46:31Z",
            "author_login": "leegarrett"
          },
          {
            "sha": "5b0d1704962b4634380c20f8ab5d23f80cbc5f52",
            "date": "2025-01-14T15:44:29Z",
            "author_login": "Akasurde"
          },
          {
            "sha": "f727d74fc248ed29da403e5240816449f25d9836",
            "date": "2025-01-14T15:43:08Z",
            "author_login": "knewsome-cl"
          },
          {
            "sha": "85884013870f930d9fda0dd7d1f6bfabacbe9dff",
            "date": "2025-01-14T15:35:31Z",
            "author_login": "Akasurde"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 9.8,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
    "cwe_id": "CWE-20",
    "description": "Ansible before versions 2.3.1.0 and 2.4.0.0 fails to properly mark lookup-plugin results as unsafe. If an attacker could control the results of lookup() calls, they could inject Unicode strings to be parsed by the jinja2 templating system, resulting in code execution. By default, the jinja2 templating language is now marked as 'unsafe' and is not evaluated.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2018-07-19T13:29:00.340",
    "last_modified": "2024-11-21T03:31:59.250",
    "fix_date": "2017-05-08T15:37:10Z"
  },
  "references": [
    {
      "url": "http://www.securityfocus.com/bid/98492",
      "source": "secalert@redhat.com",
      "tags": [
        "Third Party Advisory",
        "VDB Entry"
      ]
    },
    {
      "url": "https://access.redhat.com/errata/RHSA-2017:1244",
      "source": "secalert@redhat.com",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://access.redhat.com/errata/RHSA-2017:1334",
      "source": "secalert@redhat.com",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://access.redhat.com/errata/RHSA-2017:1476",
      "source": "secalert@redhat.com",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://access.redhat.com/errata/RHSA-2017:1499",
      "source": "secalert@redhat.com",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://access.redhat.com/errata/RHSA-2017:1599",
      "source": "secalert@redhat.com",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://access.redhat.com/errata/RHSA-2017:2524",
      "source": "secalert@redhat.com",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://bugzilla.redhat.com/show_bug.cgi?id=CVE-2017-7481",
      "source": "secalert@redhat.com",
      "tags": [
        "Issue Tracking",
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/ansible/ansible/commit/ed56f51f185a1ffd7ea57130d260098686fcc7c2",
      "source": "secalert@redhat.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2021/01/msg00023.html",
      "source": "secalert@redhat.com",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://usn.ubuntu.com/4072-1/",
      "source": "secalert@redhat.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.securityfocus.com/bid/98492",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory",
        "VDB Entry"
      ]
    },
    {
      "url": "https://access.redhat.com/errata/RHSA-2017:1244",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://access.redhat.com/errata/RHSA-2017:1334",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://access.redhat.com/errata/RHSA-2017:1476",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://access.redhat.com/errata/RHSA-2017:1499",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://access.redhat.com/errata/RHSA-2017:1599",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://access.redhat.com/errata/RHSA-2017:2524",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://bugzilla.redhat.com/show_bug.cgi?id=CVE-2017-7481",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Issue Tracking",
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/ansible/ansible/commit/ed56f51f185a1ffd7ea57130d260098686fcc7c2",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2021/01/msg00023.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://usn.ubuntu.com/4072-1/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T22:59:32.401251",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "ansible",
    "owner": "ansible",
    "created_at": "2012-03-06T14:58:02Z",
    "updated_at": "2025-01-14T10:49:14Z",
    "pushed_at": "2025-01-13T22:24:09Z",
    "size": 256540,
    "stars": 63659,
    "forks": 23941,
    "open_issues": 910,
    "watchers": 63659,
    "has_security_policy": false,
    "default_branch": "devel",
    "protected_branches": [
      "devel",
      "mazer_role_loader",
      "milestone",
      "release1.5.0",
      "release1.5.1",
      "release1.5.2",
      "release1.5.3",
      "release1.5.4",
      "release1.5.5",
      "release1.6.0",
      "release1.6.1",
      "release1.6.2",
      "release1.6.3",
      "release1.6.4",
      "release1.6.5",
      "release1.6.6",
      "release1.6.7",
      "release1.6.8",
      "release1.6.9",
      "release1.6.10",
      "release1.7.0",
      "release1.7.1",
      "release1.7.2",
      "release1.8.0",
      "release1.8.1",
      "release1.8.2",
      "release1.8.3",
      "release1.8.4",
      "stable-1.9",
      "stable-2.0-network"
    ],
    "languages": {
      "Python": 8959137,
      "PowerShell": 728026,
      "Shell": 293660,
      "C#": 221744,
      "Jinja": 45945,
      "Go": 2010,
      "Roff": 555,
      "Batchfile": 144
    },
    "commit_activity": {
      "total_commits_last_year": 609,
      "avg_commits_per_week": 11.711538461538462,
      "days_active_last_year": 201
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "gpl-3.0"
    },
    "collected_at": "2025-01-14T13:02:42.286063"
  }
}