{
  "cve_id": "CVE-2017-7501",
  "github_data": {
    "repository": "rpm-software-management/rpm",
    "fix_commit": "404ef011c300207cdb1e531670384564aae04bdc",
    "related_commits": [
      "404ef011c300207cdb1e531670384564aae04bdc",
      "404ef011c300207cdb1e531670384564aae04bdc"
    ],
    "patch_url": "https://github.com/rpm-software-management/rpm/commit/404ef011c300207cdb1e531670384564aae04bdc.patch",
    "fix_commit_details": {
      "sha": "404ef011c300207cdb1e531670384564aae04bdc",
      "commit_date": "2017-09-19T11:46:36Z",
      "author": {
        "login": "pmatilai",
        "type": "User",
        "stats": {
          "total_commits": 8074,
          "average_weekly_commits": 8.74756229685807,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 671
        }
      },
      "commit_message": {
        "title": "Don't follow symlinks on file creation (CVE-2017-7501)",
        "length": 686,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 29,
        "additions": 23,
        "deletions": 6
      },
      "files": [
        {
          "filename": "lib/fsm.c",
          "status": "modified",
          "additions": 23,
          "deletions": 6,
          "patch": "@@ -206,20 +206,37 @@ static int fsmSetFCaps(const char *path, const char *captxt)\n     return rc;\n }\n \n+/* Check dest is the same, empty and regular file with writeonly permissions */\n+static int linkSane(FD_t wfd, const char *dest)\n+{\n+    struct stat sb, lsb;\n+\n+    return (fstat(Fileno(wfd), &sb) == 0 && sb.st_size == 0 &&\n+\t    (sb.st_mode & ~S_IFMT) == S_IWUSR &&\n+\t    lstat(dest, &lsb) == 0 && S_ISREG(lsb.st_mode) &&\n+\t    sb.st_dev == lsb.st_dev && sb.st_ino == lsb.st_ino);\n+}\n+\n /** \\ingroup payload\n  * Create file from payload stream.\n  * @return\t\t0 on success\n  */\n-static int expandRegular(rpmfi fi, const char *dest, rpmpsm psm, int nodigest, int nocontent)\n+static int expandRegular(rpmfi fi, const char *dest, rpmpsm psm, int exclusive, int nodigest, int nocontent)\n {\n     FD_t wfd = NULL;\n     int rc = 0;\n \n     /* Create the file with 0200 permissions (write by owner). */\n     {\n \tmode_t old_umask = umask(0577);\n-\twfd = Fopen(dest, \"w.ufdio\");\n+\twfd = Fopen(dest, exclusive ? \"wx.ufdio\" : \"a.ufdio\");\n \tumask(old_umask);\n+\n+\t/* If reopening, make sure the file is what we expect */\n+\tif (!exclusive && wfd != NULL && !linkSane(wfd, dest)) {\n+\t    rc = RPMERR_OPEN_FAILED;\n+\t    goto exit;\n+\t}\n     }\n     if (Ferror(wfd)) {\n \trc = RPMERR_OPEN_FAILED;\n@@ -248,7 +265,7 @@ static int fsmMkfile(rpmfi fi, const char *dest, rpmfiles files,\n \t/* Create first hardlinked file empty */\n \tif (*firsthardlink < 0) {\n \t    *firsthardlink = rpmfiFX(fi);\n-\t    rc = expandRegular(fi, dest, psm, nodigest, 1);\n+\t    rc = expandRegular(fi, dest, psm, 1, nodigest, 1);\n \t} else {\n \t    /* Create hard links for others */\n \t    char *fn = rpmfilesFN(files, *firsthardlink);\n@@ -263,10 +280,10 @@ static int fsmMkfile(rpmfi fi, const char *dest, rpmfiles files,\n        existing) file with content */\n     if (numHardlinks<=1) {\n \tif (!rc)\n-\t    rc = expandRegular(fi, dest, psm, nodigest, 0);\n+\t    rc = expandRegular(fi, dest, psm, 1, nodigest, 0);\n     } else if (rpmfiArchiveHasContent(fi)) {\n \tif (!rc)\n-\t    rc = expandRegular(fi, dest, psm, nodigest, 0);\n+\t    rc = expandRegular(fi, dest, psm, 0, nodigest, 0);\n \t*firsthardlink = -1;\n     } else {\n \t*setmeta = 0;\n@@ -939,7 +956,7 @@ int rpmPackageFilesInstall(rpmts ts, rpmte te, rpmfiles files,\n \t    /* we skip the hard linked file containing the content */\n \t    /* write the content to the first used instead */\n \t    char *fn = rpmfilesFN(files, firsthardlink);\n-\t    rc = expandRegular(fi, fn, psm, nodigest, 0);\n+\t    rc = expandRegular(fi, fn, psm, 0, nodigest, 0);\n \t    firsthardlink = -1;\n \t    free(fn);\n \t}"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 1,
        "max_directory_depth": 1
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "d319c79c6469be00748b9870c8f33b34c65f0e6d",
            "date": "2025-01-13T14:13:56Z",
            "author_login": "ffesti"
          },
          {
            "sha": "55453a055f58aa6837ccf78ceccb869d4a8ebe57",
            "date": "2025-01-08T14:23:30Z",
            "author_login": "ffesti"
          },
          {
            "sha": "e09a79afb171159f3d76a8d204cd40f562cb19b0",
            "date": "2025-01-08T14:25:29Z",
            "author_login": "ffesti"
          },
          {
            "sha": "105c5e832aacba86fb7ec528ffa9ef085fbcb2be",
            "date": "2025-01-10T14:14:59Z",
            "author_login": "pmatilai"
          },
          {
            "sha": "3755fca7b2f775661f90b675df3976e11abbfd17",
            "date": "2025-01-10T12:14:47Z",
            "author_login": "pmatilai"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": null,
    "cvss_vector": null,
    "cwe_id": "CWE-59",
    "description": "It was found that versions of rpm before 4.13.0.2 use temporary files with predictable names when installing an RPM. An attacker with ability to write in a directory where files will be installed could create symbolic links to an arbitrary location and modify content, and possibly permissions to arbitrary files, which could be used for denial of service or possibly privilege escalation.",
    "attack_vector": null,
    "attack_complexity": null
  },
  "temporal_data": {
    "published_date": "2017-11-22T22:29:00.270",
    "last_modified": "2024-11-21T03:32:01.540",
    "fix_date": "2017-09-19T11:46:36Z"
  },
  "references": [
    {
      "url": "https://github.com/rpm-software-management/rpm/commit/404ef011c300207cdb1e531670384564aae04bdc",
      "source": "secalert@redhat.com",
      "tags": [
        "Issue Tracking",
        "Patch"
      ]
    },
    {
      "url": "https://lists.apache.org/thread.html/r58af02e294bd07f487e2c64ffc0a29b837db5600e33b6e698b9d696b%40%3Cissues.bookkeeper.apache.org%3E",
      "source": "secalert@redhat.com",
      "tags": []
    },
    {
      "url": "https://lists.apache.org/thread.html/rf4c02775860db415b4955778a131c2795223f61cb8c6a450893651e4%40%3Cissues.bookkeeper.apache.org%3E",
      "source": "secalert@redhat.com",
      "tags": []
    },
    {
      "url": "https://security.gentoo.org/glsa/201811-22",
      "source": "secalert@redhat.com",
      "tags": []
    },
    {
      "url": "https://github.com/rpm-software-management/rpm/commit/404ef011c300207cdb1e531670384564aae04bdc",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Issue Tracking",
        "Patch"
      ]
    },
    {
      "url": "https://lists.apache.org/thread.html/r58af02e294bd07f487e2c64ffc0a29b837db5600e33b6e698b9d696b%40%3Cissues.bookkeeper.apache.org%3E",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://lists.apache.org/thread.html/rf4c02775860db415b4955778a131c2795223f61cb8c6a450893651e4%40%3Cissues.bookkeeper.apache.org%3E",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://security.gentoo.org/glsa/201811-22",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T22:59:09.748079",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "rpm",
    "owner": "rpm-software-management",
    "created_at": "2015-02-24T12:00:53Z",
    "updated_at": "2025-01-14T12:49:04Z",
    "pushed_at": "2025-01-14T12:48:59Z",
    "size": 86059,
    "stars": 519,
    "forks": 375,
    "open_issues": 272,
    "watchers": 519,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "ffesti-templates",
      "master",
      "refs",
      "rpm-4.4.x",
      "rpm-4.6.x",
      "rpm-4.7.x",
      "rpm-4.8.x",
      "rpm-4.9.x",
      "rpm-4.10.x",
      "rpm-4.11.x",
      "rpm-4.12.x",
      "rpm-4.13.x",
      "rpm-4.14.x",
      "rpm-4.15.x",
      "rpm-4.16.x",
      "rpm-4.17.x",
      "rpm-4.18.x",
      "rpm-4.19.x",
      "rpm-4.20.x"
    ],
    "languages": {
      "C++": 1716571,
      "C": 619258,
      "Shell": 62332,
      "CMake": 34556,
      "Python": 16186,
      "Lua": 138
    },
    "commit_activity": {
      "total_commits_last_year": 712,
      "avg_commits_per_week": 13.692307692307692,
      "days_active_last_year": 184
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T16:04:49.568059"
  }
}