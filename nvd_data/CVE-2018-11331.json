{
  "cve_id": "CVE-2018-11331",
  "github_data": {
    "repository": "pluck-cms/pluck",
    "fix_commit": "8f6541e60c9435e82e9c531a20cb3c218d36976e",
    "related_commits": [
      "8f6541e60c9435e82e9c531a20cb3c218d36976e",
      "8f6541e60c9435e82e9c531a20cb3c218d36976e"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "8f6541e60c9435e82e9c531a20cb3c218d36976e",
      "commit_date": "2018-05-21T10:21:01Z",
      "author": {
        "login": "BSteelooper",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "bugfix for XSS and backdoor file upload found by s7acktrac3 issue #58",
        "length": 69,
        "has_description": false,
        "references_issue": true
      },
      "stats": {
        "total": 89,
        "additions": 75,
        "deletions": 14
      },
      "files": [
        {
          "filename": "data/inc/editpage.php",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -39,10 +39,10 @@\n \t\t\t$title = $_POST['title'];\n \t\t//If we are editing an existing page, pass current seo-name.\n \t\tif (isset($_GET['page'])) {\n-\t\t\t$seoname = save_page($title, $_POST['content'], $_POST['hidden'], $_POST['sub_page'], $_POST['description'], $_POST['keywords'], $module_additional_data, $_GET['page']);\n+\t\t\t$seoname = latinOnlyInput(save_page($title, $_POST['content'], $_POST['hidden'], $_POST['sub_page'], $_POST['description'], $_POST['keywords'], $module_additional_data, $_GET['page']));\n \t\t} else {\n \t\t//If we are creating a new page, don't pass seo-name.\n-\t\t\t$seoname = save_page($title, $_POST['content'], $_POST['hidden'], $_POST['sub_page'], $_POST['description'], $_POST['keywords'], $module_additional_data);\n+\t\t\t$seoname = latinOnlyInput(save_page($title, $_POST['content'], $_POST['hidden'], $_POST['sub_page'], $_POST['description'], $_POST['keywords'], $module_additional_data));\n \t\t}\n \t\t//If seoname is false, a file already exists with the same name\n \t\tif (empty($seoname)) {"
        },
        {
          "filename": "data/inc/files.php",
          "status": "modified",
          "additions": 13,
          "deletions": 8,
          "patch": "@@ -32,24 +32,27 @@\n </div>\n <?php\n if (isset($_POST['submit'])) {\n-\t\tif (!copy($_FILES['filefile']['tmp_name'], 'files/'.$_FILES['filefile']['name']))\n+\t\tif (!copy($_FILES['filefile']['tmp_name'], 'files/'.latinOnlyInput(latinOnlyInput($_FILES['filefile']['name']))))\n \t\t\tshow_error($lang['general']['upload_failed'], 1);\n \t\telse {\n-\t\t\tif (strcasecmp(substr($_FILES['filefile']['name'], -3),'php') == 0){\n-\t\t\t\tif (!rename('files/'.$_FILES['filefile']['name'], 'files/'.$_FILES['filefile']['name'].'.txt')){\n+\t\t\t$lastfour = strtolower(substr(latinOnlyInput($_FILES['filefile']['name']), -4));\n+\t\t\t$lastfive = strtolower(substr(latinOnlyInput($_FILES['filefile']['name']), -5));\n+\t\t\t$blockedExtentions = array('.php','php3','php4','php5','php6','php7','phtml');\n+\t\t\tif (in_array($lastfour, $blockedExtentions) or in_array($lastfive, $blockedExtentions) ){\n+\t\t\t\tif (!rename('files/'.latinOnlyInput($_FILES['filefile']['name']), 'files/'.latinOnlyInput($_FILES['filefile']['name']).'.txt')){\n \t\t\t\t\tshow_error($lang['general']['upload_failed'], 1);\n \t\t\t\t}\n-\t\t\t\tchmod('files/'.$_FILES['filefile']['name'].'.txt', 0775);\n+\t\t\t\tchmod('files/'.latinOnlyInput($_FILES['filefile']['name']).'.txt', 0775);\n \t\t\t}else{\n-\t\t\t\tchmod('files/'.$_FILES['filefile']['name'], 0775);\n+\t\t\t\tchmod('files/'.latinOnlyInput($_FILES['filefile']['name']), 0775);\n \t\t\t}\n \t\t\t?>\n \t\t\t\t<div class=\"menudiv\">\n-\t\t\t\t\t<strong><?php echo $lang['files']['name']; ?></strong> <?php echo $_FILES['filefile']['name']; ?>\n+\t\t\t\t\t<strong><?php echo $lang['files']['name']; ?></strong> <?php echo latinOnlyInput($_FILES['filefile']['name']); ?>\n \t\t\t\t\t<br />\n-\t\t\t\t\t<strong><?php echo $lang['files']['size']; ?></strong> <?php echo $_FILES['filefile']['size'].' '.$lang['images']['bytes']; ?>\n+\t\t\t\t\t<strong><?php echo $lang['files']['size']; ?></strong> <?php echo latinOnlyInput($_FILES['filefile']['size']).' '.$lang['images']['bytes']; ?>\n \t\t\t\t\t<br />\n-\t\t\t\t\t<strong><?php echo $lang['files']['type']; ?></strong> <?php echo $_FILES['filefile']['type']; ?>\n+\t\t\t\t\t<strong><?php echo $lang['files']['type']; ?></strong> <?php echo latinOnlyInput($_FILES['filefile']['type']); ?>\n \t\t\t\t\t<br />\n \t\t\t\t\t<strong><?php echo $lang['files']['success']; //TODO: Need to show this message another place, and with show_error(). ?></strong>\n \t\t\t\t</div>\n@@ -66,6 +69,7 @@\n \tif ($files) {\n \t\tnatcasesort($files);\n \t\tforeach ($files as $file) {\n+\t\t\tif (!($file == '.htaccess')){\n \t\t?>\n \t\t\t<div class=\"menudiv\">\n \t\t\t\t<span>\n@@ -84,6 +88,7 @@\n \t\t\t\t</span>\n \t\t\t</div>\n \t\t\t<?php\n+\t\t\t}\n \t\t}\n \t\tunset($files);\n \t}"
        },
        {
          "filename": "data/inc/functions.all.php",
          "status": "modified",
          "additions": 18,
          "deletions": 0,
          "patch": "@@ -215,10 +215,28 @@ function sanitize($var, $html = true) {\n  */\n function preventXSS($var) {\n \t$var = str_replace('\\'', '', $var);\n+\t$var = htmlspecialchars($var, ENT_COMPAT, 'UTF-8', false);\n \n \treturn $var;\n }\n \n+/**\n+ * latinOnlyInput from a URL, to make it ready for saving in a file.\n+ *\n+ * @since 4.7.5\n+ * @package all\n+ * @param string $var Variable \n+ * @return string The sanitized variable.\n+ * \n+ * Added as bugfix for XSS and backdoor file upload found by s7acktrac3\n+ */\n+function latinOnlyInput($var) {\n+\t$var = str_replace(chr(0), '', $var);\n+\t$var = preg_replace(\"/[^a-zA-Z0-9.\\ -_]+/\", \"\", $var);;\n+\treturn $var;\n+}\n+\n+\n /**\n  * Displays or returns an error, notice or success message.\n  *"
        },
        {
          "filename": "data/inc/images.php",
          "status": "modified",
          "additions": 6,
          "deletions": 4,
          "patch": "@@ -39,17 +39,17 @@\n         if (!in_array(strtolower(substr($_FILES['imagefile']['name'], -4)), $imagewhitelist))\n \t\t\tshow_error($lang['general']['upload_failed'], 1);\n \t\t/* end of fix issue 44. Thanks to Klaus.  */\n-\t\tif (!copy($_FILES['imagefile']['tmp_name'], 'images/'.$_FILES['imagefile']['name']))\n+\t\tif (!copy($_FILES['imagefile']['tmp_name'], 'images/'.latinOnlyInput($_FILES['imagefile']['name'])))\n \t\t\tshow_error($lang['general']['upload_failed'], 1);\n \t\telse {\n \t\t\tchmod('images/'.$_FILES['imagefile']['name'], 0666);\n \t\t\t?>\n \t\t\t\t<div class=\"menudiv\">\n-\t\t\t\t\t<strong><?php echo $lang['images']['name']; ?></strong> <?php echo $_FILES['imagefile']['name']; ?>\n+\t\t\t\t\t<strong><?php echo $lang['images']['name']; ?></strong> <?php echo latinOnlyInput($_FILES['imagefile']['name']); ?>\n \t\t\t\t\t<br />\n-\t\t\t\t\t<strong><?php echo $lang['images']['size']; ?></strong> <?php echo $_FILES['imagefile']['size'].' '.$lang['images']['bytes']; ?>\n+\t\t\t\t\t<strong><?php echo $lang['images']['size']; ?></strong> <?php echo latinOnlyInput($_FILES['imagefile']['size']).' '.$lang['images']['bytes']; ?>\n \t\t\t\t\t<br />\n-\t\t\t\t\t<strong><?php echo $lang['images']['type']; ?></strong> <?php echo $_FILES['imagefile']['type']; ?>\n+\t\t\t\t\t<strong><?php echo $lang['images']['type']; ?></strong> <?php echo latinOnlyInput($_FILES['imagefile']['type']); ?>\n \t\t\t\t\t<br />\n \t\t\t\t\t<strong><?php echo $lang['images']['success']; //TODO: Need to show this message another place, and with show_error(). ?></strong>\n \t\t\t\t</div>\n@@ -67,6 +67,7 @@\n \tif ($images) {\n \t\tnatcasesort($images);\n \t\tforeach ($images as $image) {\n+\t\t\tif (!($image == '.htaccess')){\n \t\t?>\n \t\t\t<div class=\"menudiv\">\n \t\t\t\t<span>\n@@ -85,6 +86,7 @@\n \t\t\t\t</span>\n \t\t\t</div>\n \t\t\t<?php\n+\t\t\t}\n \t\t}\n \t\tunset($images);\n \t}"
        },
        {
          "filename": "data/modules/.htaccess",
          "status": "added",
          "additions": 9,
          "deletions": 0,
          "patch": "@@ -0,0 +1,9 @@\n+<FilesMatch \\.php$>\n+    SetHandler None\n+</FilesMatch>\n+\n+<FilesMatch \\.phtml>\n+    SetHandler None\n+</FilesMatch>\n+\n+Options -ExecCGI"
        },
        {
          "filename": "data/themes/.htaccess",
          "status": "added",
          "additions": 9,
          "deletions": 0,
          "patch": "@@ -0,0 +1,9 @@\n+<FilesMatch \\.php$>\n+    SetHandler None\n+</FilesMatch>\n+\n+<FilesMatch \\.phtml>\n+    SetHandler None\n+</FilesMatch>\n+\n+Options -ExecCGI"
        },
        {
          "filename": "files/.files",
          "status": "removed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "files/.htaccess",
          "status": "added",
          "additions": 9,
          "deletions": 0,
          "patch": "@@ -0,0 +1,9 @@\n+<FilesMatch \\.php$>\n+    SetHandler None\n+</FilesMatch>\n+\n+<FilesMatch \\.phtml>\n+    SetHandler None\n+</FilesMatch>\n+\n+Options -ExecCGI"
        },
        {
          "filename": "images/.htaccess",
          "status": "added",
          "additions": 9,
          "deletions": 0,
          "patch": "@@ -0,0 +1,9 @@\n+<FilesMatch \\.php$>\n+    SetHandler None\n+</FilesMatch>\n+\n+<FilesMatch \\.phtml>\n+    SetHandler None\n+</FilesMatch>\n+\n+Options -ExecCGI"
        },
        {
          "filename": "images/.images",
          "status": "removed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 5,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "598d9b8852792017e9e28d6e85015a1f6e5de621",
            "date": "2024-10-04T14:54:24Z",
            "author_login": "BSteelooper"
          },
          {
            "sha": "244a86c4980dc33ca3cc6b1ba8852cc7c1d4a297",
            "date": "2024-10-04T14:52:17Z",
            "author_login": "BSteelooper"
          },
          {
            "sha": "8611e20344ddc74c12855fd0a61b8000b56496be",
            "date": "2023-02-24T10:53:48Z",
            "author_login": "BSteelooper"
          },
          {
            "sha": "868a4437681255affbde0e2893fbb121cdb3950c",
            "date": "2023-02-24T10:51:39Z",
            "author_login": "BSteelooper"
          },
          {
            "sha": "c941a39bc4d8442a71ecb2db89e1df2a7db88669",
            "date": "2023-02-23T06:23:39Z",
            "author_login": "GaneshKandu"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": null,
    "cvss_vector": null,
    "cwe_id": "CWE-434",
    "description": "An issue was discovered in Pluck before 4.7.6. Remote PHP code execution is possible because the set of disallowed filetypes for uploads in missing some applicable ones such as .phtml and .htaccess.",
    "attack_vector": null,
    "attack_complexity": null
  },
  "temporal_data": {
    "published_date": "2018-05-21T21:29:00.330",
    "last_modified": "2024-11-21T03:43:09.320",
    "fix_date": "2018-05-21T10:21:01Z"
  },
  "references": [
    {
      "url": "https://github.com/pluck-cms/pluck/commit/8f6541e60c9435e82e9c531a20cb3c218d36976e",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/pluck-cms/pluck/issues/58",
      "source": "cve@mitre.org",
      "tags": [
        "Issue Tracking",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/pluck-cms/pluck/commit/8f6541e60c9435e82e9c531a20cb3c218d36976e",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/pluck-cms/pluck/issues/58",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Issue Tracking",
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T22:59:25.850794",
    "processing_status": "enhanced"
  }
}