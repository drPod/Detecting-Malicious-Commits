{
  "cve_id": "CVE-2018-14857",
  "github_data": {
    "repository": "OCSInventory-NG/OCSInventory-ocsreports",
    "fix_commit": "cc572819e373f7ff81dec61591b6f465b43c5515",
    "related_commits": [
      "cc572819e373f7ff81dec61591b6f465b43c5515",
      "cc572819e373f7ff81dec61591b6f465b43c5515"
    ],
    "patch_url": "https://github.com/OCSInventory-NG/OCSInventory-ocsreports/commit/cc572819e373f7ff81dec61591b6f465b43c5515.patch",
    "fix_commit_details": {
      "sha": "cc572819e373f7ff81dec61591b6f465b43c5515",
      "commit_date": "2018-08-02T13:58:38Z",
      "author": {
        "login": "damienbelliard",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Merge pull request #525 from OCSInventory-NG/notification-improvement",
        "length": 95,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 84,
        "additions": 68,
        "deletions": 16
      },
      "files": [
        {
          "filename": "plugins/language/en_GB/en_GB.txt",
          "status": "modified",
          "additions": 2,
          "deletions": 0,
          "patch": "@@ -1543,3 +1543,5 @@\n 8017 This file is not an html file\n 8018 Subject\n 8019 Notification OCSInventory\n+8020 WARNING : Mail template file not found\n+8021 The uploaded file need to have .html extension to be valid\n\\ No newline at end of file"
        },
        {
          "filename": "plugins/language/fr_FR/fr_FR.txt",
          "status": "modified",
          "additions": 2,
          "deletions": 0,
          "patch": "@@ -1541,3 +1541,5 @@\n 8016 Ici vous pouvez t\u00e9l\u00e9charger votre mod\u00e8le de notification personnalis\u00e9:</br>\u2022 Le fichier doit \u00eatre un fichier html.</br></br>Informations:</br>\u2022 Pour avoir les traduction mettez {{g.(num\u00e9ro de la traduction)}} dans votre code html - Exemple: {{g.49}} = Nom</br>\u2022 Pour le moment vous disposez de deux choix de rapport d'inventaire: </br> {{Report.Software}} - Nombre de logiciels par cat\u00e9gorie de logiciel </br> {{Report.Asset}} - Nombre de machines par cat\u00e9gorie d'actifs\n 8017 Ce fichier n'est pas un fichier html\n 8018 Sujet\n+8020 WARNING : Fichier de template personnalis\u00e9 non trouv\u00e9\n+8021 Le fichier upload doit avoir pour extension .html"
        },
        {
          "filename": "plugins/main_sections/ms_config/ms_notification.php",
          "status": "modified",
          "additions": 4,
          "deletions": 1,
          "patch": "@@ -192,10 +192,13 @@\n \n     //Perso\n     $info = $mail->get_all_information('PERSO');\n+    $output = $mail->replace_value($mail->get_template_perso(), 'PERSO');\n+    if(!$output){\n+        $output = $l->g(8020);\n+    }\n     echo \"<div id=perso_mail \".$style_perso.\">\";\n     echo \"<div class='form-group'><label class='control-label col-sm-2' for='subject'>\".$l->g(8018).\"</label><div class='col-sm-8'>\n           <input type='text' class='form-control' id='subject' name='subject' size='50' maxlength='255' value='\".$info['PERSO']['SUBJECT'].\"'/></div></div>\";\n-    $output = $mail->replace_value($mail->get_template_perso(), 'PERSO');\n     echo $output;\n     echo \"</div>\";\n "
        },
        {
          "filename": "require/mail/NotificationMail.php",
          "status": "modified",
          "additions": 49,
          "deletions": 15,
          "patch": "@@ -48,6 +48,8 @@ class NotificationMail\n                         );\n       private $week = array('MON' => 'MON', 'TUE' => 'TUE', 'WED' => 'WED', 'THURS' => 'THURS', 'FRI' => 'FRI', 'SAT' => 'SAT', 'SUN' => 'SUN');\n \n+      const HTML_EXT = 'html';\n+      \n       public function __construct($language){\n         global $l;\n         $l = new language($language);\n@@ -180,20 +182,27 @@ public function config_mailer(){\n        * @return void\n        */\n      public function send_notification($subject, $body, $altBody = '', $selected, $isHtml = false ){\n-          $body = $this->replace_value($body, $selected);\n-          try{\n-             // Content\n-             $this->notif->isHTML(false);\n-             $this->notif->Subject = $subject;\n-             $this->notif->Body    = $body;\n-             $this->notif->AltBody = $altBody;\n-\n-             $this->notif->send();\n-             error_log('Message has been sent');\n-         } catch (Exception $e) {\n-             $msg = 'Message could not be sent. Mailer Error: '. $mail->ErrorInfo;\n-             error_log($msg);\n-         }\n+            \n+            $body = $this->replace_value($body, $selected);\n+         \n+            if(!$body){\n+                error_log('Error reading custom template');\n+                return false;\n+            }\n+            \n+            try{\n+               // Content\n+               $this->notif->isHTML(false);\n+               $this->notif->Subject = $subject;\n+               $this->notif->Body    = $body;\n+               $this->notif->AltBody = $altBody;\n+\n+               $this->notif->send();\n+               error_log('Message has been sent');\n+           } catch (Exception $e) {\n+               $msg = 'Message could not be sent. Mailer Error: '. $mail->ErrorInfo;\n+               error_log($msg);\n+           }\n       }\n \n       /**\n@@ -214,7 +223,11 @@ public function replace_value($file, $selected){\n           if($selected == 'DEFAULT'){\n             $template = file_get_contents(TEMPLATE.'OCS_template.html', true);\n           }else{\n-            $template = file_get_contents($file, true);\n+            if(file_exists($file)){\n+                $template = file_get_contents($file, true); \n+            }else{\n+                return false;\n+            }\n           }\n \n           if(strpos($template, \"{{\") !== false){\n@@ -263,6 +276,11 @@ public function replace_value($file, $selected){\n       public function upload_file($file, $subject){\n           global $l;\n           $uploadFile = TEMPLATE . basename($file['template']['name']);\n+          \n+          if(!$this->is_html_extension($uploadFile)){\n+              msg_error($l->g(8021));\n+              return false;\n+          }\n \n           if($file['template']['type'] == 'text/html'){\n             if (move_uploaded_file($_FILES['template']['tmp_name'], $uploadFile)) {\n@@ -280,6 +298,22 @@ public function upload_file($file, $subject){\n             return false;\n           }\n       }\n+      \n+      /**\n+       * Check if file respect naming convention\n+       * And have extension .html\n+       * \n+       * @param array $uploaded_file\n+       */\n+      private function is_html_extension($uploaded_file_name){\n+          $ext = end((explode(\".\", $uploaded_file_name)));\n+          var_dump($ext);\n+          if($ext == self::HTML_EXT){\n+              return true;\n+          }else{\n+              return false;\n+          }\n+      }\n \n       /**\n        * Get directory template perso"
        },
        {
          "filename": "templates/.htaccess",
          "status": "added",
          "additions": 11,
          "deletions": 0,
          "patch": "@@ -0,0 +1,11 @@\n+# Prevent direct access to folder\n+\n+# Apache 2.2\n+<IfModule !mod_authz_core.c>\n+    Deny from all\n+</IfModule>\n+\n+# Apache 2.4\n+<IfModule mod_authz_core.c>\n+    Require all denied\n+</IfModule>"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 1,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 5,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "ce485351f7769da0d63f47acb718ba59f5f96201",
            "date": "2024-11-06T09:20:39Z",
            "author_login": "Lea9250"
          },
          {
            "sha": "3359dd0cfb7361617ffe5d17a5a7b0946f54e82e",
            "date": "2024-10-28T09:01:38Z",
            "author_login": "Lea9250"
          },
          {
            "sha": "f855e067425737c15c8b0ad20306fcfa0c33941a",
            "date": "2024-10-28T09:00:36Z",
            "author_login": "Lea9250"
          },
          {
            "sha": "668ba387f4d54702ca34f8decf5c85d47e2a96f3",
            "date": "2024-10-28T08:59:40Z",
            "author_login": "Lea9250"
          },
          {
            "sha": "04cf001d451d511eeb4e2c83a86857ead939ada6",
            "date": "2024-10-25T15:38:46Z",
            "author_login": "kvolk2git"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": null,
    "cvss_vector": null,
    "cwe_id": "CWE-434",
    "description": "Unrestricted file upload (with remote code execution) in require/mail/NotificationMail.php in Webconsole in OCS Inventory NG OCS Inventory Server through 2.5 allows a privileged user to gain access to the server via a template file containing PHP code, because file extensions other than .html are permitted.",
    "attack_vector": null,
    "attack_complexity": null
  },
  "temporal_data": {
    "published_date": "2018-08-06T21:29:00.453",
    "last_modified": "2024-11-21T03:49:56.150",
    "fix_date": "2018-08-02T13:58:38Z"
  },
  "references": [
    {
      "url": "http://seclists.org/fulldisclosure/2018/Aug/6",
      "source": "cve@mitre.org",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.securitytracker.com/id/1041418",
      "source": "cve@mitre.org",
      "tags": [
        "Third Party Advisory",
        "VDB Entry"
      ]
    },
    {
      "url": "https://github.com/OCSInventory-NG/OCSInventory-ocsreports/commit/cc572819e373f7ff81dec61591b6f465b43c5515",
      "source": "cve@mitre.org",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://seclists.org/fulldisclosure/2018/Aug/6",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.securitytracker.com/id/1041418",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory",
        "VDB Entry"
      ]
    },
    {
      "url": "https://github.com/OCSInventory-NG/OCSInventory-ocsreports/commit/cc572819e373f7ff81dec61591b6f465b43c5515",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T22:59:32.432502",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "OCSInventory-ocsreports",
    "owner": "OCSInventory-NG",
    "created_at": "2015-06-02T09:28:21Z",
    "updated_at": "2024-12-16T09:04:06Z",
    "pushed_at": "2024-11-06T09:20:39Z",
    "size": 100342,
    "stars": 235,
    "forks": 151,
    "open_issues": 81,
    "watchers": 235,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "JavaScript": 14579056,
      "PHP": 1818211,
      "CSS": 72476,
      "Perl": 24247,
      "HTML": 14455,
      "PowerShell": 4351,
      "Python": 3596,
      "Shell": 1392
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "gpl-2.0"
    },
    "collected_at": "2025-01-14T19:17:41.647904"
  }
}