{
  "cve_id": "CVE-2018-16418",
  "github_data": {
    "repository": "OpenSC/OpenSC",
    "fix_commit": "360e95d45ac4123255a4c796db96337f332160ad",
    "related_commits": [
      "360e95d45ac4123255a4c796db96337f332160ad",
      "360e95d45ac4123255a4c796db96337f332160ad"
    ],
    "patch_url": "https://github.com/OpenSC/OpenSC/commit/360e95d45ac4123255a4c796db96337f332160ad.patch",
    "fix_commit_details": {
      "sha": "360e95d45ac4123255a4c796db96337f332160ad",
      "commit_date": "2018-05-25T21:34:14Z",
      "author": {
        "login": "frankmorgner",
        "type": "User",
        "stats": {
          "total_commits": 1065,
          "average_weekly_commits": 1.4978902953586497,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 268
        }
      },
      "commit_message": {
        "title": "fixed out of bounds writes",
        "length": 101,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 50,
        "additions": 29,
        "deletions": 21
      },
      "files": [
        {
          "filename": "src/libopensc/card-cac.c",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -794,7 +794,7 @@ static int cac_get_serial_nr_from_CUID(sc_card_t* card, sc_serial_number_t* seri\n         }\n \tif (priv->cac_id_len) {\n \t\tserial->len = MIN(priv->cac_id_len, SC_MAX_SERIALNR);\n-\t\tmemcpy(serial->value, priv->cac_id, priv->cac_id_len);\n+\t\tmemcpy(serial->value, priv->cac_id, serial->len);\n \t\tSC_FUNC_RETURN(card->ctx, SC_LOG_DEBUG_NORMAL, SC_SUCCESS);\n \t}\n \tSC_FUNC_RETURN(card->ctx, SC_LOG_DEBUG_NORMAL, SC_ERROR_FILE_NOT_FOUND);"
        },
        {
          "filename": "src/libopensc/card-epass2003.c",
          "status": "modified",
          "additions": 2,
          "deletions": 1,
          "patch": "@@ -951,7 +951,7 @@ decrypt_response(struct sc_card *card, unsigned char *in, size_t inlen, unsigned\n \twhile (0x80 != plaintext[cipher_len - 2] && (cipher_len - 2 > 0))\n \t\tcipher_len--;\n \n-\tif (2 == cipher_len)\n+\tif (2 == cipher_len || *out_len < cipher_len - 2)\n \t\treturn -1;\n \n \tmemcpy(out, plaintext, cipher_len - 2);\n@@ -977,6 +977,7 @@ epass2003_sm_unwrap_apdu(struct sc_card *card, struct sc_apdu *sm, struct sc_apd\n \tr = sc_check_sw(card, sm->sw1, sm->sw2);\n \tif (r == SC_SUCCESS) {\n \t\tif (exdata->sm) {\n+\t\t\tlen = plain->resplen;\n \t\t\tif (0 != decrypt_response(card, sm->resp, sm->resplen, plain->resp, &len))\n \t\t\t\treturn SC_ERROR_CARD_CMD_FAILED;\n \t\t}"
        },
        {
          "filename": "src/libopensc/card-muscle.c",
          "status": "modified",
          "additions": 5,
          "deletions": 2,
          "patch": "@@ -518,7 +518,9 @@ static int muscle_list_files(sc_card_t *card, u8 *buf, size_t bufLen)\n \tmscfs_check_cache(priv->fs);\n \n \tfor(x = 0; x < fs->cache.size; x++) {\n-\t\tu8* oid= fs->cache.array[x].objectId.id;\n+\t\tu8* oid = fs->cache.array[x].objectId.id;\n+\t\tif (bufLen < 2)\n+\t\t\tbreak;\n \t\tsc_debug(card->ctx, SC_LOG_DEBUG_NORMAL,\n \t\t\t\"FILE: %02X%02X%02X%02X\\n\",\n \t\t\toid[0],oid[1],oid[2],oid[3]);\n@@ -527,7 +529,8 @@ static int muscle_list_files(sc_card_t *card, u8 *buf, size_t bufLen)\n \t\t\tbuf[1] = oid[3];\n \t\t\tif(buf[0] == 0x00 && buf[1] == 0x00) continue; /* No directories/null names outside of root */\n \t\t\tbuf += 2;\n-\t\t\tcount+=2;\n+\t\t\tcount += 2;\n+\t\t\tbufLen -= 2;\n \t\t}\n \t}\n \treturn count;"
        },
        {
          "filename": "src/libopensc/card-tcos.c",
          "status": "modified",
          "additions": 3,
          "deletions": 3,
          "patch": "@@ -408,7 +408,7 @@ static int tcos_select_file(sc_card_t *card,\n \tfile->path = *in_path;\n \n \tfor(i=2; i+1<apdu.resplen && i+1+apdu.resp[i+1]<apdu.resplen; i+=2+apdu.resp[i+1]){\n-\t\tint j, len=apdu.resp[i+1];\n+\t\tsize_t j, len=apdu.resp[i+1];\n \t\tunsigned char type=apdu.resp[i], *d=apdu.resp+i+2;\n \n \t\tswitch (type) {\n@@ -432,8 +432,8 @@ static int tcos_select_file(sc_card_t *card,\n \t\t\tfile->id = (d[0]<<8) | d[1];\n \t\t\tbreak;\n \t\tcase 0x84:\n-\t\t\tmemcpy(file->name, d, len);\n-\t\t\tfile->namelen = len;\n+\t\t\tfile->namelen = MIN(sizeof file->name, len);\n+\t\t\tmemcpy(file->name, d, file->namelen);\n \t\t\tbreak;\n \t\tcase 0x86:\n \t\t\tsc_file_set_sec_attr(file, d, len); "
        },
        {
          "filename": "src/libopensc/pkcs15-esteid.c",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -79,7 +79,7 @@ sc_pkcs15emu_esteid_init (sc_pkcs15_card_t * p15card)\n \t/* read the serial (document number) */\n \tr = sc_read_record (card, SC_ESTEID_PD_DOCUMENT_NR, buff, sizeof(buff), SC_RECORD_BY_REC_NR);\n \tSC_TEST_RET(card->ctx, SC_LOG_DEBUG_NORMAL, r, \"read document number failed\");\n-\tbuff[r] = '\\0';\n+\tbuff[MIN((size_t) r, (sizeof buff)-1)] = '\\0';\n \tset_string (&p15card->tokeninfo->serial_number, (const char *) buff);\n \n \tp15card->tokeninfo->flags = SC_PKCS15_TOKEN_PRN_GENERATION"
        },
        {
          "filename": "src/libopensc/pkcs15-gemsafeV1.c",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -208,7 +208,7 @@ static int gemsafe_get_cert_len(sc_card_t *card)\n \t * the private key.\n \t */\n \tind = 2; /* skip length */\n-\twhile (ibuf[ind] == 0x01) {\n+\twhile (ibuf[ind] == 0x01 && i < gemsafe_cert_max) {\n \t\tif (ibuf[ind+1] == 0xFE) {\n \t\t\tgemsafe_prkeys[i].ref = ibuf[ind+4];\n \t\t\tsc_log(card->ctx, \"Key container %d is allocated and uses key_ref %d\","
        },
        {
          "filename": "src/libopensc/pkcs15-sc-hsm.c",
          "status": "modified",
          "additions": 8,
          "deletions": 6,
          "patch": "@@ -837,12 +837,14 @@ static int sc_pkcs15emu_sc_hsm_init (sc_pkcs15_card_t * p15card)\n \t\tr = read_file(p15card, (u8 *) \"\\x2F\\x02\", efbin, &len, 1);\n \t\tLOG_TEST_RET(card->ctx, r, \"Skipping optional EF.C_DevAut\");\n \n-\t\t/* save EF_C_DevAut for further use */\n-\t\tptr = realloc(priv->EF_C_DevAut, len);\n-\t\tif (ptr) {\n-\t\t\tmemcpy(ptr, efbin, len);\n-\t\t\tpriv->EF_C_DevAut = ptr;\n-\t\t\tpriv->EF_C_DevAut_len = len;\n+\t\tif (len > 0) {\n+\t\t\t/* save EF_C_DevAut for further use */\n+\t\t\tptr = realloc(priv->EF_C_DevAut, len);\n+\t\t\tif (ptr) {\n+\t\t\t\tmemcpy(ptr, efbin, len);\n+\t\t\t\tpriv->EF_C_DevAut = ptr;\n+\t\t\t\tpriv->EF_C_DevAut_len = len;\n+\t\t\t}\n \t\t}\n \n \t\tptr = efbin;"
        },
        {
          "filename": "src/libopensc/sc.c",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -628,7 +628,7 @@ int sc_file_set_sec_attr(sc_file_t *file, const u8 *sec_attr,\n \t\treturn SC_ERROR_INVALID_ARGUMENTS;\n \t}\n \n-\tif (sec_attr == NULL) {\n+\tif (sec_attr == NULL || sec_attr_len) {\n \t\tif (file->sec_attr != NULL)\n \t\t\tfree(file->sec_attr);\n \t\tfile->sec_attr = NULL;"
        },
        {
          "filename": "src/tools/cryptoflex-tool.c",
          "status": "modified",
          "additions": 3,
          "deletions": 2,
          "patch": "@@ -21,6 +21,7 @@\n #include \"config.h\"\n \n #include \"libopensc/sc-ossl-compat.h\"\n+#include \"libopensc/internal.h\"\n #include <openssl/bn.h>\n #include <openssl/rsa.h>\n #include <openssl/x509.h>\n@@ -331,7 +332,7 @@ static int read_public_key(RSA *rsa)\n \t\tfprintf(stderr, \"Unable to select public key file: %s\\n\", sc_strerror(r));\n \t\treturn 2;\n \t}\n-\tbufsize = file->size;\n+\tbufsize = MIN(file->size, sizeof buf);\n \tsc_file_free(file);\n \tr = sc_read_binary(card, 0, buf, bufsize, 0);\n \tif (r < 0) {\n@@ -382,7 +383,7 @@ static int read_private_key(RSA *rsa)\n \te = sc_file_get_acl_entry(file, SC_AC_OP_READ);\n \tif (e == NULL || e->method == SC_AC_NEVER)\n \t\treturn 10;\n-\tbufsize = file->size;\n+\tbufsize = MIN(file->size, sizeof buf);\n \tsc_file_free(file);\n \tr = sc_read_binary(card, 0, buf, bufsize, 0);\n \tif (r < 0) {"
        },
        {
          "filename": "src/tools/egk-tool.c",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -149,7 +149,7 @@ int read_file(struct sc_card *card, char *str_path, unsigned char **data, size_t\n \t\tgoto err;\n \t}\n \n-\tlen = file ? file->size : 4096;\n+\tlen = file && file->size > 0 ? file->size : 4096;\n \tp = realloc(*data, len);\n \tif (!p) {\n \t\tgoto err;"
        },
        {
          "filename": "src/tools/util.c",
          "status": "modified",
          "additions": 3,
          "deletions": 2,
          "patch": "@@ -339,10 +339,11 @@ const char * util_acl_to_str(const sc_acl_entry_t *e)\n \t\t\tstrcpy(buf, \"????\");\n \t\t\tbreak;\n \t\t}\n-\t\tstrcat(line, buf);\n-\t\tstrcat(line, \" \");\n+\t\tstrncat(line, buf, sizeof line);\n+\t\tstrncat(line, \" \", sizeof line);\n \t\te = e->next;\n \t}\n+\tline[(sizeof line)-1] = '\\0'; /* make sure it's NUL terminated */\n \tline[strlen(line)-1] = 0; /* get rid of trailing space */\n \treturn line;\n }"
        }
      ],
      "file_patterns": {
        "security_files": 1,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 2,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "2d77452e6760c50a7d2bab722b8e06137fee79ce",
            "date": "2025-01-09T14:15:58Z",
            "author_login": "xhanulik"
          },
          {
            "sha": "50e1009ce8c82a5948105273ef531dc3828d3255",
            "date": "2025-01-09T14:12:25Z",
            "author_login": "xhanulik"
          },
          {
            "sha": "59e2638a79fe28745461a6a6e673c978d6e198f3",
            "date": "2025-01-09T14:11:44Z",
            "author_login": "xhanulik"
          },
          {
            "sha": "8c1a26023c0da489577f253d596ce0a488252faa",
            "date": "2024-12-17T09:44:08Z",
            "author_login": "Jakuje"
          },
          {
            "sha": "4c24dfbba4bbe2777b4675636fd89d745784823c",
            "date": "2025-01-06T21:36:10Z",
            "author_login": "tpetazzoni"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": null,
    "cvss_vector": null,
    "cwe_id": "CWE-119",
    "description": "A buffer overflow when handling string concatenation in util_acl_to_str in tools/util.c in OpenSC before 0.19.0-rc1 could be used by attackers able to supply crafted smartcards to cause a denial of service (application crash) or possibly have unspecified other impact.",
    "attack_vector": null,
    "attack_complexity": null
  },
  "temporal_data": {
    "published_date": "2018-09-04T00:29:00.230",
    "last_modified": "2024-11-21T03:52:42.590",
    "fix_date": "2018-05-25T21:34:14Z"
  },
  "references": [
    {
      "url": "https://access.redhat.com/errata/RHSA-2019:2154",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "https://github.com/OpenSC/OpenSC/commit/360e95d45ac4123255a4c796db96337f332160ad#diff-628c8445c4e7ae92bbc4be08ba11a4c3",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/OpenSC/OpenSC/releases/tag/0.19.0-rc1",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2019/09/msg00009.html",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "https://www.x41-dsec.de/lab/advisories/x41-2018-002-OpenSC/",
      "source": "cve@mitre.org",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://access.redhat.com/errata/RHSA-2019:2154",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://github.com/OpenSC/OpenSC/commit/360e95d45ac4123255a4c796db96337f332160ad#diff-628c8445c4e7ae92bbc4be08ba11a4c3",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/OpenSC/OpenSC/releases/tag/0.19.0-rc1",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2019/09/msg00009.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://www.x41-dsec.de/lab/advisories/x41-2018-002-OpenSC/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T22:59:35.791531",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "OpenSC",
    "owner": "OpenSC",
    "created_at": "2011-07-05T09:45:08Z",
    "updated_at": "2025-01-13T13:10:21Z",
    "pushed_at": "2025-01-13T13:55:00Z",
    "size": 22961,
    "stars": 2633,
    "forks": 751,
    "open_issues": 133,
    "watchers": 2633,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "master"
    ],
    "languages": {
      "C": 7104257,
      "M4": 95841,
      "Shell": 94340,
      "Makefile": 59947,
      "C++": 26987,
      "Objective-C": 17726,
      "Roff": 13853,
      "Dockerfile": 4471,
      "Lex": 2042,
      "AppleScript": 530,
      "BitBake": 273
    },
    "commit_activity": {
      "total_commits_last_year": 306,
      "avg_commits_per_week": 5.884615384615385,
      "days_active_last_year": 130
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "lgpl-2.1"
    },
    "collected_at": "2025-01-14T13:02:30.052371"
  }
}