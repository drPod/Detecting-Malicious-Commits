{
  "cve_id": "CVE-2018-3759",
  "github_data": {
    "repository": "jtdowney/private_address_check",
    "fix_commit": "4068228187db87fea7577f7020099399772bb147",
    "related_commits": [
      "4068228187db87fea7577f7020099399772bb147",
      "4068228187db87fea7577f7020099399772bb147"
    ],
    "patch_url": "https://github.com/jtdowney/private_address_check/commit/4068228187db87fea7577f7020099399772bb147.patch",
    "fix_commit_details": {
      "sha": "4068228187db87fea7577f7020099399772bb147",
      "commit_date": "2018-05-04T01:05:19Z",
      "author": {
        "login": "jtdowney",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Fix TOCTOU bug",
        "length": 102,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 25,
        "additions": 19,
        "deletions": 6
      },
      "files": [
        {
          "filename": "README.md",
          "status": "modified",
          "additions": 11,
          "deletions": 1,
          "patch": "@@ -61,8 +61,18 @@ To install this gem onto your local machine, run `bundle exec rake install`. To\n \n Bug reports and pull requests are welcome on GitHub at https://github.com/jtdowney/private_address_check. This project is intended to be a safe, welcoming space for collaboration, and contributors are expected to adhere to the [Contributor Covenant](http://contributor-covenant.org) code of conduct.\n \n+## Security\n+\n+If you've found a security issue in `private_address_check`, please reach out to @jtdowney via email to report.\n+\n+### Time of check to time of use\n+\n+A library like `private_address_check` is going to be easily susceptible to attacks like [time of check to time of use](https://en.wikipedia.org/wiki/Time_of_check_to_time_of_use). DNS entries with a TTL of 0 can trigger this case where the initial resolution is a public address by the subsequent resolution is a private address. There are some possible defenses and workarounds:\n+\n+- Use the TCPSocket extension in this library which checks the address the socket uses. This is most useful if your system is built on native Ruby like Net::HTTP.\n+- Use a feature like the `resolve` capability in curl and [curb](https://www.rubydoc.info/github/taf2/curb/Curl/Easy#resolve=-instance_method) to force the resolution to a pre-checked IP address.\n+- Implement your own caching DNS resolver with something like dnsmasq or unbound. These tools let you set a minimum cache time that can override the TTL of 0.\n \n ## License\n \n The gem is available as open source under the terms of the [MIT License](http://opensource.org/licenses/MIT).\n-"
        },
        {
          "filename": "lib/private_address_check/tcpsocket_ext.rb",
          "status": "modified",
          "additions": 3,
          "deletions": 4,
          "patch": "@@ -14,11 +14,10 @@ def only_public_connections\n TCPSocket.class_eval do\n   alias initialize_without_private_address_check initialize\n \n-  def initialize(remote_host, remote_port, local_host = nil, local_port = nil)\n-    if Thread.current[:private_address_check] && PrivateAddressCheck.resolves_to_private_address?(remote_host)\n+  def initialize(*args)\n+    initialize_without_private_address_check(*args)\n+    if Thread.current[:private_address_check] && PrivateAddressCheck.resolves_to_private_address?(remote_address.ip_address)\n       raise PrivateAddressCheck::PrivateConnectionAttemptedError\n     end\n-\n-    initialize_without_private_address_check(remote_host, remote_port, local_host, local_port)\n   end\n end"
        },
        {
          "filename": "test/private_address_check/tcpsocket_ext_test.rb",
          "status": "modified",
          "additions": 5,
          "deletions": 1,
          "patch": "@@ -3,11 +3,15 @@\n \n class TCPSocketExtTest < Minitest::Test\n   def test_private_address\n+    server = TCPServer.new(63453)\n+    thread = Thread.start { server.accept }\n     assert_raises PrivateAddressCheck::PrivateConnectionAttemptedError do\n       PrivateAddressCheck.only_public_connections do\n-        TCPSocket.new(\"localhost\", 80)\n+        TCPSocket.new(\"localhost\", 63453)\n       end\n     end\n+  ensure\n+    thread.exit if thread\n   end\n \n   def test_public_address"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 3,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "31f93cbc5deec92321c5751afe344a76c042dc13",
            "date": "2024-06-18T14:40:28Z",
            "author_login": "jtdowney"
          },
          {
            "sha": "d05b2de2d89ebfcf7e9450dcee6fbc6656af8187",
            "date": "2024-06-18T13:33:41Z",
            "author_login": "mjankowski"
          },
          {
            "sha": "02b733435fb51dd14be27ac562e79aff40e78784",
            "date": "2021-04-14T13:39:59Z",
            "author_login": "jtdowney"
          },
          {
            "sha": "d27c88d843531254970212bb429948394ebe7555",
            "date": "2021-04-14T13:32:07Z",
            "author_login": "jtdowney"
          },
          {
            "sha": "e0ade581c07938cd4f2dd208fe811030449c9c40",
            "date": "2021-04-14T11:01:57Z",
            "author_login": "jtdowney"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": null,
    "cvss_vector": null,
    "cwe_id": "CWE-362",
    "description": "private_address_check ruby gem before 0.5.0 is vulnerable to a time-of-check time-of-use (TOCTOU) race condition due to the address the socket uses not being checked. DNS entries with a TTL of 0 can trigger this case where the initial resolution is a public address but the subsequent resolution is a private address.",
    "attack_vector": null,
    "attack_complexity": null
  },
  "temporal_data": {
    "published_date": "2018-06-13T15:29:00.267",
    "last_modified": "2024-11-21T04:06:01.377",
    "fix_date": "2018-05-04T01:05:19Z"
  },
  "references": [
    {
      "url": "https://github.com/jtdowney/private_address_check/commit/4068228187db87fea7577f7020099399772bb147",
      "source": "support@hackerone.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/jtdowney/private_address_check/commit/4068228187db87fea7577f7020099399772bb147",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T22:59:28.530793",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "private_address_check",
    "owner": "jtdowney",
    "created_at": "2016-07-20T22:30:48Z",
    "updated_at": "2024-06-18T14:40:32Z",
    "pushed_at": "2024-06-18T14:40:28Z",
    "size": 34,
    "stars": 42,
    "forks": 12,
    "open_issues": 1,
    "watchers": 42,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [],
    "languages": {
      "Ruby": 7145,
      "Shell": 131
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-14T14:34:40.764812"
  }
}