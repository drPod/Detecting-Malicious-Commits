{
  "cve_id": "CVE-2019-10765",
  "github_data": {
    "repository": "ioBroker/ioBroker.admin",
    "fix_commit": "16b2b325ab47896090bc7f54b77b0a97ed74f5cd",
    "related_commits": [
      "16b2b325ab47896090bc7f54b77b0a97ed74f5cd",
      "16b2b325ab47896090bc7f54b77b0a97ed74f5cd"
    ],
    "patch_url": "https://github.com/ioBroker/ioBroker.admin/commit/16b2b325ab47896090bc7f54b77b0a97ed74f5cd.patch",
    "fix_commit_details": {
      "sha": "16b2b325ab47896090bc7f54b77b0a97ed74f5cd",
      "commit_date": "2019-10-09T16:29:20Z",
      "author": {
        "login": "GermanBluefox",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "### 3.6.8 (2019-10-09)",
        "length": 97,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 1231,
        "additions": 662,
        "deletions": 569
      },
      "files": [
        {
          "filename": "README.md",
          "status": "modified",
          "additions": 7,
          "deletions": 6,
          "patch": "@@ -1,6 +1,5 @@\n ![Logo](admin/admin.png)\n # ioBroker.admin\n-===================\n \n [![NPM version](http://img.shields.io/npm/v/iobroker.admin.svg)](https://www.npmjs.com/package/iobroker.admin)\n [![Downloads](https://img.shields.io/npm/dm/iobroker.admin.svg)](https://www.npmjs.com/package/iobroker.admin)\n@@ -9,11 +8,9 @@\n \n [![NPM](https://nodei.co/npm/iobroker.admin.png?downloads=true)](https://nodei.co/npm/iobroker.admin/)\n \n-\n-User interface for configuration and administration.\n+User interface for configuration and administration of ioBroker.\n \n ## Using common.localLink\n-\n - %ip% - ioBroker ip address (address of the admin)\n - %secure% or %protocol% - read from native.secure the value and use http or https\n - %web_protocol% - looking for the first instance of web (e.g. web.0) and get \"native.secure\" from \"system.adapter.web.0\"\n@@ -82,6 +79,10 @@ This project uses some icons from [Flaticon](https://www.flaticon.com/):\n - <img src=\"src/img/rooms/toilet.svg\" height=\"48\" /> - Icons made by [Freepik](http://www.freepik.com) from [www.flaticon.com](https://www.flaticon.com/) is licensed by [CC 3.0 BY](http://creativecommons.org/licenses/by/3.0/)\n \n ## Changelog\n+### 3.6.8 (2019-10-09)\n+* (bluefox) Log paths were sanitized\n+* (bluefox) NPM packages were updated\n+\n ### 3.6.7 (2019-09-24)\n * (ldittmar) Add Node.JS version check to popup messages\n \n@@ -276,7 +277,7 @@ This project uses some icons from [Flaticon](https://www.flaticon.com/):\n \n ### 3.0.11 (2018-01-11)\n * (DeepCoreSystem) French update\n-* (bluefox) fix error with empty ID \n+* (bluefox) fix error with empty ID\n * (bluefox) add sort by \"recently updated\"\n * (ldittmar) add readme and issues viewer\n \n@@ -287,7 +288,7 @@ This project uses some icons from [Flaticon](https://www.flaticon.com/):\n \n ### 3.0.7 (2018-01-01)\n * (soef) update instances, objects and other lists\n-* (bluefox) rewrite interface with materialize \n+* (bluefox) rewrite interface with materialize\n \n ### 2.0.11 (2017-10-23)\n * (bluefox) Configurable event update disable threshold"
        },
        {
          "filename": "gulpfile.js",
          "status": "modified",
          "additions": 5,
          "deletions": 5,
          "patch": "@@ -493,13 +493,13 @@ gulp.task('materializeJS', () => {\n     .pipe(concat('materialize.js'))\n     .pipe(babel({\n         plugins: [\n-            'transform-es2015-arrow-functions',\n-            'transform-es2015-block-scoping',\n-            'transform-es2015-classes',\n-            'transform-es2015-template-literals'\n+            '@babel/plugin-transform-arrow-functions',\n+            '@babel/plugin-transform-block-scoping',\n+            '@babel/plugin-transform-classes',\n+            '@babel/plugin-transform-template-literals'\n         ]\n     }))\n-    .pipe(uglify())    \n+    .pipe(uglify())\n     .pipe(sourcemaps.write('.'))\n     .pipe(gulp.dest('./www/lib/js'));\n });"
        },
        {
          "filename": "io-package.json",
          "status": "modified",
          "additions": 15,
          "deletions": 4,
          "patch": "@@ -2,7 +2,7 @@\n   \"common\": {\n     \"name\": \"admin\",\n     \"title\": \"Admin\",\n-    \"version\": \"3.6.7\",\n+    \"version\": \"3.6.8\",\n     \"news\": {\n       \"3.6.7\": {\n         \"en\": \"Add Node.JS version check to popup messages\",\n@@ -16,7 +16,18 @@\n         \"pl\": \"Dodaj sprawdzanie wersji Node.JS do wyskakuj\u0105cych wiadomo\u015bci\",\n         \"zh-cn\": \"\u5c06Node.JS\u7248\u672c\u68c0\u67e5\u6dfb\u52a0\u5230\u5f39\u51fa\u6d88\u606f\"\n       },\n-      \"3.6.6\": {\n+      \"3.6.7\": {\n+        \"en\": \"Add Node.JS version check to popup messages\",\n+        \"de\": \"Node.JS-Versionspr\u00fcfung zu Popup-Nachrichten hinzuf\u00fcgen\",\n+        \"ru\": \"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u043f\u0440\u043e\u0432\u0435\u0440\u043a\u0443 \u0432\u0435\u0440\u0441\u0438\u0438 Node.JS \u0432\u043e \u0432\u0441\u043f\u043b\u044b\u0432\u0430\u044e\u0449\u0438\u0435 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f\",\n+        \"pt\": \"Adicione a verifica\u00e7\u00e3o da vers\u00e3o do Node.JS \u00e0s mensagens pop-up\",\n+        \"nl\": \"Voeg Node.JS versiecontrole toe aan pop-upberichten\",\n+        \"fr\": \"Ajouter la v\u00e9rification de la version de Node.JS aux messages contextuels\",\n+        \"it\": \"Aggiungi il controllo versione Node.JS ai messaggi popup\",\n+        \"es\": \"Agregar verificaci\u00f3n de versi\u00f3n de Node.JS a mensajes emergentes\",\n+        \"pl\": \"Dodaj sprawdzanie wersji Node.JS do wyskakuj\u0105cych wiadomo\u015bci\",\n+        \"zh-cn\": \"\u5c06Node.JS\u7248\u672c\u68c0\u67e5\u6dfb\u52a0\u5230\u5f39\u51fa\u6d88\u606f\"\n+      },\"3.6.6\": {\n         \"en\": \"update some words translation\",\n         \"de\": \"Aktualisieren Sie einige W\u00f6rter \u00dcbersetzung\",\n         \"ru\": \"\u043e\u0431\u043d\u043e\u0432\u0438\u0442\u044c \u043f\u0435\u0440\u0435\u0432\u043e\u0434 \u043d\u0435\u043a\u043e\u0442\u043e\u0440\u044b\u0445 \u0441\u043b\u043e\u0432\",\n@@ -87,7 +98,7 @@\n         \"es\": \"Integraci\u00f3n del adaptador de informaci\u00f3n\",\n         \"pl\": \"Integracja adaptera informacyjnego\",\n         \"zh-cn\": \"\u4fe1\u606f\u9002\u914d\u5668\u96c6\u6210\"\n-      },    \n+      },\n       \"3.6.0\": {\n         \"en\": \"Added Chinese translations\\nNew informative states added about updates\",\n         \"de\": \"Chinesische \u00dcbersetzungen hinzugef\u00fcgt\\nNeue Informationsst\u00e4nde zu Updates hinzugef\u00fcgt\",\n@@ -162,7 +173,7 @@\n       \"fr\": \"docs/fr/admin.md\",\n       \"it\": \"docs/it/admin.md\",\n       \"pl\": \"docs/pl/admin.md\",\n-      \"zh-cn\": \"docs/zh-cn/admin.md\"            \n+      \"zh-cn\": \"docs/zh-cn/admin.md\"\n     },\n     \"materialize\": true,\n     \"mode\": \"daemon\","
        },
        {
          "filename": "lib/socket.js",
          "status": "modified",
          "additions": 58,
          "deletions": 28,
          "patch": "@@ -9,8 +9,10 @@ const request  = require('request');\n const path     = require('path');\r\n const fs       = require('fs');\r\n \r\n-function IOSocket(server, settings, adapter, objects, states, store) {\r\n-    if (!(this instanceof IOSocket)) return new IOSocket(server, settings, adapter, objects, states, store);\r\n+function IOSocket(server, settings, adapter, objects, store) {\r\n+    if (!(this instanceof IOSocket)) {\r\n+        return new IOSocket(server, settings, adapter, objects, store);\r\n+    }\r\n \r\n     const userKey = 'connect.sid'; // const\r\n     const cmdSessions = {};\r\n@@ -19,6 +21,7 @@ function IOSocket(server, settings, adapter, objects, states, store) {\n     this.subscribes = {};\r\n     let cookieParser;\r\n     let passport;\r\n+    let states = {};\r\n \r\n     if (settings.auth) {\r\n         cookieParser = require('cookie-parser');\r\n@@ -433,10 +436,13 @@ function IOSocket(server, settings, adapter, objects, states, store) {\n \r\n     this.unsubscribe = function (socket, type, pattern) {\r\n         //console.log((socket._name || socket.id) + ' unsubscribe ' + pattern);\r\n-        if (!this.subscribes[type]) this.subscribes[type] = {};\r\n+        this.subscribes[type] = this.subscribes[type] || {};\r\n \r\n         if (socket) {\r\n-            if (!socket._subscribe || !socket._subscribe[type]) return;\r\n+            if (!socket._subscribe || !socket._subscribe[type]) {\r\n+                return;\r\n+            }\r\n+\r\n             for (let i = socket._subscribe[type].length - 1; i >= 0; i--) {\r\n                 if (socket._subscribe[type][i].pattern === pattern) {\r\n \r\n@@ -539,7 +545,7 @@ function IOSocket(server, settings, adapter, objects, states, store) {\n                     adapter.subscribeForeignObjects && adapter.subscribeForeignObjects(pattern);\r\n                 } else if (type === 'log') {\r\n                     adapter.log.debug('Subscribe LOGS');\r\n-                    if (adapter.requireLog) adapter.requireLog(true);\r\n+                    adapter.requireLog && adapter.requireLog(true);\r\n                 }\r\n             } else {\r\n                 that.subscribes[type][pattern]++;\r\n@@ -692,7 +698,7 @@ function IOSocket(server, settings, adapter, objects, states, store) {\n         socket.on('getStates', function (callback) {\r\n             if (updateSession(socket) && checkPermissions(socket, 'getStates', callback)) {\r\n                 if (typeof callback === 'function') {\r\n-                    callback(null, states);\r\n+                    adapter.getForeignStates('*', callback);\r\n                 } else {\r\n                     adapter.log.warn('[getStates] Invalid callback')\r\n                 }\r\n@@ -702,7 +708,11 @@ function IOSocket(server, settings, adapter, objects, states, store) {\n         socket.on('getState', function (id, callback) {\r\n             if (updateSession(socket) && checkPermissions(socket, 'getState', callback, id)) {\r\n                 if (typeof callback === 'function') {\r\n-                    callback(null, states[id]);\r\n+                    if (states[id]) {\r\n+                        callback(null, states[id]);\r\n+                    } else {\r\n+                        adapter.getForeignState(id, callback);\r\n+                    }\r\n                 } else {\r\n                     adapter.log.warn('[getState] Invalid callback')\r\n                 }\r\n@@ -711,13 +721,11 @@ function IOSocket(server, settings, adapter, objects, states, store) {\n \r\n         socket.on('getForeignStates', function (pattern, callback) {\r\n             if (updateSession(socket) && checkPermissions(socket, 'getStates', callback)) {\r\n-                adapter.getForeignStates(pattern, function (err, objs) {\r\n-                    if (typeof callback === 'function') {\r\n-                        callback(err, objs);\r\n-                    } else {\r\n-                        adapter.log.warn('[getForeignStates] Invalid callback')\r\n-                    }\r\n-                });\r\n+                if (typeof callback === 'function') {\r\n+                    adapter.getForeignStates(pattern, callback);\r\n+                } else {\r\n+                    adapter.log.warn('[getForeignStates] Invalid callback')\r\n+                }\r\n             }\r\n         });\r\n \r\n@@ -727,16 +735,22 @@ function IOSocket(server, settings, adapter, objects, states, store) {\n                     state = {val: state};\r\n                 }\r\n \r\n-                adapter.setForeignState(id, state, {user: this._acl.user}, function (err, res) {\r\n-                    if (typeof callback === 'function') {\r\n-                        callback(err, res);\r\n-                    }\r\n-                });\r\n+                // clear cache\r\n+                if (states[id]) {\r\n+                    delete states[id];\r\n+                }\r\n+\r\n+                adapter.setForeignState(id, state, {user: this._acl.user}, (err, res) =>\r\n+                    typeof callback === 'function' && callback(err, res));\r\n             }\r\n         });\r\n \r\n         socket.on('delState', function (id, callback) {\r\n             if (updateSession(socket) && checkPermissions(socket, 'delState', callback, id)) {\r\n+                // clear cache\r\n+                if (states[id]) {\r\n+                    delete states[id];\r\n+                }\r\n                 adapter.delForeignState(id, {user: this._acl.user}, callback);\r\n             }\r\n         });\r\n@@ -965,7 +979,6 @@ function IOSocket(server, settings, adapter, objects, states, store) {\n             }\r\n         });\r\n \r\n-\r\n         socket.on('unsubscribe', function (pattern, callback) {\r\n             if (updateSession(socket) && checkPermissions(socket, 'unsubscribe', callback, pattern)) {\r\n                 if (pattern && typeof pattern === 'object' && pattern instanceof Array) {\r\n@@ -975,10 +988,13 @@ function IOSocket(server, settings, adapter, objects, states, store) {\n                 } else {\r\n                     that.unsubscribe(this, 'stateChange', pattern);\r\n                 }\r\n-                if (adapter.log.level === 'debug') showSubscribes(socket, 'stateChange');\r\n-                if (typeof callback === 'function') {\r\n-                    setImmediate(callback, null);\r\n-                }\r\n+\r\n+                // reset states cache on unsubscribe\r\n+                states = {};\r\n+\r\n+                adapter.log.level === 'debug' && showSubscribes(socket, 'stateChange');\r\n+\r\n+                typeof callback === 'function' && setImmediate(callback, null);\r\n             }\r\n         });\r\n \r\n@@ -1168,7 +1184,7 @@ function IOSocket(server, settings, adapter, objects, states, store) {\n             adapter.log.info('Subscribe on all states again');\r\n \r\n             setTimeout(function () {\r\n-                if (readAll) {\r\n+                /*if (readAll) {\r\n                     adapter.getForeignStates('*', function (err, res) {\r\n                         adapter.log.info('received all states');\r\n                         for (const id in res) {\r\n@@ -1178,11 +1194,14 @@ function IOSocket(server, settings, adapter, objects, states, store) {\n                             }\r\n                         }\r\n                     });\r\n-                }\r\n+                }*/\r\n \r\n                 that.server.sockets.emit('eventsThreshold', false);\r\n                 adapter.unsubscribeForeignStates('system.adapter.*');\r\n-                adapter.subscribeForeignStates('*');\r\n+\r\n+                Object.keys(that.subscribes.stateChange).forEach(pattern =>\r\n+                    adapter.subscribeForeignStates(pattern));\r\n+\r\n             }, 50);\r\n         }\r\n     }\r\n@@ -1196,7 +1215,10 @@ function IOSocket(server, settings, adapter, objects, states, store) {\n                 eventsThreshold.timeActivated = new Date().getTime();\r\n \r\n                 that.server.sockets.emit('eventsThreshold', true);\r\n-                adapter.unsubscribeForeignStates('*');\r\n+\r\n+                Object.keys(that.subscribes.stateChange).forEach(pattern =>\r\n+                    adapter.unsubscribeForeignStates(pattern));\r\n+\r\n                 adapter.subscribeForeignStates('system.adapter.*');\r\n             }, 100);\r\n         }\r\n@@ -1240,6 +1262,13 @@ function IOSocket(server, settings, adapter, objects, states, store) {\n     };\r\n \r\n     this.stateChange = function (id, state) {\r\n+        if (!state) {\r\n+            if (states[id]) {\r\n+                delete states[id];\r\n+            }\r\n+        } else {\r\n+            states[id] = state;\r\n+        }\r\n         const clients = that.server.sockets.connected;\r\n \r\n         if (!eventsThreshold.active) {\r\n@@ -1309,4 +1338,5 @@ function IOSocket(server, settings, adapter, objects, states, store) {\n \r\n     return this;\r\n }\r\n+\r\n module.exports = IOSocket;\n\\ No newline at end of file"
        },
        {
          "filename": "lib/web.js",
          "status": "modified",
          "additions": 75,
          "deletions": 15,
          "patch": "@@ -21,6 +21,55 @@ let cookieParser;\n let fileUpload;\r\n let socketIoFile;\r\n \r\n+// copied from here: https://github.com/component/escape-html/blob/master/index.js\r\n+const matchHtmlRegExp = /[\"'&<>]/;\r\n+function escapeHtml (string) {\r\n+    const str = '' + string;\r\n+    const match = matchHtmlRegExp.exec(str);\r\n+\r\n+    if (!match) {\r\n+        return str;\r\n+    }\r\n+\r\n+    let escape;\r\n+    let html = '';\r\n+    let index = 0;\r\n+    let lastIndex = 0;\r\n+\r\n+    for (index = match.index; index < str.length; index++) {\r\n+        switch (str.charCodeAt(index)) {\r\n+            case 34: // \"\r\n+                escape = '&quot;';\r\n+                break;\r\n+            case 38: // &\r\n+                escape = '&amp;';\r\n+                break;\r\n+            case 39: // '\r\n+                escape = '&#39;';\r\n+                break;\r\n+            case 60: // <\r\n+                escape = '&lt;';\r\n+                break;\r\n+            case 62: // >\r\n+                escape = '&gt;';\r\n+                break;\r\n+            default:\r\n+                continue;\r\n+        }\r\n+\r\n+        if (lastIndex !== index) {\r\n+            html += str.substring(lastIndex, index);\r\n+        }\r\n+\r\n+        lastIndex = index + 1;\r\n+        html += escape;\r\n+    }\r\n+\r\n+    return lastIndex !== index\r\n+        ? html + str.substring(lastIndex, index)\r\n+        : html;\r\n+}\r\n+\r\n function Web(settings, adapter, onReady) {\r\n     if (!(this instanceof Web)) return new Web(settings, adapter, onReady);\r\n     const server = {\r\n@@ -231,15 +280,23 @@ function Web(settings, adapter, onReady) {\n \r\n                 server.app.post('/login', (req, res, next) => {\r\n                     let redirect = '/';\r\n-                    if (req.body.origin) {\r\n-                        const parts = req.body.origin.match(/href=(.+)$/);\r\n+                    const origin = (req.body && req.body.origin) || '?href=%2F';\r\n+                    if (origin) {\r\n+                        const parts = origin.match(/href=(.+)$/);\r\n                         if (parts && parts[1]) {\r\n                             redirect = decodeURIComponent(parts[1]);\r\n+                            // if some invalid characters in redirect\r\n+                            if (redirect.match(/[^-_a-zA-Z0-9&%?.]/)) {\r\n+                                redirect = '/';\r\n+                            }\r\n                         }\r\n                     }\r\n+                    req.body.password = ((req.body && req.body.password) || '').toString();\r\n+                    req.body.username = ((req.body && req.body.username) || '').toString();\r\n+\r\n                     passport.authenticate('local', {\r\n                         successRedirect: redirect,\r\n-                        failureRedirect: '/login/index.html' + req.body.origin + (req.body.origin ? '&error' : '?error'),\r\n+                        failureRedirect: '/login/index.html' + origin + (origin ? '&error' : '?error'),\r\n                         failureFlash:    'Invalid username or password.'\r\n                     })(req, res, next);\r\n                 });\r\n@@ -324,7 +381,7 @@ function Web(settings, adapter, onReady) {\n \r\n                 adapter.getBinaryState('system.host.' + adapter.host + '.zip.' + filename, (err, buff) => {\r\n                     if (err) {\r\n-                        res.status(500).send(err);\r\n+                        res.status(500).send(escapeHtml(typeof err === 'string' ? err : JSON.stringify(err)));\r\n                     } else {\r\n                         if (!buff) {\r\n                             res.status(404).send('File package.zip not found');\r\n@@ -340,27 +397,30 @@ function Web(settings, adapter, onReady) {\n \r\n             // send log files\r\n             server.app.get('/log/*', (req, res) => {\r\n-                let parts = req.url.split('/');\r\n+                let parts = decodeURIComponent(req.url).split('/');\r\n                 parts = parts.splice(2);\r\n                 const transport = parts.shift();\r\n                 let filename = parts.join('/');\r\n                 const config = adapter.systemConfig;\r\n                 // detect file log\r\n                 if (config && config.log && config.log.transport) {\r\n                     if (config.log.transport.hasOwnProperty(transport) && config.log.transport[transport].type === 'file') {\r\n+                        let logFolder;\r\n                         if (config.log.transport[transport].filename) {\r\n                             parts = config.log.transport[transport].filename.replace(/\\\\/g, '/').split('/');\r\n                             parts.pop();\r\n-                            filename = path.join(parts.join('/'), filename);\r\n+                            logFolder = path.normalize(parts.join('/'));\r\n                         } else {\r\n-                            filename = path.join('log/', filename) ;\r\n+                            logFolder = path.join(process.cwd(), 'log');\r\n                         }\r\n \r\n-                        if (filename[0] !== '/' && !filename.match(/^\\W:/)) {\r\n-                            filename = path.normalize(__dirname + '/../../../') + filename;\r\n+                        if (logFolder[0] !== '/' && logFolder[0] !== '\\\\' && !logFolder.match(/^[a-zA-Z]:/)) {\r\n+                            logFolder = path.normalize(path.join(__dirname + '/../../../', logFolder));\r\n                         }\r\n \r\n-                        if (fs.existsSync(filename)) {\r\n+                        filename = path.normalize(path.join(logFolder, filename));\r\n+\r\n+                        if (filename.startsWith(logFolder) && fs.existsSync(filename)) {\r\n                             const stat = fs.lstatSync(filename);\r\n                             if (stat.size > 2 * 1024 * 1024) {\r\n                                 res.sendFile(filename);\r\n@@ -372,7 +432,7 @@ function Web(settings, adapter, onReady) {\n                         }\r\n                     }\r\n                 }\r\n-                res.status(404).send('File ' + filename + ' not found');\r\n+                res.status(404).send('File ' + escapeHtml(filename) + ' not found');\r\n             });\r\n             const appOptions = {};\r\n             if (settings.cache) {\r\n@@ -384,7 +444,7 @@ function Web(settings, adapter, onReady) {\n                 fileUpload = fileUpload || require('express-fileupload');\r\n                 server.app.use(fileUpload({\r\n                     useTempFiles: true,\r\n-                    tempFilePath: settings.tmpPath\r\n+                    tempFileDir: settings.tmpPath\r\n                 }));\r\n                 server.app.post('/upload', (req, res) => {\r\n                     if (!req.files) {\r\n@@ -393,6 +453,7 @@ function Web(settings, adapter, onReady) {\n \r\n                     // The name of the input field (i.e. \"sampleFile\") is used to retrieve the uploaded file\r\n                     let myFile;\r\n+                    // take first non empty file\r\n                     for (const name in req.files) {\r\n                         if (req.files.hasOwnProperty(name)) {\r\n                             myFile = req.files[name];\r\n@@ -407,7 +468,7 @@ function Web(settings, adapter, onReady) {\n                         // Use the mv() method to place the file somewhere on your server\r\n                         myFile.mv(settings.tmpPath + '/restore.iob', err =>  {\r\n                             if (err) {\r\n-                                res.status(500).send(err);\r\n+                                res.status(500).send(escapeHtml(typeof err === 'string' ? err : JSON.stringify(err)));\r\n                             } else {\r\n                                 res.send('File uploaded!');\r\n                             }\r\n@@ -428,7 +489,6 @@ function Web(settings, adapter, onReady) {\n \r\n             // reverse proxy with url rewrite for couchdb attachments in <adapter-name>.admin\r\n             server.app.use('/adapter/', (req, res) => {\r\n-\r\n                 // Example: /example/?0\r\n                 let url = req.url;\r\n \r\n@@ -470,7 +530,7 @@ function Web(settings, adapter, onReady) {\n                 adapter.readFile(id, url, null, (err, buffer, mimeType) => {\r\n                     if (!buffer || err) {\r\n                         res.contentType('text/html');\r\n-                        res.status(404).send('File ' + url + ' not found');\r\n+                        res.status(404).send('File ' + escapeHtml(url) + ' not found');\r\n                     } else {\r\n                         if (mimeType) {\r\n                             res.contentType(mimeType['content-type'] || mimeType);\r"
        },
        {
          "filename": "main.js",
          "status": "modified",
          "additions": 77,
          "deletions": 100,
          "patch": "@@ -14,17 +14,19 @@\n 'use strict';\r\n \r\n const adapterName = require('./package.json').name.split('.').pop();\r\n-const utils = require('@iobroker/adapter-core'); // Get common adapter utils\r\n+const utils       = require('@iobroker/adapter-core'); // Get common adapter utils\r\n const tools \t  = require(utils.controllerDir + '/lib/tools.js');\r\n const SocketIO    = require('./lib/socket');\r\n const Web         = require('./lib/web');\r\n \r\n-let socket      = null;\r\n-let webServer   = null;\r\n+const ONE_HOUR_MS = 3600000;\r\n+const ERROR_PERMISSION = 'permissionError';\r\n \r\n-let objects     = {};\r\n-let states      = {};\r\n-let secret      = 'Zgfr56gFe87jJOM'; // Will be generated by first start\r\n+let socket        = null;\r\n+let webServer     = null;\r\n+\r\n+let objects       = {};\r\n+let secret        = 'Zgfr56gFe87jJOM'; // Will be generated by first start\r\n let adapter;\r\n \r\n function startAdapter(options) {\r\n@@ -55,23 +57,11 @@ function startAdapter(options) {\n         }\r\n \r\n         // TODO Build in some threshold of messages\r\n-        if (socket) {\r\n-            socket.objectChange(id, obj);\r\n-        }\r\n+        socket && socket.objectChange(id, obj);\r\n     });\r\n \r\n-    adapter.on('stateChange', (id, state) => {\r\n-        if (!state) {\r\n-            if (states[id]) {\r\n-                delete states[id];\r\n-            }\r\n-        } else {\r\n-            states[id] = state;\r\n-        }\r\n-        if (socket) {\r\n-            socket.stateChange(id, state);\r\n-        }\r\n-    });\r\n+    adapter.on('stateChange', (id, state) =>\r\n+        socket && socket.stateChange(id, state));\r\n \r\n     adapter.on('ready', () => {\r\n         adapter.getForeignObject('system.config', (err, obj) => {\r\n@@ -99,18 +89,14 @@ function startAdapter(options) {\n             return false;\r\n         }\r\n \r\n-        if (socket) {\r\n-            socket.sendCommand(obj);\r\n-        }\r\n+        socket && socket.sendCommand(obj);\r\n \r\n         return true;\r\n     });\r\n \r\n     adapter.on('unload', callback => {\r\n-        if (socket) {\r\n-            // unsubscribe all\r\n-            socket.unsubscribeAll();\r\n-        }\r\n+        // unsubscribe all\r\n+        socket && socket.unsubscribeAll();\r\n \r\n         try {\r\n             adapter.log.info('terminating http' + (adapter.config.secure ? 's' : '') + ' server on port ' + adapter.config.port);\r\n@@ -320,53 +306,10 @@ function writeUpdateInfo(sources) {\n         let updateTime = new Date();\r\n         adapter.setState('info.lastUpdateCheck', new Date(updateTime - updateTime.getTimezoneOffset() * 60000).toISOString(), true);\r\n     });\r\n-\r\n-}\r\n-\r\n-// to do => remove it later, when all repositories patched.\r\n-function patchRepos(callback) {\r\n-    return callback && callback();\r\n-    // do not patch any more. Delete it later 2018.04.23\r\n-    /*\r\n-    adapter.getForeignObject('system.repositories', (err, obj) => {\r\n-        let changed = false;\r\n-        if (obj && obj.native && obj.native.repositories) {\r\n-            // default link should point to stable\r\n-            if (!obj.native.repositories.default || obj.native.repositories.default.link !== 'http://download.iobroker.net/sources-dist.json') {\r\n-                changed = true;\r\n-                obj.native.repositories.default = {\r\n-                    link: 'http://download.iobroker.net/sources-dist.json'\r\n-                };\r\n-            }\r\n-            // latest link should point to latest\r\n-            if (!obj.native.repositories.latest) {\r\n-                obj.native.repositories.latest = {\r\n-                    link: 'http://download.iobroker.net/sources-dist-latest.json'\r\n-                };\r\n-                changed = true;\r\n-            }\r\n-\r\n-            // change URL of raw sources from ioBroker.js-controller to ioBroker.repositories\r\n-            for (let r in obj.native.repositories) {\r\n-                if (obj.native.repositories.hasOwnProperty(r) &&\r\n-                    obj.native.repositories[r].link === 'https://raw.githubusercontent.com/ioBroker/ioBroker.js-controller/master/conf/sources-dist.json') {\r\n-                    obj.native.repositories[r].link = 'https://raw.githubusercontent.com/ioBroker/ioBroker.repositories/master/sources-dist.json';\r\n-                    changed = true;\r\n-                }\r\n-            }\r\n-        }\r\n-        if (changed) {\r\n-            adapter.setForeignObject(obj._id, obj, function () {\r\n-                callback && callback();\r\n-            });\r\n-        } else {\r\n-            callback && callback();\r\n-        }\r\n-    });*/\r\n }\r\n \r\n function initSocket(server, store) {\r\n-    socket = new SocketIO(server, adapter.config, adapter, objects, states, store);\r\n+    socket = new SocketIO(server, adapter.config, adapter, objects, store);\r\n     socket.subscribe(null, 'objectChange', '*');\r\n }\r\n \r\n@@ -391,30 +334,30 @@ function main() {\n         getData(() => webServer = new Web(adapter.config, adapter, initSocket));\r\n     }\r\n \r\n-    patchRepos(() => {\r\n-        // By default update repository every 24 hours\r\n-        if (adapter.config.autoUpdate === undefined) {\r\n-            adapter.config.autoUpdate = 24;\r\n-        }\r\n-        adapter.config.autoUpdate = parseInt(adapter.config.autoUpdate, 10) || 0;\r\n-        if (adapter.config.autoUpdate) {\r\n-            setInterval(() => updateRegister(), adapter.config.autoUpdate * 3600000);\r\n-            updateRegister();\r\n-        }\r\n-    });\r\n+    // By default update repository every 24 hours\r\n+    if (adapter.config.autoUpdate === undefined || adapter.config.autoUpdate === null) {\r\n+        adapter.config.autoUpdate = 24;\r\n+    }\r\n+\r\n+    // interval in hours\r\n+    adapter.config.autoUpdate = parseInt(adapter.config.autoUpdate, 10) || 0;\r\n+\r\n+    adapter.config.autoUpdate && updateRegister();\r\n }\r\n \r\n function getData(callback) {\r\n     adapter.log.info('requesting all states');\r\n-    let tasks = 0;\r\n+    /*\r\n     tasks++;\r\n+\r\n     adapter.getForeignStates('*', (err, res) => {\r\n         adapter.log.info('received all states');\r\n         states = res;\r\n         !--tasks && callback && callback();\r\n-    });\r\n+    });*/\r\n+\r\n     adapter.log.info('requesting all objects');\r\n-    tasks++;\r\n+\r\n     adapter.objects.getObjectList({include_docs: true}, (err, res) => {\r\n         adapter.log.info('received all objects');\r\n         if (res) {\r\n@@ -439,25 +382,59 @@ function getData(callback) {\n             writeUpdateInfo();\r\n         }\r\n \r\n-        !--tasks && callback && callback();\r\n+        callback && callback();\r\n     });\r\n }\r\n \r\n // read repository information from active repository\r\n-function updateRegister() {\r\n-    adapter.log.info('Request actual repository...');\r\n-    adapter.getForeignObject('system.config', (err, data) => {\r\n-        if (data && data.common) {\r\n-            adapter.sendToHost(adapter.host, 'getRepository', {\r\n-                repo:   data.common.activeRepo,\r\n-                update: true\r\n-            }, _repository => {\r\n-                if (_repository === 'permissionError') {\r\n-                    adapter.log.error('May not read \"getRepository\"');\r\n-                } else {\r\n-                    adapter.log.info('Repository received successfully.');\r\n+function updateRegister(isForce) {\r\n+    adapter.getForeignObject('system.config', (err, systemConfig) => {\r\n+        err && adapter.log.error('May not read \"system.config\"');\r\n+\r\n+        if (systemConfig && systemConfig.common) {\r\n+            adapter.getForeignObject('system.repositories', (err, repos) => {\r\n+                err && adapter.log.error('May not read \"system.repositories\"');\r\n+                // Check if repositories exists\r\n+                let exists = false;\r\n+                const active = systemConfig.common.activeRepo;\r\n+\r\n+                // if repo is valid and actual\r\n+                if (!err &&\r\n+                    repos &&\r\n+                    repos.native &&\r\n+                    repos.native.repositories &&\r\n+                    repos.native.repositories[active] &&\r\n+                    Date.now() < repos.ts + adapter.config.autoUpdate * ONE_HOUR_MS) {\r\n+                    exists = true;\r\n+                }\r\n \r\n-                    socket && socket.repoUpdated();\r\n+                if (!exists || isForce) {\r\n+                    adapter.log.info('Request actual repository...');\r\n+                    // request repo from host\r\n+                    adapter.sendToHost(adapter.host, 'getRepository', {\r\n+                        repo:   active,\r\n+                        update: true\r\n+                    }, _repository => {\r\n+                        if (_repository === ERROR_PERMISSION) {\r\n+                            adapter.log.error('May not read \"getRepository\"');\r\n+                        } else {\r\n+                            adapter.log.info('Repository received successfully.');\r\n+\r\n+                            socket && socket.repoUpdated();\r\n+                        }\r\n+\r\n+                        // start next cycle\r\n+                        if (adapter.config.autoUpdate) {\r\n+                            adapter.timerRepo && clearInterval(adapter.timerRepo);\r\n+                            adapter.log.debug('Next repo update on ' + new Date(Date.now() + adapter.config.autoUpdate * ONE_HOUR_MS + 1).toLocaleString());\r\n+                            adapter.timerRepo = setTimeout(() => updateRegister(), adapter.config.autoUpdate * ONE_HOUR_MS + 1);\r\n+                        }\r\n+                    });\r\n+                } else if (adapter.config.autoUpdate) {\r\n+                    const interval = repos.ts + adapter.config.autoUpdate * ONE_HOUR_MS - Date.now() + 1;\r\n+                    adapter.log.debug('Next repo update on ' + new Date(Date.now() + interval).toLocaleString());\r\n+                    adapter.timerRepo && clearInterval(adapter.timerRepo);\r\n+                    adapter.timerRepo = setTimeout(() => updateRegister(), interval);\r\n                 }\r\n             });\r\n         }\r"
        },
        {
          "filename": "package.json",
          "status": "modified",
          "additions": 25,
          "deletions": 25,
          "patch": "@@ -1,7 +1,7 @@\n {\n   \"name\": \"iobroker.admin\",\n   \"description\": \"The adapter opens a webserver for the ioBroker admin UI.\",\n-  \"version\": \"3.6.7\",\n+  \"version\": \"3.6.8\",\n   \"contributors\": [\n     \"bluefox <dogafox@gmail.com>\",\n     \"apollon77\",\n@@ -19,41 +19,41 @@\n     \"setup\"\n   ],\n   \"dependencies\": {\n-    \"body-parser\": \"^1.18.2\",\n+    \"body-parser\": \"^1.19.0\",\n     \"connect-flash\": \"^0.1.1\",\n-    \"cookie-parser\": \"^1.4.3\",\n-    \"express\": \"^4.16.3\",\n-    \"express-fileupload\": \"https://github.com/screenmeet/express-fileupload/tarball/8d8f5d9b7cec2d7c17e6d85654edf1c0aaa5fa82\",\n-    \"express-session\": \"^1.15.6\",\n+    \"cookie-parser\": \"^1.4.4\",\n+    \"express\": \"^4.17.1\",\n+    \"express-fileupload\": \"^1.1.6-alpha.5\",\n+    \"express-session\": \"^1.16.2\",\n     \"passport\": \"^0.4.0\",\n     \"passport-local\": \"^1.0.0\",\n     \"passport.socketio\": \"^3.7.0\",\n-    \"request\": \"^2.85.0\",\n+    \"request\": \"^2.88.0\",\n     \"socket.io\": \"1.7.2\",\n-    \"xtend\": \"^4.0.1\",\n+    \"xtend\": \"^4.0.2\",\n     \"@iobroker/adapter-core\": \"^1.0.3\"\n   },\n   \"devDependencies\": {\n-    \"@iobroker/testing\": \"^1.2.0\",\n-    \"babel-core\": \"^6.26.3\",\n-    \"babel-plugin-transform-es2015-arrow-functions\": \"^6.22.0\",\n-    \"babel-plugin-transform-es2015-block-scoping\": \"^6.26.0\",\n-    \"babel-plugin-transform-es2015-classes\": \"^6.24.1\",\n-    \"babel-plugin-transform-es2015-template-literals\": \"^6.22.0\",\n-    \"chai\": \"^4.1.2\",\n-    \"gulp\": \"^4.0.0\",\n-    \"gulp-babel\": \"^7.0.1\",\n-    \"gulp-clean-css\": \"^3.9.4\",\n+    \"@iobroker/testing\": \"^1.2.5\",\n+    \"@babel/core\": \"^7.6.3\",\n+    \"@babel/plugin-transform-arrow-functions\": \"^7.2.0\",\n+    \"@babel/plugin-transform-block-scoping\": \"^7.6.3\",\n+    \"@babel/plugin-transform-classes\": \"^7.5.5\",\n+    \"@babel/plugin-transform-template-literals\": \"^7.4.4\",\n+    \"chai\": \"^4.2.0\",\n+    \"gulp\": \"^4.0.2\",\n+    \"gulp-babel\": \"^8.0.0\",\n+    \"gulp-clean-css\": \"^4.2.0\",\n     \"gulp-concat\": \"^2.6.1\",\n-    \"gulp-htmlmin\": \"^4.0.0\",\n-    \"gulp-less\": \"^4.0.0\",\n-    \"gulp-sass\": \"^3.1.0\",\n-    \"gulp-sourcemaps\": \"^2.6.4\",\n-    \"gulp-terser\": \"^1.1.7\",\n+    \"gulp-htmlmin\": \"^5.0.1\",\n+    \"gulp-less\": \"^4.0.1\",\n+    \"gulp-sass\": \"^4.0.2\",\n+    \"gulp-sourcemaps\": \"^2.6.5\",\n+    \"gulp-terser\": \"^1.2.0\",\n     \"fancy-log\": \"^1.3.3\",\n-    \"ansi-colors\": \"^3.2.4\",\n+    \"ansi-colors\": \"^4.1.1\",\n     \"materialize-css\": \"^1.0.0\",\n-    \"mocha\": \"^6.1.4\"\n+    \"mocha\": \"^6.2.1\"\n   },\n   \"bugs\": {\n     \"url\": \"https://github.com/ioBroker/ioBroker.admin/issues\""
        },
        {
          "filename": "src/js/admin.js",
          "status": "modified",
          "additions": 190,
          "deletions": 187,
          "patch": "@@ -1,6 +1,6 @@\n /* jshint -W097 */\n /* jshint strict:true */\n-/* jslint vars: true */\n+/* jslint consts: true */\n /* global io:false */\n /* global jQuery:false */\n /* jslint browser:true */\n@@ -19,10 +19,10 @@\n //if (typeof Worker === 'undefined') alert('your browser does not support WebWorkers :-(');\n \n Array.prototype.remove = function () {\n-    var what;\n-    var a = arguments;\n-    var L = a.length;\n-    var ax;\n+    let what;\n+    const a = arguments;\n+    let L = a.length;\n+    let ax;\n     while (L && this.length) {\n         what = a[--L];\n         while ((ax = this.indexOf(what)) !== -1) {\n@@ -51,16 +51,17 @@ async function asyncForEach(array, callback) {\n     }\n }\n \n-var $iframeDialog = null; // used in adapter settings window\n-var configNotSaved = null; // used in adapter settings window\n-var showConfig = null; // used in adapter settings window\n-var defaults = {};\n-var customPostInits = {};\n-var customPostOnSave = {};\n-var FORBIDDEN_CHARS = /[\\]\\[*,;'\"`<>\\\\\\s?]/g;\n+let $iframeDialog = null;  // used in adapter settings window\n+let configNotSaved = null; // used in adapter settings window\n+let showConfig = null;     // used in adapter settings window\n+\n+const defaults = {};\n+const customPostInits = {};\n+const customPostOnSave = {};\n+const FORBIDDEN_CHARS = /[\\]\\[*,;'\"`<>\\\\\\s?]/g;\n \n // used in adapter settings window\n-var adapterRedirect = function (redirect, timeout) {\n+const adapterRedirect = function (redirect, timeout) {\n     if (redirect) {\n         setTimeout(function () {\n             redirect += document.location.pathname;\n@@ -69,25 +70,25 @@ var adapterRedirect = function (redirect, timeout) {\n         }, timeout || 5000);\n     }\n };\n-var gMain = null; // for google maps\n+let gMain = null; // for google maps\n \n function detectIE() {\n-    var ua = window.navigator.userAgent;\n+    const ua = window.navigator.userAgent;\n \n-    var msie = ua.indexOf('MSIE ');\n+    const msie = ua.indexOf('MSIE ');\n     if (msie > 0) {\n         // IE 10 or older => return version number\n         return parseInt(ua.substring(msie + 5, ua.indexOf('.', msie)), 10);\n     }\n \n-    var trident = ua.indexOf('Trident/');\n+    const trident = ua.indexOf('Trident/');\n     if (trident > 0) {\n         // IE 11 => return version number\n-        var rv = ua.indexOf('rv:');\n+        const rv = ua.indexOf('rv:');\n         return parseInt(ua.substring(rv + 3, ua.indexOf('.', rv)), 10);\n     }\n \n-    var edge = ua.indexOf('Edge/');\n+    const edge = ua.indexOf('Edge/');\n     if (edge > 0) {\n         // Edge (IE 12+) => return version number\n         return parseInt(ua.substring(edge + 5, ua.indexOf('.', edge)), 10);\n@@ -99,14 +100,14 @@ function detectIE() {\n \n (function ($) {\n $(document).ready(function () {\n-    var path = location.pathname + 'socket.io';\n+    let path = location.pathname + 'socket.io';\n     if (location.pathname.match(/^\\/admin\\//)) {\n         path = '/socket.io';\n     }\n \n-    var allTabs = {};\n+    let allTabs = {};\n \n-    var main = {\n+    const main = {\n         objects:        {},\n         states:         {},\n         currentHost:    '',\n@@ -221,17 +222,17 @@ $(document).ready(function () {\n                     '<a class=\"modal-action modal-close waves-effect waves-green btn-flat translate\" data-result=\"true\">' + _('Ok') + '</a>' +\n                     '<a class=\"modal-action modal-close waves-effect waves-green btn-flat translate\">' + _('Cancel') + '</a>');\n                 $dialogConfirm.find('.modal-footer .modal-action').on('click', function () {\n-                    var cb = $dialogConfirm.data('callback');\n+                    const cb = $dialogConfirm.data('callback');\n                     cb && cb($(this).data('result'));\n                 });\n             } else if (typeof buttons === 'object') {\n-                var tButtons = '';\n-                for (var b = buttons.length - 1; b >= 0; b--) {\n+                let tButtons = '';\n+                for (let b = buttons.length - 1; b >= 0; b--) {\n                     tButtons += '<a class=\"modal-action modal-close waves-effect waves-green btn-flat translate\" data-id=\"' + b + '\">' + buttons[b] + '</a>';\n                 }\n                 $dialogConfirm.find('.modal-footer').html(tButtons);\n                 $dialogConfirm.find('.modal-footer .modal-action').on('click', function () {\n-                    var cb = $dialogConfirm.data('callback');\n+                    const cb = $dialogConfirm.data('callback');\n                     cb && cb($(this).data('id'));\n                 });\n             }\n@@ -290,7 +291,7 @@ $(document).ready(function () {\n             //    (\"0\" + (dateObj.getSeconds()).toString(10)).slice(-2);\n             // Following implementation is 5 times faster\n             if (!dateObj) return '';\n-            var text = typeof dateObj;\n+            let text = typeof dateObj;\n             if (text === 'string') {\n                 if (justTime) {\n                     return dateObj.substring(8);\n@@ -301,7 +302,7 @@ $(document).ready(function () {\n             // if less 2000.01.01 00:00:00\n             if (text !== 'object') dateObj = dateObj < 946681200000 ? new Date(dateObj * 1000) : new Date(dateObj);\n \n-            var v;\n+            let v;\n             if (!justTime) {\n                 text = dateObj.getFullYear();\n                 v = dateObj.getMonth() + 1;\n@@ -385,7 +386,7 @@ $(document).ready(function () {\n             return main.selectId;\n         },*/\n         updateWizard:   function () {\n-            var $wizard = $('#button-wizard');\n+            const $wizard = $('#button-wizard');\n             if (main.objects['system.adapter.discovery.0']) {\n                 if (!$wizard.data('inited')) {\n                     $wizard.data('inited', true);\n@@ -418,30 +419,30 @@ $(document).ready(function () {\n                     if (!auth) {\n                         $('#button-logout').remove();\n                     } else {\n-                        main._lastTimer = (new Date()).getTime();\n+                        main._lastTimer = Date.now();\n                         monitor();\n                     }\n                 });\n             } else if (main.objects[main.currentUser]) {\n-                var obj = main.objects[main.currentUser];\n-                var name = '';\n+                const obj = main.objects[main.currentUser];\n+                let name = '';\n                 if (!obj || !obj.common || !obj.common.name) {\n                     name = main.currentUser.replace(/^system\\.user\\./);\n                     name = name[0].toUpperCase() + name.substring(1).toLowerCase();\n                 } else {\n                     name = translateName(obj.common.name);\n                 }\n                 if (obj && obj.common && obj.common.icon) {\n-                    var objs = {};\n+                    const objs = {};\n                     objs[main.currentUser] = obj;\n                     $('#current-user-icon').html(main.getIcon(main.currentUser, null, objs));\n                 } else {\n                     $('#current-user-icon').html('<i class=\"large material-icons\">account_circle</i>');\n                 }\n                 $('#current-user').html(name);\n-                var groups = [];\n-                for (var i = 0; i < tabs.users.groups.length; i++) {\n-                    var group = main.objects[tabs.users.groups[i]];\n+                const groups = [];\n+                for (let i = 0; i < tabs.users.groups.length; i++) {\n+                    const group = main.objects[tabs.users.groups[i]];\n                     if (group && group.common && group.common.members && group.common.members.indexOf(main.currentUser) !== -1) {\n                         groups.push(_(translateName(group.common.name)));\n                     }\n@@ -452,7 +453,7 @@ $(document).ready(function () {\n \n         // Delete objects\n         _delObject:     function (idOrList, callback) {\n-            var id;\n+            let id;\n             if (!Array.isArray(idOrList)) {\n                 if (typeof idOrList !== 'string') return callback && callback('invalid idOrList parameter');\n                 idOrList = [idOrList];\n@@ -467,7 +468,7 @@ $(document).ready(function () {\n                     main.showMessage (_ ('Cannot delete \"%s\" because not allowed', id), '', 'notifications');\n                     setTimeout(doIt, 0);\n                 } else {\n-                    var obj = main.objects[id];\n+                    const obj = main.objects[id];\n                     main.socket.emit('delObject', id, function (err) {\n                         if (err && err !== 'Not exists') {\n                             main.showError (err);\n@@ -488,13 +489,13 @@ $(document).ready(function () {\n                 }\n             }\n             doIt();\n-        },     \n+        },\n         _delObjects:    function (rootId, isAll, callback) {\n             if (!isAll) {\n                 this._delObject(rootId, callback);\n             } else {\n-                var list = [];\n-                for (var id in main.objects) {\n+                const list = [];\n+                for (const id in main.objects) {\n                     if (main.objects.hasOwnProperty(id) && id.substring(0, rootId.length + 1) === rootId + '.') {\n                         list.push(id);\n                     }\n@@ -508,7 +509,7 @@ $(document).ready(function () {\n             }\n         },\n         delObject:      function ($tree, id, callback) {\n-            var leaf = $tree ? $tree.selectId('getTreeInfo', id) : null;\n+            const leaf = $tree ? $tree.selectId('getTreeInfo', id) : null;\n             if (main.objects[id]) {\n                 if (leaf && leaf.children) {\n                     // ask if only object must be deleted or just this one\n@@ -544,7 +545,7 @@ $(document).ready(function () {\n \n     gMain = main; // for google maps\n \n-    var tabs = {\n+    const tabs = {\n         hosts:      new Hosts(main), // must be first to read the list of hosts\n         objects:    new Objects(main),\n         adapters:   new Adapters(main),\n@@ -573,21 +574,21 @@ $(document).ready(function () {\n         readme:     new Readme(main)\n     };\n \n-    var stdout;\n-    var cmdCallback    = null;\n-    var activeCmdId    = null;\n-    var $stdout        = $('#stdout');\n+    let stdout;\n+    let cmdCallback      = null;\n+    let activeCmdId      = null;\n+    const $stdout        = $('#stdout');\n \n-    var $dialogCommand = $('#dialog-command');\n-    var $dialogLicense = $('#dialog-license-main');\n-    var $dialogMessage = $('#dialog-message');\n-    var $dialogConfirm = $('#dialog-confirm');\n-    var $dialogCommandProgress = $dialogCommand.find('.progress div');\n+    const $dialogCommand = $('#dialog-command');\n+    const $dialogLicense = $('#dialog-license-main');\n+    const $dialogMessage = $('#dialog-message');\n+    const $dialogConfirm = $('#dialog-confirm');\n+    const $dialogCommandProgress = $dialogCommand.find('.progress div');\n \n-    var $adminSideMenu = $('#admin_sidemenu_menu');\n-    var $adminSideMain = $('#admin_sidemenu_main');\n+    const $adminSideMenu = $('#admin_sidemenu_menu');\n+    const $adminSideMain = $('#admin_sidemenu_main');\n \n-    var firstConnect   = true;\n+    let firstConnect     = true;\n \n     // detect touch devices\n     if (!('ontouchstart' in window || navigator.maxTouchPoints)) {\n@@ -633,15 +634,15 @@ $(document).ready(function () {\n \n     function initHtmlButtons() {\n         main.socket.emit('getVersion', function (err, version) {\n-\t\t\tvar $versionBtn = $('.button-version');\n+\t\t\tconst $versionBtn = $('.button-version');\n \t        if (!$versionBtn.hasClass('vendor')) {\n \t            $versionBtn.text('ioBroker.admin ' + version);\n \t        }\n         });\n \n         $('.choose-tabs-config-button').off('click').on('click', function(event) {\n-            var $dialog = $('#admin_sidemenu_dialog');\n-            var html = $dialog.html();\n+            const $dialog = $('#admin_sidemenu_dialog');\n+            const html = $dialog.html();\n             if (html) {\n                 $dialog.html('');\n                 // disable global handler\n@@ -652,27 +653,27 @@ $(document).ready(function () {\n                 // enable global handler\n                 $('html').on('click', globalClickHandler);\n             }, 100);\n-            var $e = $(event.target);\n-            var offs = $e.offset();\n+            const $e = $(event.target);\n+            const offs = $e.offset();\n             offs.top += $e.height() - 2;\n \n-            var text =\n+            let text =\n                 '<dialog open class=\"tab-selector m\" style=\"top: ' + offs.top + 'px; left: ' + offs.left + 'px;\">' + // style=\"overflow: visible; z-index: 999; \">'\n                 '<div>' +\n                 '<ul style=\"\">';\n \n-            var $lis = $adminSideMenu;\n-            for (var tid in allTabs) {\n-                var name = allTabs[tid];\n-                var found = $adminSideMenu.find('.admin-sidemenu-items[data-tab=\"' + tid + '\"]').length;\n+            const $lis = $adminSideMenu;\n+            for (const tid in allTabs) {\n+                const name = allTabs[tid];\n+                const found = $adminSideMenu.find('.admin-sidemenu-items[data-tab=\"' + tid + '\"]').length;\n                 // TABS\n                 /*$adminSideMenu.each(function (i, e) {\n                     if (tid === $(e).attr('aria-controls')) {\n                         found = $(e);\n                         return false;\n                     }\n                 });*/\n-                var id = 'chk-' + tid;\n+                const id = 'chk-' + tid;\n                 text +=\n                     '<li><input ' + (found ? 'checked' : 'unchecked') + ' class=\"chk-tab filled-in\" type=\"checkbox\" id=\"' + id + '\" />' +\n                     '<span for=\"' + id + '\">' + _(name) + '</span></id>';\n@@ -684,11 +685,11 @@ $(document).ready(function () {\n             $dialog.append(text);\n \n             $dialog.find('.chk-tab').off('change').on('change', function (event) {\n-                var id = $(this).attr('id').substr(4);\n+                const id = $(this).attr('id').substr(4);\n                 if ($(this).prop('checked')) {\n                     main.systemConfig.common.tabs.push(id);\n                 } else {\n-                    var pos = main.systemConfig.common.tabs.indexOf(id);\n+                    const pos = main.systemConfig.common.tabs.indexOf(id);\n                     if (id !== -1) {\n                         main.systemConfig.common.tabs.splice(pos, 1);\n                     }\n@@ -698,19 +699,19 @@ $(document).ready(function () {\n             });\n             // workaround for materialize checkbox problem\n             $dialog.find('input[type=\"checkbox\"]+span').off('click').on('click', function () {\n-                var $input = $(this).prev();\n+                const $input = $(this).prev();\n                 if (!$input.prop('disabled')) {\n                     $input.prop('checked', !$input.prop('checked')).trigger('change');\n                 }\n             });\n         });\n \n         main.updateWizard();\n-        \n+\n         $('#button-logout').on('click', function () {\n             window.location.href = '/logout/';\n         });\n-        \n+\n         setTimeout(function () {\n             main.tabs.info.init();\n         }, 5000);\n@@ -734,15 +735,15 @@ $(document).ready(function () {\n                 main.socket.emit('eventsThreshold', false);\n             });\n         } else {\n-            var $menu = $adminSideMenu;\n-            var panelSelector = $menu.data('problem-link');\n+            const $menu = $adminSideMenu;\n+            const panelSelector = $menu.data('problem-link');\n             if (panelSelector) {\n-                var $panel = $(panelSelector);\n+                const $panel = $(panelSelector);\n                 // Init source for iframe\n                 if ($panel.length) {\n-                    var link = $panel.data('src');\n+                    const link = $panel.data('src');\n                     if (link && link.indexOf('%') === -1) {\n-                        var $iframe = $panel.find('iframe');\n+                        const $iframe = $panel.find('iframe');\n                         if ($iframe.length && !$iframe.attr('src')) {\n                             $iframe.attr('src', link);\n                             $menu.data('problem-link', null);\n@@ -758,20 +759,20 @@ $(document).ready(function () {\n \n     function initTabs() {\n         // extract all additional instances\n-        var text     = '';\n-        var list     = [];\n-        var addTabs = [];\n+        let text      = '';\n+        const list    = [];\n+        const addTabs = [];\n \n         allTabs = {};\n-        for (var i = 0; i < main.instances.length; i++) {\n-            var instance = main.instances[i];\n-            var instanceObj = main.objects[instance];\n+        for (let i = 0; i < main.instances.length; i++) {\n+            const instance = main.instances[i];\n+            const instanceObj = main.objects[instance];\n             if (!instanceObj.common || !instanceObj.common.adminTab) continue;\n             if (instanceObj.common.adminTab.singleton) {\n-                var isFound = false;\n-                var inst1 = instance.replace(/\\.(\\d+)$/, '.');\n-                for (var j = 0; j < addTabs.length; j++) {\n-                    var inst2 = addTabs[j].replace(/\\.(\\d+)$/, '.');\n+                let isFound = false;\n+                const inst1 = instance.replace(/\\.(\\d+)$/, '.');\n+                for (let j = 0; j < addTabs.length; j++) {\n+                    const inst2 = addTabs[j].replace(/\\.(\\d+)$/, '.');\n                     if (inst1 === inst2) {\n                         isFound = true;\n                         break;\n@@ -785,24 +786,24 @@ $(document).ready(function () {\n \n         // Build the standard tabs together\n         $('.admin-tab').each(function () {\n-            var $this = $(this);\n-            var id = $this.attr('id');\n+            const $this = $(this);\n+            const id = $this.attr('id');\n             list.push(id);\n             allTabs[id] = $this.data('name');\n         });\n \n         // Look for adapter tabs\n-        for (var a = 0; a < addTabs.length; a++) {\n-            var tab   = main.objects[addTabs[a]];\n-            var name  = 'tab-' + tab.common.name;\n+        for (let a = 0; a < addTabs.length; a++) {\n+            const tab = main.objects[addTabs[a]];\n+            let name  = 'tab-' + tab.common.name;\n \n-            var link  = tab.common.adminTab.link || '/adapter/' + tab.common.name + '/tab.html';\n+            let link  = tab.common.adminTab.link || '/adapter/' + tab.common.name + '/tab.html';\n             if (tab.common.materializeTab) {\n                 link  = tab.common.adminTab.link || '/adapter/' + tab.common.name + '/tab_m.html';\n             }\n \n-            var parts = addTabs[a].split('.');\n-            var buttonName;\n+            const parts = addTabs[a].split('.');\n+            let buttonName;\n \n             if (tab.common.adminTab.name) {\n                 if (typeof tab.common.adminTab.name === 'object') {\n@@ -836,7 +837,7 @@ $(document).ready(function () {\n             allTabs[name] = buttonName;\n \n             if (!main.systemConfig.common.tabs || main.systemConfig.common.tabs.indexOf(name) !==-1) {\n-                var isReplace = false;\n+                let isReplace = false;\n                 if (!link) {\n                     link = '/adapter/' + parts[2] + '/tab.html';\n                     if (tab.common.materilizeTab) {\n@@ -850,16 +851,20 @@ $(document).ready(function () {\n \n                 // noinspection JSJQueryEfficiency\n                 if (!$('#' + name).length) {\n-                    var div = '<div id=\"' + name + '\" data-name=\"' + buttonName + '\" class=\"tab-custom ' + (isReplace ? 'link-replace' : '') + '\" data-adapter=\"' + parts[2] + '\" data-instance=\"' + parts[3] + '\" data-src=\"' + link + '\">' +\n+                    const div = '<div id=\"' + name + '\" data-name=\"' + buttonName + '\" class=\"tab-custom ' + (isReplace ? 'link-replace' : '') + '\" data-adapter=\"' + parts[2] + '\" data-instance=\"' + parts[3] + '\" data-src=\"' + link + '\">' +\n                         '<iframe class=\"iframe-in-tab\" style=\"border: 0; solid #FFF; display: block; left: 0; top: 0; width: 100%; height: 100%\"' +\n                         '></iframe></div>';\n                     $(div).hide().appendTo($('body'));\n \n                     // TODO: temporary, until other tab will be adapted\n                     $('#' + name).find ('.iframe-in-tab').on('load', function () {\n-                        var elem = $ (this).contents ().find('body>header');\n-                        if (!elem || !elem.length) elem = $(this).contents ().find('head');\n-                        if (elem && elem.length) elem.append('<link rel=\"stylesheet\" type=\"text/css\" href=\"../../lib/css/iob/selectID.css\"/>');\n+                        let elem = $ (this).contents ().find('body>header');\n+                        if (!elem || !elem.length) {\n+                            elem = $(this).contents ().find('head');\n+                        }\n+                        if (elem && elem.length) {\n+                            elem.append('<link rel=\"stylesheet\" type=\"text/css\" href=\"../../lib/css/iob/selectID.css\"/>');\n+                        }\n                     });\n                 } else {\n                     $('#' + name).hide().appendTo($('body'));\n@@ -877,10 +882,10 @@ $(document).ready(function () {\n         if (!main.systemConfig.common.tabs) main.systemConfig.common.tabs = list;\n \n         if ($('.link-replace').length) {\n-            var countLink = 0;\n+            let countLink = 0;\n \n             // If some objects cannot be read => go by timeout\n-            var loadTimeout = setTimeout(function() {\n+            let loadTimeout = setTimeout(function() {\n                 loadTimeout = null;\n                 initHtmlTabs(/*showTabs*/);\n             }, 100);\n@@ -906,7 +911,7 @@ $(document).ready(function () {\n \n     main.initHostsList = function (isFirstInit) {\n         // fill the host list (select) on adapter tab\n-        var $selHosts = $('#host-adapters');\n+        const $selHosts = $('#host-adapters');\n         if (isFirstInit && $selHosts.data('inited')) {\n             return;\n         }\n@@ -915,10 +920,10 @@ $(document).ready(function () {\n \n         main.currentHost = main.currentHost || main.config.currentHost || '';\n \n-        var lines = [];\n-        var color;\n-        var curId;\n-        for (var i = 0; i < main.tabs.hosts.list.length; i++) {\n+        const lines = [];\n+        let color;\n+        let curId;\n+        for (let i = 0; i < main.tabs.hosts.list.length; i++) {\n             lines.push('<li><a data-value=\"' + main.tabs.hosts.list[i].name + '\">' + main.getHostIcon(main.objects[main.tabs.hosts.list[i].id], 'imgHost left') + main.tabs.hosts.list[i].name + '</a></li>');\n             if (!main.currentHost) {\n                 main.currentHost = main.tabs.hosts.list[i].name;\n@@ -929,7 +934,7 @@ $(document).ready(function () {\n         }\n         $selHosts.html(lines);\n \n-        var $selBtn = $('#host-adapters-btn').show();\n+        const $selBtn = $('#host-adapters-btn').show();\n         $selBtn\n             .text(_('Host:') + ' ' + main.currentHost)\n             .dropdown();\n@@ -951,8 +956,8 @@ $(document).ready(function () {\n \n         // host selector\n         $selHosts.find('a').on('click', function () {\n-            var val = $(this).data('value');\n-            var id  = 'system.host.' + val + '.alive';\n+            const val = $(this).data('value');\n+            const id  = 'system.host.' + val + '.alive';\n             if (!main.states[id] || !main.states[id].val || main.states[id].val === 'null') {\n                 main.showMessage(_('Host %s is offline', $(this).val()));\n                 return;\n@@ -997,7 +1002,7 @@ $(document).ready(function () {\n         });\n \n         $dialogCommand.find('.progress-show-more').off('change').on('change', function () {\n-            var val = $(this).prop('checked');\n+            const val = $(this).prop('checked');\n             main.saveConfig('progressMore', val);\n             if (val) {\n                 $dialogCommand.find('.textarea').show();\n@@ -1013,7 +1018,7 @@ $(document).ready(function () {\n         });\n         // workaround for materialize checkbox problem\n         $dialogCommand.find('input[type=\"checkbox\"]+span').off('click').on('click', function () {\n-            var $input = $(this).prev();\n+            const $input = $(this).prev();\n             // ignore switch\n             if ($input.parent().parent().hasClass('switch')) return;\n \n@@ -1041,7 +1046,7 @@ $(document).ready(function () {\n         if (hosts && index < hosts.length) {\n             main.socket.emit('sendToHost', hosts[index].name, 'getHostInfo', null, function (result) {\n                 if (result && result['Node.js']) {\n-                    var major = parseInt(result['Node.js'].split('.').shift().replace('v', ''), 10);\n+                    const major = parseInt(result['Node.js'].split('.').shift().replace('v', ''), 10);\n                     if (major < 6 || major === 7 || major === 9  || major === 11 ) { // we allow 6, 8, 10 and 12+\n                         main.showMessage(_('This version of node.js \"%s\" on \"%s\" is deprecated. Please install node.js 6, 8 or newer', result['Node.js'], hosts[index].name), _('Suggestion'), 'error_outline');\n                     }\n@@ -1065,9 +1070,9 @@ $(document).ready(function () {\n             }\n \n             setTimeout(function () {\n-                var obj;\n+                let obj;\n                 main.objects = res;\n-                for (var id in main.objects) {\n+                for (const id in main.objects) {\n                     if (!main.objects.hasOwnProperty(id) || id.slice(0, 7) === '_design') continue;\n \n                     obj = main.objects[id];\n@@ -1090,7 +1095,7 @@ $(document).ready(function () {\n \n                 initTabs();\n                 // init dialogs\n-                for (var dialog in main.dialogs) {\n+                for (const dialog in main.dialogs) {\n                     if (main.dialogs.hasOwnProperty(dialog) && typeof main.dialogs[dialog].prepare === 'function') {\n                         main.dialogs[dialog].prepare();\n                     }\n@@ -1144,11 +1149,9 @@ $(document).ready(function () {\n     }\n \n     function objectChange(id, obj) {\n-        //var changed = false;\n-        var oldObj = null;\n-        var action = 'update';\n-\n-        oldObj = main.objects[id];\n+        //const changed = false;\n+        const oldObj = main.objects[id];\n+        let action = 'update';\n \n         // update main.objects cache\n         if (obj) {\n@@ -1205,11 +1208,11 @@ $(document).ready(function () {\n                 !obj.common.adminTab.ignoreConfigUpdate\n             ) {\n                 // Detect enable/disable change and do not update tabs (To able to work with global scripts normally)\n-                var ignore = false;\n+                let ignore = false;\n                 // try to detect if javascript just enabled or disabled\n                 if (oldObj && obj) {\n                     if (oldObj.common && obj.common) {\n-                        var newObj = JSON.parse(JSON.stringify(obj));\n+                        const newObj = JSON.parse(JSON.stringify(obj));\n                         newObj.common.enabled = oldObj.common.enabled;\n                         newObj.ts = 0;\n                         oldObj.ts = 0;\n@@ -1245,22 +1248,23 @@ $(document).ready(function () {\n \n     function monitor() {\n         if (main._timer) return;\n-        var ts = (new Date()).getTime();\n+        const ts = Date.now();\n+\n         if (ts - main._lastTimer > 30000) {\n             // It seems, that PC was in a sleep => Reload page to request authentication anew\n             location.reload();\n         } else {\n             main._lastTimer = ts;\n         }\n-        main._timer = setTimeout(function () {\n+        main._timer = setTimeout(() => {\n             main._timer = null;\n             monitor();\n         }, 10000);\n     }\n \n     // ---------------------------- Subscribes ---------------------------------------------\n     main.resubscribeStates = function () {\n-        for (var pattern in main.subscribesStates) {\n+        for (const pattern in main.subscribesStates) {\n             if (main.subscribesStates.hasOwnProperty(pattern) && main.subscribesStates[pattern]) {\n                 console.debug('Re-Subscribe: ' + pattern);\n                 main.socket.emit('subscribe', pattern);\n@@ -1269,7 +1273,7 @@ $(document).ready(function () {\n     };\n \n     main.resubscribeObjects = function () {\n-        for (var pattern in main.subscribesObjects) {\n+        for (const pattern in main.subscribesObjects) {\n             if (main.subscribesObjects.hasOwnProperty(pattern) && main.subscribesObjects[pattern]) {\n                 main.socket.emit('subscribeObjects', pattern);\n             }\n@@ -1286,7 +1290,7 @@ $(document).ready(function () {\n     main.subscribeStates = function (patterns) {\n         if (!patterns) return;\n         if (typeof patterns === 'object') {\n-            for (var s = 0; s < patterns.length; s++) {\n+            for (let s = 0; s < patterns.length; s++) {\n                 main.subscribesStates[patterns[s]] = main.subscribesStates[patterns[s]] || 0;\n                 main.subscribesStates[patterns[s]]++;\n                 if (main.subscribesStates[patterns[s]] === 1) {\n@@ -1307,12 +1311,12 @@ $(document).ready(function () {\n     main.unsubscribeStates = function (patterns) {\n         if (!patterns) return;\n         if (typeof patterns === 'object') {\n-            for (var s = 0; s < patterns.length; s++) {\n+            for (let s = 0; s < patterns.length; s++) {\n                 if (main.subscribesStates[patterns[s]]) {\n                     main.subscribesStates[patterns[s]]--;\n                 }\n                 if (main.subscribesStates[patterns[s]] === 0) {\n-                    console.debug('Unsibscribe: ' + patterns[s]);\n+                    console.debug('Unsubscribe: ' + patterns[s]);\n                     main.socket.emit('unsubscribe', patterns[s]);\n                     delete main.subscribesStates[patterns[s]];\n                 }\n@@ -1332,7 +1336,7 @@ $(document).ready(function () {\n     main.subscribeObjects = function (patterns) {\n         if (!patterns) return;\n         if (typeof patterns === 'object') {\n-            for (var s = 0; s < patterns.length; s++) {\n+            for (let s = 0; s < patterns.length; s++) {\n                 main.subscribesObjects[patterns[s]] = main.subscribesObjects[patterns[s]] || 0;\n                 main.subscribesObjects[patterns[s]]++;\n                 if (main.subscribesObjects[patterns[s]] === 1) {\n@@ -1351,7 +1355,7 @@ $(document).ready(function () {\n     main.unsubscribeObjects = function (patterns) {\n         if (!patterns) return;\n         if (typeof patterns === 'object') {\n-            for (var s = 0; s < patterns.length; s++) {\n+            for (let s = 0; s < patterns.length; s++) {\n                 if (main.subscribesObjects[patterns[s]]) {\n                     main.subscribesObjects[patterns[s]]--;\n                 }\n@@ -1407,7 +1411,7 @@ $(document).ready(function () {\n     };\n \n     main.navigateGetParams = function () {\n-        var parts = decodeURI(window.location.hash).split('/');\n+        const parts = decodeURI(window.location.hash).split('/');\n         return parts[2] ? decodeURIComponent(parts[2]) : null;\n     };\n \n@@ -1425,7 +1429,7 @@ $(document).ready(function () {\n \n         // get actual tab\n         if (!options.tab) {\n-            var parts   = decodeURI(window.location.hash).split('/');\n+            const parts   = decodeURI(window.location.hash).split('/');\n             options.tab = parts[0].replace(/^#/, '').replace(/^tab-/, '');\n         }\n \n@@ -1444,10 +1448,10 @@ $(document).ready(function () {\n                 configNotSaved = null;\n                 main.currentHash = window.location.hash;\n                 // hash has following structure => #tabName/dialogName/ids\n-                var parts  = main.currentHash.split('/');\n-                var tab    = parts[0].replace(/^#/, '').replace(/^tab-/, '');\n-                var dialog = parts[1];\n-                var params = decodeURIComponent(parts[2]);\n+                const parts  = main.currentHash.split('/');\n+                let tab      = parts[0].replace(/^#/, '').replace(/^tab-/, '');\n+                const dialog = parts[1];\n+                const params = decodeURIComponent(parts[2]);\n \n                 // set default page\n                 if (!tab || tab === '!') {\n@@ -1461,9 +1465,9 @@ $(document).ready(function () {\n                 }\n                 // do tab is not found\n \n-                var $adminBody = $('.admin-sidemenu-body');\n-                var $actualTab = $adminBody.find('.admin-sidemenu-body-content');\n-                var $panel     = $('#tab-' + tab);\n+                const $adminBody = $('.admin-sidemenu-body');\n+                let $actualTab   = $adminBody.find('.admin-sidemenu-body-content');\n+                const $panel     = $('#tab-' + tab);\n \n                 $adminBody.find('.admin-preloader').remove();\n \n@@ -1473,15 +1477,15 @@ $(document).ready(function () {\n \n                 // if tab was changed\n                 if (main.currentTab !== tab || !$actualTab.length) {\n-                    var link;\n+                    let link;\n                     // destroy actual tab\n                     if (main.currentTab && tabs[main.currentTab] && typeof tabs[main.currentTab].destroy === 'function') {\n                         tabs[main.currentTab].destroy();\n                     } else if (main.currentTab) {\n-                        var $oldPanel = $('#tab-' + main.currentTab);\n+                        const $oldPanel = $('#tab-' + main.currentTab);\n                         // destroy current iframe\n                         if ($oldPanel.length && (link = $oldPanel.data('src'))) {\n-                            var $iframe_ = $oldPanel.find('>iframe');\n+                            const $iframe_ = $oldPanel.find('>iframe');\n                             if ($iframe_.attr('src')) {\n                                 console.log('clear');\n                                 $iframe_.attr('src', '');\n@@ -1504,7 +1508,7 @@ $(document).ready(function () {\n                     // if iframe like node-red\n                     if ($panel.length && (link = $panel.data('src'))) {\n                         if (link.indexOf('%') === -1) {\n-                            var $iframe = $panel.find('>iframe');\n+                            const $iframe = $panel.find('>iframe');\n                             if ($iframe.length && !$iframe.attr('src')) {\n                                 $iframe.attr('src', link);\n                             }\n@@ -1515,7 +1519,7 @@ $(document).ready(function () {\n                 }\n \n                 // select menu element\n-                var  $tab = $adminSideMenu.find('.admin-sidemenu-items[data-tab=\"tab-' + tab + '\"]');\n+                const  $tab = $adminSideMenu.find('.admin-sidemenu-items[data-tab=\"tab-' + tab + '\"]');\n                 $adminSideMenu.find('.admin-sidemenu-items').not($tab).removeClass('admin-sidemenu-active');\n                 $tab.addClass('admin-sidemenu-active');\n \n@@ -1553,14 +1557,14 @@ $(document).ready(function () {\n     };\n \n     function getIconHtml(obj, classes) {\n-        var icon;\n-        var alt;\n-        var isCommon = obj && obj.common;\n+        let icon;\n+        let alt;\n+        const isCommon = obj && obj.common;\n \n         if (isCommon.icon) {\n             if (!isCommon.icon.match(/^data:image\\//)) {\n                 if (isCommon.icon.indexOf('.') !== -1) {\n-                    var instance;\n+                    let instance;\n                     if (obj.type === 'instance') {\n                         icon = '/adapter/' + obj.common.name + '/' + obj.common.icon;\n                     } else if (obj._id.match(/^system\\.adapter\\./)) {\n@@ -1593,11 +1597,11 @@ $(document).ready(function () {\n     }\n \n     main.getIconFromObj = function (obj, imgPath, classes) {\n-        var icon     = '';\n-        var alt      = '';\n+        let icon     = '';\n+        let alt      = '';\n         if (obj && obj.common) {\n             if (obj.common.icon) {\n-                var result = getIconHtml(obj);\n+                const result = getIconHtml(obj);\n                 icon = result.icon;\n                 alt = result.alt;\n             } else {\n@@ -1625,11 +1629,11 @@ $(document).ready(function () {\n     };\n \n     main.getHostIcon = function (obj, classes) {\n-        var icon     = '';\n-        var alt      = '';\n+        let icon     = '';\n+        let alt      = '';\n \n         if (obj && obj.common && obj.common.icon) {\n-            var result = getIconHtml(obj);\n+            const result = getIconHtml(obj);\n             icon = result.icon;\n             alt = result.alt;\n         }\n@@ -1643,8 +1647,8 @@ $(document).ready(function () {\n         if (Math.abs(bytes) < 1024) {\n             return bytes + ' B';\n         }\n-        var units = ['KiB','MiB','GiB','TiB','PiB','EiB','ZiB','YiB'];\n-        var u = -1;\n+        const units = ['KiB','MiB','GiB','TiB','PiB','EiB','ZiB','YiB'];\n+        let u = -1;\n         do {\n             bytes /= 1024;\n             ++u;\n@@ -1664,14 +1668,14 @@ $(document).ready(function () {\n         if (hex.length !== 6) {\n             return false;\n         }\n-        var r = parseInt(hex.slice(0, 2), 16),\n+        const r = parseInt(hex.slice(0, 2), 16),\n             g = parseInt(hex.slice(2, 4), 16),\n             b = parseInt(hex.slice(4, 6), 16);\n         // http://stackoverflow.com/a/3943023/112731\n         return (r * 0.299 + g * 0.587 + b * 0.114) <= 186;\n     };\n \n-    var tabsInfo = {\n+    const tabsInfo = {\n         'tab-intro':            {order: 1,    icon: 'apps'},\n         'tab-info':             {order: 5,    icon: 'info',              host: true},\n         'tab-adapters':         {order: 10,   icon: 'store',             host: true},\n@@ -1689,19 +1693,19 @@ $(document).ready(function () {\n         'tab-text2command-2':   {order: 57,   icon: 'ac_unit'},\n         'tab-node-red-0':       {order: 60,   icon: 'device_hub'},\n         'tab-node-red-1':       {order: 61,   icon: 'device_hub'},\n-        'tab-node-red-2':       {order: 62,   icon: 'device_hub'},        \n+        'tab-node-red-2':       {order: 62,   icon: 'device_hub'},\n         'tab-fullcalendar-0':   {order: 65,   icon: 'perm_contact_calendar'},\n         'tab-fullcalendar-1':   {order: 66,   icon: 'perm_contact_calendar'},\n         'tab-fullcalendar-2':   {order: 67,   icon: 'perm_contact_calendar'},\n         'tab-hosts':            {order: 100,  icon: 'storage'},\n     };\n \n     function initSideNav() {\n-        var lines = '';\n+        let lines = '';\n \n-        var elements = [];\n+        const elements = [];\n         $('.admin-tab').each(function () {\n-            var id = $(this).attr('id');\n+            const id = $(this).attr('id');\n             if (!main.systemConfig.common.tabs || main.systemConfig.common.tabs.indexOf(id) !== -1) {\n                 elements.push({\n                     line: '<li class=\"admin-sidemenu-items\" data-tab=\"' + id + '\"><a href=\"#' + id + '\">' +\n@@ -1712,14 +1716,14 @@ $(document).ready(function () {\n             }\n         });\n         $('.tab-custom').each(function () {\n-            var id = $(this).attr('id');\n+            const id = $(this).attr('id');\n             if (!main.systemConfig.common.tabs || main.systemConfig.common.tabs.indexOf(id) !== -1) {\n-                var icon;\n+                let icon;\n                 if (tabsInfo[id] && tabsInfo[id].icon) {\n                     icon = tabsInfo[id].icon;\n                 } else {\n-                    var _id = 'system.adapter.' + id.substring(4);\n-\t\t    if (main.objects[_id] && main.objects[_id].common.adminTab && main.objects[_id].common.adminTab['fa-icon']) {\n+                    const _id = 'system.adapter.' + id.substring(4);\n+\t\t            if (main.objects[_id] && main.objects[_id].common.adminTab && main.objects[_id].common.adminTab['fa-icon']) {\n                         icon = main.objects[_id].common.adminTab['fa-icon'];\n                     }\n                 }\n@@ -1742,7 +1746,7 @@ $(document).ready(function () {\n             return 0;\n         });\n \n-        for (var e = 0; e < elements.length; e++) {\n+        for (let e = 0; e < elements.length; e++) {\n             lines += elements[e].line;\n         }\n         $adminSideMenu.find('.admin-sidemenu-menu').html(lines);\n@@ -1792,14 +1796,14 @@ $(document).ready(function () {\n     });\n     main.socket.on('cmdStdout',         function (_id, text) {\n         if (activeCmdId === _id) {\n-            var m = text.match(/^upload \\[(\\d+)]/);\n+            let m = text.match(/^upload \\[(\\d+)]/);\n             if (m) {\n                 if ($dialogCommand.data('max') === null) {\n                     $dialogCommand.data('max', parseInt(m[1], 10));\n                     $dialogCommandProgress.removeClass('indeterminate').addClass('determinate');\n                 }\n-                var max = $dialogCommand.data('max');\n-                var value = parseInt(m[1], 10);\n+                const max = $dialogCommand.data('max');\n+                const value = parseInt(m[1], 10);\n                 $dialogCommandProgress.css('width', (100 - Math.round((value / max) * 100)) + '%');\n             } else {\n                 m = text.match(/^got [-_:\\/\\\\.\\w\\d]+\\/admin$/);\n@@ -1848,7 +1852,7 @@ $(document).ready(function () {\n             $dialogCommand.find('.btn').html(_('Close'));\n             $dialogCommand.data('finished', true);\n             $dialogCommand.data('max', true);\n-            var $backButton = $adminSideMain.find('.button-command');\n+            const $backButton = $adminSideMain.find('.button-command');\n             $backButton.removeClass('in-progress');\n \n             if (!exitCode) {\n@@ -1860,9 +1864,9 @@ $(document).ready(function () {\n                     }, 1500);\n                 }\n             } else {\n-                var error = $dialogCommand.data('error');\n+                let error = $dialogCommand.data('error');\n                 if (error) {\n-                    var m = error.match(/error: (.*)$/);\n+                    const m = error.match(/error: (.*)$/);\n                     if (m) {\n                         error = m[1];\n                     }\n@@ -1902,7 +1906,7 @@ $(document).ready(function () {\n \n                     // set logo and set branding\n                     if (data && data.native && data.native.vendor) {\n-                        var vendor = data.native.vendor;\n+                        const vendor = data.native.vendor;\n                         if (vendor.icon) {\n                             $('.admin-sidemenu-header .button-icon img').attr('src', data.native.vendor.icon);\n                         }\n@@ -1924,7 +1928,7 @@ $(document).ready(function () {\n                             }\n                             // apply rules\n                             if (vendor.admin.css.rules) {\n-                                for (var r = 0; r < vendor.admin.css.rules.length; r++) {\n+                                for (let r = 0; r < vendor.admin.css.rules.length; r++) {\n                                     $(vendor.admin.css.rules[r].selector).css(vendor.admin.css.rules[r].css);\n                                 }\n                             }\n@@ -1936,7 +1940,7 @@ $(document).ready(function () {\n \n                     // rename log => logs (back compatibility)\n                     if (main.systemConfig && main.systemConfig.common && main.systemConfig.common.tabs) {\n-                        var pos = main.systemConfig.common.tabs.indexOf('tab-log');\n+                        const pos = main.systemConfig.common.tabs.indexOf('tab-log');\n                         if (pos !== -1) {\n                             main.systemConfig.common.tabs[pos] = 'tab-logs';\n                         }\n@@ -1959,8 +1963,10 @@ $(document).ready(function () {\n \n                                         if (!main.systemConfig.common.licenseConfirmed) {\n                                             // Show license agreement\n-                                            var language = (main.systemConfig.common.language || window.navigator.userLanguage || window.navigator.language || '').substring(0, 2);\n-                                            if (language !== 'en' && language !== 'de' && language !== 'ru') language = 'en';\n+                                            let language = (main.systemConfig.common.language || window.navigator.userLanguage || window.navigator.language || '').substring(0, 2);\n+                                            if (language !== 'en' && language !== 'de' && language !== 'ru') {\n+                                                language = 'en';\n+                                            }\n \n                                             systemLang = language;\n \n@@ -1993,7 +1999,7 @@ $(document).ready(function () {\n \n                                             // workaround for materialize checkbox problem\n                                             $dialogLicense.find('input[type=\"checkbox\"]+span').off('click').on('click', function () {\n-                                                var $input = $(this).prev();\n+                                                const $input = $(this).prev();\n                                                 if (!$input.prop('disabled')) {\n                                                     $input.prop('checked', !$input.prop('checked')).trigger('change');\n                                                 }\n@@ -2077,7 +2083,7 @@ $(document).ready(function () {\n                                 // Here we go!\n                                 initAllDialogs();\n                                 // call prepare\n-                                for (var t in tabs) {\n+                                for (const t in tabs) {\n                                     if (tabs.hasOwnProperty(t) && tabs[t] && typeof tabs[t].prepare === 'function') {\n                                         tabs[t].prepare();\n                                     }\n@@ -2096,18 +2102,15 @@ $(document).ready(function () {\n             main.resubscribeObjects();\n             main.resubscribeLogs();\n         }\n-        if (main.waitForRestart) {\n-            location.reload();\n-        }\n+\n+        main.waitForRestart && location.reload();\n     });\n     main.socket.on('disconnect',        function () {\n         $('#connecting').show();\n     });\n     main.socket.on('reconnect',         function () {\n         $('#connecting').hide();\n-        if (main.waitForRestart) {\n-            location.reload();\n-        }\n+        main.waitForRestart && location.reload();\n     });\n     main.socket.on('repoUpdated',       function () {\n         setTimeout(function () {"
        },
        {
          "filename": "src/js/adminAdapters.js",
          "status": "modified",
          "additions": 189,
          "deletions": 187,
          "patch": "@@ -1,7 +1,7 @@\n function Adapters(main) {\n     'use strict';\n \n-    var that = this;\n+    const that = this;\n \n     this.curRepository     = null;\n     this.curRepoLastUpdate = null;\n@@ -69,7 +69,7 @@ function Adapters(main) {\n \n     function getVersionClass(version) {\n         if (version) {\n-            var tmp = version.split ('.');\n+            const tmp = version.split ('.');\n             if (tmp[0] === '0' && tmp[1] === '0' && tmp[2] === '0') {\n                 version = 'planned';\n             } else if (tmp[0] === '0' && tmp[1] === '0') {\n@@ -106,9 +106,9 @@ function Adapters(main) {\n                 },\n                 source:     that.tree,\n                 renderColumns: function(event, data) {\n-                    var node = data.node;\n-                    var $tdList = $(node.tr).find('>td');\n-                    var obj = that.data[node.key];\n+                    const node = data.node;\n+                    const $tdList = $(node.tr).find('>td');\n+                    const obj = that.data[node.key];\n \n                     function ellipsis(txt) {\n                         return '<div class=\"text-ellipsis\">' + txt + '</div>';\n@@ -120,18 +120,18 @@ function Adapters(main) {\n                         $tdList.eq(0).find('span.fancytree-title').attr('style', 'padding-left: 0px !important');\n \n                         // Calculate total count of adapter and count of installed adapter\n-                        for (var c = 0; c < that.tree.length; c++) {\n+                        for (let c = 0; c < that.tree.length; c++) {\n                             if (that.tree[c].key === node.key) {\n                                 $tdList.eq(1).html(that.tree[c].desc || '').css({'overflow': 'hidden', 'white-space': 'nowrap', position: 'relative'});\n-                                var installed = 0;\n-                                for (var k = 0; k < that.tree[c].children.length; k++) {\n-                                    if (that.data[that.tree[c].children[k].key].installed) installed++;\n+                                let installed = 0;\n+                                for (let k = 0; k < that.tree[c].children.length; k++) {\n+                                    if (that.data[that.tree[c].children[k].key].installed) {\n+                                        installed++;\n+                                    }\n                                 }\n                                 that.tree[c].installed = installed;\n                                 node.data.installed = installed;\n-                                var title;\n-                                //if (!that.onlyInstalled && !that.onlyUpdatable) {\n-                                title = '[<span title=\"' + _('Installed from group') + '\">' + installed + '</span> / <span title=\"' + _('Total count in group') + '\">' + that.tree[c].children.length + '</span>]';\n+                                let title = '[<span title=\"' + _('Installed from group') + '\">' + installed + '</span> / <span title=\"' + _('Total count in group') + '\">' + that.tree[c].children.length + '</span>]';\n                                 $tdList.eq(1).html(ellipsis('<span class=\"dark-green\">' + installed + '</span> ' + _('of') + '<span class=\"dark-blue\"> ' + that.tree[c].children.length + '</span> ' + _('Adapters from this Group installed')));\n                                 break;\n                             }\n@@ -145,8 +145,8 @@ function Adapters(main) {\n                         return $tdList.eq(no).html(ellipsis(html));\n                     }\n \n-                    var idx = obj.desc.indexOf('<div');\n-                    var desc = idx >= 0 ? obj.desc.substr(0, idx) : obj.desc;\n+                    const idx = obj.desc.indexOf('<div');\n+                    const desc = idx >= 0 ? obj.desc.substr(0, idx) : obj.desc;\n                     $tdList.eq(1).html(ellipsis(obj.desc))\n                         .attr('title', desc)\n                         .css({'white-space': 'nowrap', position: 'relative', 'font-weight': obj.bold ? 'bold' : null}).find('>div>div')\n@@ -206,7 +206,7 @@ function Adapters(main) {\n             });\n \n             that.$tab.find('#btn_list_adapters').show().off('click').on('click', function () {\n-                var $processAdapters = that.$tab.find('.process-adapters');\n+                const $processAdapters = that.$tab.find('.process-adapters');\n                 $processAdapters.show();\n                 that.isList = !that.isList;\n                 if (that.isList) {\n@@ -278,11 +278,11 @@ function Adapters(main) {\n     }\n \n     function filterTiles() {\n-        var anyVisible = false;\n+        let anyVisible = false;\n         // filter\n         if (that.currentFilter) {\n             that.$tiles.find('.tile').each(function () {\n-                var $this = $(this);\n+                const $this = $(this);\n                 if (that.currentType && !$this.hasClass('class-' + that.currentType)) {\n                     $this.hide();\n                     return;\n@@ -383,18 +383,18 @@ function Adapters(main) {\n             .off('click')\n             .on('click', function () {\n                 // prepare adapters\n-                var data = {};\n-                var order = [];\n-                var url;\n+                const data = {};\n+                const order = [];\n+                let url;\n                 for (url in that.urls) {\n                     if (that.urls.hasOwnProperty(url)) {\n                         order.push(url);\n                     }\n                 }\n                 order.sort();\n \n-                for (var o = 0; o < order.length; o++) {\n-                    var user = that.urls[order[o]].match(/\\.com\\/([-_$\u00a7A-Za-z0-9]+)\\/([-._$\u00a7A-Za-z0-9]+)\\//);\n+                for (let o = 0; o < order.length; o++) {\n+                    const user = that.urls[order[o]].match(/\\.com\\/([-_$\u00a7A-Za-z0-9]+)\\/([-._$\u00a7A-Za-z0-9]+)\\//);\n                     if (user && user.length >= 2 && (that.main.config.expertMode || order[o].indexOf('js-controller') === -1)) {\n                         //text += '<option value=\"https://github.com/' + user[1] + '/ioBroker.' + order[o] + '/tarball/master ' + order[o] + '\">' + order[o] + '</option>';\n                         data[order[o] + ' [' + user[1] + ']'] = null;\n@@ -412,16 +412,16 @@ function Adapters(main) {\n                 that.$installDialog.modal();\n \n                 that.$installDialog.find('.btn-install').off('click').on('click', function () {\n-                    var isCustom = !that.$installDialog.find('a[href=\"#tabs-install-github\"]').hasClass('active');//!!that.$installDialog.find('#tabs-install').tabs('option', 'active');\n-                    var url;\n-                    var debug;\n-                    var adapter;\n+                    const isCustom = !that.$installDialog.find('a[href=\"#tabs-install-github\"]').hasClass('active');//!!that.$installDialog.find('#tabs-install').tabs('option', 'active');\n+                    let url;\n+                    let debug;\n+                    let adapter;\n                     if (isCustom) {\n                         url     = that.$installDialog.find('#install-url-link').val();\n                         debug   = that.$installDialog.find('#install-url-debug').prop('checked') ? ' --debug' : '';\n                         adapter = '';\n                     } else {\n-                        var parts = that.$installDialog.find('#install-github-link').val().split(' ');\n+                        const parts = that.$installDialog.find('#install-github-link').val().split(' ');\n                         url     = 'https://github.com/' + parts[1].replace(/^\\[|]$/g, '') + '/ioBroker.' + parts[0] + '/tarball/master';\n                         debug   = that.$installDialog.find('#install-github-debug').prop('checked') ? ' --debug' : '';\n                         adapter = ' ' + parts[0];\n@@ -440,7 +440,7 @@ function Adapters(main) {\n                 });\n                 // workaround for materialize checkbox problem\n                 that.$installDialog.find('input[type=\"checkbox\"]+span').off('click').on('click', function () {\n-                    var $input = $(this).prev();\n+                    const $input = $(this).prev();\n                     if (!$input.prop('disabled')) {\n                         $input.prop('checked', !$input.prop('checked')).trigger('change');\n                     }\n@@ -578,25 +578,25 @@ function Adapters(main) {\n         //if (node.parent && node.parent.match) return true;\n \n         if (that.currentFilter) {\n-             if (!that.data[node.key]) return false;\n+            if (!that.data[node.key]) return false;\n \n-             var title = that.data[node.key].title;\n-             if (title && typeof title === 'object') {\n+            let title = that.data[node.key].title;\n+            if (title && typeof title === 'object') {\n                  title = title[systemLang] || title.en;\n-             }\n-            var desc = that.data[node.key].desc;\n+            }\n+            let desc = that.data[node.key].desc;\n             if (desc && typeof desc === 'object') {\n-                desc = desc[systemLang] || desc.en;\n+               desc = desc[systemLang] || desc.en;\n             }\n \n-            if ((that.data[node.key].name      && that.data[node.key].name.toLowerCase().indexOf(that.currentFilter)     !== -1) ||\n-                 (title                        && title.toLowerCase().indexOf(that.currentFilter)                        !== -1) ||\n-                 (that.data[node.key].keywords && that.data[node.key].keywords.toLowerCase().indexOf(that.currentFilter) !== -1) ||\n-                 (desc                         && desc.toLowerCase().indexOf(that.currentFilter)                         !== -1)){\n+            if ((that.data[node.key].name     && that.data[node.key].name.toLowerCase().indexOf(that.currentFilter)     !== -1) ||\n+                (title                        && title.toLowerCase().indexOf(that.currentFilter)                        !== -1) ||\n+                (that.data[node.key].keywords && that.data[node.key].keywords.toLowerCase().indexOf(that.currentFilter) !== -1) ||\n+                (desc                         && desc.toLowerCase().indexOf(that.currentFilter)                         !== -1)){\n                 return true;\n-             } else {\n-                 return false;\n-             }\n+            } else {\n+                return false;\n+            }\n         } else {\n             return true;\n         }\n@@ -621,40 +621,42 @@ function Adapters(main) {\n \n         if (!this.curRepository || this.curRepoLastHost !== host) {\n             this.curRepository = null;\n-            this.main.socket.emit('sendToHost', host, 'getRepository', {repo: this.main.systemConfig.common.activeRepo, update: updateRepo}, function (_repository) {\n+            this.main.socket.emit('sendToHost', host, 'getRepository', {repo: this.main.systemConfig.common.activeRepo, update: updateRepo}, _repository => {\n                 if (_repository === 'permissionError') {\n                     console.error('May not read \"getRepository\"');\n                     _repository = {};\n                 }\n \n-                that.curRepository = _repository || {};\n-                if (that.curRepository && that.curInstalled && that.curRunning) {\n-                    that.curRepoLastUpdate = (new Date()).getTime();\n-                    setTimeout(function () {\n-                        for (var c = 0; c < that.curRunning.length; c++) {\n-                            that.curRunning[c](that.curRepository, that.curInstalled);\n-                        }\n-                        that.curRunning = null;\n+                this.curRepository = _repository || {};\n+\n+                if (this.curRepository && that.curInstalled && that.curRunning) {\n+                    this.curRepoLastUpdate = Date.now();\n+                    setTimeout(() => {\n+                        this.curRunning.forEach(cb =>\n+                            cb(this.curRepository, this.curInstalled));\n+\n+                        this.curRunning = null;\n                     }, 0);\n                 }\n             });\n         }\n         if (!this.curInstalled || this.curRepoLastHost !== host) {\n             this.curInstalled = null;\n-            this.main.socket.emit('sendToHost', host, 'getInstalled', null, function (_installed) {\n+            this.main.socket.emit('sendToHost', host, 'getInstalled', null, _installed => {\n                 if (_installed === 'permissionError') {\n                     console.error('May not read \"getInstalled\"');\n                     _installed = {};\n                 }\n \n-                that.curInstalled = _installed || {};\n-                if (that.curRepository && that.curInstalled) {\n-                    that.curRepoLastUpdate = (new Date()).getTime();\n-                    setTimeout(function () {\n-                        for (var c = 0; c < that.curRunning.length; c++) {\n-                            that.curRunning[c](that.curRepository, that.curInstalled);\n-                        }\n-                        that.curRunning = null;\n+                this.curInstalled = _installed || {};\n+\n+                if (this.curRepository && that.curInstalled) {\n+                    this.curRepoLastUpdate = Date.now();\n+                    setTimeout(() => {\n+                        this.curRunning.forEach(cb =>\n+                            cb(this.curRepository, this.curInstalled));\n+\n+                        this.curRunning = null;\n                     }, 0);\n                 }\n             });\n@@ -663,14 +665,14 @@ function Adapters(main) {\n         this.curRepoLastHost = host;\n \n         if (this.curInstalled && this.curRepository) {\n-            setTimeout(function () {\n-                if (that.curRunning) {\n-                    for (var c = 0; c < that.curRunning.length; c++) {\n-                        that.curRunning[c](that.curRepository, that.curInstalled);\n-                    }\n-                    that.curRunning = null;\n+            setTimeout(() => {\n+                if (this.curRunning) {\n+                    this.curRunning.forEach(cb =>\n+                        cb(this.curRepository, this.curInstalled));\n+\n+                    this.curRunning = null;\n                 }\n-                if (callback) callback(that.curRepository, that.curInstalled);\n+                callback && callback(this.curRepository, this.curInstalled);\n             }, 0);\n         } else {\n             this.curRunning = [callback];\n@@ -685,9 +687,9 @@ function Adapters(main) {\n     };\n \n     function getNews(actualVersion, adapter) {\n-        var text = '';\n+        let text = '';\n         if (adapter.news) {\n-            for (var v in adapter.news) {\n+            for (const v in adapter.news) {\n                 if (adapter.news.hasOwnProperty(v)) {\n                     if (systemLang === v) text += (text ? '\\n' : '') + adapter.news[v];\n                     if (v === 'en' || v === 'ru'  || v === 'de') continue;\n@@ -702,12 +704,12 @@ function Adapters(main) {\n     function checkDependencies(dependencies) {\n         if (!dependencies) return '';\n         // like [{\"js-controller\": \">=0.10.1\"}]\n-        var adapters;\n+        let adapters;\n         if (dependencies instanceof Array) {\n             adapters = {};\n-            for (var a = 0; a < dependencies.length; a++) {\n+            for (let a = 0; a < dependencies.length; a++) {\n                 if (typeof dependencies[a] === 'string') continue;\n-                for (var b in dependencies[a]) {\n+                for (const b in dependencies[a]) {\n                     if (dependencies[a].hasOwnProperty(b)) {\n                         adapters[b] = dependencies[a][b];\n                     }\n@@ -717,7 +719,7 @@ function Adapters(main) {\n             adapters = dependencies;\n         }\n \n-        for (var adapter in adapters) {\n+        for (const adapter in adapters) {\n             if (adapters.hasOwnProperty(adapter)) {\n                 if (adapter === 'js-controller') {\n                     if (!semver.satisfies(that.main.objects['system.host.' + that.main.currentHost].common.installedVersion, adapters[adapter])) return _('Invalid version of %s. Required %s', adapter, adapters[adapter]);\n@@ -732,15 +734,15 @@ function Adapters(main) {\n \n     this.sortTree = function() {\n         function sort(c1, c2) {\n-            //var d1 = that.data[c1.key], d2 = that.data[c1.key];\n-            var inst1 = c1.data.installed || 0, inst2 = c2.data.installed || 0;\n-            var ret = inst2 - inst1;\n+            //const d1 = that.data[c1.key], d2 = that.data[c1.key];\n+            const inst1 = c1.data.installed || 0, inst2 = c2.data.installed || 0;\n+            const ret = inst2 - inst1;\n             if (ret) return ret;\n-            var t1 = c1.titleLang || c1.title || '';\n+            let t1 = c1.titleLang || c1.title || '';\n             if (typeof t1 === 'object') {\n                 t1 = t1[systemLang] || t1.en;\n             }\n-            var t2 = c2.titleLang || c2.title || '';\n+            let t2 = c2.titleLang || c2.title || '';\n             if (typeof t2 === 'object') {\n                 t2 = t2[systemLang] || t2.en;\n             }\n@@ -760,8 +762,8 @@ function Adapters(main) {\n         if (typeof time === 'string' || typeof time === 'number') {\n             time = new Date(time);\n         }\n-        var interval = now.getTime() - time.getTime();\n-        var days = Math.floor(interval / (24 * 3600000));\n+        const interval = now.getTime() - time.getTime();\n+        const days = Math.floor(interval / (24 * 3600000));\n         if (days === 0) {\n             if (now.getDate() === time.getDate()) {\n                 return todayText;\n@@ -775,8 +777,8 @@ function Adapters(main) {\n                 return x2DaysAgoText.replace('%d', days + 1);\n             }\n         } else {\n-            var t  = days % 10;\n-            var tt = days % 100;\n+            const t  = days % 10;\n+            const tt = days % 100;\n             // 2, 3, 4, 22, 23, 24, 32, 33, 34, 111, ...x2, x3, h4\n             if ((tt < 10 || tt > 20) && t >= 2 && t <= 4) {\n                 return x2DaysAgoText.replace('%d', days);\n@@ -798,16 +800,16 @@ function Adapters(main) {\n             this.$grid.find('tbody').html('');\n \n             this.getAdaptersInfo(this.main.currentHost, update, updateRepo, function (repository, installedList) {\n-                var obj;\n-                var version;\n-                var rawVersion;\n-                var adapter;\n-                var adaptersToUpdate = 0;\n-\n-                var listInstalled = [];\n-                var listNonInstalled = [];\n-                var nowObj = new Date();\n-                var localTexts = {\n+                let obj;\n+                let version;\n+                let rawVersion;\n+                let adapter;\n+                let adaptersToUpdate = 0;\n+\n+                const listInstalled = [];\n+                const listNonInstalled = [];\n+                const nowObj = new Date();\n+                const localTexts = {\n                     'add instance':             _('add instance'),\n                     'update':                   _('update'),\n                     'upload':                   _('upload'),\n@@ -858,9 +860,9 @@ function Adapters(main) {\n                 listNonInstalled.sort();\n \n                 function getVersionString(version, updatable, news, updatableError) {\n-                    //var span = getVersionSpan(version);\n-                    var color = getVersionClass(version);\n-                    var title = color + '\\n\\r' + (news || '');\n+                    //const span = getVersionSpan(version);\n+                    const color = getVersionClass(version);\n+                    const title = color + '\\n\\r' + (news || '');\n                     //version = '<table style=\"min-width: 80px; width: 100%; text-align: center; border: 0; border-spacing: 0px;' + (news ? 'font-weight: bold;' : '') + '\" cellspacing=\"0\" cellpadding=\"0\" class=\"ui-widget\">' +\n                     version = //'<div style=\"height: 100% !important;\">' +\n                         '<table style=\"cursor: alias; width: 100%; text-align: center; border: 0; border-spacing: 0;' + (news ? 'color: blue;' : '') + '\" cellspacing=\"0\" cellpadding=\"0\" class=\"ui-widget\">' +\n@@ -878,27 +880,28 @@ function Adapters(main) {\n                 that.data = {};\n \n                 // list of the installed adapters\n-                for (var i = 0; i < listInstalled.length; i++) {\n+                for (const i = 0; i < listInstalled.length; i++) {\n                     adapter = listInstalled[i];\n \n                     obj = installedList ? installedList[adapter] : null;\n \n                     if (!obj || obj.controller || adapter === 'hosts') continue;\n-                    var installed = '';\n-                    var rawInstalled = '';\n-                    var icon = obj.icon;\n+                    let installed = '';\n+                    let rawInstalled = '';\n+                    let icon = obj.icon;\n                     version = '';\n \n                     if (repository[adapter] && repository[adapter].version) version = repository[adapter].version;\n \n                     if (repository[adapter] && repository[adapter].extIcon) icon = repository[adapter].extIcon;\n \n-                    var _instances = 0;\n-                    var _enabled   = 0;\n+                    let _instances = 0;\n+                    let _enabled   = 0;\n                     if (obj.version) {\n-                        var news = '';\n-                        var updatable = false;\n-                        var updatableError = '';\n+                        let news = '';\n+                        let updatable = false;\n+                        let updatableError = '';\n+\n                         if (!that.main.upToDate(version, obj.version)) {\n                             news = getNews(obj.version, repository[adapter]);\n                             // check if version is compatible with current adapters and js-controller\n@@ -911,7 +914,7 @@ function Adapters(main) {\n                             '<tr>';\n \n                         // Show information about installed and enabled instances\n-                        for (var z = 0; z < that.main.instances.length; z++) {\n+                        for (const z = 0; z < that.main.instances.length; z++) {\n                             if (that.main.objects[that.main.instances[z]] &&\n                                 that.main.objects[that.main.instances[z]].common.name === adapter) {\n                                 _instances++;\n@@ -956,11 +959,11 @@ function Adapters(main) {\n                     rawVersion = version;\n                     version = getVersionString(version, updatable, news, updatableError);\n \n-                    var group = (obj.type || that.types[adapter] || 'common adapters') + '_group';\n-                    var desc  = (typeof obj.desc === 'object') ? (obj.desc[systemLang] || obj.desc.en) : obj.desc;\n+                    const group = (obj.type || that.types[adapter] || 'common adapters') + '_group';\n+                    let desc  = (typeof obj.desc === 'object') ? (obj.desc[systemLang] || obj.desc.en) : obj.desc;\n                     desc = desc || '';\n                     desc += showUploadProgress(group, adapter, that.main.states['system.adapter.' + adapter + '.upload'] ? that.main.states['system.adapter.' + adapter + '.upload'].val : 0);\n-                    var title = obj.titleLang || obj.title;\n+                    let title = obj.titleLang || obj.title;\n                     title = (typeof title === 'object') ? (title[systemLang] || title.en) : title;\n \n                     that.data[adapter] = {\n@@ -996,8 +999,8 @@ function Adapters(main) {\n                     if (obj.type && that.types[adapter]) console.log('Adapter \"' + adapter + '\" has own type. Remove from admin.');\n \n                     if (!that.isList) {\n-                        var iGroup = -1;\n-                        for (var jj = 0; jj < that.tree.length; jj++) {\n+                        let iGroup = -1;\n+                        for (const jj = 0; jj < that.tree.length; jj++) {\n                             if (that.tree[jj].key === that.data[adapter].group) {\n                                 iGroup = jj;\n                                 break;\n@@ -1032,7 +1035,7 @@ function Adapters(main) {\n                 //that.sortTree();\n \n                 if (!that.onlyInstalled && !that.onlyUpdatable) {\n-                    for (i = 0; i < listNonInstalled.length; i++) {\n+                    for (let i = 0; i < listNonInstalled.length; i++) {\n                         adapter = listNonInstalled[i];\n \n                         obj = repository[adapter];\n@@ -1046,12 +1049,12 @@ function Adapters(main) {\n                             version = getVersionString(version);\n                         }\n \n-                        var group = (obj.type || that.types[adapter] || 'common adapters') + '_group';\n-                        var desc = (typeof obj.desc === 'object') ? (obj.desc[systemLang] || obj.desc.en) : obj.desc;\n+                        const group = (obj.type || that.types[adapter] || 'common adapters') + '_group';\n+                        let desc = (typeof obj.desc === 'object') ? (obj.desc[systemLang] || obj.desc.en) : obj.desc;\n                         desc = desc || '';\n                         desc += showUploadProgress(group, adapter, that.main.states['system.adapter.' + adapter + '.upload'] ? that.main.states['system.adapter.' + adapter + '.upload'].val : 0);\n \n-                        title = obj.titleLang || obj.title;\n+                        let title = obj.titleLang || obj.title;\n                         title = (typeof title === 'object') ? (title[systemLang] || title.en) : title;\n \n                         that.data[adapter] = {\n@@ -1082,8 +1085,8 @@ function Adapters(main) {\n                         if (obj.type && that.types[adapter]) console.log('Adapter \"' + adapter + '\" has own type. Remove from admin.');\n \n                         if (!that.isList) {\n-                            var igroup = -1;\n-                            for (var j = 0; j < that.tree.length; j++){\n+                            let igroup = -1;\n+                            for (const j = 0; j < that.tree.length; j++){\n                                 if (that.tree[j].key === that.data[adapter].group) {\n                                     igroup = j;\n                                     break;\n@@ -1118,7 +1121,7 @@ function Adapters(main) {\n                 }\n \n                 if (that.currentOrder === 'popular' || that.currentOrder === 'updated') {\n-                    var akeys = Object.keys(that.data);\n+                    const akeys = Object.keys(that.data);\n \n                     if (that.currentOrder === 'popular') {\n                         akeys.sort(function (a, b) {\n@@ -1137,20 +1140,20 @@ function Adapters(main) {\n                             return 0;\n                         });\n                     }\n-                    var newData = {};\n-                    for (var u = 0; u < akeys.length; u++) {\n+                    const newData = {};\n+                    for (let u = 0; u < akeys.length; u++) {\n                         newData[akeys[u]] = that.data[akeys[u]];\n                     }\n                     that.data = newData;\n                 }\n \n                 // build tiles\n                 if (that.isTiles && (that.main.browser !== 'ie' || that.main.browserVersion > 10)) {\n-                    var text = '';\n-                    var types = [];\n-                    for (var a in that.data) {\n+                    let text = '';\n+                    const types = [];\n+                    for (const a in that.data) {\n                         if (!that.data.hasOwnProperty(a)) continue;\n-                        var ad = that.data[a];\n+                        const ad = that.data[a];\n                         if (types.indexOf(ad.group) === -1) {\n                             types.push(ad.group);\n                         }\n@@ -1227,17 +1230,17 @@ function Adapters(main) {\n \n                     that.$tiles.html(text);\n                     // init buttons\n-                    for (var b in that.data) {\n+                    for (const b in that.data) {\n                         if (that.data.hasOwnProperty(b)) {\n                             that.initButtons(b);\n                         }\n                     }\n \n-                    var tTypes = '<li class=\"main-toolbar-table-types-item\" data-type=\"\"><a>' + localTexts['all'] + '</a></li>\\n';\n-                    for (var g = 0; g < types.length; g++) {\n+                    let tTypes = '<li class=\"main-toolbar-table-types-item\" data-type=\"\"><a>' + localTexts['all'] + '</a></li>\\n';\n+                    for (let g = 0; g < types.length; g++) {\n                         tTypes += '<li class=\"main-toolbar-table-types-item\" data-type=\"' + types[g] + '\"><a>' + _(types[g]) + '</a></li>\\n';\n                     }\n-                    var $types = that.$tab.find('#main-toolbar-table-types');\n+                    const $types = that.$tab.find('#main-toolbar-table-types');\n                     $types.html(tTypes);\n                     $types.find('.main-toolbar-table-types-item').show().off('click').on('click', function () {\n                         that.currentType = $(this).data('type') || '';\n@@ -1279,20 +1282,20 @@ function Adapters(main) {\n                         }\n \n                         $(this).on('hover', function () {\n-                            var text = '<div class=\"icon-large\" style=\"' +\n+                            const text = '<div class=\"icon-large\" style=\"' +\n                                 'left: ' + Math.round($(this).position().left + $(this).width() + 5) + 'px;\"><img onerror=\"this.src=\\'img/info-big.png\\';\" src=\"' + $(this).attr('src') + '\"/></div>';\n-                            var $big = $(text);\n+                            const $big = $(text);\n                             $big.insertAfter($(this));\n                             $(this).data('big', $big[0]);\n-                            var h   = parseFloat($big.height());\n-                            var top = Math.round($(this).position().top - ((h - parseFloat($(this).height())) / 2));\n+                            const h = parseFloat($big.height());\n+                            let top = Math.round($(this).position().top - ((h - parseFloat($(this).height())) / 2));\n                             if (h + top > (window.innerHeight || document.documentElement.clientHeight)) {\n                                 top = (window.innerHeight || document.documentElement.clientHeight) - h;\n                             }\n                             $big.css({top: top});\n \n                         }, function () {\n-                            var big = $(this).data('big');\n+                            const big = $(this).data('big');\n                             $(big).remove();\n                             $(this).data('big', undefined);\n                         });\n@@ -1304,7 +1307,7 @@ function Adapters(main) {\n \n                     that.sortTree();\n                     that.enableColResize();\n-                    var classes = [\n+                    const classes = [\n                         'tab-adapters-table-name',\n                         'tab-adapters-table-description',\n                         'tab-adapters-table-keywords',\n@@ -1314,7 +1317,7 @@ function Adapters(main) {\n                         'tab-adapters-table-install'\n                     ];\n                     that.$grid.find('tbody tr').each(function () {\n-                        var i = 0;\n+                        const i = 0;\n                         $(this).find('td').each(function () {\n                             $(this).addClass(classes[i]);\n                             i++;\n@@ -1342,15 +1345,17 @@ function Adapters(main) {\n     this.updateCounter = function (counter) {\n         if (counter === undefined) {\n             this.getAdaptersInfo(this.main.currentHost, false, false, function (repository, installedList) {\n-                var adaptersToUpdate = 0;\n+                let adaptersToUpdate = 0;\n \n-                for (var adapter in installedList) {\n+                for (const adapter in installedList) {\n                     if (!installedList.hasOwnProperty(adapter)) continue;\n-                    var obj = installedList ? installedList[adapter] : null;\n+                    const obj = installedList ? installedList[adapter] : null;\n                     if (!obj || obj.controller || adapter === 'hosts') continue;\n \n-                    var version = '';\n-                    if (repository[adapter] && repository[adapter].version) version = repository[adapter].version;\n+                    let version = '';\n+                    if (repository[adapter] && repository[adapter].version) {\n+                        version = repository[adapter].version;\n+                    }\n \n                     if (obj.version && !that.main.upToDate(version, obj.version)) {\n                         adaptersToUpdate++;\n@@ -1359,7 +1364,7 @@ function Adapters(main) {\n                 that.updateCounter(adaptersToUpdate);\n             });\n         } else if (counter) {\n-            var $updates = $('#updates-for-adapters');\n+            const $updates = $('#updates-for-adapters');\n             if ($updates.length) {\n                 $updates.text(counter);\n             } else {\n@@ -1409,14 +1414,14 @@ function Adapters(main) {\n             return callback(true, that.main.currentHost, '');\n         }\n \n-        var $dialogAddInstance = $('#dialog-add-instance');\n+        const $dialogAddInstance = $('#dialog-add-instance');\n         $dialogAddInstance.find('.dialog-add-instance-name').html(adapter);\n         $dialogAddInstance.find('.dialog-add-description').html(desc);\n \n         // fill the hosts\n-        var text = '';\n-        for (var h = 0; h < that.main.tabs.hosts.list.length; h++) {\n-            var host = that.main.tabs.hosts.list[h];\n+        let text = '';\n+        for (const h = 0; h < that.main.tabs.hosts.list.length; h++) {\n+            const host = that.main.tabs.hosts.list[h];\n             text += '<option ' + (host.name === that.main.currentHost ? 'selected' : '') + ' value=\"' + host.name + '\">' + host.name + '</option>';\n         }\n \n@@ -1428,12 +1433,12 @@ function Adapters(main) {\n         $dialogAddInstance.find('.dialog-add-instance-host').html(text).select();\n \n         // find free instance numbers\n-        var min = -1;\n-        var used = [];\n-        for (var i = 0; i < that.main.tabs.instances.list.length; i++) {\n-            var parts = that.main.tabs.instances.list[i].split('.');\n+        let min = -1;\n+        const used = [];\n+        for (const i = 0; i < that.main.tabs.instances.list.length; i++) {\n+            const parts = that.main.tabs.instances.list[i].split('.');\n             if (parts[parts.length - 2] === adapter) {\n-                var index = parseInt(parts[parts.length - 1], 10);\n+                const index = parseInt(parts[parts.length - 1], 10);\n                 used.push(index);\n                 if (index > min) {\n                     min = index;\n@@ -1442,7 +1447,7 @@ function Adapters(main) {\n         }\n         min += 10;\n         text = '<option selected value=\"\">' + _('auto') + '</option>';\n-        for (var m = 0; m < min; m++) {\n+        for (const m = 0; m < min; m++) {\n             if (used.indexOf(m) !== -1) continue;\n             text += '<option value=\"' + m + '\">' + m + '</option>';\n         }\n@@ -1473,14 +1478,14 @@ function Adapters(main) {\n     }\n \n     function showLicenseDialog(adapter, callback) {\n-        var $dialogLicense = $('#dialog-license');\n+        const $dialogLicense = $('#dialog-license');\n         // Is adapter installed\n         if (that.data[adapter].installed || !that.data[adapter].licenseUrl) {\n             callback(true);\n             return;\n         }\n \n-        var timeout = setTimeout(function () {\n+        let timeout = setTimeout(function () {\n             timeout = null;\n             callback(true);\n         }, 10000);\n@@ -1544,40 +1549,37 @@ function Adapters(main) {\n \n     this.initButtons = function (adapter) {\n         this.$tab.find('.adapter-install-submit[data-adapter-name=\"' + adapter + '\"]').off('click').on('click', function () {\n-            var adapter = $(this).attr('data-adapter-name');\n-            var desc = $(this).attr('data-adapter-desc');\n+            const adapter = $(this).attr('data-adapter-name');\n+            const desc = $(this).attr('data-adapter-desc');\n \n             // show config dialog\n             showAddInstanceDialog(adapter, desc, function (result, host, index) {\n                 if (!result) return;\n \n                 that.getAdaptersInfo(host, false, false, function (repo, installed) {\n-                    var obj = repo[adapter];\n+                    let obj = repo[adapter];\n \n-                    if (!obj) obj = installed[adapter];\n+                    obj = obj || installed[adapter];\n \n-                    if (!obj) return;\n+                    if (!obj) {\n+                        return;\n+                    }\n \n                     if (obj.license && obj.license !== 'MIT') {\n                         // Show license dialog!\n-                        showLicenseDialog(adapter, function (isAgree) {\n-                            if (isAgree) {\n-                                that.main.cmdExec(null, 'add ' + adapter + ' ' + index + ' --host ' + host, function (exitCode) {\n-                                    if (!exitCode) that._postInit(true);\n-                                });\n-                            }\n-                        });\n+                        showLicenseDialog(adapter, isAgree =>\n+                            isAgree && that.main.cmdExec(null, 'add ' + adapter + ' ' + index + ' --host ' + host, exitCode =>\n+                                !exitCode && that._postInit(true)));\n                     } else {\n-                        that.main.cmdExec(null, 'add ' + adapter + ' ' + index + ' --host ' + host, function (exitCode) {\n-                            if (!exitCode) that._postInit(true);\n-                        });\n+                        that.main.cmdExec(null, 'add ' + adapter + ' ' + index + ' --host ' + host, exitCode =>\n+                            !exitCode && that._postInit(true));\n                     }\n                 });\n             });\n         });\n \n         this.$tab.find('.adapter-delete-submit[data-adapter-name=\"' + adapter + '\"]').off('click').on('click', function () {\n-            var name = $(this).attr('data-adapter-name');\n+            const name = $(this).attr('data-adapter-name');\n             that.main.confirmMessage(_('Are you sure you want to delete adapter %s?', name), _('Please confirm'), 'help', function (result) {\n                 if (result) {\n                     that.main.cmdExec(null, 'del ' + name, function (exitCode) {\n@@ -1596,7 +1598,7 @@ function Adapters(main) {\n         });\n \n         this.$tab.find('.adapter-update-submit[data-adapter-name=\"' + adapter + '\"]').off('click').on('click', function () {\n-            var aName = $(this).attr('data-adapter-name');\n+            const aName = $(this).attr('data-adapter-name');\n             if (aName === 'admin') that.main.waitForRestart = true;\n \n             that.main.cmdExec(null, 'upgrade ' + aName, function (exitCode) {\n@@ -1605,34 +1607,34 @@ function Adapters(main) {\n         });\n \n         this.$tab.find('.adapter-upload-submit[data-adapter-name=\"' + adapter + '\"]').off('click').on('click', function () {\n-            var aName = $(this).attr('data-adapter-name');\n+            const aName = $(this).attr('data-adapter-name');\n \n             that.main.cmdExec(null, 'upload ' + aName, function (exitCode) {\n                 if (!exitCode) that._postInit(true);\n             });\n         });\n \n-        var $button = this.$tab.find('.adapter-update-custom-submit[data-adapter-name=\"' + adapter + '\"]');\n+        const $button = this.$tab.find('.adapter-update-custom-submit[data-adapter-name=\"' + adapter + '\"]');\n         $button.off('click').on('click', function () {\n-            var versions = [];\n+            const versions = [];\n             if (that.main.objects['system.adapter.' + adapter].common.news) {\n-                var news = that.main.objects['system.adapter.' + adapter].common.news;\n-                for (var id in news) {\n+                const news = that.main.objects['system.adapter.' + adapter].common.news;\n+                for (const id in news) {\n                     if (news.hasOwnProperty(id)) {\n                         versions.push(id);\n                     }\n                 }\n             } else {\n                 versions.push(that.main.objects['system.adapter.' + adapter].common.version);\n             }\n-            var menu = '<div class=\"collection\">';\n-            for (var v = 0; v < versions.length; v++) {\n-                var nnews = (news[versions[v]] ? news[versions[v]][systemLang] || news[versions[v]].en : '');\n+            const menu = '<div class=\"collection\">';\n+            for (const v = 0; v < versions.length; v++) {\n+                const nnews = (news[versions[v]] ? news[versions[v]][systemLang] || news[versions[v]].en : '');\n                 menu += '<a data-version=\"' + versions[v] + '\" data-position=\"left\" data-delay=\"50\" title=\"' + nnews + '\" data-adapter-name=\"' + $(this).data('adapter-name') + '\" class=\"collection-item adapters-versions-link tooltipped\"><span class=\"adapters-versions-link-version\">' + versions[v] + '</span> - <div class=\"adapters-versions-link-history\">' + nnews + '</div></a>';\n             }\n             menu += '</div>';\n \n-            var $adaptersMenu = $('#adapters-menu');\n+            const $adaptersMenu = $('#adapters-menu');\n             if (!$adaptersMenu.length) {\n                 //$adaptersMenu = $('<div id=\"adapters-menu\" class=\"dropdown-content m\"></div>');\n                 $adaptersMenu = $('<div id=\"adapters-menu\" class=\"modal modal-fixed-footer\"><div class=\"modal-content\">' +\n@@ -1649,8 +1651,8 @@ function Adapters(main) {\n             $adaptersMenu.find('.adapters-versions-link').off('click').on('click', function () {\n                 //if ($(this).data('link')) window.open($(this).data('link'), $(this).data('instance-id'));\n                 $adaptersMenu.modal('close');\n-                var adapter = $(this).data('adapter-name');\n-                var version = $(this).data('version');\n+                const adapter = $(this).data('adapter-name');\n+                const version = $(this).data('version');\n                 if (version && adapter) {\n                     that.main.cmdExec(null, 'upgrade ' + adapter + '@' + version, function (exitCode) {\n                         if (!exitCode) that._postInit(true);\n@@ -1660,8 +1662,8 @@ function Adapters(main) {\n \n             /*$(this).dropdown({\n                 onCloseEnd: function () {\n-                    var $adaptersMenu = $('#adapters-menu');\n-                    var trigger = $adaptersMenu.data('trigger');\n+                    const $adaptersMenu = $('#adapters-menu');\n+                    const trigger = $adaptersMenu.data('trigger');\n                     $(trigger).dropdown('close').dropdown('destroy');\n                     $adaptersMenu.data('trigger', null).hide();\n                     $adaptersMenu.remove();\n@@ -1685,7 +1687,7 @@ function Adapters(main) {\n             if (obj) {\n                 if (this.list.indexOf(id) === -1) this.list.push(id);\n             } else {\n-                var j = this.list.indexOf(id);\n+                const j = this.list.indexOf(id);\n                 if (j !== -1) {\n                     this.list.splice(j, 1);\n                 }\n@@ -1698,8 +1700,8 @@ function Adapters(main) {\n     };\n \n     function showUploadProgress(group, adapter, percent) {\n-        var text = '';\n-        var opened;\n+        let text = '';\n+        let opened;\n         if (adapter || typeof group === 'string') {\n             if (adapter) {\n                // text += '<div class=\"adapter-upload-progress\" data-adapter-name=\"' + adapter + '\"';\n@@ -1733,10 +1735,10 @@ function Adapters(main) {\n \n     this.stateChange = function (id, state) {\n         if (id && state) {\n-            var adapter = id.match(/^system\\.adapter\\.([\\w\\d-]+)\\.upload$/);\n+            const adapter = id.match(/^system\\.adapter\\.([\\w\\d-]+)\\.upload$/);\n             if (adapter) {\n-                var $adapter = this.$tab.find('.adapter-upload-progress[data-adapter-name=\"' + adapter[1] + '\"]');\n-                var text = showUploadProgress(state.val);\n+                const $adapter = this.$tab.find('.adapter-upload-progress[data-adapter-name=\"' + adapter[1] + '\"]');\n+                const text = showUploadProgress(state.val);\n                 $adapter.html(text).css({opacity: state.val ? 0.7 : 0});\n                 this.$tab.find('.group-upload-progress[data-adapter-group=\"' + $adapter.data('adapter-group') + '\"]').html(text).css({opacity: state.val ? 0.7 : 0});\n             }"
        },
        {
          "filename": "src/login/index.html",
          "status": "modified",
          "additions": 21,
          "deletions": 12,
          "patch": "@@ -2,7 +2,7 @@\n <head>\n     <style>\n         * {\n-            box-sizing:border-box;\n+            box-sizing: border-box;\n         }\n \n         body {\n@@ -63,7 +63,9 @@\n             border-bottom: 1px solid #757575;\n         }\n \n-        input:focus { outline: none; }\n+        input:focus {\n+            outline: none;\n+        }\n \n         /* Label */\n \n@@ -79,8 +81,8 @@\n         }\n \n         /* active */\n-\n-        input:focus ~ label, input.used ~ label {\n+        input:focus ~ label,\n+        input.used ~ label {\n             top: -20px;\n             transform: scale(.75); left: -2px;\n             /* font-size: 14px; */\n@@ -111,7 +113,10 @@\n \n         /* active */\n \n-        input:focus ~ .bar:before, input:focus ~ .bar:after { width: 50%; }\n+        input:focus ~ .bar:before,\n+        input:focus ~ .bar:after {\n+            width: 50%;\n+        }\n \n \n         /* Highlight */\n@@ -163,18 +168,21 @@\n             cursor: pointer;\n             transition: all 0.15s ease;\n         }\n-        .button:focus { outline: 0; }\n \n+        .button:focus {\n+            outline: 0;\n+        }\n \n         /* Button modifiers */\n-\n         .buttonBlue {\n             background: #2196f3;\n             text-shadow: 1px 1px 0 rgba(39, 110, 204, .5);\n             border-radius: 2px;\n         }\n \n-        .buttonBlue:hover { background: #39a1f4; }\n+        .buttonBlue:hover {\n+            background: #39a1f4;\n+        }\n \n \n         /* Ripples container */\n@@ -268,11 +276,11 @@ <h1 id=\"login-label\">ioBroker Admin</h1>\n </header>\n <form action=\"/login\" method=\"post\">\n     <div class=\"group\">\n-        <input type=\"text\" name=\"username\" id=\"username\"><span class=\"highlight\"></span><span class=\"bar\"></span>\n+        <input type=\"text\" name=\"username\" id=\"username\" class=\"used\"><span class=\"highlight\"></span><span class=\"bar\"></span>\n         <label id=\"username-label\" for=\"username\">Name</label>\n     </div>\n     <div class=\"group\">\n-        <input type=\"password\" name=\"password\" id=\"password\"><span class=\"highlight\"></span><span class=\"bar\"></span>\n+        <input type=\"password\" name=\"password\" id=\"password\" class=\"used\"><span class=\"highlight\"></span><span class=\"bar\"></span>\n         <label id=\"password-label\" for=\"password\">Password</label>\n     </div>\n     <input type=\"hidden\" id=\"origin\" name=\"origin\" value=\"\"/>\n@@ -355,7 +363,7 @@ <h1 id=\"login-label\">ioBroker Admin</h1>\n \n     var inputs = document.getElementsByTagName('INPUT');\n     if (inputs) {\n-        for (var i = 0; i < inputs.length; i++) {\n+        /*for (var i = 0; i < inputs.length; i++) {\n             inputs[i].addEventListener('blur', function() {\n                 if (this.value) {\n                     if (this.className.indexOf('used') === -1) {\n@@ -365,7 +373,7 @@ <h1 id=\"login-label\">ioBroker Admin</h1>\n                     this.className = this.className.replace(/\\s?used/, '');\n                 }\n             });\n-        }\n+        }*/\n         setTimeout(function () {\n             if (document.getElementById('username').value) {\n                 document.getElementById('password').focus();\n@@ -379,6 +387,7 @@ <h1 id=\"login-label\">ioBroker Admin</h1>\n             }\n         }, 300);\n     }\n+\n     document.getElementById('username').addEventListener('keydown', function (e) {\n         if (e.keyCode === 13) {\n             e.preventDefault();"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 2,
        "dependency_files": 2,
        "test_files": 0,
        "unique_directories": 4,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "2bfed452651ed920c75b4fa6792632acc99aa8af",
            "date": "2025-01-11T17:43:04Z",
            "author_login": "foxriver76"
          },
          {
            "sha": "a7cb118503e0c8ae76bc1329b4d283d2ee4a9555",
            "date": "2025-01-11T17:25:36Z",
            "author_login": "GermanBluefox"
          },
          {
            "sha": "a78107ac02e1624b6f74e0f9b84d3081ca56bb47",
            "date": "2025-01-11T16:23:43Z",
            "author_login": "GermanBluefox"
          },
          {
            "sha": "8ab6d4facb0bbd8915d7b6e4b4d35ca97125a0ea",
            "date": "2025-01-11T14:17:09Z",
            "author_login": "foxriver76"
          },
          {
            "sha": "0bb45ddb2223b3d065b9dd3f9f3b94015aee6083",
            "date": "2025-01-11T13:59:33Z",
            "author_login": "GermanBluefox"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 9.8,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
    "cwe_id": "CWE-22",
    "description": "iobroker.admin before 3.6.12 allows attacker to include file contents from outside the `/log/file1/` directory.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2019-11-20T16:15:12.873",
    "last_modified": "2024-11-21T04:19:52.703",
    "fix_date": "2019-10-09T16:29:20Z"
  },
  "references": [
    {
      "url": "https://github.com/ioBroker/ioBroker.admin/commit/16b2b325ab47896090bc7f54b77b0a97ed74f5cd",
      "source": "report@snyk.io",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://snyk.io/vuln/SNYK-JS-IOBROKERADMIN-534634",
      "source": "report@snyk.io",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/ioBroker/ioBroker.admin/commit/16b2b325ab47896090bc7f54b77b0a97ed74f5cd",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://snyk.io/vuln/SNYK-JS-IOBROKERADMIN-534634",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:00:09.207463",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "ioBroker.admin",
    "owner": "ioBroker",
    "created_at": "2014-08-20T15:23:02Z",
    "updated_at": "2025-01-11T17:43:08Z",
    "pushed_at": "2025-01-14T15:06:13Z",
    "size": 52270,
    "stars": 272,
    "forks": 78,
    "open_issues": 169,
    "watchers": 272,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "master"
    ],
    "languages": {
      "TypeScript": 4577198,
      "JavaScript": 990483,
      "Less": 64473,
      "CSS": 42927,
      "HTML": 23928
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-14T22:46:17.326018"
  }
}