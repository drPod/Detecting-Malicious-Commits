{
  "cve_id": "CVE-2019-14550",
  "github_data": {
    "repository": "espocrm/espocrm",
    "fix_commit": "ffd3f762ce4a8de3b8962f33513e073c55d943b5",
    "related_commits": [
      "ffd3f762ce4a8de3b8962f33513e073c55d943b5",
      "ffd3f762ce4a8de3b8962f33513e073c55d943b5"
    ],
    "patch_url": "https://github.com/espocrm/espocrm/commit/ffd3f762ce4a8de3b8962f33513e073c55d943b5.patch",
    "fix_commit_details": {
      "sha": "ffd3f762ce4a8de3b8962f33513e073c55d943b5",
      "commit_date": "2019-07-30T07:57:44Z",
      "author": {
        "login": "yurikuzn",
        "type": "User",
        "stats": {
          "total_commits": 17806,
          "average_weekly_commits": 30.437606837606836,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 566
        }
      },
      "commit_message": {
        "title": "xss fixes",
        "length": 9,
        "has_description": false,
        "references_issue": true
      },
      "stats": {
        "total": 116,
        "additions": 83,
        "deletions": 33
      },
      "files": [
        {
          "filename": "client/res/templates/attachment/fields/name/detail.tpl",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -1,2 +1,2 @@\n \n-<span class=\"fas fa-paperclip small\"></span> <a href=\"{{url}}\">{{{value}}}</a>\n+<span class=\"fas fa-paperclip small\"></span> <a href=\"{{url}}\">{{value}}</a>"
        },
        {
          "filename": "client/src/view-helper.js",
          "status": "modified",
          "additions": 71,
          "deletions": 0,
          "patch": "@@ -321,6 +321,77 @@ define('view-helper', ['lib!client/lib/purify.min.js'], function () {\n         sanitizeHtml: function (text, options) {\n             return DOMPurify.sanitize(text, options);\n         },\n+\n+        moderateSanitizeHtml: function (value) {\n+            value = value || '';\n+            value = value.replace(/<[\\/]{0,1}(base)[^><]*>/gi, '');\n+            value = value.replace(/<[\\/]{0,1}(object)[^><]*>/gi, '');\n+            value = value.replace(/<[\\/]{0,1}(embed)[^><]*>/gi, '');\n+            value = value.replace(/<[\\/]{0,1}(applet)[^><]*>/gi, '');\n+            value = value.replace(/<[\\/]{0,1}(iframe)[^><]*>/gi, '');\n+            value = value.replace(/<[\\/]{0,1}(script)[^><]*>/gi, '');\n+            value = value.replace(/<[^><]*([^a-z]{1}on[a-z]+)=[^><]*>/gi, function (match) {\n+                return match.replace(/[^a-z]{1}on[a-z]+=/gi, ' data-handler-stripped=');\n+            });\n+\n+            value = this.stripEventHandlersInHtml(value);\n+\n+            value = value.replace(/href=\" *javascript\\:(.*?)\"/gi, function(m, $1) {\n+                return 'removed=\"\"';\n+            });\n+            value = value.replace(/href=' *javascript\\:(.*?)'/gi, function(m, $1) {\n+                return 'removed=\"\"';\n+            });\n+            value = value.replace(/src=\" *javascript\\:(.*?)\"/gi, function(m, $1) {\n+                return 'removed=\"\"';\n+            });\n+            value = value.replace(/src=' *javascript\\:(.*?)'/gi, function(m, $1) {\n+                return 'removed=\"\"';\n+            });\n+\n+            return value;\n+        },\n+\n+        stripEventHandlersInHtml: function (html) {\n+            function stripHTML(){\n+                html = html.slice(0, strip) + html.slice(j);\n+                j = strip;\n+                strip = false;\n+            }\n+            function isValidTagChar(str) {\n+                return str.match(/[a-z?\\\\\\/!]/i);\n+            }\n+            var strip = false;\n+            var lastQuote = false;\n+            for (var i = 0; i<html.length; i++){\n+                if (html[i] === \"<\" && html[i+1] && isValidTagChar(html[i+1])) {\n+                    i++;\n+                    for (var j = i; j<html.length; j++){\n+                        if (!lastQuote && html[j] === \">\"){\n+                            if (strip) {\n+                                stripHTML();\n+                            }\n+                            i = j;\n+                            break;\n+                        }\n+                        if (lastQuote === html[j]){\n+                            lastQuote = false;\n+                            continue;\n+                        }\n+                        if (!lastQuote && html[j-1] === \"=\" && (html[j] === \"'\" || html[j] === '\"')){\n+                            lastQuote = html[j];\n+                        }\n+                        if (!lastQuote && html[j-2] === \" \" && html[j-1] === \"o\" && html[j] === \"n\"){\n+                            strip = j-2;\n+                        }\n+                        if (strip && html[j] === \" \" && !lastQuote){\n+                            stripHTML();\n+                        }\n+                    }\n+                }\n+            }\n+            return html;\n+        },\n     });\n \n     return ViewHelper;"
        },
        {
          "filename": "client/src/views/attachment/fields/name.js",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -26,7 +26,7 @@\n  * these Appropriate Legal Notices must retain the display of t\u0442he \"EspoCRM\" word.\n  ************************************************************************/\n \n-Espo.define('views/attachment/fields/name', 'views/fields/varchar', function (Dep) {\n+define('views/attachment/fields/name', 'views/fields/varchar', function (Dep) {\n \n     return Dep.extend({\n "
        },
        {
          "filename": "client/src/views/fields/wysiwyg.js",
          "status": "modified",
          "additions": 1,
          "deletions": 24,
          "patch": "@@ -165,30 +165,7 @@ Espo.define('views/fields/wysiwyg', ['views/fields/text', 'lib!Summernote'], fun\n \n \n         sanitizeHtmlLight: function (value) {\n-            value = value || '';\n-            value = value.replace(/<[\\/]{0,1}(base)[^><]*>/gi, '');\n-            value = value.replace(/<[\\/]{0,1}(object)[^><]*>/gi, '');\n-            value = value.replace(/<[\\/]{0,1}(embed)[^><]*>/gi, '');\n-            value = value.replace(/<[\\/]{0,1}(applet)[^><]*>/gi, '');\n-            value = value.replace(/<[\\/]{0,1}(iframe)[^><]*>/gi, '');\n-            value = value.replace(/<[\\/]{0,1}(script)[^><]*>/gi, '');\n-            value = value.replace(/<[^><]*([^a-z]{1}on[a-z]+)=[^><]*>/gi, function (match) {\n-                return match.replace(/[^a-z]{1}on[a-z]+=/gi, ' data-handler-stripped=');\n-            });\n-\n-            value = value.replace(/href=\" *javascript\\:(.*?)\"/gi, function(m, $1) {\n-                return 'removed=\"\"';\n-            });\n-            value = value.replace(/href=' *javascript\\:(.*?)'/gi, function(m, $1) {\n-                return 'removed=\"\"';\n-            });\n-            value = value.replace(/src=\" *javascript\\:(.*?)\"/gi, function(m, $1) {\n-                return 'removed=\"\"';\n-            });\n-            value = value.replace(/src=' *javascript\\:(.*?)'/gi, function(m, $1) {\n-                return 'removed=\"\"';\n-            });\n-            return value;\n+           return this.getHelper().moderateSanitizeHtml(value);\n         },\n \n         getValueForEdit: function () {"
        },
        {
          "filename": "client/src/views/preferences/fields/dashboard-tab-list.js",
          "status": "modified",
          "additions": 9,
          "deletions": 7,
          "patch": "@@ -26,7 +26,7 @@\n  * these Appropriate Legal Notices must retain the display of the \"EspoCRM\" word.\n  ************************************************************************/\n \n-Espo.define('views/preferences/fields/dashboard-tab-list', 'views/fields/array', function (Dep) {\n+define('views/preferences/fields/dashboard-tab-list', 'views/fields/array', function (Dep) {\n \n     return Dep.extend({\n \n@@ -39,17 +39,18 @@ Espo.define('views/preferences/fields/dashboard-tab-list', 'views/fields/array',\n                 this.translatedOptions[value] = value;\n             }, this);\n         },\n-\n         getItemHtml: function (value) {\n-            var translatedValue = this.translatedOptions[value] || value;\n+            value = value.toString();\n+            var valueSanitized = this.escapeValue(value);\n+            var translatedValue = this.escapeValue(this.translatedOptions[value] || value);\n \n             var html = '' +\n-            '<div class=\"list-group-item link-with-role form-inline\" data-value=\"' + value + '\">' +\n+            '<div class=\"list-group-item link-with-role form-inline\" data-value=\"' + valueSanitized + '\">' +\n                 '<div class=\"pull-left\" style=\"width: 92%; display: inline-block;\">' +\n-                    '<input data-name=\"translatedValue\" data-value=\"' + value + '\" class=\"role form-control input-sm\" value=\"'+translatedValue+'\">' +\n+                    '<input data-name=\"translatedValue\" data-value=\"' + valueSanitized + '\" class=\"role form-control input-sm\" value=\"'+translatedValue+'\">' +\n                 '</div>' +\n                 '<div style=\"width: 8%; display: inline-block; vertical-align: top;\">' +\n-                    '<a href=\"javascript:\" class=\"pull-right\" data-value=\"' + value + '\" data-action=\"removeValue\"><span class=\"fas fa-times\"></a>' +\n+                    '<a href=\"javascript:\" class=\"pull-right\" data-value=\"' + valueSanitized + '\" data-action=\"removeValue\"><span class=\"fas fa-times\"></a>' +\n                 '</div><br style=\"clear: both;\" />' +\n             '</div>';\n \n@@ -60,7 +61,8 @@ Espo.define('views/preferences/fields/dashboard-tab-list', 'views/fields/array',\n             var data = Dep.prototype.fetch.call(this);\n             data.translatedOptions = {};\n             (data[this.name] || []).forEach(function (value) {\n-                data.translatedOptions[value] = this.$el.find('input[data-name=\"translatedValue\"][data-value=\"'+value+'\"]').val() || value;\n+                var valueInternal = value.replace(/\"/g, '\\\\\"');\n+                data.translatedOptions[value] = this.$el.find('input[data-name=\"translatedValue\"][data-value=\"'+valueInternal+'\"]').val() || value;\n             }, this);\n \n             return data;"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 5,
        "max_directory_depth": 6
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "980b1cc40185a862096d6424086bc25c0451ae56",
            "date": "2025-01-14T18:45:13Z",
            "author_login": "yurikuzn"
          },
          {
            "sha": "a0c0b7cd5709654a38ae4b492cc1d6b6ba9f3f4f",
            "date": "2025-01-14T13:03:42Z",
            "author_login": "yurikuzn"
          },
          {
            "sha": "8675478b0a9301415d2afd3d8951bc33036a25b8",
            "date": "2025-01-14T11:44:01Z",
            "author_login": "yurikuzn"
          },
          {
            "sha": "c021466de94a10150a3319e46e56199b2ad43359",
            "date": "2025-01-14T11:01:20Z",
            "author_login": "yurikuzn"
          },
          {
            "sha": "758430ad38120ee39a16fe5fcaf4291e6f5877b2",
            "date": "2025-01-14T10:49:19Z",
            "author_login": "yurikuzn"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": null,
    "cvss_vector": null,
    "cwe_id": "CWE-79",
    "description": "An issue was discovered in EspoCRM before 5.6.9. Stored XSS was executed when a victim clicks on the Edit Dashboard feature present on the Homepage. An attacker can load malicious JavaScript inside the add tab list feature, which would fire when a user clicks on the Edit Dashboard button, thus helping him steal victims' cookies (hence compromising their accounts).",
    "attack_vector": null,
    "attack_complexity": null
  },
  "temporal_data": {
    "published_date": "2019-08-05T19:15:11.600",
    "last_modified": "2024-11-21T04:26:56.970",
    "fix_date": "2019-07-30T07:57:44Z"
  },
  "references": [
    {
      "url": "https://gauravnarwani.com/publications/cve-2019-14550/",
      "source": "cve@mitre.org",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/espocrm/espocrm/commit/ffd3f762ce4a8de3b8962f33513e073c55d943b5",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/espocrm/espocrm/issues/1369",
      "source": "cve@mitre.org",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/espocrm/espocrm/releases/tag/5.6.9",
      "source": "cve@mitre.org",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://gauravnarwani.com/publications/cve-2019-14550/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/espocrm/espocrm/commit/ffd3f762ce4a8de3b8962f33513e073c55d943b5",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/espocrm/espocrm/issues/1369",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/espocrm/espocrm/releases/tag/5.6.9",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T22:59:54.830811",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "espocrm",
    "owner": "espocrm",
    "created_at": "2014-09-25T13:38:46Z",
    "updated_at": "2025-01-14T13:03:51Z",
    "pushed_at": "2025-01-14T13:03:47Z",
    "size": 79790,
    "stars": 1940,
    "forks": 592,
    "open_issues": 50,
    "watchers": 1940,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "fix",
      "master",
      "stable"
    ],
    "languages": {
      "PHP": 11934707,
      "JavaScript": 5561169,
      "Less": 550393,
      "Smarty": 377691,
      "CSS": 40861,
      "HTML": 2102
    },
    "commit_activity": {
      "total_commits_last_year": 2712,
      "avg_commits_per_week": 52.15384615384615,
      "days_active_last_year": 331
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "agpl-3.0"
    },
    "collected_at": "2025-01-14T13:38:45.084907"
  }
}