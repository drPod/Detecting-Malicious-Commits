{
  "cve_id": "CVE-2019-20421",
  "github_data": {
    "repository": "Exiv2/exiv2",
    "fix_commit": "a82098f4f90cd86297131b5663c3dec6a34470e8",
    "related_commits": [
      "a82098f4f90cd86297131b5663c3dec6a34470e8",
      "a82098f4f90cd86297131b5663c3dec6a34470e8"
    ],
    "patch_url": "https://github.com/Exiv2/exiv2/commit/a82098f4f90cd86297131b5663c3dec6a34470e8.patch",
    "fix_commit_details": {
      "sha": "a82098f4f90cd86297131b5663c3dec6a34470e8",
      "commit_date": "2019-10-05T07:58:31Z",
      "author": {
        "login": "D4N",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Fix #1011 fix_1011_jp2_readmetadata_loop (#1013)",
        "length": 90,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 42,
        "additions": 35,
        "deletions": 7
      },
      "files": [
        {
          "filename": "src/jp2image.cpp",
          "status": "modified",
          "additions": 20,
          "deletions": 5,
          "patch": "@@ -18,10 +18,6 @@\n  * Foundation, Inc., 51 Franklin Street, 5th Floor, Boston, MA 02110-1301 USA.\n  */\n \n-/*\n-  File:      jp2image.cpp\n-*/\n-\n // *****************************************************************************\n \n // included header files\n@@ -197,6 +193,16 @@ namespace Exiv2\n         return result;\n     }\n \n+static void boxes_check(size_t b,size_t m)\n+{\n+    if ( b > m ) {\n+#ifdef EXIV2_DEBUG_MESSAGES\n+        std::cout << \"Exiv2::Jp2Image::readMetadata box maximum exceeded\" << std::endl;\n+#endif\n+        throw Error(kerCorruptedMetadata);\n+    }\n+}\n+\n     void Jp2Image::readMetadata()\n     {\n #ifdef EXIV2_DEBUG_MESSAGES\n@@ -219,9 +225,12 @@ namespace Exiv2\n         Jp2BoxHeader      subBox    = {0,0};\n         Jp2ImageHeaderBox ihdr      = {0,0,0,0,0,0,0,0};\n         Jp2UuidBox        uuid      = {{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}};\n+        size_t            boxes     = 0 ;\n+        size_t            boxem     = 1000 ; // boxes max\n \n         while (io_->read((byte*)&box, sizeof(box)) == sizeof(box))\n         {\n+            boxes_check(boxes++,boxem );\n             position   = io_->tell();\n             box.length = getLong((byte*)&box.length, bigEndian);\n             box.type   = getLong((byte*)&box.type, bigEndian);\n@@ -251,8 +260,12 @@ namespace Exiv2\n \n                     while (io_->read((byte*)&subBox, sizeof(subBox)) == sizeof(subBox) && subBox.length )\n                     {\n+                        boxes_check(boxes++, boxem) ;\n                         subBox.length = getLong((byte*)&subBox.length, bigEndian);\n                         subBox.type   = getLong((byte*)&subBox.type, bigEndian);\n+                        if (subBox.length > io_->size() ) {\n+                            throw Error(kerCorruptedMetadata);\n+                        }\n #ifdef EXIV2_DEBUG_MESSAGES\n                         std::cout << \"Exiv2::Jp2Image::readMetadata: \"\n                         << \"subBox = \" << toAscii(subBox.type) << \" length = \" << subBox.length << std::endl;\n@@ -308,7 +321,9 @@ namespace Exiv2\n                         }\n \n                         io_->seek(restore,BasicIo::beg);\n-                        io_->seek(subBox.length, Exiv2::BasicIo::cur);\n+                        if ( io_->seek(subBox.length, Exiv2::BasicIo::cur) != 0 ) {\n+                            throw Error(kerCorruptedMetadata);\n+                        }\n                         restore = io_->tell();\n                     }\n                     break;"
        },
        {
          "filename": "test/data/Jp2Image_readMetadata_loop.poc",
          "status": "added",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "tests/bugfixes/github/test_CVE_2017_17725.py",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -11,7 +11,7 @@ class TestCvePoC(metaclass=system_tests.CaseMeta):\n     filename = \"$data_path/poc_2017-12-12_issue188\"\n     commands = [\"$exiv2 \" + filename]\n     stdout = [\"\"]\n-    stderr = [\"\"\"$exiv2_overflow_exception_message \"\"\" + filename + \"\"\":\n-$addition_overflow_message\n+    stderr = [\"\"\"$exiv2_exception_message \"\"\" + filename + \"\"\":\n+$kerCorruptedMetadata\n \"\"\"]\n     retval = [1]"
        },
        {
          "filename": "tests/bugfixes/github/test_issue_1011.py",
          "status": "added",
          "additions": 13,
          "deletions": 0,
          "patch": "@@ -0,0 +1,13 @@\n+# -*- coding: utf-8 -*-\n+\n+from system_tests import CaseMeta, path\n+\n+class Test_issue_1011(metaclass=CaseMeta):\n+\n+    filename = path(\"$data_path/Jp2Image_readMetadata_loop.poc\")\n+    commands = [\"$exiv2 \" + filename]\n+    stdout   = [\"\"]\n+    stderr   = [\"\"\"$exiv2_exception_message \"\"\" + filename + \"\"\":\n+$kerCorruptedMetadata\n+\"\"\"]\n+    retval = [1]\n\\ No newline at end of file"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 3,
        "unique_directories": 3,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "d70512ed9f75e04a144d0f74d37df3d8f5c48e77",
            "date": "2025-01-14T18:15:48Z",
            "author_login": "kmilos"
          },
          {
            "sha": "a1b65bbddb1b10c4525b267af7f806408afd8b09",
            "date": "2025-01-13T18:45:29Z",
            "author_login": "kamiccolo"
          },
          {
            "sha": "cf64c2cca727195b5ee27f3438916dec3830a0d4",
            "date": "2025-01-12T05:43:43Z",
            "author_login": "neheb"
          },
          {
            "sha": "289eb76313f866aad94cc0cdf187a86be41b2046",
            "date": "2023-11-26T20:48:52Z",
            "author_login": "neheb"
          },
          {
            "sha": "9635d6fbbe19ab5f09649056b1cd6631396ddef2",
            "date": "2025-01-07T22:09:12Z",
            "author_login": "neheb"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 7.5,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H",
    "cwe_id": "CWE-835",
    "description": "In Jp2Image::readMetadata() in jp2image.cpp in Exiv2 0.27.2, an input file can result in an infinite loop and hang, with high CPU consumption. Remote attackers could leverage this vulnerability to cause a denial of service via a crafted file.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2020-01-27T05:15:10.453",
    "last_modified": "2024-11-21T04:38:25.993",
    "fix_date": "2019-10-05T07:58:31Z"
  },
  "references": [
    {
      "url": "https://github.com/Exiv2/exiv2/commit/a82098f4f90cd86297131b5663c3dec6a34470e8",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/Exiv2/exiv2/issues/1011",
      "source": "cve@mitre.org",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2021/08/msg00028.html",
      "source": "cve@mitre.org",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://usn.ubuntu.com/4270-1/",
      "source": "cve@mitre.org",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.debian.org/security/2021/dsa-4958",
      "source": "cve@mitre.org",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/Exiv2/exiv2/commit/a82098f4f90cd86297131b5663c3dec6a34470e8",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/Exiv2/exiv2/issues/1011",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2021/08/msg00028.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://usn.ubuntu.com/4270-1/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.debian.org/security/2021/dsa-4958",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:00:37.490554",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "exiv2",
    "owner": "Exiv2",
    "created_at": "2017-04-27T17:25:13Z",
    "updated_at": "2025-01-13T23:55:45Z",
    "pushed_at": "2025-01-14T10:46:44Z",
    "size": 127560,
    "stars": 962,
    "forks": 285,
    "open_issues": 173,
    "watchers": 962,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [
      "0.25",
      "0.26",
      "0.27-maintenance",
      "0.28.x",
      "main",
      "old-master"
    ],
    "languages": {
      "C++": 4307014,
      "Python": 937259,
      "CMake": 69364,
      "C": 36920,
      "Meson": 13972,
      "Shell": 8085,
      "Batchfile": 914,
      "CodeQL": 599,
      "QMake": 392,
      "sed": 370
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T13:14:17.965961"
  }
}