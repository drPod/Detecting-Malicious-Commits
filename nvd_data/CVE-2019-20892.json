{
  "cve_id": "CVE-2019-20892",
  "github_data": {
    "repository": "net-snmp/net-snmp",
    "fix_commit": "5f881d3bf24599b90d67a45cae7a3eb099cd71c9",
    "related_commits": [
      "5f881d3bf24599b90d67a45cae7a3eb099cd71c9",
      "5f881d3bf24599b90d67a45cae7a3eb099cd71c9"
    ],
    "patch_url": "https://github.com/net-snmp/net-snmp/commit/5f881d3bf24599b90d67a45cae7a3eb099cd71c9.patch",
    "fix_commit_details": {
      "sha": "5f881d3bf24599b90d67a45cae7a3eb099cd71c9",
      "commit_date": "2019-07-28T02:34:09Z",
      "author": {
        "login": "bvanassche",
        "type": "User",
        "stats": {
          "total_commits": 3901,
          "average_weekly_commits": 5.509887005649717,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 366
        }
      },
      "commit_message": {
        "title": "libsnmp, USM: Introduce a reference count in struct usmStateReference",
        "length": 134,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 95,
        "additions": 53,
        "deletions": 42
      },
      "files": [
        {
          "filename": "snmplib/snmp_client.c",
          "status": "modified",
          "additions": 5,
          "deletions": 17,
          "patch": "@@ -405,28 +405,16 @@ _clone_pdu_header(netsnmp_pdu *pdu)\n         return NULL;\n     }\n \n-    if (pdu->securityStateRef &&\n-        pdu->command == SNMP_MSG_TRAP2) {\n-\n-        netsnmp_assert(pdu->securityModel == SNMP_DEFAULT_SECMODEL);\n-        ret = usm_clone_usmStateReference((struct usmStateReference *) pdu->securityStateRef,\n-                (struct usmStateReference **) &newpdu->securityStateRef );\n-\n-        if (ret)\n-        {\n+    sptr = find_sec_mod(newpdu->securityModel);\n+    if (sptr && sptr->pdu_clone) {\n+        /* call security model if it needs to know about this */\n+        ret = sptr->pdu_clone(pdu, newpdu);\n+        if (ret) {\n             snmp_free_pdu(newpdu);\n             return NULL;\n         }\n     }\n \n-    if ((sptr = find_sec_mod(newpdu->securityModel)) != NULL &&\n-        sptr->pdu_clone != NULL) {\n-        /*\n-         * call security model if it needs to know about this \n-         */\n-        (*sptr->pdu_clone) (pdu, newpdu);\n-    }\n-\n     return newpdu;\n }\n "
        },
        {
          "filename": "snmplib/snmpusm.c",
          "status": "modified",
          "additions": 48,
          "deletions": 25,
          "patch": "@@ -85,6 +85,7 @@ netsnmp_feature_child_of(usm_support, usm_all)\n netsnmp_feature_require(usm_support)\n \n struct usmStateReference {\n+    int             refcnt;\n     char           *usr_name;\n     size_t          usr_name_length;\n     u_char         *usr_engine_id;\n@@ -280,42 +281,63 @@ free_enginetime_on_shutdown(int majorid, int minorid, void *serverarg,\n static struct usmStateReference *\n usm_malloc_usmStateReference(void)\n {\n-    struct usmStateReference *retval = (struct usmStateReference *)\n-        calloc(1, sizeof(struct usmStateReference));\n+    struct usmStateReference *retval;\n+\n+    retval = calloc(1, sizeof(struct usmStateReference));\n+    if (retval)\n+        retval->refcnt = 1;\n \n     return retval;\n }                               /* end usm_malloc_usmStateReference() */\n \n+static int\n+usm_clone(netsnmp_pdu *pdu, netsnmp_pdu *new_pdu)\n+{\n+    struct usmStateReference *ref = pdu->securityStateRef;\n+    struct usmStateReference **new_ref =\n+        (struct usmStateReference **)&new_pdu->securityStateRef;\n+    int ret = 0;\n+\n+    if (!ref)\n+        return ret;\n+\n+    if (pdu->command == SNMP_MSG_TRAP2) {\n+        netsnmp_assert(pdu->securityModel == SNMP_DEFAULT_SECMODEL);\n+        ret = usm_clone_usmStateReference(ref, new_ref);\n+    } else {\n+        netsnmp_assert(ref == *new_ref);\n+        ref->refcnt++;\n+    }\n+\n+    return ret;\n+}\n+\n static void\n usm_free_usmStateReference(void *old)\n {\n-    struct usmStateReference *old_ref = (struct usmStateReference *) old;\n-\n-    if (old_ref) {\n-\n-        if (old_ref->usr_name_length)\n-            SNMP_FREE(old_ref->usr_name);\n-        if (old_ref->usr_engine_id_length)\n-            SNMP_FREE(old_ref->usr_engine_id);\n-        if (old_ref->usr_auth_protocol_length)\n-            SNMP_FREE(old_ref->usr_auth_protocol);\n-        if (old_ref->usr_priv_protocol_length)\n-            SNMP_FREE(old_ref->usr_priv_protocol);\n-\n-        if (old_ref->usr_auth_key_length && old_ref->usr_auth_key) {\n-            SNMP_ZERO(old_ref->usr_auth_key, old_ref->usr_auth_key_length);\n-            SNMP_FREE(old_ref->usr_auth_key);\n-        }\n-        if (old_ref->usr_priv_key_length && old_ref->usr_priv_key) {\n-            SNMP_ZERO(old_ref->usr_priv_key, old_ref->usr_priv_key_length);\n-            SNMP_FREE(old_ref->usr_priv_key);\n-        }\n+    struct usmStateReference *ref = old;\n+\n+    if (!ref)\n+        return;\n+\n+    if (--ref->refcnt > 0)\n+        return;\n \n-        SNMP_ZERO(old_ref, sizeof(*old_ref));\n-        SNMP_FREE(old_ref);\n+    SNMP_FREE(ref->usr_name);\n+    SNMP_FREE(ref->usr_engine_id);\n+    SNMP_FREE(ref->usr_auth_protocol);\n+    SNMP_FREE(ref->usr_priv_protocol);\n \n+    if (ref->usr_auth_key_length && ref->usr_auth_key) {\n+        SNMP_ZERO(ref->usr_auth_key, ref->usr_auth_key_length);\n+        SNMP_FREE(ref->usr_auth_key);\n+    }\n+    if (ref->usr_priv_key_length && ref->usr_priv_key) {\n+        SNMP_ZERO(ref->usr_priv_key, ref->usr_priv_key_length);\n+        SNMP_FREE(ref->usr_priv_key);\n     }\n \n+    SNMP_FREE(ref);\n }                               /* end usm_free_usmStateReference() */\n \n struct usmUser *\n@@ -4916,6 +4938,7 @@ init_usm(void)\n     def->encode_reverse = usm_secmod_rgenerate_out_msg;\n     def->encode_forward = usm_secmod_generate_out_msg;\n     def->decode = usm_secmod_process_in_msg;\n+    def->pdu_clone = usm_clone;\n     def->pdu_free_state_ref = usm_free_usmStateReference;\n     def->session_setup = usm_session_init;\n     def->handle_report = usm_handle_report;"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 1,
        "max_directory_depth": 1
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "1c6e66b3122b7fd878d17f40664adf831d1a2c7a",
            "date": "2024-12-18T05:40:40Z",
            "author_login": "orgads"
          },
          {
            "sha": "d17282ed842364d83be83d1a45ad95dd986cdb0a",
            "date": "2024-12-17T10:03:57Z",
            "author_login": "orgads"
          },
          {
            "sha": "59c0c1a2b8787fbfa0975549f41e64d31c5c2b60",
            "date": "2024-12-17T20:36:35Z",
            "author_login": "bvanassche"
          },
          {
            "sha": "75829eb857f2468001050fda26af843bcb9475db",
            "date": "2024-12-17T18:59:59Z",
            "author_login": "orgads"
          },
          {
            "sha": "46980afe4a4b5ce9820bd4419064d18e28fe215b",
            "date": "2024-12-11T15:56:25Z",
            "author_login": "bvanassche"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.5,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H",
    "cwe_id": "CWE-415",
    "description": "net-snmp before 5.8.1.pre1 has a double free in usm_free_usmStateReference in snmplib/snmpusm.c via an SNMPv3 GetBulk request. NOTE: this affects net-snmp packages shipped to end users by multiple Linux distributions, but might not affect an upstream release.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2020-06-25T10:15:10.667",
    "last_modified": "2024-11-21T04:39:37.973",
    "fix_date": "2019-07-28T02:34:09Z"
  },
  "references": [
    {
      "url": "http://www.openwall.com/lists/oss-security/2020/06/25/4",
      "source": "cve@mitre.org",
      "tags": [
        "Exploit",
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://bugs.launchpad.net/ubuntu/+source/net-snmp/+bug/1877027",
      "source": "cve@mitre.org",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://bugzilla.redhat.com/show_bug.cgi?id=1663027",
      "source": "cve@mitre.org",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/net-snmp/net-snmp/commit/5f881d3bf24599b90d67a45cae7a3eb099cd71c9",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://security.gentoo.org/glsa/202008-12",
      "source": "cve@mitre.org",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://sourceforge.net/p/net-snmp/bugs/2923/",
      "source": "cve@mitre.org",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://usn.ubuntu.com/4410-1/",
      "source": "cve@mitre.org",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.oracle.com/security-alerts/cpujan2021.html",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2020/06/25/4",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://bugs.launchpad.net/ubuntu/+source/net-snmp/+bug/1877027",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://bugzilla.redhat.com/show_bug.cgi?id=1663027",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/net-snmp/net-snmp/commit/5f881d3bf24599b90d67a45cae7a3eb099cd71c9",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://security.gentoo.org/glsa/202008-12",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://sourceforge.net/p/net-snmp/bugs/2923/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://usn.ubuntu.com/4410-1/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.oracle.com/security-alerts/cpujan2021.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:01:01.338844",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "net-snmp",
    "owner": "net-snmp",
    "created_at": "2018-04-09T19:19:27Z",
    "updated_at": "2025-01-13T17:42:11Z",
    "pushed_at": "2024-12-20T00:11:20Z",
    "size": 75523,
    "stars": 352,
    "forks": 224,
    "open_issues": 310,
    "watchers": 352,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "C": 15335594,
      "Perl": 796786,
      "Shell": 669123,
      "M4": 216800,
      "Makefile": 96403,
      "XS": 64753,
      "Python": 32626,
      "Batchfile": 13387,
      "Mathematica": 7281,
      "OpenEdge ABL": 7281,
      "C++": 7003
    },
    "commit_activity": {
      "total_commits_last_year": 155,
      "avg_commits_per_week": 2.980769230769231,
      "days_active_last_year": 64
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T12:54:50.687765"
  }
}