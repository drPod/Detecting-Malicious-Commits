{
  "cve_id": "CVE-2019-6706",
  "github_data": {
    "repository": "lua/lua",
    "fix_commit": "89aee84cbc9224f638f3b7951b306d2ee8ecb71e",
    "related_commits": [
      "89aee84cbc9224f638f3b7951b306d2ee8ecb71e",
      "89aee84cbc9224f638f3b7951b306d2ee8ecb71e"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "89aee84cbc9224f638f3b7951b306d2ee8ecb71e",
      "commit_date": "2019-03-27T17:30:12Z",
      "author": {
        "login": "roberto-ieru",
        "type": "User",
        "stats": {
          "total_commits": 5548,
          "average_weekly_commits": 3.372644376899696,
          "total_additions": 217047,
          "total_deletions": 161720,
          "weeks_active": 1125
        }
      },
      "commit_message": {
        "title": "Fixed bug in 'lua_upvaluejoin'",
        "length": 107,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 80,
        "additions": 41,
        "deletions": 39
      },
      "files": [
        {
          "filename": "bugs",
          "status": "modified",
          "additions": 33,
          "deletions": 31,
          "patch": "@@ -357,7 +357,7 @@ co = coroutine.create(co_func)\n coroutine.resume(co)\n coroutine.resume(co)     --> seg. fault\n ]],\n-report = [[by Alex Bilyk, 09/05/2003]], \n+report = [[by Alex Bilyk, 09/05/2003]],\n patch = [[\n * ldo.c:\n 325,326c325\n@@ -399,7 +399,7 @@ what = [[file:close cannot be called without a file. (results in seg fault)]],\n example = [[\n > io.stdin.close()    -- correct call shold be io.stdin:close()\n ]],\n-report = [[by Tuomo Valkonen, 27/05/2003]], \n+report = [[by Tuomo Valkonen, 27/05/2003]],\n patch = [[\n * liolib.c:\n 161c161\n@@ -1641,7 +1641,7 @@ what = [[debug.sethook/gethook may overflow the thread's stack]],\n report = [[Ivko Stanilov, on 2008/01/04]],\n since = [[5.1]],\n example = [[\n-a = coroutine.create(function() yield() end) \n+a = coroutine.create(function() yield() end)\n coroutine.resume(a)\n debug.sethook(a)      -- may overflow the stack of 'a'\n ]],\n@@ -2707,7 +2707,7 @@ local firsttime = true\n local function foo ()\n   if firsttime then\n     firsttime = false\n-    return \"a = 1\" \n+    return \"a = 1\"\n   else\n     for i = 1, 10 do\n       print(debug.getlocal(2, i))\n@@ -2899,28 +2899,6 @@ patch = [[\n ]]\n }\n \n-Bug{\n-what = [[Lua does not check memory use when creating error messages]],\n-report = [[John Dunn, 2012/09/24]],\n-since = [[5.2.0]],\n-fix = nil,\n-example = [[\n-local code = \"function test()\\n  bob.joe.larry = 23\\n end\"\n-\n-load(code)()\n-\n--- memory will grow steadly \n-for i = 1, math.huge do\n-  pcall(test)\n-  if i % 100000 == 0 then\n-    io.write(collectgarbage'count'*1024, \"\\n\")\n-  end\n-end\n-]],\n-patch = [[\n-]]\n-}\n-\n \n \n \n@@ -3859,11 +3837,11 @@ report = [[Viacheslav Usov, 2017/07/06]],\n since = [[5.3.2]],\n fix = nil,\n example = [[\n-function test()  \n+function test()\n   bob.joe.larry = 23\n end\n \n--- memory will grow steadly \n+-- memory will grow steadly\n for i = 1, math.huge do\n   pcall(test)\n   if i % 100000 == 0 then\n@@ -3892,7 +3870,7 @@ report = [[\u4e91\u98ce Cloud Wu, 2017/08/15]],\n since = [[5.2]],\n fix = nil,\n example = [[\n--- The following chunk, under a memory checker like valgrind, \n+-- The following chunk, under a memory checker like valgrind,\n -- produces a memory access violation.\n \n local a = setmetatable({}, {__mode = 'kv'})\n@@ -4020,7 +3998,6 @@ patch = [[\n -----------------------------------------------------------------\n -- Lua 5.3.5\n \n---[=[\n Bug{\n what = [[Long brackets with a huge number of '=' overflow some\n internal buffer arithmetic]],\n@@ -4111,9 +4088,34 @@ patch = [[\n        }\n ]]\n }\n-]=]\n \n \n+Bug{\n+what = [[joining an upvalue with itself can cause a use-after-free crash]],\n+report = [[Fady Othman, 2019/01/10]],\n+since = [[5.3]],\n+fix = nil,\n+example = [[\n+-- the next code may crash the machine\n+f=load(function() end)\n+interesting={}\n+interesting[0]=string.rep(\"A\",512)\n+debug.upvaluejoin(f,1,f,1)\n+]],\n+patch = [[\n+--- a/lapi.c\n++++ b/lapi.c\n+@@ -1289,6 +1289,8 @@ LUA_API void lua_upvaluejoin (lua_State *L, int fidx1, int n1,\n+   LClosure *f1;\n+   UpVal **up1 = getupvalref(L, fidx1, n1, &f1);\n+   UpVal **up2 = getupvalref(L, fidx2, n2, NULL);\n++  if (*up1 == *up2)\n++    return;\n+   luaC_upvdeccount(L, *up1);\n+   *up1 = *up2;\n+   (*up1)->refcount++;\n+]]\n+}\n \n \n --[=["
        },
        {
          "filename": "lapi.c",
          "status": "modified",
          "additions": 6,
          "deletions": 6,
          "patch": "@@ -1254,13 +1254,12 @@ LUA_API const char *lua_setupvalue (lua_State *L, int funcindex, int n) {\n }\n \n \n-static UpVal **getupvalref (lua_State *L, int fidx, int n, LClosure **pf) {\n+static UpVal **getupvalref (lua_State *L, int fidx, int n) {\n   LClosure *f;\n   StkId fi = index2addr(L, fidx);\n   api_check(L, ttisLclosure(fi), \"Lua function expected\");\n   f = clLvalue(fi);\n   api_check(L, (1 <= n && n <= f->p->sizeupvalues), \"invalid upvalue index\");\n-  if (pf) *pf = f;\n   return &f->upvals[n - 1];  /* get its upvalue pointer */\n }\n \n@@ -1269,7 +1268,7 @@ LUA_API void *lua_upvalueid (lua_State *L, int fidx, int n) {\n   StkId fi = index2addr(L, fidx);\n   switch (ttype(fi)) {\n     case LUA_TLCL: {  /* lua closure */\n-      return *getupvalref(L, fidx, n, NULL);\n+      return *getupvalref(L, fidx, n);\n     }\n     case LUA_TCCL: {  /* C closure */\n       CClosure *f = clCvalue(fi);\n@@ -1286,9 +1285,10 @@ LUA_API void *lua_upvalueid (lua_State *L, int fidx, int n) {\n \n LUA_API void lua_upvaluejoin (lua_State *L, int fidx1, int n1,\n                                             int fidx2, int n2) {\n-  LClosure *f1;\n-  UpVal **up1 = getupvalref(L, fidx1, n1, &f1);\n-  UpVal **up2 = getupvalref(L, fidx2, n2, NULL);\n+  UpVal **up1 = getupvalref(L, fidx1, n1);\n+  UpVal **up2 = getupvalref(L, fidx2, n2);\n+  if (*up1 == *up2)\n+    return;\n   luaC_upvdeccount(L, *up1);\n   *up1 = *up2;\n   (*up1)->refcount++;"
        },
        {
          "filename": "makefile",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -58,9 +58,9 @@ MYLDFLAGS= $(LOCAL) -Wl,-E\n MYLIBS= -ldl -lreadline\n \n \n-CC= clang-3.8\n+CC= gcc\n CFLAGS= -Wall -O2 $(MYCFLAGS)\n-AR= ar rcu\n+AR= ar rc\n RANLIB= ranlib\n RM= rm -f\n "
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 1,
        "max_directory_depth": 0
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "3cdd49c94a8feed94853ba3a6adaa556fb34fd8d",
            "date": "2025-01-14T19:24:46Z",
            "author_login": "roberto-ieru"
          },
          {
            "sha": "10e931da82268a9d190c17a9bdb9b1a4b48c2947",
            "date": "2025-01-13T14:23:07Z",
            "author_login": "roberto-ieru"
          },
          {
            "sha": "4b107a87760ee5f85185a904c9088ca476b94be5",
            "date": "2025-01-10T18:27:17Z",
            "author_login": "roberto-ieru"
          },
          {
            "sha": "429761d7d29226dd0c220de9fdc7c28ea54d95c0",
            "date": "2025-01-10T18:14:01Z",
            "author_login": "roberto-ieru"
          },
          {
            "sha": "915c29f8bd0d4b0435a4b51a6c7913f5e170d09e",
            "date": "2025-01-10T18:11:54Z",
            "author_login": "roberto-ieru"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 7.5,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H",
    "cwe_id": "CWE-416",
    "description": "Lua 5.3.5 has a use-after-free in lua_upvaluejoin in lapi.c. For example, a crash outcome might be achieved by an attacker who is able to trigger a debug.upvaluejoin call in which the arguments have certain relationships.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2019-01-23T19:29:00.447",
    "last_modified": "2024-11-21T04:46:59.147",
    "fix_date": "2019-03-27T17:30:12Z"
  },
  "references": [
    {
      "url": "http://lua-users.org/lists/lua-l/2019-01/msg00039.html",
      "source": "cve@mitre.org",
      "tags": [
        "Broken Link"
      ]
    },
    {
      "url": "http://packetstormsecurity.com/files/151335/Lua-5.3.5-Use-After-Free.html",
      "source": "cve@mitre.org",
      "tags": [
        "Exploit",
        "Third Party Advisory",
        "VDB Entry"
      ]
    },
    {
      "url": "https://access.redhat.com/security/cve/cve-2019-6706",
      "source": "cve@mitre.org",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/Lua-Project/cve-analysis/blob/a43c9ccd00274b31fa2f24c6c8f20ce36655682d/CVE-2019-6706.pdf",
      "source": "cve@mitre.org",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/lua/lua/commit/89aee84cbc9224f638f3b7951b306d2ee8ecb71e",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2023/06/msg00031.html",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "http://lua-users.org/lists/lua-l/2019-01/msg00039.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Broken Link"
      ]
    },
    {
      "url": "http://packetstormsecurity.com/files/151335/Lua-5.3.5-Use-After-Free.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Third Party Advisory",
        "VDB Entry"
      ]
    },
    {
      "url": "https://access.redhat.com/security/cve/cve-2019-6706",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/Lua-Project/cve-analysis/blob/a43c9ccd00274b31fa2f24c6c8f20ce36655682d/CVE-2019-6706.pdf",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/lua/lua/commit/89aee84cbc9224f638f3b7951b306d2ee8ecb71e",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2023/06/msg00031.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T22:59:44.406611",
    "processing_status": "enhanced"
  }
}