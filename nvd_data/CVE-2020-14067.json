{
  "cve_id": "CVE-2020-14067",
  "github_data": {
    "repository": "NavigateCMS/Navigate-CMS",
    "fix_commit": "f1f47126b359d73a2635306ae46d8719c14d240b",
    "related_commits": [
      "f1f47126b359d73a2635306ae46d8719c14d240b",
      "f1f47126b359d73a2635306ae46d8719c14d240b"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "f1f47126b359d73a2635306ae46d8719c14d240b",
      "commit_date": "2020-06-11T10:20:32Z",
      "author": {
        "login": "NavigateCMS",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "* themes,extensions: secure \"install_from_hash\" functionality",
        "length": 61,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 631,
        "additions": 343,
        "deletions": 288
      },
      "files": [
        {
          "filename": "lib/packages/extensions/extension.class.php",
          "status": "modified",
          "additions": 6,
          "deletions": 2,
          "patch": "@@ -551,7 +551,7 @@ public static function check_upload($file_upload, $extension_name)\n         }\r\n \r\n         // check every php file included\r\n-        $files = core_recursive_file_search($tempdir,  '/.*\\/*.php/');\r\n+        $files = core_recursive_file_search($tempdir,  '/.*\\/*.(php|phtml)/');\r\n \r\n         $prohibited_functions = array(\r\n             'eval(',\r\n@@ -566,8 +566,12 @@ public static function check_upload($file_upload, $extension_name)\n \r\n         foreach($files as $file)\r\n         {\r\n-            // remove all spaces\r\n+            if(!file_exists($file))\r\n+            {\r\n+                continue;\r\n+            }\r\n             $file_content = file_get_contents($file);\r\n+            // remove all spaces\r\n             $file_content = str_replace(array(' ', \"\\t\", \"\\r\", \"\\n\"), '', $file_content);\r\n \r\n             foreach($prohibited_functions as $pf)\r"
        },
        {
          "filename": "lib/packages/extensions/extensions.js",
          "status": "modified",
          "additions": 234,
          "deletions": 188,
          "patch": "@@ -1,231 +1,277 @@\n-// make executable the runnable extensions\r\n-$(\".navigrid-item-buttonset[run='1'],.navigrid-item-buttonset[run='true']\").parent().on(\"dblclick\", function()\r\n+function navigate_extensions_init()\r\n {\r\n-    // is this extension enabled?\r\n-    if($(this).find(\".navigrid-item-buttonset\").attr(\"enabled\")==\"0\")\r\n-        return;\r\n-\r\n-    var extension = $(this).find(\".navigrid-item-buttonset\").attr(\"extension\");\r\n-    //location.href = NAVIGATE_APP + \"?fid=extensions&act=run&extension=\" + extension;\r\n-    location.href = NAVIGATE_APP + \"?fid=ext_\" + extension;\r\n-});\r\n+    // make executable the runnable extensions\r\n+    $(\".navigrid-item-buttonset[run='1'],.navigrid-item-buttonset[run='true']\").parent().on(\"dblclick\", function()\r\n+    {\r\n+        // is this extension enabled?\r\n+        if($(this).find(\".navigrid-item-buttonset\").attr(\"enabled\")==\"0\")\r\n+            return;\r\n \r\n-// open configuration on NON runnable extensions (if configuration is available)\r\n-$(\".navigrid-item-buttonset[run='']\").parent().on(\"dblclick\", function()\r\n-{\r\n-    // is this extension enabled?\r\n-    if($(this).find(\".navigrid-item-buttonset\").attr(\"enabled\")==\"0\")\r\n-        return;\r\n+        var extension = $(this).find(\".navigrid-item-buttonset\").attr(\"extension\");\r\n+        //location.href = NAVIGATE_APP + \"?fid=extensions&act=run&extension=\" + extension;\r\n+        location.href = NAVIGATE_APP + \"?fid=ext_\" + extension;\r\n+    });\r\n \r\n-    // has this extension a configuration option?\r\n-    if($(this).find('.navigrid-extensions-settings').length > 0)\r\n-        $(this).find('.navigrid-extensions-settings').trigger('click');\r\n-});\r\n+    // open configuration on NON runnable extensions (if configuration is available)\r\n+    $(\".navigrid-item-buttonset[run='']\").parent().on(\"dblclick\", function()\r\n+    {\r\n+        // is this extension enabled?\r\n+        if($(this).find(\".navigrid-item-buttonset\").attr(\"enabled\")==\"0\")\r\n+            return;\r\n \r\n-// show extension info window\r\n-$(\".navigrid-extensions-info\").bind(\"click\", function()\r\n-{\r\n-    var extension = $(this).parent().attr(\"extension\");\r\n+        // has this extension a configuration option?\r\n+        if($(this).find('.navigrid-extensions-settings').length > 0)\r\n+            $(this).find('.navigrid-extensions-settings').trigger('click');\r\n+    });\r\n \r\n-    $(\"#navigrid-extension-information\").attr(\"title\", $(this).parent().attr(\"extension-title\"));\r\n-    $(\"#navigrid-extension-information\").load(\"?fid=extensions&act=extension_info&extension=\" + extension, function()\r\n+    // show extension info window\r\n+    $(\".navigrid-extensions-info\").bind(\"click\", function()\r\n     {\r\n-        $(\"#navigrid-extension-information\").dialog(\r\n-            {\r\n-                width: 700,\r\n-                height: 500,\r\n-                modal: true,\r\n-                title: \"<img src=\\\"img/icons/silk/information.png\\\" align=\\\"absmiddle\\\"> \" + $(\"#navigrid-extension-information\").attr(\"title\")\r\n-            }).dialogExtend(\r\n-            {\r\n-                maximizable: true\r\n-            });\r\n-    });\r\n-});\r\n+        var extension = $(this).parent().attr(\"extension\");\r\n \r\n-// disable extension\r\n-$(\".navigrid-extensions-disable\").bind(\"click\", function()\r\n-{\r\n-    var extension = $(this).parent().attr(\"extension\");\r\n-    $.post(\r\n-        NAVIGATE_APP + \"?fid=extensions&act=disable\",\r\n-        { extension: extension },\r\n-        function(data)\r\n+        $(\"#navigrid-extension-information\").attr(\"title\", $(this).parent().attr(\"extension-title\"));\r\n+        $(\"#navigrid-extension-information\").load(\"?fid=extensions&act=extension_info&extension=\" + extension, function()\r\n         {\r\n-            $(\"div#item-\" + extension).find(\".navigrid-extensions-enable\").hide();\r\n-            $(\"div#item-\" + extension).find(\".navigrid-extensions-disable\").hide();\r\n-            $(\"div#item-\" + extension).find(\".navigrid-extensions-remove\").hide();\r\n+            $(\"#navigrid-extension-information\").dialog(\r\n+                {\r\n+                    width: 700,\r\n+                    height: 500,\r\n+                    modal: true,\r\n+                    title: \"<img src=\\\"img/icons/silk/information.png\\\" align=\\\"absmiddle\\\"> \" + $(\"#navigrid-extension-information\").attr(\"title\")\r\n+                }).dialogExtend(\r\n+                {\r\n+                    maximizable: true\r\n+                });\r\n+        });\r\n+    });\r\n \r\n-            if(data==\"true\")\r\n-            {\r\n-                $(\"div#item-\" + extension).find(\".navigrid-extensions-enable\").show();\r\n-                $(\"div#item-\" + extension).find(\".navigrid-extensions-remove\").show();\r\n-                $(\"div#item-\" + extension).find(\".navigrid-item-buttonset\").attr(\"enabled\", 1);\r\n-            }\r\n-            else\r\n+    // disable extension\r\n+    $(\".navigrid-extensions-disable\").on(\"click\", function()\r\n+    {\r\n+        var extension = $(this).parent().attr(\"extension\");\r\n+        $.post(\r\n+            NAVIGATE_APP + \"?fid=extensions&act=disable\",\r\n+            { extension: extension },\r\n+            function(data)\r\n             {\r\n-                $(\"div#item-\" + extension).find(\".navigrid-extensions-disable\").show();\r\n-            }\r\n+                $(\"div#item-\" + extension).find(\".navigrid-extensions-enable\").hide();\r\n+                $(\"div#item-\" + extension).find(\".navigrid-extensions-disable\").hide();\r\n+                $(\"div#item-\" + extension).find(\".navigrid-extensions-remove\").hide();\r\n \r\n-            navigate_extensions_refresh();\r\n-        });\r\n-});\r\n+                if(data==\"true\")\r\n+                {\r\n+                    $(\"div#item-\" + extension).find(\".navigrid-extensions-enable\").show();\r\n+                    $(\"div#item-\" + extension).find(\".navigrid-extensions-remove\").show();\r\n+                    $(\"div#item-\" + extension).find(\".navigrid-item-buttonset\").attr(\"enabled\", 1);\r\n+                }\r\n+                else\r\n+                {\r\n+                    $(\"div#item-\" + extension).find(\".navigrid-extensions-disable\").show();\r\n+                }\r\n \r\n-// enable extension\r\n-$(\".navigrid-extensions-enable\").bind(\"click\", function()\r\n-{\r\n-    var extension = $(this).parent().attr(\"extension\");\r\n-    $.post(\r\n-        NAVIGATE_APP + \"?fid=extensions&act=enable\",\r\n-        { extension: extension },\r\n-        function(data)\r\n-        {\r\n-            $(\"div#item-\" + extension).find(\".navigrid-extensions-enable\").hide();\r\n-            $(\"div#item-\" + extension).find(\".navigrid-extensions-disable\").hide();\r\n-            $(\"div#item-\" + extension).find(\".navigrid-extensions-remove\").hide();\r\n+                navigate_extensions_refresh();\r\n+            });\r\n+    });\r\n \r\n-            if(data==\"true\")\r\n-            {\r\n-                $(\"div#item-\" + extension).find(\".navigrid-extensions-disable\").show();\r\n-            }\r\n-            else\r\n+    // enable extension\r\n+    $(\".navigrid-extensions-enable\").on(\"click\", function()\r\n+    {\r\n+        var extension = $(this).parent().attr(\"extension\");\r\n+        $.post(\r\n+            NAVIGATE_APP + \"?fid=extensions&act=enable\",\r\n+            { extension: extension },\r\n+            function(data)\r\n             {\r\n-                $(\"div#item-\" + extension).find(\".navigrid-extensions-enable\").show();\r\n-                $(\"div#item-\" + extension).find(\".navigrid-extensions-remove\").show();\r\n-            }\r\n+                $(\"div#item-\" + extension).find(\".navigrid-extensions-enable\").hide();\r\n+                $(\"div#item-\" + extension).find(\".navigrid-extensions-disable\").hide();\r\n+                $(\"div#item-\" + extension).find(\".navigrid-extensions-remove\").hide();\r\n \r\n-            navigate_extensions_refresh();\r\n-        });\r\n-});\r\n+                if(data==\"true\")\r\n+                {\r\n+                    $(\"div#item-\" + extension).find(\".navigrid-extensions-disable\").show();\r\n+                }\r\n+                else\r\n+                {\r\n+                    $(\"div#item-\" + extension).find(\".navigrid-extensions-enable\").show();\r\n+                    $(\"div#item-\" + extension).find(\".navigrid-extensions-remove\").show();\r\n+                }\r\n \r\n-// add extension as favorite\r\n-$(\".navigrid-extensions-favorite\").bind(\"click\", function()\r\n-{\r\n-    var extension = $(this).parent().attr(\"extension\");\r\n-    var add_as_favorite = ($(this).parent().attr(\"favorite\")==0);\r\n-    var el = this;\r\n-\r\n-    $.post(\r\n-        NAVIGATE_APP + \"?fid=extensions&act=favorite\",\r\n-        { extension: extension,\r\n-            value: (add_as_favorite? 1 : 0)\r\n-        },\r\n-        function(data)\r\n-        {\r\n-            $(el).find(\"img\").removeClass(\"silk-heart_add\");\r\n-            $(el).find(\"img\").removeClass(\"silk-heart_delete\");\r\n+                navigate_extensions_refresh();\r\n+            });\r\n+    });\r\n \r\n-            if(data==\"true\")\r\n+    // add extension as favorite\r\n+    $(\".navigrid-extensions-favorite\").on(\"click\", function()\r\n+    {\r\n+        var extension = $(this).parent().attr(\"extension\");\r\n+        var add_as_favorite = ($(this).parent().attr(\"favorite\")==0);\r\n+        var el = this;\r\n+\r\n+        $.post(\r\n+            NAVIGATE_APP + \"?fid=extensions&act=favorite\",\r\n+            { extension: extension,\r\n+                value: (add_as_favorite? 1 : 0)\r\n+            },\r\n+            function(data)\r\n             {\r\n-                if(add_as_favorite)\r\n+                $(el).find(\"img\").removeClass(\"silk-heart_add\");\r\n+                $(el).find(\"img\").removeClass(\"silk-heart_delete\");\r\n+\r\n+                if(data==\"true\")\r\n                 {\r\n-                    $(el).parent().attr(\"favorite\", 1);\r\n-                    $(el).find(\"img\").addClass(\"silk-heart_delete\");\r\n+                    if(add_as_favorite)\r\n+                    {\r\n+                        $(el).parent().attr(\"favorite\", 1);\r\n+                        $(el).find(\"img\").addClass(\"silk-heart_delete\");\r\n+                    }\r\n+                    else\r\n+                    {\r\n+                        $(el).parent().attr(\"favorite\", 0);\r\n+                        $(el).find(\"img\").addClass(\"silk-heart_add\");\r\n+                    }\r\n                 }\r\n                 else\r\n                 {\r\n-                    $(el).parent().attr(\"favorite\", 0);\r\n-                    $(el).find(\"img\").addClass(\"silk-heart_add\");\r\n+                    // show error\r\n+                    navigate_notification(navigate_lang_dictionary[56]);\r\n                 }\r\n-            }\r\n-            else\r\n-            {\r\n-                // show error\r\n-                navigate_notification(navigate_lang_dictionary[56]);\r\n-            }\r\n-\r\n-            navigate_extensions_refresh();\r\n-        });\r\n-});\r\n-\r\n-$(\".navigrid-extensions-settings\").on(\"click\", function()\r\n-{\r\n-    var extension = $(this).parent().attr(\"extension\");\r\n \r\n-    $(\"#navigrid-extension-options\").attr(\"title\", $(this).parent().attr(\"extension-title\"));\r\n-    //$(\"#navigrid-extension-options\").load(\"?fid=extensions&act=options&extension=\" + extension, function()\r\n-    $(\"#navigrid-extension-options\").html('<iframe width=\"100%\" height=\"100%\" frameborder=\"0\" src=\"?fid=extensions&act=options&extension=' + extension + '\"></iframe>');\r\n+                navigate_extensions_refresh();\r\n+            });\r\n+    });\r\n \r\n-    $(\"#navigrid-extension-options\").dialog(\r\n-    {\r\n-        width: $(window).width() * 0.95,\r\n-        height: $(window).height() * 0.95,\r\n-        modal: true,\r\n-        title: \"<img src=\\\"img/icons/silk/cog.png\\\" align=\\\"absmiddle\\\"> \" + $(\"#navigrid-extension-options\").attr(\"title\")\r\n-    }).dialogExtend(\r\n+    $(\".navigrid-extensions-settings\").on(\"click\", function()\r\n     {\r\n-        maximizable: true\r\n-    });\r\n-});\r\n+        var extension = $(this).parent().attr(\"extension\");\r\n \r\n-$(\".navigrid-extensions-remove\").bind(\"click\", function()\r\n-{\r\n-    var extension = $(this).parent().attr(\"extension\");\r\n+        $(\"#navigrid-extension-options\").attr(\"title\", $(this).parent().attr(\"extension-title\"));\r\n+        //$(\"#navigrid-extension-options\").load(\"?fid=extensions&act=options&extension=\" + extension, function()\r\n+        $(\"#navigrid-extension-options\").html('<iframe width=\"100%\" height=\"100%\" frameborder=\"0\" src=\"?fid=extensions&act=options&extension=' + extension + '\"></iframe>');\r\n \r\n-    $(\"#navigrid-extensions-remove-confirmation\").dialog(\r\n+        $(\"#navigrid-extension-options\").dialog(\r\n         {\r\n-            resizable: true,\r\n-            width: 300,\r\n-            height: 150,\r\n+            width: $(window).width() * 0.95,\r\n+            height: $(window).height() * 0.95,\r\n             modal: true,\r\n-            buttons:\r\n-                [\r\n-                    {\r\n-                        text: navigate_lang_dictionary[190],\r\n-                        click: function()\r\n+            title: \"<img src=\\\"img/icons/silk/cog.png\\\" align=\\\"absmiddle\\\"> \" + $(\"#navigrid-extension-options\").attr(\"title\")\r\n+        }).dialogExtend(\r\n+        {\r\n+            maximizable: true\r\n+        });\r\n+    });\r\n+\r\n+    $(\".navigrid-extensions-remove\").bind(\"click\", function()\r\n+    {\r\n+        var extension = $(this).parent().attr(\"extension\");\r\n+\r\n+        $(\"#navigrid-extensions-remove-confirmation\").dialog(\r\n+            {\r\n+                resizable: true,\r\n+                width: 300,\r\n+                height: 150,\r\n+                modal: true,\r\n+                buttons:\r\n+                    [\r\n                         {\r\n-                            $.post(\r\n-                                NAVIGATE_APP + \"?fid=extensions&act=remove&extension=\" + extension,\r\n-                                { },\r\n-                                function(data)\r\n-                                {\r\n-                                    if(data==\"true\")\r\n-                                    {\r\n-                                        $(\"#item-\" + extension).fadeOut(\"slow\", function(){ $(\"#item-\" + extension).remove(); });\r\n-                                    }\r\n-                                    else\r\n+                            text: navigate_lang_dictionary[190],\r\n+                            click: function()\r\n+                            {\r\n+                                $.post(\r\n+                                    NAVIGATE_APP + \"?fid=extensions&act=remove&extension=\" + extension,\r\n+                                    { },\r\n+                                    function(data)\r\n                                     {\r\n-                                        navigate_notification(navigate_lang_dictionary[56]);\r\n+                                        if(data==\"true\")\r\n+                                        {\r\n+                                            $(\"#item-\" + extension).fadeOut(\"slow\", function(){ $(\"#item-\" + extension).remove(); });\r\n+                                        }\r\n+                                        else\r\n+                                        {\r\n+                                            navigate_notification(navigate_lang_dictionary[56]);\r\n+                                        }\r\n                                     }\r\n-                                }\r\n-                            );\r\n-                            $( this ).dialog( \"close\" );\r\n-                        }\r\n-                    },\r\n-                    {\r\n-                        text: navigate_lang_dictionary[58],\r\n-                        click: function()\r\n+                                );\r\n+                                $( this ).dialog( \"close\" );\r\n+                            }\r\n+                        },\r\n                         {\r\n-                            $( this ).dialog( \"close\" );\r\n+                            text: navigate_lang_dictionary[58],\r\n+                            click: function()\r\n+                            {\r\n+                                $( this ).dialog( \"close\" );\r\n+                            }\r\n                         }\r\n-                    }\r\n-                ]\r\n-        });\r\n-    return false;\r\n-});\r\n+                    ]\r\n+            });\r\n+        return false;\r\n+    });\r\n \r\n-$(\".navigrid-extensions-update\").on(\"click\", function()\r\n-{\r\n-    var extension = $(this).parent().attr(\"extension\");\r\n+    $(\".navigrid-extensions-update\").on(\"click\", function()\r\n+    {\r\n+        var extension = $(this).parent().attr(\"extension\");\r\n+\r\n+        $(\"#navigrid-extensions-update\").dialog(\r\n+            {\r\n+                resizable: false,\r\n+                width: 980,\r\n+                height: 650,\r\n+                modal: true\r\n+            }\r\n+        );\r\n+\r\n+        $(\"#navigrid-extensions-update\").find('iframe').\r\n+            css({\r\n+                \"width\": \"960\",\r\n+                \"height\": 600\r\n+            }).\r\n+            attr('src', 'http://www.navigatecms.com/en/marketplace/purchase?extension='+extension+'&get_update')\r\n+\r\n+        return false;\r\n+    });\r\n+\r\n+    $(\".navigrid-item-buttonset\").each(function(i, el)\r\n+    {\r\n+        $(el).hide().css(\"visibility\", \"visible\");\r\n+        $(el).fadeIn();\r\n+        $(\".navigrid-extensions-disable\").addClass(\"ui-corner-right\");\r\n+    });\r\n+\r\n+    $(\"#extension-upload-button\").on(\"click\", function()\r\n+    {\r\n+        $(\"#extension-upload-button\").parent().find(\"form\").remove();\r\n+        $(\"#extension-upload-button\").after('<form action=\"?fid=extensions&act=extension_upload\" enctype=\"multipart/form-data\" method=\"post\"></form>');\r\n+        $(\"#extension-upload-button\").next().append('<input type=\"hidden\" id=\"_nv_csrf_token\" name=\"_nv_csrf_token\" value=\"'+navigatecms.csrf_token+'\" />');\r\n+        $(\"#extension-upload-button\").next().append('<input type=\"file\" name=\"extension-upload\" style=\" display: none;\" />');\r\n \r\n-    $(\"#navigrid-extensions-update\").dialog(\r\n+        $(\"#extension-upload-button\").next().find(\"input\").on(\"change\", function()\r\n         {\r\n-            resizable: false,\r\n-            width: 980,\r\n-            height: 650,\r\n-            modal: true\r\n-        }\r\n-    );\r\n+            if($(this).val()!=\"\")\r\n+            {\r\n+                $(this).parent().submit();\r\n+            }\r\n+        });\r\n+        $(\"#extension-upload-button\").next().find(\"input\").trigger(\"click\");\r\n \r\n-    $(\"#navigrid-extensions-update\").find('iframe').\r\n-        css({\r\n-            \"width\": \"960\",\r\n-            \"height\": 600\r\n-        }).\r\n-        attr('src', 'http://www.navigatecms.com/en/marketplace/purchase?extension='+extension+'&get_update')\r\n+        return false;\r\n+    });\r\n+}\r\n+\r\n+function navitable_quicksearch(value)\r\n+{\r\n+    $(\".navigrid-item\").hide();\r\n \r\n-    return false;\r\n-});\r\n+    if(value==\"\")\r\n+        $(\".navigrid-item\").show();\r\n+    else\r\n+    {\r\n+        $(\".navigrid-item\").each(function(i, el)\r\n+        {\r\n+            var item_text = $(el).text().toLowerCase();\r\n+            if( item_text.indexOf(value.toLowerCase()) >= 0 )\r\n+                $(el).fadeIn();\r\n+        });\r\n+    }\r\n+}\r\n \r\n function navigate_extensions_refresh()\r\n {\r"
        },
        {
          "filename": "lib/packages/extensions/extensions.php",
          "status": "modified",
          "additions": 47,
          "deletions": 69,
          "patch": "@@ -158,40 +158,51 @@ function run()\n             if(!empty($url) && $user->permission(\"extensions.install\")==\"true\")\r\n             {\r\n                 $error = false;\r\n+                $tmp_file = NULL;\r\n+\r\n                 parse_str(parse_url($url, PHP_URL_QUERY), $query);\r\n \r\n-                $tmp_file = sys_get_temp_dir().DIRECTORY_SEPARATOR.$query['code'].'.zip';\r\n-                @core_file_curl($url, $tmp_file);\r\n-                if(@filesize($tmp_file) == 0)\r\n+                if(parse_url($url, PHP_URL_HOST) == 'www.navigatecms.com')\r\n                 {\r\n-                    @unlink($tmp_file);\r\n-                    // core file curl failed, try using file_get_contents...\r\n-                    $tmp = @file_get_contents($url);\r\n-                    if(!empty($tmp))\r\n-                    {\r\n-                        @file_put_contents($tmp_file, $tmp);\r\n-                    }\r\n-                    unset($tmp);\r\n+                    $tmp_file = sys_get_temp_dir().DIRECTORY_SEPARATOR.$query['code'].'.zip';\r\n+                    @core_file_curl($url, $tmp_file);\r\n                 }\r\n \r\n-                if(@filesize($tmp_file) > 0)\r\n+                if(!empty($tmp_file) && @filesize($tmp_file) > 0)\r\n                 {\r\n-                    // uncompress ZIP and copy it to the extensions dir\r\n-                    @mkdir(NAVIGATE_PATH.'/plugins/'.$query['code']);\r\n+                    $secure = extension::check_upload(\r\n+                        array(\r\n+                            'type' => mime_content_type($tmp_file),\r\n+                            'name' => $query['code'].'.zip',\r\n+                            'tmp_name' => $tmp_file\r\n+                        ),\r\n+                        $query['code']\r\n+                    );\r\n \r\n-                    $zip = new ZipArchive();\r\n-                    $zip_open_status = $zip->open($tmp_file);\r\n-                    if($zip_open_status === TRUE)\r\n+                    if($secure !== true)\r\n                     {\r\n-                        $zip->extractTo(NAVIGATE_PATH.'/plugins/'.$query['code']);\r\n-                        $zip->close();\r\n-\r\n-                        $layout->navigate_notification(t(374, \"Item installed successfully.\"), false);\r\n+                        $layout->navigate_notification(t(344, 'Security error'), true, true);\r\n+                        $error = true;\r\n                     }\r\n-                    else // zip extraction failed\r\n+                    else // everything seems fine, go ahead\r\n                     {\r\n-                        $layout->navigate_notification('ERROR '.$zip_open_status, true, true);\r\n-                        $error = true;\r\n+                        // uncompress ZIP and copy it to the extensions dir\r\n+                        @mkdir(NAVIGATE_PATH.'/plugins/'.$query['code']);\r\n+\r\n+                        $zip = new ZipArchive();\r\n+                        $zip_open_status = $zip->open($tmp_file);\r\n+                        if($zip_open_status === TRUE)\r\n+                        {\r\n+                            $zip->extractTo(NAVIGATE_PATH.'/plugins/'.$query['code']);\r\n+                            $zip->close();\r\n+\r\n+                            $layout->navigate_notification(t(374, \"Item installed successfully.\"), false);\r\n+                        }\r\n+                        else // zip extraction failed\r\n+                        {\r\n+                            $layout->navigate_notification('ERROR '.$zip_open_status, true, true);\r\n+                            $error = true;\r\n+                        }\r\n                     }\r\n                 }\r\n                 else\r\n@@ -213,13 +224,21 @@ function run()\n                     $layout->add_script('\r\n                         $(\"#navigate_marketplace_install_from_hash_error\").dialog({\r\n                             modal: true,\r\n-                            title: \"'.t(56, \"Unexpected error\").'\"\r\n+                            title: \"'.t(56, \"Unexpected error\").'\",\r\n+                            close: function()\r\n+                            {\r\n+                                window.location.replace(\"?fid=extensions\");\r\n+                            }\r\n                         });\r\n                     ');\r\n                 }\r\n-\r\n+                else\r\n+                {\r\n+                    // redirect to extensions grid\r\n+                    core_terminate('?fid=extensions');\r\n+                }\r\n             }\r\n-        // don't break, we want to show the themes grid right now (theme_upload by browser upload won't trigger)\r\n+            break;\r\n \r\n         case 'extension_upload':\r\n             if(!naviforms::check_csrf_token())\r\n@@ -393,51 +412,10 @@ class=\"ui-corner-all\"\n                 url: \"lib/packages/extensions/extensions.js?r='.$current_version->revision.'\",\r\n                 complete: function()\r\n                 {                   \r\n+                    navigate_extensions_init();\r\n                     navigate_extensions_refresh();\r\n                 }\r\n             });\r\n-\r\n-            $(window).on(\"load\", function()\r\n-            {\r\n-                $(\".navigrid-item-buttonset\").each(function(i, el)\r\n-                {\r\n-                    $(el).hide().css(\"visibility\", \"visible\");\r\n-                    $(el).fadeIn();\r\n-                    $(\".navigrid-extensions-disable\").addClass(\"ui-corner-right\");\r\n-                });\r\n-            });\r\n-\r\n-            function navitable_quicksearch(value)\r\n-            {\r\n-                $(\".navigrid-item\").hide();\r\n-\r\n-                if(value==\"\")\r\n-                    $(\".navigrid-item\").show();\r\n-                else\r\n-                {\r\n-                    $(\".navigrid-item\").each(function(i, el)\r\n-                    {\r\n-                        var item_text = $(el).text().toLowerCase();\r\n-                        if( item_text.indexOf(value.toLowerCase()) >= 0 )\r\n-                            $(el).fadeIn();\r\n-                    });\r\n-                }\r\n-            }\r\n-            \r\n-            $(\"#extension-upload-button\").on(\"click\", function()\r\n-            {\r\n-                $(\"#extension-upload-button\").parent().find(\"form\").remove();\r\n-                $(\"#extension-upload-button\").after(\\'<form action=\"?fid=extensions&act=extension_upload\" enctype=\"multipart/form-data\" method=\"post\"><input type=\"file\" name=\"extension-upload\" style=\" display: none;\" /><input type=\"hidden\" id=\"_nv_csrf_token\" name=\"_nv_csrf_token\" value=\"\\'+navigatecms.csrf_token+\\'\" /></form>\\');\r\n-                $(\"#extension-upload-button\").next().find(\"input\").on(\"change\", function()\r\n-                {\r\n-                    if($(this).val()!=\"\")\r\n-                        $(this).parent().submit();\r\n-                });\r\n-                $(\"#extension-upload-button\").next().find(\"input\").trigger(\"click\");\r\n-\r\n-                return false;\r\n-            });\r\n-\r\n         ');\r\n     }\r\n     else\r"
        },
        {
          "filename": "lib/packages/themes/theme.class.php",
          "status": "modified",
          "additions": 6,
          "deletions": 2,
          "patch": "@@ -552,7 +552,7 @@ public static function check_upload($file_upload, $theme_name)\n         }\r\n \r\n         // check every php file included\r\n-        $files = core_recursive_file_search($tempdir,  '/.*\\/*.php/');\r\n+        $files = core_recursive_file_search($tempdir,  '/.*\\/*.(php|phtml)/');\r\n \r\n         $prohibited_functions = array(\r\n             'eval(',\r\n@@ -567,8 +567,12 @@ public static function check_upload($file_upload, $theme_name)\n \r\n         foreach($files as $file)\r\n         {\r\n-            // remove all spaces\r\n+            if(!file_exists($file))\r\n+            {\r\n+                continue;\r\n+            }\r\n             $file_content = file_get_contents($file);\r\n+            // remove all spaces\r\n             $file_content = str_replace(array(' ', \"\\t\", \"\\r\", \"\\n\"), '', $file_content);\r\n \r\n             foreach($prohibited_functions as $pf)\r"
        },
        {
          "filename": "lib/packages/themes/themes.js",
          "status": "modified",
          "additions": 4,
          "deletions": 1,
          "patch": "@@ -110,12 +110,15 @@ function navigate_themes_init()\n         e.stopPropagation();\r\n         e.preventDefault();\r\n         $(\"#theme-upload-button\").parent().find(\"form\").remove();\r\n-        $(\"#theme-upload-button\").after('<form action=\"?fid=themes&act=theme_upload\" enctype=\"multipart/form-data\" method=\"post\"><input type=\"file\" name=\"theme-upload\" style=\" display: none;\" /><input type=\"hidden\" id=\"_nv_csrf_token\" name=\"_nv_csrf_token\" value=\"'+navigatecms.csrf_token+'\" /></form>');\r\n+        $(\"#theme-upload-button\").after('<form action=\"?fid=themes&act=theme_upload\" enctype=\"multipart/form-data\" method=\"post\"></form>');\r\n+        $(\"#theme-upload-button\").next().append('<input type=\"hidden\" id=\"_nv_csrf_token\" name=\"_nv_csrf_token\" value=\"'+navigatecms.csrf_token+'\" />');\r\n+        $(\"#theme-upload-button\").next().append('<input type=\"file\" name=\"theme-upload\" style=\" display: none;\" />');\r\n         $(\"#theme-upload-button\").next().find(\"input\").on(\"change\", function()\r\n         {\r\n             if($(this).val()!=\"\")\r\n             {\r\n                 $(this).parent().submit();\r\n+                return false;\r\n             }\r\n         });\r\n         $(\"#theme-upload-button\").next().find(\"input\").trigger(\"click\");\r"
        },
        {
          "filename": "lib/packages/themes/themes.php",
          "status": "modified",
          "additions": 46,
          "deletions": 26,
          "patch": "@@ -114,40 +114,51 @@ function run()\n             if(!empty($url) && $user->permission(\"themes.install\")==\"true\")\r\n             {\r\n                 $error = false;\r\n+                $tmp_file = NULL;\r\n+\r\n                 parse_str(parse_url($url, PHP_URL_QUERY), $query);\r\n \r\n-                $tmp_file = sys_get_temp_dir() . DIRECTORY_SEPARATOR . $query['code'] . '.zip';\r\n-                @core_file_curl($url, $tmp_file);\r\n-                if(@filesize($tmp_file) == 0)\r\n+                if(parse_url($url, PHP_URL_HOST) == 'www.navigatecms.com')\r\n                 {\r\n-                    @unlink($tmp_file);\r\n-                    // core file curl failed, try using file_get_contents...\r\n-                    $tmp = @file_get_contents($url);\r\n-                    if(!empty($tmp))\r\n-                    {\r\n-                        @file_put_contents($tmp_file, $tmp);\r\n-                    }\r\n-                    unset($tmp);\r\n+                    $tmp_file = sys_get_temp_dir().DIRECTORY_SEPARATOR.$query['code'].'.zip';\r\n+                    @core_file_curl($url, $tmp_file);\r\n                 }\r\n \r\n-                if(@filesize($tmp_file) > 0)\r\n+                if(!empty($tmp_file) && @filesize($tmp_file) > 0)\r\n                 {\r\n-                    // uncompress ZIP and copy it to the themes dir\r\n-                    @mkdir(NAVIGATE_PATH.'/themes/'.$query['code']);\r\n+                    $secure = theme::check_upload(\r\n+                        array(\r\n+                            'type' => mime_content_type($tmp_file),\r\n+                            'name' => $query['code'].'.zip',\r\n+                            'tmp_name' => $tmp_file\r\n+                        ),\r\n+                        $query['code']\r\n+                    );\r\n \r\n-                    $zip = new ZipArchive();\r\n-                    $zip_open_status = $zip->open($tmp_file);\r\n-                    if($zip_open_status === TRUE)\r\n+                    if($secure !== true)\r\n                     {\r\n-                        $zip->extractTo(NAVIGATE_PATH.'/themes/'.$query['code']);\r\n-                        $zip->close();\r\n-\r\n-                        $layout->navigate_notification(t(374, \"Item installed successfully.\"), false);\r\n+                        $layout->navigate_notification(t(344, 'Security error'), true, true);\r\n+                        $error = true;\r\n                     }\r\n-                    else // zip extraction failed\r\n+                    else // everything seems fine, go ahead\r\n                     {\r\n-                        $layout->navigate_notification('ERROR '.$zip_open_status, true, true);\r\n-                        $error = true;\r\n+                        // uncompress ZIP and copy it to the themes dir\r\n+                        @mkdir(NAVIGATE_PATH.'/themes/'.$query['code']);\r\n+\r\n+                        $zip = new ZipArchive();\r\n+                        $zip_open_status = $zip->open($tmp_file);\r\n+                        if($zip_open_status === TRUE)\r\n+                        {\r\n+                            $zip->extractTo(NAVIGATE_PATH.'/themes/'.$query['code']);\r\n+                            $zip->close();\r\n+\r\n+                            $layout->navigate_notification(t(374, \"Item installed successfully.\"), false);\r\n+                        }\r\n+                        else // zip extraction failed\r\n+                        {\r\n+                            $layout->navigate_notification('ERROR '.$zip_open_status, true, true);\r\n+                            $error = true;\r\n+                        }\r\n                     }\r\n                 }\r\n                 else\r\n@@ -169,12 +180,21 @@ function run()\n                     $layout->add_script('\r\n                         $(\"#navigate_marketplace_install_from_hash_error\").dialog({\r\n                             modal: true,\r\n-                            title: \"'.t(56, \"Unexpected error\").'\"\r\n+                            title: \"'.t(56, \"Unexpected error\").'\",\r\n+                            close: function()\r\n+                            {\r\n+                                window.location.replace(\"?fid=themes\");\r\n+                            }\r\n                         });\r\n                     ');\r\n                 }\r\n+                else\r\n+                {\r\n+                    // redirect to themes grid\r\n+                    core_terminate('?fid=themes');\r\n+                }\r\n             }\r\n-            // don't break, we want to show the themes grid right now (theme_upload by browser upload won't trigger)\r\n+            break;\r\n \r\n         case 'theme_upload':\r\n             if(!naviforms::check_csrf_token())\r"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 2,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "abbdf661397eb953b29ca7545c08295e086db2a2",
            "date": "2023-05-21T08:48:06Z",
            "author_login": "NavigateCMS"
          },
          {
            "sha": "92ec28b7ea58aa617f338c4b2b20c20a9c678adc",
            "date": "2023-05-21T08:22:43Z",
            "author_login": "NavigateCMS"
          },
          {
            "sha": "e1cf0ee0d1b27213e54913c532f7f6a03d7b2049",
            "date": "2023-05-14T07:24:26Z",
            "author_login": "NavigateCMS"
          },
          {
            "sha": "8674e0b5dc1a918e5075c64fd8b4519b57d8e55b",
            "date": "2023-05-14T07:23:22Z",
            "author_login": "NavigateCMS"
          },
          {
            "sha": "dad8cc80f3b48acae27f656c84618c70daf36ea7",
            "date": "2023-05-14T07:21:12Z",
            "author_login": "NavigateCMS"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 9.8,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
    "cwe_id": "CWE-434",
    "description": "The install_from_hash functionality in Navigate CMS 2.9 does not consider the .phtml extension when examining files within a ZIP archive that may contain PHP code, in check_upload in lib/packages/extensions/extension.class.php and lib/packages/themes/theme.class.php.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2020-06-15T01:15:10.273",
    "last_modified": "2024-11-21T05:02:32.560",
    "fix_date": "2020-06-11T10:20:32Z"
  },
  "references": [
    {
      "url": "https://github.com/NavigateCMS/Navigate-CMS/commit/f1f47126b359d73a2635306ae46d8719c14d240b",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/NavigateCMS/Navigate-CMS/commit/f1f47126b359d73a2635306ae46d8719c14d240b",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:00:47.850575",
    "processing_status": "enhanced"
  },
  "repository_context": {
    "name": "Navigate-CMS",
    "owner": "NavigateCMS",
    "created_at": "2011-10-10T06:39:08Z",
    "updated_at": "2024-03-12T12:36:58Z",
    "pushed_at": "2023-05-21T08:48:10Z",
    "size": 137522,
    "stars": 8,
    "forks": 4,
    "open_issues": 3,
    "watchers": 8,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "PHP": 3154678,
      "JavaScript": 1006156,
      "CSS": 311979,
      "HTML": 147096,
      "Less": 5592,
      "Hack": 232
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "gpl-2.0"
    },
    "collected_at": "2025-01-26T07:37:12.601895"
  }
}