{
  "cve_id": "CVE-2020-15269",
  "github_data": {
    "repository": "spree/spree",
    "fix_commit": "e43643abfe51f54bd9208dd02298b366e9b9a847",
    "related_commits": [
      "e43643abfe51f54bd9208dd02298b366e9b9a847",
      "e43643abfe51f54bd9208dd02298b366e9b9a847"
    ],
    "patch_url": "https://github.com/spree/spree/commit/e43643abfe51f54bd9208dd02298b366e9b9a847.patch",
    "fix_commit_details": {
      "sha": "e43643abfe51f54bd9208dd02298b366e9b9a847",
      "commit_date": "2020-10-12T14:49:04Z",
      "author": {
        "login": "Morantron",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "ensure doorkeeper_token is valid when authenticating requests in v2",
        "length": 67,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 24,
        "additions": 22,
        "deletions": 2
      },
      "files": [
        {
          "filename": "api/app/controllers/spree/api/v2/base_controller.rb",
          "status": "modified",
          "additions": 6,
          "deletions": 1,
          "patch": "@@ -53,7 +53,12 @@ def render_error_payload(error, status = 422)\n         end\n \n         def spree_current_user\n-          @spree_current_user ||= Spree.user_class.find_by(id: doorkeeper_token.resource_owner_id) if doorkeeper_token\n+          return nil unless doorkeeper_token\n+          return @spree_current_user if @spree_current_user\n+\n+          doorkeeper_authorize!\n+\n+          @spree_current_user ||= Spree.user_class.find_by(id: doorkeeper_token.resource_owner_id)\n         end\n \n         def spree_authorize!(action, subject, *args)"
        },
        {
          "filename": "api/lib/spree/api/testing_support/v2/base.rb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -4,7 +4,7 @@\n   let(:headers_order_token) { { 'X-Spree-Order-Token' => order.token } }\n end\n \n-[200, 201, 400, 404, 403, 422].each do |status_code|\n+[200, 201, 400, 401, 404, 403, 422].each do |status_code|\n   shared_examples \"returns #{status_code} HTTP status\" do\n     it \"returns #{status_code}\" do\n       expect(response.status).to eq(status_code)"
        },
        {
          "filename": "api/spec/requests/spree/api/v2/errors_spec.rb",
          "status": "modified",
          "additions": 15,
          "deletions": 0,
          "patch": "@@ -29,4 +29,19 @@\n       expect(json_response['error']).to eq('You are not authorized to access this page.')\n     end\n   end\n+\n+  context 'expired token failure' do\n+    let(:user) { create(:user) }\n+    let(:headers) { headers_bearer }\n+\n+    include_context 'API v2 tokens'\n+\n+    before do\n+      token.expires_in = -1\n+      token.save\n+      get '/api/v2/storefront/account', headers: headers\n+    end\n+\n+    it_behaves_like 'returns 401 HTTP status'\n+  end\n end"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 3,
        "max_directory_depth": 6
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "49fa0dd1e4fc1409b2a93a4fa7b4d9490b5b170c",
            "date": "2025-01-14T19:40:47Z",
            "author_login": "damianlegawiec"
          },
          {
            "sha": "fe5f2179b712c08b8f59ee00d21da9c7ce2e63e9",
            "date": "2025-01-14T16:23:45Z",
            "author_login": "damianlegawiec"
          },
          {
            "sha": "a38e72f377537a90702b0d59d46175be39a653de",
            "date": "2025-01-14T15:46:03Z",
            "author_login": "damianlegawiec"
          },
          {
            "sha": "c979ff84665560981c5ce3135fba57620e3b6be3",
            "date": "2025-01-14T15:08:42Z",
            "author_login": "damianlegawiec"
          },
          {
            "sha": "e2fa4ba84a8e81c625018ab25ad3aaf7065d2aba",
            "date": "2025-01-14T14:32:53Z",
            "author_login": "Vegann"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 7.4,
    "cvss_vector": "CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:N",
    "cwe_id": "CWE-287",
    "description": "In Spree before versions 3.7.11, 4.0.4, or 4.1.11, expired user tokens could be used to access Storefront API v2 endpoints. The issue is patched in versions 3.7.11, 4.0.4 and 4.1.11. A workaround without upgrading is described in the linked advisory.",
    "attack_vector": "NETWORK",
    "attack_complexity": "HIGH"
  },
  "temporal_data": {
    "published_date": "2020-10-20T21:15:12.743",
    "last_modified": "2024-11-21T05:05:14.067",
    "fix_date": "2020-10-12T14:49:04Z"
  },
  "references": [
    {
      "url": "https://github.com/spree/spree/commit/e43643abfe51f54bd9208dd02298b366e9b9a847",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/spree/spree/security/advisories/GHSA-f8cm-364f-q9qh",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/spree/spree/commit/e43643abfe51f54bd9208dd02298b366e9b9a847",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/spree/spree/security/advisories/GHSA-f8cm-364f-q9qh",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:01:06.186318",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "spree",
    "owner": "spree",
    "created_at": "2008-03-10T14:45:35Z",
    "updated_at": "2025-01-14T20:43:38Z",
    "pushed_at": "2025-01-14T19:45:30Z",
    "size": 156575,
    "stars": 13230,
    "forks": 4967,
    "open_issues": 299,
    "watchers": 13230,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [
      "3-0-stable",
      "3-1-stable",
      "3-2-stable",
      "3-3-stable",
      "3-4-stable",
      "3-5-stable",
      "3-6-stable",
      "3-7-stable",
      "4-0-stable",
      "4-1-stable",
      "4-2-stable",
      "4-3-stable",
      "4-4-stable",
      "4-5-stable",
      "4-6-stable",
      "4-7-stable"
    ],
    "languages": {
      "Ruby": 3549072,
      "HTML": 315904,
      "Shell": 3532,
      "JavaScript": 671,
      "SCSS": 20
    },
    "commit_activity": {
      "total_commits_last_year": 525,
      "avg_commits_per_week": 10.096153846153847,
      "days_active_last_year": 154
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T21:03:58.126375"
  }
}