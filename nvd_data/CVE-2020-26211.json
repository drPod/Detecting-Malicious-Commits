{
  "cve_id": "CVE-2020-26211",
  "github_data": {
    "repository": "BookStackApp/BookStack",
    "fix_commit": "bbd1384acbe7e52c21f89af69f2dc391c95dbf54",
    "related_commits": [
      "bbd1384acbe7e52c21f89af69f2dc391c95dbf54",
      "bbd1384acbe7e52c21f89af69f2dc391c95dbf54"
    ],
    "patch_url": "https://github.com/BookStackApp/BookStack/commit/bbd1384acbe7e52c21f89af69f2dc391c95dbf54.patch",
    "fix_commit_details": {
      "sha": "bbd1384acbe7e52c21f89af69f2dc391c95dbf54",
      "commit_date": "2020-10-27T01:34:51Z",
      "author": {
        "login": "PercussiveElbow",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "XSS and redirect fixes with test cases",
        "length": 38,
        "has_description": false,
        "references_issue": true
      },
      "stats": {
        "total": 84,
        "additions": 84,
        "deletions": 0
      },
      "files": [
        {
          "filename": "app/Entities/Managers/PageContent.php",
          "status": "modified",
          "additions": 18,
          "deletions": 0,
          "patch": "@@ -296,6 +296,24 @@ protected function escapeScripts(string $html) : string\n             $scriptElem->parentNode->removeChild($scriptElem);\n         }\n \n+        // Remove clickable links to JavaScript URI\n+        $badLinks = $xPath->query('//*[contains(@href, \\'javascript:\\')]');\n+        foreach ($badLinks as $badLink) {\n+            $badLink->parentNode->removeChild($badLink);\n+        }\n+\n+        // Remove forms with calls to JavaScript URI\n+        $badForms = $xPath->query('//*[contains(@action, \\'javascript:\\')] | //*[contains(@formaction, \\'javascript:\\')]');\n+        foreach ($badForms as $badForm) {\n+            $badForm->parentNode->removeChild($badForm);\n+        }\n+\n+        // Remove meta tag to prevent external redirects\n+        $metaTags = $xPath->query('//meta[contains(@content, \\'url\\')]');\n+        foreach ($metaTags as $metaTag) {\n+            $metaTag->parentNode->removeChild($metaTag);\n+        }\n+\n         // Remove data or JavaScript iFrames\n         $badIframes = $xPath->query('//*[contains(@src, \\'data:\\')] | //*[contains(@src, \\'javascript:\\')] | //*[@srcdoc]');\n         foreach ($badIframes as $badIframe) {"
        },
        {
          "filename": "tests/Entity/PageContentTest.php",
          "status": "modified",
          "additions": 66,
          "deletions": 0,
          "patch": "@@ -159,6 +159,72 @@ public function test_iframe_js_and_base64_urls_are_removed()\n \n     }\n \n+    public function test_javascript_uri_links_are_removed()\n+    {\n+        $checks = [\n+            '<a id=\"xss\" href=\"javascript:alert(document.cookie)>Click me</a>',\n+            '<a id=\"xss\" href=\"javascript: alert(document.cookie)>Click me</a>'\n+        ];\n+\n+        $this->asEditor();\n+        $page = Page::first();\n+\n+        foreach ($checks as $check) {\n+            $page->html = $check;\n+            $page->save();\n+\n+            $pageView = $this->get($page->getUrl());\n+            $pageView->assertStatus(200);\n+            $pageView->assertElementNotContains('.page-content', '<a id=\"xss\">');\n+            $pageView->assertElementNotContains('.page-content', 'href=javascript:');\n+        }\n+    }\n+    public function test_form_actions_with_javascript_are_removed()\n+    {\n+        $checks = [\n+            '<form><input id=\"xss\" type=submit formaction=javascript:alert(document.domain) value=Submit><input></form>',\n+            '<form ><button id=\"xss\" formaction=javascript:alert(document.domain)>Click me</button></form>',\n+            '<form id=\"xss\" action=javascript:alert(document.domain)><input type=submit value=Submit></form>'\n+        ];\n+\n+        $this->asEditor();\n+        $page = Page::first();\n+\n+        foreach ($checks as $check) {\n+            $page->html = $check;\n+            $page->save();\n+\n+            $pageView = $this->get($page->getUrl());\n+            $pageView->assertStatus(200);\n+            $pageView->assertElementNotContains('.page-content', '<button id=\"xss\"');\n+            $pageView->assertElementNotContains('.page-content', '<input id=\"xss\"');\n+            $pageView->assertElementNotContains('.page-content', '<form id=\"xss\"');\n+            $pageView->assertElementNotContains('.page-content', 'action=javascript:');\n+            $pageView->assertElementNotContains('.page-content', 'formaction=javascript:');\n+        }\n+    }\n+    \n+    public function test_metadata_redirects_are_removed()\n+    {\n+        $checks = [\n+            '<meta http-equiv=\"refresh\" content=\"0; url=//external_url\">',\n+        ];\n+\n+        $this->asEditor();\n+        $page = Page::first();\n+\n+        foreach ($checks as $check) {\n+            $page->html = $check;\n+            $page->save();\n+\n+            $pageView = $this->get($page->getUrl());\n+            $pageView->assertStatus(200);\n+            $pageView->assertElementNotContains('.page-content', '<meta>');\n+            $pageView->assertElementNotContains('.page-content', '</meta>');\n+            $pageView->assertElementNotContains('.page-content', 'content=');\n+            $pageView->assertElementNotContains('.page-content', 'external_url');\n+        }\n+    }\n     public function test_page_inline_on_attributes_removed_by_default()\n     {\n         $this->asEditor();"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 2,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "786a434c03faa996e630f4a0a523567d3b093f43",
            "date": "2025-01-14T14:56:43Z",
            "author_login": "ssddanbrown"
          },
          {
            "sha": "25c4f4b02ba06f66f5239de48ae005f895146f8d",
            "date": "2025-01-14T14:53:10Z",
            "author_login": "ssddanbrown"
          },
          {
            "sha": "481580be172a4813ee98ad1b945d12d731e71cdb",
            "date": "2025-01-13T16:51:07Z",
            "author_login": "ssddanbrown"
          },
          {
            "sha": "593645acfe8521db97d7469c92546c8529703969",
            "date": "2025-01-13T14:30:53Z",
            "author_login": "ssddanbrown"
          },
          {
            "sha": "b9751807e7bad4b7d477b6977f630881f730abad",
            "date": "2025-01-13T13:27:32Z",
            "author_login": "ssddanbrown"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 7.7,
    "cvss_vector": "CVSS:3.1/AV:N/AC:H/PR:L/UI:R/S:C/C:H/I:H/A:N",
    "cwe_id": "CWE-79",
    "description": "In BookStack before version 0.30.4, a user with permissions to edit a page could insert JavaScript code through the use of `javascript:` URIs within a link or form which would run, within the context of the current page, when clicked or submitted. Additionally, a user with permissions to edit a page could insert a particular meta tag which could be used to silently redirect users to a alternative location upon visit of a page. Dangerous content may remain in the database but will be removed before being displayed on a page. If you think this could have been exploited the linked advisory provides a SQL query to test. As a workaround without upgrading, page edit permissions could be limited to only those that are trusted until you can upgrade although this will not address existing exploitation of this vulnerability. The issue is fixed in BookStack version 0.30.4.",
    "attack_vector": "NETWORK",
    "attack_complexity": "HIGH"
  },
  "temporal_data": {
    "published_date": "2020-11-03T21:15:12.547",
    "last_modified": "2024-11-21T05:19:32.137",
    "fix_date": "2020-10-27T01:34:51Z"
  },
  "references": [
    {
      "url": "https://github.com/BookStackApp/BookStack/commit/bbd1384acbe7e52c21f89af69f2dc391c95dbf54",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/BookStackApp/BookStack/releases/tag/v0.30.4",
      "source": "security-advisories@github.com",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/BookStackApp/BookStack/security/advisories/GHSA-r2cf-8778-3jgp",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.bookstackapp.com/blog/beta-release-v0-30-4/",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/BookStackApp/BookStack/commit/bbd1384acbe7e52c21f89af69f2dc391c95dbf54",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/BookStackApp/BookStack/releases/tag/v0.30.4",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/BookStackApp/BookStack/security/advisories/GHSA-r2cf-8778-3jgp",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.bookstackapp.com/blog/beta-release-v0-30-4/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:01:08.445946",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "BookStack",
    "owner": "BookStackApp",
    "created_at": "2015-08-29T10:26:44Z",
    "updated_at": "2025-01-14T14:56:47Z",
    "pushed_at": "2025-01-14T14:56:46Z",
    "size": 41179,
    "stars": 15788,
    "forks": 1979,
    "open_issues": 596,
    "watchers": 15788,
    "has_security_policy": false,
    "default_branch": "development",
    "protected_branches": [
      "release"
    ],
    "languages": {
      "PHP": 7967773,
      "TypeScript": 1856418,
      "Blade": 444101,
      "JavaScript": 287858,
      "SCSS": 139395,
      "Dockerfile": 1282,
      "Shell": 347
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-14T15:42:30.929244"
  }
}