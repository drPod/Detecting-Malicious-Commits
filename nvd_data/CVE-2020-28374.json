{
  "cve_id": "CVE-2020-28374",
  "github_data": {
    "repository": "torvalds/linux",
    "fix_commit": "2896c93811e39d63a4d9b63ccf12a8fbc226e5e4",
    "related_commits": [
      "2896c93811e39d63a4d9b63ccf12a8fbc226e5e4",
      "2896c93811e39d63a4d9b63ccf12a8fbc226e5e4"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "2896c93811e39d63a4d9b63ccf12a8fbc226e5e4",
      "commit_date": "2020-11-03T01:21:58Z",
      "author": {
        "login": "ddiss",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "scsi: target: Fix XCOPY NAA identifier lookup",
        "length": 873,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 120,
        "additions": 71,
        "deletions": 49
      },
      "files": [
        {
          "filename": "drivers/target/target_core_xcopy.c",
          "status": "modified",
          "additions": 70,
          "deletions": 49,
          "patch": "@@ -46,60 +46,83 @@ static int target_xcopy_gen_naa_ieee(struct se_device *dev, unsigned char *buf)\n \treturn 0;\n }\n \n-struct xcopy_dev_search_info {\n-\tconst unsigned char *dev_wwn;\n-\tstruct se_device *found_dev;\n-};\n-\n+/**\n+ * target_xcopy_locate_se_dev_e4_iter - compare XCOPY NAA device identifiers\n+ *\n+ * @se_dev: device being considered for match\n+ * @dev_wwn: XCOPY requested NAA dev_wwn\n+ * @return: 1 on match, 0 on no-match\n+ */\n static int target_xcopy_locate_se_dev_e4_iter(struct se_device *se_dev,\n-\t\t\t\t\t      void *data)\n+\t\t\t\t\t      const unsigned char *dev_wwn)\n {\n-\tstruct xcopy_dev_search_info *info = data;\n \tunsigned char tmp_dev_wwn[XCOPY_NAA_IEEE_REGEX_LEN];\n \tint rc;\n \n-\tif (!se_dev->dev_attrib.emulate_3pc)\n+\tif (!se_dev->dev_attrib.emulate_3pc) {\n+\t\tpr_debug(\"XCOPY: emulate_3pc disabled on se_dev %p\\n\", se_dev);\n \t\treturn 0;\n+\t}\n \n \tmemset(&tmp_dev_wwn[0], 0, XCOPY_NAA_IEEE_REGEX_LEN);\n \ttarget_xcopy_gen_naa_ieee(se_dev, &tmp_dev_wwn[0]);\n \n-\trc = memcmp(&tmp_dev_wwn[0], info->dev_wwn, XCOPY_NAA_IEEE_REGEX_LEN);\n-\tif (rc != 0)\n-\t\treturn 0;\n-\n-\tinfo->found_dev = se_dev;\n-\tpr_debug(\"XCOPY 0xe4: located se_dev: %p\\n\", se_dev);\n-\n-\trc = target_depend_item(&se_dev->dev_group.cg_item);\n+\trc = memcmp(&tmp_dev_wwn[0], dev_wwn, XCOPY_NAA_IEEE_REGEX_LEN);\n \tif (rc != 0) {\n-\t\tpr_err(\"configfs_depend_item attempt failed: %d for se_dev: %p\\n\",\n-\t\t       rc, se_dev);\n-\t\treturn rc;\n+\t\tpr_debug(\"XCOPY: skip non-matching: %*ph\\n\",\n+\t\t\t XCOPY_NAA_IEEE_REGEX_LEN, tmp_dev_wwn);\n+\t\treturn 0;\n \t}\n+\tpr_debug(\"XCOPY 0xe4: located se_dev: %p\\n\", se_dev);\n \n-\tpr_debug(\"Called configfs_depend_item for se_dev: %p se_dev->se_dev_group: %p\\n\",\n-\t\t se_dev, &se_dev->dev_group);\n \treturn 1;\n }\n \n-static int target_xcopy_locate_se_dev_e4(const unsigned char *dev_wwn,\n-\t\t\t\t\tstruct se_device **found_dev)\n+static int target_xcopy_locate_se_dev_e4(struct se_session *sess,\n+\t\t\t\t\tconst unsigned char *dev_wwn,\n+\t\t\t\t\tstruct se_device **_found_dev,\n+\t\t\t\t\tstruct percpu_ref **_found_lun_ref)\n {\n-\tstruct xcopy_dev_search_info info;\n-\tint ret;\n-\n-\tmemset(&info, 0, sizeof(info));\n-\tinfo.dev_wwn = dev_wwn;\n-\n-\tret = target_for_each_device(target_xcopy_locate_se_dev_e4_iter, &info);\n-\tif (ret == 1) {\n-\t\t*found_dev = info.found_dev;\n-\t\treturn 0;\n-\t} else {\n-\t\tpr_debug_ratelimited(\"Unable to locate 0xe4 descriptor for EXTENDED_COPY\\n\");\n-\t\treturn -EINVAL;\n+\tstruct se_dev_entry *deve;\n+\tstruct se_node_acl *nacl;\n+\tstruct se_lun *this_lun = NULL;\n+\tstruct se_device *found_dev = NULL;\n+\n+\t/* cmd with NULL sess indicates no associated $FABRIC_MOD */\n+\tif (!sess)\n+\t\tgoto err_out;\n+\n+\tpr_debug(\"XCOPY 0xe4: searching for: %*ph\\n\",\n+\t\t XCOPY_NAA_IEEE_REGEX_LEN, dev_wwn);\n+\n+\tnacl = sess->se_node_acl;\n+\trcu_read_lock();\n+\thlist_for_each_entry_rcu(deve, &nacl->lun_entry_hlist, link) {\n+\t\tstruct se_device *this_dev;\n+\t\tint rc;\n+\n+\t\tthis_lun = rcu_dereference(deve->se_lun);\n+\t\tthis_dev = rcu_dereference_raw(this_lun->lun_se_dev);\n+\n+\t\trc = target_xcopy_locate_se_dev_e4_iter(this_dev, dev_wwn);\n+\t\tif (rc) {\n+\t\t\tif (percpu_ref_tryget_live(&this_lun->lun_ref))\n+\t\t\t\tfound_dev = this_dev;\n+\t\t\tbreak;\n+\t\t}\n \t}\n+\trcu_read_unlock();\n+\tif (found_dev == NULL)\n+\t\tgoto err_out;\n+\n+\tpr_debug(\"lun_ref held for se_dev: %p se_dev->se_dev_group: %p\\n\",\n+\t\t found_dev, &found_dev->dev_group);\n+\t*_found_dev = found_dev;\n+\t*_found_lun_ref = &this_lun->lun_ref;\n+\treturn 0;\n+err_out:\n+\tpr_debug_ratelimited(\"Unable to locate 0xe4 descriptor for EXTENDED_COPY\\n\");\n+\treturn -EINVAL;\n }\n \n static int target_xcopy_parse_tiddesc_e4(struct se_cmd *se_cmd, struct xcopy_op *xop,\n@@ -246,12 +269,16 @@ static int target_xcopy_parse_target_descriptors(struct se_cmd *se_cmd,\n \n \tswitch (xop->op_origin) {\n \tcase XCOL_SOURCE_RECV_OP:\n-\t\trc = target_xcopy_locate_se_dev_e4(xop->dst_tid_wwn,\n-\t\t\t\t\t\t&xop->dst_dev);\n+\t\trc = target_xcopy_locate_se_dev_e4(se_cmd->se_sess,\n+\t\t\t\t\t\txop->dst_tid_wwn,\n+\t\t\t\t\t\t&xop->dst_dev,\n+\t\t\t\t\t\t&xop->remote_lun_ref);\n \t\tbreak;\n \tcase XCOL_DEST_RECV_OP:\n-\t\trc = target_xcopy_locate_se_dev_e4(xop->src_tid_wwn,\n-\t\t\t\t\t\t&xop->src_dev);\n+\t\trc = target_xcopy_locate_se_dev_e4(se_cmd->se_sess,\n+\t\t\t\t\t\txop->src_tid_wwn,\n+\t\t\t\t\t\t&xop->src_dev,\n+\t\t\t\t\t\t&xop->remote_lun_ref);\n \t\tbreak;\n \tdefault:\n \t\tpr_err(\"XCOPY CSCD descriptor IDs not found in CSCD list - \"\n@@ -391,18 +418,12 @@ static int xcopy_pt_get_cmd_state(struct se_cmd *se_cmd)\n \n static void xcopy_pt_undepend_remotedev(struct xcopy_op *xop)\n {\n-\tstruct se_device *remote_dev;\n-\n \tif (xop->op_origin == XCOL_SOURCE_RECV_OP)\n-\t\tremote_dev = xop->dst_dev;\n+\t\tpr_debug(\"putting dst lun_ref for %p\\n\", xop->dst_dev);\n \telse\n-\t\tremote_dev = xop->src_dev;\n-\n-\tpr_debug(\"Calling configfs_undepend_item for\"\n-\t\t  \" remote_dev: %p remote_dev->dev_group: %p\\n\",\n-\t\t  remote_dev, &remote_dev->dev_group.cg_item);\n+\t\tpr_debug(\"putting src lun_ref for %p\\n\", xop->src_dev);\n \n-\ttarget_undepend_item(&remote_dev->dev_group.cg_item);\n+\tpercpu_ref_put(xop->remote_lun_ref);\n }\n \n static void xcopy_pt_release_cmd(struct se_cmd *se_cmd)"
        },
        {
          "filename": "drivers/target/target_core_xcopy.h",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -27,6 +27,7 @@ struct xcopy_op {\n \tstruct se_device *dst_dev;\n \tunsigned char dst_tid_wwn[XCOPY_NAA_IEEE_REGEX_LEN];\n \tunsigned char local_dev_wwn[XCOPY_NAA_IEEE_REGEX_LEN];\n+\tstruct percpu_ref *remote_lun_ref;\n \n \tsector_t src_lba;\n \tsector_t dst_lba;"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 1,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "aa22f4da2a46b484a257d167c67a2adc1b7aaf68",
            "date": "2025-01-26T00:23:38Z",
            "author_login": "torvalds"
          },
          {
            "sha": "eda061cccd146fcbe71051bb4aa5a8672b71216e",
            "date": "2025-01-26T00:19:10Z",
            "author_login": "torvalds"
          },
          {
            "sha": "08de7f9d4d39fd9aa5e747a13acc891214fa2d5f",
            "date": "2025-01-26T00:12:07Z",
            "author_login": "torvalds"
          },
          {
            "sha": "647d69605c70368d54fc012fce8a43e8e5955b04",
            "date": "2025-01-26T00:03:40Z",
            "author_login": "torvalds"
          },
          {
            "sha": "184a0997fb77f4a9527fc867fcd16806776c27ce",
            "date": "2025-01-25T23:59:46Z",
            "author_login": "torvalds"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 8.1,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:N",
    "cwe_id": "CWE-22",
    "description": "In drivers/target/target_core_xcopy.c in the Linux kernel before 5.10.7, insufficient identifier checking in the LIO SCSI target code can be used by remote attackers to read or write files via directory traversal in an XCOPY request, aka CID-2896c93811e3. For example, an attack can occur over a network if the attacker has access to one iSCSI LUN. The attacker gains control over file access because I/O operations are proxied via an attacker-selected backstore.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2021-01-13T04:15:12.837",
    "last_modified": "2024-11-21T05:22:41.040",
    "fix_date": "2020-11-03T01:21:58Z"
  },
  "references": [
    {
      "url": "http://packetstormsecurity.com/files/161229/Kernel-Live-Patch-Security-Notice-LSN-0074-1.html",
      "source": "cve@mitre.org",
      "tags": [
        "Third Party Advisory",
        "VDB Entry"
      ]
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2021/01/13/2",
      "source": "cve@mitre.org",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2021/01/13/5",
      "source": "cve@mitre.org",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://bugzilla.suse.com/attachment.cgi?id=844938",
      "source": "cve@mitre.org",
      "tags": [
        "Issue Tracking",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://bugzilla.suse.com/show_bug.cgi?id=1178372",
      "source": "cve@mitre.org",
      "tags": [
        "Issue Tracking",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://cdn.kernel.org/pub/linux/kernel/v5.x/ChangeLog-5.10.7",
      "source": "cve@mitre.org",
      "tags": [
        "Release Notes",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=2896c93811e39d63a4d9b63ccf12a8fbc226e5e4",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/torvalds/linux/commit/2896c93811e39d63a4d9b63ccf12a8fbc226e5e4",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2021/02/msg00018.html",
      "source": "cve@mitre.org",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2021/03/msg00010.html",
      "source": "cve@mitre.org",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/FZEUPID5DZYLZBIO4BEVLHFUDZZIFL57/",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/HK7SRTITN5ABAUOOIGFVR7XE5YKYYAVO/",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/LTGQDYIEO2GOCOOKADBHEITF44GY55QF/",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "https://security.netapp.com/advisory/ntap-20210219-0002/",
      "source": "cve@mitre.org",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.debian.org/security/2021/dsa-4843",
      "source": "cve@mitre.org",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://packetstormsecurity.com/files/161229/Kernel-Live-Patch-Security-Notice-LSN-0074-1.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory",
        "VDB Entry"
      ]
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2021/01/13/2",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2021/01/13/5",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://bugzilla.suse.com/attachment.cgi?id=844938",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Issue Tracking",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://bugzilla.suse.com/show_bug.cgi?id=1178372",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Issue Tracking",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://cdn.kernel.org/pub/linux/kernel/v5.x/ChangeLog-5.10.7",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=2896c93811e39d63a4d9b63ccf12a8fbc226e5e4",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/torvalds/linux/commit/2896c93811e39d63a4d9b63ccf12a8fbc226e5e4",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2021/02/msg00018.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2021/03/msg00010.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/FZEUPID5DZYLZBIO4BEVLHFUDZZIFL57/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/HK7SRTITN5ABAUOOIGFVR7XE5YKYYAVO/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/LTGQDYIEO2GOCOOKADBHEITF44GY55QF/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://security.netapp.com/advisory/ntap-20210219-0002/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.debian.org/security/2021/dsa-4843",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:01:13.144857",
    "processing_status": "enhanced"
  },
  "repository_context": {
    "name": "linux",
    "owner": "torvalds",
    "created_at": "2011-09-04T22:48:12Z",
    "updated_at": "2025-01-14T12:39:03Z",
    "pushed_at": "2025-01-13T17:27:04Z",
    "size": 5361369,
    "stars": 185823,
    "forks": 54743,
    "open_issues": 437,
    "watchers": 185823,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "C": 1326937103,
      "Assembly": 9568292,
      "Shell": 5072004,
      "Python": 2974128,
      "Makefile": 2713905,
      "Perl": 1253637,
      "Rust": 807711,
      "Roff": 202277,
      "C++": 173382,
      "SmPL": 165946,
      "Yacc": 127472,
      "Lex": 71321,
      "Awk": 69539,
      "Jinja": 30138,
      "UnrealScript": 16848,
      "Gherkin": 10172,
      "M4": 3329,
      "MATLAB": 2482,
      "sed": 2433,
      "Clojure": 2411,
      "XS": 1239,
      "RPC": 962
    },
    "commit_activity": {
      "total_commits_last_year": 46007,
      "avg_commits_per_week": 884.75,
      "days_active_last_year": 359
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T12:53:59.486675"
  }
}