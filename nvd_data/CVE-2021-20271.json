{
  "cve_id": "CVE-2021-20271",
  "github_data": {
    "repository": "rpm-software-management/rpm",
    "fix_commit": "d6a86b5e69e46cc283b1e06c92343319beb42e21",
    "related_commits": [
      "d6a86b5e69e46cc283b1e06c92343319beb42e21",
      "d6a86b5e69e46cc283b1e06c92343319beb42e21"
    ],
    "patch_url": "https://github.com/rpm-software-management/rpm/commit/d6a86b5e69e46cc283b1e06c92343319beb42e21.patch",
    "fix_commit_details": {
      "sha": "d6a86b5e69e46cc283b1e06c92343319beb42e21",
      "commit_date": "2021-03-04T11:21:19Z",
      "author": {
        "login": "pmatilai",
        "type": "User",
        "stats": {
          "total_commits": 8074,
          "average_weekly_commits": 8.74756229685807,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 671
        }
      },
      "commit_message": {
        "title": "Be much more careful about copying data from the signature header",
        "length": 654,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 114,
        "additions": 51,
        "deletions": 63
      },
      "files": [
        {
          "filename": "lib/package.c",
          "status": "modified",
          "additions": 51,
          "deletions": 63,
          "patch": "@@ -31,84 +31,71 @@ struct pkgdata_s {\n     rpmRC rc;\n };\n \n+struct taglate_s {\n+    rpmTagVal stag;\n+    rpmTagVal xtag;\n+    rpm_count_t count;\n+} const xlateTags[] = {\n+    { RPMSIGTAG_SIZE, RPMTAG_SIGSIZE, 1 },\n+    { RPMSIGTAG_PGP, RPMTAG_SIGPGP, 0 },\n+    { RPMSIGTAG_MD5, RPMTAG_SIGMD5, 16 },\n+    { RPMSIGTAG_GPG, RPMTAG_SIGGPG, 0 },\n+    /* { RPMSIGTAG_PGP5, RPMTAG_SIGPGP5, 0 }, */ /* long obsolete, dont use */\n+    { RPMSIGTAG_PAYLOADSIZE, RPMTAG_ARCHIVESIZE, 1 },\n+    { RPMSIGTAG_FILESIGNATURES, RPMTAG_FILESIGNATURES, 0 },\n+    { RPMSIGTAG_FILESIGNATURELENGTH, RPMTAG_FILESIGNATURELENGTH, 1 },\n+    { RPMSIGTAG_VERITYSIGNATURES, RPMTAG_VERITYSIGNATURES, 0 },\n+    { RPMSIGTAG_VERITYSIGNATUREALGO, RPMTAG_VERITYSIGNATUREALGO, 1 },\n+    { RPMSIGTAG_SHA1, RPMTAG_SHA1HEADER, 1 },\n+    { RPMSIGTAG_SHA256, RPMTAG_SHA256HEADER, 1 },\n+    { RPMSIGTAG_DSA, RPMTAG_DSAHEADER, 0 },\n+    { RPMSIGTAG_RSA, RPMTAG_RSAHEADER, 0 },\n+    { RPMSIGTAG_LONGSIZE, RPMTAG_LONGSIGSIZE, 1 },\n+    { RPMSIGTAG_LONGARCHIVESIZE, RPMTAG_LONGARCHIVESIZE, 1 },\n+    { 0 }\n+};\n+\n /** \\ingroup header\n  * Translate and merge legacy signature tags into header.\n  * @param h\t\theader (dest)\n  * @param sigh\t\tsignature header (src)\n+ * @return\t\tfailing tag number, 0 on success\n  */\n static\n-void headerMergeLegacySigs(Header h, Header sigh)\n+rpmTagVal headerMergeLegacySigs(Header h, Header sigh, char **msg)\n {\n-    HeaderIterator hi;\n+    const struct taglate_s *xl;\n     struct rpmtd_s td;\n \n-    hi = headerInitIterator(sigh);\n-    for (; headerNext(hi, &td); rpmtdFreeData(&td))\n-    {\n-\tswitch (td.tag) {\n-\t/* XXX Translate legacy signature tag values. */\n-\tcase RPMSIGTAG_SIZE:\n-\t    td.tag = RPMTAG_SIGSIZE;\n-\t    break;\n-\tcase RPMSIGTAG_PGP:\n-\t    td.tag = RPMTAG_SIGPGP;\n-\t    break;\n-\tcase RPMSIGTAG_MD5:\n-\t    td.tag = RPMTAG_SIGMD5;\n-\t    break;\n-\tcase RPMSIGTAG_GPG:\n-\t    td.tag = RPMTAG_SIGGPG;\n-\t    break;\n-\tcase RPMSIGTAG_PGP5:\n-\t    td.tag = RPMTAG_SIGPGP5;\n-\t    break;\n-\tcase RPMSIGTAG_PAYLOADSIZE:\n-\t    td.tag = RPMTAG_ARCHIVESIZE;\n-\t    break;\n-\tcase RPMSIGTAG_FILESIGNATURES:\n-\t    td.tag = RPMTAG_FILESIGNATURES;\n+    rpmtdReset(&td);\n+    for (xl = xlateTags; xl->stag; xl++) {\n+\t/* There mustn't be one in the main header */\n+\tif (headerIsEntry(h, xl->xtag))\n \t    break;\n-\tcase RPMSIGTAG_FILESIGNATURELENGTH:\n-\t    td.tag = RPMTAG_FILESIGNATURELENGTH;\n-\t    break;\n-\tcase RPMSIGTAG_VERITYSIGNATURES:\n-\tcase RPMSIGTAG_VERITYSIGNATUREALGO:\n-\tcase RPMSIGTAG_SHA1:\n-\tcase RPMSIGTAG_SHA256:\n-\tcase RPMSIGTAG_DSA:\n-\tcase RPMSIGTAG_RSA:\n-\tdefault:\n-\t    if (!(td.tag >= HEADER_SIGBASE && td.tag < HEADER_TAGBASE))\n-\t\tcontinue;\n-\t    break;\n-\t}\n-\tif (!headerIsEntry(h, td.tag)) {\n-\t    switch (td.type) {\n-\t    case RPM_NULL_TYPE:\n-\t\tcontinue;\n+\tif (headerGet(sigh, xl->stag, &td, HEADERGET_RAW|HEADERGET_MINMEM)) {\n+\t    /* Translate legacy tags */\n+\t    if (xl->stag != xl->xtag)\n+\t\ttd.tag = xl->xtag;\n+\t    /* Ensure type and tag size match expectations */\n+\t    if (td.type != rpmTagGetTagType(td.tag))\n \t\tbreak;\n-\t    case RPM_CHAR_TYPE:\n-\t    case RPM_INT8_TYPE:\n-\t    case RPM_INT16_TYPE:\n-\t    case RPM_INT32_TYPE:\n-\t    case RPM_INT64_TYPE:\n-\t\tif (td.count != 1)\n-\t\t    continue;\n+\t    if (td.count < 1 || td.count > 16*1024*1024)\n \t\tbreak;\n-\t    case RPM_STRING_TYPE:\n-\t    case RPM_STRING_ARRAY_TYPE:\n-\t    case RPM_BIN_TYPE:\n-\t\tif (td.count >= 16*1024)\n-\t\t    continue;\n+\t    if (xl->count && td.count != xl->count)\n \t\tbreak;\n-\t    case RPM_I18NSTRING_TYPE:\n-\t\tcontinue;\n+\t    if (!headerPut(h, &td, HEADERPUT_DEFAULT))\n \t\tbreak;\n-\t    }\n-\t    (void) headerPut(h, &td, HEADERPUT_DEFAULT);\n+\t    rpmtdFreeData(&td);\n \t}\n     }\n-    headerFreeIterator(hi);\n+    rpmtdFreeData(&td);\n+\n+    if (xl->stag) {\n+\trasprintf(msg, \"invalid signature tag %s (%d)\",\n+\t\t\trpmTagGetName(xl->xtag), xl->xtag);\n+    }\n+\n+    return xl->stag;\n }\n \n /**\n@@ -380,7 +367,8 @@ rpmRC rpmReadPackageFile(rpmts ts, FD_t fd, const char * fn, Header * hdrp)\n \t\tgoto exit;\n \n \t    /* Append (and remap) signature tags to the metadata. */\n-\t    headerMergeLegacySigs(h, sigh);\n+\t    if (headerMergeLegacySigs(h, sigh, &msg))\n+\t\tgoto exit;\n \t    applyRetrofits(h);\n \n \t    /* Bump reference count for return. */"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 1,
        "max_directory_depth": 1
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "d319c79c6469be00748b9870c8f33b34c65f0e6d",
            "date": "2025-01-13T14:13:56Z",
            "author_login": "ffesti"
          },
          {
            "sha": "55453a055f58aa6837ccf78ceccb869d4a8ebe57",
            "date": "2025-01-08T14:23:30Z",
            "author_login": "ffesti"
          },
          {
            "sha": "e09a79afb171159f3d76a8d204cd40f562cb19b0",
            "date": "2025-01-08T14:25:29Z",
            "author_login": "ffesti"
          },
          {
            "sha": "105c5e832aacba86fb7ec528ffa9ef085fbcb2be",
            "date": "2025-01-10T14:14:59Z",
            "author_login": "pmatilai"
          },
          {
            "sha": "3755fca7b2f775661f90b675df3976e11abbfd17",
            "date": "2025-01-10T12:14:47Z",
            "author_login": "pmatilai"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 7.0,
    "cvss_vector": "CVSS:3.1/AV:L/AC:H/PR:N/UI:R/S:U/C:H/I:H/A:H",
    "cwe_id": "CWE-345",
    "description": "A flaw was found in RPM's signature check functionality when reading a package file. This flaw allows an attacker who can convince a victim to install a seemingly verifiable package, whose signature header was modified, to cause RPM database corruption and execute code. The highest threat from this vulnerability is to data integrity, confidentiality, and system availability.",
    "attack_vector": "LOCAL",
    "attack_complexity": "HIGH"
  },
  "temporal_data": {
    "published_date": "2021-03-26T17:15:13.000",
    "last_modified": "2024-11-21T05:46:15.240",
    "fix_date": "2021-03-04T11:21:19Z"
  },
  "references": [
    {
      "url": "https://bugzilla.redhat.com/show_bug.cgi?id=1934125",
      "source": "secalert@redhat.com",
      "tags": [
        "Issue Tracking",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/rpm-software-management/rpm/commit/d6a86b5e69e46cc283b1e06c92343319beb42e21",
      "source": "secalert@redhat.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/TMGXO3W6DHPO62GJ4VVF5DEUX5DRUR5K/",
      "source": "secalert@redhat.com",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/VHRPNBCRPDJHHQE3MBPSZK4H7X2IM7AC/",
      "source": "secalert@redhat.com",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/YILPBTPSBRYL4POBI3F4YUSVPSOQNJBY/",
      "source": "secalert@redhat.com",
      "tags": []
    },
    {
      "url": "https://security.gentoo.org/glsa/202107-43",
      "source": "secalert@redhat.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.starwindsoftware.com/security/sw-20220805-0002/",
      "source": "secalert@redhat.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://bugzilla.redhat.com/show_bug.cgi?id=1934125",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Issue Tracking",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/rpm-software-management/rpm/commit/d6a86b5e69e46cc283b1e06c92343319beb42e21",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/TMGXO3W6DHPO62GJ4VVF5DEUX5DRUR5K/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/VHRPNBCRPDJHHQE3MBPSZK4H7X2IM7AC/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/YILPBTPSBRYL4POBI3F4YUSVPSOQNJBY/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://security.gentoo.org/glsa/202107-43",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.starwindsoftware.com/security/sw-20220805-0002/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:01:33.498357",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "rpm",
    "owner": "rpm-software-management",
    "created_at": "2015-02-24T12:00:53Z",
    "updated_at": "2025-01-14T12:49:04Z",
    "pushed_at": "2025-01-14T12:48:59Z",
    "size": 86059,
    "stars": 519,
    "forks": 375,
    "open_issues": 272,
    "watchers": 519,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "ffesti-templates",
      "master",
      "refs",
      "rpm-4.4.x",
      "rpm-4.6.x",
      "rpm-4.7.x",
      "rpm-4.8.x",
      "rpm-4.9.x",
      "rpm-4.10.x",
      "rpm-4.11.x",
      "rpm-4.12.x",
      "rpm-4.13.x",
      "rpm-4.14.x",
      "rpm-4.15.x",
      "rpm-4.16.x",
      "rpm-4.17.x",
      "rpm-4.18.x",
      "rpm-4.19.x",
      "rpm-4.20.x"
    ],
    "languages": {
      "C++": 1716571,
      "C": 619258,
      "Shell": 62332,
      "CMake": 34556,
      "Python": 16186,
      "Lua": 138
    },
    "commit_activity": {
      "total_commits_last_year": 712,
      "avg_commits_per_week": 13.692307692307692,
      "days_active_last_year": 184
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T16:04:49.568059"
  }
}