{
  "cve_id": "CVE-2021-21245",
  "github_data": {
    "repository": "theonedev/onedev",
    "fix_commit": "0c060153fb97c0288a1917efdb17cc426934dacb",
    "related_commits": [
      "0c060153fb97c0288a1917efdb17cc426934dacb",
      "0c060153fb97c0288a1917efdb17cc426934dacb"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "0c060153fb97c0288a1917efdb17cc426934dacb",
      "commit_date": "2020-11-20T02:08:14Z",
      "author": {
        "login": "robinshine",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Fix the issue that uploaded file can be stored anywhere OneDev has write",
        "length": 89,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 20,
        "additions": 17,
        "deletions": 3
      },
      "files": [
        {
          "filename": "server-core/src/main/java/io/onedev/server/util/FilenameUtils.java",
          "status": "added",
          "additions": 9,
          "deletions": 0,
          "patch": "@@ -0,0 +1,9 @@\n+package io.onedev.server.util;\n+\n+public class FilenameUtils extends org.apache.commons.io.FilenameUtils {\n+\n+\tpublic static String sanitizeFilename(String fileName) {\n+\t\treturn fileName.replace(\"..\", \"_\").replace('/', '_').replace('\\\\', '_');\n+\t}\n+\n+}\n\\ No newline at end of file"
        },
        {
          "filename": "server-core/src/main/java/io/onedev/server/web/component/markdown/InsertUrlPanel.java",
          "status": "modified",
          "additions": 3,
          "deletions": 1,
          "patch": "@@ -53,6 +53,7 @@\n import io.onedev.server.git.BlobIdentFilter;\n import io.onedev.server.git.exception.GitException;\n import io.onedev.server.model.Project;\n+import io.onedev.server.util.FilenameUtils;\n import io.onedev.server.util.UrlUtils;\n import io.onedev.server.web.ajaxlistener.ConfirmClickListener;\n import io.onedev.server.web.behavior.ReferenceInputBehavior;\n@@ -402,7 +403,8 @@ protected void onSubmit() {\n \t\t\t\t\tString attachmentName;\n \t\t\t\t\tFileUpload upload = uploads.iterator().next();\n \t\t\t\t\ttry (InputStream is = upload.getInputStream()) {\n-\t\t\t\t\t\tattachmentName = attachmentSupport.saveAttachment(upload.getClientFileName(), is);\n+\t\t\t\t\t\tattachmentName = attachmentSupport.saveAttachment(\n+\t\t\t\t\t\t\t\tFilenameUtils.sanitizeFilename(upload.getClientFileName()), is);\n \t\t\t\t\t} catch (IOException e) {\n \t\t\t\t\t\tthrow new RuntimeException(e);\n \t\t\t\t\t}"
        },
        {
          "filename": "server-core/src/main/java/io/onedev/server/web/component/markdown/MarkdownEditor.java",
          "status": "modified",
          "additions": 3,
          "deletions": 1,
          "patch": "@@ -60,6 +60,7 @@\n import io.onedev.server.model.Project;\n import io.onedev.server.model.PullRequest;\n import io.onedev.server.model.User;\n+import io.onedev.server.util.FilenameUtils;\n import io.onedev.server.util.markdown.MarkdownManager;\n import io.onedev.server.util.validation.ProjectNameValidator;\n import io.onedev.server.web.avatar.AvatarManager;\n@@ -477,7 +478,8 @@ protected void respond(AjaxRequestTarget target) {\n \t\t\t\tHttpServletRequest request = (HttpServletRequest) RequestCycle.get().getRequest().getContainerRequest();\n \t\t\t\tHttpServletResponse response = (HttpServletResponse) RequestCycle.get().getResponse().getContainerResponse();\n \t\t\t\ttry {\n-\t\t\t\t\tString fileName = URLDecoder.decode(request.getHeader(\"File-Name\"), StandardCharsets.UTF_8.name());\n+\t\t\t\t\tString fileName = FilenameUtils.sanitizeFilename(\n+\t\t\t\t\t\t\tURLDecoder.decode(request.getHeader(\"File-Name\"), StandardCharsets.UTF_8.name()));\n \t\t\t\t\tString attachmentName = getAttachmentSupport().saveAttachment(fileName, request.getInputStream());\n \t\t\t\t\tresponse.getWriter().print(URLEncoder.encode(attachmentName, StandardCharsets.UTF_8.name()));\n \t\t\t\t\tresponse.setStatus(HttpServletResponse.SC_OK);"
        },
        {
          "filename": "server-core/src/main/java/io/onedev/server/web/page/project/blob/ProjectBlobPage.java",
          "status": "modified",
          "additions": 2,
          "deletions": 1,
          "patch": "@@ -85,6 +85,7 @@\n import io.onedev.server.search.code.query.BlobQuery;\r\n import io.onedev.server.search.code.query.TextQuery;\r\n import io.onedev.server.security.SecurityUtils;\r\n+import io.onedev.server.util.FilenameUtils;\r\n import io.onedev.server.util.script.identity.JobIdentity;\r\n import io.onedev.server.util.script.identity.ScriptIdentity;\r\n import io.onedev.server.util.script.identity.ScriptIdentityAware;\r\n@@ -1413,7 +1414,7 @@ public RefUpdated uploadFiles(Collection<FileUpload> uploads, String directory,\n \t\tBlobIdent blobIdent = getBlobIdent();\r\n \t\t\r\n \t\tfor (FileUpload upload: uploads) {\r\n-\t\t\tString blobPath = upload.getClientFileName();\r\n+\t\t\tString blobPath = FilenameUtils.sanitizeFilename(upload.getClientFileName());\r\n \t\t\tif (parentPath != null)\r\n \t\t\t\tblobPath = parentPath + \"/\" + blobPath;\r\n \t\t\t\r"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 3,
        "max_directory_depth": 11
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "c1225b2d30014179117beeab4f237b0a2bf41ad9",
            "date": "2025-01-25T03:58:44Z",
            "author_login": "robinshine"
          },
          {
            "sha": "72169095ca02b9e8ef443311ea32998b71e54769",
            "date": "2025-01-25T03:58:24Z",
            "author_login": "robinshine"
          },
          {
            "sha": "5f5259da16fab4d3033c5cb106bf833a39cbd7da",
            "date": "2025-01-24T01:36:54Z",
            "author_login": "robinshine"
          },
          {
            "sha": "376fd70412f089d27d4881b25926ab734128d9b3",
            "date": "2025-01-24T01:32:16Z",
            "author_login": "robinshine"
          },
          {
            "sha": "0c3627ee7c4ea90a4a88858b29987c789051efb3",
            "date": "2025-01-24T01:32:01Z",
            "author_login": "robinshine"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 10.0,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:N",
    "cwe_id": "CWE-434",
    "description": "OneDev is an all-in-one devops platform. In OneDev before version 4.0.3, AttachmentUploadServlet also saves user controlled data (`request.getInputStream()`) to a user specified location (`request.getHeader(\"File-Name\")`). This issue may lead to arbitrary file upload which can be used to upload a WebShell to OneDev server. This issue is addressed in 4.0.3 by only allowing uploaded file to be in attachments folder. The webshell issue is not possible as OneDev never executes files in attachments folder.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2021-01-15T21:15:13.413",
    "last_modified": "2024-11-21T05:47:51.243",
    "fix_date": "2020-11-20T02:08:14Z"
  },
  "references": [
    {
      "url": "https://github.com/theonedev/onedev/commit/0c060153fb97c0288a1917efdb17cc426934dacb",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/theonedev/onedev/security/advisories/GHSA-62m2-38q5-96w9",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/theonedev/onedev/commit/0c060153fb97c0288a1917efdb17cc426934dacb",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/theonedev/onedev/security/advisories/GHSA-62m2-38q5-96w9",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:01:13.151960",
    "processing_status": "enhanced"
  },
  "repository_context": {
    "name": "onedev",
    "owner": "theonedev",
    "created_at": "2018-11-06T02:57:01Z",
    "updated_at": "2025-01-25T21:53:19Z",
    "pushed_at": "2025-01-25T04:21:03Z",
    "size": 223029,
    "stars": 13639,
    "forks": 878,
    "open_issues": 0,
    "watchers": 13639,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [],
    "languages": {
      "Java": 11067888,
      "JavaScript": 730260,
      "HTML": 380412,
      "CSS": 180815,
      "Shell": 116784,
      "ANTLR": 46591,
      "Smarty": 17174,
      "Python": 5761,
      "Mustache": 3983,
      "Dockerfile": 125
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-26T07:57:34.182929"
  }
}