{
  "cve_id": "CVE-2021-21266",
  "github_data": {
    "repository": "openhab/openhab-addons",
    "fix_commit": "81935b0ab126e6d9aebd2f6c3fc67d82bb7e8b86",
    "related_commits": [
      "81935b0ab126e6d9aebd2f6c3fc67d82bb7e8b86",
      "81935b0ab126e6d9aebd2f6c3fc67d82bb7e8b86"
    ],
    "patch_url": "https://github.com/openhab/openhab-addons/commit/81935b0ab126e6d9aebd2f6c3fc67d82bb7e8b86.patch",
    "fix_commit_details": {
      "sha": "81935b0ab126e6d9aebd2f6c3fc67d82bb7e8b86",
      "commit_date": "2021-01-24T14:06:00Z",
      "author": {
        "login": "kaikreuzer",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Fix XXE vulnerabilities in multiple add-ons",
        "length": 89,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 176,
        "additions": 163,
        "deletions": 13
      },
      "files": [
        {
          "filename": "bundles/org.openhab.binding.avmfritz/src/main/java/org/openhab/binding/avmfritz/internal/hardware/callbacks/FritzAhaUpdateCallback.java",
          "status": "modified",
          "additions": 5,
          "deletions": 2,
          "patch": "@@ -18,6 +18,8 @@\n \n import javax.xml.bind.JAXBException;\n import javax.xml.bind.Unmarshaller;\n+import javax.xml.stream.XMLStreamException;\n+import javax.xml.stream.XMLStreamReader;\n \n import org.eclipse.jdt.annotation.NonNullByDefault;\n import org.eclipse.smarthome.core.thing.ThingStatus;\n@@ -62,15 +64,16 @@ public void execute(int status, String response) {\n         logger.trace(\"Received State response {}\", response);\n         if (isValidRequest()) {\n             try {\n+                XMLStreamReader xsr = JAXBUtils.XMLINPUTFACTORY.createXMLStreamReader(new StringReader(response));\n                 Unmarshaller unmarshaller = JAXBUtils.JAXBCONTEXT_DEVICES.createUnmarshaller();\n-                DeviceListModel model = (DeviceListModel) unmarshaller.unmarshal(new StringReader(response));\n+                DeviceListModel model = (DeviceListModel) unmarshaller.unmarshal(xsr);\n                 if (model != null) {\n                     handler.onDeviceListAdded(model.getDevicelist());\n                 } else {\n                     logger.debug(\"no model in response\");\n                 }\n                 handler.setStatusInfo(ThingStatus.ONLINE, ThingStatusDetail.NONE, null);\n-            } catch (JAXBException e) {\n+            } catch (JAXBException | XMLStreamException e) {\n                 logger.error(\"Exception creating Unmarshaller: {}\", e.getLocalizedMessage(), e);\n                 handler.setStatusInfo(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n                         e.getLocalizedMessage());"
        },
        {
          "filename": "bundles/org.openhab.binding.avmfritz/src/main/java/org/openhab/binding/avmfritz/internal/hardware/callbacks/FritzAhaUpdateTemplatesCallback.java",
          "status": "modified",
          "additions": 5,
          "deletions": 2,
          "patch": "@@ -18,6 +18,8 @@\n \n import javax.xml.bind.JAXBException;\n import javax.xml.bind.Unmarshaller;\n+import javax.xml.stream.XMLStreamException;\n+import javax.xml.stream.XMLStreamReader;\n \n import org.eclipse.jdt.annotation.NonNullByDefault;\n import org.openhab.binding.avmfritz.internal.dto.templates.TemplateListModel;\n@@ -58,14 +60,15 @@ public void execute(int status, String response) {\n         logger.trace(\"Received response '{}'\", response);\n         if (isValidRequest()) {\n             try {\n+                XMLStreamReader xsr = JAXBUtils.XMLINPUTFACTORY.createXMLStreamReader(new StringReader(response));\n                 Unmarshaller unmarshaller = JAXBUtils.JAXBCONTEXT_TEMPLATES.createUnmarshaller();\n-                TemplateListModel model = (TemplateListModel) unmarshaller.unmarshal(new StringReader(response));\n+                TemplateListModel model = (TemplateListModel) unmarshaller.unmarshal(xsr);\n                 if (model != null) {\n                     handler.addTemplateList(model.getTemplates());\n                 } else {\n                     logger.debug(\"no template in response\");\n                 }\n-            } catch (JAXBException e) {\n+            } catch (JAXBException | XMLStreamException e) {\n                 logger.error(\"Exception creating Unmarshaller: {}\", e.getLocalizedMessage(), e);\n             }\n         } else {"
        },
        {
          "filename": "bundles/org.openhab.binding.avmfritz/src/main/java/org/openhab/binding/avmfritz/internal/util/JAXBUtils.java",
          "status": "modified",
          "additions": 9,
          "deletions": 0,
          "patch": "@@ -14,6 +14,7 @@\n \n import javax.xml.bind.JAXBContext;\n import javax.xml.bind.JAXBException;\n+import javax.xml.stream.XMLInputFactory;\n \n import org.eclipse.jdt.annotation.NonNullByDefault;\n import org.eclipse.jdt.annotation.Nullable;\n@@ -34,6 +35,7 @@ public class JAXBUtils {\n \n     public static final @Nullable JAXBContext JAXBCONTEXT_DEVICES = initJAXBContextDevices();\n     public static final @Nullable JAXBContext JAXBCONTEXT_TEMPLATES = initJAXBContextTemplates();\n+    public static final XMLInputFactory XMLINPUTFACTORY = initXMLInputFactory();\n \n     private static @Nullable JAXBContext initJAXBContextDevices() {\n         try {\n@@ -52,4 +54,11 @@ public class JAXBUtils {\n             return null;\n         }\n     }\n+\n+    private static XMLInputFactory initXMLInputFactory() {\n+        XMLInputFactory xif = XMLInputFactory.newInstance();\n+        xif.setProperty(XMLInputFactory.IS_SUPPORTING_EXTERNAL_ENTITIES, false);\n+        xif.setProperty(XMLInputFactory.SUPPORT_DTD, false);\n+        return xif;\n+    }\n }"
        },
        {
          "filename": "bundles/org.openhab.binding.bosesoundtouch/src/main/java/org/openhab/binding/bosesoundtouch/internal/XMLResponseProcessor.java",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -41,6 +41,7 @@ public XMLResponseProcessor(BoseSoundTouchHandler handler) {\n \n     public void handleMessage(String msg) throws SAXException, IOException {\n         XMLReader reader = XMLReaderFactory.createXMLReader();\n+        reader.setFeature(\"http://apache.org/xml/features/disallow-doctype-decl\", true);\n         reader.setContentHandler(new XMLResponseHandler(handler, stateSwitchingMap));\n         reader.parse(new InputSource(new StringReader(msg)));\n     }"
        },
        {
          "filename": "bundles/org.openhab.binding.denonmarantz/src/main/java/org/openhab/binding/denonmarantz/internal/connector/http/DenonMarantzHttpConnector.java",
          "status": "modified",
          "additions": 2,
          "deletions": 0,
          "patch": "@@ -309,6 +309,8 @@ private <T> T getDocument(String uri, Class<T> response) throws IOException {\n             if (StringUtils.isNotBlank(result)) {\n                 JAXBContext jc = JAXBContext.newInstance(response);\n                 XMLInputFactory xif = XMLInputFactory.newInstance();\n+                xif.setProperty(XMLInputFactory.IS_SUPPORTING_EXTERNAL_ENTITIES, false);\n+                xif.setProperty(XMLInputFactory.SUPPORT_DTD, false);\n                 XMLStreamReader xsr = xif.createXMLStreamReader(IOUtils.toInputStream(result));\n                 xsr = new PropertyRenamerDelegate(xsr);\n "
        },
        {
          "filename": "bundles/org.openhab.binding.denonmarantz/src/main/java/org/openhab/binding/denonmarantz/internal/handler/DenonMarantzHandler.java",
          "status": "modified",
          "additions": 8,
          "deletions": 1,
          "patch": "@@ -261,8 +261,15 @@ private void autoConfigure() {\n \n                 if (status == HttpURLConnection.HTTP_OK && response != null) {\n                     DocumentBuilderFactory domFactory = DocumentBuilderFactory.newInstance();\n-                    DocumentBuilder builder;\n                     try {\n+                        // see\n+                        // https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html\n+                        domFactory.setFeature(\"http://xml.org/sax/features/external-general-entities\", false);\n+                        domFactory.setFeature(\"http://xml.org/sax/features/external-parameter-entities\", false);\n+                        domFactory.setFeature(\"http://apache.org/xml/features/nonvalidating/load-external-dtd\", false);\n+                        domFactory.setXIncludeAware(false);\n+                        domFactory.setExpandEntityReferences(false);\n+                        DocumentBuilder builder;\n                         builder = domFactory.newDocumentBuilder();\n                         Document dDoc = builder.parse(new InputSource(new StringReader(response.getContentAsString())));\n                         XPath xPath = XPathFactory.newInstance().newXPath();"
        },
        {
          "filename": "bundles/org.openhab.binding.dlinksmarthome/src/main/java/org/openhab/binding/dlinksmarthome/internal/DLinkHNAPCommunication.java",
          "status": "modified",
          "additions": 8,
          "deletions": 1,
          "patch": "@@ -155,7 +155,14 @@ public DLinkHNAPCommunication(final String ipAddress, final String pin) {\n             uri = new URI(\"http://\" + ipAddress + \"/HNAP1\");\n             httpClient.start();\n \n-            parser = DocumentBuilderFactory.newInstance().newDocumentBuilder();\n+            DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();\n+            // see https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html\n+            dbf.setFeature(\"http://xml.org/sax/features/external-general-entities\", false);\n+            dbf.setFeature(\"http://xml.org/sax/features/external-parameter-entities\", false);\n+            dbf.setFeature(\"http://apache.org/xml/features/nonvalidating/load-external-dtd\", false);\n+            dbf.setXIncludeAware(false);\n+            dbf.setExpandEntityReferences(false);\n+            parser = dbf.newDocumentBuilder();\n \n             final MessageFactory messageFactory = MessageFactory.newInstance();\n             requestAction = messageFactory.createMessage();"
        },
        {
          "filename": "bundles/org.openhab.binding.enigma2/src/main/java/org/openhab/binding/enigma2/internal/Enigma2Client.java",
          "status": "modified",
          "additions": 12,
          "deletions": 2,
          "patch": "@@ -82,8 +82,18 @@ public class Enigma2Client {\n     private final DocumentBuilderFactory factory;\n \n     public Enigma2Client(String host, @Nullable String user, @Nullable String password, int requestTimeout) {\n-        this.enigma2HttpClient = new Enigma2HttpClient(requestTimeout);\n-        this.factory = DocumentBuilderFactory.newInstance();\n+        enigma2HttpClient = new Enigma2HttpClient(requestTimeout);\n+        factory = DocumentBuilderFactory.newInstance();\n+        // see https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html\n+        try {\n+            factory.setFeature(\"http://xml.org/sax/features/external-general-entities\", false);\n+            factory.setFeature(\"http://xml.org/sax/features/external-parameter-entities\", false);\n+            factory.setFeature(\"http://apache.org/xml/features/nonvalidating/load-external-dtd\", false);\n+            factory.setXIncludeAware(false);\n+            factory.setExpandEntityReferences(false);\n+        } catch (ParserConfigurationException e) {\n+            logger.warn(\"Failed setting parser features against XXE attacks!\", e);\n+        }\n         if (StringUtils.isNotEmpty(user) && StringUtils.isNotEmpty(password)) {\n             this.host = \"http://\" + user + \":\" + password + \"@\" + host;\n         } else {"
        },
        {
          "filename": "bundles/org.openhab.binding.fmiweather/src/main/java/org/openhab/binding/fmiweather/internal/client/Client.java",
          "status": "modified",
          "additions": 6,
          "deletions": 0,
          "patch": "@@ -105,6 +105,12 @@ public String getNamespaceURI(@Nullable String prefix) {\n     public Client() {\n         documentBuilderFactory.setNamespaceAware(true);\n         try {\n+            // see https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html\n+            documentBuilderFactory.setFeature(\"http://xml.org/sax/features/external-general-entities\", false);\n+            documentBuilderFactory.setFeature(\"http://xml.org/sax/features/external-parameter-entities\", false);\n+            documentBuilderFactory.setFeature(\"http://apache.org/xml/features/nonvalidating/load-external-dtd\", false);\n+            documentBuilderFactory.setXIncludeAware(false);\n+            documentBuilderFactory.setExpandEntityReferences(false);\n             documentBuilder = documentBuilderFactory.newDocumentBuilder();\n         } catch (ParserConfigurationException e) {\n             throw new IllegalStateException(e);"
        },
        {
          "filename": "bundles/org.openhab.binding.fsinternetradio/src/main/java/org/openhab/binding/fsinternetradio/internal/radio/FrontierSiliconRadioApiResult.java",
          "status": "modified",
          "additions": 6,
          "deletions": 0,
          "patch": "@@ -209,6 +209,12 @@ public String getSessionId() {\n     private Document getXmlDocFromString(String xmlString)\n             throws ParserConfigurationException, SAXException, IOException {\n         final DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n+        // see https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html\n+        factory.setFeature(\"http://xml.org/sax/features/external-general-entities\", false);\n+        factory.setFeature(\"http://xml.org/sax/features/external-parameter-entities\", false);\n+        factory.setFeature(\"http://apache.org/xml/features/nonvalidating/load-external-dtd\", false);\n+        factory.setXIncludeAware(false);\n+        factory.setExpandEntityReferences(false);\n         final DocumentBuilder builder = factory.newDocumentBuilder();\n         final Document xmlDocument = builder.parse(new InputSource(new StringReader(xmlString)));\n         return xmlDocument;"
        },
        {
          "filename": "bundles/org.openhab.binding.gce/src/main/java/org/openhab/binding/gce/internal/model/StatusFileInterpreter.java",
          "status": "modified",
          "additions": 8,
          "deletions": 1,
          "patch": "@@ -61,7 +61,14 @@ public StatusFileInterpreter(String hostname, Ipx800EventListener listener) {\n \n     public void read() {\n         try {\n-            DocumentBuilder builder = DocumentBuilderFactory.newInstance().newDocumentBuilder();\n+            DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n+            // see https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html\n+            factory.setFeature(\"http://xml.org/sax/features/external-general-entities\", false);\n+            factory.setFeature(\"http://xml.org/sax/features/external-parameter-entities\", false);\n+            factory.setFeature(\"http://apache.org/xml/features/nonvalidating/load-external-dtd\", false);\n+            factory.setXIncludeAware(false);\n+            factory.setExpandEntityReferences(false);\n+            DocumentBuilder builder = factory.newDocumentBuilder();\n             String statusPage = HttpUtil.executeUrl(\"GET\", String.format(URL_TEMPLATE, hostname), 5000);\n             InputStream inputStream = new ByteArrayInputStream(statusPage.getBytes());\n             Document document = builder.parse(inputStream);"
        },
        {
          "filename": "bundles/org.openhab.binding.homematic/src/main/java/org/openhab/binding/homematic/internal/communicator/message/XmlRpcResponse.java",
          "status": "modified",
          "additions": 3,
          "deletions": 0,
          "patch": "@@ -47,6 +47,9 @@ public XmlRpcResponse(InputStream is, String encoding)\n             throws SAXException, ParserConfigurationException, IOException {\n         SAXParserFactory factory = SAXParserFactory.newInstance();\n         SAXParser saxParser = factory.newSAXParser();\n+        factory.setFeature(\"http://xml.org/sax/features/external-general-entities\", false);\n+        saxParser.getXMLReader().setFeature(\"http://xml.org/sax/features/external-general-entities\", false);\n+        factory.setFeature(\"http://apache.org/xml/features/disallow-doctype-decl\", true);\n         InputSource inputSource = new InputSource(is);\n         inputSource.setEncoding(encoding);\n         saxParser.parse(inputSource, new XmlRpcHandler());"
        },
        {
          "filename": "bundles/org.openhab.binding.hpprinter/src/main/java/org/openhab/binding/hpprinter/internal/api/HPWebServerClient.java",
          "status": "modified",
          "additions": 9,
          "deletions": 3,
          "patch": "@@ -50,7 +50,7 @@ public class HPWebServerClient {\n \n     /**\n      * Creates a new HP Web Server Client object.\n-     * \n+     *\n      * @param httpClient {HttpClient} The HttpClient to use for HTTP requests.\n      * @param address The address for the Embedded Web Server.\n      */\n@@ -63,7 +63,7 @@ public HPWebServerClient(HttpClient httpClient, String address) {\n \n     /**\n      * Gets the Status information from the Embedded Web Server.\n-     * \n+     *\n      * @return The status information.\n      */\n     public HPServerResult<HPStatus> getStatus() {\n@@ -84,7 +84,7 @@ public HPServerResult<HPScannerStatusFeatures> getScannerFeatures() {\n \n     /**\n      * Gets the Usage information from the Embedded Web Server.\n-     * \n+     *\n      * @return The usage information.\n      */\n     public HPServerResult<HPUsage> getUsage() {\n@@ -120,6 +120,12 @@ private <T> HPServerResult<T> fetchData(String endpoint, Function<Document, T> f\n \n     private synchronized Document getDocument(String contentAsString)\n             throws ParserConfigurationException, SAXException, IOException {\n+        // see https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html\n+        factory.setFeature(\"http://xml.org/sax/features/external-general-entities\", false);\n+        factory.setFeature(\"http://xml.org/sax/features/external-parameter-entities\", false);\n+        factory.setFeature(\"http://apache.org/xml/features/nonvalidating/load-external-dtd\", false);\n+        factory.setXIncludeAware(false);\n+        factory.setExpandEntityReferences(false);\n         DocumentBuilder builder = factory.newDocumentBuilder();\n         InputSource source = new InputSource(new StringReader(contentAsString));\n         return builder.parse(source);"
        },
        {
          "filename": "bundles/org.openhab.binding.ihc/src/main/java/org/openhab/binding/ihc/internal/ws/projectfile/ProjectFileUtils.java",
          "status": "modified",
          "additions": 6,
          "deletions": 0,
          "patch": "@@ -53,6 +53,12 @@ public static Document readFromFile(String filePath) throws IhcExecption {\n         File fXmlFile = new File(filePath);\n         DocumentBuilderFactory dbFactory = DocumentBuilderFactory.newInstance();\n         try {\n+            // see https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html\n+            dbFactory.setFeature(\"http://xml.org/sax/features/external-general-entities\", false);\n+            dbFactory.setFeature(\"http://xml.org/sax/features/external-parameter-entities\", false);\n+            dbFactory.setFeature(\"http://apache.org/xml/features/nonvalidating/load-external-dtd\", false);\n+            dbFactory.setXIncludeAware(false);\n+            dbFactory.setExpandEntityReferences(false);\n             DocumentBuilder dBuilder = dbFactory.newDocumentBuilder();\n             Document doc = dBuilder.parse(fXmlFile);\n             return doc;"
        },
        {
          "filename": "bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/device/DeviceTypeLoader.java",
          "status": "modified",
          "additions": 6,
          "deletions": 0,
          "patch": "@@ -78,6 +78,12 @@ public HashMap<String, DeviceType> getDeviceTypes() {\n      */\n     public void loadDeviceTypesXML(InputStream in) throws ParserConfigurationException, SAXException, IOException {\n         DocumentBuilderFactory dbFactory = DocumentBuilderFactory.newInstance();\n+        // see https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html\n+        dbFactory.setFeature(\"http://xml.org/sax/features/external-general-entities\", false);\n+        dbFactory.setFeature(\"http://xml.org/sax/features/external-parameter-entities\", false);\n+        dbFactory.setFeature(\"http://apache.org/xml/features/nonvalidating/load-external-dtd\", false);\n+        dbFactory.setXIncludeAware(false);\n+        dbFactory.setExpandEntityReferences(false);\n         DocumentBuilder dBuilder = dbFactory.newDocumentBuilder();\n         Document doc = dBuilder.parse(in);\n         doc.getDocumentElement().normalize();"
        },
        {
          "filename": "bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/device/FeatureTemplateLoader.java",
          "status": "modified",
          "additions": 6,
          "deletions": 0,
          "patch": "@@ -52,6 +52,12 @@ public static List<FeatureTemplate> readTemplates(InputStream input) throws IOEx\n         List<FeatureTemplate> features = new ArrayList<>();\n         try {\n             DocumentBuilderFactory dbFactory = DocumentBuilderFactory.newInstance();\n+            // see https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html\n+            dbFactory.setFeature(\"http://xml.org/sax/features/external-general-entities\", false);\n+            dbFactory.setFeature(\"http://xml.org/sax/features/external-parameter-entities\", false);\n+            dbFactory.setFeature(\"http://apache.org/xml/features/nonvalidating/load-external-dtd\", false);\n+            dbFactory.setXIncludeAware(false);\n+            dbFactory.setExpandEntityReferences(false);\n             DocumentBuilder dBuilder = dbFactory.newDocumentBuilder();\n             // Parse it!\n             Document doc = dBuilder.parse(input);"
        },
        {
          "filename": "bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/message/XMLMessageReader.java",
          "status": "modified",
          "additions": 6,
          "deletions": 0,
          "patch": "@@ -56,6 +56,12 @@ public static HashMap<String, Msg> readMessageDefinitions(InputStream input)\n         HashMap<String, Msg> messageMap = new HashMap<>();\n         try {\n             DocumentBuilderFactory dbFactory = DocumentBuilderFactory.newInstance();\n+            // see https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html\n+            dbFactory.setFeature(\"http://xml.org/sax/features/external-general-entities\", false);\n+            dbFactory.setFeature(\"http://xml.org/sax/features/external-parameter-entities\", false);\n+            dbFactory.setFeature(\"http://apache.org/xml/features/nonvalidating/load-external-dtd\", false);\n+            dbFactory.setXIncludeAware(false);\n+            dbFactory.setExpandEntityReferences(false);\n             DocumentBuilder dBuilder = dbFactory.newDocumentBuilder();\n             // Parse it!\n             Document doc = dBuilder.parse(input);"
        },
        {
          "filename": "bundles/org.openhab.binding.onkyo/src/main/java/org/openhab/binding/onkyo/internal/handler/OnkyoHandler.java",
          "status": "modified",
          "additions": 6,
          "deletions": 0,
          "patch": "@@ -498,6 +498,12 @@ public void statusUpdateReceived(String ip, EiscpMessage data) {\n     private void processInfo(String infoXML) {\n         try {\n             DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n+            // see https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html\n+            factory.setFeature(\"http://xml.org/sax/features/external-general-entities\", false);\n+            factory.setFeature(\"http://xml.org/sax/features/external-parameter-entities\", false);\n+            factory.setFeature(\"http://apache.org/xml/features/nonvalidating/load-external-dtd\", false);\n+            factory.setXIncludeAware(false);\n+            factory.setExpandEntityReferences(false);\n             DocumentBuilder builder = factory.newDocumentBuilder();\n             try (StringReader sr = new StringReader(infoXML)) {\n                 InputSource is = new InputSource(sr);"
        },
        {
          "filename": "bundles/org.openhab.binding.samsungtv/src/main/java/org/openhab/binding/samsungtv/internal/service/SamsungTvUtils.java",
          "status": "modified",
          "additions": 6,
          "deletions": 0,
          "patch": "@@ -81,6 +81,12 @@ public static HashMap<String, String> buildHashMap(String... data) {\n     public static @Nullable Document loadXMLFromString(String xml) {\n         try {\n             DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n+            // see https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html\n+            factory.setFeature(\"http://xml.org/sax/features/external-general-entities\", false);\n+            factory.setFeature(\"http://xml.org/sax/features/external-parameter-entities\", false);\n+            factory.setFeature(\"http://apache.org/xml/features/nonvalidating/load-external-dtd\", false);\n+            factory.setXIncludeAware(false);\n+            factory.setExpandEntityReferences(false);\n             DocumentBuilder builder = factory.newDocumentBuilder();\n             InputSource is = new InputSource(new StringReader(xml));\n             return builder.parse(is);"
        },
        {
          "filename": "bundles/org.openhab.binding.sonos/src/main/java/org/openhab/binding/sonos/internal/SonosXMLParser.java",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -134,6 +134,7 @@ public static List<SonosEntry> getEntriesFromString(String xml) {\n      */\n     public static @Nullable SonosResourceMetaData getResourceMetaData(String xml) throws SAXException {\n         XMLReader reader = XMLReaderFactory.createXMLReader();\n+        reader.setFeature(\"http://apache.org/xml/features/disallow-doctype-decl\", true);\n         ResourceMetaDataHandler handler = new ResourceMetaDataHandler();\n         reader.setContentHandler(handler);\n         try {"
        },
        {
          "filename": "bundles/org.openhab.binding.tellstick/src/main/java/org/openhab/binding/tellstick/internal/live/TelldusLiveDeviceController.java",
          "status": "modified",
          "additions": 2,
          "deletions": 0,
          "patch": "@@ -309,6 +309,8 @@ private <T> T innerCallRest(String uri, Class<T> response) throws InterruptedExc\n         // TelldusLiveHandler.logger.info(\"Devices\" + resp.getResponseBody());\n         JAXBContext jc = JAXBContext.newInstance(response);\n         XMLInputFactory xif = XMLInputFactory.newInstance();\n+        xif.setProperty(XMLInputFactory.IS_SUPPORTING_EXTERNAL_ENTITIES, false);\n+        xif.setProperty(XMLInputFactory.SUPPORT_DTD, false);\n         XMLStreamReader xsr = xif.createXMLStreamReader(resp.getResponseBodyAsStream());\n         // xsr = new PropertyRenamerDelegate(xsr);\n "
        },
        {
          "filename": "bundles/org.openhab.binding.vitotronic/src/main/java/org/openhab/binding/vitotronic/internal/handler/VitotronicBridgeHandler.java",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -250,6 +250,7 @@ private void openSocket() {\n         logger.trace(\"Start Background Thread for recieving data from adapter\");\n         try {\n             XMLReader xmlReader = XMLReaderFactory.createXMLReader();\n+            xmlReader.setFeature(\"http://apache.org/xml/features/disallow-doctype-decl\", true);\n             xmlReader.setContentHandler(new XmlHandler());\n             logger.trace(\"Start Parser for optolink adapter\");\n             xmlReader.parse(new InputSource(inStream));"
        },
        {
          "filename": "bundles/org.openhab.binding.wemo/src/main/java/org/openhab/binding/wemo/internal/discovery/WemoLinkDiscoveryService.java",
          "status": "modified",
          "additions": 7,
          "deletions": 0,
          "patch": "@@ -156,6 +156,13 @@ public void startScan() {\n \n                         // Build parser for received <DeviceList>\n                         DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();\n+                        // see\n+                        // https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html\n+                        dbf.setFeature(\"http://xml.org/sax/features/external-general-entities\", false);\n+                        dbf.setFeature(\"http://xml.org/sax/features/external-parameter-entities\", false);\n+                        dbf.setFeature(\"http://apache.org/xml/features/nonvalidating/load-external-dtd\", false);\n+                        dbf.setXIncludeAware(false);\n+                        dbf.setExpandEntityReferences(false);\n                         DocumentBuilder db = dbf.newDocumentBuilder();\n                         InputSource is = new InputSource();\n                         is.setCharacterStream(new StringReader(stringParser));"
        },
        {
          "filename": "bundles/org.openhab.binding.wemo/src/main/java/org/openhab/binding/wemo/internal/handler/WemoCoffeeHandler.java",
          "status": "modified",
          "additions": 7,
          "deletions": 0,
          "patch": "@@ -290,6 +290,13 @@ protected void updateWemoState() {\n                         stringParser = \"<data>\" + stringParser + \"</data>\";\n \n                         DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();\n+                        // see\n+                        // https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html\n+                        dbf.setFeature(\"http://xml.org/sax/features/external-general-entities\", false);\n+                        dbf.setFeature(\"http://xml.org/sax/features/external-parameter-entities\", false);\n+                        dbf.setFeature(\"http://apache.org/xml/features/nonvalidating/load-external-dtd\", false);\n+                        dbf.setXIncludeAware(false);\n+                        dbf.setExpandEntityReferences(false);\n                         DocumentBuilder db = dbf.newDocumentBuilder();\n                         InputSource is = new InputSource();\n                         is.setCharacterStream(new StringReader(stringParser));"
        },
        {
          "filename": "bundles/org.openhab.binding.wemo/src/main/java/org/openhab/binding/wemo/internal/handler/WemoHolmesHandler.java",
          "status": "modified",
          "additions": 7,
          "deletions": 0,
          "patch": "@@ -359,6 +359,13 @@ protected void updateWemoState() {\n                     stringParser = \"<data>\" + stringParser + \"</data>\";\n \n                     DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();\n+                    // see\n+                    // https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html\n+                    dbf.setFeature(\"http://xml.org/sax/features/external-general-entities\", false);\n+                    dbf.setFeature(\"http://xml.org/sax/features/external-parameter-entities\", false);\n+                    dbf.setFeature(\"http://apache.org/xml/features/nonvalidating/load-external-dtd\", false);\n+                    dbf.setXIncludeAware(false);\n+                    dbf.setExpandEntityReferences(false);\n                     DocumentBuilder db = dbf.newDocumentBuilder();\n                     InputSource is = new InputSource();\n                     is.setCharacterStream(new StringReader(stringParser));"
        },
        {
          "filename": "bundles/org.openhab.binding.wemo/src/main/java/org/openhab/binding/wemo/internal/handler/WemoMakerHandler.java",
          "status": "modified",
          "additions": 7,
          "deletions": 0,
          "patch": "@@ -222,6 +222,13 @@ protected void updateWemoState() {\n                         stringParser = \"<data>\" + stringParser + \"</data>\";\n \n                         DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();\n+                        // see\n+                        // https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html\n+                        dbf.setFeature(\"http://xml.org/sax/features/external-general-entities\", false);\n+                        dbf.setFeature(\"http://xml.org/sax/features/external-parameter-entities\", false);\n+                        dbf.setFeature(\"http://apache.org/xml/features/nonvalidating/load-external-dtd\", false);\n+                        dbf.setXIncludeAware(false);\n+                        dbf.setExpandEntityReferences(false);\n                         DocumentBuilder db = dbf.newDocumentBuilder();\n                         InputSource is = new InputSource();\n                         is.setCharacterStream(new StringReader(stringParser));"
        },
        {
          "filename": "bundles/org.openhab.binding.yamahareceiver/src/main/java/org/openhab/binding/yamahareceiver/internal/protocol/xml/XMLUtils.java",
          "status": "modified",
          "additions": 7,
          "deletions": 1,
          "patch": "@@ -173,7 +173,13 @@ public static Document xml(String message) throws IOException, ReceivedMessagePa\n                 : \"<?xml version=\\\"1.0\\\" encoding=\\\"utf-8\\\"?>\" + message;\n \n         try {\n-            return XMLUtils.dbf.newDocumentBuilder().parse(new InputSource(new StringReader(response)));\n+            // see https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html\n+            dbf.setFeature(\"http://xml.org/sax/features/external-general-entities\", false);\n+            dbf.setFeature(\"http://xml.org/sax/features/external-parameter-entities\", false);\n+            dbf.setFeature(\"http://apache.org/xml/features/nonvalidating/load-external-dtd\", false);\n+            dbf.setXIncludeAware(false);\n+            dbf.setExpandEntityReferences(false);\n+            return dbf.newDocumentBuilder().parse(new InputSource(new StringReader(response)));\n         } catch (SAXException | ParserConfigurationException e) {\n             throw new ReceivedMessageParseException(e);\n         }"
        },
        {
          "filename": "bundles/org.openhab.transform.xpath/src/main/java/org/openhab/transform/xpath/internal/XPathTransformationService.java",
          "status": "modified",
          "additions": 6,
          "deletions": 0,
          "patch": "@@ -55,6 +55,12 @@ public class XPathTransformationService implements TransformationService {\n \n         try {\n             DocumentBuilderFactory domFactory = DocumentBuilderFactory.newInstance();\n+            // see https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html\n+            domFactory.setFeature(\"http://xml.org/sax/features/external-general-entities\", false);\n+            domFactory.setFeature(\"http://xml.org/sax/features/external-parameter-entities\", false);\n+            domFactory.setFeature(\"http://apache.org/xml/features/nonvalidating/load-external-dtd\", false);\n+            domFactory.setXIncludeAware(false);\n+            domFactory.setExpandEntityReferences(false);\n             domFactory.setNamespaceAware(true);\n             domFactory.setValidating(false);\n             DocumentBuilder builder = domFactory.newDocumentBuilder();"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 24,
        "max_directory_depth": 12
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "184ef673a2aad92d2c83bb4af4e2088c67a4187b",
            "date": "2025-01-13T21:50:29Z",
            "author_login": "JankKeks"
          },
          {
            "sha": "15b3c0503e75fbd0df48540de6a4169a88398f11",
            "date": "2025-01-13T21:21:25Z",
            "author_login": "GiviMAD"
          },
          {
            "sha": "d8618a761a432dd567a9c74d281c0aab052f605e",
            "date": "2025-01-13T20:54:21Z",
            "author_login": "tl-photography"
          },
          {
            "sha": "22d907ffb22d7d97489346e547592f6c806a528b",
            "date": "2025-01-12T21:37:41Z",
            "author_login": "mlobstein"
          },
          {
            "sha": "fad9107a200ac14458b1557c47f52a6242bd02fb",
            "date": "2025-01-12T21:37:21Z",
            "author_login": "mlobstein"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.4,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N",
    "cwe_id": "CWE-611",
    "description": "openHAB is a vendor and technology agnostic open source automation software for your home. In openHAB before versions 2.5.12 and 3.0.1 the XML external entity (XXE) attack allows attackers in the same network as the openHAB instance to retrieve internal information like the content of files from the file system. Responses to SSDP requests can be especially malicious. All add-ons that use SAX or JAXB parsing of externally received XML are potentially subject to this kind of attack. In openHAB, the following add-ons are potentially impacted: AvmFritz, BoseSoundtouch, DenonMarantz, DLinkSmarthome, Enigma2, FmiWeather, FSInternetRadio, Gce, Homematic, HPPrinter, IHC, Insteon, Onkyo, Roku, SamsungTV, Sonos, Roku, Tellstick, TR064, UPnPControl, Vitotronic, Wemo, YamahaReceiver and XPath Tranformation. The vulnerabilities have been fixed in versions 2.5.12 and 3.0.1 by a more strict configuration of the used XML parser.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2021-02-01T15:15:13.057",
    "last_modified": "2024-11-21T05:47:53.610",
    "fix_date": "2021-01-24T14:06:00Z"
  },
  "references": [
    {
      "url": "https://dev.to/brianverm/configure-your-java-xml-parsers-to-prevent-xxe-213c",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/openhab/openhab-addons/commit/81935b0ab126e6d9aebd2f6c3fc67d82bb7e8b86",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/openhab/openhab-addons/security/advisories/GHSA-r2hc-pmr7-4c9r",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.contrastsecurity.com/security-influencers/xml-xxe-pitfalls-with-jaxb",
      "source": "security-advisories@github.com",
      "tags": [
        "Technical Description",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://dev.to/brianverm/configure-your-java-xml-parsers-to-prevent-xxe-213c",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/openhab/openhab-addons/commit/81935b0ab126e6d9aebd2f6c3fc67d82bb7e8b86",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/openhab/openhab-addons/security/advisories/GHSA-r2hc-pmr7-4c9r",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.contrastsecurity.com/security-influencers/xml-xxe-pitfalls-with-jaxb",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Technical Description",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:01:13.175813",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "openhab-addons",
    "owner": "openhab",
    "created_at": "2014-05-13T19:41:58Z",
    "updated_at": "2025-01-14T17:41:06Z",
    "pushed_at": "2025-01-14T07:56:23Z",
    "size": 359973,
    "stars": 1917,
    "forks": 3613,
    "open_issues": 640,
    "watchers": 1917,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [
      "2.5.x",
      "3.0.x",
      "3.1.x",
      "3.2.x",
      "3.4.x",
      "4.0.x",
      "4.1.x",
      "4.2.x",
      "4.3.x",
      "l10n_crowdin",
      "main"
    ],
    "languages": {
      "Java": 62559432,
      "JavaScript": 557917,
      "CSS": 421234,
      "HTML": 133419,
      "Groovy": 45923,
      "C++": 30357,
      "C": 18836,
      "Awk": 9404,
      "XSLT": 6282,
      "Python": 4218,
      "Shell": 1702,
      "Batchfile": 1466
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "epl-2.0"
    },
    "collected_at": "2025-01-14T19:48:58.855519"
  }
}