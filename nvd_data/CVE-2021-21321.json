{
  "cve_id": "CVE-2021-21321",
  "github_data": {
    "repository": "fastify/fastify-reply-from",
    "fix_commit": "dea227dda606900cc01870d08541b4dcc69d3889",
    "related_commits": [
      "dea227dda606900cc01870d08541b4dcc69d3889",
      "dea227dda606900cc01870d08541b4dcc69d3889"
    ],
    "patch_url": "https://github.com/fastify/fastify-reply-from/commit/dea227dda606900cc01870d08541b4dcc69d3889.patch",
    "fix_commit_details": {
      "sha": "dea227dda606900cc01870d08541b4dcc69d3889",
      "commit_date": "2021-02-19T17:45:06Z",
      "author": {
        "login": "mcollina",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Merge pull request from GHSA-qmw8-3v4g-gwj4",
        "length": 261,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 39,
        "additions": 32,
        "deletions": 7
      },
      "files": [
        {
          "filename": "lib/utils.js",
          "status": "modified",
          "additions": 8,
          "deletions": 2,
          "patch": "@@ -59,8 +59,14 @@ function buildURL (source, reqBase) {\n   const dest = new URL(source, reqBase)\n \n   // if base is specified, source url should not override it\n-  if (reqBase && !reqBase.startsWith(dest.origin)) {\n-    throw new Error('source must be a relative path string')\n+  if (reqBase) {\n+    if (!reqBase.endsWith('/') && dest.href.length > reqBase.length) {\n+      reqBase = reqBase + '/'\n+    }\n+\n+    if (!dest.href.startsWith(reqBase)) {\n+      throw new Error('source must be a relative path string')\n+    }\n   }\n \n   return dest"
        },
        {
          "filename": "test/build-url.js",
          "status": "modified",
          "additions": 19,
          "deletions": 1,
          "patch": "@@ -21,13 +21,31 @@ test('should return same source when base is not specified', (t) => {\n   t.equal(url.href, 'http://localhost/hi')\n })\n \n+test('should handle lack of trailing slash in base', (t) => {\n+  t.plan(3)\n+  let url = buildURL('hi', 'http://localhost/hi')\n+  t.equal(url.href, 'http://localhost/hi')\n+\n+  url = buildURL('hi/', 'http://localhost/hi')\n+  t.equal(url.href, 'http://localhost/hi/')\n+\n+  url = buildURL('hi/more', 'http://localhost/hi')\n+  t.equal(url.href, 'http://localhost/hi/more')\n+})\n+\n const errorInputs = [\n   { source: '//10.0.0.10/hi', base: 'http://localhost' },\n   { source: 'http://10.0.0.10/hi', base: 'http://localhost' },\n   { source: 'https://10.0.0.10/hi', base: 'http://localhost' },\n   { source: 'blah://10.0.0.10/hi', base: 'http://localhost' },\n   { source: '//httpbin.org/hi', base: 'http://localhost' },\n-  { source: 'urn:foo:bar', base: 'http://localhost' }\n+  { source: 'urn:foo:bar', base: 'http://localhost' },\n+  { source: 'http://localhost/private', base: 'http://localhost/exposed/' },\n+  { source: 'http://localhost/exposed-extra', base: 'http://localhost/exposed' },\n+  { source: '/private', base: 'http://localhost/exposed/' },\n+  { source: '/exposed-extra', base: 'http://localhost/exposed' },\n+  { source: '../private', base: 'http://localhost/exposed/' },\n+  { source: 'exposed-extra', base: 'http://localhost/exposed' }\n ]\n \n test('should throw when trying to override base', (t) => {"
        },
        {
          "filename": "test/unix-http.js",
          "status": "modified",
          "additions": 5,
          "deletions": 4,
          "patch": "@@ -13,14 +13,15 @@ if (process.platform === 'win32') {\n   process.exit(0)\n }\n \n+const socketPath = `${__filename}.socket`\n+const upstream = `unix+http://${querystring.escape(socketPath)}/`\n+\n const instance = Fastify()\n-instance.register(From)\n+instance.register(From, { base: upstream })\n \n t.plan(10)\n t.tearDown(instance.close.bind(instance))\n \n-const socketPath = `${__filename}.socket`\n-\n try {\n   fs.unlinkSync(socketPath)\n } catch (_) {\n@@ -37,7 +38,7 @@ const target = http.createServer((req, res) => {\n })\n \n instance.get('/', (request, reply) => {\n-  reply.from(`unix+http://${querystring.escape(socketPath)}/hello`)\n+  reply.from('hello')\n })\n \n t.tearDown(target.close.bind(target))"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 2,
        "unique_directories": 2,
        "max_directory_depth": 1
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "df1c3443ac551e0fd7c9d621c3564722c784654d",
            "date": "2025-01-11T12:04:19Z",
            "author_login": "Fdawgs"
          },
          {
            "sha": "17f63234c5c8d4104aaba1e0120796ab34fc83ae",
            "date": "2025-01-10T19:06:30Z",
            "author_login": "Fdawgs"
          },
          {
            "sha": "e6330d2968acfe32aab111ac424322b430435abb",
            "date": "2025-01-10T12:48:02Z",
            "author_login": "Fdawgs"
          },
          {
            "sha": "3be6c280681a6d0444503ad5a1fedd9eafafc6b1",
            "date": "2025-01-08T15:28:54Z",
            "author_login": "Fdawgs"
          },
          {
            "sha": "4e145d3fd251fe2d87092ce6a65e2db7be115b23",
            "date": "2025-01-07T20:38:11Z",
            "author_login": "Fdawgs"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 10.0,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:N",
    "cwe_id": "CWE-20",
    "description": "fastify-reply-from is an npm package which is a fastify plugin to forward the current http request to another server. In fastify-reply-from before version 4.0.2, by crafting a specific URL, it is possible to escape the prefix of the proxied backend service. If the base url of the proxied server is \"/pub/\", a user expect that accessing \"/priv\" on the target service would not be possible. In affected versions, it is possible. This is fixed in version 4.0.2.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2021-03-02T04:15:12.487",
    "last_modified": "2024-11-21T05:48:01.047",
    "fix_date": "2021-02-19T17:45:06Z"
  },
  "references": [
    {
      "url": "https://github.com/fastify/fastify-reply-from/commit/dea227dda606900cc01870d08541b4dcc69d3889",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/fastify/fastify-reply-from/security/advisories/GHSA-qmw8-3v4g-gwj4",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.npmjs.com/package/fastify-reply-from",
      "source": "security-advisories@github.com",
      "tags": [
        "Product",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/fastify/fastify-reply-from/commit/dea227dda606900cc01870d08541b4dcc69d3889",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/fastify/fastify-reply-from/security/advisories/GHSA-qmw8-3v4g-gwj4",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.npmjs.com/package/fastify-reply-from",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Product",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:01:16.815678",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "fastify-reply-from",
    "owner": "fastify",
    "created_at": "2017-12-25T10:58:57Z",
    "updated_at": "2025-01-11T12:04:30Z",
    "pushed_at": "2025-01-11T12:04:27Z",
    "size": 508,
    "stars": 152,
    "forks": 77,
    "open_issues": 8,
    "watchers": 152,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "master"
    ],
    "languages": {
      "JavaScript": 168288,
      "TypeScript": 4514
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-14T21:34:51.405025"
  }
}