{
  "cve_id": "CVE-2021-21323",
  "github_data": {
    "repository": "brave/brave-core",
    "fix_commit": "12fe321eaad8acc1cbd1d70b4128f687777bcf15",
    "related_commits": [
      "12fe321eaad8acc1cbd1d70b4128f687777bcf15",
      "12fe321eaad8acc1cbd1d70b4128f687777bcf15"
    ],
    "patch_url": "https://github.com/brave/brave-core/commit/12fe321eaad8acc1cbd1d70b4128f687777bcf15.patch",
    "fix_commit_details": {
      "sha": "12fe321eaad8acc1cbd1d70b4128f687777bcf15",
      "commit_date": "2021-02-04T21:32:48Z",
      "author": {
        "login": "darkdh",
        "type": "User",
        "stats": {
          "total_commits": 1254,
          "average_weekly_commits": 2.352720450281426,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 270
        }
      },
      "commit_message": {
        "title": "Merge pull request #7769 from brave/tor-dns-leak",
        "length": 66,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 31,
        "additions": 18,
        "deletions": 13
      },
      "files": [
        {
          "filename": "browser/net/BUILD.gn",
          "status": "modified",
          "additions": 2,
          "deletions": 4,
          "patch": "@@ -54,11 +54,11 @@ source_set(\"net\") {\n     \"//brave/components/brave_webtorrent/browser/buildflags\",\n     \"//brave/components/ipfs/buildflags\",\n     \"//brave/extensions:common\",\n+    \"//components/content_settings/core/browser\",\n     \"//components/prefs\",\n     \"//components/user_prefs\",\n     \"//content/public/browser\",\n     \"//content/public/common\",\n-    \"//components/content_settings/core/browser\",\n     \"//extensions/common:common_constants\",\n     \"//mojo/public/cpp/bindings\",\n     \"//mojo/public/cpp/system\",\n@@ -88,9 +88,7 @@ source_set(\"net\") {\n       \"brave_referrals_network_delegate_helper.h\",\n     ]\n \n-    deps += [\n-      \"//brave/components/brave_referrals/browser\",\n-    ]\n+    deps += [ \"//brave/components/brave_referrals/browser\" ]\n   }\n \n   if (enable_brave_webtorrent) {"
        },
        {
          "filename": "browser/net/brave_ad_block_tp_network_delegate_helper.cc",
          "status": "modified",
          "additions": 16,
          "deletions": 9,
          "patch": "@@ -65,26 +65,24 @@ void ShouldBlockAdOnTaskRunner(std::shared_ptr<BraveRequestInfo> ctx,\n   std::string source_host = ctx->initiator_url.host();\n \n   g_brave_browser_process->ad_block_service()->ShouldStartRequest(\n-        ctx->request_url, ctx->resource_type, source_host,\n-        &did_match_rule, &did_match_exception, &did_match_important,\n-        &ctx->mock_data_url);\n+      ctx->request_url, ctx->resource_type, source_host, &did_match_rule,\n+      &did_match_exception, &did_match_important, &ctx->mock_data_url);\n   if (did_match_important) {\n     ctx->blocked_by = kAdBlocked;\n     return;\n   }\n \n-  if (canonical_name.has_value() && ctx->request_url.host() != *canonical_name\n-      && *canonical_name != \"\") {\n+  if (canonical_name.has_value() &&\n+      ctx->request_url.host() != *canonical_name && *canonical_name != \"\") {\n     GURL::Replacements replacements = GURL::Replacements();\n     replacements.SetHost(\n         canonical_name->c_str(),\n         url::Component(0, static_cast<int>(canonical_name->length())));\n     const GURL canonical_url = ctx->request_url.ReplaceComponents(replacements);\n \n     g_brave_browser_process->ad_block_service()->ShouldStartRequest(\n-        ctx->request_url, ctx->resource_type, source_host,\n-        &did_match_rule, &did_match_exception, &did_match_important,\n-        &ctx->mock_data_url);\n+        ctx->request_url, ctx->resource_type, source_host, &did_match_rule,\n+        &did_match_exception, &did_match_important, &ctx->mock_data_url);\n   }\n \n   if (did_match_important || (did_match_rule && !did_match_exception)) {\n@@ -206,7 +204,16 @@ void OnBeforeURLRequestAdBlockTP(const ResponseCallback& next_callback,\n   scoped_refptr<base::SequencedTaskRunner> task_runner =\n       g_brave_browser_process->ad_block_service()->GetTaskRunner();\n \n-  new AdblockCnameResolveHostClient(std::move(next_callback), task_runner, ctx);\n+  DCHECK(ctx->browser_context);\n+  // DoH or standard DNS quries won't be routed through Tor, so we need to skip\n+  // it.\n+  if (ctx->browser_context->IsTor()) {\n+    ShouldBlockAdWithOptionalCname(task_runner, std::move(next_callback), ctx,\n+                                   base::nullopt);\n+  } else {\n+    new AdblockCnameResolveHostClient(std::move(next_callback), task_runner,\n+                                      ctx);\n+  }\n }\n \n int OnBeforeURLRequest_AdBlockTPPreWork(const ResponseCallback& next_callback,"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 1,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "f7d55ff1be6d798993d1084891da37af4a731b2d",
            "date": "2025-01-14T16:20:58Z",
            "author_login": "tmancey"
          },
          {
            "sha": "886363cccfee3d0d19418354fe0894e2fa676a57",
            "date": "2025-01-14T16:03:23Z",
            "author_login": "brave-builds"
          },
          {
            "sha": "77ee2c01e3084089e2dac9f7984ea32522e85732",
            "date": "2025-01-14T15:16:24Z",
            "author_login": "AlexeyBarabash"
          },
          {
            "sha": "8ab8a53a04cc8bf48aa5498fa89ad4c55734b001",
            "date": "2025-01-14T15:13:55Z",
            "author_login": "mherrmann"
          },
          {
            "sha": "6e696fcf0e74c48109b955dee8089d433582db24",
            "date": "2025-01-14T15:06:59Z",
            "author_login": "mherrmann"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 4.3,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:L/I:N/A:N",
    "cwe_id": "CWE-200",
    "description": "Brave is an open source web browser with a focus on privacy and security. In Brave versions 1.17.73-1.20.103, the CNAME adblocking feature added in Brave 1.17.73 accidentally initiated DNS requests that bypassed the Brave Tor proxy. Users with adblocking enabled would leak DNS requests from Tor windows to their DNS provider. (DNS requests that were not initiated by CNAME adblocking would go through Tor as expected.) This is fixed in Brave version 1.20.108",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2021-02-23T23:15:13.317",
    "last_modified": "2024-11-21T05:48:01.280",
    "fix_date": "2021-02-04T21:32:48Z"
  },
  "references": [
    {
      "url": "https://github.com/brave/brave-browser/issues/13527",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/brave/brave-browser/security/advisories/GHSA-mqjf-9x5g-2rv6",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/brave/brave-core/commit/12fe321eaad8acc1cbd1d70b4128f687777bcf15",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/brave/brave-core/pull/7769",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://hackerone.com/reports/1077022",
      "source": "security-advisories@github.com",
      "tags": [
        "Permissions Required",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/brave/brave-browser/issues/13527",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/brave/brave-browser/security/advisories/GHSA-mqjf-9x5g-2rv6",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/brave/brave-core/commit/12fe321eaad8acc1cbd1d70b4128f687777bcf15",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/brave/brave-core/pull/7769",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://hackerone.com/reports/1077022",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Permissions Required",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:01:16.805314",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "brave-core",
    "owner": "brave",
    "created_at": "2017-11-10T03:33:30Z",
    "updated_at": "2025-01-14T16:21:03Z",
    "pushed_at": "2025-01-14T16:20:59Z",
    "size": 3444770,
    "stars": 2542,
    "forks": 894,
    "open_issues": 233,
    "watchers": 2542,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "0.53.x",
      "0.54.x",
      "0.55.x",
      "0.56.x",
      "0.57.x",
      "0.58.x",
      "0.59.x",
      "0.60.x",
      "0.61.x",
      "0.62.x",
      "0.63.x",
      "0.64.x",
      "0.65.x",
      "0.66.x",
      "0.67.x",
      "0.68.x",
      "0.69.x",
      "0.70.x",
      "0.71.x",
      "0.72.x",
      "0.73.x",
      "1.0.x",
      "1.1.x",
      "1.2.x",
      "1.3.x",
      "1.4.x",
      "1.5.x"
    ],
    "languages": {
      "HTML": 35443155,
      "C++": 31337056,
      "Swift": 10041814,
      "TypeScript": 7425380,
      "Java": 4187275,
      "C": 1450874,
      "JavaScript": 1389751,
      "Objective-C++": 894217,
      "Python": 830483,
      "Rust": 566338,
      "Objective-C": 283142,
      "CSS": 132887,
      "SCSS": 49637,
      "Shell": 19438,
      "Jinja": 8990,
      "Roff": 8880,
      "Ruby": 7531,
      "PowerShell": 1506,
      "Batchfile": 416,
      "Makefile": 189
    },
    "commit_activity": {
      "total_commits_last_year": 8910,
      "avg_commits_per_week": 171.34615384615384,
      "days_active_last_year": 353
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "mpl-2.0"
    },
    "collected_at": "2025-01-14T16:23:59.810342"
  }
}