{
  "cve_id": "CVE-2021-21324",
  "github_data": {
    "repository": "glpi-project/glpi",
    "fix_commit": "aade65b7f67d46f23d276a8acb0df70651c3b1dc",
    "related_commits": [
      "aade65b7f67d46f23d276a8acb0df70651c3b1dc",
      "aade65b7f67d46f23d276a8acb0df70651c3b1dc"
    ],
    "patch_url": "https://github.com/glpi-project/glpi/commit/aade65b7f67d46f23d276a8acb0df70651c3b1dc.patch",
    "fix_commit_details": {
      "sha": "aade65b7f67d46f23d276a8acb0df70651c3b1dc",
      "commit_date": "2021-01-06T08:38:38Z",
      "author": {
        "login": "orthagh",
        "type": "User",
        "stats": {
          "total_commits": 1687,
          "average_weekly_commits": 1.5434583714547119,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 337
        }
      },
      "commit_message": {
        "title": "validate entity_restrict when available with idor tokens",
        "length": 56,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 44,
        "additions": 31,
        "deletions": 13
      },
      "files": [
        {
          "filename": "ajax/dropdownTrackingDeviceType.php",
          "status": "modified",
          "additions": 3,
          "deletions": 1,
          "patch": "@@ -76,7 +76,9 @@\n       'multiple'            => $_POST[\"multiple\"],\n       'myname'              => $_POST[\"myname\"],\n       'rand'                => $_POST[\"rand\"],\n-      '_idor_token'         => Session::getNewIDORToken($itemtype),\n+      '_idor_token'         => Session::getNewIDORToken($itemtype, [\n+         'entity_restrict' => $_POST['entity_restrict'],\n+      ]),\n    ];\n \n    if (isset($_POST[\"used\"]) && !empty($_POST[\"used\"])) {"
        },
        {
          "filename": "inc/computer_item.class.php",
          "status": "modified",
          "additions": 3,
          "deletions": 1,
          "patch": "@@ -682,7 +682,9 @@ static function dropdownConnect($itemtype, $fromtype, $myname, $entity_restrict\n          'itemtype'        => $itemtype,\n          'onlyglobal'      => $onlyglobal,\n          'used'            => $used,\n-         '_idor_token'     => Session::getNewIDORToken($itemtype),\n+         '_idor_token'     => Session::getNewIDORToken($itemtype, [\n+            'entity_restrict' => $entity_restrict,\n+         ]),\n       ];\n \n       echo Html::jsAjaxDropdown($myname, $field_id,"
        },
        {
          "filename": "inc/dropdown.class.php",
          "status": "modified",
          "additions": 9,
          "deletions": 7,
          "patch": "@@ -173,11 +173,13 @@ static function show($itemtype, $options = []) {\n             'condition'            => $params['condition'],\n             'used'                 => $params['used'],\n             'toadd'                => $params['toadd'],\n-            'entity_restrict'      => (is_array($params['entity']) ? json_encode(array_values($params['entity'])) : $params['entity']),\n+            'entity_restrict'      => ($entity_restrict = (is_array($params['entity']) ? json_encode(array_values($params['entity'])) : $params['entity'])),\n             'on_change'            => $params['on_change'],\n             'permit_select_parent' => $params['permit_select_parent'],\n             'specific_tags'        => $params['specific_tags'],\n-            '_idor_token'          => Session::getNewIDORToken($itemtype),\n+            '_idor_token'          => Session::getNewIDORToken($itemtype, [\n+               'entity_restrict' => $entity_restrict,\n+            ]),\n       ];\n \n       $output = \"<span class='no-wrap'>\";\n@@ -2182,6 +2184,11 @@ static function showListLimit($onchange = '', $display = true) {\n    public static function getDropdownValue($post, $json = true) {\n       global $DB, $CFG_GLPI;\n \n+      // check if asked itemtype is the one originaly requested by the form\n+      if (!Session::validateIDOR($post)) {\n+         return;\n+      }\n+\n       if (isset($post[\"entity_restrict\"])\n          && !is_array($post[\"entity_restrict\"])\n          && (substr($post[\"entity_restrict\"], 0, 1) === '[')\n@@ -2199,11 +2206,6 @@ public static function getDropdownValue($post, $json = true) {\n          $post['entity_restrict'] = $_SESSION['glpiactiveentities'];\n       }\n \n-      // check if asked itemtype is the one originaly requested by the form\n-      if (!Session::validateIDOR($post)) {\n-         return;\n-      }\n-\n       // Security\n       if (!($item = getItemForItemtype($post['itemtype']))) {\n          return;"
        },
        {
          "filename": "inc/user.class.php",
          "status": "modified",
          "additions": 5,
          "deletions": 2,
          "patch": "@@ -4026,9 +4026,12 @@ static function dropdown($options = []) {\n          'on_change'           => $p['on_change'],\n          'used'                => $p['used'],\n          'inactive_deleted'    => $p['inactive_deleted'],\n-         'entity_restrict'     => (is_array($p['entity']) ? json_encode(array_values($p['entity'])) : $p['entity']),\n+         'entity_restrict'     => ($entity_restrict = (is_array($p['entity']) ? json_encode(array_values($p['entity'])) : $p['entity'])),\n          'specific_tags'       => $p['specific_tags'],\n-         '_idor_token'         => Session::getNewIDORToken(__CLASS__, ['right' => $p['right']]),\n+         '_idor_token'         => Session::getNewIDORToken(__CLASS__, [\n+            'right'           => $p['right'],\n+            'entity_restrict' => $entity_restrict,\n+         ]),\n       ];\n \n       $output   = Html::jsAjaxDropdown($p['name'], $field_id,"
        },
        {
          "filename": "tests/functionnal/Dropdown.php",
          "status": "modified",
          "additions": 10,
          "deletions": 2,
          "patch": "@@ -765,7 +765,7 @@ public function testGetDropdownValue($params, $expected, $session_params = []) {\n          }\n       }\n \n-      $params['_idor_token'] = \\Session::getNewIDORToken($params['itemtype'] ?? '');\n+      $params['_idor_token'] = $this->generateIdor($params);\n \n       $result = \\Dropdown::getDropdownValue($params, false);\n \n@@ -928,7 +928,7 @@ public function testGetDropdownConnect($params, $expected, $session_params = [])\n          }\n       }\n \n-      $params['_idor_token'] = \\Session::getNewIDORToken($params['itemtype'] ?? '');\n+      $params['_idor_token'] = $this->generateIdor($params);\n \n       $result = \\Dropdown::getDropdownConnect($params, false);\n \n@@ -1331,4 +1331,12 @@ public function testGetDropdownValuePaginate() {\n             ->hasSize(2);\n \n    }\n+\n+   private function generateIdor(array $params = []) {\n+      $idor_add_params = [];\n+      if (isset($params['entity_restrict'])) {\n+         $idor_add_params['entity_restrict'] = $params['entity_restrict'];\n+      }\n+      return \\Session::getNewIDORToken(($params['itemtype'] ?? ''), $idor_add_params);\n+   }\n }"
        },
        {
          "filename": "tests/functionnal/Session.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -375,6 +375,7 @@ protected function idorProvider() {\n          ['itemtype' => 'Ticket'],\n          ['itemtype' => 'Glpi\\\\Dashboard\\\\Item'],\n          ['itemtype' => 'User', 'add_params' => ['right' => 'all']],\n+         ['itemtype' => 'User', 'add_params' => ['entity_restrict' => 0]],\n       ];\n    }\n "
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 2,
        "unique_directories": 3,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "ec0e2a11b56e8ef9d1d28f503a363e4ba64fd4ab",
            "date": "2025-01-14T16:55:01Z",
            "author_login": "ccailly"
          },
          {
            "sha": "50989595d9386f3eed353125d7a693ef1241b517",
            "date": "2025-01-14T15:16:58Z",
            "author_login": "cconard96"
          },
          {
            "sha": "515f37f98fdfc8fdc1eb2f090252b2f3af1fdfa4",
            "date": "2025-01-14T14:43:36Z",
            "author_login": "ccailly"
          },
          {
            "sha": "9869867f24c899d79e4675ad93131bbb2cba53a2",
            "date": "2025-01-14T14:39:56Z",
            "author_login": "ccailly"
          },
          {
            "sha": "4b9fbaea0bb355b49990ee51c690fed5e7302443",
            "date": "2025-01-14T13:22:29Z",
            "author_login": "SebSept"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.8,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:H/I:N/A:N",
    "cwe_id": "CWE-639",
    "description": "GLPI is an open-source asset and IT management software package that provides ITIL Service Desk features, licenses tracking and software auditing. In GLPI before version 9.5.4 there is an Insecure Direct Object Reference (IDOR) on \"Solutions\". This vulnerability gives an unauthorized user the ability to enumerate GLPI items names (including users logins) using the knowbase search form (requires authentication). To Reproduce: Perform a valid authentication at your GLPI instance, Browse the ticket list and select any open ticket, click on Solution form, then Search a solution form that will redirect you to the endpoint /\"glpi/front/knowbaseitem.php?item_itemtype=Ticket&item_items_id=18&forcetab=Knowbase$1\", and the item_itemtype=Ticket parameter present in the previous URL will point to the PHP alias of glpi_tickets table, so just replace it with \"Users\" to point to glpi_users table instead; in the same way, item_items_id=18 will point to the related column id, so changing it too you should be able to enumerate all the content which has an alias. Since such id(s) are obviously incremental, a malicious party could exploit the vulnerability simply by guessing-based attempts.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2021-03-08T17:15:12.757",
    "last_modified": "2024-11-21T05:48:01.410",
    "fix_date": "2021-01-06T08:38:38Z"
  },
  "references": [
    {
      "url": "https://github.com/glpi-project/glpi/commit/aade65b7f67d46f23d276a8acb0df70651c3b1dc",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/glpi-project/glpi/releases/tag/9.5.4",
      "source": "security-advisories@github.com",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/glpi-project/glpi/security/advisories/GHSA-jvwm-gq36-3v7v",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/glpi-project/glpi/commit/aade65b7f67d46f23d276a8acb0df70651c3b1dc",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/glpi-project/glpi/releases/tag/9.5.4",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/glpi-project/glpi/security/advisories/GHSA-jvwm-gq36-3v7v",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:01:16.824606",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "glpi",
    "owner": "glpi-project",
    "created_at": "2015-07-16T07:20:21Z",
    "updated_at": "2025-01-14T12:00:43Z",
    "pushed_at": "2025-01-14T12:00:37Z",
    "size": 864638,
    "stars": 4447,
    "forks": 1324,
    "open_issues": 223,
    "watchers": 4447,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [
      "0.70/bugfixes",
      "0.71/bugfixes",
      "0.72/bugfixes",
      "0.78/bugfixes",
      "0.80/bugfixes",
      "0.83/bugfixes",
      "0.84/bugfixes",
      "0.85/bugfixes",
      "0.90/bugfixes",
      "9.1/bugfixes",
      "9.2/bugfixes",
      "9.3/bugfixes",
      "9.4/bugfixes",
      "9.5/bugfixes",
      "10.0/bugfixes",
      "main"
    ],
    "languages": {
      "PHP": 24867216,
      "Twig": 1834187,
      "JavaScript": 1339721,
      "SCSS": 362786,
      "Vue": 188168,
      "Shell": 24779,
      "Makefile": 2692,
      "CSS": 1716,
      "Dockerfile": 638
    },
    "commit_activity": {
      "total_commits_last_year": 1737,
      "avg_commits_per_week": 33.40384615384615,
      "days_active_last_year": 259
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "gpl-3.0"
    },
    "collected_at": "2025-01-14T13:16:26.208966"
  }
}