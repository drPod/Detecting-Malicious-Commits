{
  "cve_id": "CVE-2021-22567",
  "github_data": {
    "repository": "dart-lang/sdk",
    "fix_commit": "52519ea8eb4780c468c4c2ed00e7c8046ccfed41",
    "related_commits": [
      "52519ea8eb4780c468c4c2ed00e7c8046ccfed41",
      "52519ea8eb4780c468c4c2ed00e7c8046ccfed41"
    ],
    "patch_url": "https://github.com/dart-lang/sdk/commit/52519ea8eb4780c468c4c2ed00e7c8046ccfed41.patch",
    "fix_commit_details": {
      "sha": "52519ea8eb4780c468c4c2ed00e7c8046ccfed41",
      "commit_date": "2021-11-17T10:39:23Z",
      "author": {
        "login": "athomas",
        "type": "User",
        "stats": {
          "total_commits": 764,
          "average_weekly_commits": 1.100864553314121,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 256
        }
      },
      "commit_message": {
        "title": "Version 2.15.0-268.18.beta",
        "length": 657,
        "has_description": true,
        "references_issue": false
      },
      "stats": {
        "total": 1247,
        "additions": 898,
        "deletions": 349
      },
      "files": [
        {
          "filename": "CHANGELOG.md",
          "status": "modified",
          "additions": 35,
          "deletions": 144,
          "patch": "@@ -2,14 +2,18 @@\n \n ### Language\n \n-- **[Constructor tearoffs][]**: **BETA PREVIEW**\n+The following features are new in the Dart 2.15 [language version][]. To use\n+them, you must set the lower bound on the SDK constraint for your package to\n+2.15 or greater (`sdk: '>=2.15.0 <3.0.0'`).\n \n-  Previous Dart versions allowed a method on an instance to be passed as a\n-  closure, and similarly for static methods. This is commonly referred to as\n-  \"closurizing\" or \"tearing off\" a method. Constructors were not previously\n-  eligible for closurization, forcing users to explicitly write wrapper\n-  functions when using constructors as first class functions, as in the calls to\n-  `List.map` in the following example:\n+[language version]: https://dart.dev/guides/language/evolution\n+\n+- **[Constructor tear-offs][]**: Previous Dart versions allowed a method on an\n+  instance to be passed as a closure, and similarly for static methods. This is\n+  commonly referred to as \"closurizing\" or \"tearing off\" a method. Constructors\n+  were not previously eligible for closurization, forcing users to explicitly\n+  write wrapper functions when using constructors as first class functions, as\n+  in the calls to `map()` in the following example:\n \n   ```dart\n   class A {\n@@ -55,10 +59,10 @@\n   ```\n \n   Constructors for generic classes may be torn off as generic functions, or\n-  instantiated at the tear off site. So in the following code, the tear off\n+  instantiated at the tear-off site. So in the following code, the tear-off\n   `G.new` used to initialize the variable `f` produces a generic function which\n   may be used to produce an instance of `G<T>` for any type `T` provided when\n-  `f` is called. The tear off `G<String>.new` used to initialize the variable\n+  `f` is called. The tear-off `G<String>.new` used to initialize the variable\n   `g` on the other hand produces a non-generic function which may only be used\n   to produce instances of type `G<String>`.\n \n@@ -76,27 +80,14 @@\n   }\n   ```\n \n-  The new constructor tearoff feature is currently in **BETA PREVIEW**. The\n-  feature is enabled in beta releases only, and is still subject to breaking\n-  changes. It is not fully supported by all tools and there may be known issues\n-  with the tool support. Feedback on the feature is welcome, but it is not\n-  recommended that production code use the feature until it has been released in\n-  a stable version.\n-\n-  The new constructor tearoff feature is only available as part of the 2.15\n-  [language version](https://dart.dev/guides/language/evolution). To use this\n-  feature, you must set the lower bound on the sdk constraint for your package\n-  to 2.15 or greater (if using a beta preview release, an sdk constraint of\n-  `>=2.15.0-0` must be used).\n-\n-- **[Generic type literals][Explicit instantiation]**: **BETA PREVIEW**\n+[constructor tear-offs]: https://github.com/dart-lang/language/blob/master/accepted/future-releases/constructor-tearoffs/feature-specification.md\n \n-  Previous Dart versions allowed class names to be used as type literals. So\n-  for example,`int` may be used as an expression, producing a value of type\n-  `Type`. Generic classes (e.g. `List`) could be referred to by name as an\n-  expression, but no type arguments could be provided and so only the `dynamic`\n-  instantiation could be produced directly as an expression without using\n-  indirect methods:\n+- **[Generic type literals][explicit instantiation]**: Previous Dart versions\n+  allowed class names to be used as type literals. So for example,`int` may be\n+  used as an expression, producing a value of type `Type`. Generic classes (e.g.\n+  `List`) could be referred to by name as an expression, but no type arguments\n+  could be provided and so only the `dynamic` instantiation could be produced\n+  directly as an expression without using indirect methods:\n \n   ```dart\n   // Workaround to capture generic type literals.\n@@ -121,23 +112,9 @@\n   }\n   ```\n \n-  The new generic type literal feature is currently in **BETA PREVIEW**. The\n-  feature is enabled in beta releases only, and is still subject to breaking\n-  changes. It is not fully supported by all tools and there may be known issues\n-  with the tool support. Feedback on the feature is welcome, but it is not\n-  recommended that production code use the feature until it has been released in\n-  a stable version.\n-\n-  Generic type literals are only available as part of the 2.15 [language\n-  version](https://dart.dev/guides/language/evolution). To use this feature, you\n-  must set the lower bound on the sdk constraint for your package to 2.15 or\n-  greater (if using a beta preview release, an sdk constraint of\n-  `>=2.15.0-0` must be used).\n-\n-- **[Explicit generic method instantiations][Explicit instantiation]**: **BETA PREVIEW**\n-\n-  Previous Dart versions allowed generic methods to be implicitly specialized\n-  (or \"instantiated\") to non-generic versions when assigned to a location with a\n+- **[Explicit generic method instantiations][explicit instantiation]**: Previous\n+  Dart versions allowed generic methods to be implicitly specialized (or\n+  \"instantiated\") to non-generic versions when assigned to a location with a\n   compatible monomorphic type. Example:\n \n   ```dart\n@@ -177,30 +154,12 @@\n   }\n   ```\n \n-  The new generic method instantation feature is currently in **BETA PREVIEW**.\n-  The feature is enabled in beta releases only, and is still subject to breaking\n-  changes. It is not fully supported by all tools and there may be known issues\n-  with the tool support. Feedback on the feature is welcome, but it is not\n-  recommended that production code use the feature until it has been released in\n-  a stable version.\n+[explicit instantiation]: https://github.com/dart-lang/language/blob/master/accepted/future-releases/constructor-tearoffs/feature-specification.md#explicitly-instantiated-classes-and-functions\n \n-  Explicit generic method instantiations are only available as part of the 2.15\n-  [language version](https://dart.dev/guides/language/evolution). To use this\n-  feature, you must set the lower bound on the sdk constraint for your package\n-  to 2.15 or greater (if using a beta preview release, an sdk constraint of\n-  `>=2.15.0-0` must be used).\n-\n-  [Constructor tearoffs]:\n-        https://github.com/dart-lang/language/blob/master/accepted/future-releases/constructor-tearoffs/feature-specification.md\n-\n-  [Explicit instantiation]:\n-        https://github.com/dart-lang/language/blob/master/accepted/future-releases/constructor-tearoffs/feature-specification.md#explicitly-instantiated-classes-and-functions\n-\n-- **[Generic instantiation of function objects][Object instantiation]**: **BETA PREVIEW**\n-\n-  Generic function instantiation was previously restricted to function\n-  declarations. For example, as soon as a function had already been torn\n-  off, it could not be instantiated:\n+- **[Generic instantiation of function objects][object instantiation]**: Generic\n+  function instantiation was previously restricted to function declarations. For\n+  example, as soon as a function had already been torn off, it could not be\n+  instantiated:\n \n   ```dart\n   X id<X>(X x) => x;\n@@ -240,19 +199,6 @@\n   }\n   ```\n \n-  The new generic instantation of objects feature is currently in **BETA\n-  PREVIEW**. The feature is enabled in beta releases only, and is still subject\n-  to breaking changes. It is not fully supported by all tools and there may be\n-  known issues with the tool support. Feedback on the feature is welcome, but it\n-  is not recommended that production code use the feature until it has been\n-  released in a stable version.\n-\n-  Generic instantiation of objects is only available as part of the 2.15\n-  [language version](https://dart.dev/guides/language/evolution). To use this\n-  feature, you must set the lower bound on the sdk constraint for your package\n-  to 2.15 or greater (if using a beta preview release, an sdk constraint of\n-  `>=2.15.0-0` must be used).\n-\n [Object instantiation]: https://github.com/dart-lang/language/pull/1812\n \n - Annotations on type parameters of classes can no longer refer to class members\n@@ -282,7 +228,7 @@\n   f(int? i) {\n     var iIsNull = i == null;\n     if (!iIsNull) {\n-      print(i + 1); // OK, because `i` is known to be non-null\n+      print(i + 1); // OK, because `i` is known to be non-null.\n     }\n   }\n   ```\n@@ -293,7 +239,7 @@\n   lacked an explicit type.\n \n   To avoid causing problems for packages that are intended to work with older\n-  versions of Dart, the fix only takes effect when the \"constructor tearoffs\"\n+  versions of Dart, the fix only takes effect when the \"constructor tear-offs\"\n   language feature is enabled.\n \n [#1785]: https://github.com/dart-lang/language/issues/1785\n@@ -324,72 +270,17 @@\n   instance variable, and it brings the implementation behavior in line with\n   the specification in all other cases.\n \n-- **Function object canonicalization and equality**\n-\n-  Several corner cases in the area of function object canonicalization and\n-  function object equality have been updated, such that all tools behave in\n-  the same way, and the behavior matches the specification.\n+- **Function object canonicalization and equality**: Several corner cases in the\n+  area of function object canonicalization and function object equality have\n+  been updated, such that all tools behave in the same way, and the behavior\n+  matches the specification.\n \n   In particular, function objects are now equal when they are obtained by\n   generic instantiation from the same function with the same actual type\n   arguments, even when that type argument is not known at compile time.\n   When the expressions are constant then said function objects are identical.\n   Constant expressions are treated as such even when they do not occur in a\n-  constant context (e.g., `var f = top;`). Here are the main cases where the\n-  behavior has been adjusted:\n-\n-  ```dart\n-  void top() {}\n-  X? genericTop<X>() => null;\n-\n-  class A {\n-    static void stat() {}\n-    static X? genericStat<X>() => null;\n-    void inst() {}\n-    X? genericInst<X>() => null;\n-  }\n-\n-  const int? Function() cIntTop1 = genericTop;\n-  const int? Function() cIntStat1 = A.genericStat;\n-\n-  int? Function() vIntTop1 = genericTop;\n-  int? Function() vIntStat1 = A.genericStat;\n-  int? Function() vIntTop2 = genericTop;\n-  int? Function() vIntStat2 = A.genericStat;\n-\n-  String? Function() vStringTop = genericTop;\n-  String? Function() vStringStat = A.genericStat;\n-\n-  void main() {\n-    var a = A();\n-    int? Function() vIntInst1 = a.genericInst;\n-    int? Function() vIntInst2 = a.genericInst;\n-\n-    // All true (used to be false).\n-    identical(cIntTop1, vIntTop2);\n-    identical(cIntStat1, vIntStat2);\n-    identical(vIntTop1, vIntTop2);\n-    identical(vIntStat1, vIntStat2);\n-    vIntInst1 == vIntInst2;\n-\n-    <X>() {\n-      X? Function() vXTop1 = genericTop;\n-      X? Function() vXStat1 = A.genericStat;\n-      X? Function() vXTop2 = genericTop;\n-      X? Function() vXStat2 = A.genericStat;\n-      X? Function() vXInst1 = a.genericInst;\n-      X? Function() vXInst2 = a.genericInst;\n-\n-      // All true (used to be false).\n-      vXTop1 == vXTop2;\n-      vXStat1 == vXStat2;\n-      vXInst1 == vXInst2;\n-      vXTop1 == vIntTop1;\n-      vXStat1 == vIntStat1;\n-      vXInst1 == vIntInst2;\n-    }<int>();\n-  }\n-  ```\n+  constant context (e.g., `var f = top;`).\n \n ### Core libraries\n "
        },
        {
          "filename": "pkg/_fe_analyzer_shared/lib/src/messages/codes_generated.dart",
          "status": "modified",
          "additions": 0,
          "deletions": 42,
          "patch": "@@ -3271,48 +3271,6 @@ Message _withArgumentsExperimentNotEnabled(String string, String string2) {\n       arguments: {'string': string, 'string2': string2});\n }\n \n-// DO NOT EDIT. THIS FILE IS GENERATED. SEE TOP OF FILE.\n-const Code<Null> codeExperimentNotEnabledNoFlag =\n-    messageExperimentNotEnabledNoFlag;\n-\n-// DO NOT EDIT. THIS FILE IS GENERATED. SEE TOP OF FILE.\n-const MessageCode messageExperimentNotEnabledNoFlag = const MessageCode(\n-    \"ExperimentNotEnabledNoFlag\",\n-    analyzerCodes: <String>[\"ParserErrorCode.EXPERIMENT_NOT_ENABLED\"],\n-    problemMessage:\n-        r\"\"\"This requires the null safety language feature, which is experimental.\"\"\",\n-    correctionMessage:\n-        r\"\"\"You can enable the experiment using the '--enable-experiment=non-nullable' command line option.\"\"\");\n-\n-// DO NOT EDIT. THIS FILE IS GENERATED. SEE TOP OF FILE.\n-const Template<Message Function(String string2)>\n-    templateExperimentNotEnabledNoFlagInvalidLanguageVersion =\n-    const Template<Message Function(String string2)>(\n-        problemMessageTemplate:\n-            r\"\"\"This requires the null safety language feature, which is experimental and requires language version of #string2 or higher.\"\"\",\n-        correctionMessageTemplate:\n-            r\"\"\"You can enable the experiment using the '--enable-experiment=non-nullable' command line option.\"\"\",\n-        withArguments:\n-            _withArgumentsExperimentNotEnabledNoFlagInvalidLanguageVersion);\n-\n-// DO NOT EDIT. THIS FILE IS GENERATED. SEE TOP OF FILE.\n-const Code<Message Function(String string2)>\n-    codeExperimentNotEnabledNoFlagInvalidLanguageVersion =\n-    const Code<Message Function(String string2)>(\n-        \"ExperimentNotEnabledNoFlagInvalidLanguageVersion\",\n-        analyzerCodes: <String>[\"ParserErrorCode.EXPERIMENT_NOT_ENABLED\"]);\n-\n-// DO NOT EDIT. THIS FILE IS GENERATED. SEE TOP OF FILE.\n-Message _withArgumentsExperimentNotEnabledNoFlagInvalidLanguageVersion(\n-    String string2) {\n-  if (string2.isEmpty) throw 'No string provided';\n-  return new Message(codeExperimentNotEnabledNoFlagInvalidLanguageVersion,\n-      problemMessage:\n-          \"\"\"This requires the null safety language feature, which is experimental and requires language version of ${string2} or higher.\"\"\",\n-      correctionMessage: \"\"\"You can enable the experiment using the '--enable-experiment=non-nullable' command line option.\"\"\",\n-      arguments: {'string2': string2});\n-}\n-\n // DO NOT EDIT. THIS FILE IS GENERATED. SEE TOP OF FILE.\n const Code<Null> codeExplicitExtensionArgumentMismatch =\n     messageExplicitExtensionArgumentMismatch;"
        },
        {
          "filename": "pkg/analyzer/lib/error/error.dart",
          "status": "modified",
          "additions": 2,
          "deletions": 0,
          "patch": "@@ -632,6 +632,8 @@ const List<ErrorCode> errorCodeValues = [\n   HintCode.UNNECESSARY_QUESTION_MARK,\n   HintCode.UNNECESSARY_TYPE_CHECK_FALSE,\n   HintCode.UNNECESSARY_TYPE_CHECK_TRUE,\n+  HintCode.TEXT_DIRECTION_CODE_POINT_IN_COMMENT,\n+  HintCode.TEXT_DIRECTION_CODE_POINT_IN_LITERAL,\n   HintCode.UNUSED_CATCH_CLAUSE,\n   HintCode.UNUSED_CATCH_STACK,\n   HintCode.UNUSED_ELEMENT,"
        },
        {
          "filename": "pkg/analyzer/lib/src/dart/analysis/library_analyzer.dart",
          "status": "modified",
          "additions": 3,
          "deletions": 0,
          "patch": "@@ -33,6 +33,7 @@ import 'package:analyzer/src/error/inheritance_override.dart';\n import 'package:analyzer/src/error/language_version_override_verifier.dart';\n import 'package:analyzer/src/error/override_verifier.dart';\n import 'package:analyzer/src/error/todo_finder.dart';\n+import 'package:analyzer/src/error/unicode_text_verifier.dart';\n import 'package:analyzer/src/error/unused_local_elements_verifier.dart';\n import 'package:analyzer/src/generated/declaration_resolver.dart';\n import 'package:analyzer/src/generated/engine.dart';\n@@ -259,6 +260,8 @@ class LibraryAnalyzer {\n       );\n     }\n \n+    UnicodeTextVerifier(errorReporter).verify(unit, file.content);\n+\n     unit.accept(DeadCodeVerifier(errorReporter));\n \n     unit.accept("
        },
        {
          "filename": "pkg/analyzer/lib/src/dart/error/hint_codes.g.dart",
          "status": "modified",
          "additions": 86,
          "deletions": 0,
          "patch": "@@ -2913,6 +2913,92 @@ class HintCode extends AnalyzerErrorCode {\n     hasPublishedDocs: true,\n   );\n \n+  /**\n+   * Parameters:\n+   * 0: the unicode sequence of the code point.\n+   */\n+  // #### Description\n+  //\n+  // The analyzer produces this diagnostic when it encounters source that\n+  // contains text direction Unicode code points. These code points cause\n+  // source code in either a string literal or a comment to be interpreted\n+  // and compiled differently than how it appears in editors, leading to\n+  // possible security vulnerabilities.\n+  //\n+  // #### Example\n+  //\n+  // The following code produces this diagnostic twice because there are\n+  // hidden characters at the start and end of the label string:\n+  //\n+  // ```dart\n+  // var label = '[!I!]nteractive text[!'!];\n+  // ```\n+  //\n+  // #### Common fixes\n+  //\n+  // If the code points are intended to be included in the string literal,\n+  // then escape them:\n+  //\n+  // ```dart\n+  // var label = '\\u202AInteractive text\\u202C';\n+  // ```\n+  //\n+  // If the code points aren't intended to be included in the string literal,\n+  // then remove them:\n+  //\n+  // ```dart\n+  // var label = 'Interactive text';\n+  // ```\n+  static const HintCode TEXT_DIRECTION_CODE_POINT_IN_COMMENT = HintCode(\n+    'TEXT_DIRECTION_CODE_POINT_IN_COMMENT',\n+    \"The Unicode code point 'U+{0}' changes the appearance of text from how it's interpreted by the compiler.\",\n+    correctionMessage:\n+        \"Try removing the code point or using the Unicode escape sequence '\\\\u{0}'.\",\n+  );\n+\n+  /**\n+   * Parameters:\n+   * 0: the unicode sequence of the code point.\n+   */\n+  // #### Description\n+  //\n+  // The analyzer produces this diagnostic when it encounters source that\n+  // contains text direction Unicode code points. These code points cause\n+  // source code in either a string literal or a comment to be interpreted\n+  // and compiled differently than how it appears in editors, leading to\n+  // possible security vulnerabilities.\n+  //\n+  // #### Example\n+  //\n+  // The following code produces this diagnostic twice because there are\n+  // hidden characters at the start and end of the label string:\n+  //\n+  // ```dart\n+  // var label = '[!I!]nteractive text[!'!];\n+  // ```\n+  //\n+  // #### Common fixes\n+  //\n+  // If the code points are intended to be included in the string literal,\n+  // then escape them:\n+  //\n+  // ```dart\n+  // var label = '\\u202AInteractive text\\u202C';\n+  // ```\n+  //\n+  // If the code points aren't intended to be included in the string literal,\n+  // then remove them:\n+  //\n+  // ```dart\n+  // var label = 'Interactive text';\n+  // ```\n+  static const HintCode TEXT_DIRECTION_CODE_POINT_IN_LITERAL = HintCode(\n+    'TEXT_DIRECTION_CODE_POINT_IN_LITERAL',\n+    \"The Unicode code point 'U+{0}' changes the appearance of text from how it's interpreted by the compiler.\",\n+    correctionMessage:\n+        \"Try removing the code point or using the Unicode escape sequence '\\\\u{0}'.\",\n+  );\n+\n   /**\n    * No parameters.\n    */"
        },
        {
          "filename": "pkg/analyzer/lib/src/dart/micro/library_analyzer.dart",
          "status": "modified",
          "additions": 3,
          "deletions": 0,
          "patch": "@@ -31,6 +31,7 @@ import 'package:analyzer/src/error/imports_verifier.dart';\n import 'package:analyzer/src/error/inheritance_override.dart';\n import 'package:analyzer/src/error/override_verifier.dart';\n import 'package:analyzer/src/error/todo_finder.dart';\n+import 'package:analyzer/src/error/unicode_text_verifier.dart';\n import 'package:analyzer/src/error/unused_local_elements_verifier.dart';\n import 'package:analyzer/src/generated/declaration_resolver.dart';\n import 'package:analyzer/src/generated/engine.dart';\n@@ -270,6 +271,8 @@ class LibraryAnalyzer {\n     unit.accept(DeadCodeVerifier(errorReporter));\n \n     var content = getFileContent(file);\n+    UnicodeTextVerifier(errorReporter).verify(unit, content);\n+\n     unit.accept(\n       BestPracticesVerifier(\n         errorReporter,"
        },
        {
          "filename": "pkg/analyzer/lib/src/error/unicode_text_verifier.dart",
          "status": "added",
          "additions": 37,
          "deletions": 0,
          "patch": "@@ -0,0 +1,37 @@\n+// Copyright (c) 2021, the Dart project authors. Please see the AUTHORS file\n+// for details. All rights reserved. Use of this source code is governed by a\n+// BSD-style license that can be found in the LICENSE file.\n+\n+import 'package:analyzer/dart/ast/ast.dart';\n+import 'package:analyzer/error/listener.dart';\n+import 'package:analyzer/src/dart/ast/utilities.dart';\n+import 'package:analyzer/src/error/codes.dart';\n+\n+/// A verifier that checks for unsafe Unicode text.\n+/// todo(pq): update w/ a Dart CVE link once published\n+class UnicodeTextVerifier {\n+  final ErrorReporter errorReporter;\n+  UnicodeTextVerifier(this.errorReporter);\n+\n+  void verify(CompilationUnit unit, String source) {\n+    for (var offset = 0; offset < source.length; ++offset) {\n+      var codeUnit = source.codeUnitAt(offset);\n+      // U+202A, U+202B, U+202C, U+202D, U+202E, U+2066, U+2067, U+2068, U+2069.\n+      if (0x202a <= codeUnit &&\n+          codeUnit <= 0x2069 &&\n+          (codeUnit <= 0x202e || 0x2066 <= codeUnit)) {\n+        // This uses an AST visitor; consider a more direct approach.\n+        var node = NodeLocator(offset).searchWithin(unit);\n+        // If it's not in a string literal, we assume we're in a comment.\n+        // This can potentially over-report on syntactically incorrect sources\n+        // (where Unicode is outside a string or comment).\n+        var errorCode =\n+            node is SimpleStringLiteral || node is InterpolationString\n+                ? HintCode.TEXT_DIRECTION_CODE_POINT_IN_LITERAL\n+                : HintCode.TEXT_DIRECTION_CODE_POINT_IN_COMMENT;\n+        var code = codeUnit.toRadixString(16).toUpperCase();\n+        errorReporter.reportErrorForOffset(errorCode, offset, 1, [code]);\n+      }\n+    }\n+  }\n+}"
        },
        {
          "filename": "pkg/analyzer/messages.yaml",
          "status": "modified",
          "additions": 80,
          "deletions": 0,
          "patch": "@@ -16446,6 +16446,86 @@ HintCode:\n       If the class needs to be a subtype of the sealed class, then either change\n       the sealed class so that it's no longer sealed or move the subclass into\n       the same package as the sealed class.\n+  TEXT_DIRECTION_CODE_POINT_IN_COMMENT:\n+    problemMessage: The Unicode code point 'U+{0}' changes the appearance of text from how it's interpreted by the compiler.\n+    correctionMessage: Try removing the code point or using the Unicode escape sequence '\\u{0}'.\n+    hasPublishedDocs: false\n+    comment: |-\n+      Parameters:\n+      0: the unicode sequence of the code point.\n+    documentation: |-\n+      #### Description\n+\n+      The analyzer produces this diagnostic when it encounters source that\n+      contains text direction Unicode code points. These code points cause\n+      source code in either a string literal or a comment to be interpreted\n+      and compiled differently than how it appears in editors, leading to\n+      possible security vulnerabilities.\n+\n+      #### Example\n+\n+      The following code produces this diagnostic twice because there are\n+      hidden characters at the start and end of the label string:\n+\n+      ```dart\n+      var label = '[!I!]nteractive text[!'!];\n+      ```\n+\n+      #### Common fixes\n+\n+      If the code points are intended to be included in the string literal,\n+      then escape them:\n+\n+      ```dart\n+      var label = '\\u202AInteractive text\\u202C';\n+      ```\n+\n+      If the code points aren't intended to be included in the string literal,\n+      then remove them:\n+\n+      ```dart\n+      var label = 'Interactive text';\n+      ```\n+  TEXT_DIRECTION_CODE_POINT_IN_LITERAL:\n+    problemMessage: The Unicode code point 'U+{0}' changes the appearance of text from how it's interpreted by the compiler.\n+    correctionMessage: Try removing the code point or using the Unicode escape sequence '\\u{0}'.\n+    hasPublishedDocs: false\n+    comment: |-\n+      Parameters:\n+      0: the unicode sequence of the code point.\n+    documentation: |-\n+      #### Description\n+\n+      The analyzer produces this diagnostic when it encounters source that\n+      contains text direction Unicode code points. These code points cause\n+      source code in either a string literal or a comment to be interpreted\n+      and compiled differently than how it appears in editors, leading to\n+      possible security vulnerabilities.\n+\n+      #### Example\n+\n+      The following code produces this diagnostic twice because there are\n+      hidden characters at the start and end of the label string:\n+\n+      ```dart\n+      var label = '[!I!]nteractive text[!'!];\n+      ```\n+\n+      #### Common fixes\n+\n+      If the code points are intended to be included in the string literal,\n+      then escape them:\n+\n+      ```dart\n+      var label = '\\u202AInteractive text\\u202C';\n+      ```\n+\n+      If the code points aren't intended to be included in the string literal,\n+      then remove them:\n+\n+      ```dart\n+      var label = 'Interactive text';\n+      ```\n   TYPE_CHECK_IS_NOT_NULL:\n     sharedName: TYPE_CHECK_WITH_NULL\n     problemMessage: \"Tests for non-null should be done with '!= null'.\""
        },
        {
          "filename": "pkg/analyzer/test/src/diagnostics/test_all.dart",
          "status": "modified",
          "additions": 2,
          "deletions": 0,
          "patch": "@@ -630,6 +630,7 @@ import 'switch_expression_not_assignable_test.dart'\n     as switch_expression_not_assignable;\n import 'tearoff_of_generative_constructor_of_abstract_class_test.dart'\n     as tearoff_of_generative_constructor_of_abstract_class;\n+import 'text_direction_code_point_test.dart' as text_direction_code_point;\n import 'throw_of_invalid_type_test.dart' as throw_of_invalid_type;\n import 'todo_test.dart' as todo_test;\n import 'top_level_cycle_test.dart' as top_level_cycle;\n@@ -1132,6 +1133,7 @@ main() {\n     switch_case_completes_normally.main();\n     switch_expression_not_assignable.main();\n     tearoff_of_generative_constructor_of_abstract_class.main();\n+    text_direction_code_point.main();\n     throw_of_invalid_type.main();\n     todo_test.main();\n     top_level_cycle.main();"
        },
        {
          "filename": "pkg/analyzer/test/src/diagnostics/text_direction_code_point_test.dart",
          "status": "added",
          "additions": 92,
          "deletions": 0,
          "patch": "@@ -0,0 +1,92 @@\n+// Copyright (c) 2021, the Dart project authors. Please see the AUTHORS file\n+// for details. All rights reserved. Use of this source code is governed by a\n+// BSD-style license that can be found in the LICENSE file.\n+\n+import 'package:analyzer/src/dart/error/hint_codes.dart';\n+import 'package:test_reflective_loader/test_reflective_loader.dart';\n+\n+import '../dart/resolution/context_collection_resolution.dart';\n+\n+main() {\n+  defineReflectiveSuite(() {\n+    defineReflectiveTests(UnsafeTextDirectionCodepointTest);\n+  });\n+}\n+\n+@reflectiveTest\n+class UnsafeTextDirectionCodepointTest extends PubPackageResolutionTest {\n+  test_comments() async {\n+    await assertErrorsInCode('''\n+// \\u2066\n+/// \\u2066\n+void f() { // \\u2066\n+  // \\u2066\n+}\n+''', [\n+      error(HintCode.TEXT_DIRECTION_CODE_POINT_IN_COMMENT, 3, 1),\n+      error(HintCode.TEXT_DIRECTION_CODE_POINT_IN_COMMENT, 9, 1),\n+      error(HintCode.TEXT_DIRECTION_CODE_POINT_IN_COMMENT, 25, 1),\n+      error(HintCode.TEXT_DIRECTION_CODE_POINT_IN_COMMENT, 32, 1),\n+    ]);\n+  }\n+\n+  /// https://github.com/flutter/flutter/pull/93029\n+  test_file_ok() async {\n+    // Raw strings preserve the escapes.\n+    await assertNoErrorsInCode(r'''\n+var u202a = '\\u202AInteractive text\\u202C';\n+''');\n+  }\n+\n+  test_message_escape() async {\n+    await assertErrorsInCode('''\n+var u202a = '\\u202A';\n+''', [\n+      error(HintCode.TEXT_DIRECTION_CODE_POINT_IN_LITERAL, 13, 1,\n+          messageContains: ['U+202A']),\n+    ]);\n+  }\n+\n+  test_multiLineString() async {\n+    await assertErrorsInCode('''\n+var s = \"\"\" \\u202a\n+        Multiline!\n+\"\"\";\n+''', [\n+      error(HintCode.TEXT_DIRECTION_CODE_POINT_IN_LITERAL, 12, 1),\n+    ]);\n+  }\n+\n+  test_simpleStrings() async {\n+    await assertErrorsInCode('''\n+var u202a = '\\u202A';\n+var u202b = '\\u202B';\n+var u202c = '\\u202C';\n+var u202d = '\\u202D';\n+var u202e = '\\u202E';\n+var u2066 = '\\u2066';\n+var u2067 = '\\u2067';\n+var u2068 = '\\u2068';\n+var u2069 = '\\u2069';\n+''', [\n+      error(HintCode.TEXT_DIRECTION_CODE_POINT_IN_LITERAL, 13, 1),\n+      error(HintCode.TEXT_DIRECTION_CODE_POINT_IN_LITERAL, 30, 1),\n+      error(HintCode.TEXT_DIRECTION_CODE_POINT_IN_LITERAL, 47, 1),\n+      error(HintCode.TEXT_DIRECTION_CODE_POINT_IN_LITERAL, 64, 1),\n+      error(HintCode.TEXT_DIRECTION_CODE_POINT_IN_LITERAL, 81, 1),\n+      error(HintCode.TEXT_DIRECTION_CODE_POINT_IN_LITERAL, 98, 1),\n+      error(HintCode.TEXT_DIRECTION_CODE_POINT_IN_LITERAL, 115, 1),\n+      error(HintCode.TEXT_DIRECTION_CODE_POINT_IN_LITERAL, 132, 1),\n+      error(HintCode.TEXT_DIRECTION_CODE_POINT_IN_LITERAL, 149, 1),\n+    ]);\n+  }\n+\n+  test_stringInterpolation() async {\n+    await assertErrorsInCode('''\n+var x = 'x';\n+var u202a = '\\u202A\\$x';\n+''', [\n+      error(HintCode.TEXT_DIRECTION_CODE_POINT_IN_LITERAL, 26, 1),\n+    ]);\n+  }\n+}"
        },
        {
          "filename": "pkg/analyzer/test/verify_diagnostics_test.dart",
          "status": "modified",
          "additions": 5,
          "deletions": 0,
          "patch": "@@ -82,6 +82,11 @@ class DocumentationValidator {\n     'CompileTimeErrorCode.YIELD_EACH_IN_NON_GENERATOR',\n     // The code has been replaced but is not yet removed.\n     'HintCode.DEPRECATED_MEMBER_USE',\n+    // Produces more than one error range by design.\n+    // TODO: update verification to allow for multiple highlight ranges.\n+    'HintCode.TEXT_DIRECTION_CODE_POINT_IN_COMMENT',\n+    // Produces more than one error range by design.\n+    'HintCode.TEXT_DIRECTION_CODE_POINT_IN_LITERAL',\n     // Produces two diagnostics when it should only produce one (see\n     // https://github.com/dart-lang/sdk/issues/43051)\n     'HintCode.UNNECESSARY_NULL_COMPARISON_FALSE',"
        },
        {
          "filename": "pkg/analyzer/tool/diagnostics/diagnostics.md",
          "status": "modified",
          "additions": 76,
          "deletions": 0,
          "patch": "@@ -13017,6 +13017,82 @@ void f() {\n \n Tear off the constructor of a concrete class.\n \n+### text_direction_code_point_in_comment\n+\n+_The Unicode code point 'U+{0}' changes the appearance of text from how it's\n+interpreted by the compiler._\n+\n+#### Description\n+\n+The analyzer produces this diagnostic when it encounters source that\n+contains text direction Unicode code points. These code points cause\n+source code in either a string literal or a comment to be interpreted\n+and compiled differently than how it appears in editors, leading to\n+possible security vulnerabilities.\n+\n+#### Example\n+\n+The following code produces this diagnostic twice because there are\n+hidden characters at the start and end of the label string:\n+\n+{% prettify dart tag=pre+code %}\n+var label = '[!I!]nteractive text[!'!];\n+{% endprettify %}\n+\n+#### Common fixes\n+\n+If the code points are intended to be included in the string literal,\n+then escape them:\n+\n+{% prettify dart tag=pre+code %}\n+var label = '\\u202AInteractive text\\u202C';\n+{% endprettify %}\n+\n+If the code points aren't intended to be included in the string literal,\n+then remove them:\n+\n+{% prettify dart tag=pre+code %}\n+var label = 'Interactive text';\n+{% endprettify %}\n+\n+### text_direction_code_point_in_literal\n+\n+_The Unicode code point 'U+{0}' changes the appearance of text from how it's\n+interpreted by the compiler._\n+\n+#### Description\n+\n+The analyzer produces this diagnostic when it encounters source that\n+contains text direction Unicode code points. These code points cause\n+source code in either a string literal or a comment to be interpreted\n+and compiled differently than how it appears in editors, leading to\n+possible security vulnerabilities.\n+\n+#### Example\n+\n+The following code produces this diagnostic twice because there are\n+hidden characters at the start and end of the label string:\n+\n+{% prettify dart tag=pre+code %}\n+var label = '[!I!]nteractive text[!'!];\n+{% endprettify %}\n+\n+#### Common fixes\n+\n+If the code points are intended to be included in the string literal,\n+then escape them:\n+\n+{% prettify dart tag=pre+code %}\n+var label = '\\u202AInteractive text\\u202C';\n+{% endprettify %}\n+\n+If the code points aren't intended to be included in the string literal,\n+then remove them:\n+\n+{% prettify dart tag=pre+code %}\n+var label = 'Interactive text';\n+{% endprettify %}\n+\n ### throw_of_invalid_type\n \n _The type '{0}' of the thrown expression must be assignable to 'Object'._"
        },
        {
          "filename": "pkg/compiler/lib/src/js/rewrite_async.dart",
          "status": "modified",
          "additions": 5,
          "deletions": 6,
          "patch": "@@ -1397,8 +1397,8 @@ abstract class AsyncRewriterBase extends js.NodeVisitor {\n \n   @override\n   void visitSwitch(js.Switch node) {\n-    if (!node.cases.any(shouldTransform)) {\n-      // If only the key has an await, translation can be simplified.\n+    if (!shouldTransform(node)) {\n+      // TODO(sra): If only the key has an await, translation can be simplified.\n       bool oldInsideUntranslated = insideUntranslatedBreakable;\n       insideUntranslatedBreakable = true;\n       withExpression(node.key, (js.Expression key) {\n@@ -2824,10 +2824,9 @@ class PreTranslationAnalysis extends js.BaseVisitor<bool> {\n   @override\n   bool visitSwitch(js.Switch node) {\n     loopsAndSwitches.add(node);\n-    // If the key has an `await` expression, do not transform the\n-    // body of the switch.\n-    visit(node.key);\n-    bool result = false;\n+    // TODO(sra): If just the key has an `await` expression, do not transform\n+    // the body of the switch.\n+    bool result = visit(node.key);\n     for (js.SwitchClause clause in node.cases) {\n       if (visit(clause)) result = true;\n     }"
        },
        {
          "filename": "pkg/compiler/test/async_await/async_await_js_transform_test.dart",
          "status": "modified",
          "additions": 101,
          "deletions": 5,
          "patch": "@@ -1085,20 +1085,116 @@ function(l) {\n       switch (__goto) {\n         case 0:\n           // Function start\n-          __goto = 2;\n-          return awaitHelper(l, body);\n         case 2:\n+          // switch\n+          __goto = 7;\n+          return awaitHelper(l, body);\n+        case 7:\n           // returning from await.\n           switch (__result) {\n             case 1:\n-              print(1);\n+              // goto case\n+              __goto = 4;\n               break;\n             case 2:\n-              print(1);\n+              // goto case\n+              __goto = 5;\n+              break;\n+            default:\n+              // goto default\n+              __goto = 6;\n+              break;\n+          }\n+          break;\n+        case 4:\n+          // case\n+          print(1);\n+          // goto after switch\n+          __goto = 3;\n+          break;\n+        case 5:\n+          // case\n+          print(1);\n+        case 6:\n+          // default\n+          print(2);\n+          // goto after switch\n+          __goto = 3;\n+          break;\n+        case 3:\n+          // after switch\n+          // implicit return\n+          return returnHelper(null, __completer);\n+      }\n+  });\n+  return startHelper(body, __completer);\n+}\"\"\");\n+\n+  testAsyncTransform(\"\"\"\n+  // This example is like #47566\n+  function(b, l) async {\n+    print(\"start\");\n+    if (b) {\n+      switch(await l) {\n+        case 1:\n+          print(1);\n+          break;\n+        default:\n+          print(2);\n+          break;\n+      }\n+    }\n+    print(\"end\");\n+  }\"\"\", \"\"\"\n+function(b, l) {\n+  var __goto = 0,\n+    __completer = NewCompleter(CompleterType);\n+  var body = _wrapJsFunctionForAsync(function(__errorCode, __result) {\n+    if (__errorCode === 1)\n+      return rethrowHelper(__result, __completer);\n+    while (true)\n+      switch (__goto) {\n+        case 0:\n+          // Function start\n+          print(\"start\");\n+          __goto = b ? 2 : 3;\n+          break;\n+        case 2:\n+          // then\n+        case 4:\n+          // switch\n+          __goto = 8;\n+          return awaitHelper(l, body);\n+        case 8:\n+          // returning from await.\n+          switch (__result) {\n+            case 1:\n+              // goto case\n+              __goto = 6;\n+              break;\n             default:\n-              print(2);\n+              // goto default\n+              __goto = 7;\n               break;\n           }\n+          break;\n+        case 6:\n+          // case\n+          print(1);\n+          // goto after switch\n+          __goto = 5;\n+          break;\n+        case 7:\n+          // default\n+          print(2);\n+          // goto after switch\n+          __goto = 5;\n+          break;\n+        case 5:\n+          // after switch\n+        case 3:\n+          // join\n+          print(\"end\");\n           // implicit return\n           return returnHelper(null, __completer);\n       }"
        },
        {
          "filename": "pkg/compiler/test/rti/rti_emission_test_helper.dart",
          "status": "modified",
          "additions": 0,
          "deletions": 1,
          "patch": "@@ -31,7 +31,6 @@ runTests(List<String> args, [int shardIndex]) {\n         new Directory.fromUri(Platform.script.resolve('emission'));\n     await checkTests(dataDir, const RtiEmissionDataComputer(),\n         args: args,\n-        options: ['--enable-experiment=constructor-tearoffs'],\n         shardIndex: shardIndex ?? 0,\n         shards: shardIndex != null ? 4 : 1);\n   });"
        },
        {
          "filename": "pkg/compiler/test/rti/rti_need_test_helper.dart",
          "status": "modified",
          "additions": 0,
          "deletions": 1,
          "patch": "@@ -34,7 +34,6 @@ runTests(List<String> args, [int shardIndex]) {\n   asyncTest(() async {\n     Directory dataDir = new Directory.fromUri(Platform.script.resolve('data'));\n     await checkTests(dataDir, const RtiNeedDataComputer(),\n-        options: ['--enable-experiment=constructor-tearoffs'],\n         args: args,\n         shardIndex: shardIndex ?? 0,\n         shards: shardIndex != null ? 4 : 1);"
        },
        {
          "filename": "pkg/compiler/test/sourcemaps/stacktrace_test.dart",
          "status": "modified",
          "additions": 0,
          "deletions": 1,
          "patch": "@@ -89,7 +89,6 @@ Future runTest(Test test, String config,\n       '--libraries-spec=$sdkLibrariesSpecificationPath',\n       '--packages=${Platform.packageConfig}',\n       Flags.testMode,\n-      '--enable-experiment=extension-methods',\n       input,\n     ]..addAll(options);\n     print(\"Compiling dart2js ${arguments.join(' ')}\");"
        },
        {
          "filename": "pkg/dev_compiler/lib/src/kernel/compiler.dart",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -1124,6 +1124,7 @@ class ProgramCompiler extends ComputeOnceConstantVisitor<js_ast.Expression>\n     for (var i = 0; i < mixinApplications.length; i++) {\n       var m = mixinApplications[i];\n       var mixinClass = m.isAnonymousMixin ? m.mixedInClass : m;\n+      _declareBeforeUse(mixinClass);\n       var mixinType =\n           _hierarchy.getClassAsInstanceOf(c, mixinClass).asInterfaceType;\n       var mixinName ="
        },
        {
          "filename": "pkg/front_end/lib/src/api_prototype/experimental_flags_generated.dart",
          "status": "modified",
          "additions": 5,
          "deletions": 5,
          "patch": "@@ -125,17 +125,17 @@ const Map<ExperimentalFlag, bool> expiredExperimentalFlags = {\n   ExperimentalFlag.constructorTearoffs: false,\n   ExperimentalFlag.controlFlowCollections: true,\n   ExperimentalFlag.enhancedEnums: false,\n-  ExperimentalFlag.extensionMethods: false,\n+  ExperimentalFlag.extensionMethods: true,\n   ExperimentalFlag.extensionTypes: false,\n-  ExperimentalFlag.genericMetadata: false,\n+  ExperimentalFlag.genericMetadata: true,\n   ExperimentalFlag.namedArgumentsAnywhere: false,\n-  ExperimentalFlag.nonNullable: false,\n-  ExperimentalFlag.nonfunctionTypeAliases: false,\n+  ExperimentalFlag.nonNullable: true,\n+  ExperimentalFlag.nonfunctionTypeAliases: true,\n   ExperimentalFlag.setLiterals: true,\n   ExperimentalFlag.spreadCollections: true,\n   ExperimentalFlag.superParameters: false,\n   ExperimentalFlag.testExperiment: false,\n-  ExperimentalFlag.tripleShift: false,\n+  ExperimentalFlag.tripleShift: true,\n   ExperimentalFlag.valueClass: false,\n   ExperimentalFlag.variance: false,\n };"
        },
        {
          "filename": "pkg/front_end/lib/src/fasta/source/stack_listener_impl.dart",
          "status": "modified",
          "additions": 1,
          "deletions": 23,
          "patch": "@@ -12,8 +12,6 @@ import 'package:_fe_analyzer_shared/src/scanner/scanner.dart' show Token;\n \n import 'package:kernel/ast.dart';\n \n-import '../../api_prototype/experimental_flags.dart';\n-\n import '../fasta_codes.dart';\n \n import '../problems.dart' as problems\n@@ -97,8 +95,7 @@ abstract class StackListenerImpl extends StackListener {\n             token.charOffset,\n             token.charCount);\n       }\n-    } else if (libraryBuilder.loader.target\n-        .isExperimentEnabledByDefault(ExperimentalFlag.nonNullable)) {\n+    } else {\n       if (libraryBuilder.languageVersion.version <\n           libraryBuilder.enableNonNullableVersionInLibrary) {\n         addProblem(\n@@ -110,25 +107,6 @@ abstract class StackListenerImpl extends StackListener {\n         addProblem(templateExperimentDisabled.withArguments('non-nullable'),\n             token.offset, noLength);\n       }\n-    } else if (!libraryBuilder.loader.target\n-        .isExperimentEnabledGlobally(ExperimentalFlag.nonNullable)) {\n-      if (libraryBuilder.languageVersion.version <\n-          libraryBuilder.enableNonNullableVersionInLibrary) {\n-        addProblem(\n-            templateExperimentNotEnabledNoFlagInvalidLanguageVersion\n-                .withArguments(\n-                    libraryBuilder.enableNonNullableVersionInLibrary.toText()),\n-            token.offset,\n-            noLength);\n-      } else {\n-        addProblem(messageExperimentNotEnabledNoFlag, token.offset, noLength);\n-      }\n-    } else {\n-      addProblem(\n-          templateExperimentNotEnabled.withArguments('non-nullable',\n-              libraryBuilder.enableNonNullableVersionInLibrary.toText()),\n-          token.offset,\n-          noLength);\n     }\n   }\n "
        },
        {
          "filename": "pkg/front_end/messages.yaml",
          "status": "modified",
          "additions": 0,
          "deletions": 10,
          "patch": "@@ -282,16 +282,6 @@ ExperimentNotEnabled:\n   correctionMessage: \"Try updating your pubspec.yaml to set the minimum SDK constraint to #string2 or higher, and running 'pub get'.\"\n   analyzerCode: ParserErrorCode.EXPERIMENT_NOT_ENABLED\n \n-ExperimentNotEnabledNoFlag:\n-  problemMessage: \"This requires the null safety language feature, which is experimental.\"\n-  correctionMessage: \"You can enable the experiment using the '--enable-experiment=non-nullable' command line option.\"\n-  analyzerCode: ParserErrorCode.EXPERIMENT_NOT_ENABLED\n-\n-ExperimentNotEnabledNoFlagInvalidLanguageVersion:\n-  problemMessage: \"This requires the null safety language feature, which is experimental and requires language version of #string2 or higher.\"\n-  correctionMessage: \"You can enable the experiment using the '--enable-experiment=non-nullable' command line option.\"\n-  analyzerCode: ParserErrorCode.EXPERIMENT_NOT_ENABLED\n-\n ExperimentDisabled:\n   problemMessage: \"This requires the '#string' language feature to be enabled.\"\n   correctionMessage: \"The feature is on by default but is currently disabled, maybe because the '--enable-experiment=no-#string' command line option is passed.\""
        },
        {
          "filename": "pkg/front_end/testcases/constructor_tearoffs/folder.options",
          "status": "modified",
          "additions": 0,
          "deletions": 1,
          "patch": "@@ -1,2 +1 @@\n---enable-experiment=constructor-tearoffs\n --force-constructor-tear-off-lowering=0"
        },
        {
          "filename": "pkg/front_end/testcases/constructor_tearoffs/lowering/folder.options",
          "status": "modified",
          "additions": 1,
          "deletions": 2,
          "patch": "@@ -1,2 +1 @@\n---enable-experiment=constructor-tearoffs\n---force-constructor-tear-off-lowering\n\\ No newline at end of file\n+--force-constructor-tear-off-lowering"
        },
        {
          "filename": "pkg/front_end/testcases/extensions/extension_methods.dart",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -1,8 +1,8 @@\n // Copyright (c) 2019, the Dart project authors.  Please see the AUTHORS file\n // for details. All rights reserved. Use of this source code is governed by a\n // BSD-style license that can be found in the LICENSE file.\n+\n // @dart=2.9\n-// SharedOptions=--enable-experiment=extension-methods\n \n import 'package:expect/expect.dart';\n "
        },
        {
          "filename": "pkg/front_end/testcases/extensions/use_this.dart",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -1,8 +1,8 @@\n // Copyright (c) 2019, the Dart project authors.  Please see the AUTHORS file\n // for details. All rights reserved. Use of this source code is governed by a\n // BSD-style license that can be found in the LICENSE file.\n+\n // @dart=2.9\n-// SharedOptions=--enable-experiment=extension-methods\n \n class A1 {}\n \n@@ -30,4 +30,4 @@ extension B2<T> on B1<T> {\n   }\n }\n \n-main() {}\n\\ No newline at end of file\n+main() {}"
        },
        {
          "filename": "runtime/lib/isolate.cc",
          "status": "modified",
          "additions": 6,
          "deletions": 2,
          "patch": "@@ -108,7 +108,7 @@ DEFINE_NATIVE_ENTRY(SendPortImpl_sendInternal_, 0, 2) {\n \n   const Dart_Port destination_port_id = port.Id();\n   const bool can_send_any_object = isolate->origin_id() == port.origin_id();\n-  // We have to check whether the reciever has the same isolate group (e.g.\n+  // We have to check whether the receiver has the same isolate group (e.g.\n   // native message handlers such as an IOService handler does not but does\n   // share the same origin port).\n   const bool same_group =\n@@ -719,7 +719,11 @@ class SpawnIsolateTask : public ThreadPool::Task {\n     }\n \n     state_->set_isolate(child);\n-    child->set_origin_id(state_->origin_id());\n+    if (state_->origin_id() != ILLEGAL_PORT) {\n+      // origin_id is set to parent isolate main port id when spawning via\n+      // spawnFunction.\n+      child->set_origin_id(state_->origin_id());\n+    }\n \n     bool success = true;\n     {"
        },
        {
          "filename": "runtime/observatory/tests/service/constructor_tear_off_test.dart",
          "status": "modified",
          "additions": 0,
          "deletions": 2,
          "patch": "@@ -4,8 +4,6 @@\n \n // @dart=2.15\n \n-// SharedOptions=--enable-experiment=constructor-tearoffs\n-\n import 'package:observatory/service_common.dart';\n import 'package:test/test.dart';\n "
        },
        {
          "filename": "runtime/tests/vm/dart/isolates/send_object_to_spawn_uri_isolate_test.dart",
          "status": "added",
          "additions": 52,
          "deletions": 0,
          "patch": "@@ -0,0 +1,52 @@\n+// Copyright (c) 2021, the Dart project authors.  Please see the AUTHORS file\n+// for details. All rights reserved. Use of this source code is governed by a\n+// BSD-style license that can be found in the LICENSE file.\n+//\n+// This test ensures that one can't send user dart objects to\n+// an isolate spawned via spawnUri.\n+\n+import 'dart:async';\n+import 'dart:io';\n+import 'dart:isolate';\n+\n+import 'package:expect/expect.dart';\n+import \"package:test/test.dart\";\n+\n+class Foo {\n+  var bar = 123;\n+}\n+\n+Future<void> main(args, message) async {\n+  if (message == null) {\n+    final receivePort = ReceivePort();\n+    final isolate = await Isolate.spawnUri(\n+        Platform.script, <String>[], <SendPort>[receivePort.sendPort],\n+        errorsAreFatal: true);\n+    final result = await receivePort.first;\n+    Expect.equals(\"done\", result);\n+    return;\n+  }\n+\n+  if (args.length > 0) {\n+    Expect.equals(\"worker\", args[0]);\n+    final SendPort sendPort = message[0] as SendPort;\n+    Expect.throws(() => sendPort.send(Foo()));\n+    sendPort.send(\"done\");\n+  } else {\n+    final SendPort sendPort = message[0] as SendPort;\n+\n+    final receivePort = ReceivePort();\n+    try {\n+      final isolate = await Isolate.spawnUri(\n+          Platform.script, <String>[\"worker\"], <SendPort>[receivePort.sendPort],\n+          errorsAreFatal: true);\n+      final result = await receivePort.first;\n+      Expect.equals(\"done\", result);\n+      sendPort.send(\"done\");\n+    } catch (_) {\n+      sendPort.send(\"fail\");\n+    }\n+\n+    sendPort.send(\"done\");\n+  }\n+}"
        },
        {
          "filename": "runtime/tests/vm/dart_2/isolates/send_object_to_spawn_uri_isolate_test.dart",
          "status": "added",
          "additions": 54,
          "deletions": 0,
          "patch": "@@ -0,0 +1,54 @@\n+// Copyright (c) 2021, the Dart project authors.  Please see the AUTHORS file\n+// for details. All rights reserved. Use of this source code is governed by a\n+// BSD-style license that can be found in the LICENSE file.\n+//\n+// @dart = 2.9\n+//\n+// This test ensures that one can't send user dart objects to\n+// an isolate spawned via spawnUri.\n+\n+import 'dart:async';\n+import 'dart:io';\n+import 'dart:isolate';\n+\n+import 'package:expect/expect.dart';\n+import \"package:test/test.dart\";\n+\n+class Foo {\n+  var bar = 123;\n+}\n+\n+Future<void> main(args, message) async {\n+  if (message == null) {\n+    final receivePort = ReceivePort();\n+    final isolate = await Isolate.spawnUri(\n+        Platform.script, <String>[], <SendPort>[receivePort.sendPort],\n+        errorsAreFatal: true);\n+    final result = await receivePort.first;\n+    Expect.equals(\"done\", result);\n+    return;\n+  }\n+\n+  if (args.length > 0) {\n+    Expect.equals(\"worker\", args[0]);\n+    final SendPort sendPort = message[0] as SendPort;\n+    Expect.throws(() => sendPort.send(Foo()));\n+    sendPort.send(\"done\");\n+  } else {\n+    final SendPort sendPort = message[0] as SendPort;\n+\n+    final receivePort = ReceivePort();\n+    try {\n+      final isolate = await Isolate.spawnUri(\n+          Platform.script, <String>[\"worker\"], <SendPort>[receivePort.sendPort],\n+          errorsAreFatal: true);\n+      final result = await receivePort.first;\n+      Expect.equals(\"done\", result);\n+      sendPort.send(\"done\");\n+    } catch (_) {\n+      sendPort.send(\"fail\");\n+    }\n+\n+    sendPort.send(\"done\");\n+  }\n+}"
        },
        {
          "filename": "runtime/tests/vm/vm.status",
          "status": "modified",
          "additions": 2,
          "deletions": 0,
          "patch": "@@ -421,8 +421,10 @@ dart_2/*: SkipByDesign # Legacy tests are not supposed to run on NNBD bots.\n # These Isolate tests that use spawnURI are hence skipped on purpose.\n [ $runtime == dart_precompiled || $runtime == vm && ($arch == simarm || $arch == simarm64 || $arch == simarm64c) ]\n dart/data_uri_spawn_test: SkipByDesign # Isolate.spawnUri\n+dart/isolates/send_object_to_spawn_uri_isolate_test: SkipByDesign # uses spawnUri\n dart/issue32950_test: SkipByDesign # uses spawnUri.\n dart_2/data_uri_spawn_test: SkipByDesign # Isolate.spawnUri\n+dart_2/isolates/send_object_to_spawn_uri_isolate_test: SkipByDesign # uses spawnUri\n dart_2/issue32950_test: SkipByDesign # uses spawnUri.\n \n [ $runtime != dart_precompiled || $system == android ]"
        },
        {
          "filename": "runtime/vm/compiler/frontend/kernel_binary_flowgraph.cc",
          "status": "modified",
          "additions": 15,
          "deletions": 4,
          "patch": "@@ -4869,17 +4869,28 @@ Fragment StreamingFlowGraphBuilder::BuildReturnStatement() {\n \n   if (instructions.is_open()) {\n     if (inside_try_finally) {\n-      ASSERT(scopes()->finally_return_variable != NULL);\n+      LocalVariable* const finally_return_variable =\n+          scopes()->finally_return_variable;\n+      ASSERT(finally_return_variable != nullptr);\n       const Function& function = parsed_function()->function();\n       if (NeedsDebugStepCheck(function, position)) {\n         instructions += DebugStepCheck(position);\n       }\n-      instructions += StoreLocal(position, scopes()->finally_return_variable);\n+      instructions += StoreLocal(position, finally_return_variable);\n       instructions += Drop();\n-      instructions += TranslateFinallyFinalizers(NULL, -1);\n+      const intptr_t target_context_depth =\n+          finally_return_variable->is_captured()\n+              ? finally_return_variable->owner()->context_level()\n+              : -1;\n+      instructions += TranslateFinallyFinalizers(nullptr, target_context_depth);\n       if (instructions.is_open()) {\n-        instructions += LoadLocal(scopes()->finally_return_variable);\n+        const intptr_t saved_context_depth = B->context_depth_;\n+        if (finally_return_variable->is_captured()) {\n+          B->context_depth_ = target_context_depth;\n+        }\n+        instructions += LoadLocal(finally_return_variable);\n         instructions += Return(TokenPosition::kNoSource);\n+        B->context_depth_ = saved_context_depth;\n       }\n     } else {\n       instructions += Return(position);"
        },
        {
          "filename": "runtime/vm/experimental_features.cc",
          "status": "modified",
          "additions": 20,
          "deletions": 11,
          "patch": "@@ -18,24 +18,33 @@ namespace dart {\n \n bool GetExperimentalFeatureDefault(ExperimentalFeature feature) {\n   constexpr bool kFeatureValues[] = {\n-      true, true, true, true, true, true, true, true, true, true,\n+    true,\n+    true,\n+    true,\n+    true,\n+    true,\n+    true,\n+    true,\n+    true,\n+    true,\n+    true,\n   };\n   ASSERT(static_cast<size_t>(feature) < ARRAY_SIZE(kFeatureValues));\n   return kFeatureValues[static_cast<int>(feature)];\n }\n \n const char* GetExperimentalFeatureName(ExperimentalFeature feature) {\n   constexpr const char* kFeatureNames[] = {\n-      \"nonfunction-type-aliases\",\n-      \"non-nullable\",\n-      \"extension-methods\",\n-      \"constant-update-2018\",\n-      \"control-flow-collections\",\n-      \"generic-metadata\",\n-      \"set-literals\",\n-      \"spread-collections\",\n-      \"triple-shift\",\n-      \"constructor-tearoffs\",\n+    \"nonfunction-type-aliases\",\n+    \"non-nullable\",\n+    \"extension-methods\",\n+    \"constant-update-2018\",\n+    \"control-flow-collections\",\n+    \"generic-metadata\",\n+    \"set-literals\",\n+    \"spread-collections\",\n+    \"triple-shift\",\n+    \"constructor-tearoffs\",\n   };\n   ASSERT(static_cast<size_t>(feature) < ARRAY_SIZE(kFeatureNames));\n   return kFeatureNames[static_cast<int>(feature)];"
        },
        {
          "filename": "runtime/vm/isolate.cc",
          "status": "modified",
          "additions": 12,
          "deletions": 1,
          "patch": "@@ -2418,7 +2418,18 @@ void Isolate::ProcessFreeSampleBlocks(Thread* thread) {\n \n // static\n void Isolate::NotifyLowMemory() {\n-  Isolate::KillAllIsolates(Isolate::kLowMemoryMsg);\n+  IsolateGroup::ForEach([](IsolateGroup* group) { group->NotifyLowMemory(); });\n+}\n+\n+void IsolateGroup::NotifyLowMemory() {\n+  SafepointReadRwLocker ml(Thread::Current(), isolates_lock_.get());\n+  MonitorLocker ml2(Isolate::isolate_creation_monitor_);\n+  for (Isolate* isolate : isolates_) {\n+    if (isolate->AcceptsMessagesLocked()) {\n+      isolate->KillLocked(Isolate::kLowMemoryMsg);\n+      return;  // Only wake up one member of the group.\n+    }\n+  }\n }\n \n void Isolate::LowLevelShutdown() {"
        },
        {
          "filename": "runtime/vm/isolate.h",
          "status": "modified",
          "additions": 2,
          "deletions": 0,
          "patch": "@@ -592,6 +592,8 @@ class IsolateGroup : public IntrusiveDListEntry<IsolateGroup> {\n     return deferred_marking_stack_;\n   }\n \n+  void NotifyLowMemory();\n+\n   // Runs the given [function] on every isolate in the isolate group.\n   //\n   // During the duration of this function, no new isolates can be added or"
        },
        {
          "filename": "tests/language/async_star/regression_47610_test.dart",
          "status": "added",
          "additions": 32,
          "deletions": 0,
          "patch": "@@ -0,0 +1,32 @@\n+// Copyright (c) 2021, the Dart project authors.  Please see the AUTHORS file\n+// for details. All rights reserved. Use of this source code is governed by a\n+// BSD-style license that can be found in the LICENSE file.\n+\n+// Regression test for https://github.com/dart-lang/sdk/issues/47610.\n+// Tests returning value from a deep context depth along with\n+// breaking from 'await for'.\n+\n+import \"dart:async\";\n+import \"package:expect/expect.dart\";\n+import \"package:async_helper/async_helper.dart\";\n+\n+Stream<int> foo() async* {\n+  for (int i = 0; i < 2; ++i) {\n+    for (int j = 0; j < 2; ++j) {\n+      for (int k = 0; k < 2; ++k) {\n+        yield i + j + k;\n+      }\n+    }\n+  }\n+}\n+\n+void test() async {\n+  await for (var x in foo()) {\n+    Expect.equals(0, x);\n+    break;\n+  }\n+}\n+\n+void main() {\n+  asyncTest(test);\n+}"
        },
        {
          "filename": "tests/language/const/constant_type_variable_error_test.dart",
          "status": "modified",
          "additions": 0,
          "deletions": 2,
          "patch": "@@ -2,8 +2,6 @@\n // for details. All rights reserved. Use of this source code is governed by a\n // BSD-style license that can be found in the LICENSE file.\n \n-// SharedOptions=--enable-experiment=constructor-tearoffs\n-\n // Test the support for errors about type parameters as potentially\n // constant expressions or potentially constant type expressions.\n "
        },
        {
          "filename": "tests/language/const/constant_type_variable_test.dart",
          "status": "modified",
          "additions": 0,
          "deletions": 2,
          "patch": "@@ -2,8 +2,6 @@\n // for details. All rights reserved. Use of this source code is governed by a\n // BSD-style license that can be found in the LICENSE file.\n \n-// SharedOptions=--enable-experiment=constructor-tearoffs\n-\n // Test the support for type parameters as potentially constant expressions\n // and potentially constant type expressions. The cast to dynamic is included\n // in order to avoid a diagnostic message about an unnecessary cast."
        },
        {
          "filename": "tests/language/const/instantiated_function_constant_error_test.dart",
          "status": "modified",
          "additions": 0,
          "deletions": 2,
          "patch": "@@ -2,8 +2,6 @@\n // for details. All rights reserved. Use of this source code is governed by a\n // BSD-style license that can be found in the LICENSE file.\n \n-// SharedOptions=--enable-experiment=constructor-tearoffs\n-\n // Test the support for error detection with generic function instantiation\n // expressions that are constant or potentially constant. Include both some\n // explicit generic function instantiations, and some implicit ones (for the"
        },
        {
          "filename": "tests/language/const/instantiated_function_constant_test.dart",
          "status": "modified",
          "additions": 0,
          "deletions": 2,
          "patch": "@@ -2,8 +2,6 @@\n // for details. All rights reserved. Use of this source code is governed by a\n // BSD-style license that can be found in the LICENSE file.\n \n-// SharedOptions=--enable-experiment=constructor-tearoffs\n-\n // Test the support for generic function instantiation with constant and\n // potentially constant expressions. Include both some explicit generic\n // function instantiations, and some implicit ones (for the latter, the type"
        },
        {
          "filename": "tests/language/constructor/explicit_instantiation_syntax_test.dart",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -2,7 +2,7 @@\n // for details. All rights reserved. Use of this source code is governed by a\n // BSD-style license that can be found in the LICENSE file.\n \n-// SharedOptions=--enable-experiment=constructor-tearoffs\n+\n \n import 'dart:core' hide dynamic;\n import 'dart:core' as core show dynamic;"
        },
        {
          "filename": "tests/language/constructor/tear_off_test.dart",
          "status": "modified",
          "additions": 10,
          "deletions": 14,
          "patch": "@@ -2,8 +2,6 @@\n // for details. All rights reserved. Use of this source code is governed by a\n // BSD-style license that can be found in the LICENSE file.\n \n-// SharedOptions=--enable-experiment=constructor-tearoffs\n-\n import \"package:expect/expect.dart\";\n \n import \"../static_type_helper.dart\";\n@@ -91,23 +89,23 @@ void main() {\n \n   GGen<int>.new.expectStaticType<Exactly<GGen<int> Function(int)>>();\n   GGen<int>.named.expectStaticType<Exactly<GGen<int> Function(int)>>();\n-  GGenRedir<int>.new\n-      .expectStaticType<Exactly<GGenRedir<int> Function(int)>>();\n-  GGenRedir<int>.named\n+  GGenRedir<int>.new.expectStaticType<Exactly<GGenRedir<int> Function(int)>>();\n+  GGenRedir<int>\n+      .named\n       .expectStaticType<Exactly<GGenRedir<int> Function(int)>>();\n   GFac<int>.new.expectStaticType<Exactly<GFac<int> Function(int)>>();\n   GFac<int>.named.expectStaticType<Exactly<GFac<int> Function(int)>>();\n-  GFacRedir<int>.new\n-      .expectStaticType<Exactly<GFacRedir<int> Function(int)>>();\n-  GFacRedir<int>.named\n+  GFacRedir<int>.new.expectStaticType<Exactly<GFacRedir<int> Function(int)>>();\n+  GFacRedir<int>\n+      .named\n       .expectStaticType<Exactly<GFacRedir<int> Function(int)>>();\n \n   context<GGen<int> Function(int)>(\n       GGen.new..expectStaticType<Exactly<GGen<int> Function(int)>>());\n   context<GGen<int> Function(int)>(\n       GGen.named..expectStaticType<Exactly<GGen<int> Function(int)>>());\n-  context<GGenRedir<int> Function(int)>(GGenRedir.new\n-    ..expectStaticType<Exactly<GGenRedir<int> Function(int)>>());\n+  context<GGenRedir<int> Function(int)>(\n+      GGenRedir.new..expectStaticType<Exactly<GGenRedir<int> Function(int)>>());\n   context<GGenRedir<int> Function(int)>(GGenRedir.named\n     ..expectStaticType<Exactly<GGenRedir<int> Function(int)>>());\n   context<GFac<int> Function(int)>(\n@@ -156,15 +154,13 @@ void main() {\n \n   // Generic class constructors torn off with explicit instantiation\n   // to constant type.\n-  test<GGen<int> Function(int)>(\n-      GGen<int>.new, GGen<int>.new, GGen<int>.named);\n+  test<GGen<int> Function(int)>(GGen<int>.new, GGen<int>.new, GGen<int>.named);\n   test<GGen<int> Function(int)>(GGen<int>.named, GGen<int>.named);\n   test<GGenRedir<int> Function(int)>(\n       GGenRedir<int>.new, GGenRedir<int>.new, GGenRedir<int>.named);\n   test<GGenRedir<int> Function(int)>(\n       GGenRedir<int>.named, GGenRedir<int>.named);\n-  test<GFac<int> Function(int)>(\n-      GFac<int>.new, GFac<int>.new, GFac<int>.named);\n+  test<GFac<int> Function(int)>(GFac<int>.new, GFac<int>.new, GFac<int>.named);\n   test<GFac<int> Function(int)>(GFac<int>.named, GFac<int>.named);\n   test<GFacRedir<int> Function(int)>(\n       GFacRedir<int>.new, GFacRedir<int>.new, GFacRedir<int>.named);"
        },
        {
          "filename": "tests/language/constructor/unnamed_new_error_test.dart",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -2,7 +2,7 @@\n // for details. All rights reserved. Use of this source code is governed by a\n // BSD-style license that can be found in the LICENSE file.\n \n-// SharedOptions=--enable-experiment=constructor-tearoffs\n+\n \n import \"package:expect/expect.dart\";\n "
        },
        {
          "filename": "tests/language/constructor/unnamed_new_test.dart",
          "status": "modified",
          "additions": 0,
          "deletions": 2,
          "patch": "@@ -2,8 +2,6 @@\n // for details. All rights reserved. Use of this source code is governed by a\n // BSD-style license that can be found in the LICENSE file.\n \n-// SharedOptions=--enable-experiment=constructor-tearoffs\n-\n import \"package:expect/expect.dart\";\n \n import \"unnamed_new_test.dart\" as prefix;"
        },
        {
          "filename": "tests/language/explicit_type_instantiation_parsing_test.dart",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -2,7 +2,7 @@\n // for details. All rights reserved. Use of this source code is governed by a\n // BSD-style license that can be found in the LICENSE file.\n \n-// SharedOptions=--enable-experiment=constructor-tearoffs\n+\n \n // Test parsing around ambiguities in grammar for explicit type instantiation.\n //"
        },
        {
          "filename": "tests/language/generic_methods/explicit_instantiated_tearoff_test.dart",
          "status": "modified",
          "additions": 19,
          "deletions": 30,
          "patch": "@@ -2,8 +2,6 @@\n // for details. All rights reserved. Use of this source code is governed by a\n // BSD-style license that can be found in the LICENSE file.\n \n-// SharedOptions=--enable-experiment=constructor-tearoffs\n-\n import \"package:expect/expect.dart\";\n \n import \"../static_type_helper.dart\";\n@@ -19,11 +17,11 @@ class C {\n   void tearOffsOnThis() {\n     const staticTearOff = staticMethod<int, String>;\n     staticMethod<int, String>\n-      .expectStaticType<Exactly<int Function(String, [String?])>>();\n+        .expectStaticType<Exactly<int Function(String, [String?])>>();\n     instanceMethod<int, String>\n-      .expectStaticType<Exactly<int Function(String, [String?])>>();\n+        .expectStaticType<Exactly<int Function(String, [String?])>>();\n     this.instanceMethod<int, String>\n-      .expectStaticType<Exactly<int Function(String, [String?])>>();\n+        .expectStaticType<Exactly<int Function(String, [String?])>>();\n \n     Expect.identical(staticMethod<int, String>, staticTearOff);\n \n@@ -39,16 +37,15 @@ mixin M on C {\n   void mixinTearOffsOnThis() {\n     const staticTearOff = staticMethod<int, String>;\n     staticMethod<int, String>\n-      .expectStaticType<Exactly<int Function(String, [String?])>>();\n+        .expectStaticType<Exactly<int Function(String, [String?])>>();\n     mixinInstanceMethod<int, String>\n-      .expectStaticType<Exactly<int Function(String, [String?])>>();\n+        .expectStaticType<Exactly<int Function(String, [String?])>>();\n     this.mixinInstanceMethod<int, String>\n-      .expectStaticType<Exactly<int Function(String, [String?])>>();\n+        .expectStaticType<Exactly<int Function(String, [String?])>>();\n \n     Expect.identical(staticMethod<int, String>, staticTearOff);\n \n-    Expect.equals(\n-        mixinInstanceMethod<int, String>,\n+    Expect.equals(mixinInstanceMethod<int, String>,\n         this.mixinInstanceMethod<int, String>);\n   }\n }\n@@ -60,11 +57,11 @@ extension E on C {\n   void extensionTearOffsOnThis() {\n     const staticTearOff = staticMethod<int, String>;\n     staticMethod<int, String>\n-      .expectStaticType<Exactly<int Function(String, [String?])>>();\n+        .expectStaticType<Exactly<int Function(String, [String?])>>();\n     extInstanceMethod<int, String>\n-      .expectStaticType<Exactly<int Function(String, [String?])>>();\n+        .expectStaticType<Exactly<int Function(String, [String?])>>();\n     this.extInstanceMethod<int, String>\n-      .expectStaticType<Exactly<int Function(String, [String?])>>();\n+        .expectStaticType<Exactly<int Function(String, [String?])>>();\n     Expect.identical(staticMethod<int, String>, staticTearOff);\n     // Extension instance methods do not specify equality.\n   }\n@@ -73,7 +70,7 @@ extension E on C {\n class D extends C with M {\n   void tearOffsOnSuper() {\n     super.instanceMethod<int, String>\n-      .expectStaticType<Exactly<int Function(String, [String?])>>();\n+        .expectStaticType<Exactly<int Function(String, [String?])>>();\n     Expect.equals(\n         super.instanceMethod<int, String>, super.instanceMethod<int, String>);\n   }\n@@ -93,23 +90,17 @@ void main() {\n \n   toplevel<int, String>\n       .expectStaticType<Exactly<int Function(String, [String?])>>();\n-  C\n-      .staticMethod<int, String>\n+  C.staticMethod<int, String>\n       .expectStaticType<Exactly<int Function(String, [String?])>>();\n-  M\n-      .staticMethod<int, String>\n+  M.staticMethod<int, String>\n       .expectStaticType<Exactly<int Function(String, [String?])>>();\n-  E\n-      .staticMethod<int, String>\n+  E.staticMethod<int, String>\n       .expectStaticType<Exactly<int Function(String, [String?])>>();\n-  o\n-      .instanceMethod<int, String>\n+  o.instanceMethod<int, String>\n       .expectStaticType<Exactly<int Function(String, [String?])>>();\n-  o\n-      .mixinInstanceMethod<int, String>\n+  o.mixinInstanceMethod<int, String>\n       .expectStaticType<Exactly<int Function(String, [String?])>>();\n-  o\n-      .extInstanceMethod<int, String>\n+  o.extInstanceMethod<int, String>\n       .expectStaticType<Exactly<int Function(String, [String?])>>();\n   local<int, String>\n       .expectStaticType<Exactly<int Function(String, [String?])>>();\n@@ -125,17 +116,15 @@ void main() {\n \n   // But not for instance method tear-off.\n   // Specification requires equality.\n-  Expect.equals(\n-      o.instanceMethod<int, String>, o.instanceMethod<int, String>);\n+  Expect.equals(o.instanceMethod<int, String>, o.instanceMethod<int, String>);\n   Expect.equals(\n       o.mixinInstanceMethod<int, String>, o.mixinInstanceMethod<int, String>);\n \n   // Instantiated extension methods do not specify equality.\n \n   // And not canonicalized where they shouldn't (different types).\n   Expect.notEquals(toplevel<int, String>, toplevel<num, String>);\n-  Expect.notEquals(\n-      C.staticMethod<int, String>, C.staticMethod<num, String>);\n+  Expect.notEquals(C.staticMethod<int, String>, C.staticMethod<num, String>);\n   Expect.notEquals(local<int, String>, local<num, String>);\n   Expect.notEquals(\n       o.instanceMethod<int, String>, o.instanceMethod<num, String>);"
        },
        {
          "filename": "tests/language/mixin/regress_47645_test.dart",
          "status": "added",
          "additions": 19,
          "deletions": 0,
          "patch": "@@ -0,0 +1,19 @@\n+// Copyright (c) 2021, the Dart project authors.  Please see the AUTHORS file\n+// for details. All rights reserved. Use of this source code is governed by a\n+// BSD-style license that can be found in the LICENSE file.\n+\n+import \"package:expect/expect.dart\";\n+\n+// Regression test for https://github.com/dart-lang/sdk/issues/47645.\n+// To reproduce the issue the class declaration must appear before the mixin\n+// declaration.\n+class C<T> with M<C<T>> {}\n+\n+mixin M<T> {\n+  bool fn() => true;\n+}\n+\n+void main() {\n+  var c = C<int>();\n+  Expect.isTrue(c.fn());\n+}"
        },
        {
          "filename": "tests/language/nnbd/flow_analysis/local_boolean_implicitly_typed_new_test.dart",
          "status": "modified",
          "additions": 0,
          "deletions": 2,
          "patch": "@@ -2,8 +2,6 @@\n // for details. All rights reserved. Use of this source code is governed by a\n // BSD-style license that can be found in the LICENSE file.\n \n-// SharedOptions=--enable-experiment=constructor-tearoffs\n-\n import '../../static_type_helper.dart';\n \n // This test checks whether a local boolean variable can be used to perform type"
        },
        {
          "filename": "tests/language/nonfunction_type_aliases/basic_syntax_test.dart",
          "status": "modified",
          "additions": 0,
          "deletions": 2,
          "patch": "@@ -2,8 +2,6 @@\n // for details. All rights reserved. Use of this source code is governed by a\n // BSD-style license that can be found in the LICENSE file.\n \n-// SharedOptions=--enable-experiment=non-nullable\n-\n typedef T0 = void;\n typedef T1 = Function;\n typedef T2<X> = List<X>;"
        },
        {
          "filename": "tests/language/nonfunction_type_aliases/nnbd_syntax_test.dart",
          "status": "modified",
          "additions": 2,
          "deletions": 4,
          "patch": "@@ -2,15 +2,13 @@\n // for details. All rights reserved. Use of this source code is governed by a\n // BSD-style license that can be found in the LICENSE file.\n \n-// SharedOptions=--enable-experiment=non-nullable\n-\n typedef T0 = Function?;\n typedef T1<X> = List<X?>?;\n typedef T2<X, Y> = Map<X?, Y?>?;\n typedef T3 = Never? Function(void)?;\n typedef T4<X> = X? Function(X?, {required X? name})?;\n-typedef T5<X extends String, Y extends List<X?>> =\n-    X? Function(Y?, [Map<Y, Y?>]);\n+typedef T5<X extends String, Y extends List<X?>> = X? Function(Y?,\n+    [Map<Y, Y?>]);\n \n void main() {\n   // ignore:unused_local_variable"
        },
        {
          "filename": "tests/language/regress/regress47566_test.dart",
          "status": "added",
          "additions": 42,
          "deletions": 0,
          "patch": "@@ -0,0 +1,42 @@\n+// Copyright (c) 2021, the Dart project authors.  Please see the AUTHORS file\n+// for details. All rights reserved. Use of this source code is governed by a\n+// BSD-style license that can be found in the LICENSE file.\n+\n+// Regression test for https://github.com/dart-lang/sdk/issues/47566\n+\n+import 'package:expect/expect.dart';\n+\n+final List trace = [];\n+void log(String s) {\n+  trace.add(s);\n+}\n+\n+Future<void> test(bool value) async {\n+  log('f1');\n+\n+  if (value) {\n+    final result = await bar();\n+    switch (result) {\n+      case 1:\n+        log('sb');\n+        break;\n+      case 0:\n+        return;\n+    }\n+    log('sc');\n+  }\n+\n+  log('f2');\n+}\n+\n+Future<int> bar() async => 1;\n+\n+Future<void> main() async {\n+  trace.clear();\n+  await test(true);\n+  Expect.equals('f1,sb,sc,f2', trace.join(','));\n+\n+  trace.clear();\n+  await test(false);\n+  Expect.equals('f1,f2', trace.join(','));\n+}"
        },
        {
          "filename": "tests/language/type_object/explicit_instantiated_type_literal_error_test.dart",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -2,7 +2,7 @@\n // for details. All rights reserved. Use of this source code is governed by a\n // BSD-style license that can be found in the LICENSE file.\n \n-// SharedOptions=--enable-experiment=constructor-tearoffs\n+\n \n // Tests that explicitly instantiated type objects only work\n // when instantiated correctly."
        },
        {
          "filename": "tests/language/type_object/explicit_instantiated_type_literal_test.dart",
          "status": "modified",
          "additions": 0,
          "deletions": 2,
          "patch": "@@ -2,8 +2,6 @@\n // for details. All rights reserved. Use of this source code is governed by a\n // BSD-style license that can be found in the LICENSE file.\n \n-// SharedOptions=--enable-experiment=constructor-tearoffs\n-\n import \"package:expect/expect.dart\";\n \n import \"../static_type_helper.dart\";"
        },
        {
          "filename": "tests/language/typedef/aliased_constructor_tear_off_test.dart",
          "status": "modified",
          "additions": 8,
          "deletions": 10,
          "patch": "@@ -2,8 +2,6 @@\n // for details. All rights reserved. Use of this source code is governed by a\n // BSD-style license that can be found in the LICENSE file.\n \n-// SharedOptions=--enable-experiment=constructor-tearoffs\n-\n // Tests that constructor tear-offs from type aliases work and\n // are canonicalized correctly\n \n@@ -115,15 +113,15 @@ void main() {\n   context<C<int> Function(int)>(\n       Bounded.named..expectStaticType<Exactly<C<int> Function(int)>>());\n \n-  context<C<C<int>> Function(C<int>)>(Wrapping.new\n-    ..expectStaticType<Exactly<C<C<int>> Function(C<int>)>>());\n-  context<C<C<int>> Function(C<int>)>(Wrapping.named\n-    ..expectStaticType<Exactly<C<C<int>> Function(C<int>)>>());\n+  context<C<C<int>> Function(C<int>)>(\n+      Wrapping.new..expectStaticType<Exactly<C<C<int>> Function(C<int>)>>());\n+  context<C<C<int>> Function(C<int>)>(\n+      Wrapping.named..expectStaticType<Exactly<C<C<int>> Function(C<int>)>>());\n \n-  context<C<int> Function(int)>(Extra.new\n-    ..expectStaticType<Exactly<C<int> Function(int)>>());\n-  context<C<int> Function(int)>(Extra.named\n-    ..expectStaticType<Exactly<C<int> Function(int)>>());\n+  context<C<int> Function(int)>(\n+      Extra.new..expectStaticType<Exactly<C<int> Function(int)>>());\n+  context<C<int> Function(int)>(\n+      Extra.named..expectStaticType<Exactly<C<int> Function(int)>>());\n \n   // Uninstantiated tear-offs always canonicalize.\n   Expect.identical(Direct.new, Direct.new);"
        },
        {
          "filename": "tests/language/typedef/aliased_type_literal_instantiation_test.dart",
          "status": "modified",
          "additions": 0,
          "deletions": 2,
          "patch": "@@ -2,8 +2,6 @@\n // for details. All rights reserved. Use of this source code is governed by a\n // BSD-style license that can be found in the LICENSE file.\n \n-// SharedOptions=--enable-experiment=constructor-tearoffs\n-\n // Tests that type literals made from type aliases work and\n // are canonicalized correctly\n "
        },
        {
          "filename": "tests/language/vm/regress_flutter_42845_test.dart",
          "status": "modified",
          "additions": 0,
          "deletions": 2,
          "patch": "@@ -2,8 +2,6 @@\n // for details. All rights reserved. Use of this source code is governed by a\n // BSD-style license that can be found in the LICENSE file.\n \n-// SharedOptions=--enable-experiment=extension-methods\n-\n // Tests exported extensions.\n \n import \"regress_flutter_42845_lib.dart\";"
        },
        {
          "filename": "tests/language_2/async_star/regression_47610_test.dart",
          "status": "added",
          "additions": 34,
          "deletions": 0,
          "patch": "@@ -0,0 +1,34 @@\n+// Copyright (c) 2021, the Dart project authors.  Please see the AUTHORS file\n+// for details. All rights reserved. Use of this source code is governed by a\n+// BSD-style license that can be found in the LICENSE file.\n+\n+// @dart = 2.9\n+\n+// Regression test for https://github.com/dart-lang/sdk/issues/47610.\n+// Tests returning value from a deep context depth along with\n+// breaking from 'await for'.\n+\n+import \"dart:async\";\n+import \"package:expect/expect.dart\";\n+import \"package:async_helper/async_helper.dart\";\n+\n+Stream<int> foo() async* {\n+  for (int i = 0; i < 2; ++i) {\n+    for (int j = 0; j < 2; ++j) {\n+      for (int k = 0; k < 2; ++k) {\n+        yield i + j + k;\n+      }\n+    }\n+  }\n+}\n+\n+void test() async {\n+  await for (var x in foo()) {\n+    Expect.equals(0, x);\n+    break;\n+  }\n+}\n+\n+void main() {\n+  asyncTest(test);\n+}"
        },
        {
          "filename": "tests/language_2/mixin/regress_47645_test.dart",
          "status": "added",
          "additions": 21,
          "deletions": 0,
          "patch": "@@ -0,0 +1,21 @@\n+// Copyright (c) 2021, the Dart project authors.  Please see the AUTHORS file\n+// for details. All rights reserved. Use of this source code is governed by a\n+// BSD-style license that can be found in the LICENSE file.\n+\n+// @dart = 2.9\n+\n+import \"package:expect/expect.dart\";\n+\n+// Regression test for https://github.com/dart-lang/sdk/issues/47645.\n+// To reproduce the issue the class declaration must appear before the mixin\n+// declaration.\n+class C<T> with M<C<T>> {}\n+\n+mixin M<T> {\n+  bool fn() => true;\n+}\n+\n+void main() {\n+  var c = C<int>();\n+  Expect.isTrue(c.fn());\n+}"
        },
        {
          "filename": "tests/lib/mirrors/method_mirror_extension_test.dart",
          "status": "modified",
          "additions": 0,
          "deletions": 2,
          "patch": "@@ -2,8 +2,6 @@\n // for details. All rights reserved. Use of this source code is governed by a\n // BSD-style license that can be found in the LICENSE file.\n \n-// SharedOptions=--enable-experiment=extension-methods\n-\n library lib;\n \n import \"dart:mirrors\";"
        },
        {
          "filename": "tools/VERSION",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -28,4 +28,4 @@ MAJOR 2\n MINOR 15\n PATCH 0\n PRERELEASE 268\n-PRERELEASE_PATCH 8\n\\ No newline at end of file\n+PRERELEASE_PATCH 18\n\\ No newline at end of file"
        },
        {
          "filename": "tools/experimental_features.yaml",
          "status": "modified",
          "additions": 5,
          "deletions": 0,
          "patch": "@@ -151,6 +151,7 @@ features:\n         S s = 'feature enabled';\n         print(s);\n       }\n+    expired: true\n \n   non-nullable:\n     help: \"Non Nullable by default\"\n@@ -161,10 +162,12 @@ features:\n         int? a = null;\n         print('feature enabled');\n       }\n+    expired: true\n \n   extension-methods:\n     help: \"Extension Methods\"\n     enabledIn: '2.6.0'\n+    expired: true\n \n   constant-update-2018:\n     help: \"Enhanced constant expressions\"\n@@ -181,6 +184,7 @@ features:\n       Allow annotations to accept type arguments;\n       also allow generic function types as type arguments.\n     enabledIn: '2.14.0'\n+    expired: true\n \n   set-literals:\n     help: \"Set Literals\"\n@@ -202,6 +206,7 @@ features:\n       void main() {\n         if ((A() >>> 1) == 42) print('feature enabled');\n       }\n+    expired: true\n \n   constructor-tearoffs:\n     help: \"Allow constructor tear-offs and explicit generic instantiations.\""
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 39,
        "unique_directories": 45,
        "max_directory_depth": 6
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "e1ba3ea504fb561cfdc3cdc67c5ae61fe0c19d4a",
            "date": "2025-01-14T14:40:18Z",
            "author_login": "stereotype441"
          },
          {
            "sha": "61336f32ab43c11747eb22ff6d1ca91c38b987c6",
            "date": "2025-01-14T13:20:33Z",
            "author_login": "mkustermann"
          },
          {
            "sha": "e13db8b7739def53f2c2d1609839c40464fd740e",
            "date": "2025-01-14T13:07:38Z",
            "author_login": "mkustermann"
          },
          {
            "sha": "ac9acf51659ec55d0dc1096305a0c7c7a5aa34dc",
            "date": "2025-01-14T12:54:20Z",
            "author_login": "dcharkes"
          },
          {
            "sha": "6aeb8657810ab3dc55b2a60bcd4328be6490dd10",
            "date": "2025-01-14T12:09:47Z",
            "author_login": "mkustermann"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 4.6,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:U/C:N/I:L/A:L",
    "cwe_id": "CWE-284",
    "description": "Bidirectional Unicode text can be interpreted and compiled differently than how it appears in editors which can be exploited to get nefarious code passed a code review by appearing benign. An attacker could embed a source that is invisible to a code reviewer that modifies the behavior of a program in unexpected ways.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2022-01-05T11:15:08.120",
    "last_modified": "2024-11-21T05:50:20.357",
    "fix_date": "2021-11-17T10:39:23Z"
  },
  "references": [
    {
      "url": "https://github.com/dart-lang/sdk/blob/main/CHANGELOG.md",
      "source": "cve-coordination@google.com",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/dart-lang/sdk/commit/52519ea8eb4780c468c4c2ed00e7c8046ccfed41",
      "source": "cve-coordination@google.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/dart-lang/sdk/blob/main/CHANGELOG.md",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/dart-lang/sdk/commit/52519ea8eb4780c468c4c2ed00e7c8046ccfed41",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:37.047309",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "sdk",
    "owner": "dart-lang",
    "created_at": "2015-05-16T14:14:58Z",
    "updated_at": "2025-01-14T14:41:25Z",
    "pushed_at": "2025-01-14T14:41:19Z",
    "size": 1476140,
    "stars": 10381,
    "forks": 1603,
    "open_issues": 8145,
    "watchers": 10381,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [
      "beta",
      "dev",
      "main",
      "master",
      "stable"
    ],
    "languages": {
      "Dart": 145669978,
      "C++": 23871549,
      "C": 1579300,
      "Python": 1290938,
      "HTML": 702875,
      "Java": 589555,
      "JavaScript": 277923,
      "Shell": 107149,
      "GAP": 97087,
      "CSS": 76022,
      "ANTLR": 48460,
      "TeX": 37865,
      "SCSS": 22311,
      "Makefile": 10867,
      "Assembly": 8350,
      "Batchfile": 4772,
      "CMake": 1598,
      "Objective-C++": 854,
      "Dockerfile": 499
    },
    "commit_activity": {
      "total_commits_last_year": 5883,
      "avg_commits_per_week": 113.13461538461539,
      "days_active_last_year": 304
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "bsd-3-clause"
    },
    "collected_at": "2025-01-14T14:47:50.604306"
  }
}