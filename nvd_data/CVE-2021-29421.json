{
  "cve_id": "CVE-2021-29421",
  "github_data": {
    "repository": "pikepdf/pikepdf",
    "fix_commit": "3f38f73218e5e782fe411ccbb3b44a793c0b343a",
    "related_commits": [
      "3f38f73218e5e782fe411ccbb3b44a793c0b343a",
      "3f38f73218e5e782fe411ccbb3b44a793c0b343a"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "3f38f73218e5e782fe411ccbb3b44a793c0b343a",
      "commit_date": "2021-03-27T07:43:21Z",
      "author": {
        "login": "jbarlow83",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Fix XXE vulnerability in XMP metadata parsing",
        "length": 203,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 64,
        "additions": 59,
        "deletions": 5
      },
      "files": [
        {
          "filename": "src/pikepdf/_xml.py",
          "status": "added",
          "additions": 30,
          "deletions": 0,
          "patch": "@@ -0,0 +1,30 @@\n+# This Source Code Form is subject to the terms of the Mozilla Public\n+# License, v. 2.0. If a copy of the MPL was not distributed with this\n+# file, You can obtain one at http://mozilla.org/MPL/2.0/.\n+#\n+# Copyright (C) 2021, James R. Barlow (https://github.com/jbarlow83/)\n+\n+\n+from typing import IO, Any, AnyStr, Union\n+\n+from lxml.etree import XMLParser as _UnsafeXMLParser\n+from lxml.etree import parse as _parse\n+\n+\n+class _XMLParser(_UnsafeXMLParser):\n+    def __init__(self, *args, **kwargs):\n+        # Prevent XXE attacks\n+        # https://rules.sonarsource.com/python/type/Vulnerability/RSPEC-2755\n+        kwargs['resolve_entities'] = False\n+        kwargs['no_network'] = True\n+        super().__init__(*args, **kwargs)\n+\n+\n+def parse_xml(source: Union[AnyStr, IO[Any]], recover: bool = False):\n+    \"\"\"Wrapper around lxml's parse to provide protection against XXE attacks.\"\"\"\n+\n+    parser = _XMLParser(recover=recover, remove_pis=False)\n+    return _parse(source, parser=parser)\n+\n+\n+__all__ = ['parse_xml']"
        },
        {
          "filename": "src/pikepdf/models/metadata.py",
          "status": "modified",
          "additions": 5,
          "deletions": 5,
          "patch": "@@ -26,10 +26,11 @@\n from warnings import warn\n \n from lxml import etree\n-from lxml.etree import QName, XMLParser, XMLSyntaxError, parse\n+from lxml.etree import QName, XMLSyntaxError\n \n from .. import Name, Stream, String\n from .. import __version__ as pikepdf_version\n+from .._xml import parse_xml\n \n if sys.version_info < (3, 9):  # pragma: no cover\n     from typing import Iterable, MutableMapping\n@@ -413,14 +414,13 @@ def _load_from(self, data: bytes) -> None:\n             data = XMP_EMPTY  # on some platforms lxml chokes on empty documents\n \n         def basic_parser(xml):\n-            return parse(BytesIO(xml))\n+            return parse_xml(BytesIO(xml))\n \n         def strip_illegal_bytes_parser(xml):\n-            return parse(BytesIO(re_xml_illegal_bytes.sub(b'', xml)))\n+            return parse_xml(BytesIO(re_xml_illegal_bytes.sub(b'', xml)))\n \n         def recovery_parser(xml):\n-            parser = XMLParser(recover=True)\n-            return parse(BytesIO(xml), parser)\n+            return parse_xml(BytesIO(xml), recover=True)\n \n         def replace_with_empty_xmp(_xml=None):\n             log.warning(\"Error occurred parsing XMP, replacing with empty XMP.\")"
        },
        {
          "filename": "tests/test_metadata.py",
          "status": "modified",
          "additions": 24,
          "deletions": 0,
          "patch": "@@ -729,3 +729,27 @@ def test_exception_undoes_edits(graph):\n             raise\n         m = graph.open_metadata()\n         assert m['dc:format'] != 'application/pdf-demo'\n+\n+\n+def test_xxe(trivial, outdir):\n+    secret = outdir / 'secret.txt'\n+    secret.write_text(\"This is a secret\")\n+    trivial.Root.Metadata = Stream(\n+        trivial,\n+        b\"\"\"\\\n+<?xpacket begin='\\xef\\xbb\\xbf' id='W5M0MpCehiHzreSzNTczkc9d'?>\n+<!DOCTYPE rdf:RDF [<!ENTITY xxe SYSTEM \"file://%s\">]>\n+<x:xmpmeta xmlns:x='adobe:ns:meta/' x:xmptk='Image'>\n+<rdf:RDF xmlns:rdf=\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\">\n+<note>\n+<to>&xxe;</to>\n+<from>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</from>\n+</note>\n+</rdf:RDF>\n+</x:xmpmeta>\n+<?xpacket end='w'?>\n+    \"\"\"\n+        % os.fsencode(secret),\n+    )\n+    with trivial.open_metadata() as m:\n+        assert 'This is a secret' not in str(m)"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 3,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "2662d9da649a3b354422673fb62bcfe0a1b9ba4c",
            "date": "2025-01-26T01:00:22Z",
            "author_login": "jbarlow83"
          },
          {
            "sha": "742a26e286b557f56d7b6facea51d2477b6c71ea",
            "date": "2025-01-03T19:14:12Z",
            "author_login": "jbarlow83"
          },
          {
            "sha": "51e5434b08eda702c258c988e898777ad28e7579",
            "date": "2025-01-03T18:32:52Z",
            "author_login": "jbarlow83"
          },
          {
            "sha": "d2e47383a1b09221b952a94c5c294f2db6313c2f",
            "date": "2025-01-03T18:32:42Z",
            "author_login": "jbarlow83"
          },
          {
            "sha": "a4dddf5f6bbc4ace2bbb184696509c2d1155b76d",
            "date": "2025-01-02T04:38:40Z",
            "author_login": "jbarlow83"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 7.5,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N",
    "cwe_id": "CWE-611",
    "description": "models/metadata.py in the pikepdf package 1.3.0 through 2.9.2 for Python allows XXE when parsing XMP metadata entries.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2021-04-01T20:15:12.453",
    "last_modified": "2024-11-21T06:01:03.820",
    "fix_date": "2021-03-27T07:43:21Z"
  },
  "references": [
    {
      "url": "https://github.com/pikepdf/pikepdf/blob/v2.10.0/docs/release_notes.rst#v2100",
      "source": "cve@mitre.org",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/pikepdf/pikepdf/commit/3f38f73218e5e782fe411ccbb3b44a793c0b343a",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/36P4HTLBJPO524WMQWW57N3QRF4RFSJG/",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/3QFLBBYGEDNXJ7FS6PIWTVI4T4BUPGEQ/",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "https://github.com/pikepdf/pikepdf/blob/v2.10.0/docs/release_notes.rst#v2100",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/pikepdf/pikepdf/commit/3f38f73218e5e782fe411ccbb3b44a793c0b343a",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/36P4HTLBJPO524WMQWW57N3QRF4RFSJG/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/3QFLBBYGEDNXJ7FS6PIWTVI4T4BUPGEQ/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:01:33.509682",
    "processing_status": "enhanced"
  },
  "repository_context": {
    "name": "pikepdf",
    "owner": "pikepdf",
    "created_at": "2017-09-14T20:22:29Z",
    "updated_at": "2025-01-26T05:33:47Z",
    "pushed_at": "2025-01-26T01:00:27Z",
    "size": 8688,
    "stars": 2246,
    "forks": 195,
    "open_issues": 42,
    "watchers": 2246,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [
      "main"
    ],
    "languages": {
      "Python": 564327,
      "C++": 184968,
      "Shell": 2858,
      "Makefile": 1687,
      "PowerShell": 564
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "mpl-2.0"
    },
    "collected_at": "2025-01-26T08:05:54.102571"
  }
}