{
  "cve_id": "CVE-2021-29439",
  "github_data": {
    "repository": "getgrav/grav-plugin-admin",
    "fix_commit": "a220359877fd1281f76ba732e5308e0e3002e4b1",
    "related_commits": [
      "a220359877fd1281f76ba732e5308e0e3002e4b1",
      "a220359877fd1281f76ba732e5308e0e3002e4b1"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "a220359877fd1281f76ba732e5308e0e3002e4b1",
      "commit_date": "2021-04-13T18:21:55Z",
      "author": {
        "login": "rhukster",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Merge branch 'release/1.10.11'",
        "length": 30,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 345,
        "additions": 230,
        "deletions": 115
      },
      "files": [
        {
          "filename": "CHANGELOG.md",
          "status": "modified",
          "additions": 9,
          "deletions": 0,
          "patch": "@@ -1,3 +1,12 @@\n+# v1.10.11\n+## 04/13/2021\n+\n+1. [](#bugfix)\n+    * **IMPORTANT** Fixed security vulnerability that allows installation of plugins with minimal admin privileges (GHSA-wg37-cf5x-55hq)[https://github.com/getgrav/grav-plugin-admin/security/advisories/GHSA-wg37-cf5x-55hq]\n+    * Fixed `You have been logged out` message when entering to 2FA authentication due to `/admin/task:getNotifications` AJAX call\n+    * Fixed broken 2FA login when site is not configured to use Flex Users [#2109](https://github.com/getgrav/grav-plugin-admin/issues/2109)\n+    * Fixed error message when user clicks logout link after the session has been expired\n+\n # v1.10.10\n ## 04/07/2021\n "
        },
        {
          "filename": "blueprints.yaml",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -1,7 +1,7 @@\n name: Admin Panel\n slug: admin\n type: plugin\n-version: 1.10.10\n+version: 1.10.11\n description: Adds an advanced administration panel to manage your site\n icon: empire\n author:"
        },
        {
          "filename": "classes/plugin/AdminBaseController.php",
          "status": "modified",
          "additions": 32,
          "deletions": 3,
          "patch": "@@ -105,10 +105,17 @@ class AdminBaseController\n      */\n     public function execute()\n     {\n+        // Ignore blacklisted views.\n         if (in_array($this->view, $this->blacklist_views, true)) {\n             return false;\n         }\n \n+        // Make sure that user is logged into admin.\n+        if (!$this->admin->authorize()) {\n+            return false;\n+        }\n+\n+        // Always validate nonce.\n         if (!$this->validateNonce()) {\n             return false;\n         }\n@@ -222,6 +229,7 @@ protected function validateNonce()\n      *\n      * @param string $path The path to redirect to\n      * @param int    $code The HTTP redirect code\n+     * @return void\n      */\n     public function setRedirect($path, $code = 303)\n     {\n@@ -234,6 +242,7 @@ public function setRedirect($path, $code = 303)\n      *\n      * @param array $json\n      * @param int $code\n+     * @return never-return\n      */\n     protected function sendJsonResponse(array $json, $code = 200): void\n     {\n@@ -245,6 +254,7 @@ protected function sendJsonResponse(array $json, $code = 200): void\n \n     /**\n      * @param ResponseInterface $response\n+     * @return never-return\n      */\n     protected function close(ResponseInterface $response): void\n     {\n@@ -259,7 +269,7 @@ protected function close(ResponseInterface $response): void\n      */\n     public function taskFilesUpload()\n     {\n-        if (null === $_FILES || !$this->authorizeTask('save', $this->dataPermissions())) {\n+        if (null === $_FILES || !$this->authorizeTask('upload file', $this->dataPermissions())) {\n             return false;\n         }\n \n@@ -597,7 +607,7 @@ protected function normalizeFiles($data, $key = '')\n      */\n     public function taskFilesSessionRemove()\n     {\n-        if (!$this->authorizeTask('save', $this->dataPermissions())) {\n+        if (!$this->authorizeTask('delete file', $this->dataPermissions())) {\n             return false;\n         }\n \n@@ -654,6 +664,8 @@ public function taskFilesSessionRemove()\n      * Redirect to the route stored in $this->redirect\n      *\n      * Route may or may not be prefixed by /en or /admin or /en/admin.\n+     *\n+     * @return void\n      */\n     public function redirect()\n     {\n@@ -706,6 +718,10 @@ protected function jsonDecode(array $data)\n         return $data;\n     }\n \n+    /**\n+     * @param array $source\n+     * @return array\n+     */\n     protected function cleanDataKeys($source = [])\n     {\n         $out = [];\n@@ -786,10 +802,12 @@ protected function storeFiles($obj)\n \n     /**\n      * Used by the filepicker field to get a list of files in a folder.\n+     *\n+     * @return bool\n      */\n     protected function taskGetFilesInFolder()\n     {\n-        if (!$this->authorizeTask('save', $this->dataPermissions())) {\n+        if (!$this->authorizeTask('get files', $this->dataPermissions())) {\n             return false;\n         }\n \n@@ -903,6 +921,11 @@ protected function taskGetFilesInFolder()\n         return true;\n     }\n \n+    /**\n+     * @param string $file\n+     * @param array $settings\n+     * @return false\n+     */\n     protected function filterAcceptedFiles($file, $settings)\n     {\n         $valid = false;\n@@ -922,6 +945,10 @@ protected function filterAcceptedFiles($file, $settings)\n      */\n     protected function taskRemoveFileFromBlueprint()\n     {\n+        if (!$this->authorizeTask('remove file', $this->dataPermissions())) {\n+            return false;\n+        }\n+\n         /** @var Uri $uri */\n         $uri       = $this->grav['uri'];\n         $blueprint = base64_decode($uri->param('blueprint'));\n@@ -1049,6 +1076,8 @@ protected function taskRemoveFileFromBlueprint()\n     /**\n      * Handles removing a media file\n      *\n+     * @note This task cannot be used anymore.\n+     *\n      * @return bool True if the action was performed\n      */\n     public function taskRemoveMedia($filename = null)"
        },
        {
          "filename": "classes/plugin/AdminController.php",
          "status": "modified",
          "additions": 152,
          "deletions": 72,
          "patch": "@@ -37,7 +37,6 @@\n use RocketTheme\\Toolbox\\ResourceLocator\\UniformResourceLocator;\n use Twig\\Loader\\FilesystemLoader;\n \n-\n /**\n  * Class AdminController\n  *\n@@ -51,6 +50,7 @@ class AdminController extends AdminBaseController\n      * @param string|null $task\n      * @param string|null $route\n      * @param array|null $post\n+     * @return void\n      */\n     public function initialize(Grav $grav = null, $view = null, $task = null, $route = null, $post = null)\n     {\n@@ -80,6 +80,7 @@ public function initialize(Grav $grav = null, $view = null, $task = null, $route\n      */\n     protected function taskKeepAlive(): void\n     {\n+        // This task is available for all admin users.\n         $response = new Response(200);\n \n         $this->close($response);\n@@ -92,7 +93,7 @@ protected function taskKeepAlive(): void\n      */\n     protected function taskClearCache()\n     {\n-        if (!$this->authorizeTask('clear cache', ['admin.cache', 'admin.super', 'admin.maintenance'])) {\n+        if (!$this->authorizeTask('clear cache', ['admin.cache', 'admin.maintenance', 'admin.super'])) {\n             return false;\n         }\n \n@@ -144,8 +145,10 @@ public function taskSave()\n \n         switch ($this->view) {\n             case 'pages':\n+                // Not used if Flex-Objects plugin handles pages.\n                 return $this->savePage();\n             case 'user':\n+                // Not used if Flex-Objects plugin handles users.\n                 return $this->saveUser();\n             default:\n                 return $this->saveDefault();\n@@ -204,21 +207,19 @@ protected function saveDefault()\n      */\n     protected function taskLogout()\n     {\n-        if (!$this->authorizeTask('logout', ['admin.login'])) {\n+        if (!$this->authorizeTask('logout', ['admin.login', 'admin.super'])) {\n             return false;\n         }\n \n         $this->admin->logout($this->data, $this->post);\n-\n-        return true;\n     }\n \n     /**\n      * @return bool\n      */\n     public function taskRegenerate2FASecret()\n     {\n-        if (!$this->authorizeTask('regenerate 2FA Secret', ['admin.login'])) {\n+        if (!$this->authorizeTask('regenerate 2FA Secret', ['admin.login', 'admin.super'])) {\n             return false;\n         }\n \n@@ -265,6 +266,8 @@ public function taskRegenerate2FASecret()\n      *\n      * Called by more general save task.\n      *\n+     * @note Not used if Flex-Objects plugin handles users.\n+     *\n      * @return bool\n      */\n     protected function saveUser()\n@@ -330,7 +333,7 @@ protected function saveUser()\n     /**\n      * Get Notifications\n      *\n-     * @return void\n+     * @return never-return\n      */\n     protected function taskGetNotifications(): void\n     {\n@@ -377,7 +380,7 @@ protected function taskGetNotifications(): void\n      */\n     protected function taskHideNotification()\n     {\n-        if (!$this->authorizeTask('hide notification', ['admin.login'])) {\n+        if (!$this->authorizeTask('hide notification', ['admin.login', 'admin.super'])) {\n             return false;\n         }\n \n@@ -409,7 +412,7 @@ protected function taskHideNotification()\n     /**\n      * Get Newsfeeds\n      *\n-     * @return void\n+     * @return never-return\n      */\n     protected function taskGetNewsFeed(): void\n     {\n@@ -447,11 +450,11 @@ protected function taskGetNewsFeed(): void\n      */\n     protected function taskBackup()\n     {\n-        $param_sep = $this->grav['config']->get('system.param_sep', ':');\n         if (!$this->authorizeTask('backup', ['admin.maintenance', 'admin.super'])) {\n             return false;\n         }\n \n+        $param_sep = $this->grav['config']->get('system.param_sep', ':');\n         $download = $this->grav['uri']->param('download');\n \n         try {\n@@ -549,11 +552,11 @@ protected function taskBackupDelete()\n      */\n     public function taskEnable()\n     {\n-        if (!$this->authorizeTask('enable plugin', ['admin.plugins', 'admin.super'])) {\n+        if ($this->view !== 'plugins') {\n             return false;\n         }\n \n-        if ($this->view !== 'plugins') {\n+        if (!$this->authorizeTask('enable plugin', ['admin.plugins', 'admin.super'])) {\n             return false;\n         }\n \n@@ -579,11 +582,11 @@ public function taskEnable()\n      */\n     public function taskDisable()\n     {\n-        if (!$this->authorizeTask('disable plugin', ['admin.plugins', 'admin.super'])) {\n+        if ($this->view !== 'plugins') {\n             return false;\n         }\n \n-        if ($this->view !== 'plugins') {\n+        if (!$this->authorizeTask('disable plugin', ['admin.plugins', 'admin.super'])) {\n             return false;\n         }\n \n@@ -609,11 +612,11 @@ public function taskDisable()\n      */\n     public function taskActivate()\n     {\n-        if (!$this->authorizeTask('activate theme', ['admin.themes', 'admin.super'])) {\n+        if ($this->view !== 'themes') {\n             return false;\n         }\n \n-        if ($this->view !== 'themes') {\n+        if (!$this->authorizeTask('activate theme', ['admin.themes', 'admin.super'])) {\n             return false;\n         }\n \n@@ -676,8 +679,6 @@ public function taskUpdategrav()\n         }\n \n         $this->sendJsonResponse($json_response);\n-\n-        return true;\n     }\n \n     /**\n@@ -692,7 +693,11 @@ public function taskUpdategrav()\n      */\n     public function taskUninstall()\n     {\n-        $type = $this->view === 'plugins' ? 'plugins' : 'themes';\n+        $type = $this->view;\n+        if ($type !== 'plugins' && $type !== 'themes') {\n+            return false;\n+        }\n+\n         if (!$this->authorizeTask('uninstall ' . $type, ['admin.' . $type, 'admin.super'])) {\n             return false;\n         }\n@@ -719,7 +724,7 @@ public function taskUninstall()\n      */\n     protected function taskGpmRelease()\n     {\n-        if (!$this->authorizeTask('configuration', ['admin.configuration.system', 'admin.super'])) {\n+        if (!$this->authorizeTask('configuration', ['admin.super'])) {\n             return false;\n         }\n \n@@ -762,7 +767,11 @@ protected function taskGpmRelease()\n      */\n     protected function taskGetUpdates()\n     {\n-        if (!$this->authorizeTask('dashboard', ['admin.login', 'admin.super'])) {\n+        if ($this->view !== 'update') {\n+            return false;\n+        }\n+\n+        if (!$this->authorizeTask('dashboard', ['admin.plugins', 'admin.themes', 'admin.super'])) {\n             return false;\n         }\n \n@@ -832,6 +841,10 @@ protected function taskGetUpdates()\n      */\n     protected function taskGetPackagesDependencies()\n     {\n+        if (!$this->authorizeTask('dashboard', ['admin.plugins', 'admin.themes', 'admin.super'])) {\n+            return false;\n+        }\n+\n         $data     = $this->post;\n         $packages = isset($data['packages']) ? explode(',', $data['packages']) : '';\n         $packages = (array)$packages;\n@@ -859,11 +872,11 @@ protected function taskGetPackagesDependencies()\n      */\n     protected function taskInstallDependenciesOfPackages()\n     {\n-        $data     = $this->post;\n-        $packages = isset($data['packages']) ? explode(',', $data['packages']) : '';\n-        $packages = (array)$packages;\n-\n+        $data = $this->post;\n         $type = $data['type'] ?? '';\n+        if ($type !== 'plugins' && $type !== 'themes') {\n+            return false;\n+        }\n \n         if (!$this->authorizeTask('install ' . $type, ['admin.' . $type, 'admin.super'])) {\n             $this->admin->json_response = [\n@@ -874,6 +887,9 @@ protected function taskInstallDependenciesOfPackages()\n             return false;\n         }\n \n+        $packages = isset($data['packages']) ? explode(',', $data['packages']) : '';\n+        $packages = (array)$packages;\n+\n         try {\n             $dependencies = $this->admin->getDependenciesNeededToInstall($packages);\n         } catch (\\Exception $e) {\n@@ -906,9 +922,11 @@ protected function taskInstallDependenciesOfPackages()\n      */\n     protected function taskInstallPackage($reinstall = false)\n     {\n-        $data    = $this->post;\n-        $package = $data['package'] ?? '';\n-        $type    = $data['type'] ?? '';\n+        $data = $this->post;\n+        $type = $data['type'] ?? '';\n+        if ($type !== 'plugins' && $type !== 'themes') {\n+            return false;\n+        }\n \n         if (!$this->authorizeTask('install ' . $type, ['admin.' . $type, 'admin.super'])) {\n             $this->admin->json_response = [\n@@ -919,6 +937,7 @@ protected function taskInstallPackage($reinstall = false)\n             return false;\n         }\n \n+        $package = $data['package'] ?? '';\n         try {\n             $result = Gpm::install($package, ['theme' => $type === 'theme']);\n         } catch (\\Exception $e) {\n@@ -954,14 +973,15 @@ protected function taskInstallPackage($reinstall = false)\n     /**\n      * Handle removing a package\n      *\n-     * @return void\n+     * @return bool\n      */\n-    protected function taskRemovePackage(): void\n+    protected function taskRemovePackage(): bool\n     {\n         $data    = $this->post;\n-        $package = $data['package'] ?? '';\n         $type    = $data['type'] ?? '';\n-        $result = false;\n+        if ($type !== 'plugins' && $type !== 'themes') {\n+            return false;\n+        }\n \n         if (!$this->authorizeTask('uninstall ' . $type, ['admin.' . $type, 'admin.super'])) {\n             $json_response = [\n@@ -972,6 +992,9 @@ protected function taskRemovePackage(): void\n             $this->sendJsonResponse($json_response, 403);\n         }\n \n+        $package = $data['package'] ?? '';\n+        $result = false;\n+\n         //check if there are packages that have this as a dependency. Abort and show which ones\n         $dependent_packages = $this->admin->getPackagesThatDependOnPackage($package);\n         if (count($dependent_packages) > 0) {\n@@ -1023,16 +1046,15 @@ protected function taskRemovePackage(): void\n     /**\n      * Handle reinstalling a package\n      *\n-     * @return void\n+     * @return bool\n      */\n     protected function taskReinstallPackage()\n     {\n         $data = $this->post;\n-\n-        $slug            = $data['slug'] ?? '';\n-        $type            = $data['type'] ?? '';\n-        $package_name    = $data['package_name'] ?? '';\n-        $current_version = $data['current_version'] ?? '';\n+        $type = $data['type'] ?? '';\n+        if ($type !== 'plugins' && $type !== 'themes') {\n+            return false;\n+        }\n \n         if (!$this->authorizeTask('install ' . $type, ['admin.' . $type, 'admin.super'])) {\n             $json_response = [\n@@ -1043,6 +1065,10 @@ protected function taskReinstallPackage()\n             $this->sendJsonResponse($json_response, 403);\n         }\n \n+        $slug            = $data['slug'] ?? '';\n+        $package_name    = $data['package_name'] ?? '';\n+        $current_version = $data['current_version'] ?? '';\n+\n         $url = \"https://getgrav.org/download/{$type}s/$slug/$current_version\";\n \n         $result = Gpm::directInstall($url);\n@@ -1059,6 +1085,8 @@ protected function taskReinstallPackage()\n                 'message' => $this->admin::translate('PLUGIN_ADMIN.REINSTALLATION_FAILED')\n             ];\n         }\n+\n+        return true;\n     }\n \n     /**\n@@ -1129,11 +1157,19 @@ protected function taskDirectInstall()\n     /**\n      * Handles creating an empty page folder (without markdown file)\n      *\n+     * Route: /pages\n+     *\n+     * @note Not used if Flex-Objects plugin handles pages.\n+     *\n      * @return bool True if the action was performed.\n      */\n     public function taskSaveNewFolder()\n     {\n-        if (!$this->authorizeTask('save', $this->dataPermissions())) {\n+        if ($this->view !== 'pages') {\n+            return false;\n+        }\n+\n+        if (!$this->authorizeTask('new folder', ['admin.pages', 'admin.super'])) {\n             return false;\n         }\n \n@@ -1172,6 +1208,8 @@ public function taskSaveNewFolder()\n     }\n \n     /**\n+     * @note Not used if Flex-Objects plugin handles pages.\n+     *\n      * @return bool\n      */\n     protected function savePage()\n@@ -1314,17 +1352,18 @@ protected function savePage()\n      *\n      * Route: /pages\n      *\n+     * @note Not used if Flex-Objects plugin handles pages.\n+     *\n      * @return bool True if the action was performed.\n      * @throws \\RuntimeException\n      */\n     protected function taskCopy()\n     {\n-        if (!$this->authorizeTask('copy page', ['admin.pages', 'admin.super'])) {\n+        if ($this->view !== 'pages') {\n             return false;\n         }\n \n-        // Only applies to pages.\n-        if ($this->view !== 'pages') {\n+        if (!$this->authorizeTask('copy page', ['admin.pages', 'admin.super'])) {\n             return false;\n         }\n \n@@ -1403,16 +1442,17 @@ protected function taskCopy()\n      *\n      * Route: /pages\n      *\n+     * @note Not used if Flex-Objects plugin handles pages.\n+     *\n      * @return bool True if the action was performed.\n      */\n     protected function taskReorder()\n     {\n-        if (!$this->authorizeTask('reorder pages', ['admin.pages', 'admin.super'])) {\n+        if ($this->view !== 'pages') {\n             return false;\n         }\n \n-        // Only applies to pages.\n-        if ($this->view !== 'pages') {\n+        if (!$this->authorizeTask('reorder pages', ['admin.pages', 'admin.super'])) {\n             return false;\n         }\n \n@@ -1426,17 +1466,18 @@ protected function taskReorder()\n      *\n      * Route: /pages\n      *\n+     * @note Not used if Flex-Objects plugin handles pages.\n+     *\n      * @return bool True if the action was performed.\n      * @throws \\RuntimeException\n      */\n     protected function taskDelete()\n     {\n-        if (!$this->authorizeTask('delete page', ['admin.pages', 'admin.super'])) {\n+        if ($this->view !== 'pages') {\n             return false;\n         }\n \n-        // Only applies to pages.\n-        if ($this->view !== 'pages') {\n+        if (!$this->authorizeTask('delete page', ['admin.pages', 'admin.super'])) {\n             return false;\n         }\n \n@@ -1472,10 +1513,16 @@ protected function taskDelete()\n      *\n      * Route: /pages\n      *\n+     * @note Not used if Flex-Objects plugin handles pages.\n+     *\n      * @return bool\n      */\n     protected function taskSwitchlanguage()\n     {\n+        if ($this->view !== 'pages') {\n+            return false;\n+        }\n+\n         if (!$this->authorizeTask('switch language', ['admin.pages', 'admin.super'])) {\n             return false;\n         }\n@@ -1505,11 +1552,19 @@ protected function taskSwitchlanguage()\n     /**\n      * Save the current page in a different language. Automatically switches to that language.\n      *\n+     * Route: /pages\n+     *\n+     * @note Not used if Flex-Objects plugin handles pages.\n+     *\n      * @return bool True if the action was performed.\n      */\n     protected function taskSaveas()\n     {\n-        if (!$this->authorizeTask('save', $this->dataPermissions())) {\n+        if ($this->view !== 'pages') {\n+            return false;\n+        }\n+\n+        if (!$this->authorizeTask('save as', ['admin.pages', 'admin.super'])) {\n             return false;\n         }\n \n@@ -1565,6 +1620,8 @@ protected function taskSaveas()\n     /**\n      * Continue to the new page.\n      *\n+     * @note Not used if Flex-Objects plugin handles pages, users and user groups.\n+     *\n      * @return bool True if the action was performed.\n      */\n     public function taskContinue()\n@@ -1578,12 +1635,6 @@ public function taskContinue()\n             return true;\n         }\n \n-        if ($this->view === 'groups') {\n-            $this->setRedirect(\"{$this->view}/{$data['groupname']}\");\n-\n-            return true;\n-        }\n-\n         if ($this->view !== 'pages') {\n             return false;\n         }\n@@ -1666,10 +1717,18 @@ protected function taskGetLevelListing(): ResponseInterface\n     }\n \n     /**\n+     * Route: /ajax.json\n+     *\n+     * @note Not used if Flex-Objects plugin handles pages.\n+     *\n      * @return bool\n      */\n     protected function taskGetChildTypes()\n     {\n+        if ($this->view !== 'ajax') {\n+            return false;\n+        }\n+\n         if (!$this->authorizeTask('get childtypes', ['admin.pages', 'admin.super'])) {\n             return false;\n         }\n@@ -1709,12 +1768,18 @@ protected function taskGetChildTypes()\n     /**\n      * Handles filtering the page by modular/visible/routable in the pages list.\n      *\n-     * @return void\n+     * @note Used only in legacy pages.\n+     *\n+     * @return bool\n      */\n     protected function taskFilterPages()\n     {\n+        if ($this->view !== 'pages-filter') {\n+            return false;\n+        }\n+\n         if (!$this->authorizeTask('filter pages', ['admin.pages', 'admin.super'])) {\n-            return;\n+            return false;\n         }\n \n         $data = $this->post;\n@@ -1829,12 +1894,16 @@ protected function taskFilterPages()\n             'results' => $results\n         ];\n         $this->admin->collection = $collection;\n+\n+        return true;\n     }\n \n \n     /**\n      * Process the page Markdown\n      *\n+     * Preview task in the builtin editor.\n+     *\n      * @return bool True if the action was performed.\n      */\n     protected function taskProcessMarkdown()\n@@ -1884,12 +1953,16 @@ protected function taskProcessMarkdown()\n     /**\n      * Determines the file types allowed to be uploaded\n      *\n-     * Used by pagemedia field.\n+     * Used by pagemedia field. Works only within legacy pages.\n      *\n      * @return bool True if the action was performed.\n      */\n     protected function taskListmedia()\n     {\n+        if ($this->view !== 'media') {\n+            return false;\n+        }\n+\n         if (!$this->authorizeTask('list media', ['admin.pages', 'admin.super'])) {\n             return false;\n         }\n@@ -1937,12 +2010,16 @@ protected function taskListmedia()\n     /**\n      * Handles adding a media file to a page.\n      *\n-     * Used by pagemedia field.\n+     * Used by pagemedia field. Works only within legacy pages.\n      *\n      * @return bool True if the action was performed.\n      */\n     protected function taskAddmedia()\n     {\n+        if ($this->view !== 'media') {\n+            return false;\n+        }\n+\n         if (!$this->authorizeTask('add media', ['admin.pages', 'admin.super'])) {\n             return false;\n         }\n@@ -2106,8 +2183,7 @@ protected function taskAddmedia()\n      */\n     protected function taskCompileScss()\n     {\n-\n-        if (!$this->authorizeTask('compile scss', ['admin.super'])) {\n+        if (!$this->authorizeTask('compile scss', ['admin.plugins', 'admin.super'])) {\n             return false;\n         }\n \n@@ -2132,16 +2208,15 @@ protected function taskCompileScss()\n             ]\n         ];\n \n-        echo json_encode($json_response);\n-        exit;\n+        $this->sendJsonResponse($json_response);\n     }\n \n     /**\n      * @return bool\n      */\n     protected function taskExportScss()\n     {\n-        if (!$this->authorizeTask('compile scss', ['admin.pages', 'admin.super'])) {\n+        if (!$this->authorizeTask('export scss', ['admin.plugins', 'admin.super'])) {\n             return false;\n         }\n \n@@ -2160,8 +2235,7 @@ protected function taskExportScss()\n             ]\n         ];\n \n-        echo json_encode($json_response);\n-        exit;\n+        $this->sendJsonResponse($json_response);\n     }\n \n     /**\n@@ -2173,6 +2247,10 @@ protected function taskExportScss()\n      */\n     protected function taskDelmedia()\n     {\n+        if ($this->view !== 'media') {\n+            return false;\n+        }\n+\n         if (!$this->authorizeTask('delete media', ['admin.pages', 'admin.super'])) {\n             return false;\n         }\n@@ -2455,10 +2533,6 @@ protected function getLevelListing($data)\n      */\n     public function getMedia(PageInterface $page = null)\n     {\n-        if ($this->view !== 'media') {\n-            return null;\n-        }\n-\n         $page = $page ?? $this->admin->page($this->route);\n         if (!$page) {\n             return null;\n@@ -2753,10 +2827,16 @@ public static function getNextOrderInFolder($path)\n     }\n \n     /**\n-     * @return ResponseInterface\n+     * Used in 3rd party editors (e.g. next-gen).\n+     *\n+     * @return ResponseInterface|false\n      */\n-    protected function taskConvertUrls(): ResponseInterface\n+    protected function taskConvertUrls()\n     {\n+        if (!$this->authorizeTask('access page', ['admin.pages', 'admin.super'])) {\n+            return false;\n+        }\n+\n         $request = $this->getRequest();\n         $data = $request->getParsedBody();\n         $converted_links = [];"
        },
        {
          "filename": "classes/plugin/Controllers/Login/LoginController.php",
          "status": "modified",
          "additions": 5,
          "deletions": 10,
          "patch": "@@ -10,6 +10,7 @@\n namespace Grav\\Plugin\\Admin\\Controllers\\Login;\n \n use Grav\\Common\\Debugger;\n+use Grav\\Common\\Grav;\n use Grav\\Common\\Page\\Pages;\n use Grav\\Common\\Uri;\n use Grav\\Common\\User\\Interfaces\\UserCollectionInterface;\n@@ -209,20 +210,14 @@ public function taskLogin(): ResponseInterface\n     }\n \n     /**\n-     * Handle logout when user isn't fully logged in.\n+     * Handle logout when user isn't fully logged in or clicks logout after the session has been expired.\n      *\n      * @return ResponseInterface\n      */\n     public function taskLogout(): ResponseInterface\n     {\n-        try {\n-            $this->checkNonce();\n-        } catch (PageExpiredException $e) {\n-            $this->setMessage($this->translate('PLUGIN_ADMIN.INVALID_SECURITY_TOKEN'), 'error');\n-\n-            return $this->createDisplayResponse();\n-        }\n-\n+        // We do not need to check the nonce here as user session has been expired or user hasn't fully logged in (2FA).\n+        // Just be sure we terminate the current session.\n         $login = $this->getLogin();\n         $event = $login->logout(['admin' => true], ['return_event' => true]);\n \n@@ -298,7 +293,7 @@ public function taskTwofa(): ResponseInterface\n         }\n \n         // Successful 2FA, authorize user and redirect.\n-        $user->authorized = true;\n+        Grav::instance()['user']->authorized = true;\n \n         Admin::DEBUG && Admin::addDebugMessage('Admin login: 2FA check succeeded, authorize user and redirect');\n "
        },
        {
          "filename": "composer.lock",
          "status": "modified",
          "additions": 24,
          "deletions": 24,
          "patch": "@@ -814,16 +814,16 @@\n         },\n         {\n             \"name\": \"guzzlehttp/psr7\",\n-            \"version\": \"1.7.0\",\n+            \"version\": \"1.8.1\",\n             \"source\": {\n                 \"type\": \"git\",\n                 \"url\": \"https://github.com/guzzle/psr7.git\",\n-                \"reference\": \"53330f47520498c0ae1f61f7e2c90f55690c06a3\"\n+                \"reference\": \"35ea11d335fd638b5882ff1725228b3d35496ab1\"\n             },\n             \"dist\": {\n                 \"type\": \"zip\",\n-                \"url\": \"https://api.github.com/repos/guzzle/psr7/zipball/53330f47520498c0ae1f61f7e2c90f55690c06a3\",\n-                \"reference\": \"53330f47520498c0ae1f61f7e2c90f55690c06a3\",\n+                \"url\": \"https://api.github.com/repos/guzzle/psr7/zipball/35ea11d335fd638b5882ff1725228b3d35496ab1\",\n+                \"reference\": \"35ea11d335fd638b5882ff1725228b3d35496ab1\",\n                 \"shasum\": \"\"\n             },\n             \"require\": {\n@@ -883,9 +883,9 @@\n             ],\n             \"support\": {\n                 \"issues\": \"https://github.com/guzzle/psr7/issues\",\n-                \"source\": \"https://github.com/guzzle/psr7/tree/1.7.0\"\n+                \"source\": \"https://github.com/guzzle/psr7/tree/1.8.1\"\n             },\n-            \"time\": \"2020-09-30T07:37:11+00:00\"\n+            \"time\": \"2021-03-21T16:25:00+00:00\"\n         },\n         {\n             \"name\": \"myclabs/deep-copy\",\n@@ -1215,16 +1215,16 @@\n         },\n         {\n             \"name\": \"phpspec/prophecy\",\n-            \"version\": \"1.12.2\",\n+            \"version\": \"1.13.0\",\n             \"source\": {\n                 \"type\": \"git\",\n                 \"url\": \"https://github.com/phpspec/prophecy.git\",\n-                \"reference\": \"245710e971a030f42e08f4912863805570f23d39\"\n+                \"reference\": \"be1996ed8adc35c3fd795488a653f4b518be70ea\"\n             },\n             \"dist\": {\n                 \"type\": \"zip\",\n-                \"url\": \"https://api.github.com/repos/phpspec/prophecy/zipball/245710e971a030f42e08f4912863805570f23d39\",\n-                \"reference\": \"245710e971a030f42e08f4912863805570f23d39\",\n+                \"url\": \"https://api.github.com/repos/phpspec/prophecy/zipball/be1996ed8adc35c3fd795488a653f4b518be70ea\",\n+                \"reference\": \"be1996ed8adc35c3fd795488a653f4b518be70ea\",\n                 \"shasum\": \"\"\n             },\n             \"require\": {\n@@ -1276,9 +1276,9 @@\n             ],\n             \"support\": {\n                 \"issues\": \"https://github.com/phpspec/prophecy/issues\",\n-                \"source\": \"https://github.com/phpspec/prophecy/tree/1.12.2\"\n+                \"source\": \"https://github.com/phpspec/prophecy/tree/1.13.0\"\n             },\n-            \"time\": \"2020-12-19T10:15:11+00:00\"\n+            \"time\": \"2021-03-17T13:42:18+00:00\"\n         },\n         {\n             \"name\": \"phpunit/php-code-coverage\",\n@@ -2541,16 +2541,16 @@\n         },\n         {\n             \"name\": \"symfony/console\",\n-            \"version\": \"v4.4.20\",\n+            \"version\": \"v4.4.21\",\n             \"source\": {\n                 \"type\": \"git\",\n                 \"url\": \"https://github.com/symfony/console.git\",\n-                \"reference\": \"c98349bda966c70d6c08b4cd8658377c94166492\"\n+                \"reference\": \"1ba4560dbbb9fcf5ae28b61f71f49c678086cf23\"\n             },\n             \"dist\": {\n                 \"type\": \"zip\",\n-                \"url\": \"https://api.github.com/repos/symfony/console/zipball/c98349bda966c70d6c08b4cd8658377c94166492\",\n-                \"reference\": \"c98349bda966c70d6c08b4cd8658377c94166492\",\n+                \"url\": \"https://api.github.com/repos/symfony/console/zipball/1ba4560dbbb9fcf5ae28b61f71f49c678086cf23\",\n+                \"reference\": \"1ba4560dbbb9fcf5ae28b61f71f49c678086cf23\",\n                 \"shasum\": \"\"\n             },\n             \"require\": {\n@@ -2610,7 +2610,7 @@\n             \"description\": \"Eases the creation of beautiful and testable command line interfaces\",\n             \"homepage\": \"https://symfony.com\",\n             \"support\": {\n-                \"source\": \"https://github.com/symfony/console/tree/v4.4.20\"\n+                \"source\": \"https://github.com/symfony/console/tree/v4.4.21\"\n             },\n             \"funding\": [\n                 {\n@@ -2626,7 +2626,7 @@\n                     \"type\": \"tidelift\"\n                 }\n             ],\n-            \"time\": \"2021-02-22T18:44:15+00:00\"\n+            \"time\": \"2021-03-26T09:23:24+00:00\"\n         },\n         {\n             \"name\": \"symfony/css-selector\",\n@@ -3544,16 +3544,16 @@\n         },\n         {\n             \"name\": \"symfony/yaml\",\n-            \"version\": \"v4.4.20\",\n+            \"version\": \"v4.4.21\",\n             \"source\": {\n                 \"type\": \"git\",\n                 \"url\": \"https://github.com/symfony/yaml.git\",\n-                \"reference\": \"29e61305e1c79d25f71060903982ead8f533e267\"\n+                \"reference\": \"3871c720871029f008928244e56cf43497da7e9d\"\n             },\n             \"dist\": {\n                 \"type\": \"zip\",\n-                \"url\": \"https://api.github.com/repos/symfony/yaml/zipball/29e61305e1c79d25f71060903982ead8f533e267\",\n-                \"reference\": \"29e61305e1c79d25f71060903982ead8f533e267\",\n+                \"url\": \"https://api.github.com/repos/symfony/yaml/zipball/3871c720871029f008928244e56cf43497da7e9d\",\n+                \"reference\": \"3871c720871029f008928244e56cf43497da7e9d\",\n                 \"shasum\": \"\"\n             },\n             \"require\": {\n@@ -3595,7 +3595,7 @@\n             \"description\": \"Loads and dumps YAML files\",\n             \"homepage\": \"https://symfony.com\",\n             \"support\": {\n-                \"source\": \"https://github.com/symfony/yaml/tree/v4.4.20\"\n+                \"source\": \"https://github.com/symfony/yaml/tree/v4.4.21\"\n             },\n             \"funding\": [\n                 {\n@@ -3611,7 +3611,7 @@\n                     \"type\": \"tidelift\"\n                 }\n             ],\n-            \"time\": \"2021-02-22T15:36:50+00:00\"\n+            \"time\": \"2021-03-05T17:58:50+00:00\"\n         },\n         {\n             \"name\": \"theseer/tokenizer\","
        },
        {
          "filename": "themes/grav/templates/partials/javascript-config.html.twig",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -1,4 +1,4 @@\n-{% if authorize(['admin.login', 'admin.super']) %}\n+{% if user.authorized and authorize(['admin.login', 'admin.super']) %}\n {% set notifications = (config.plugins.admin.widgets['dashboard-notifications'] or config.plugins.admin.notifications.dashboard or config.plugins.admin.notifications.plugins or config.plugins.admin.notifications.themes) ? 1 : 0 %}\n {% switch template_route %}\n     {% case 'dashboard' %}"
        },
        {
          "filename": "themes/grav/templates/partials/release-toggle.html.twig",
          "status": "modified",
          "additions": 2,
          "deletions": 0,
          "patch": "@@ -1,3 +1,4 @@\n+{% if authorize(['admin.super']) %}\n <form id=\"gpm-release-toggle\">\n     <div class=\"switch-toggle switch-grav\" data-url=\"{{ base_url }}/ajax.json/task:gpmRelease\">\n         <input type=\"radio\" value=\"stable\" id=\"stable\" name=\"channel-switch\" class=\"highlight\" {% if config.system.gpm.releases == 'stable' %} checked=\"checked\"{% endif %}>\n@@ -7,3 +8,4 @@\n         <a></a>\n     </div>\n </form>\n+{% endif %}"
        },
        {
          "filename": "vendor/composer/InstalledVersions.php",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -29,7 +29,7 @@ class InstalledVersions\n     'aliases' => \n     array (\n     ),\n-    'reference' => '63db6543920650ca2da91797df10e8a3fd1aa4c7',\n+    'reference' => '1acb94e85744589877484a13af715394b3558bd2',\n     'name' => 'getgrav/grav-plugin-admin',\n   ),\n   'versions' => \n@@ -41,7 +41,7 @@ class InstalledVersions\n       'aliases' => \n       array (\n       ),\n-      'reference' => '63db6543920650ca2da91797df10e8a3fd1aa4c7',\n+      'reference' => '1acb94e85744589877484a13af715394b3558bd2',\n     ),\n     'laminas/laminas-xml' => \n     array ("
        },
        {
          "filename": "vendor/composer/installed.php",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -6,7 +6,7 @@\n     'aliases' => \n     array (\n     ),\n-    'reference' => '63db6543920650ca2da91797df10e8a3fd1aa4c7',\n+    'reference' => '1acb94e85744589877484a13af715394b3558bd2',\n     'name' => 'getgrav/grav-plugin-admin',\n   ),\n   'versions' => \n@@ -18,7 +18,7 @@\n       'aliases' => \n       array (\n       ),\n-      'reference' => '63db6543920650ca2da91797df10e8a3fd1aa4c7',\n+      'reference' => '1acb94e85744589877484a13af715394b3558bd2',\n     ),\n     'laminas/laminas-xml' => \n     array ("
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 1,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 5,
        "max_directory_depth": 4
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "5b292eca9ba30caaff97e8b238b9fcac433bc8f6",
            "date": "2025-01-18T12:37:41Z",
            "author_login": "pmoreno-rodriguez"
          },
          {
            "sha": "8dc503c8426c5603c775ef405df71f7d9c26c076",
            "date": "2025-01-06T14:22:34Z",
            "author_login": "pips-"
          },
          {
            "sha": "d4d02029d07d76e2115b09e43b19accff223d3b9",
            "date": "2024-12-10T00:12:10Z",
            "author_login": "rhukster"
          },
          {
            "sha": "12bdb5af4bd10e30e24d191b7ea1a78602a583fb",
            "date": "2024-10-31T01:32:09Z",
            "author_login": "rhukster"
          },
          {
            "sha": "746683e3640fef4fab9ae16d646c919afae6b73c",
            "date": "2024-10-28T11:28:12Z",
            "author_login": "rhukster"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 7.2,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H",
    "cwe_id": "CWE-863",
    "description": "The Grav admin plugin prior to version 1.10.11 does not correctly verify caller's privileges. As a consequence, users with the permission `admin.login` can install third-party plugins and their dependencies. By installing the right plugin, an attacker can obtain an arbitrary code execution primitive and elevate their privileges on the instance. The vulnerability has been addressed in version 1.10.11. As a mitigation blocking access to the `/admin` path from untrusted sources will reduce the probability of exploitation. ",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2021-04-13T20:15:22.297",
    "last_modified": "2024-11-21T06:01:06.040",
    "fix_date": "2021-04-13T18:21:55Z"
  },
  "references": [
    {
      "url": "https://github.com/getgrav/grav-plugin-admin/commit/a220359877fd1281f76ba732e5308e0e3002e4b1",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/getgrav/grav-plugin-admin/security/advisories/GHSA-wg37-cf5x-55hq",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/getgrav/grav-plugin-admin/commit/a220359877fd1281f76ba732e5308e0e3002e4b1",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://github.com/getgrav/grav-plugin-admin/security/advisories/GHSA-wg37-cf5x-55hq",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:01:33.530709",
    "processing_status": "enhanced"
  },
  "repository_context": {
    "name": "grav-plugin-admin",
    "owner": "getgrav",
    "created_at": "2015-08-04T19:01:06Z",
    "updated_at": "2025-01-18T12:37:44Z",
    "pushed_at": "2025-01-18T12:37:41Z",
    "size": 49695,
    "stars": 356,
    "forks": 231,
    "open_issues": 422,
    "watchers": 356,
    "has_security_policy": false,
    "default_branch": "develop",
    "protected_branches": [],
    "languages": {
      "PHP": 348738,
      "SCSS": 348172,
      "JavaScript": 343495,
      "Twig": 260357,
      "CSS": 39102,
      "Shell": 491
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-26T07:59:08.437902"
  }
}