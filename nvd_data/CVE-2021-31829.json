{
  "cve_id": "CVE-2021-31829",
  "github_data": {
    "repository": "torvalds/linux",
    "fix_commit": "801c6058d14a82179a7ee17a4b532cac6fad067f",
    "related_commits": [
      "801c6058d14a82179a7ee17a4b532cac6fad067f",
      "801c6058d14a82179a7ee17a4b532cac6fad067f"
    ],
    "patch_url": "https://github.com/torvalds/linux/commit/801c6058d14a82179a7ee17a4b532cac6fad067f.patch",
    "fix_commit_details": {
      "sha": "801c6058d14a82179a7ee17a4b532cac6fad067f",
      "commit_date": "2021-04-29T15:19:37Z",
      "author": {
        "login": "borkmann",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "bpf: Fix leakage of uninitialized bpf stack under speculation",
        "length": 2161,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 32,
        "additions": 20,
        "deletions": 12
      },
      "files": [
        {
          "filename": "include/linux/bpf_verifier.h",
          "status": "modified",
          "additions": 3,
          "deletions": 2,
          "patch": "@@ -302,10 +302,11 @@ struct bpf_verifier_state_list {\n };\n \n /* Possible states for alu_state member. */\n-#define BPF_ALU_SANITIZE_SRC\t\t1U\n-#define BPF_ALU_SANITIZE_DST\t\t2U\n+#define BPF_ALU_SANITIZE_SRC\t\t(1U << 0)\n+#define BPF_ALU_SANITIZE_DST\t\t(1U << 1)\n #define BPF_ALU_NEG_VALUE\t\t(1U << 2)\n #define BPF_ALU_NON_POINTER\t\t(1U << 3)\n+#define BPF_ALU_IMMEDIATE\t\t(1U << 4)\n #define BPF_ALU_SANITIZE\t\t(BPF_ALU_SANITIZE_SRC | \\\n \t\t\t\t\t BPF_ALU_SANITIZE_DST)\n "
        },
        {
          "filename": "kernel/bpf/verifier.c",
          "status": "modified",
          "additions": 17,
          "deletions": 10,
          "patch": "@@ -6496,6 +6496,7 @@ static int sanitize_ptr_alu(struct bpf_verifier_env *env,\n {\n \tstruct bpf_insn_aux_data *aux = commit_window ? cur_aux(env) : tmp_aux;\n \tstruct bpf_verifier_state *vstate = env->cur_state;\n+\tbool off_is_imm = tnum_is_const(off_reg->var_off);\n \tbool off_is_neg = off_reg->smin_value < 0;\n \tbool ptr_is_dst_reg = ptr_reg == dst_reg;\n \tu8 opcode = BPF_OP(insn->code);\n@@ -6526,6 +6527,7 @@ static int sanitize_ptr_alu(struct bpf_verifier_env *env,\n \t\talu_limit = abs(tmp_aux->alu_limit - alu_limit);\n \t} else {\n \t\talu_state  = off_is_neg ? BPF_ALU_NEG_VALUE : 0;\n+\t\talu_state |= off_is_imm ? BPF_ALU_IMMEDIATE : 0;\n \t\talu_state |= ptr_is_dst_reg ?\n \t\t\t     BPF_ALU_SANITIZE_SRC : BPF_ALU_SANITIZE_DST;\n \t}\n@@ -12371,7 +12373,7 @@ static int do_misc_fixups(struct bpf_verifier_env *env)\n \t\t\tconst u8 code_add = BPF_ALU64 | BPF_ADD | BPF_X;\n \t\t\tconst u8 code_sub = BPF_ALU64 | BPF_SUB | BPF_X;\n \t\t\tstruct bpf_insn *patch = &insn_buf[0];\n-\t\t\tbool issrc, isneg;\n+\t\t\tbool issrc, isneg, isimm;\n \t\t\tu32 off_reg;\n \n \t\t\taux = &env->insn_aux_data[i + delta];\n@@ -12382,24 +12384,29 @@ static int do_misc_fixups(struct bpf_verifier_env *env)\n \t\t\tisneg = aux->alu_state & BPF_ALU_NEG_VALUE;\n \t\t\tissrc = (aux->alu_state & BPF_ALU_SANITIZE) ==\n \t\t\t\tBPF_ALU_SANITIZE_SRC;\n+\t\t\tisimm = aux->alu_state & BPF_ALU_IMMEDIATE;\n \n \t\t\toff_reg = issrc ? insn->src_reg : insn->dst_reg;\n-\t\t\tif (isneg)\n-\t\t\t\t*patch++ = BPF_ALU64_IMM(BPF_MUL, off_reg, -1);\n-\t\t\t*patch++ = BPF_MOV32_IMM(BPF_REG_AX, aux->alu_limit);\n-\t\t\t*patch++ = BPF_ALU64_REG(BPF_SUB, BPF_REG_AX, off_reg);\n-\t\t\t*patch++ = BPF_ALU64_REG(BPF_OR, BPF_REG_AX, off_reg);\n-\t\t\t*patch++ = BPF_ALU64_IMM(BPF_NEG, BPF_REG_AX, 0);\n-\t\t\t*patch++ = BPF_ALU64_IMM(BPF_ARSH, BPF_REG_AX, 63);\n-\t\t\t*patch++ = BPF_ALU64_REG(BPF_AND, BPF_REG_AX, off_reg);\n+\t\t\tif (isimm) {\n+\t\t\t\t*patch++ = BPF_MOV32_IMM(BPF_REG_AX, aux->alu_limit);\n+\t\t\t} else {\n+\t\t\t\tif (isneg)\n+\t\t\t\t\t*patch++ = BPF_ALU64_IMM(BPF_MUL, off_reg, -1);\n+\t\t\t\t*patch++ = BPF_MOV32_IMM(BPF_REG_AX, aux->alu_limit);\n+\t\t\t\t*patch++ = BPF_ALU64_REG(BPF_SUB, BPF_REG_AX, off_reg);\n+\t\t\t\t*patch++ = BPF_ALU64_REG(BPF_OR, BPF_REG_AX, off_reg);\n+\t\t\t\t*patch++ = BPF_ALU64_IMM(BPF_NEG, BPF_REG_AX, 0);\n+\t\t\t\t*patch++ = BPF_ALU64_IMM(BPF_ARSH, BPF_REG_AX, 63);\n+\t\t\t\t*patch++ = BPF_ALU64_REG(BPF_AND, BPF_REG_AX, off_reg);\n+\t\t\t}\n \t\t\tif (!issrc)\n \t\t\t\t*patch++ = BPF_MOV64_REG(insn->dst_reg, insn->src_reg);\n \t\t\tinsn->src_reg = BPF_REG_AX;\n \t\t\tif (isneg)\n \t\t\t\tinsn->code = insn->code == code_add ?\n \t\t\t\t\t     code_sub : code_add;\n \t\t\t*patch++ = *insn;\n-\t\t\tif (issrc && isneg)\n+\t\t\tif (issrc && isneg && !isimm)\n \t\t\t\t*patch++ = BPF_ALU64_IMM(BPF_MUL, off_reg, -1);\n \t\t\tcnt = patch - insn_buf;\n "
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 2,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "c3812b15000cc5b7b17c7238f8b12f6a22df0b1d",
            "date": "2025-01-14T18:07:40Z",
            "author_login": "torvalds"
          },
          {
            "sha": "79a1d390f879563119bf2848b621bc7eed228c7d",
            "date": "2025-01-14T17:54:57Z",
            "author_login": "torvalds"
          },
          {
            "sha": "c45323b7560ec87c37c729b703c86ee65f136d75",
            "date": "2025-01-13T17:03:18Z",
            "author_login": "torvalds"
          },
          {
            "sha": "34c8e74cd6667ef5da90d448a1af702c4b873bd3",
            "date": "2025-01-13T08:52:08Z",
            "author_login": "YageGeng"
          },
          {
            "sha": "cbc5dde0a461240046e8a41c43d7c3b76d5db952",
            "date": "2025-01-10T15:28:21Z",
            "author_login": "rikvanriel"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 5.5,
    "cvss_vector": "CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:N/A:N",
    "cwe_id": "CWE-863",
    "description": "kernel/bpf/verifier.c in the Linux kernel through 5.12.1 performs undesirable speculative loads, leading to disclosure of stack content via side-channel attacks, aka CID-801c6058d14a. The specific concern is not protecting the BPF stack area against speculative loads. Also, the BPF stack can contain uninitialized data that might represent sensitive information previously operated on by the kernel.",
    "attack_vector": "LOCAL",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2021-05-06T16:15:07.493",
    "last_modified": "2024-11-21T06:06:18.613",
    "fix_date": "2021-04-29T15:19:37Z"
  },
  "references": [
    {
      "url": "http://www.openwall.com/lists/oss-security/2021/05/04/4",
      "source": "cve@mitre.org",
      "tags": [
        "Mailing List",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2021/05/04/4",
      "source": "cve@mitre.org",
      "tags": [
        "Mailing List",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/torvalds/linux/commit/801c6058d14a82179a7ee17a4b532cac6fad067f",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2021/06/msg00019.html",
      "source": "cve@mitre.org",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/VWCZ6LJLENL2C3URW5ICARTACXPFCFN2/",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/Y4X2G5YAPYJGI3PFEZZNOTRYI33GOCCZ/",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/ZI7OBCJQDNWMKLBP6MZ5NV4EUTDAMX6Q/",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2021/05/04/4",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2021/05/04/4",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/torvalds/linux/commit/801c6058d14a82179a7ee17a4b532cac6fad067f",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2021/06/msg00019.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/VWCZ6LJLENL2C3URW5ICARTACXPFCFN2/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/Y4X2G5YAPYJGI3PFEZZNOTRYI33GOCCZ/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/ZI7OBCJQDNWMKLBP6MZ5NV4EUTDAMX6Q/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:01:57.067390",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "linux",
    "owner": "torvalds",
    "created_at": "2011-09-04T22:48:12Z",
    "updated_at": "2025-01-14T12:39:03Z",
    "pushed_at": "2025-01-13T17:27:04Z",
    "size": 5361369,
    "stars": 185823,
    "forks": 54743,
    "open_issues": 437,
    "watchers": 185823,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "C": 1326937103,
      "Assembly": 9568292,
      "Shell": 5072004,
      "Python": 2974128,
      "Makefile": 2713905,
      "Perl": 1253637,
      "Rust": 807711,
      "Roff": 202277,
      "C++": 173382,
      "SmPL": 165946,
      "Yacc": 127472,
      "Lex": 71321,
      "Awk": 69539,
      "Jinja": 30138,
      "UnrealScript": 16848,
      "Gherkin": 10172,
      "M4": 3329,
      "MATLAB": 2482,
      "sed": 2433,
      "Clojure": 2411,
      "XS": 1239,
      "RPC": 962
    },
    "commit_activity": {
      "total_commits_last_year": 46007,
      "avg_commits_per_week": 884.75,
      "days_active_last_year": 359
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T12:53:59.486675"
  }
}