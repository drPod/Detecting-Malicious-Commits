{
  "cve_id": "CVE-2021-32066",
  "github_data": {
    "repository": "ruby/ruby",
    "fix_commit": "a21a3b7d23704a01d34bd79d09dc37897e00922a",
    "related_commits": [
      "a21a3b7d23704a01d34bd79d09dc37897e00922a",
      "a21a3b7d23704a01d34bd79d09dc37897e00922a"
    ],
    "patch_url": "https://github.com/ruby/ruby/commit/a21a3b7d23704a01d34bd79d09dc37897e00922a.patch",
    "fix_commit_details": {
      "sha": "a21a3b7d23704a01d34bd79d09dc37897e00922a",
      "commit_date": "2021-07-07T03:06:44Z",
      "author": {
        "login": "mame",
        "type": "User",
        "stats": {
          "total_commits": 2066,
          "average_weekly_commits": 1.5783040488922842,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 409
        }
      },
      "commit_message": {
        "title": "Fix StartTLS stripping vulnerability",
        "length": 156,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 41,
        "additions": 39,
        "deletions": 2
      },
      "files": [
        {
          "filename": "lib/net/imap.rb",
          "status": "modified",
          "additions": 7,
          "deletions": 1,
          "patch": "@@ -1216,12 +1216,14 @@ def get_tagged_response(tag, cmd)\n       end\n       resp = @tagged_responses.delete(tag)\n       case resp.name\n+      when /\\A(?:OK)\\z/ni\n+        return resp\n       when /\\A(?:NO)\\z/ni\n         raise NoResponseError, resp\n       when /\\A(?:BAD)\\z/ni\n         raise BadResponseError, resp\n       else\n-        return resp\n+        raise UnknownResponseError, resp\n       end\n     end\n \n@@ -3717,6 +3719,10 @@ class BadResponseError < ResponseError\n     class ByeResponseError < ResponseError\n     end\n \n+    # Error raised upon an unknown response from the server.\n+    class UnknownResponseError < ResponseError\n+    end\n+\n     RESPONSE_ERRORS = Hash.new(ResponseError)\n     RESPONSE_ERRORS[\"NO\"] = NoResponseError\n     RESPONSE_ERRORS[\"BAD\"] = BadResponseError"
        },
        {
          "filename": "test/net/imap/test_imap.rb",
          "status": "modified",
          "additions": 31,
          "deletions": 0,
          "patch": "@@ -127,6 +127,16 @@ def test_starttls\n         imap.disconnect\n       end\n     end\n+\n+    def test_starttls_stripping\n+      starttls_stripping_test do |port|\n+        imap = Net::IMAP.new(\"localhost\", :port => port)\n+        assert_raise(Net::IMAP::UnknownResponseError) do\n+          imap.starttls(:ca_file => CA_FILE)\n+        end\n+        imap\n+      end\n+    end\n   end\n \n   def start_server\n@@ -784,6 +794,27 @@ def starttls_test\n     end\n   end\n \n+  def starttls_stripping_test\n+    server = create_tcp_server\n+    port = server.addr[1]\n+    start_server do\n+      sock = server.accept\n+      begin\n+        sock.print(\"* OK test server\\r\\n\")\n+        sock.gets\n+        sock.print(\"RUBY0001 BUG unhandled command\\r\\n\")\n+      ensure\n+        sock.close\n+        server.close\n+      end\n+    end\n+    begin\n+      imap = yield(port)\n+    ensure\n+      imap.disconnect if imap && !imap.disconnected?\n+    end\n+  end\n+\n   def create_tcp_server\n     return TCPServer.new(server_addr, 0)\n   end"
        },
        {
          "filename": "version.h",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -2,7 +2,7 @@\n # define RUBY_VERSION_MINOR RUBY_API_VERSION_MINOR\n #define RUBY_VERSION_TEENY 4\n #define RUBY_RELEASE_DATE RUBY_RELEASE_YEAR_STR\"-\"RUBY_RELEASE_MONTH_STR\"-\"RUBY_RELEASE_DAY_STR\n-#define RUBY_PATCHLEVEL 190\n+#define RUBY_PATCHLEVEL 191\n \n #define RUBY_RELEASE_YEAR 2021\n #define RUBY_RELEASE_MONTH 7"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 3,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "f1e32914eb40737de0f639146aebaf6e3ce2bf21",
            "date": "2025-01-14T20:59:35Z",
            "author_login": "peterzhu2118"
          },
          {
            "sha": "56242ba495246e95dd5178f2ec101c1005c10afc",
            "date": "2025-01-14T19:20:05Z",
            "author_login": "Earlopain"
          },
          {
            "sha": "51d3d6ac8c2e3b6b6dacd80a9ddf11adc46fde08",
            "date": "2025-01-14T18:10:46Z",
            "author_login": "kddnewton"
          },
          {
            "sha": "f5fa1ee5f6e0e29e15063e8b62eb0ce7042bb29b",
            "date": "2025-01-14T17:16:59Z",
            "author_login": "peterzhu2118"
          },
          {
            "sha": "1adcd960e2c0ef7e5debafa4245cd14420616d7b",
            "date": "2025-01-14T17:08:35Z",
            "author_login": "XrXr"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 7.4,
    "cvss_vector": "CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:N",
    "cwe_id": "CWE-755",
    "description": "An issue was discovered in Ruby through 2.6.7, 2.7.x through 2.7.3, and 3.x through 3.0.1. Net::IMAP does not raise an exception when StartTLS fails with an an unknown response, which might allow man-in-the-middle attackers to bypass the TLS protections by leveraging a network position between the client and the registry to block the StartTLS command, aka a \"StartTLS stripping attack.\"",
    "attack_vector": "NETWORK",
    "attack_complexity": "HIGH"
  },
  "temporal_data": {
    "published_date": "2021-08-01T19:15:07.697",
    "last_modified": "2024-11-21T06:06:47.243",
    "fix_date": "2021-07-07T03:06:44Z"
  },
  "references": [
    {
      "url": "https://github.com/ruby/ruby/commit/a21a3b7d23704a01d34bd79d09dc37897e00922a",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://hackerone.com/reports/1178562",
      "source": "cve@mitre.org",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2021/10/msg00009.html",
      "source": "cve@mitre.org",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2023/04/msg00033.html",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "https://security.gentoo.org/glsa/202401-27",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "https://security.netapp.com/advisory/ntap-20210902-0004/",
      "source": "cve@mitre.org",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.oracle.com/security-alerts/cpuapr2022.html",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.ruby-lang.org/en/news/2021/07/07/starttls-stripping-in-net-imap/",
      "source": "cve@mitre.org",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/ruby/ruby/commit/a21a3b7d23704a01d34bd79d09dc37897e00922a",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://hackerone.com/reports/1178562",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2021/10/msg00009.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2023/04/msg00033.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://security.gentoo.org/glsa/202401-27",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://security.netapp.com/advisory/ntap-20210902-0004/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.oracle.com/security-alerts/cpuapr2022.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.ruby-lang.org/en/news/2021/07/07/starttls-stripping-in-net-imap/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Vendor Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:02.352056",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "ruby",
    "owner": "ruby",
    "created_at": "2010-02-27T15:55:23Z",
    "updated_at": "2025-01-14T20:59:49Z",
    "pushed_at": "2025-01-14T20:59:43Z",
    "size": 323228,
    "stars": 22265,
    "forks": 5349,
    "open_issues": 420,
    "watchers": 22265,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "master",
      "ruby_1_3",
      "ruby_1_4",
      "ruby_1_6",
      "ruby_1_8",
      "ruby_1_8_5",
      "ruby_1_8_6",
      "ruby_1_8_7",
      "ruby_1_9_1",
      "ruby_1_9_2",
      "ruby_1_9_3",
      "ruby_2_0_0",
      "ruby_2_1",
      "ruby_2_2",
      "ruby_2_3",
      "ruby_2_4",
      "ruby_2_5",
      "ruby_2_6",
      "ruby_2_7",
      "ruby_3_0",
      "ruby_3_1",
      "ruby_3_2",
      "ruby_3_3",
      "v1_0r",
      "v1_1dev",
      "v1_1r"
    ],
    "languages": {
      "Ruby": 35555127,
      "C": 16241485,
      "C++": 1594866,
      "Rust": 1362581,
      "Makefile": 1171241,
      "Yacc": 520140,
      "HTML": 208845,
      "M4": 195503,
      "Roff": 129542,
      "Python": 98745,
      "Ragel": 43895,
      "GDB": 35667,
      "Assembly": 26341,
      "CSS": 18496,
      "JavaScript": 15749,
      "Shell": 14249,
      "Batchfile": 13747,
      "Emacs Lisp": 4294,
      "Scheme": 557,
      "Raku": 506,
      "Perl": 178,
      "sed": 103,
      "Dockerfile": 81
    },
    "commit_activity": {
      "total_commits_last_year": 7014,
      "avg_commits_per_week": 134.8846153846154,
      "days_active_last_year": 359
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": true,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T21:06:46.206360"
  }
}