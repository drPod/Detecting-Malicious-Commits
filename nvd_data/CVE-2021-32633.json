{
  "cve_id": "CVE-2021-32633",
  "github_data": {
    "repository": "zopefoundation/Zope",
    "fix_commit": "1f8456bf1f908ea46012537d52bd7e752a532c91",
    "related_commits": [
      "1f8456bf1f908ea46012537d52bd7e752a532c91",
      "1f8456bf1f908ea46012537d52bd7e752a532c91"
    ],
    "patch_url": "https://github.com/zopefoundation/Zope/commit/1f8456bf1f908ea46012537d52bd7e752a532c91.patch",
    "fix_commit_details": {
      "sha": "1f8456bf1f908ea46012537d52bd7e752a532c91",
      "commit_date": "2021-05-21T07:11:02Z",
      "author": {
        "login": "dataflake",
        "type": "User",
        "stats": {
          "total_commits": 723,
          "average_weekly_commits": 0.5063025210084033,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 161
        }
      },
      "commit_message": {
        "title": "Merge pull request from GHSA-5pr9-v234-jw36",
        "length": 503,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 86,
        "additions": 84,
        "deletions": 2
      },
      "files": [
        {
          "filename": "CHANGES.rst",
          "status": "modified",
          "additions": 3,
          "deletions": 0,
          "patch": "@@ -11,6 +11,9 @@ https://github.com/zopefoundation/Zope/blob/4.x/CHANGES.rst\n 5.2 (unreleased)\n ----------------\n \n+- Prevent traversal to names starting with ``_`` in TAL expressions\n+  and fix path expressions for the ``chameleon.tales`` expression engine.\n+\n - Provide friendlier ZMI error message for the Transaction Undo form\n   (`#964 <https://github.com/zopefoundation/Zope/issues/964>`_)\n "
        },
        {
          "filename": "src/Products/PageTemplates/Expressions.py",
          "status": "modified",
          "additions": 9,
          "deletions": 0,
          "patch": "@@ -17,6 +17,7 @@\n \"\"\"\n \n import logging\n+import warnings\n \n import OFS.interfaces\n from AccessControl import safe_builtins\n@@ -74,6 +75,14 @@ def boboAwareZopeTraverse(object, path_items, econtext):\n \n     while path_items:\n         name = path_items.pop()\n+\n+        if name == '_':\n+            warnings.warn('Traversing to the name `_` is deprecated '\n+                          'and will be removed in Zope 6.',\n+                          DeprecationWarning)\n+        elif name.startswith('_'):\n+            raise NotFound(name)\n+\n         if OFS.interfaces.ITraversable.providedBy(object):\n             object = object.restrictedTraverse(name)\n         else:"
        },
        {
          "filename": "src/Products/PageTemplates/expression.py",
          "status": "modified",
          "additions": 10,
          "deletions": 1,
          "patch": "@@ -1,5 +1,6 @@\n \"\"\"``chameleon.tales`` expressions.\"\"\"\n \n+import warnings\n from ast import NodeTransformer\n from ast import parse\n \n@@ -61,8 +62,16 @@ def traverse(cls, base, request, path_items):\n \n         while path_items:\n             name = path_items.pop()\n+\n+            if name == '_':\n+                warnings.warn('Traversing to the name `_` is deprecated '\n+                              'and will be removed in Zope 6.',\n+                              DeprecationWarning)\n+            elif name.startswith('_'):\n+                raise NotFound(name)\n+\n             if ITraversable.providedBy(base):\n-                base = getattr(base, cls.traverseMethod)(name)\n+                base = getattr(base, cls.traverse_method)(name)\n             else:\n                 base = traversePathElement(base, name, path_items,\n                                            request=request)"
        },
        {
          "filename": "src/Products/PageTemplates/tests/input/CheckPathTraverse.html",
          "status": "added",
          "additions": 5,
          "deletions": 0,
          "patch": "@@ -0,0 +1,5 @@\n+<html>\n+<body>\n+   <div tal:content=\"context/laf\"></div>\n+</body>\n+</html>"
        },
        {
          "filename": "src/Products/PageTemplates/tests/output/CheckPathTraverse.html",
          "status": "added",
          "additions": 5,
          "deletions": 0,
          "patch": "@@ -0,0 +1,5 @@\n+<html>\n+<body>\n+   <div>ok</div>\n+</body>\n+</html>"
        },
        {
          "filename": "src/Products/PageTemplates/tests/testChameleonTalesExpressions.py",
          "status": "modified",
          "additions": 7,
          "deletions": 0,
          "patch": "@@ -1,3 +1,5 @@\n+import unittest\n+\n from ..expression import getEngine\n from . import testHTMLTests\n \n@@ -19,3 +21,8 @@ def setUp(self):\n     #   expressions (e.g. the ``zope.tales`` ``not`` expression\n     #   returns ``int``, that of ``chameleon.tales`` ``bool``\n     PREFIX = \"CH_\"\n+\n+    @unittest.skip('The test in the base class relies on a Zope context with'\n+                   ' the \"random\" module available in expressions')\n+    def test_underscore_traversal(self):\n+        pass"
        },
        {
          "filename": "src/Products/PageTemplates/tests/testExpressions.py",
          "status": "modified",
          "additions": 20,
          "deletions": 1,
          "patch": "@@ -1,6 +1,8 @@\n import unittest\n+import warnings\n \n from AccessControl import safe_builtins\n+from zExceptions import NotFound\n from zope.component.testing import PlacelessSetup\n \n \n@@ -106,8 +108,12 @@ def test_evaluate_alternative_first_missing(self):\n         self.assertTrue(ec.evaluate('x | nothing') is None)\n \n     def test_evaluate_dict_key_as_underscore(self):\n+        # Traversing to the name `_` will raise a DeprecationWarning\n+        # because it will go away in Zope 6.\n         ec = self._makeContext()\n-        self.assertEqual(ec.evaluate('d/_'), 'under')\n+        with warnings.catch_warnings():\n+            warnings.simplefilter('ignore')\n+            self.assertEqual(ec.evaluate('d/_'), 'under')\n \n     def test_evaluate_dict_with_key_from_expansion(self):\n         ec = self._makeContext()\n@@ -220,6 +226,19 @@ def test_list_in_path_expr(self):\n         ec = self._makeContext()\n         self.assertIs(ec.evaluate('nocall: list'), safe_builtins[\"list\"])\n \n+    def test_underscore_traversal(self):\n+        # Prevent traversal to names starting with an underscore (_)\n+        ec = self._makeContext()\n+\n+        with self.assertRaises(NotFound):\n+            ec.evaluate(\"context/__class__\")\n+\n+        with self.assertRaises(NotFound):\n+            ec.evaluate(\"nocall: random/_itertools/repeat\")\n+\n+        with self.assertRaises(NotFound):\n+            ec.evaluate(\"random/_itertools/repeat/foobar\")\n+\n \n class TrustedEngineTests(EngineTestsBase, unittest.TestCase):\n "
        },
        {
          "filename": "src/Products/PageTemplates/tests/testHTMLTests.py",
          "status": "modified",
          "additions": 25,
          "deletions": 0,
          "patch": "@@ -26,6 +26,7 @@\n     DefaultUnicodeEncodingConflictResolver\n from Products.PageTemplates.unicodeconflictresolver import \\\n     PreferredCharsetResolver\n+from zExceptions import NotFound\n from zope.component import provideUtility\n from zope.traversing.adapters import DefaultTraversable\n \n@@ -155,6 +156,15 @@ def testPathNothing(self):\n     def testPathAlt(self):\n         self.assert_expected(self.folder.t, 'CheckPathAlt.html')\n \n+    def testPathTraverse(self):\n+        # need to perform this test with a \"real\" folder\n+        from OFS.Folder import Folder\n+        f = self.folder\n+        self.folder = Folder()\n+        self.folder.t, self.folder.laf = f.t, f.laf\n+        self.folder.laf.write('ok')\n+        self.assert_expected(self.folder.t, 'CheckPathTraverse.html')\n+\n     def testBatchIteration(self):\n         self.assert_expected(self.folder.t, 'CheckBatchIteration.html')\n \n@@ -207,3 +217,18 @@ def test_unicode_conflict_resolution(self):\n         provideUtility(PreferredCharsetResolver)\n         t = PageTemplate()\n         self.assert_expected(t, 'UnicodeResolution.html')\n+\n+    def test_underscore_traversal(self):\n+        t = self.folder.t\n+\n+        t.write('<p tal:define=\"p context/__class__\" />')\n+        with self.assertRaises(NotFound):\n+            t()\n+\n+        t.write('<p tal:define=\"p nocall: random/_itertools/repeat\"/>')\n+        with self.assertRaises(NotFound):\n+            t()\n+\n+        t.write('<p tal:content=\"random/_itertools/repeat/foobar\"/>')\n+        with self.assertRaises(NotFound):\n+            t()"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 5,
        "unique_directories": 5,
        "max_directory_depth": 5
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "1595981bb0adc7b4e9e7fd3a63cb886f0dcb0a25",
            "date": "2025-01-14T09:50:29Z",
            "author_login": "djay"
          },
          {
            "sha": "8c140a3e4c0354b1f7b45e2fcbbe8bef98628271",
            "date": "2025-01-07T07:26:33Z",
            "author_login": "perrinjerome"
          },
          {
            "sha": "78025426ecb021e6296881f20afbf7e1db32a809",
            "date": "2024-12-03T07:57:04Z",
            "author_login": "icemac"
          },
          {
            "sha": "c647a3a2bf70506596f78389b96a002a26f98724",
            "date": "2024-11-27T12:28:24Z",
            "author_login": "d-maurer"
          },
          {
            "sha": "04b75cf7956425fe3e4e1f4184bac4d377502c59",
            "date": "2024-11-03T14:12:11Z",
            "author_login": "perrinjerome"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.8,
    "cvss_vector": "CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:N",
    "cwe_id": "CWE-22",
    "description": "Zope is an open-source web application server. In Zope versions prior to 4.6 and 5.2, users can access untrusted modules indirectly through Python modules that are available for direct use. By default, only users with the Manager role can add or edit Zope Page Templates through the web, but sites that allow untrusted users to add/edit Zope Page Templates through the web are at risk from this vulnerability. The problem has been fixed in Zope 5.2 and 4.6. As a workaround, a site administrator can restrict adding/editing Zope Page Templates through the web using the standard Zope user/role permission mechanisms. Untrusted users should not be assigned the Zope Manager role and adding/editing Zope Page Templates through the web should be restricted to trusted users only.",
    "attack_vector": "NETWORK",
    "attack_complexity": "HIGH"
  },
  "temporal_data": {
    "published_date": "2021-05-21T14:15:07.977",
    "last_modified": "2024-11-21T06:07:25.347",
    "fix_date": "2021-05-21T07:11:02Z"
  },
  "references": [
    {
      "url": "http://www.openwall.com/lists/oss-security/2021/05/21/1",
      "source": "security-advisories@github.com",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2021/05/22/1",
      "source": "security-advisories@github.com",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://cyllective.com/blog/post/plone-authenticated-rce-cve-2021-32633/",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/zopefoundation/Zope/commit/1f8456bf1f908ea46012537d52bd7e752a532c91",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/zopefoundation/Zope/security/advisories/GHSA-5pr9-v234-jw36",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2021/05/21/1",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2021/05/22/1",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://cyllective.com/blog/post/plone-authenticated-rce-cve-2021-32633/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/zopefoundation/Zope/commit/1f8456bf1f908ea46012537d52bd7e752a532c91",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/zopefoundation/Zope/security/advisories/GHSA-5pr9-v234-jw36",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:01:57.114151",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "Zope",
    "owner": "zopefoundation",
    "created_at": "2013-02-26T16:13:23Z",
    "updated_at": "2025-01-14T12:28:42Z",
    "pushed_at": "2025-01-14T09:50:31Z",
    "size": 163786,
    "stars": 358,
    "forks": 101,
    "open_issues": 29,
    "watchers": 358,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "2.9",
      "2.10",
      "2.11",
      "2.12",
      "2.13",
      "2.13.30-prep",
      "4.x",
      "gh-pages",
      "master"
    ],
    "languages": {
      "Python": 2097262,
      "CSS": 148167,
      "HTML": 29796,
      "JavaScript": 11022
    },
    "commit_activity": {
      "total_commits_last_year": 58,
      "avg_commits_per_week": 1.1153846153846154,
      "days_active_last_year": 30
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T14:25:22.530227"
  }
}