{
  "cve_id": "CVE-2021-32651",
  "github_data": {
    "repository": "theonedev/onedev",
    "fix_commit": "4440f0c57e440488d7e653417b2547eaae8ad19c",
    "related_commits": [
      "4440f0c57e440488d7e653417b2547eaae8ad19c",
      "4440f0c57e440488d7e653417b2547eaae8ad19c"
    ],
    "patch_url": "https://github.com/theonedev/onedev/commit/4440f0c57e440488d7e653417b2547eaae8ad19c.patch",
    "fix_commit_details": {
      "sha": "4440f0c57e440488d7e653417b2547eaae8ad19c",
      "commit_date": "2021-05-29T02:41:52Z",
      "author": {
        "login": "robinshine",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Fix issue #304 - Potential information leak via Ldap injection when ldap",
        "length": 97,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 46,
        "additions": 45,
        "deletions": 1
      },
      "files": [
        {
          "filename": "server-plugin/server-plugin-authenticator-ldap/src/main/java/io/onedev/server/plugin/authenticator/ldap/LdapAuthenticator.java",
          "status": "modified",
          "additions": 45,
          "deletions": 1,
          "patch": "@@ -181,7 +181,9 @@ public Authenticated authenticate(UsernamePasswordToken token) {\n \t\t} catch (InvalidNameException e) {\n \t\t\tthrow new RuntimeException(e);\n \t\t}\n-        String userSearchFilter = StringUtils.replace(getUserSearchFilter(), \"{0}\", token.getUsername());\n+\t\t\n+        String userSearchFilter = StringUtils.replace(getUserSearchFilter(), \"{0}\", \n+        \t\tescape(token.getUsername()));\n         userSearchFilter = StringUtils.replace(userSearchFilter, \"\\\\\", \"\\\\\\\\\");\n         logger.debug(\"Evaluated user search filter: \" + userSearchFilter);\n         \n@@ -437,4 +439,46 @@ public boolean isManagingSshKeys() {\n \t\treturn getUserSshKeyAttribute() != null;\n \t}\n \t\n+\t/* Copied from Spring LdapEncoder.java */\n+    private static String[] FILTER_ESCAPE_TABLE = new String['\\\\' + 1];\n+\n+    static {\n+\n+        // Filter encoding table -------------------------------------\n+\n+        // fill with char itself\n+        for (char c = 0; c < FILTER_ESCAPE_TABLE.length; c++) {\n+            FILTER_ESCAPE_TABLE[c] = String.valueOf(c);\n+        }\n+\n+        // escapes (RFC2254)\n+        FILTER_ESCAPE_TABLE['*'] = \"\\\\2a\";\n+        FILTER_ESCAPE_TABLE['('] = \"\\\\28\";\n+        FILTER_ESCAPE_TABLE[')'] = \"\\\\29\";\n+        FILTER_ESCAPE_TABLE['\\\\'] = \"\\\\5c\";\n+        FILTER_ESCAPE_TABLE[0] = \"\\\\00\";\n+\n+    }\n+\n+    private static String escape(String value) {\n+        // make buffer roomy\n+        StringBuilder encodedValue = new StringBuilder(value.length() * 2);\n+\n+        int length = value.length();\n+\n+        for (int i = 0; i < length; i++) {\n+\n+            char c = value.charAt(i);\n+\n+            if (c < FILTER_ESCAPE_TABLE.length) {\n+                encodedValue.append(FILTER_ESCAPE_TABLE[c]);\n+            } else {\n+                // default: add the char\n+                encodedValue.append(c);\n+            }\n+        }\n+\n+        return encodedValue.toString();\n+    }\t\n+\t\n }"
        }
      ],
      "file_patterns": {
        "security_files": 1,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 1,
        "max_directory_depth": 11
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "10e2c31d03935064a014dfb1464fa7bc146be9e0",
            "date": "2025-01-11T23:54:45Z",
            "author_login": "robinshine"
          },
          {
            "sha": "715386eb735489c08616f9e1c3dc56f58a5457c3",
            "date": "2025-01-11T01:12:03Z",
            "author_login": "robinshine"
          },
          {
            "sha": "be37d8fc32b9c3c4d7b11d3af8051be8911ee390",
            "date": "2025-01-09T14:35:55Z",
            "author_login": "robinshine"
          },
          {
            "sha": "f61d99124dd571668a8836354672903717ced5ca",
            "date": "2025-01-06T03:25:54Z",
            "author_login": "sususweet"
          },
          {
            "sha": "4c37f0dd4e0336e64f22fa04929d67188ee70bd4",
            "date": "2025-01-06T02:48:57Z",
            "author_login": "sususweet"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 3.1,
    "cvss_vector": "CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:U/C:L/I:N/A:N",
    "cwe_id": "CWE-90",
    "description": "OneDev is a development operations platform. If the LDAP external authentication mechanism is enabled in OneDev versions 4.4.1 and prior, an attacker can manipulate a user search filter to send forged queries to the application and explore the LDAP tree using Blind LDAP Injection techniques. The specific payload depends on how the User Search Filter property is configured in OneDev. This issue was fixed in version 4.4.2.",
    "attack_vector": "NETWORK",
    "attack_complexity": "HIGH"
  },
  "temporal_data": {
    "published_date": "2021-06-01T18:15:07.747",
    "last_modified": "2024-11-21T06:07:27.657",
    "fix_date": "2021-05-29T02:41:52Z"
  },
  "references": [
    {
      "url": "https://github.com/theonedev/onedev/commit/4440f0c57e440488d7e653417b2547eaae8ad19c",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/theonedev/onedev/security/advisories/GHSA-5864-2496-4xjf",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/theonedev/onedev/commit/4440f0c57e440488d7e653417b2547eaae8ad19c",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/theonedev/onedev/security/advisories/GHSA-5864-2496-4xjf",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:01:57.133676",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "onedev",
    "owner": "theonedev",
    "created_at": "2018-11-06T02:57:01Z",
    "updated_at": "2025-01-14T10:30:38Z",
    "pushed_at": "2025-01-11T23:54:59Z",
    "size": 226316,
    "stars": 13579,
    "forks": 872,
    "open_issues": 0,
    "watchers": 13579,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [],
    "languages": {
      "Java": 11067283,
      "JavaScript": 730260,
      "HTML": 381307,
      "CSS": 180682,
      "Shell": 116784,
      "ANTLR": 46591,
      "Smarty": 17174,
      "Python": 5761,
      "Mustache": 3983,
      "Dockerfile": 125
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-14T13:48:17.966345"
  }
}