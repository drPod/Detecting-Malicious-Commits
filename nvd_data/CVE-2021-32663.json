{
  "cve_id": "CVE-2021-32663",
  "github_data": {
    "repository": "Combodo/iTop",
    "fix_commit": "43daa2ef088bf928a2386fa19324628c3f19b807",
    "related_commits": [
      "43daa2ef088bf928a2386fa19324628c3f19b807",
      "6be9a87c150978752bc68baae1a5c4833ddadfec",
      "43daa2ef088bf928a2386fa19324628c3f19b807",
      "6be9a87c150978752bc68baae1a5c4833ddadfec"
    ],
    "patch_url": "https://github.com/Combodo/iTop/commit/43daa2ef088bf928a2386fa19324628c3f19b807.patch",
    "fix_commit_details": {
      "sha": "43daa2ef088bf928a2386fa19324628c3f19b807",
      "commit_date": "2021-05-27T07:29:50Z",
      "author": {
        "login": "eespie",
        "type": "User",
        "stats": {
          "total_commits": 1964,
          "average_weekly_commits": 2.392204628501827,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 273
        }
      },
      "commit_message": {
        "title": " N\u00b03952 - code hardening",
        "length": 24,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 118,
        "additions": 91,
        "deletions": 27
      },
      "files": [
        {
          "filename": "setup/ajax.dataloader.php",
          "status": "modified",
          "additions": 2,
          "deletions": 8,
          "patch": "@@ -147,12 +147,7 @@ function FatalErrorCatcher($sOutput)\n $sOperation = Utils::ReadParam('operation', '');\n try\n {\n-\t$sAuthent = utils::ReadParam('authent', '', false, 'raw_data');\n-\tif (!file_exists(APPROOT.'data/setup/authent') || $sAuthent !== file_get_contents(APPROOT.'data/setup/authent'))\n-\t{\n-\t\tthrow new SecurityException('Setup operations are not allowed outside of the setup');\n-\t\tSetupPage::log_error(\"Setup operations are not allowed outside of the setup\");\n-\t}\n+\tSetupUtils::CheckSetupToken();\n \n \tswitch($sOperation)\n \t{\n@@ -199,15 +194,14 @@ function FatalErrorCatcher($sOutput)\n {\n \theader(\"HTTP/1.0 500 Internal server error.\");\n \techo \"<p>An error happened while processing the installation:</p>\\n\";\n-\techo '<p>'.$e.\"</p>\\n\";\n \tSetupPage::log_error(\"An error happened while processing the installation: \".$e);\n }\n \n if (function_exists('memory_get_peak_usage'))\n {\n \tif ($sOperation == 'file')\n \t{\n-\t\tSetupPage::log_info(\"loading file '$sFileName', peak memory usage. \".memory_get_peak_usage());\n+\t\tSetupPage::log_info(\"loading file peak memory usage. \".memory_get_peak_usage());\n \t}\n \telse\n \t{"
        },
        {
          "filename": "setup/index.php",
          "status": "modified",
          "additions": 13,
          "deletions": 6,
          "patch": "@@ -30,6 +30,7 @@\n require_once(APPROOT.'/setup/wizardcontroller.class.inc.php');\n require_once(APPROOT.'/setup/wizardsteps.class.inc.php');\n \n+session_start();\n clearstatcache(); // Make sure we know what we are doing !\n // Set a long (at least 4 minutes) execution time for the setup to avoid timeouts during this phase\n ini_set('max_execution_time', max(240, ini_get('max_execution_time')));\n@@ -41,21 +42,27 @@\n /////////////////////////////////////////////////////////////////////\n // Fake functions to protect the first run of the installer\n // in case the PHP JSON module is not installed...\n-if (!function_exists('json_encode'))\n-{\n+if (!function_exists('json_encode')) {\n \tfunction json_encode($value, $options = null)\n \t{\n \t\treturn '[]';\n \t}\n }\n-if (!function_exists('json_decode'))\n-{\n-\tfunction json_decode($json, $assoc=null)\n+if (!function_exists('json_decode')) {\n+\tfunction json_decode($json, $assoc = null)\n \t{\n \t\treturn array();\n \t}\n }\n /////////////////////////////////////////////////////////////////////\n \n $oWizard = new WizardController('WizStepWelcome');\n-$oWizard->Run();\n+//N\u00b03952\n+if (SetupUtils::IsSessionSetupTokenValid()) {\n+\t// Normal operation\n+\t$oWizard->Run();\n+} else {\n+\t// Force initializing the setup\n+\t$oWizard->Start();\n+\tSetupUtils::CreateSetupToken();\n+}"
        },
        {
          "filename": "setup/setuputils.class.inc.php",
          "status": "modified",
          "additions": 69,
          "deletions": 0,
          "patch": "@@ -1826,6 +1826,75 @@ static public function GetSetupQueriesFilePath()\n \t{\n \t\treturn APPROOT.'log/setup-queries-'.strftime('%Y-%m-%d_%H_%M').'.sql';\n \t}\n+\n+\t/**\n+\t * Create and store Setup authentication token\n+\t *\n+\t * @return string token\n+\t */\n+\tpublic final static function CreateSetupToken()\n+\t{\n+\t\tif (!is_dir(APPROOT.'data'))\n+\t\t{\n+\t\t\tmkdir(APPROOT.'data');\n+\t\t}\n+\t\tif (!is_dir(APPROOT.'data/setup'))\n+\t\t{\n+\t\t\tmkdir(APPROOT.'data/setup');\n+\t\t}\n+\t\t$sUID = hash('sha256', rand());\n+\t\tfile_put_contents(APPROOT.'data/setup/authent', $sUID);\n+\t\t$_SESSION['setup_token'] = $sUID;\n+\t\treturn $sUID;\n+\t}\n+\n+\t/**\n+\t * Verify Setup authentication token (from the request parameter 'authent')\n+\t *\n+\t * @param bool $bRemoveToken\n+\t *\n+\t * @throws \\SecurityException\n+\t */\n+\tpublic final static function CheckSetupToken($bRemoveToken = false)\n+\t{\n+\t\t$sAuthent = utils::ReadParam('authent', '', false, 'raw_data');\n+\t\t$sTokenFile = APPROOT.'data/setup/authent';\n+\t\tif (!file_exists($sTokenFile) || $sAuthent !== file_get_contents($sTokenFile))\n+\t\t{\n+\t\t\tthrow new SecurityException('Setup operations are not allowed outside of the setup');\n+\t\t}\n+\t\tif ($bRemoveToken)\n+\t\t{\n+\t\t\t@unlink($sTokenFile);\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Check setup transaction and create a new one if necessary\n+\t *\n+\t * @return bool\n+\t */\n+\tpublic static function IsSessionSetupTokenValid()\n+\t{\n+\t\tif (isset($_SESSION['setup_token'])) {\n+\t\t\t$sAuth = $_SESSION['setup_token'];\n+\t\t\t$sTokenFile = APPROOT.'data/setup/authent';\n+\t\t\tif (file_exists($sTokenFile) && $sAuth === file_get_contents($sTokenFile)) {\n+\t\t\t\treturn true;\n+\t\t\t}\n+\t\t}\n+\n+\t\treturn false;\n+\t}\n+\n+\tpublic static function EraseSetupToken()\n+\t{\n+\t\t$sTokenFile = APPROOT.'data/setup/authent';\n+\t\tif (is_file($sTokenFile)) {\n+\t\t\tunlink($sTokenFile);\n+\t\t}\n+\t\tunset($_SESSION['setup_token']);\n+\t}\n }\n \n /**"
        },
        {
          "filename": "setup/wizardcontroller.class.inc.php",
          "status": "modified",
          "additions": 5,
          "deletions": 3,
          "patch": "@@ -105,7 +105,7 @@ public function SaveParameter($sParamCode, $defaultValue, $sSanitizationFilter =\n \t/**\n \t * Starts the wizard by displaying it in its initial state\n \t */\n-\tprotected function Start()\n+\tpublic function Start()\n \t{\n \t\t$sCurrentStepClass = $this->sInitialStepClass;\n \t\t$oStep = new $sCurrentStepClass($this, $this->sInitialState);\n@@ -121,7 +121,7 @@ protected function Next()\n \t\t$sCurrentState = utils::ReadParam('_state', $this->sInitialState);\n \t\t/** @var \\WizardStep $oStep */\n \t\t$oStep = new $sCurrentStepClass($this, $sCurrentState);\n-\t\tif ($oStep->ValidateParams($sCurrentState))\n+\t\tif ($oStep->ValidateParams())\n \t\t{\n \t\t\t$this->PushStep(array('class' => $sCurrentStepClass, 'state' => $sCurrentState));\n \t\t\t$aPossibleSteps = $oStep->GetPossibleSteps();\n@@ -173,14 +173,16 @@ protected function DisplayStep(WizardStep $oStep)\n \t\t\t\t// The configuration file already exists\n \t\t\t\tif (!is_writable($sConfigFile))\n \t\t\t\t{\n+\t\t\t\t\tSetupUtils::EraseSetupToken();\n \t\t\t\t\t$sRelativePath = utils::GetConfigFilePathRelative();\n \t\t\t\t\t$oP = new SetupPage('Installation Cannot Continue');\n \t\t\t\t\t$oP->add(\"<h2>Fatal error</h2>\\n\");\n \t\t\t\t\t$oP->error(\"<b>Error:</b> the configuration file '\".$sRelativePath.\"' already exists and cannot be overwritten.\");\n \t\t\t\t\t$oP->p(\"The wizard cannot modify the configuration file for you. If you want to upgrade \".ITOP_APPLICATION.\", make sure that the file '<b>\".$sRelativePath.\"</b>' can be modified by the web server.\");\n \t\t\t\t\t$oP->p('<button type=\"button\" onclick=\"window.location.reload()\">Reload</button>');\n \t\t\t\t\t$oP->output();\n-\t\t\t\t\treturn;\n+\t\t\t\t\t// Prevent token creation\n+\t\t\t\t\texit;\n \t\t\t\t}\n \t\t\t}\t\t\t\n \t\t}"
        },
        {
          "filename": "setup/wizardsteps.class.inc.php",
          "status": "modified",
          "additions": 2,
          "deletions": 10,
          "patch": "@@ -57,16 +57,7 @@ public function GetPossibleSteps()\n \n \tpublic function ProcessParams($bMoveForward = true)\n \t{\n-\t\tif (!is_dir(APPROOT.'data'))\n-\t\t{\n-\t\t\tmkdir(APPROOT.'data');\n-\t\t}\n-\t\tif (!is_dir(APPROOT.'data/setup'))\n-\t\t{\n-\t\t\tmkdir(APPROOT.'data/setup');\n-\t\t}\n-\t\t$sUID = hash('sha256', rand());\n-\t\tfile_put_contents(APPROOT.'data/setup/authent', $sUID);\n+\t\t$sUID = SetupUtils::CreateSetupToken();\n \t\t$this->oWizard->SetParameter('authent', $sUID);\n \t\treturn array('class' => 'WizStepInstallOrUpgrade', 'state' => '');\n \t}\n@@ -2643,6 +2634,7 @@ public function Display(WebPage $oPage)\n \t\t$oPage->add('<img style=\"border:0\" src=\"'.$sImgUrl.'\"/>');\n \t\t$sForm = addslashes($sForm);\n \t\t$oPage->add_ready_script(\"$('#wiz_form').after('$sForm');\");\n+\t\tSetupUtils::EraseSetupToken();\n \t}\n \n \tpublic function CanMoveForward()"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 1,
        "max_directory_depth": 1
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "d0bdde30ad84c7e48c476cb1bc1d0d91ca23bf71",
            "date": "2025-01-14T07:34:41Z",
            "author_login": "odain-cbd"
          },
          {
            "sha": "95dbe4c859fa644ebe28a279ec92e50ba01f5bfc",
            "date": "2025-01-14T06:52:07Z",
            "author_login": "odain-cbd"
          },
          {
            "sha": "3fe8b6c6968152ea956f99e1075fa3a908c2a7fc",
            "date": "2025-01-13T14:01:55Z",
            "author_login": "bdalsass"
          },
          {
            "sha": "ec6adee9c1fb9ded4978e27c85968b5daf7cedf9",
            "date": "2025-01-13T13:32:06Z",
            "author_login": "bdalsass"
          },
          {
            "sha": "baa8bba92696427709b86dcf6c46332503b89c1e",
            "date": "2025-01-13T11:50:58Z",
            "author_login": "bdalsass"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 8.7,
    "cvss_vector": "CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:C/C:H/I:H/A:N",
    "cwe_id": "CWE-918",
    "description": "iTop is an open source web based IT Service Management tool. In affected versions an attacker can call the system setup without authentication. Given specific parameters this can lead to SSRF. This issue has been resolved in versions 2.6.5 and 2.7.5 and later",
    "attack_vector": "NETWORK",
    "attack_complexity": "HIGH"
  },
  "temporal_data": {
    "published_date": "2021-10-19T18:15:07.783",
    "last_modified": "2024-11-21T06:07:29.093",
    "fix_date": "2021-05-27T07:29:50Z"
  },
  "references": [
    {
      "url": "https://github.com/Combodo/iTop/commit/43daa2ef088bf928a2386fa19324628c3f19b807",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/Combodo/iTop/commit/6be9a87c150978752bc68baae1a5c4833ddadfec",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/Combodo/iTop/security/advisories/GHSA-ghqc-r8f6-q9m9",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/Combodo/iTop/commit/43daa2ef088bf928a2386fa19324628c3f19b807",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/Combodo/iTop/commit/6be9a87c150978752bc68baae1a5c4833ddadfec",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/Combodo/iTop/security/advisories/GHSA-ghqc-r8f6-q9m9",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:31.838068",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "iTop",
    "owner": "Combodo",
    "created_at": "2018-08-23T08:50:30Z",
    "updated_at": "2025-01-14T07:34:50Z",
    "pushed_at": "2025-01-14T09:39:51Z",
    "size": 206204,
    "stars": 863,
    "forks": 237,
    "open_issues": 30,
    "watchers": 863,
    "has_security_policy": false,
    "default_branch": "develop",
    "protected_branches": [],
    "languages": {
      "PHP": 34789945,
      "JavaScript": 2352041,
      "HTML": 1103794,
      "Twig": 957796,
      "SCSS": 915657,
      "CSS": 908219,
      "Yacc": 61589,
      "Shell": 14490,
      "Smarty": 13798,
      "Batchfile": 2449
    },
    "commit_activity": {
      "total_commits_last_year": 1315,
      "avg_commits_per_week": 25.28846153846154,
      "days_active_last_year": 203
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "agpl-3.0"
    },
    "collected_at": "2025-01-14T12:57:30.690988"
  }
}