{
  "cve_id": "CVE-2021-32672",
  "github_data": {
    "repository": "redis/redis",
    "fix_commit": "6ac3c0b7abd35f37201ed2d6298ecef4ea1ae1dd",
    "related_commits": [
      "6ac3c0b7abd35f37201ed2d6298ecef4ea1ae1dd",
      "6ac3c0b7abd35f37201ed2d6298ecef4ea1ae1dd"
    ],
    "patch_url": "https://github.com/redis/redis/commit/6ac3c0b7abd35f37201ed2d6298ecef4ea1ae1dd.patch",
    "fix_commit_details": {
      "sha": "6ac3c0b7abd35f37201ed2d6298ecef4ea1ae1dd",
      "commit_date": "2021-06-13T11:29:20Z",
      "author": {
        "login": "MeirShpilraien",
        "type": "User",
        "stats": {
          "total_commits": 84,
          "average_weekly_commits": 0.1016949152542373,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 56
        }
      },
      "commit_message": {
        "title": "Fix protocol parsing on 'ldbReplParseCommand' (CVE-2021-32672)",
        "length": 519,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 44,
        "additions": 40,
        "deletions": 4
      },
      "files": [
        {
          "filename": "src/scripting.c",
          "status": "modified",
          "additions": 25,
          "deletions": 4,
          "patch": "@@ -2026,7 +2026,8 @@ int ldbDelBreakpoint(int line) {\n /* Expect a valid multi-bulk command in the debugging client query buffer.\n  * On success the command is parsed and returned as an array of SDS strings,\n  * otherwise NULL is returned and there is to read more buffer. */\n-sds *ldbReplParseCommand(int *argcp) {\n+sds *ldbReplParseCommand(int *argcp, char** err) {\n+    static char* protocol_error = \"protocol error\";\n     sds *argv = NULL;\n     int argc = 0;\n     if (sdslen(ldb.cbuf) == 0) return NULL;\n@@ -2043,7 +2044,7 @@ sds *ldbReplParseCommand(int *argcp) {\n     /* Seek and parse *<count>\\r\\n. */\n     p = strchr(p,'*'); if (!p) goto protoerr;\n     char *plen = p+1; /* Multi bulk len pointer. */\n-    p = strstr(p,\"\\r\\n\"); if (!p) goto protoerr;\n+    p = strstr(p,\"\\r\\n\"); if (!p) goto keep_reading;\n     *p = '\\0'; p += 2;\n     *argcp = atoi(plen);\n     if (*argcp <= 0 || *argcp > 1024) goto protoerr;\n@@ -2052,12 +2053,16 @@ sds *ldbReplParseCommand(int *argcp) {\n     argv = zmalloc(sizeof(sds)*(*argcp));\n     argc = 0;\n     while(argc < *argcp) {\n+        // reached the end but there should be more data to read\n+        if (*p == '\\0') goto keep_reading;\n+\n         if (*p != '$') goto protoerr;\n         plen = p+1; /* Bulk string len pointer. */\n-        p = strstr(p,\"\\r\\n\"); if (!p) goto protoerr;\n+        p = strstr(p,\"\\r\\n\"); if (!p) goto keep_reading;\n         *p = '\\0'; p += 2;\n         int slen = atoi(plen); /* Length of this arg. */\n         if (slen <= 0 || slen > 1024) goto protoerr;\n+        if ((size_t)(p + slen + 2 - copy) > sdslen(copy) ) goto keep_reading;\n         argv[argc++] = sdsnewlen(p,slen);\n         p += slen; /* Skip the already parsed argument. */\n         if (p[0] != '\\r' || p[1] != '\\n') goto protoerr;\n@@ -2067,6 +2072,8 @@ sds *ldbReplParseCommand(int *argcp) {\n     return argv;\n \n protoerr:\n+    *err = protocol_error;\n+keep_reading:\n     sdsfreesplitres(argv,argc);\n     sdsfree(copy);\n     return NULL;\n@@ -2555,12 +2562,17 @@ void ldbMaxlen(sds *argv, int argc) {\n int ldbRepl(lua_State *lua) {\n     sds *argv;\n     int argc;\n+    char* err = NULL;\n \n     /* We continue processing commands until a command that should return\n      * to the Lua interpreter is found. */\n     while(1) {\n-        while((argv = ldbReplParseCommand(&argc)) == NULL) {\n+        while((argv = ldbReplParseCommand(&argc, &err)) == NULL) {\n             char buf[1024];\n+            if (err) {\n+                lua_pushstring(lua, err);\n+                lua_error(lua);\n+            }\n             int nread = connRead(ldb.conn,buf,sizeof(buf));\n             if (nread <= 0) {\n                 /* Make sure the script runs without user input since the\n@@ -2570,6 +2582,15 @@ int ldbRepl(lua_State *lua) {\n                 return C_ERR;\n             }\n             ldb.cbuf = sdscatlen(ldb.cbuf,buf,nread);\n+            /* after 1M we will exit with an error\n+             * so that the client will not blow the memory\n+             */\n+            if (sdslen(ldb.cbuf) > 1<<20) {\n+                sdsfree(ldb.cbuf);\n+                ldb.cbuf = sdsempty();\n+                lua_pushstring(lua, \"max client buffer reached\");\n+                lua_error(lua);\n+            }\n         }\n \n         /* Flush the old buffer. */"
        },
        {
          "filename": "tests/unit/scripting.tcl",
          "status": "modified",
          "additions": 15,
          "deletions": 0,
          "patch": "@@ -820,3 +820,18 @@ start_server {tags {\"scripting\"}} {\n     r eval {return 'hello'} 0\n     r eval {return 'hello'} 0\n }\n+\n+start_server {tags {\"scripting needs:debug external:skip\"}} {\n+    test {Test scripting debug protocol parsing} {\n+        r script debug sync\n+        r eval {return 'hello'} 0\n+        catch {r 'hello\\0world'} e\n+        assert_match {*Unknown Redis Lua debugger command*} $e\n+        catch {r 'hello\\0'} e\n+        assert_match {*Unknown Redis Lua debugger command*} $e\n+        catch {r '\\0hello'} e\n+        assert_match {*Unknown Redis Lua debugger command*} $e\n+        catch {r '\\0hello\\0'} e\n+        assert_match {*Unknown Redis Lua debugger command*} $e\n+    }\n+}"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 2,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "0f65806b5b0f21b96e9c688ce7d2d00062203a51",
            "date": "2025-01-14T09:30:18Z",
            "author_login": "sundb"
          },
          {
            "sha": "5b8b58e472fc567337429f63e93927f86db7f838",
            "date": "2025-01-14T07:51:05Z",
            "author_login": "ShooterIT"
          },
          {
            "sha": "342ee426ad0d0731b2272553bd4db2cd78e24772",
            "date": "2024-12-15T19:41:45Z",
            "author_login": "YaacovHazan"
          },
          {
            "sha": "4a95b3005a140165bbb9df373ba61f775c936554",
            "date": "2024-12-15T09:27:48Z",
            "author_login": "YaacovHazan"
          },
          {
            "sha": "73a9b916c9f42f2e07b9338a975f9a473ad0cd9b",
            "date": "2025-01-13T12:09:52Z",
            "author_login": "tezc"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 5.3,
    "cvss_vector": "CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:U/C:H/I:N/A:N",
    "cwe_id": "CWE-125",
    "description": "Redis is an open source, in-memory database that persists on disk. When using the Redis Lua Debugger, users can send malformed requests that cause the debugger\u2019s protocol parser to read data beyond the actual buffer. This issue affects all versions of Redis with Lua debugging support (3.2 or newer). The problem is fixed in versions 6.2.6, 6.0.16 and 5.0.14.",
    "attack_vector": "NETWORK",
    "attack_complexity": "HIGH"
  },
  "temporal_data": {
    "published_date": "2021-10-04T18:15:08.780",
    "last_modified": "2024-11-21T06:07:30.103",
    "fix_date": "2021-06-13T11:29:20Z"
  },
  "references": [
    {
      "url": "https://github.com/redis/redis/commit/6ac3c0b7abd35f37201ed2d6298ecef4ea1ae1dd",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/redis/redis/security/advisories/GHSA-9mj9-xx53-qmxm",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/HTYQ5ZF37HNGTZWVNJD3VXP7I6MEEF42/",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/VL5KXFN3ATM7IIM7Q4O4PWTSRGZ5744Z/",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/WR5WKJWXD4D6S3DJCZ56V74ESLTDQRAB/",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://security.gentoo.org/glsa/202209-17",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://security.netapp.com/advisory/ntap-20211104-0003/",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.debian.org/security/2021/dsa-5001",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.oracle.com/security-alerts/cpuapr2022.html",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/redis/redis/commit/6ac3c0b7abd35f37201ed2d6298ecef4ea1ae1dd",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/redis/redis/security/advisories/GHSA-9mj9-xx53-qmxm",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/HTYQ5ZF37HNGTZWVNJD3VXP7I6MEEF42/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/VL5KXFN3ATM7IIM7Q4O4PWTSRGZ5744Z/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/WR5WKJWXD4D6S3DJCZ56V74ESLTDQRAB/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://security.gentoo.org/glsa/202209-17",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://security.netapp.com/advisory/ntap-20211104-0003/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.debian.org/security/2021/dsa-5001",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.oracle.com/security-alerts/cpuapr2022.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:07.807523",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "redis",
    "owner": "redis",
    "created_at": "2009-03-21T22:32:25Z",
    "updated_at": "2025-01-14T13:39:40Z",
    "pushed_at": "2025-01-14T13:24:52Z",
    "size": 142912,
    "stars": 67707,
    "forks": 23864,
    "open_issues": 2530,
    "watchers": 67707,
    "has_security_policy": false,
    "default_branch": "unstable",
    "protected_branches": [
      "2.2",
      "2.4",
      "2.6",
      "2.8",
      "3.0",
      "3.2",
      "4.0",
      "5.0",
      "6.0",
      "6.2",
      "7.0",
      "7.2",
      "7.4",
      "8.0",
      "LiorKogan-patch-1",
      "LiorKogan-patch-2",
      "acl-api-pr",
      "acl-log",
      "antiaffinity",
      "aofrdb",
      "argv-accounting",
      "arm",
      "client-unblock",
      "conduct",
      "cow-pipe",
      "csc2",
      "current-client-fix",
      "dict-clustered-entries",
      "dict-split-by-slot"
    ],
    "languages": {
      "C": 6937367,
      "Tcl": 2354158,
      "Python": 40222,
      "Makefile": 26062,
      "Shell": 23597,
      "Ruby": 23260,
      "C++": 5987,
      "Smarty": 1047,
      "JavaScript": 953
    },
    "commit_activity": {
      "total_commits_last_year": 425,
      "avg_commits_per_week": 8.173076923076923,
      "days_active_last_year": 171
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T14:05:59.165273"
  }
}