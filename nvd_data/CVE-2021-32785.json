{
  "cve_id": "CVE-2021-32785",
  "github_data": {
    "repository": "zmartzone/mod_auth_openidc",
    "fix_commit": "dc672688dc1f2db7df8ad4abebc367116017a449",
    "related_commits": [
      "dc672688dc1f2db7df8ad4abebc367116017a449",
      "dc672688dc1f2db7df8ad4abebc367116017a449"
    ],
    "patch_url": "https://github.com/zmartzone/mod_auth_openidc/commit/dc672688dc1f2db7df8ad4abebc367116017a449.patch",
    "fix_commit_details": {
      "sha": "dc672688dc1f2db7df8ad4abebc367116017a449",
      "commit_date": "2021-07-22T16:13:56Z",
      "author": {
        "login": "zandbelt",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Merge pull request from GHSA-55r8-6w97-xxr4",
        "length": 115,
        "has_description": true,
        "references_issue": false
      },
      "stats": {
        "total": 32,
        "additions": 19,
        "deletions": 13
      },
      "files": [
        {
          "filename": "ChangeLog",
          "status": "modified",
          "additions": 3,
          "deletions": 0,
          "patch": "@@ -1,3 +1,6 @@\n+07/22/2021\n+- use redisvCommand to avoid crash with crafted key when using Redis without encryption; thanks @thomas-chauchefoin-sonarsource\n+\n 07/15/2021\n - verify that \"alg\" is not none in logout_token explicitly\n - make session not found on backchannel logout produce a log warning instead of error"
        },
        {
          "filename": "Dockerfile",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -8,7 +8,7 @@ RUN apt-get update && apt-get install -y autoconf automake libtool\n RUN apt-get update && apt-get install -y libssl-dev libjansson-dev libcurl4-openssl-dev check\n RUN apt-get update && apt-get install -y apache2 apache2-dev\n RUN apt-get update && apt-get install -y libpcre3-dev zlib1g-dev\n-RUN apt-get update && apt-get install -y libapache2-mod-php \n+RUN apt-get update && apt-get install -y libapache2-mod-php libhiredis-dev\n \n RUN wget https://mod-auth-openidc.org/download/libcjose0_0.6.1.5-1~bionic+1_amd64.deb\n RUN wget https://mod-auth-openidc.org/download/libcjose-dev_0.6.1.5-1~bionic+1_amd64.deb"
        },
        {
          "filename": "openidc.conf",
          "status": "modified",
          "additions": 3,
          "deletions": 0,
          "patch": "@@ -26,6 +26,9 @@ OIDCInfoHook iat access_token access_token_expires id_token userinfo refresh_tok\n \n OIDCScope \"openid email profile\"\n \n+OIDCCacheType redis\n+OIDCRedisCacheServer host.docker.internal\n+\n <Location /protected>\n   AuthType openid-connect\n   Require valid-user"
        },
        {
          "filename": "src/cache/redis.c",
          "status": "modified",
          "additions": 12,
          "deletions": 12,
          "patch": "@@ -265,10 +265,12 @@ static apr_status_t oidc_cache_redis_connect(request_rec *r,\n  * execute Redis command and deal with return value\n  */\n static redisReply* oidc_cache_redis_command(request_rec *r,\n-\t\toidc_cache_cfg_redis_t *context, const char *command) {\n+\t\toidc_cache_cfg_redis_t *context, const char *format, ...) {\n \n \tredisReply *reply = NULL;\n \tint i = 0;\n+\tva_list ap;\n+\tva_start(ap, format);\n \n \t/* try to execute a command at max 2 times while reconnecting */\n \tfor (i = 0; i < OIDC_REDIS_MAX_TRIES; i++) {\n@@ -278,7 +280,7 @@ static redisReply* oidc_cache_redis_command(request_rec *r,\n \t\t\tbreak;\n \n \t\t/* execute the actual command */\n-\t\treply = redisCommand(context->ctx, command);\n+\t\treply = redisvCommand(context->ctx, format, ap);\n \n \t\t/* check for errors, need to return error replies for cache miss case REDIS_REPLY_NIL */\n \t\tif ((reply != NULL) && (reply->type != REDIS_REPLY_ERROR))\n@@ -298,6 +300,8 @@ static redisReply* oidc_cache_redis_command(request_rec *r,\n \t\toidc_cache_redis_free(context);\n \t}\n \n+\tva_end(ap);\n+\n \treturn reply;\n }\n \n@@ -318,9 +322,8 @@ static apr_byte_t oidc_cache_redis_get(request_rec *r, const char *section,\n \t\treturn FALSE;\n \n \t/* get */\n-\treply = oidc_cache_redis_command(r, context,\n-\t\t\tapr_psprintf(r->pool, \"GET %s\",\n-\t\t\t\t\toidc_cache_redis_get_key(r->pool, section, key)));\n+\treply =\n+\t\t\toidc_cache_redis_command(r, context, \"GET %s\", oidc_cache_redis_get_key(r->pool, section, key));\n \n \tif (reply == NULL)\n \t\tgoto end;\n@@ -384,20 +387,17 @@ static apr_byte_t oidc_cache_redis_set(request_rec *r, const char *section,\n \tif (value == NULL) {\n \n \t\t/* delete it */\n-\t\treply = oidc_cache_redis_command(r, context,\n-\t\t\t\tapr_psprintf(r->pool, \"DEL %s\",\n-\t\t\t\t\t\toidc_cache_redis_get_key(r->pool, section, key)));\n+\t\treply =\n+\t\t\t\toidc_cache_redis_command(r, context, \"DEL %s\", oidc_cache_redis_get_key(r->pool, section, key));\n \n \t} else {\n \n \t\t/* calculate the timeout from now */\n \t\ttimeout = apr_time_sec(expiry - apr_time_now());\n \n \t\t/* store it */\n-\t\treply = oidc_cache_redis_command(r, context,\n-\t\t\t\tapr_psprintf(r->pool, \"SETEX %s %d %s\",\n-\t\t\t\t\t\toidc_cache_redis_get_key(r->pool, section, key),\n-\t\t\t\t\t\ttimeout, value));\n+\t\treply =\n+\t\t\t\toidc_cache_redis_command(r, context, \"SETEX %s %d %s\", oidc_cache_redis_get_key(r->pool, section, key), timeout, value);\n \n \t}\n "
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 2,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "4d4b8e0c42b4edc3a3a343103a4f5393a3187868",
            "date": "2025-01-02T11:11:02Z",
            "author_login": "zandbelt"
          },
          {
            "sha": "afa23358b3c52c448f0d6a7d0853deec26042425",
            "date": "2025-01-02T10:48:45Z",
            "author_login": "ahus1"
          },
          {
            "sha": "1a9d3489bca4fb6eb146d5c14042431f6bb4952f",
            "date": "2025-01-02T10:11:08Z",
            "author_login": "zandbelt"
          },
          {
            "sha": "a2b1e662721757802a07c3797c3b40e389c42d1b",
            "date": "2025-01-02T10:07:28Z",
            "author_login": "zandbelt"
          },
          {
            "sha": "127e1706f836946d181366523fab89b2a79f9016",
            "date": "2024-12-17T08:06:04Z",
            "author_login": "zandbelt"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 5.3,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:L",
    "cwe_id": "CWE-134",
    "description": "mod_auth_openidc is an authentication/authorization module for the Apache 2.x HTTP server that functions as an OpenID Connect Relying Party, authenticating users against an OpenID Connect Provider. When mod_auth_openidc versions prior to 2.4.9 are configured to use an unencrypted Redis cache (`OIDCCacheEncrypt off`, `OIDCSessionType server-cache`, `OIDCCacheType redis`), `mod_auth_openidc` wrongly performed argument interpolation before passing Redis requests to `hiredis`, which would perform it again and lead to an uncontrolled format string bug. Initial assessment shows that this bug does not appear to allow gaining arbitrary code execution, but can reliably provoke a denial of service by repeatedly crashing the Apache workers. This bug has been corrected in version 2.4.9 by performing argument interpolation only once, using the `hiredis` API. As a workaround, this vulnerability can be mitigated by setting `OIDCCacheEncrypt` to `on`, as cache keys are cryptographically hashed before use when this option is enabled.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2021-07-22T22:15:08.140",
    "last_modified": "2024-11-21T06:07:44.050",
    "fix_date": "2021-07-22T16:13:56Z"
  },
  "references": [
    {
      "url": "https://github.com/zmartzone/mod_auth_openidc/commit/dc672688dc1f2db7df8ad4abebc367116017a449",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/zmartzone/mod_auth_openidc/releases/tag/v2.4.9",
      "source": "security-advisories@github.com",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/zmartzone/mod_auth_openidc/security/advisories/GHSA-55r8-6w97-xxr4",
      "source": "security-advisories@github.com",
      "tags": [
        "Mitigation",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2023/04/msg00034.html",
      "source": "security-advisories@github.com",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://security.netapp.com/advisory/ntap-20210902-0001/",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.oracle.com/security-alerts/cpuapr2022.html",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/zmartzone/mod_auth_openidc/commit/dc672688dc1f2db7df8ad4abebc367116017a449",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/zmartzone/mod_auth_openidc/releases/tag/v2.4.9",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/zmartzone/mod_auth_openidc/security/advisories/GHSA-55r8-6w97-xxr4",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mitigation",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2023/04/msg00034.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://security.netapp.com/advisory/ntap-20210902-0001/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.oracle.com/security-alerts/cpuapr2022.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:02.331952",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "mod_auth_openidc",
    "owner": "zmartzone",
    "created_at": "2014-03-27T18:54:06Z",
    "updated_at": "2025-01-11T00:58:38Z",
    "pushed_at": "2025-01-02T11:11:02Z",
    "size": 6185,
    "stars": 1003,
    "forks": 327,
    "open_issues": 0,
    "watchers": 1003,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "C": 1219433,
      "M4": 5581,
      "Makefile": 3452,
      "Shell": 62
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "apache-2.0"
    },
    "collected_at": "2025-01-14T13:04:46.206694"
  }
}