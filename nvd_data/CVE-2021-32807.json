{
  "cve_id": "CVE-2021-32807",
  "github_data": {
    "repository": "zopefoundation/AccessControl",
    "fix_commit": "b42dd4badf803bb9fb71ac34cd9cb0c249262f2c",
    "related_commits": [
      "b42dd4badf803bb9fb71ac34cd9cb0c249262f2c",
      "b42dd4badf803bb9fb71ac34cd9cb0c249262f2c"
    ],
    "patch_url": "https://github.com/zopefoundation/AccessControl/commit/b42dd4badf803bb9fb71ac34cd9cb0c249262f2c.patch",
    "fix_commit_details": {
      "sha": "b42dd4badf803bb9fb71ac34cd9cb0c249262f2c",
      "commit_date": "2021-07-30T07:25:07Z",
      "author": {
        "login": "dataflake",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Merge pull request from GHSA-qcx9-j53g-ccgf",
        "length": 43,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 24,
        "additions": 23,
        "deletions": 1
      },
      "files": [
        {
          "filename": "CHANGES.rst",
          "status": "modified",
          "additions": 2,
          "deletions": 1,
          "patch": "@@ -6,7 +6,8 @@ For changes before version 3.0, see ``HISTORY.rst``.\n 5.1 (unreleased)\n ----------------\n \n-- Nothing changed yet.\n+- Fix a remote code execution issue by preventing access to\n+  ``string.Formatter`` from restricted code.\n \n \n 5.0 (2020-10-07)"
        },
        {
          "filename": "src/AccessControl/ZopeGuards.py",
          "status": "modified",
          "additions": 8,
          "deletions": 0,
          "patch": "@@ -30,6 +30,7 @@\n from RestrictedPython.Utilities import utility_builtins\n from zExceptions import Unauthorized\n \n+from AccessControl.SecurityInfo import ModuleSecurityInfo\n from AccessControl.SecurityInfo import secureModule\n from AccessControl.SecurityManagement import getSecurityManager\n from AccessControl.SimpleObjectPolicies import ContainerAssertions\n@@ -57,6 +58,13 @@\n math.__allow_access_to_unprotected_subobjects__ = 1\n random.__allow_access_to_unprotected_subobjects__ = 1\n \n+# Mark some unprotected module attributes as private, these should not be\n+# used in untrusted Python code such as Scripts (Python)\n+string_modsec = ModuleSecurityInfo('string')\n+for name in ('Formatter', 'Template'):\n+    string_modsec.declarePrivate(name)  # NOQA: D001\n+secureModule('string')\n+\n # AccessControl.Implementation inserts these names into this module as\n # module globals:  aq_validate, guarded_getattr\n "
        },
        {
          "filename": "src/AccessControl/tests/testZopeSecurityPolicy.py",
          "status": "modified",
          "additions": 13,
          "deletions": 0,
          "patch": "@@ -278,6 +278,19 @@ def testAccessToSimpleContainer(self):\n         c.attr = PublicMethod()\n         self.assertPolicyAllows(c, 'attr')\n \n+    def testAccessToStringModule(self):\n+        # The string module is available to restricted code and its members are\n+        # explicitly allowed via a\n+        # ``__allow_access_to_unprotected_subobjects__`` declaration. However,\n+        # a few classes are exempted and declared private, they can indirectly\n+        # provide uncontrolled access to system libraries from within\n+        # restricted code.\n+        import string\n+\n+        self.assertPolicyAllows(string, 'printable')\n+        self.assertPolicyDenies(string, 'Formatter')\n+        self.assertPolicyDenies(string, 'Template')\n+\n     def testUnicodeAttributeLookups(self):\n         item = self.item\n         r_item = self.a.r_item"
        }
      ],
      "file_patterns": {
        "security_files": 1,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 3,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "2302fbe3eb637ab225ff630ea71df63cada94b8f",
            "date": "2024-11-03T11:55:18Z",
            "author_login": "dataflake"
          },
          {
            "sha": "81dcf3d284964e468f8eba32224863ed47033170",
            "date": "2024-11-03T11:47:58Z",
            "author_login": "dataflake"
          },
          {
            "sha": "98f6125542a3de1836a2c0c202fa5226cb679a02",
            "date": "2024-11-03T11:46:05Z",
            "author_login": "d-maurer"
          },
          {
            "sha": "5e846cb6f84579c7f470d47312fefa78d9d6054c",
            "date": "2024-10-10T06:44:31Z",
            "author_login": "dataflake"
          },
          {
            "sha": "c3480ca1407cc2d9091c7a0feffdf5f9059bd2d3",
            "date": "2024-10-10T06:35:15Z",
            "author_login": "dataflake"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 4.4,
    "cvss_vector": "CVSS:3.1/AV:N/AC:H/PR:H/UI:N/S:U/C:N/I:H/A:N",
    "cwe_id": "CWE-915",
    "description": "The module `AccessControl` defines security policies for Python code used in restricted code within Zope applications. Restricted code is any code that resides in Zope's object database, such as the contents of `Script (Python)` objects. The policies defined in `AccessControl` severely restrict access to Python modules and only exempt a few that are deemed safe, such as Python's `string` module. However, full access to the `string` module also allows access to the class `Formatter`, which can be overridden and extended within `Script (Python)` in a way that provides access to other unsafe Python libraries. Those unsafe Python libraries can be used for remote code execution. By default, you need to have the admin-level Zope \"Manager\" role to add or edit `Script (Python)` objects through the web. Only sites that allow untrusted users to add/edit these scripts through the web - which would be a very unusual configuration to begin with - are at risk. The problem has been fixed in AccessControl 4.3 and 5.2. Only AccessControl versions 4 and 5 are vulnerable, and only on Python 3, not Python 2.7. As a workaround, a site administrator can restrict adding/editing `Script (Python)` objects through the web using the standard Zope user/role permission mechanisms. Untrusted users should not be assigned the Zope Manager role and adding/editing these scripts through the web should be restricted to trusted users only. This is the default configuration in Zope.",
    "attack_vector": "NETWORK",
    "attack_complexity": "HIGH"
  },
  "temporal_data": {
    "published_date": "2021-07-30T22:15:07.967",
    "last_modified": "2024-11-21T06:07:47.197",
    "fix_date": "2021-07-30T07:25:07Z"
  },
  "references": [
    {
      "url": "https://github.com/zopefoundation/AccessControl/blob/master/CHANGES.rst#51-2021-07-30",
      "source": "security-advisories@github.com",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/zopefoundation/AccessControl/commit/b42dd4badf803bb9fb71ac34cd9cb0c249262f2c",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/zopefoundation/AccessControl/security/advisories/GHSA-qcx9-j53g-ccgf",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/zopefoundation/AccessControl/blob/master/CHANGES.rst#51-2021-07-30",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/zopefoundation/AccessControl/commit/b42dd4badf803bb9fb71ac34cd9cb0c249262f2c",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/zopefoundation/AccessControl/security/advisories/GHSA-qcx9-j53g-ccgf",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:02.351877",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "AccessControl",
    "owner": "zopefoundation",
    "created_at": "2013-02-25T14:38:38Z",
    "updated_at": "2024-11-03T11:55:32Z",
    "pushed_at": "2024-11-03T11:55:29Z",
    "size": 851,
    "stars": 12,
    "forks": 17,
    "open_issues": 5,
    "watchers": 12,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "2.13",
      "3.0.x",
      "4.x",
      "5.x",
      "config-with-c-code-template-bda0daae",
      "davisagli-permission-directive",
      "do3cc_1007523",
      "master",
      "plonezope4",
      "rotonen-purepython",
      "sylvain-memory-leak"
    ],
    "languages": {
      "Python": 387719,
      "C": 68836,
      "C++": 9572,
      "Shell": 2512
    },
    "commit_activity": {
      "total_commits_last_year": 20,
      "avg_commits_per_week": 0.38461538461538464,
      "days_active_last_year": 13
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T13:15:14.448966"
  }
}