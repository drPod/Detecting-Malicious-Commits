{
  "cve_id": "CVE-2021-33040",
  "github_data": {
    "repository": "futurepress/epub.js",
    "fix_commit": "ab4dd46408cce0324e1c67de4a3ba96b59e5012e",
    "related_commits": [
      "ab4dd46408cce0324e1c67de4a3ba96b59e5012e",
      "ab4dd46408cce0324e1c67de4a3ba96b59e5012e"
    ],
    "patch_url": "https://github.com/futurepress/epub.js/commit/ab4dd46408cce0324e1c67de4a3ba96b59e5012e.patch",
    "fix_commit_details": {
      "sha": "ab4dd46408cce0324e1c67de4a3ba96b59e5012e",
      "commit_date": "2021-10-21T03:15:50Z",
      "author": {
        "login": "fchasen",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Add iframe sandboxing",
        "length": 21,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 18856,
        "additions": 18828,
        "deletions": 28
      },
      "files": [
        {
          "filename": "README.md",
          "status": "modified",
          "additions": 20,
          "deletions": 0,
          "patch": "@@ -88,6 +88,26 @@ Scrolled: `book.renderTo(\"area\", { flow: \"scrolled-doc\" });`\n \n [View example](http://futurepress.github.io/epub.js/examples/scrolled.html)\n \n+## Scripted Content\n+\n+[Scripted content](https://www.w3.org/TR/epub-33/#sec-scripted-content), JavasScript the ePub HTML content, is disabled by default due to the potential for executing malicious content. \n+\n+This is done by sandboxing the iframe the content is rendered into, though it is still recommened to santize the ePub content server-side as well.\n+\n+If a trusted ePub contains interactivity, it can be enabled by passing `allowScriptedContent: true` to the `Rendition` settings.\n+\n+```html\n+<script>\n+  var rendition = book.renderTo(\"area\", {\n+    width: 600,\n+    height: 400,\n+    allowScriptedContent: true\n+  });\n+</script>\n+```\n+\n+This will allow the sandboxed content to run scripts, but currently makes the sandbox insecure.\n+\n ## Documentation\n \n API documentation is available at [epubjs.org/documentation/0.3/](http://epubjs.org/documentation/0.3/)"
        },
        {
          "filename": "package-lock.json",
          "status": "modified",
          "additions": 18785,
          "deletions": 21,
          "patch": null
        },
        {
          "filename": "src/managers/continuous/index.js",
          "status": "modified",
          "additions": 4,
          "deletions": 2,
          "patch": "@@ -21,7 +21,8 @@ class ContinuousViewManager extends DefaultViewManager {\n \t\t\twidth: undefined,\n \t\t\theight: undefined,\n \t\t\tsnap: false,\n-\t\t\tafterScrolledTimeout: 10\n+\t\t\tafterScrolledTimeout: 10,\n+\t\t\tallowScriptedContent: false\n \t\t});\n \n \t\textend(this.settings, options.settings || {});\n@@ -38,7 +39,8 @@ class ContinuousViewManager extends DefaultViewManager {\n \t\t\tlayout: this.layout,\n \t\t\twidth: 0,\n \t\t\theight: 0,\n-\t\t\tforceEvenPages: false\n+\t\t\tforceEvenPages: false,\n+\t\t\tallowScriptedContent: this.settings.allowScriptedContent\n \t\t};\n \n \t\tthis.scrollTop = 0;"
        },
        {
          "filename": "src/managers/default/index.js",
          "status": "modified",
          "additions": 4,
          "deletions": 2,
          "patch": "@@ -26,7 +26,8 @@ class DefaultViewManager {\n \t\t\twritingMode: undefined,\n \t\t\tflow: \"scrolled\",\n \t\t\tignoreClass: \"\",\n-\t\t\tfullsize: undefined\n+\t\t\tfullsize: undefined,\n+\t\t\tallowScriptedContent: false\n \t\t});\n \n \t\textend(this.settings, options.settings || {});\n@@ -39,7 +40,8 @@ class DefaultViewManager {\n \t\t\tmethod: this.settings.method, // srcdoc, blobUrl, write\n \t\t\twidth: 0,\n \t\t\theight: 0,\n-\t\t\tforceEvenPages: true\n+\t\t\tforceEvenPages: true,\n+\t\t\tallowScriptedContent: this.settings.allowScriptedContent\n \t\t};\n \n \t\tthis.rendered = false;"
        },
        {
          "filename": "src/managers/views/iframe.js",
          "status": "modified",
          "additions": 8,
          "deletions": 1,
          "patch": "@@ -16,7 +16,8 @@ class IframeView {\n \t\t\tlayout: undefined,\n \t\t\tglobalLayoutProperties: {},\n \t\t\tmethod: undefined,\n-\t\t\tforceRight: false\n+\t\t\tforceRight: false,\n+\t\t\tallowScriptedContent: false\n \t\t}, options || {});\n \n \t\tthis.id = \"epubjs-view-\" + uuid();\n@@ -88,6 +89,12 @@ class IframeView {\n \t\t// Back up if seamless isn't supported\n \t\tthis.iframe.style.border = \"none\";\n \n+\t\t// sandbox\n+\t\tthis.iframe.sandbox = \"allow-same-origin\";\n+\t\tif (this.settings.allowScriptedContent && this.section.properties.indexOf(\"scripted\") > -1) {\n+\t\t\tthis.iframe.sandbox += \" allow-scripts\"\n+\t\t}\n+\n \t\tthis.iframe.setAttribute(\"enable-annotation\", \"true\");\n \n \t\tthis.resizing = true;"
        },
        {
          "filename": "src/rendition.js",
          "status": "modified",
          "additions": 4,
          "deletions": 1,
          "patch": "@@ -36,6 +36,8 @@ import ContinuousViewManager from \"./managers/continuous/index\";\n  * @param {boolean} [options.resizeOnOrientationChange] false to disable orientation events\n  * @param {string} [options.script] url of script to be injected\n  * @param {boolean | object} [options.snap=false] use snap scrolling\n+ * @param {string} [options.defaultDirection='ltr'] default text direction\n+ * @param {boolean} [options.allowScriptedContent=false] enable running scripts in content\n  */\n class Rendition {\n \tconstructor(book, options) {\n@@ -54,7 +56,8 @@ class Rendition {\n \t\t\tresizeOnOrientationChange: true,\n \t\t\tscript: null,\n \t\t\tsnap: false,\n-\t\t\tdefaultDirection: \"ltr\"\n+\t\t\tdefaultDirection: \"ltr\",\n+\t\t\tallowScriptedContent: false\n \t\t});\n \n \t\textend(this.settings, options);"
        },
        {
          "filename": "types/managers/view.d.ts",
          "status": "modified",
          "additions": 2,
          "deletions": 1,
          "patch": "@@ -10,7 +10,8 @@ export interface ViewSettings {\n   method?: string,\n   width?: number,\n   height?: number,\n-  forceEvenPages?: boolean\n+  forceEvenPages?: boolean,\n+  allowScriptedContent?: boolean\n }\n \n export default class View {"
        },
        {
          "filename": "types/rendition.d.ts",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -25,6 +25,7 @@ export interface RenditionOptions {\n   overflow?: string,\n   snap?: boolean | object,\n   defaultDirection?: string,\n+  allowScriptedContent?: boolean\n }\n \n export interface DisplayedLocation {"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 1,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 7,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "f09089cf77c55427bfdac7e0a4fa130e373a19c8",
            "date": "2023-05-16T05:02:29Z",
            "author_login": "fchasen"
          },
          {
            "sha": "c738e658a2e5096299c22bb4fce16871fee161d7",
            "date": "2023-05-16T05:01:29Z",
            "author_login": "fchasen"
          },
          {
            "sha": "cb5cf21a71cff6c874f799267abec62d02ed1696",
            "date": "2023-05-16T05:01:11Z",
            "author_login": "fchasen"
          },
          {
            "sha": "00aeaa544b2418d213f7a9020531bbfade1ba49c",
            "date": "2023-03-03T02:41:06Z",
            "author_login": "laterbuy"
          },
          {
            "sha": "4dde26a2a56fe66227493085fc84b0bf7c5ec3fd",
            "date": "2022-12-17T01:36:36Z",
            "author_login": "cbednarski"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.1,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N",
    "cwe_id": "CWE-79",
    "description": "managers/views/iframe.js in FuturePress EPub.js before 0.3.89 allows XSS.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2022-01-17T17:15:07.537",
    "last_modified": "2024-11-21T06:08:10.670",
    "fix_date": "2021-10-21T03:15:50Z"
  },
  "references": [
    {
      "url": "https://github.com/futurepress/epub.js/blob/5c7f21d648d9d20d44c6c365d164b16871847023/src/managers/views/iframe.js#L373",
      "source": "cve@mitre.org",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/futurepress/epub.js/commit/ab4dd46408cce0324e1c67de4a3ba96b59e5012e",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/futurepress/epub.js/compare/v0.3.88...v0.3.89",
      "source": "cve@mitre.org",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/futurepress/epub.js/blob/5c7f21d648d9d20d44c6c365d164b16871847023/src/managers/views/iframe.js#L373",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/futurepress/epub.js/commit/ab4dd46408cce0324e1c67de4a3ba96b59e5012e",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/futurepress/epub.js/compare/v0.3.88...v0.3.89",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:57.034297",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "epub.js",
    "owner": "futurepress",
    "created_at": "2012-10-27T16:07:37Z",
    "updated_at": "2025-01-13T08:50:23Z",
    "pushed_at": "2024-07-26T08:36:29Z",
    "size": 27652,
    "stars": 6554,
    "forks": 1120,
    "open_issues": 510,
    "watchers": 6554,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "JavaScript": 378254,
      "HTML": 357,
      "TypeScript": 229
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0.0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T13:10:12.932051"
  }
}