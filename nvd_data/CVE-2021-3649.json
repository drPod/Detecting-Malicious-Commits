{
  "cve_id": "CVE-2021-3649",
  "github_data": {
    "repository": "chatwoot/chatwoot",
    "fix_commit": "aa7db90cd2d23dbcf22a94f1e4c100dd909e2172",
    "related_commits": [
      "aa7db90cd2d23dbcf22a94f1e4c100dd909e2172",
      "aa7db90cd2d23dbcf22a94f1e4c100dd909e2172"
    ],
    "patch_url": "https://github.com/chatwoot/chatwoot/commit/aa7db90cd2d23dbcf22a94f1e4c100dd909e2172.patch",
    "fix_commit_details": {
      "sha": "aa7db90cd2d23dbcf22a94f1e4c100dd909e2172",
      "commit_date": "2021-07-15T07:24:31Z",
      "author": {
        "login": "pranavrajs",
        "type": "User",
        "stats": {
          "total_commits": 1115,
          "average_weekly_commits": 3.926056338028169,
          "total_additions": 359060,
          "total_deletions": 179584,
          "weeks_active": 248
        }
      },
      "commit_message": {
        "title": "fix: Use Dompurify to strip style characters (#2632)",
        "length": 52,
        "has_description": false,
        "references_issue": true
      },
      "stats": {
        "total": 61,
        "additions": 34,
        "deletions": 27
      },
      "files": [
        {
          "filename": "app/javascript/dashboard/components/widgets/conversation/Message.vue",
          "status": "modified",
          "additions": 1,
          "deletions": 2,
          "patch": "@@ -91,7 +91,6 @@ import contentTypeMixin from 'shared/mixins/contentTypeMixin';\n import BubbleActions from './bubble/Actions';\n import { MESSAGE_TYPE, MESSAGE_STATUS } from 'shared/constants/messages';\n import { generateBotMessageContent } from './helpers/botMessageContentHelper';\n-import { stripStyleCharacters } from './helpers/EmailContentParser';\n \n export default {\n   components: {\n@@ -140,7 +139,7 @@ export default {\n \n       if ((replyHTMLContent || fullHTMLContent) && this.isIncoming) {\n         let contentToBeParsed = replyHTMLContent || fullHTMLContent || '';\n-        const parsedContent = stripStyleCharacters(contentToBeParsed);\n+        const parsedContent = this.stripStyleCharacters(contentToBeParsed);\n         if (parsedContent) {\n           return parsedContent;\n         }"
        },
        {
          "filename": "app/javascript/dashboard/components/widgets/conversation/helpers/EmailContentParser.js",
          "status": "removed",
          "additions": 0,
          "deletions": 12,
          "patch": "@@ -1,12 +0,0 @@\n-export const stripStyleCharacters = emailContent => {\n-  let contentToBeParsed = emailContent.replace(/<style(.|\\s)*?<\\/style>/g, '');\n-  contentToBeParsed = contentToBeParsed.replace(/style=\"(.*?)\"/g, '');\n-  let parsedContent = new DOMParser().parseFromString(\n-    contentToBeParsed,\n-    'text/html'\n-  );\n-  if (!parsedContent.getElementsByTagName('parsererror').length) {\n-    return parsedContent.body.innerHTML;\n-  }\n-  return '';\n-};"
        },
        {
          "filename": "app/javascript/dashboard/components/widgets/conversation/helpers/specs/EmailContentParser.spec.js",
          "status": "removed",
          "additions": 0,
          "deletions": 13,
          "patch": "@@ -1,13 +0,0 @@\n-import { stripStyleCharacters } from '../EmailContentParser';\n-\n-describe('#stripStyleCharacters', () => {\n-  it('remove style characters', () => {\n-    expect(\n-      stripStyleCharacters(\n-        `<html><body><style type=\"text/css\"> \\n<!-- \\nimg \\n\t{max-width:100%} \\ndiv \\n\t{width:100%!important; \\n\theight:100%; \\n\tline-height:1.6em} \\ndiv \\n\t{background-color:#f6f6f6} \\n--> \\n</style>\\n<div itemscope=\"\" itemtype=\"http://schema.org/EmailMessage\" style=\"font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; box-sizing:border-box; font-size:14px; width:100%!important; height:100%; line-height:1.6em; background-color:#f6f6f6; margin:0; background-color:#f6f6f6\">Test Content</div>\\n</body></html>`\n-      )\n-    ).toEqual(\n-      '\\n<div itemscope=\"\" itemtype=\"http://schema.org/EmailMessage\">Test Content</div>\\n'\n-    );\n-  });\n-});"
        },
        {
          "filename": "app/javascript/shared/mixins/messageFormatterMixin.js",
          "status": "modified",
          "additions": 20,
          "deletions": 0,
          "patch": "@@ -1,4 +1,5 @@\n import MessageFormatter from '../helpers/MessageFormatter';\n+import DOMPurify from 'dompurify';\n \n export default {\n   methods: {\n@@ -17,5 +18,24 @@ export default {\n \n       return `${description.slice(0, 97)}...`;\n     },\n+    stripStyleCharacters(message) {\n+      return DOMPurify.sanitize(message, {\n+        FORBID_TAGS: ['style'],\n+        FORBID_ATTR: [\n+          'id',\n+          'class',\n+          'style',\n+          'bgcolor',\n+          'valign',\n+          'width',\n+          'face',\n+          'color',\n+          'height',\n+          'lang',\n+          'align',\n+          'size',\n+        ],\n+      });\n+    },\n   },\n };"
        },
        {
          "filename": "app/javascript/shared/mixins/specs/messageFormatterMixin.spec.js",
          "status": "modified",
          "additions": 13,
          "deletions": 0,
          "patch": "@@ -14,4 +14,17 @@ describe('messageFormatterMixin', () => {\n       'Chatwoot is an opensource tool. https://www.chatwoot.com'\n     );\n   });\n+\n+  it('stripStyleCharacters returns message without style tags', () => {\n+    const Component = {\n+      render() {},\n+      mixins: [messageFormatterMixin],\n+    };\n+    const wrapper = shallowMount(Component);\n+    const message =\n+      '<b style=\"max-width:100%\">Chatwoot is an opensource tool. https://www.chatwoot.com</b><style type=\"css\">.message{}</style>';\n+    expect(wrapper.vm.stripStyleCharacters(message)).toMatch(\n+      '<b>Chatwoot is an opensource tool. https://www.chatwoot.com</b>'\n+    );\n+  });\n });"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 5,
        "max_directory_depth": 8
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "0c01303db0a3a1f4f79bd6fe40a84c11a5500d0a",
            "date": "2025-01-14T16:30:56Z",
            "author_login": "chatwoot-bot"
          },
          {
            "sha": "91dd92e318fc3e5f4614fce66897a786cd972fe8",
            "date": "2025-01-14T14:15:42Z",
            "author_login": "vishnu-narayanan"
          },
          {
            "sha": "03a938eb6092c988a1fb4e90cb3bfcbc34a26a81",
            "date": "2025-01-14T14:13:56Z",
            "author_login": "vishnu-narayanan"
          },
          {
            "sha": "26187c3ebf399ccec2e041d80a908fa94d8672c1",
            "date": "2025-01-14T10:58:29Z",
            "author_login": "scmmishra"
          },
          {
            "sha": "bffc24d119ac133f937ddce76b14dfc43d6d5ebc",
            "date": "2025-01-14T07:18:30Z",
            "author_login": "iamsivin"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 7.5,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H",
    "cwe_id": "CWE-1333",
    "description": "chatwoot is vulnerable to Inefficient Regular Expression Complexity",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2021-07-16T14:15:08.063",
    "last_modified": "2024-11-21T06:22:04.390",
    "fix_date": "2021-07-15T07:24:31Z"
  },
  "references": [
    {
      "url": "https://github.com/chatwoot/chatwoot/commit/aa7db90cd2d23dbcf22a94f1e4c100dd909e2172",
      "source": "security@huntr.dev",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/1625088985607-chatwoot/chatwoot",
      "source": "security@huntr.dev",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/chatwoot/chatwoot/commit/aa7db90cd2d23dbcf22a94f1e4c100dd909e2172",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/1625088985607-chatwoot/chatwoot",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:02.311151",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "chatwoot",
    "owner": "chatwoot",
    "created_at": "2019-08-14T06:50:51Z",
    "updated_at": "2025-01-14T12:56:36Z",
    "pushed_at": "2025-01-14T11:50:33Z",
    "size": 151937,
    "stars": 21934,
    "forks": 3740,
    "open_issues": 937,
    "watchers": 21934,
    "has_security_policy": false,
    "default_branch": "develop",
    "protected_branches": [
      "3.x"
    ],
    "languages": {
      "Ruby": 2998525,
      "Vue": 2505452,
      "JavaScript": 2090105,
      "HTML": 162143,
      "SCSS": 105806,
      "Shell": 37442,
      "Liquid": 11120,
      "TypeScript": 5496,
      "Dockerfile": 4503,
      "Makefile": 1114,
      "Procfile": 283
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T14:00:34.446910"
  }
}