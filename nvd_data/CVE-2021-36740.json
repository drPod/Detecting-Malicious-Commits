{
  "cve_id": "CVE-2021-36740",
  "github_data": {
    "repository": "varnishcache/varnish-cache",
    "fix_commit": "82b0a629f60136e76112c6f2c6372cce77b683be",
    "related_commits": [
      "82b0a629f60136e76112c6f2c6372cce77b683be",
      "9be22198e258d0e7a5c41f4291792214a29405cf",
      "82b0a629f60136e76112c6f2c6372cce77b683be",
      "9be22198e258d0e7a5c41f4291792214a29405cf"
    ],
    "patch_url": "https://github.com/varnishcache/varnish-cache/commit/82b0a629f60136e76112c6f2c6372cce77b683be.patch",
    "fix_commit_details": {
      "sha": "82b0a629f60136e76112c6f2c6372cce77b683be",
      "commit_date": "2021-06-22T09:47:55Z",
      "author": {
        "login": "mbgrydeland",
        "type": "User",
        "stats": {
          "total_commits": 783,
          "average_weekly_commits": 0.7933130699088146,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 230
        }
      },
      "commit_message": {
        "title": "Take content length into account on H/2 request bodies",
        "length": 246,
        "has_description": true,
        "references_issue": false
      },
      "stats": {
        "total": 48,
        "additions": 38,
        "deletions": 10
      },
      "files": [
        {
          "filename": "bin/varnishd/http2/cache_http2.h",
          "status": "modified",
          "additions": 2,
          "deletions": 0,
          "patch": "@@ -134,6 +134,8 @@ struct h2_req {\n \t/* Where to wake this stream up */\n \tstruct worker\t\t\t*wrk;\n \n+\tssize_t\t\t\t\treqbody_bytes;\n+\n \tVTAILQ_ENTRY(h2_req)\t\ttx_list;\n \th2_error\t\t\terror;\n };"
        },
        {
          "filename": "bin/varnishd/http2/cache_http2_proto.c",
          "status": "modified",
          "additions": 36,
          "deletions": 10,
          "patch": "@@ -554,6 +554,7 @@ h2_end_headers(struct worker *wrk, struct h2_sess *h2,\n     struct req *req, struct h2_req *r2)\n {\n \th2_error h2e;\n+\tssize_t cl;\n \n \tASSERT_RXTHR(h2);\n \tassert(r2->state == H2_S_OPEN);\n@@ -574,16 +575,24 @@ h2_end_headers(struct worker *wrk, struct h2_sess *h2,\n \t// XXX: Have I mentioned H/2 Is hodge-podge ?\n \thttp_CollectHdrSep(req->http, H_Cookie, \"; \");\t// rfc7540,l,3114,3120\n \n+\tcl = http_GetContentLength(req->http);\n+\tassert(cl >= -2);\n+\tif (cl == -2) {\n+\t\tVSLb(h2->vsl, SLT_Debug, \"Non-parseable Content-Length\");\n+\t\treturn (H2SE_PROTOCOL_ERROR);\n+\t}\n+\n \tif (req->req_body_status == NULL) {\n-\t\tif (!http_GetHdr(req->http, H_Content_Length, NULL))\n+\t\tif (cl == -1)\n \t\t\treq->req_body_status = BS_EOF;\n \t\telse\n \t\t\treq->req_body_status = BS_LENGTH;\n+\t\treq->htc->content_length = cl;\n \t} else {\n \t\t/* A HEADER frame contained END_STREAM */\n \t\tassert (req->req_body_status == BS_NONE);\n \t\tr2->state = H2_S_CLOS_REM;\n-\t\tif (http_GetContentLength(req->http) > 0)\n+\t\tif (cl > 0)\n \t\t\treturn (H2CE_PROTOCOL_ERROR); //rfc7540,l,1838,1840\n \t}\n \n@@ -737,6 +746,7 @@ h2_rx_data(struct worker *wrk, struct h2_sess *h2, struct h2_req *r2)\n \tint w1 = 0, w2 = 0;\n \tchar buf[4];\n \tunsigned wi;\n+\tssize_t cl;\n \n \tCHECK_OBJ_NOTNULL(wrk, WORKER_MAGIC);\n \tASSERT_RXTHR(h2);\n@@ -755,6 +765,23 @@ h2_rx_data(struct worker *wrk, struct h2_sess *h2, struct h2_req *r2)\n \t\tLck_Unlock(&h2->sess->mtx);\n \t\treturn (h2->error ? h2->error : r2->error);\n \t}\n+\n+\tr2->reqbody_bytes += h2->rxf_len;\n+\tif (h2->rxf_flags & H2FF_DATA_END_STREAM)\n+\t\tr2->state = H2_S_CLOS_REM;\n+\tcl = r2->req->htc->content_length;\n+\tif (cl >= 0 && (r2->reqbody_bytes > cl ||\n+\t      (r2->state >= H2_S_CLOS_REM && r2->reqbody_bytes != cl))) {\n+\t\tVSLb(h2->vsl, SLT_Debug,\n+\t\t    \"H2: stream %u: Received data and Content-Length\"\n+\t\t    \" mismatch\", h2->rxf_stream);\n+\t\tr2->error = H2SE_PROTOCOL_ERROR; // rfc7540,l,3150,3163\n+\t\tif (r2->cond)\n+\t\t\tAZ(pthread_cond_signal(r2->cond));\n+\t\tLck_Unlock(&h2->sess->mtx);\n+\t\treturn (H2SE_PROTOCOL_ERROR);\n+\t}\n+\n \tAZ(h2->mailcall);\n \th2->mailcall = r2;\n \th2->req0->r_window -= h2->rxf_len;\n@@ -773,6 +800,8 @@ h2_rx_data(struct worker *wrk, struct h2_sess *h2, struct h2_req *r2)\n \t\tr2->r_window += wi;\n \t\tw2 = 1;\n \t}\n+\n+\n \tLck_Unlock(&h2->sess->mtx);\n \n \tif (w1 || w2) {\n@@ -795,7 +824,7 @@ h2_vfp_body(struct vfp_ctx *vc, struct vfp_entry *vfe, void *ptr, ssize_t *lp)\n \tstruct h2_req *r2;\n \tstruct h2_sess *h2;\n \tunsigned l;\n-\tenum vfp_status retval = VFP_OK;\n+\tenum vfp_status retval;\n \n \tCHECK_OBJ_NOTNULL(vc, VFP_CTX_MAGIC);\n \tCHECK_OBJ_NOTNULL(vfe, VFP_ENTRY_MAGIC);\n@@ -808,7 +837,6 @@ h2_vfp_body(struct vfp_ctx *vc, struct vfp_entry *vfe, void *ptr, ssize_t *lp)\n \t*lp = 0;\n \n \tLck_Lock(&h2->sess->mtx);\n-\tassert (r2->state == H2_S_OPEN);\n \tr2->cond = &vc->wrk->cond;\n \twhile (h2->mailcall != r2 && h2->error == 0 && r2->error == 0)\n \t\tAZ(Lck_CondWait(r2->cond, &h2->sess->mtx, 0));\n@@ -831,12 +859,10 @@ h2_vfp_body(struct vfp_ctx *vc, struct vfp_entry *vfe, void *ptr, ssize_t *lp)\n \t\t\tLck_Unlock(&h2->sess->mtx);\n \t\t\treturn (VFP_OK);\n \t\t}\n-\t\tif (h2->rxf_len == 0) {\n-\t\t\tif (h2->rxf_flags & H2FF_DATA_END_STREAM) {\n-\t\t\t\tretval = VFP_END;\n-\t\t\t\tr2->state = H2_S_CLOS_REM;\n-\t\t\t}\n-\t\t}\n+\t\tif (h2->rxf_len == 0 && r2->state >= H2_S_CLOS_REM)\n+\t\t\tretval = VFP_END;\n+\t\telse\n+\t\t\tretval = VFP_OK;\n \t\th2->mailcall = NULL;\n \t\tAZ(pthread_cond_signal(h2->cond));\n \t}"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 1,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "df8ee3355e519bdc9bdb33dc154769bcf7b3d13f",
            "date": "2025-01-14T08:36:36Z",
            "author_login": "bsdphk"
          },
          {
            "sha": "a104a2b4e469c35c7f60216be402ccb5dd7dbe3f",
            "date": "2025-01-13T14:31:00Z",
            "author_login": "nigoroll"
          },
          {
            "sha": "2133a93e5f606e69134d8d734bd25b4bd233c79f",
            "date": "2025-01-04T20:19:44Z",
            "author_login": "gido"
          },
          {
            "sha": "414d1b2668b320336d9c1d9188dfc46e6f78fd5c",
            "date": "2024-12-12T07:49:27Z",
            "author_login": "perbu"
          },
          {
            "sha": "df7d3acb0d81cfb18715b772053107daf7209fd1",
            "date": "2024-12-19T15:31:17Z",
            "author_login": "walid-git"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.5,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:L/A:N",
    "cwe_id": "CWE-444",
    "description": "Varnish Cache, with HTTP/2 enabled, allows request smuggling and VCL authorization bypass via a large Content-Length header for a POST request. This affects Varnish Enterprise 6.0.x before 6.0.8r3, and Varnish Cache 5.x and 6.x before 6.5.2, 6.6.x before 6.6.1, and 6.0 LTS before 6.0.8.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2021-07-14T17:15:08.253",
    "last_modified": "2024-11-21T06:13:59.623",
    "fix_date": "2021-06-22T09:47:55Z"
  },
  "references": [
    {
      "url": "https://docs.varnish-software.com/security/VSV00007/",
      "source": "cve@mitre.org",
      "tags": [
        "Mitigation",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/varnishcache/varnish-cache/commit/82b0a629f60136e76112c6f2c6372cce77b683be",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/varnishcache/varnish-cache/commit/9be22198e258d0e7a5c41f4291792214a29405cf",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/THV2DQA2GS65HUCKK4KSD2XLN3AAQ2V5/",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/ZHBNLDEOTGYRIEQZBWV7F6VPYS4O2AAK/",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "https://varnish-cache.org/security/VSV00007.html",
      "source": "cve@mitre.org",
      "tags": [
        "Mitigation",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://www.debian.org/security/2022/dsa-5088",
      "source": "cve@mitre.org",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://docs.varnish-software.com/security/VSV00007/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mitigation",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/varnishcache/varnish-cache/commit/82b0a629f60136e76112c6f2c6372cce77b683be",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/varnishcache/varnish-cache/commit/9be22198e258d0e7a5c41f4291792214a29405cf",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/THV2DQA2GS65HUCKK4KSD2XLN3AAQ2V5/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/ZHBNLDEOTGYRIEQZBWV7F6VPYS4O2AAK/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://varnish-cache.org/security/VSV00007.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mitigation",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://www.debian.org/security/2022/dsa-5088",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:02.306327",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "varnish-cache",
    "owner": "varnishcache",
    "created_at": "2015-10-05T12:04:36Z",
    "updated_at": "2025-01-14T11:01:18Z",
    "pushed_at": "2025-01-14T08:37:02Z",
    "size": 34988,
    "stars": 3738,
    "forks": 381,
    "open_issues": 154,
    "watchers": 3738,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "master"
    ],
    "languages": {
      "C": 3780267,
      "M4": 108134,
      "Python": 101174,
      "Shell": 38810,
      "Makefile": 24332,
      "VCL": 13962,
      "SmPL": 11543,
      "Roff": 7156,
      "Awk": 4467,
      "Dockerfile": 226,
      "Emacs Lisp": 66
    },
    "commit_activity": {
      "total_commits_last_year": 706,
      "avg_commits_per_week": 13.576923076923077,
      "days_active_last_year": 147
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T13:40:13.412646"
  }
}