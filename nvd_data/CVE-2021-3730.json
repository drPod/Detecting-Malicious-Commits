{
  "cve_id": "CVE-2021-3730",
  "github_data": {
    "repository": "firefly-iii/firefly-iii",
    "fix_commit": "f80178b1b2b7864d17500a131d570c353c9a26f6",
    "related_commits": [
      "f80178b1b2b7864d17500a131d570c353c9a26f6",
      "f80178b1b2b7864d17500a131d570c353c9a26f6"
    ],
    "patch_url": "https://github.com/firefly-iii/firefly-iii/commit/f80178b1b2b7864d17500a131d570c353c9a26f6.patch",
    "fix_commit_details": {
      "sha": "f80178b1b2b7864d17500a131d570c353c9a26f6",
      "commit_date": "2021-08-20T08:05:18Z",
      "author": {
        "login": "JC5",
        "type": "User",
        "stats": {
          "total_commits": 18382,
          "average_weekly_commits": 33.30072463768116,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 546
        }
      },
      "commit_message": {
        "title": "Fix https://huntr.dev/bounties/ea181323-51f8-46a2-a60f-6a401907feb7/",
        "length": 68,
        "has_description": false,
        "references_issue": true
      },
      "stats": {
        "total": 182,
        "additions": 43,
        "deletions": 139
      },
      "files": [
        {
          "filename": "app/Http/Controllers/Budget/AvailableBudgetController.php",
          "status": "modified",
          "additions": 9,
          "deletions": 3,
          "patch": "@@ -137,10 +137,16 @@ static function (TransactionCurrency $currency) use ($availableBudgets) {\n      *\n      * @return RedirectResponse|Redirector\n      */\n-    public function delete(AvailableBudget $availableBudget)\n+    public function delete(Request $request)\n     {\n-        $this->abRepository->destroyAvailableBudget($availableBudget);\n-        session()->flash('success', trans('firefly.deleted_ab'));\n+        $id = (int)$request->get('id');\n+        if (0 !== $id) {\n+            $availableBudget = $this->abRepository->findById($id);\n+            if (null !== $availableBudget) {\n+                $this->abRepository->destroyAvailableBudget($availableBudget);\n+                session()->flash('success', trans('firefly.deleted_ab'));\n+            }\n+        }\n \n         return redirect(route('budgets.index'));\n     }"
        },
        {
          "filename": "app/Repositories/Budget/AvailableBudgetRepository.php",
          "status": "modified",
          "additions": 8,
          "deletions": 0,
          "patch": "@@ -79,6 +79,14 @@ public function find(TransactionCurrency $currency, Carbon $start, Carbon $end):\n \n     }\n \n+    /**\n+     * @inheritDoc\n+     */\n+    public function findById(int $id): ?AvailableBudget\n+    {\n+        return $this->user->availableBudgets->find($id);\n+    }\n+\n     /**\n      * Return a list of all available budgets (in all currencies) (for the selected period).\n      *"
        },
        {
          "filename": "app/Repositories/Budget/AvailableBudgetRepositoryInterface.php",
          "status": "modified",
          "additions": 7,
          "deletions": 0,
          "patch": "@@ -56,6 +56,13 @@ public function destroyAvailableBudget(AvailableBudget $availableBudget): void;\n      */\n     public function find(TransactionCurrency $currency, Carbon $start, Carbon $end): ?AvailableBudget;\n \n+    /**\n+     * @param int $id\n+     *\n+     * @return AvailableBudget|null\n+     */\n+    public function findById(int $id): ?AvailableBudget;\n+\n     /**\n      * Return a list of all available budgets (in all currencies) (for the selected period).\n      *"
        },
        {
          "filename": "app/Repositories/Budget/BudgetLimitRepository.php",
          "status": "modified",
          "additions": 4,
          "deletions": 2,
          "patch": "@@ -22,6 +22,7 @@\n declare(strict_types=1);\n \n namespace FireflyIII\\Repositories\\Budget;\n+\n use Carbon\\Carbon;\n use Exception;\n use FireflyIII\\Exceptions\\FireflyException;\n@@ -319,7 +320,7 @@ public function store(array $data): BudgetLimit\n         // find the budget:\n         $budget = $this->user->budgets()->find((int)$data['budget_id']);\n         if (null === $budget) {\n-            throw new FireflyException('200004: Budget does not exist.'); \n+            throw new FireflyException('200004: Budget does not exist.');\n         }\n \n         // find limit with same date range and currency.\n@@ -329,7 +330,7 @@ public function store(array $data): BudgetLimit\n                         ->where('budget_limits.transaction_currency_id', $currency->id)\n                         ->first(['budget_limits.*']);\n         if (null !== $limit) {\n-            throw new FireflyException('200027: Budget limit already exists.'); \n+            throw new FireflyException('200027: Budget limit already exists.');\n         }\n         Log::debug('No existing budget limit, create a new one');\n \n@@ -425,6 +426,7 @@ public function updateLimitAmount(Budget $budget, Carbon $start, Carbon $end, st\n             } catch (Exception $e) { // @phpstan-ignore-line\n                 // @ignoreException\n             }\n+\n             return null;\n         }\n         // update if exists:"
        },
        {
          "filename": "public/v1/js/ff/budgets/index.js",
          "status": "modified",
          "additions": 12,
          "deletions": 131,
          "patch": "@@ -30,6 +30,7 @@ $(function () {\n     drawBudgetedBars();\n \n     $('.update_ab').on('click', updateAvailableBudget);\n+    $('.delete_ab').on('click', deleteAvailableBudget);\n     $('.create_ab_alt').on('click', createAltAvailableBudget);\n \n     $('.budget_amount').on('change', updateBudgetedAmount);\n@@ -241,7 +242,17 @@ function updateAvailableBudget(e) {\n     }\n     return false;\n }\n-\n+function deleteAvailableBudget(e) {\n+    //\n+    e.preventDefault();\n+    var button = $(e.currentTarget);\n+    var abId = button.data('id');\n+    $.post(deleteABUrl, {_token: token, id: abId}).then(function () {\n+        // lame but it works.\n+        location.reload();\n+    });\n+    return false;\n+}\n \n function drawBudgetedBars() {\n     \"use strict\";\n@@ -288,133 +299,3 @@ function drawSpentBars() {\n         }\n     });\n }\n-\n-//\n-//\n-// function drawSpentBar() {\n-//     \"use strict\";\n-//     if ($('.spentBar').length > 0) {\n-//         var overspent = spent > budgeted;\n-//         var pct;\n-//\n-//         if (overspent) {\n-//             // draw overspent bar\n-//             pct = (budgeted / spent) * 100;\n-//             $('.spentBar .progress-bar-warning').css('width', pct + '%');\n-//             $('.spentBar .progress-bar-danger').css('width', (100 - pct) + '%');\n-//         } else {\n-//             // draw normal bar:\n-//             pct = (spent / budgeted) * 100;\n-//             $('.spentBar .progress-bar-info').css('width', pct + '%');\n-//         }\n-//     }\n-// }\n-//\n-// function drawBudgetedBar() {\n-//     \"use strict\";\n-//\n-//     if ($('.budgetedBar').length > 0) {\n-//         var budgetedMuch = budgeted > available;\n-//\n-//         // recalculate percentage:\n-//\n-//         var pct;\n-//         if (budgetedMuch) {\n-//             // budgeted too much.\n-//             pct = (available / budgeted) * 100;\n-//             $('.budgetedBar .progress-bar-warning').css('width', pct + '%');\n-//             $('.budgetedBar .progress-bar-danger').css('width', (100 - pct) + '%');\n-//             $('.budgetedBar .progress-bar-info').css('width', 0);\n-//         } else {\n-//             pct = (budgeted / available) * 100;\n-//             $('.budgetedBar .progress-bar-warning').css('width', 0);\n-//             $('.budgetedBar .progress-bar-danger').css('width', 0);\n-//             $('.budgetedBar .progress-bar-info').css('width', pct + '%');\n-//         }\n-//\n-//         $('#budgetedAmount').html(currencySymbol + ' ' + budgeted.toFixed(2));\n-//     }\n-// }\n-\n-// /**\n-//  *\n-//  * @param e\n-//  */\n-// function updateBudgetedAmounts(e) {\n-//     \"use strict\";\n-//     var target = $(e.target);\n-//     var id = target.data('id');\n-//     var leftCell = $('td[class$=\"left\"][data-id=\"' + id + '\"]');\n-//     var link = $('a[data-id=\"' + id + '\"][class=\"budget-link\"]');\n-//     var value = target.val();\n-//     var original = target.data('original');\n-//\n-//     // disable input\n-//     target.prop('disabled', true);\n-//\n-//     // replace link (for now)\n-//     link.attr('href', '#');\n-//\n-//     // replace \"left\" with spinner.\n-//     leftCell.empty().html('<i class=\"fa fa-fw fa-spin fa-spinner\"></i>');\n-//\n-//     // send a post to Firefly to update the amount:\n-//     var newUri = budgetAmountUri.replace(\"REPLACE\", id);\n-//\n-//     $.post(newUri, {amount: value, start: periodStart, end: periodEnd, _token: token}).done(function (data) {\n-//\n-//         // difference between new value and original value\n-//         var difference = value - original;\n-//\n-//         // update budgeted value\n-//         budgeted = budgeted + difference;\n-//\n-//         // fill in \"left\" value:\n-//\n-//\n-//         if (data.left_per_day !== null) {\n-//             leftCell.html(data.left + ' (' + data.left_per_day + ')');\n-//         } else {\n-//             leftCell.html(data.left);\n-//         }\n-//\n-//         // update \"budgeted\" input:\n-//         target.val(data.amount);\n-//\n-//         // enable thing again\n-//         target.prop('disabled', false);\n-//\n-//         // set new original value:\n-//         target.data('original', data.amount);\n-//\n-//         // run drawBudgetedBar() again:\n-//         drawBudgetedBar();\n-//\n-//         // update the link if relevant:\n-//         link.attr('href', 'budgets/show/' + id);\n-//         if (data.limit > 0) {\n-//             link.attr('href', 'budgets/show/' + id + '/' + data.limit);\n-//         }\n-//\n-//         // update the warning if relevant:\n-//         if (data.large_diff === true) {\n-//             $('span[class$=\"budget_warning\"][data-id=\"' + id + '\"]').html(data.warn_text).show();\n-//             console.log('Show warning for budget');\n-//         } else {\n-//             $('span[class$=\"budget_warning\"][data-id=\"' + id + '\"]').empty().hide();\n-//         }\n-//     });\n-// }\n-\n-// /**\n-//  *\n-//  * @returns {boolean}\n-//  */\n-// function updateIncome() {\n-//     \"use strict\";\n-//     $('#defaultModal').empty().load(updateIncomeUri, function () {\n-//         $('#defaultModal').modal('show');\n-//     });\n-//\n-//     return false;\n-// }"
        },
        {
          "filename": "resources/views/v1/budgets/index.twig",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -137,8 +137,7 @@\n                                         <span class=\"available_amount\" data-id=\"{{ budget.id }}\"\n                                               data-value=\"{{ budget.amount }}\">{{ formatAmountBySymbol(budget.amount, budget.transaction_currency.symbol, budget.transaction_currency.decimal_places, true) }}</span>\n                                         <a href=\"#\" data-id=\"{{ budget.id }}\" class=\"update_ab btn btn-default btn-xs\"><span class=\"fa fa-pencil\"></span></a>\n-                                        <a href=\"{{ route('available-budgets.delete', [budget.id]) }}\" data-id=\"{{ budget.id }}\"\n-                                           class=\"delete_ab btn btn-danger btn-xs\"><span class=\"fa fa-trash\"></span></a>\n+                                        <a href=\"#\" data-id=\"{{ budget.id }}\" class=\"delete_ab btn btn-danger btn-xs\"><span class=\"fa fa-trash\"></span></a>\n                                     </small>\n                                 </div>\n                             </div>\n@@ -465,6 +464,7 @@\n         var createAvailableBudgetUri = \"{{ route('available-budgets.create', [start.format('Y-m-d'), end.format('Y-m-d')]) }}\";\n         var createAltAvailableBudgetUri = \"{{ route('available-budgets.create-alternative', [start.format('Y-m-d'), end.format('Y-m-d')]) }}\";\n         var editAvailableBudgetUri = \"{{ route('available-budgets.edit', ['REPLACEME', start.format('Y-m-d'), end.format('Y-m-d')]) }}\";\n+        var deleteABUrl = \"{{ route('available-budgets.delete') }}\";\n \n         // budget limit create form.\n         var createBudgetLimitUri = \"{{ route('budget-limits.create', ['REPLACEME', start.format('Y-m-d'), end.format('Y-m-d')]) }}\";"
        },
        {
          "filename": "routes/web.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -269,7 +269,7 @@ static function () {\n         Route::get('edit/{availableBudget}/{start_date}/{end_date}', ['uses' => 'Budget\\AvailableBudgetController@edit', 'as' => 'edit']);\n         Route::post('update/{availableBudget}/{start_date}/{end_date}', ['uses' => 'Budget\\AvailableBudgetController@update', 'as' => 'update']);\n \n-        Route::get('delete/{availableBudget}', ['uses' => 'Budget\\AvailableBudgetController@delete', 'as' => 'delete']);\n+        Route::post('delete', ['uses' => 'Budget\\AvailableBudgetController@delete', 'as' => 'delete']);\n     }\n );\n "
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 5,
        "max_directory_depth": 5
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "63b34c1853b69e25047f160ef122c9a0114a2f96",
            "date": "2025-01-11T09:05:51Z",
            "author_login": "JC5"
          },
          {
            "sha": "ae80fd8578a28733b75217a2030a5b4302e78d6b",
            "date": "2025-01-03T03:51:42Z",
            "author_login": "JC5"
          },
          {
            "sha": "c17f2efca6a2f831f5e3581674a87e1799f79267",
            "date": "2025-01-03T03:36:41Z",
            "author_login": "JC5"
          },
          {
            "sha": "4a185639b98ac8328059f12e86f3762b62aec3a1",
            "date": "2025-01-03T03:32:51Z",
            "author_login": "JC5"
          },
          {
            "sha": "fb30f7ec8f5e09768861a25de90e7c0c84b95eac",
            "date": "2025-01-02T18:10:39Z",
            "author_login": "JC5"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.5,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:N/I:H/A:N",
    "cwe_id": "CWE-352",
    "description": "firefly-iii is vulnerable to Cross-Site Request Forgery (CSRF)",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2021-08-23T13:15:07.953",
    "last_modified": "2024-11-21T06:22:16.237",
    "fix_date": "2021-08-20T08:05:18Z"
  },
  "references": [
    {
      "url": "https://github.com/firefly-iii/firefly-iii/commit/f80178b1b2b7864d17500a131d570c353c9a26f6",
      "source": "security@huntr.dev",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/ea181323-51f8-46a2-a60f-6a401907feb7",
      "source": "security@huntr.dev",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/firefly-iii/firefly-iii/commit/f80178b1b2b7864d17500a131d570c353c9a26f6",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/ea181323-51f8-46a2-a60f-6a401907feb7",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:05.100143",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "firefly-iii",
    "owner": "firefly-iii",
    "created_at": "2014-06-28T07:37:32Z",
    "updated_at": "2025-01-14T10:07:09Z",
    "pushed_at": "2025-01-13T10:32:55Z",
    "size": 302492,
    "stars": 17005,
    "forks": 1540,
    "open_issues": 139,
    "watchers": 17005,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [],
    "languages": {
      "PHP": 6786878,
      "JavaScript": 2763201,
      "Twig": 936450,
      "Vue": 265560,
      "Blade": 209041,
      "CSS": 207462,
      "SCSS": 5577,
      "Shell": 5223,
      "Standard ML": 866,
      "Procfile": 59
    },
    "commit_activity": {
      "total_commits_last_year": 1180,
      "avg_commits_per_week": 22.692307692307693,
      "days_active_last_year": 227
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "agpl-3.0"
    },
    "collected_at": "2025-01-14T13:03:09.645260"
  }
}