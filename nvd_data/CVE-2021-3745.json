{
  "cve_id": "CVE-2021-3745",
  "github_data": {
    "repository": "flatcore/flatcore-cms",
    "fix_commit": "5cc3937b6bc38293ec921a5cf00018b48b668dc6",
    "related_commits": [
      "5cc3937b6bc38293ec921a5cf00018b48b668dc6",
      "5cc3937b6bc38293ec921a5cf00018b48b668dc6"
    ],
    "patch_url": "https://github.com/flatcore/flatcore-cms/commit/5cc3937b6bc38293ec921a5cf00018b48b668dc6.patch",
    "fix_commit_details": {
      "sha": "5cc3937b6bc38293ec921a5cf00018b48b668dc6",
      "commit_date": "2021-10-20T08:18:27Z",
      "author": {
        "login": "patkon",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "secure gallery upload",
        "length": 98,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 47,
        "additions": 35,
        "deletions": 12
      },
      "files": [
        {
          "filename": "acp/core/files.upload_gallery.php",
          "status": "modified",
          "additions": 33,
          "deletions": 10,
          "patch": "@@ -1,5 +1,21 @@\n <?php\n \n+session_start();\n+\n+if($_SESSION['user_class'] != \"administrator\"){\n+\theader(\"location:../index.php\");\n+\tdie(\"PERMISSION DENIED!\");\n+}\n+\n+require '../../config.php';\n+if(is_file('../../'.FC_CONTENT_DIR.'/config.php')) {\n+\tinclude '../../'.FC_CONTENT_DIR.'/config.php';\n+}\n+\n+if($_POST['csrf_token'] !== $_SESSION['token']) {\n+\tdie('Error: CSRF Token is invalid');\n+}\n+\n $year = date('Y',time());\n $gallery_id = 'gallery'. (int) $_REQUEST['gal'];\n $uploads_dir = '../../content/galleries/'.$year.'/'.$gallery_id;\n@@ -20,27 +36,34 @@\n }\n \n if(array_key_exists('file',$_FILES) && $_FILES['file']['error'] == 0 ){\n+\t\n \t$tmp_name = $_FILES[\"file\"][\"tmp_name\"];\n \t$timestring = microtime(true);\n+\t$random_int = random_int(0, 999);\n \t      \n-\t$suffix = strrchr($_FILES[\"file\"][\"name\"],\".\");\n-\t$org_name = $timestring . $suffix;\n-\t$img_name = $timestring.\"_img.jpg\";\n-\t$tmb_name = $timestring.\"_tmb.jpg\";\n+\t$suffix = substr(strrchr($_FILES[\"file\"][\"name\"],\".\"),1);\n+\t$org_name = $timestring .'.'. $suffix;\n+\t$img_name = $timestring.$random_int.\"_img.jpg\";\n+\t$tmb_name = $timestring.$random_int.\"_tmb.jpg\";\n+\n+\tif(!in_array($suffix, $fc_upload_img_types)) {\n+\t\texit;\n+\t} else {\n         \n-\tif(move_uploaded_file($tmp_name, \"$uploads_dir/$org_name\")) {\n-\t\tcreate_thumbs($uploads_dir,$org_name,$img_name, $max_width,$max_height,90);\n-\t\tcreate_thumbs($uploads_dir,$img_name,$tmb_name, $max_width_tmb,$max_height_tmb,80);\n-\t\tunlink(\"$uploads_dir/$org_name\");\n-\t\tprint ('Uploaded');\n+\t\tif(move_uploaded_file($tmp_name, \"$uploads_dir/$org_name\")) {\n+\t\t\tcreate_thumbs($uploads_dir,$org_name,$img_name, $max_width,$max_height,90);\n+\t\t\tcreate_thumbs($uploads_dir,$img_name,$tmb_name, $max_width_tmb,$max_height_tmb,80);\n+\t\t\tunlink(\"$uploads_dir/$org_name\");\n+\t\t\tprint ('Uploaded');\n+\t\t}\n \t}\n }\n function create_thumbs($updir, $img, $name, $thumbnail_width, $thumbnail_height, $quality){\n \t$arr_image_details\t= GetImageSize(\"$updir/$img\");\n \t$original_width\t\t= $arr_image_details[0];\n \t$original_height\t= $arr_image_details[1];\n \t$a = $thumbnail_width / $thumbnail_height;\n-  $b = $original_width / $original_height;\n+\t$b = $original_width / $original_height;\n \t\n \t\n \tif ($a<$b) {"
        },
        {
          "filename": "acp/templates/gallery_upload_form.tpl",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -2,9 +2,8 @@\n   <div class=\"modal-dialog modal-lg modal-dialog-centered\" role=\"document\">\n     <div class=\"modal-content\">\n       <div class=\"modal-header\">\n-        <h5 class=\"modal-title\">Upload into {post_id}</h5>\n+        <h5 class=\"modal-title\">Upload into Gallery ID #{post_id}</h5>\n         <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\" aria-label=\"Close\">\n-          <span aria-hidden=\"true\">&times;</span>\n         </button>\n       </div>\n       <div class=\"modal-body\">\n@@ -26,6 +25,7 @@\n \n <form action=\"acp.php?tn=posts&sub=edit\" method=\"POST\" id=\"reload_form\">\n \t<input type=\"hidden\" name=\"post_id\" value=\"{post_id}\">\n+\t<input type=\"hidden\" name=\"csrf_token\" value=\"{token}\">\n </form>\n \n <script>"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 2,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "9dcc9be2b8857eebe8449f6d387e47386d02dccf",
            "date": "2022-12-20T06:15:17Z",
            "author_login": "patkon"
          },
          {
            "sha": "4586fab8a176864daef748fac975775dcdbb80c3",
            "date": "2022-12-20T06:13:23Z",
            "author_login": "dependabot[bot]"
          },
          {
            "sha": "e89e55f319692fb112bacbe6846d25197dee4f9e",
            "date": "2022-12-20T06:12:48Z",
            "author_login": "patkon"
          },
          {
            "sha": "6839e4a978135c8a225f73a53703c9319ddcb655",
            "date": "2022-12-09T00:43:32Z",
            "author_login": "dependabot[bot]"
          },
          {
            "sha": "e517fc03ab5ae212859efb20c6c94a12d2db623b",
            "date": "2022-06-15T19:07:22Z",
            "author_login": "patkon"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.6,
    "cvss_vector": "CVSS:3.1/AV:N/AC:H/PR:H/UI:N/S:U/C:H/I:H/A:H",
    "cwe_id": "CWE-434",
    "description": "flatcore-cms is vulnerable to Unrestricted Upload of File with Dangerous Type",
    "attack_vector": "NETWORK",
    "attack_complexity": "HIGH"
  },
  "temporal_data": {
    "published_date": "2021-10-28T17:15:07.467",
    "last_modified": "2024-11-21T06:22:19.240",
    "fix_date": "2021-10-20T08:18:27Z"
  },
  "references": [
    {
      "url": "https://github.com/flatcore/flatcore-cms/commit/5cc3937b6bc38293ec921a5cf00018b48b668dc6",
      "source": "security@huntr.dev",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/7879ab3d-8018-402a-aa0b-131bdbd1966c",
      "source": "security@huntr.dev",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/flatcore/flatcore-cms/commit/5cc3937b6bc38293ec921a5cf00018b48b668dc6",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/7879ab3d-8018-402a-aa0b-131bdbd1966c",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:31.854298",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "flatCore-CMS",
    "owner": "flatcore",
    "created_at": "2012-12-01T20:42:10Z",
    "updated_at": "2024-01-02T23:38:36Z",
    "pushed_at": "2022-12-20T06:15:26Z",
    "size": 22030,
    "stars": 50,
    "forks": 16,
    "open_issues": 0,
    "watchers": 50,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [],
    "languages": {
      "JavaScript": 5571192,
      "PHP": 2515682,
      "CSS": 1676163,
      "HTML": 161004,
      "Smarty": 109909,
      "SCSS": 48151
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0.0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "gpl-3.0"
    },
    "collected_at": "2025-01-14T14:05:16.449218"
  }
}