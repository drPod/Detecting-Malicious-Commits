{
  "cve_id": "CVE-2021-3748",
  "github_data": {
    "repository": "qemu/qemu",
    "fix_commit": "bedd7e93d01961fcb16a97ae45d93acf357e11f6",
    "related_commits": [
      "bedd7e93d01961fcb16a97ae45d93acf357e11f6",
      "bedd7e93d01961fcb16a97ae45d93acf357e11f6"
    ],
    "patch_url": "https://github.com/qemu/qemu/commit/bedd7e93d01961fcb16a97ae45d93acf357e11f6.patch",
    "fix_commit_details": {
      "sha": "bedd7e93d01961fcb16a97ae45d93acf357e11f6",
      "commit_date": "2021-09-02T05:44:12Z",
      "author": {
        "login": "jasowang",
        "type": "User",
        "stats": {
          "total_commits": 251,
          "average_weekly_commits": 0.3013205282112845,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 96
        }
      },
      "commit_message": {
        "title": "virtio-net: fix use after unmap/free for sg",
        "length": 714,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 39,
        "additions": 32,
        "deletions": 7
      },
      "files": [
        {
          "filename": "hw/net/virtio-net.c",
          "status": "modified",
          "additions": 32,
          "deletions": 7,
          "patch": "@@ -1746,10 +1746,13 @@ static ssize_t virtio_net_receive_rcu(NetClientState *nc, const uint8_t *buf,\n     VirtIONet *n = qemu_get_nic_opaque(nc);\n     VirtIONetQueue *q = virtio_net_get_subqueue(nc);\n     VirtIODevice *vdev = VIRTIO_DEVICE(n);\n+    VirtQueueElement *elems[VIRTQUEUE_MAX_SIZE];\n+    size_t lens[VIRTQUEUE_MAX_SIZE];\n     struct iovec mhdr_sg[VIRTQUEUE_MAX_SIZE];\n     struct virtio_net_hdr_mrg_rxbuf mhdr;\n     unsigned mhdr_cnt = 0;\n-    size_t offset, i, guest_offset;\n+    size_t offset, i, guest_offset, j;\n+    ssize_t err;\n \n     if (!virtio_net_can_receive(nc)) {\n         return -1;\n@@ -1780,6 +1783,12 @@ static ssize_t virtio_net_receive_rcu(NetClientState *nc, const uint8_t *buf,\n \n         total = 0;\n \n+        if (i == VIRTQUEUE_MAX_SIZE) {\n+            virtio_error(vdev, \"virtio-net unexpected long buffer chain\");\n+            err = size;\n+            goto err;\n+        }\n+\n         elem = virtqueue_pop(q->rx_vq, sizeof(VirtQueueElement));\n         if (!elem) {\n             if (i) {\n@@ -1791,15 +1800,17 @@ static ssize_t virtio_net_receive_rcu(NetClientState *nc, const uint8_t *buf,\n                              n->guest_hdr_len, n->host_hdr_len,\n                              vdev->guest_features);\n             }\n-            return -1;\n+            err = -1;\n+            goto err;\n         }\n \n         if (elem->in_num < 1) {\n             virtio_error(vdev,\n                          \"virtio-net receive queue contains no in buffers\");\n             virtqueue_detach_element(q->rx_vq, elem, 0);\n             g_free(elem);\n-            return -1;\n+            err = -1;\n+            goto err;\n         }\n \n         sg = elem->in_sg;\n@@ -1836,12 +1847,13 @@ static ssize_t virtio_net_receive_rcu(NetClientState *nc, const uint8_t *buf,\n         if (!n->mergeable_rx_bufs && offset < size) {\n             virtqueue_unpop(q->rx_vq, elem, total);\n             g_free(elem);\n-            return size;\n+            err = size;\n+            goto err;\n         }\n \n-        /* signal other side */\n-        virtqueue_fill(q->rx_vq, elem, total, i++);\n-        g_free(elem);\n+        elems[i] = elem;\n+        lens[i] = total;\n+        i++;\n     }\n \n     if (mhdr_cnt) {\n@@ -1851,10 +1863,23 @@ static ssize_t virtio_net_receive_rcu(NetClientState *nc, const uint8_t *buf,\n                      &mhdr.num_buffers, sizeof mhdr.num_buffers);\n     }\n \n+    for (j = 0; j < i; j++) {\n+        /* signal other side */\n+        virtqueue_fill(q->rx_vq, elems[j], lens[j], j);\n+        g_free(elems[j]);\n+    }\n+\n     virtqueue_flush(q->rx_vq, i);\n     virtio_notify(vdev, q->rx_vq);\n \n     return size;\n+\n+err:\n+    for (j = 0; j < i; j++) {\n+        g_free(elems[j]);\n+    }\n+\n+    return err;\n }\n \n static ssize_t virtio_net_do_receive(NetClientState *nc, const uint8_t *buf,"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 1,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "e8aa7fdcddfc8589bdc7c973a052e76e8f999455",
            "date": "2025-01-13T14:43:48Z",
            "author_login": "stefanhaRH"
          },
          {
            "sha": "435d260e7ec5ff9c79e3e62f1d66ec82d2d691ae",
            "date": "2025-01-13T12:35:35Z",
            "author_login": "pbo-linaro"
          },
          {
            "sha": "132f8ec799cea261ad6b60ac8ae86f17cc98b9a1",
            "date": "2025-01-13T12:35:34Z",
            "author_login": "pbo-linaro"
          },
          {
            "sha": "39d70016d9abe15967f7051741dd5621c659b1f4",
            "date": "2025-01-13T12:35:34Z",
            "author_login": "pm215"
          },
          {
            "sha": "86a00f2046f5f5b613bdf18d6c972b495a907c37",
            "date": "2025-01-13T12:35:34Z",
            "author_login": "pbo-linaro"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 7.5,
    "cvss_vector": "CVSS:3.1/AV:L/AC:H/PR:H/UI:N/S:C/C:H/I:H/A:H",
    "cwe_id": "CWE-416",
    "description": "A use-after-free vulnerability was found in the virtio-net device of QEMU. It could occur when the descriptor's address belongs to the non direct access region, due to num_buffers being set after the virtqueue elem has been unmapped. A malicious guest could use this flaw to crash QEMU, resulting in a denial of service condition, or potentially execute code on the host with the privileges of the QEMU process.",
    "attack_vector": "LOCAL",
    "attack_complexity": "HIGH"
  },
  "temporal_data": {
    "published_date": "2022-03-23T20:15:09.893",
    "last_modified": "2024-11-21T06:22:19.667",
    "fix_date": "2021-09-02T05:44:12Z"
  },
  "references": [
    {
      "url": "https://bugzilla.redhat.com/show_bug.cgi?id=1998514",
      "source": "secalert@redhat.com",
      "tags": [
        "Issue Tracking",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/qemu/qemu/commit/bedd7e93d01961fcb16a97ae45d93acf357e11f6",
      "source": "secalert@redhat.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2022/04/msg00002.html",
      "source": "secalert@redhat.com",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2022/09/msg00008.html",
      "source": "secalert@redhat.com",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.nongnu.org/archive/html/qemu-devel/2021-09/msg00388.html",
      "source": "secalert@redhat.com",
      "tags": [
        "Mailing List",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://security.gentoo.org/glsa/202208-27",
      "source": "secalert@redhat.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://security.netapp.com/advisory/ntap-20220425-0004/",
      "source": "secalert@redhat.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://ubuntu.com/security/CVE-2021-3748",
      "source": "secalert@redhat.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://bugzilla.redhat.com/show_bug.cgi?id=1998514",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Issue Tracking",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/qemu/qemu/commit/bedd7e93d01961fcb16a97ae45d93acf357e11f6",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2022/04/msg00002.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2022/09/msg00008.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.nongnu.org/archive/html/qemu-devel/2021-09/msg00388.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://security.gentoo.org/glsa/202208-27",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://security.netapp.com/advisory/ntap-20220425-0004/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://ubuntu.com/security/CVE-2021-3748",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:03:02.053784",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "qemu",
    "owner": "qemu",
    "created_at": "2012-08-11T21:48:37Z",
    "updated_at": "2025-01-14T15:30:43Z",
    "pushed_at": "2025-01-13T16:01:34Z",
    "size": 597325,
    "stars": 10728,
    "forks": 5703,
    "open_issues": 0,
    "watchers": 10728,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "C": 72752071,
      "C++": 10865548,
      "Python": 3771166,
      "Shell": 1394621,
      "Assembly": 661208,
      "Meson": 485678,
      "Haxe": 351509,
      "Perl": 223220,
      "Rust": 153760,
      "Objective-C": 153251,
      "Makefile": 107378,
      "Pawn": 50592,
      "SmPL": 33510,
      "Yacc": 29612,
      "Lex": 23760,
      "NSIS": 6939,
      "DenizenScript": 2931,
      "Dockerfile": 1012,
      "GLSL": 585,
      "GDB": 326,
      "Vim Script": 220,
      "Emacs Lisp": 75
    },
    "commit_activity": {
      "total_commits_last_year": 6588,
      "avg_commits_per_week": 126.6923076923077,
      "days_active_last_year": 335
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T15:49:13.645950"
  }
}