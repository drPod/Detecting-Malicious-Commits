{
  "cve_id": "CVE-2021-3758",
  "github_data": {
    "repository": "bookstackapp/bookstack",
    "fix_commit": "bee5e2c7ca637d034c6985c0328cef0ce068778e",
    "related_commits": [
      "bee5e2c7ca637d034c6985c0328cef0ce068778e",
      "bee5e2c7ca637d034c6985c0328cef0ce068778e"
    ],
    "patch_url": "https://github.com/bookstackapp/bookstack/commit/bee5e2c7ca637d034c6985c0328cef0ce068778e.patch",
    "fix_commit_details": {
      "sha": "bee5e2c7ca637d034c6985c0328cef0ce068778e",
      "commit_date": "2021-08-31T19:22:42Z",
      "author": {
        "login": "ssddanbrown",
        "type": "User",
        "stats": {
          "total_commits": 3432,
          "average_weekly_commits": 6.905432595573441,
          "total_additions": 633335,
          "total_deletions": 385989,
          "weeks_active": 420
        }
      },
      "commit_message": {
        "title": "Added untrusted server fetching control",
        "length": 255,
        "has_description": true,
        "references_issue": false
      },
      "stats": {
        "total": 70,
        "additions": 52,
        "deletions": 18
      },
      "files": [
        {
          "filename": ".env.example.complete",
          "status": "modified",
          "additions": 6,
          "deletions": 0,
          "patch": "@@ -281,6 +281,12 @@ ALLOW_CONTENT_SCRIPTS=false\n # Contents of the robots.txt file can be overridden, making this option obsolete.\n ALLOW_ROBOTS=null\n \n+# Allow server-side fetches to be performed to potentially unknown\n+# and user-provided locations. Primarily used in exports when loading\n+# in externally referenced assets.\n+# Can be 'true' or 'false'.\n+ALLOW_UNTRUSTED_SERVER_FETCHING=false\n+\n # A list of hosts that BookStack can be iframed within.\n # Space separated if multiple. BookStack host domain is auto-inferred.\n # For Example: ALLOWED_IFRAME_HOSTS=\"https://example.com https://a.example.com\""
        },
        {
          "filename": "app/Config/app.php",
          "status": "modified",
          "additions": 5,
          "deletions": 0,
          "patch": "@@ -36,6 +36,11 @@\n     // Even when overridden the WYSIWYG editor may still escape script content.\n     'allow_content_scripts' => env('ALLOW_CONTENT_SCRIPTS', false),\n \n+    # Allow server-side fetches to be performed to potentially unknown\n+    # and user-provided locations. Primarily used in exports when loading\n+    # in externally referenced assets.\n+    'allow_untrusted_server_fetching' => env('ALLOW_UNTRUSTED_SERVER_FETCHING', false),\n+\n     // Override the default behaviour for allowing crawlers to crawl the instance.\n     // May be ignored if view has be overridden or modified.\n     // Defaults to null since, if not set, 'app-public' status used instead."
        },
        {
          "filename": "app/Config/dompdf.php",
          "status": "modified",
          "additions": 17,
          "deletions": 17,
          "patch": "@@ -37,7 +37,7 @@\n          * Times-Roman, Times-Bold, Times-BoldItalic, Times-Italic,\n          * Symbol, ZapfDingbats.\n          */\n-        'DOMPDF_FONT_DIR' => storage_path('fonts/'),  // advised by dompdf (https://github.com/dompdf/dompdf/pull/782)\n+        'font_dir' => storage_path('fonts/'),  // advised by dompdf (https://github.com/dompdf/dompdf/pull/782)\n \n         /**\n          * The location of the DOMPDF font cache directory.\n@@ -47,7 +47,7 @@\n          *\n          * Note: This directory must exist and be writable by the webserver process.\n          */\n-        'DOMPDF_FONT_CACHE' => storage_path('fonts/'),\n+        'font_cache' => storage_path('fonts/'),\n \n         /**\n          * The location of a temporary directory.\n@@ -56,7 +56,7 @@\n          * The temporary directory is required to download remote images and when\n          * using the PFDLib back end.\n          */\n-        'DOMPDF_TEMP_DIR' => sys_get_temp_dir(),\n+        'temp_dir' => sys_get_temp_dir(),\n \n         /**\n          * ==== IMPORTANT ====.\n@@ -70,7 +70,7 @@\n          * direct class use like:\n          * $dompdf = new DOMPDF();  $dompdf->load_html($htmldata); $dompdf->render(); $pdfdata = $dompdf->output();\n          */\n-        'DOMPDF_CHROOT' => realpath(base_path()),\n+        'chroot' => realpath(base_path()),\n \n         /**\n          * Whether to use Unicode fonts or not.\n@@ -81,12 +81,12 @@\n          * When enabled, dompdf can support all Unicode glyphs. Any glyphs used in a\n          * document must be present in your fonts, however.\n          */\n-        'DOMPDF_UNICODE_ENABLED' => true,\n+        'unicode_enabled' => true,\n \n         /**\n          * Whether to enable font subsetting or not.\n          */\n-        'DOMPDF_ENABLE_FONTSUBSETTING' => false,\n+        'enable_fontsubsetting' => false,\n \n         /**\n          * The PDF rendering backend to use.\n@@ -115,7 +115,7 @@\n          * @link http://www.ros.co.nz/pdf\n          * @link http://www.php.net/image\n          */\n-        'DOMPDF_PDF_BACKEND' => 'CPDF',\n+        'pdf_backend' => 'CPDF',\n \n         /**\n          * PDFlib license key.\n@@ -141,7 +141,7 @@\n          * the desired content might be different (e.g. screen or projection view of html file).\n          * Therefore allow specification of content here.\n          */\n-        'DOMPDF_DEFAULT_MEDIA_TYPE' => 'print',\n+        'default_media_type' => 'print',\n \n         /**\n          * The default paper size.\n@@ -150,7 +150,7 @@\n          *\n          * @see CPDF_Adapter::PAPER_SIZES for valid sizes ('letter', 'legal', 'A4', etc.)\n          */\n-        'DOMPDF_DEFAULT_PAPER_SIZE' => 'a4',\n+        'default_paper_size' => 'a4',\n \n         /**\n          * The default font family.\n@@ -159,7 +159,7 @@\n          *\n          * @var string\n          */\n-        'DOMPDF_DEFAULT_FONT' => 'dejavu sans',\n+        'default_font' => 'dejavu sans',\n \n         /**\n          * Image DPI setting.\n@@ -194,7 +194,7 @@\n          *\n          * @var int\n          */\n-        'DOMPDF_DPI' => 96,\n+        'dpi' => 96,\n \n         /**\n          * Enable inline PHP.\n@@ -208,7 +208,7 @@\n          *\n          * @var bool\n          */\n-        'DOMPDF_ENABLE_PHP' => false,\n+        'enable_php' => false,\n \n         /**\n          * Enable inline Javascript.\n@@ -218,7 +218,7 @@\n          *\n          * @var bool\n          */\n-        'DOMPDF_ENABLE_JAVASCRIPT' => false,\n+        'enable_javascript' => false,\n \n         /**\n          * Enable remote file access.\n@@ -237,12 +237,12 @@\n          *\n          * @var bool\n          */\n-        'DOMPDF_ENABLE_REMOTE' => true,\n+        'enable_remote' => env('ALLOW_UNTRUSTED_SERVER_FETCHING', false),\n \n         /**\n          * A ratio applied to the fonts height to be more like browsers' line height.\n          */\n-        'DOMPDF_FONT_HEIGHT_RATIO' => 1.1,\n+        'font_height_ratio' => 1.1,\n \n         /**\n          * Enable CSS float.\n@@ -251,12 +251,12 @@\n          *\n          * @var bool\n          */\n-        'DOMPDF_ENABLE_CSS_FLOAT' => true,\n+        'enable_css_float' => true,\n \n         /**\n          * Use the more-than-experimental HTML5 Lib parser.\n          */\n-        'DOMPDF_ENABLE_HTML5PARSER' => true,\n+        'enable_html5parser' => true,\n \n     ],\n "
        },
        {
          "filename": "app/Entities/Tools/ExportFormatter.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -140,7 +140,7 @@ public function bookToPdf(Book $book)\n     protected function htmlToPdf(string $html): string\n     {\n         $containedHtml = $this->containHtml($html);\n-        $useWKHTML = config('snappy.pdf.binary') !== false;\n+        $useWKHTML = config('snappy.pdf.binary') !== false && config('app.allow_untrusted_server_fetching') === true;\n         if ($useWKHTML) {\n             $pdf = SnappyPDF::loadHTML($containedHtml);\n             $pdf->setOption('print-media-type', true);"
        },
        {
          "filename": "phpunit.xml",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -37,6 +37,7 @@\n     <server name=\"LOG_CHANNEL\" value=\"single\"/>\n     <server name=\"AUTH_METHOD\" value=\"standard\"/>\n     <server name=\"DISABLE_EXTERNAL_SERVICES\" value=\"true\"/>\n+    <server name=\"ALLOW_UNTRUSTED_SERVER_FETCHING\" value=\"false\"/>\n     <server name=\"AVATAR_URL\" value=\"\"/>\n     <server name=\"LDAP_START_TLS\" value=\"false\"/>\n     <server name=\"LDAP_VERSION\" value=\"3\"/>"
        },
        {
          "filename": "tests/Entity/ExportTest.php",
          "status": "modified",
          "additions": 16,
          "deletions": 0,
          "patch": "@@ -366,4 +366,20 @@ public function test_export_option_only_visible_and_accessible_with_permission()\n             $this->assertPermissionError($resp);\n         }\n     }\n+\n+    public function test_wkhtmltopdf_only_used_when_allow_untrusted_is_true()\n+    {\n+        /** @var Page $page */\n+        $page = Page::query()->first();\n+\n+        config()->set('snappy.pdf.binary', '/abc123');\n+        config()->set('app.allow_untrusted_server_fetching', false);\n+\n+        $resp = $this->asEditor()->get($page->getUrl('/export/pdf'));\n+        $resp->assertStatus(200); // Sucessful response with invalid snappy binary indicates dompdf usage.\n+\n+        config()->set('app.allow_untrusted_server_fetching', true);\n+        $resp = $this->get($page->getUrl('/export/pdf'));\n+        $resp->assertStatus(500); // Bad response indicates wkhtml usage\n+    }\n }"
        },
        {
          "filename": "tests/Unit/ConfigTest.php",
          "status": "modified",
          "additions": 6,
          "deletions": 0,
          "patch": "@@ -76,6 +76,12 @@ public function test_saml2_idp_authn_context_string_parsed_as_space_separated_ar\n         );\n     }\n \n+    public function test_dompdf_remote_fetching_controlled_by_allow_untrusted_server_fetching_false()\n+    {\n+        $this->checkEnvConfigResult('ALLOW_UNTRUSTED_SERVER_FETCHING', 'false', 'dompdf.defines.enable_remote', false);\n+        $this->checkEnvConfigResult('ALLOW_UNTRUSTED_SERVER_FETCHING', 'true', 'dompdf.defines.enable_remote', true);\n+    }\n+\n     /**\n      * Set an environment variable of the given name and value\n      * then check the given config key to see if it matches the given result."
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 4,
        "dependency_files": 0,
        "test_files": 2,
        "unique_directories": 5,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "786a434c03faa996e630f4a0a523567d3b093f43",
            "date": "2025-01-14T14:56:43Z",
            "author_login": "ssddanbrown"
          },
          {
            "sha": "25c4f4b02ba06f66f5239de48ae005f895146f8d",
            "date": "2025-01-14T14:53:10Z",
            "author_login": "ssddanbrown"
          },
          {
            "sha": "481580be172a4813ee98ad1b945d12d731e71cdb",
            "date": "2025-01-13T16:51:07Z",
            "author_login": "ssddanbrown"
          },
          {
            "sha": "593645acfe8521db97d7469c92546c8529703969",
            "date": "2025-01-13T14:30:53Z",
            "author_login": "ssddanbrown"
          },
          {
            "sha": "b9751807e7bad4b7d477b6977f630881f730abad",
            "date": "2025-01-13T13:27:32Z",
            "author_login": "ssddanbrown"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.5,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:H/A:N",
    "cwe_id": "CWE-918",
    "description": "bookstack is vulnerable to Server-Side Request Forgery (SSRF)",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2021-09-02T12:15:07.693",
    "last_modified": "2024-11-21T06:22:21.250",
    "fix_date": "2021-08-31T19:22:42Z"
  },
  "references": [
    {
      "url": "https://github.com/bookstackapp/bookstack/commit/bee5e2c7ca637d034c6985c0328cef0ce068778e",
      "source": "security@huntr.dev",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/a8d7fb24-9a69-42f3-990a-2db93b53f76b",
      "source": "security@huntr.dev",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/bookstackapp/bookstack/commit/bee5e2c7ca637d034c6985c0328cef0ce068778e",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/a8d7fb24-9a69-42f3-990a-2db93b53f76b",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:05.129726",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "BookStack",
    "owner": "bookstackapp",
    "created_at": "2015-08-29T10:26:44Z",
    "updated_at": "2025-01-14T12:14:34Z",
    "pushed_at": "2025-01-13T20:16:47Z",
    "size": 41179,
    "stars": 15786,
    "forks": 1978,
    "open_issues": 598,
    "watchers": 15786,
    "has_security_policy": false,
    "default_branch": "development",
    "protected_branches": [
      "release"
    ],
    "languages": {
      "PHP": 7963438,
      "TypeScript": 1856418,
      "Blade": 444101,
      "JavaScript": 287858,
      "SCSS": 139395,
      "Dockerfile": 1282,
      "Shell": 347
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-14T13:05:28.288711"
  }
}