{
  "cve_id": "CVE-2021-37596",
  "github_data": {
    "repository": "morethanwords/tweb",
    "fix_commit": "11d2fe01363889f20c8baa2217ed4aad445c5551",
    "related_commits": [
      "11d2fe01363889f20c8baa2217ed4aad445c5551",
      "11d2fe01363889f20c8baa2217ed4aad445c5551"
    ],
    "patch_url": "https://github.com/morethanwords/tweb/commit/11d2fe01363889f20c8baa2217ed4aad445c5551.patch",
    "fix_commit_details": {
      "sha": "11d2fe01363889f20c8baa2217ed4aad445c5551",
      "commit_date": "2021-07-20T16:11:58Z",
      "author": {
        "login": "morethanwords",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Fix document name XSS",
        "length": 21,
        "has_description": false,
        "references_issue": true
      },
      "stats": {
        "total": 405,
        "additions": 275,
        "deletions": 130
      },
      "files": [
        {
          "filename": "src/components/appSearchSuper..ts",
          "status": "modified",
          "additions": 1,
          "deletions": 2,
          "patch": "@@ -868,8 +868,7 @@ export default class AppSearchSuper {\n       }\n       \n       if(!this.membersList) {\n-        this.membersList = new SortedUserList();\n-        this.membersList.lazyLoadQueue = this.lazyLoadQueue;\n+        this.membersList = new SortedUserList({lazyLoadQueue: this.lazyLoadQueue, rippleEnabled: false});\n         this.membersList.list.addEventListener('click', (e) => {\n           const li = findUpTag(e.target, 'LI');\n           if(!li) {"
        },
        {
          "filename": "src/components/audio.ts",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -272,7 +272,7 @@ function wrapAudio(audioEl: AudioElement) {\n \n   const senderTitle = audioEl.showSender ? appMessagesManager.getSenderToPeerText(message) : '';\n \n-  let title = doc.type === 'voice' ? senderTitle : (doc.audioTitle || doc.file_name);\n+  let title = doc.type === 'voice' ? senderTitle : (doc.audioTitle || doc.fileName);\n   let subtitle: string;\n   \n   if(doc.type === 'voice') {"
        },
        {
          "filename": "src/components/chat/audio.ts",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -56,7 +56,7 @@ export default class ChatAudio extends PinnedContainer {\n         //subtitle = 'Voice message';\n         subtitle = formatDate(message.date, false, false);\n       } else {\n-        title = doc.audioTitle || doc.file_name;\n+        title = doc.audioTitle || doc.fileName;\n         subtitle = doc.audioPerformer ? RichTextProcessor.wrapPlainText(doc.audioPerformer) : 'Unknown Artist';\n       }\n "
        },
        {
          "filename": "src/components/popups/newMedia.ts",
          "status": "modified",
          "additions": 2,
          "deletions": 0,
          "patch": "@@ -20,6 +20,7 @@ import calcImageInBox from \"../../helpers/calcImageInBox\";\n import isSendShortcutPressed from \"../../helpers/dom/isSendShortcutPressed\";\n import placeCaretAtEnd from \"../../helpers/dom/placeCaretAtEnd\";\n import rootScope from \"../../lib/rootScope\";\n+import RichTextProcessor from \"../../lib/richtextprocessor\";\n \n type SendFileParams = Partial<{\n   file: File,\n@@ -298,6 +299,7 @@ export default class PopupNewMedia extends PopupElement {\n             _: 'document',\n             file: file,\n             file_name: file.name || '',\n+            fileName: file.name ? RichTextProcessor.wrapEmojiText(file.name) : '',\n             size: file.size,\n             type: isPhoto ? 'photo' : 'doc'\n           } as MyDocument;"
        },
        {
          "filename": "src/components/sidebarLeft/index.ts",
          "status": "modified",
          "additions": 12,
          "deletions": 2,
          "patch": "@@ -575,12 +575,16 @@ export class SettingSection {\n   constructor(options: {\n     name?: LangPackKey, \n     caption?: LangPackKey | true,\n-    noDelimiter?: boolean\n+    noDelimiter?: boolean,\n+    fakeGradientDelimiter?: boolean\n   }) {\n     this.container = document.createElement('div');\n     this.container.classList.add('sidebar-left-section');\n \n-    if(!options.noDelimiter) {\n+    if(options.fakeGradientDelimiter) {\n+      this.container.append(generateDelimiter());\n+      this.container.classList.add('with-fake-delimiter');\n+    } else if(!options.noDelimiter) {\n       const hr = document.createElement('hr');\n       this.container.append(hr);\n     } else {\n@@ -620,6 +624,12 @@ export const generateSection = (appendTo: Scrollable, name?: LangPackKey, captio\n   return section.content;\n };\n \n+export const generateDelimiter = () => {\n+  const delimiter = document.createElement('div');\n+  delimiter.classList.add('gradient-delimiter');\n+  return delimiter;\n+};\n+\n const appSidebarLeft = new AppSidebarLeft();\n MOUNT_CLASS_TO.appSidebarLeft = appSidebarLeft;\n export default appSidebarLeft;"
        },
        {
          "filename": "src/components/sidebarLeft/tabs/archivedTab.ts",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -17,7 +17,7 @@ export default class AppArchivedTab extends SliderSuperTab {\n \n     if(!appDialogsManager.chatLists[AppArchivedTab.filterId]) {\n       const chatList = appDialogsManager.createChatList();\n-      appDialogsManager.generateScrollable(chatList, AppArchivedTab.filterId);\n+      appDialogsManager.generateScrollable(chatList, AppArchivedTab.filterId).container.append(chatList);\n       appDialogsManager.setListClickListener(chatList, null, true);\n       //appDialogsManager.setListClickListener(archivedChatList, null, true); // * to test peer changing\n     }"
        },
        {
          "filename": "src/components/sidebarLeft/tabs/contacts.ts",
          "status": "modified",
          "additions": 10,
          "deletions": 27,
          "patch": "@@ -8,7 +8,6 @@ import { SliderSuperTab } from \"../../slider\";\n import appDialogsManager from \"../../../lib/appManagers/appDialogsManager\";\n import appUsersManager from \"../../../lib/appManagers/appUsersManager\";\n import appPhotosManager from \"../../../lib/appManagers/appPhotosManager\";\n-import rootScope from \"../../../lib/rootScope\";\n import InputSearch from \"../../inputSearch\";\n import { isMobile } from \"../../../helpers/userAgent\";\n import { canFocus } from \"../../../helpers/dom/canFocus\";\n@@ -67,50 +66,34 @@ export default class AppContactsTab extends SliderSuperTab {\n     if(this.promise) return this.promise;\n     this.scrollable.onScrolledBottom = null;\n \n-    this.promise = appUsersManager.getContacts(query).then(_contacts => {\n+    this.promise = appUsersManager.getContacts(query, undefined, 'online').then(contacts => {\n       this.promise = null;\n \n       if(!this.alive) {\n         //console.warn('user closed contacts before it\\'s loaded');\n         return;\n       }\n \n-      const contacts = [..._contacts];\n-\n-      if(!query) {\n-        contacts.findAndSplice(u => u === rootScope.myId);\n-      }\n-      /* if(query && 'saved messages'.includes(query.toLowerCase())) {\n-        contacts.unshift(rootScope.myID);\n-      } */\n-\n-      let sorted = contacts\n-      .map(userId => {\n-        let user = appUsersManager.getUser(userId);\n-        let status = appUsersManager.getUserStatusForSort(user.status);\n-\n-        return {user, status};\n-      })\n-      .sort((a, b) => b.status - a.status);\n-\n       let renderPage = () => {\n-        let pageCount = appPhotosManager.windowH / 72 * 1.25 | 0;\n-        let arr = sorted.splice(0, pageCount); // \u043d\u0430\u0434\u043e splice!\n+        const pageCount = appPhotosManager.windowH / 72 * 1.25 | 0;\n+        const arr = contacts.splice(0, pageCount); // \u043d\u0430\u0434\u043e splice!\n \n-        arr.forEach(({user}) => {\n-          let {dialog, dom} = appDialogsManager.addDialogNew({\n-            dialog: user.id,\n+        arr.forEach((peerId) => {\n+          const {dom} = appDialogsManager.addDialogNew({\n+            dialog: peerId,\n             container: this.list,\n             drawStatus: false,\n             avatarSize: 48,\n             autonomous: true\n           });\n   \n-          let status = appUsersManager.getUserStatusString(user.id);\n+          const status = appUsersManager.getUserStatusString(peerId);\n           dom.lastMessageSpan.append(status);\n         });\n \n-        if(!sorted.length) renderPage = undefined;\n+        if(!contacts.length) {\n+          renderPage = undefined;\n+        }\n       };\n \n       renderPage();"
        },
        {
          "filename": "src/components/sidebarRight/tabs/groupPermissions.ts",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -201,7 +201,7 @@ export default class AppGroupPermissionsTab extends SliderSuperTabEventable {\n       const c = section.generateContentElement();\n       c.classList.add('chatlist-container');\n       \n-      const list = appDialogsManager.createChatList();\n+      const list = appDialogsManager.createChatList({new: true});\n       c.append(list);\n \n       attachClickEvent(list, (e) => {"
        },
        {
          "filename": "src/components/sidebarRight/tabs/sharedMedia.ts",
          "status": "modified",
          "additions": 2,
          "deletions": 5,
          "patch": "@@ -26,7 +26,7 @@ import { Chat, Message, MessageAction, ChatFull, Photo } from \"../../../layer\";\n import Button from \"../../button\";\n import ButtonIcon from \"../../buttonIcon\";\n import I18n, { i18n, LangPackKey } from \"../../../lib/langPack\";\n-import { SettingSection } from \"../../sidebarLeft\";\n+import { generateDelimiter, SettingSection } from \"../../sidebarLeft\";\n import Row from \"../../row\";\n import { copyTextToClipboard } from \"../../../helpers/clipboard\";\n import { toast, toastNew } from \"../../toast\";\n@@ -572,10 +572,7 @@ class PeerProfile {\n     \n     this.section.content.append(this.phone.container, this.username.container, this.bio.container, this.notifications.container);\n \n-    const delimiter = document.createElement('div');\n-    delimiter.classList.add('gradient-delimiter');\n-\n-    this.element.append(this.section.container, delimiter);\n+    this.element.append(this.section.container, generateDelimiter());\n \n     this.notifications.checkboxField.input.addEventListener('change', (e) => {\n       if(!e.isTrusted) {"
        },
        {
          "filename": "src/components/sidebarRight/tabs/userPermissions.ts",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -36,7 +36,7 @@ export default class AppUserPermissionsTab extends SliderSuperTabEventable {\n       div.classList.add('chatlist-container');\n       section.content.insertBefore(div, section.title);\n \n-      const list = appDialogsManager.createChatList();\n+      const list = appDialogsManager.createChatList({new: true});\n       div.append(list);\n \n       const {dom} = appDialogsManager.addDialogNew({"
        },
        {
          "filename": "src/components/sortedUserList.ts",
          "status": "modified",
          "additions": 19,
          "deletions": 8,
          "patch": "@@ -12,21 +12,32 @@ import { insertInDescendSortedArray } from \"../helpers/array\";\n import isInDOM from \"../helpers/dom/isInDOM\";\n import positionElementByIndex from \"../helpers/dom/positionElementByIndex\";\n import replaceContent from \"../helpers/dom/replaceContent\";\n+import { safeAssign } from \"../helpers/object\";\n \n type SortedUser = {\n   peerId: number, \n   status: number, \n   dom: DialogDom\n };\n export default class SortedUserList {\n-  public static SORT_INTERVAL = 30e3;\n+  protected static SORT_INTERVAL = 30e3;\n+  protected users: Map<number, SortedUser>;\n+  protected sorted: Array<SortedUser>;\n   public list: HTMLUListElement;\n-  public users: Map<number, SortedUser>;\n-  public sorted: Array<SortedUser>;\n-  public lazyLoadQueue: LazyLoadQueueIntersector;\n+  \n+  protected lazyLoadQueue: LazyLoadQueueIntersector;\n+  protected avatarSize = 48;\n+  protected rippleEnabled = true;\n \n-  constructor() {\n-    this.list = appDialogsManager.createChatList();\n+  constructor(options: Partial<{\n+    lazyLoadQueue: SortedUserList['lazyLoadQueue'],\n+    avatarSize: SortedUserList['avatarSize'],\n+    rippleEnabled: SortedUserList['rippleEnabled'],\n+    new: boolean\n+  }> = {}) {\n+    safeAssign(this, options);\n+\n+    this.list = appDialogsManager.createChatList({new: options.new});\n \n     this.users = new Map();\n     this.sorted = [];\n@@ -76,10 +87,10 @@ export default class SortedUserList {\n       dialog: peerId,\n       container: false,\n       drawStatus: false,\n-      avatarSize: 48,\n+      avatarSize: this.avatarSize,\n       autonomous: true,\n       meAsSaved: false,\n-      rippleEnabled: false,\n+      rippleEnabled: this.rippleEnabled,\n       lazyLoadQueue: this.lazyLoadQueue\n     });\n "
        },
        {
          "filename": "src/components/wrappers.ts",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -507,7 +507,7 @@ export function wrapDocument({message, withTime, fontWeight, voiceAsMusic, showS\n   }\n \n   //let fileName = stringMiddleOverflow(doc.file_name || 'Unknown.file', 26);\n-  let fileName = doc.file_name || 'Unknown.file';\n+  let fileName = doc.fileName || 'Unknown.file';\n   let size = formatBytes(doc.size);\n   \n   if(withTime) {"
        },
        {
          "filename": "src/layer.d.ts",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -3133,6 +3133,7 @@ export namespace Document {\n \t\th?: number,\n \t\tw?: number,\n \t\tfile_name?: string,\n+\t\tfileName?: string,\n \t\tfile?: File,\n \t\tduration?: number,\n \t\taudioTitle?: string,"
        },
        {
          "filename": "src/lib/appManagers/appDialogsManager.ts",
          "status": "modified",
          "additions": 96,
          "deletions": 16,
          "patch": "@@ -35,14 +35,16 @@ import { LazyLoadQueueIntersector } from \"../../components/lazyLoadQueue\";\n import lottieLoader from \"../lottieLoader\";\n import { wrapLocalSticker } from \"../../components/wrappers\";\n import AppEditFolderTab from \"../../components/sidebarLeft/tabs/editFolder\";\n-import appSidebarLeft from \"../../components/sidebarLeft\";\n+import appSidebarLeft, { SettingSection } from \"../../components/sidebarLeft\";\n import { attachClickEvent } from \"../../helpers/dom/clickEvent\";\n import positionElementByIndex from \"../../helpers/dom/positionElementByIndex\";\n import replaceContent from \"../../helpers/dom/replaceContent\";\n import ConnectionStatusComponent from \"../../components/connectionStatus\";\n import appChatsManager from \"./appChatsManager\";\n import { renderImageFromUrlPromise } from \"../../helpers/dom/renderImageFromUrl\";\n import { fastRafPromise } from \"../../helpers/schedulers\";\n+import appPhotosManager from \"./appPhotosManager\";\n+import SortedUserList from \"../../components/sortedUserList\";\n \n export type DialogDom = {\n   avatarEl: AvatarElement,\n@@ -106,6 +108,7 @@ export class AppDialogsManager {\n   private lastActiveElements: Set<HTMLElement> = new Set();\n \n   private offsets: {top: number, bottom: number} = {top: 0, bottom: 0};\n+  loadContacts: () => void;\n \n   constructor() {\n     this.chatsPreloader = putPreloader(null, true);\n@@ -436,7 +439,7 @@ export class AppDialogsManager {\n       appDraftsManager.addMissedDialogs();\n     }\n \n-    return this.loadDialogs();\n+    return this.onChatsScroll();\n   }\n \n   /* private getOffset(side: 'top' | 'bottom'): {index: number, pos: number} {\n@@ -533,7 +536,7 @@ export class AppDialogsManager {\n     this.offsets.top = this.offsets.bottom = 0;\n     this.loadDialogsPromise = undefined;\n     this.chatList = this.chatLists[this.filterId];\n-    this.loadDialogs();\n+    this.onChatsScroll();\n   };\n \n   private setFilterUnreadCount(filterId: number, folder?: Dialog[]) {\n@@ -593,7 +596,6 @@ export class AppDialogsManager {\n     const scrollable = new Scrollable(null, 'CL', 500);\n     scrollable.container.addEventListener('scroll', this.onChatsRegularScroll);\n     scrollable.container.dataset.filterId = '' + filterId;\n-    scrollable.container.append(list);\n     scrollable.onScrolledTop = this.onChatsScrollTop;\n     scrollable.onScrolledBottom = this.onChatsScroll;\n     scrollable.setVirtualContainer(list);\n@@ -627,6 +629,23 @@ export class AppDialogsManager {\n \n     const ul = this.createChatList();\n     const scrollable = this.generateScrollable(ul, filter.id);\n+\n+    scrollable.container.classList.add('chatlist-parts');\n+\n+    /* const parts = document.createElement('div');\n+    parts.classList.add('chatlist-parts'); */\n+    \n+    const top = document.createElement('div');\n+    top.classList.add('chatlist-top');\n+    \n+    const bottom = document.createElement('div');\n+    bottom.classList.add('chatlist-bottom');\n+\n+    top.append(ul);\n+    scrollable.container.append(top, bottom);\n+    /* parts.append(top, bottom);\n+    scrollable.container.append(parts); */\n+    \n     const div = scrollable.container;\n     //this.folders.container.append(div);\n     positionElementByIndex(scrollable.container, this.folders.container, filter.orderIndex);\n@@ -654,7 +673,7 @@ export class AppDialogsManager {\n     }\n   }\n \n-  private loadDialogs(side: SliceSides = 'bottom') {\n+  private loadDialogs(side: SliceSides) {\n     /* if(testScroll) {\n       return;\n     } */\n@@ -779,20 +798,21 @@ export class AppDialogsManager {\n     return {container, header, subtitle};\n   }\n \n-  private onListLengthChange = () => {\n-    //return;\n+  private checkIfPlaceholderNeeded() {\n     if(this.filterId === 1) {\n       return;\n     }\n \n-    let placeholderContainer = (Array.from(this.chatList.parentElement.children) as HTMLElement[]).find(el => el.matches('.empty-placeholder'));\n+    const part = this.chatList.parentElement as HTMLElement;\n+    let placeholderContainer = (Array.from(part.children) as HTMLElement[]).find(el => el.matches('.empty-placeholder'));\n     const needPlaceholder = this.scroll.loadedAll.bottom && !this.chatList.childElementCount/*  || true */;\n     // this.chatList.style.display = 'none';\n \n     if(needPlaceholder && placeholderContainer) {\n       return;\n     } else if(!needPlaceholder) {\n       if(placeholderContainer) {\n+        part.classList.remove('with-placeholder');\n         placeholderContainer.remove();\n       }\n \n@@ -863,7 +883,55 @@ export class AppDialogsManager {\n       placeholderContainer.append(button);\n     }\n \n-    this.chatList.parentElement.append(placeholderContainer);\n+    part.append(placeholderContainer);\n+    part.classList.add('with-placeholder');\n+  }\n+\n+  private onListLengthChange = () => {\n+    return;\n+\n+    this.checkIfPlaceholderNeeded();\n+\n+    if(this.filterId > 0) return;\n+    const bottom = this.chatList.parentElement.nextElementSibling as HTMLElement;\n+\n+    if(bottom.childElementCount) return;\n+\n+    bottom.parentElement.classList.add('with-contacts');\n+\n+    const section = new SettingSection({\n+      name: 'Contacts',\n+      noDelimiter: true,\n+      fakeGradientDelimiter: true\n+    });\n+\n+    section.container.classList.add('hide');\n+\n+    appUsersManager.getContacts(undefined, undefined, 'online').then(contacts => {\n+      const sortedUserList = new SortedUserList({avatarSize: 42, new: true});\n+      this.loadContacts = () => {\n+        const pageCount = appPhotosManager.windowH / 60 | 0;\n+        const arr = contacts.splice(0, pageCount);\n+\n+        arr.forEach((peerId) => {\n+          sortedUserList.add(peerId);\n+        });\n+\n+        if(!contacts.length) {\n+          this.loadContacts = undefined;\n+        }\n+      };\n+\n+      this.loadContacts();\n+\n+      const list = sortedUserList.list;\n+      list.classList.add('chatlist-new');\n+      this.setListClickListener(list);\n+      section.content.append(list);\n+      section.container.classList.remove('hide');\n+    });\n+\n+    bottom.append(section.container);\n   };\n \n   public onChatsRegularScroll = () => {\n@@ -987,9 +1055,16 @@ export class AppDialogsManager {\n   };\n   \n   public onChatsScroll = (side: SliceSides = 'bottom') => {\n-    if(this.scroll.loadedAll[side] || this.loadDialogsPromise) return;\n+    if(this.scroll.loadedAll[side]) {\n+      if(this.loadContacts) {\n+        this.loadContacts();\n+      }\n+\n+      return;\n+    } else if(this.loadDialogsPromise) return this.loadDialogsPromise;\n+\n     this.log('onChatsScroll', side);\n-    this.loadDialogs(side);\n+    return this.loadDialogs(side);\n   };\n \n   public setListClickListener(list: HTMLUListElement, onFound?: () => void, withContext = false, autonomous = false, openInner = false) {\n@@ -1050,15 +1125,20 @@ export class AppDialogsManager {\n     }\n   }\n \n-  public createChatList(/* options: {\n-    avatarSize?: number,\n-    handheldsSize?: number,\n-    //size?: number,\n-  } = {} */) {\n+  public createChatList(options: {\n+    // avatarSize?: number,\n+    // handheldsSize?: number,\n+    // size?: number,\n+    new?: boolean\n+  } = {}) {\n     const list = document.createElement('ul');\n     list.classList.add('chatlist'/* , \n       'chatlist-avatar-' + (options.avatarSize || 54) *//* , 'chatlist-' + (options.size || 72) */);\n \n+    if(options.new) {\n+      list.classList.add('chatlist-new');\n+    }\n+\n     /* if(options.handheldsSize) {\n       list.classList.add('chatlist-handhelds-' + options.handheldsSize);\n     } */"
        },
        {
          "filename": "src/lib/appManagers/appDocsManager.ts",
          "status": "modified",
          "additions": 5,
          "deletions": 4,
          "patch": "@@ -93,12 +93,13 @@ export class AppDocsManager {\n       switch(attribute._) {\n         case 'documentAttributeFilename':\n           doc.file_name = RichTextProcessor.wrapPlainText(attribute.file_name);\n+          doc.fileName = RichTextProcessor.wrapEmojiText(attribute.file_name);\n           break;\n \n         case 'documentAttributeAudio':\n           doc.duration = attribute.duration;\n-          doc.audioTitle = attribute.title;\n-          doc.audioPerformer = attribute.performer;\n+          doc.audioTitle = RichTextProcessor.wrapEmojiText(attribute.title);\n+          doc.audioPerformer = RichTextProcessor.wrapEmojiText(attribute.performer);\n           doc.type = attribute.pFlags.voice && doc.mime_type === 'audio/ogg' ? 'voice' : 'audio';\n           /* if(apiDoc.type === 'audio') {\n             apiDoc.supportsStreaming = true;\n@@ -182,7 +183,7 @@ export class AppDocsManager {\n \n     if(doc.type === 'voice' || doc.type === 'round') {\n       // browser will identify extension\n-      doc.file_name = doc.type + '_' + getFullDate(new Date(doc.date * 1000), {monthAsNumber: true, leadingZero: true}).replace(/[:\\.]/g, '-').replace(', ', '_');\n+      doc.file_name = doc.fileName = doc.type + '_' + getFullDate(new Date(doc.date * 1000), {monthAsNumber: true, leadingZero: true}).replace(/[:\\.]/g, '-').replace(', ', '_');\n     }\n \n     if(apiManager.isServiceWorkerOnline()) {\n@@ -201,7 +202,7 @@ export class AppDocsManager {\n     // doc.url = ''; // * this will break upload urls\n     \n     if(!doc.file_name) {\n-      doc.file_name = '';\n+      doc.file_name = doc.fileName = '';\n     }\n \n     if(doc.mime_type === 'application/x-tgsticker' && doc.file_name === 'AnimatedSticker.tgs') {"
        },
        {
          "filename": "src/lib/appManagers/appMessagesManager.ts",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -2626,7 +2626,7 @@ export class AppMessagesManager {\n               addPart(undefined, ((plain ? document.stickerEmojiRaw : document.stickerEmoji) || '') + 'Sticker');\n               text = '';\n             } else {\n-              addPart(document.file_name, undefined, message.message);\n+              addPart(undefined, plain ? document.file_name : RichTextProcessor.wrapEmojiText(document.file_name), message.message);\n             }\n   \n             break;"
        },
        {
          "filename": "src/lib/appManagers/appUsersManager.ts",
          "status": "modified",
          "additions": 15,
          "deletions": 18,
          "patch": "@@ -261,7 +261,7 @@ export class AppUsersManager {\n     return arr.filter(Boolean).join(' ');\n   }\n \n-  public getContacts(query?: string, includeSaved = false) {\n+  public getContacts(query?: string, includeSaved = false, sortBy: 'name' | 'online' | 'none' = 'name') {\n     return this.fillContacts().then(_contactsList => {\n       let contactsList = [..._contactsList];\n       if(query) {\n@@ -271,30 +271,27 @@ export class AppUsersManager {\n         contactsList = filteredContactsList;\n       }\n \n-      contactsList.sort((userId1: number, userId2: number) => {\n-        const sortName1 = (this.users[userId1] || {}).sortName || '';\n-        const sortName2 = (this.users[userId2] || {}).sortName || '';\n-\n-        return sortName1.localeCompare(sortName2);\n-      });\n+      if(sortBy === 'name') {\n+        contactsList.sort((userId1, userId2) => {\n+          const sortName1 = (this.users[userId1] || {}).sortName || '';\n+          const sortName2 = (this.users[userId2] || {}).sortName || '';\n+          return sortName1.localeCompare(sortName2);\n+        });\n+      } else if(sortBy === 'online') {\n+        contactsList.sort((userId1, userId2) => {\n+          const status1 = appUsersManager.getUserStatusForSort(appUsersManager.getUser(userId1).status);\n+          const status2 = appUsersManager.getUserStatusForSort(appUsersManager.getUser(userId2).status);\n+          return status2 - status1;\n+        });\n+      }\n \n+      contactsList.findAndSplice(p => p === rootScope.myId);\n       if(includeSaved) {\n         if(this.testSelfSearch(query)) {\n-          contactsList.findAndSplice(p => p === rootScope.myId);\n           contactsList.unshift(rootScope.myId);\n         }\n       }\n \n-      /* contactsList.sort((userId1: number, userId2: number) => {\n-        const sortName1 = (this.users[userId1] || {}).sortName || '';\n-        const sortName2 = (this.users[userId2] || {}).sortName || '';\n-        if(sortName1 === sortName2) {\n-          return 0;\n-        } \n-        \n-        return sortName1 > sortName2 ? 1 : -1;\n-      }); */\n-\n       return contactsList;\n     });\n   }"
        },
        {
          "filename": "src/lib/richtextprocessor.ts",
          "status": "modified",
          "additions": 10,
          "deletions": 10,
          "patch": "@@ -748,7 +748,7 @@ namespace RichTextProcessor {\n     });\n   }\n   \n-  export function wrapPlainText(text: any) {\n+  export function wrapPlainText(text: string) {\n     if(emojiSupported) {\n       return text;\n     }\n@@ -757,32 +757,32 @@ namespace RichTextProcessor {\n       return '';\n     }\n   \n-    text = text.replace(/\\ufe0f/g, '', text);\n+    text = text.replace(/\\ufe0f/g, '');\n     var match;\n     var raw = text;\n-    var text: any = [],\n-      emojiTitle;\n+    const arr: string[] = [];\n+    let emojiTitle;\n     fullRegExp.lastIndex = 0;\n     while((match = raw.match(fullRegExp))) {\n-      text.push(raw.substr(0, match.index))\n+      arr.push(raw.substr(0, match.index))\n       if(match[8]) {\n         // @ts-ignore\n         const emojiCode = EmojiHelper.emojiMap[match[8]];\n         if(emojiCode &&\n         // @ts-ignore\n           (emojiTitle = emojiData[emojiCode][1][0])) {\n-          text.push(':' + emojiTitle + ':');\n+          arr.push(':' + emojiTitle + ':');\n         } else {\n-          text.push(match[0]);\n+          arr.push(match[0]);\n         }\n       } else {\n-        text.push(match[0]);\n+        arr.push(match[0]);\n       }\n   \n       raw = raw.substr(match.index + match[0].length);\n     }\n-    text.push(raw);\n-    return text.join('');\n+    arr.push(raw);\n+    return arr.join('');\n   }\n \n   export function wrapEmojiText(text: string) {"
        },
        {
          "filename": "src/scripts/in/schema_additional_params.json",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -6,6 +6,7 @@\n     {\"name\": \"h\", \"type\": \"number\"},\n     {\"name\": \"w\", \"type\": \"number\"},\n     {\"name\": \"file_name\", \"type\": \"string\"},\n+    {\"name\": \"fileName\", \"type\": \"string\"},\n     {\"name\": \"file\", \"type\": \"File\"},\n     {\"name\": \"duration\", \"type\": \"number\"},\n     {\"name\": \"audioTitle\", \"type\": \"string\"},"
        },
        {
          "filename": "src/scss/partials/_chatlist.scss",
          "status": "modified",
          "additions": 83,
          "deletions": 0,
          "patch": "@@ -399,6 +399,89 @@ ul.chatlist {\n   li.is-muted .unread {\n     background-color: var(--secondary-color);\n   }\n+\n+  &-parts {\n+    /* width: 100%;\n+    min-height: 100%;\n+    display: flex;\n+    flex-direction: column; */\n+\n+    &.with-contacts {\n+      .chatlist-top:not(.with-placeholder) {\n+        height: auto;\n+        padding-bottom: .5rem;\n+      }\n+\n+      .chatlist-top.with-placeholder {\n+        height: 24.125rem;\n+  \n+        .empty-placeholder-dialogs {\n+          top: 50%;\n+        }\n+      }\n+    }\n+  }\n+\n+  // do not set position: relative here. will break chatlist slicing.\n+  &-top {\n+    // flex: 0 0 auto;\n+    height: 100%;\n+  }\n+\n+  &-bottom {\n+    // flex: 1 1 auto;\n+    max-height: 36.375rem;\n+\n+    .sidebar-left-section {\n+      padding-bottom: 0;\n+    }\n+\n+    .chatlist-new {\n+      padding: 0;\n+      margin-top: -.5rem;\n+\n+      li {\n+        height: 3.5rem;\n+      }\n+\n+      .user-caption {\n+        padding-left: 1.125rem;\n+      }\n+\n+      .dialog-subtitle {\n+        margin-top: .0625rem;\n+      }\n+    }\n+  }\n+\n+  // * supernew correct layout\n+  &-new {\n+    li {\n+      height: 4.5rem;\n+      padding: 0 .75rem;\n+      align-items: center;\n+    }\n+\n+    .user-caption {\n+      padding-left: .75rem;\n+    }\n+\n+    p {\n+      height: auto !important;\n+    }\n+\n+    span {\n+      line-height: var(--line-height) !important;\n+    }\n+\n+    .dialog-subtitle {\n+      margin-top: .125rem;\n+    }\n+\n+    .user-last-message {\n+      font-size: .875rem;\n+    }\n+  }\n }\n \n // use together like class=\"chatlist-container contacts-container\""
        },
        {
          "filename": "src/scss/partials/_leftSidebar.scss",
          "status": "modified",
          "additions": 8,
          "deletions": 0,
          "patch": "@@ -830,6 +830,10 @@\n     user-select: none;\n     padding: .5rem 0 1rem;\n \n+    &.with-fake-delimiter {\n+      padding-top: 0;\n+    }\n+\n     @include respond-to(handhelds) {\n       padding-bottom: .5rem;\n     }\n@@ -1182,6 +1186,9 @@\n }\n \n .empty-placeholder {\n+  // left: 50%;\n+  // transform: translate(-50%, -50%);\n+  // position: absolute;\n   top: 40%;\n   transform: translateY(-50%);\n   text-align: center;\n@@ -1190,6 +1197,7 @@\n   width: 21rem !important;\n   margin: 0 auto;\n   padding: 0 1rem;\n+  position: relative;\n   \n   .media-sticker-wrapper {\n     width: 128px;"
        },
        {
          "filename": "src/scss/partials/_rightSidebar.scss",
          "status": "modified",
          "additions": 1,
          "deletions": 28,
          "patch": "@@ -708,35 +708,8 @@\n     padding: 0 0 .5rem;\n   }\n \n-  // * supernew and correct layout\n-  .chatlist {\n+  .chatlist-new {\n     padding: 0;\n-\n-    li {\n-      height: 72px;\n-      padding: 0 .75rem;\n-      align-items: center;\n-    }\n-\n-    .user-caption {\n-      padding-left: .75rem;\n-    }\n-\n-    p {\n-      height: auto;\n-    }\n-\n-    span {\n-      line-height: 1.3125;\n-    }\n-\n-    .dialog-subtitle {\n-      margin-top: .125rem;\n-    }\n-\n-    .user-last-message {\n-      font-size: .875rem;\n-    }\n   }\n }\n "
        },
        {
          "filename": "src/scss/partials/_slider.scss",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -147,12 +147,12 @@\n       display: flex;\n     }\n     \n-    > div:not(.scroll-padding) {\n+    /* > div:not(.scroll-padding) {\n       width: 100%;\n       max-width: 100%;\n       //overflow: hidden;\n       position: relative;\n-    }\n+    } */\n   }\n \n   /* &[data-animation=\"tabs\"] {"
        },
        {
          "filename": "src/scss/style.scss",
          "status": "modified",
          "additions": 0,
          "deletions": 1,
          "patch": "@@ -1212,7 +1212,6 @@ middle-ellipsis-element {\n .gradient-delimiter {\n   width: 100%;\n   height: .75rem;\n-  display: flex;\n   background-color: var(--background-color-true);\n   position: relative;\n "
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 1,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 12,
        "max_directory_depth": 4
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "fd6a1f41721011ec8067c809d8f2cc43a83b6483",
            "date": "2024-11-09T10:32:44Z",
            "author_login": "morethanwords"
          },
          {
            "sha": "689ab9062da28f386240ff1bb875c5f18bf46156",
            "date": "2024-11-08T21:54:56Z",
            "author_login": "morethanwords"
          },
          {
            "sha": "7af3c677754881b61d9c24577266573b24f7f486",
            "date": "2024-11-08T14:57:25Z",
            "author_login": "morethanwords"
          },
          {
            "sha": "49d26ab2794a71c5dc3a9f8db099b5413b3827c5",
            "date": "2024-11-08T14:24:14Z",
            "author_login": "morethanwords"
          },
          {
            "sha": "ae6700bb639e0e6ca2de2df1a8bc701af2a71c23",
            "date": "2024-11-08T11:36:41Z",
            "author_login": "morethanwords"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.1,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N",
    "cwe_id": "CWE-79",
    "description": "Telegram Web K Alpha 0.6.1 allows XSS via a document name.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2021-07-30T14:15:18.700",
    "last_modified": "2024-11-21T06:15:29.540",
    "fix_date": "2021-07-20T16:11:58Z"
  },
  "references": [
    {
      "url": "https://github.com/morethanwords/tweb/commit/11d2fe01363889f20c8baa2217ed4aad445c5551",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/morethanwords/tweb/commit/11d2fe01363889f20c8baa2217ed4aad445c5551",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:02.350867",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "tweb",
    "owner": "morethanwords",
    "created_at": "2020-02-06T15:36:55Z",
    "updated_at": "2025-01-13T22:13:23Z",
    "pushed_at": "2024-11-09T10:32:51Z",
    "size": 1222660,
    "stars": 1925,
    "forks": 619,
    "open_issues": 143,
    "watchers": 1925,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "TypeScript": 7415632,
      "SCSS": 707012,
      "JavaScript": 133952,
      "HTML": 28323,
      "CSS": 5029,
      "GLSL": 3901
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "gpl-3.0"
    },
    "collected_at": "2025-01-14T17:31:43.486871"
  }
}