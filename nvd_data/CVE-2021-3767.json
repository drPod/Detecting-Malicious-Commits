{
  "cve_id": "CVE-2021-3767",
  "github_data": {
    "repository": "bookstackapp/bookstack",
    "fix_commit": "040997fdc4414776bcac06a3cbaac3b26b5e8a64",
    "related_commits": [
      "040997fdc4414776bcac06a3cbaac3b26b5e8a64",
      "040997fdc4414776bcac06a3cbaac3b26b5e8a64"
    ],
    "patch_url": "https://github.com/bookstackapp/bookstack/commit/040997fdc4414776bcac06a3cbaac3b26b5e8a64.patch",
    "fix_commit_details": {
      "sha": "040997fdc4414776bcac06a3cbaac3b26b5e8a64",
      "commit_date": "2021-09-03T21:34:49Z",
      "author": {
        "login": "ssddanbrown",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Added filter for xlink:href svg xss",
        "length": 70,
        "has_description": true,
        "references_issue": false
      },
      "stats": {
        "total": 48,
        "additions": 42,
        "deletions": 6
      },
      "files": [
        {
          "filename": "app/Util/HtmlContentFilter.php",
          "status": "modified",
          "additions": 20,
          "deletions": 6,
          "patch": "@@ -2,6 +2,7 @@\n \n namespace BookStack\\Util;\n \n+use DOMAttr;\n use DOMDocument;\n use DOMNodeList;\n use DOMXPath;\n@@ -43,13 +44,14 @@ public static function removeScripts(string $html): string\n         $badIframes = $xPath->query('//*[' . static::xpathContains('@src', 'data:') . '] | //*[' . static::xpathContains('@src', 'javascript:') . '] | //*[@srcdoc]');\n         static::removeNodes($badIframes);\n \n+        // Remove elements with a xlink:href attribute\n+        // Used in SVG but deprecated anyway, so we'll be a bit more heavy-handed here.\n+        $xlinkHrefAttributes = $xPath->query('//@*[contains(name(), \\'xlink:href\\')]');\n+        static::removeAttributes($xlinkHrefAttributes);\n+\n         // Remove 'on*' attributes\n         $onAttributes = $xPath->query('//@*[starts-with(name(), \\'on\\')]');\n-        foreach ($onAttributes as $attr) {\n-            /** @var \\DOMAttr $attr */\n-            $attrName = $attr->nodeName;\n-            $attr->parentNode->removeAttribute($attrName);\n-        }\n+        static::removeAttributes($onAttributes);\n \n         $html = '';\n         $topElems = $doc->documentElement->childNodes->item(0)->childNodes;\n@@ -72,12 +74,24 @@ protected static function xpathContains(string $property, string $value): string\n     }\n \n     /**\n-     * Removed all of the given DOMNodes.\n+     * Remove all the given DOMNodes.\n      */\n     protected static function removeNodes(DOMNodeList $nodes): void\n     {\n         foreach ($nodes as $node) {\n             $node->parentNode->removeChild($node);\n         }\n     }\n+\n+    /**\n+     * Remove all the given attribute nodes.\n+     */\n+    protected static function removeAttributes(DOMNodeList $attrs): void\n+    {\n+        /** @var DOMAttr $attr */\n+        foreach ($attrs as $attr) {\n+            $attrName = $attr->nodeName;\n+            $attr->parentNode->removeAttribute($attrName);\n+        }\n+    }\n }"
        },
        {
          "filename": "tests/Entity/PageContentTest.php",
          "status": "modified",
          "additions": 22,
          "deletions": 0,
          "patch": "@@ -305,6 +305,28 @@ public function test_page_content_scripts_show_when_configured()\n         $pageView->assertDontSee('abc123abc123');\n     }\n \n+    public function test_svg_xlink_hrefs_are_removed()\n+    {\n+        $checks = [\n+            '<svg id=\"test\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" width=\"100\" height=\"100\"><a xlink:href=\"javascript:alert(document.domain)\"><rect x=\"0\" y=\"0\" width=\"100\" height=\"100\" /></a></svg>',\n+            '<svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\"><use xlink:href=\"data:application/xml;base64 ,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj4KPGRlZnM+CjxjaXJjbGUgaWQ9InRlc3QiIHI9IjAiIGN4PSIwIiBjeT0iMCIgc3R5bGU9ImZpbGw6ICNGMDAiPgo8c2V0IGF0dHJpYnV0ZU5hbWU9ImZpbGwiIGF0dHJpYnV0ZVR5cGU9IkNTUyIgb25iZWdpbj0nYWxlcnQoZG9jdW1lbnQuZG9tYWluKScKb25lbmQ9J2FsZXJ0KCJvbmVuZCIpJyB0bz0iIzAwRiIgYmVnaW49IjBzIiBkdXI9Ijk5OXMiIC8+CjwvY2lyY2xlPgo8L2RlZnM+Cjx1c2UgeGxpbms6aHJlZj0iI3Rlc3QiLz4KPC9zdmc+#test\"/></svg>'\n+        ];\n+\n+        $this->asEditor();\n+        $page = Page::query()->first();\n+\n+        foreach ($checks as $check) {\n+            $page->html = $check;\n+            $page->save();\n+\n+            $pageView = $this->get($page->getUrl());\n+            $pageView->assertStatus(200);\n+            $pageView->assertElementNotContains('.page-content', 'alert');\n+            $pageView->assertElementNotContains('.page-content', 'xlink:href');\n+            $pageView->assertElementNotContains('.page-content', 'application/xml');\n+        }\n+    }\n+\n     public function test_page_inline_on_attributes_show_if_configured()\n     {\n         $this->asEditor();"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 2,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "b9751807e7bad4b7d477b6977f630881f730abad",
            "date": "2025-01-13T13:27:32Z",
            "author_login": "ssddanbrown"
          },
          {
            "sha": "ee88832f1a468af9f930807071da3a206eeb91c8",
            "date": "2025-01-13T13:26:04Z",
            "author_login": "ssddanbrown"
          },
          {
            "sha": "dbda82ef9275fcb791a27cd329d8383c6a676d17",
            "date": "2025-01-11T15:05:10Z",
            "author_login": "ssddanbrown"
          },
          {
            "sha": "ad8bc5fe21ddccc243f6a4ef4e87bbd28668c423",
            "date": "2025-01-11T13:50:01Z",
            "author_login": "ssddanbrown"
          },
          {
            "sha": "5bf75786c6326f4c2ef5df577a1062aeacce7bff",
            "date": "2025-01-11T13:22:49Z",
            "author_login": "ssddanbrown"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 5.4,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N",
    "cwe_id": "CWE-79",
    "description": "bookstack is vulnerable to Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2021-09-06T12:15:08.237",
    "last_modified": "2024-11-21T06:22:22.600",
    "fix_date": "2021-09-03T21:34:49Z"
  },
  "references": [
    {
      "url": "https://github.com/bookstackapp/bookstack/commit/040997fdc4414776bcac06a3cbaac3b26b5e8a64",
      "source": "security@huntr.dev",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/7ec92c85-30eb-4071-8891-6183446ca980",
      "source": "security@huntr.dev",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/bookstackapp/bookstack/commit/040997fdc4414776bcac06a3cbaac3b26b5e8a64",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/7ec92c85-30eb-4071-8891-6183446ca980",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:05.133552",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "BookStack",
    "owner": "bookstackapp",
    "created_at": "2015-08-29T10:26:44Z",
    "updated_at": "2025-01-14T12:14:34Z",
    "pushed_at": "2025-01-13T20:16:47Z",
    "size": 41179,
    "stars": 15786,
    "forks": 1978,
    "open_issues": 598,
    "watchers": 15786,
    "has_security_policy": false,
    "default_branch": "development",
    "protected_branches": [
      "release"
    ],
    "languages": {
      "PHP": 7963438,
      "TypeScript": 1856418,
      "Blade": 444101,
      "JavaScript": 287858,
      "SCSS": 139395,
      "Dockerfile": 1282,
      "Shell": 347
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-14T13:05:28.288711"
  }
}