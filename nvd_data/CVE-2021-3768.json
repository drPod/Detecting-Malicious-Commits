{
  "cve_id": "CVE-2021-3768",
  "github_data": {
    "repository": "bookstackapp/bookstack",
    "fix_commit": "5e6092aaf8fd420202016038286554860bf8ea64",
    "related_commits": [
      "5e6092aaf8fd420202016038286554860bf8ea64",
      "5e6092aaf8fd420202016038286554860bf8ea64"
    ],
    "patch_url": "https://github.com/bookstackapp/bookstack/commit/5e6092aaf8fd420202016038286554860bf8ea64.patch",
    "fix_commit_details": {
      "sha": "5e6092aaf8fd420202016038286554860bf8ea64",
      "commit_date": "2021-09-02T21:02:30Z",
      "author": {
        "login": "ssddanbrown",
        "type": "User",
        "stats": {
          "total_commits": 3432,
          "average_weekly_commits": 6.905432595573441,
          "total_additions": 633335,
          "total_deletions": 385989,
          "weeks_active": 420
        }
      },
      "commit_message": {
        "title": "Added extra HTML filtering of dangerous content",
        "length": 208,
        "has_description": true,
        "references_issue": false
      },
      "stats": {
        "total": 44,
        "additions": 38,
        "deletions": 6
      },
      "files": [
        {
          "filename": "app/Util/HtmlContentFilter.php",
          "status": "modified",
          "additions": 15,
          "deletions": 4,
          "patch": "@@ -28,19 +28,19 @@ public static function removeScripts(string $html): string\n         static::removeNodes($scriptElems);\n \n         // Remove clickable links to JavaScript URI\n-        $badLinks = $xPath->query('//*[contains(@href, \\'javascript:\\')]');\n+        $badLinks = $xPath->query('//*[' . static::xpathContains('@href', 'javascript:') . ']');\n         static::removeNodes($badLinks);\n \n         // Remove forms with calls to JavaScript URI\n-        $badForms = $xPath->query('//*[contains(@action, \\'javascript:\\')] | //*[contains(@formaction, \\'javascript:\\')]');\n+        $badForms = $xPath->query('//*[' . static::xpathContains('@action', 'javascript:') . '] | //*[' . static::xpathContains('@formaction', 'javascript:') . ']');\n         static::removeNodes($badForms);\n \n         // Remove meta tag to prevent external redirects\n-        $metaTags = $xPath->query('//meta[contains(@content, \\'url\\')]');\n+        $metaTags = $xPath->query('//meta[' . static::xpathContains('@content', 'url') . ']');\n         static::removeNodes($metaTags);\n \n         // Remove data or JavaScript iFrames\n-        $badIframes = $xPath->query('//*[contains(@src, \\'data:\\')] | //*[contains(@src, \\'javascript:\\')] | //*[@srcdoc]');\n+        $badIframes = $xPath->query('//*[' . static::xpathContains('@src', 'data:') . '] | //*[' . static::xpathContains('@src', 'javascript:') . '] | //*[@srcdoc]');\n         static::removeNodes($badIframes);\n \n         // Remove 'on*' attributes\n@@ -60,6 +60,17 @@ public static function removeScripts(string $html): string\n         return $html;\n     }\n \n+    /**\n+     * Create a xpath contains statement with a translation automatically built within\n+     * to affectively search in a cases-insensitive manner.\n+     */\n+    protected static function xpathContains(string $property, string $value): string\n+    {\n+        $value = strtolower($value);\n+        $upperVal = strtoupper($value);\n+        return 'contains(translate(' . $property . ', \\'' . $upperVal . '\\', \\'' . $value . '\\'), \\'' . $value . '\\')';\n+    }\n+\n     /**\n      * Removed all of the given DOMNodes.\n      */"
        },
        {
          "filename": "tests/Entity/PageContentTest.php",
          "status": "modified",
          "additions": 23,
          "deletions": 2,
          "patch": "@@ -135,14 +135,26 @@ public function test_more_complex_content_script_escaping_scenarios()\n         }\n     }\n \n-    public function test_iframe_js_and_base64_urls_are_removed()\n+    public function test_js_and_base64_src_urls_are_removed()\n     {\n         $checks = [\n             '<iframe src=\"javascript:alert(document.cookie)\"></iframe>',\n+            '<iframe src=\"JavAScRipT:alert(document.cookie)\"></iframe>',\n+            '<iframe src=\"JavAScRipT:alert(document.cookie)\"></iframe>',\n             '<iframe SRC=\" javascript: alert(document.cookie)\"></iframe>',\n             '<iframe src=\"data:text/html;base64,PHNjcmlwdD5hbGVydCgnaGVsbG8nKTwvc2NyaXB0Pg==\" frameborder=\"0\"></iframe>',\n+            '<iframe src=\"DaTa:text/html;base64,PHNjcmlwdD5hbGVydCgnaGVsbG8nKTwvc2NyaXB0Pg==\" frameborder=\"0\"></iframe>',\n             '<iframe src=\" data:text/html;base64,PHNjcmlwdD5hbGVydCgnaGVsbG8nKTwvc2NyaXB0Pg==\" frameborder=\"0\"></iframe>',\n+            '<img src=\"javascript:alert(document.cookie)\"/>',\n+            '<img src=\"JavAScRipT:alert(document.cookie)\"/>',\n+            '<img src=\"JavAScRipT:alert(document.cookie)\"/>',\n+            '<img SRC=\" javascript: alert(document.cookie)\"/>',\n+            '<img src=\"data:text/html;base64,PHNjcmlwdD5hbGVydCgnaGVsbG8nKTwvc2NyaXB0Pg==\"/>',\n+            '<img src=\"DaTa:text/html;base64,PHNjcmlwdD5hbGVydCgnaGVsbG8nKTwvc2NyaXB0Pg==\"/>',\n+            '<img src=\" data:text/html;base64,PHNjcmlwdD5hbGVydCgnaGVsbG8nKTwvc2NyaXB0Pg==\"/>',\n             '<iframe srcdoc=\"<script>window.alert(document.cookie)</script>\"></iframe>',\n+            '<iframe SRCdoc=\"<script>window.alert(document.cookie)</script>\"></iframe>',\n+            '<IMG SRC=`javascript:alert(\"RSnake says, \\'XSS\\'\")`>',\n         ];\n \n         $this->asEditor();\n@@ -155,6 +167,7 @@ public function test_iframe_js_and_base64_urls_are_removed()\n             $pageView = $this->get($page->getUrl());\n             $pageView->assertStatus(200);\n             $pageView->assertElementNotContains('.page-content', '<iframe>');\n+            $pageView->assertElementNotContains('.page-content', '<img');\n             $pageView->assertElementNotContains('.page-content', '</iframe>');\n             $pageView->assertElementNotContains('.page-content', 'src=');\n             $pageView->assertElementNotContains('.page-content', 'javascript:');\n@@ -168,6 +181,8 @@ public function test_javascript_uri_links_are_removed()\n         $checks = [\n             '<a id=\"xss\" href=\"javascript:alert(document.cookie)>Click me</a>',\n             '<a id=\"xss\" href=\"javascript: alert(document.cookie)>Click me</a>',\n+            '<a id=\"xss\" href=\"JaVaScRiPt: alert(document.cookie)>Click me</a>',\n+            '<a id=\"xss\" href=\" JaVaScRiPt: alert(document.cookie)>Click me</a>',\n         ];\n \n         $this->asEditor();\n@@ -179,7 +194,7 @@ public function test_javascript_uri_links_are_removed()\n \n             $pageView = $this->get($page->getUrl());\n             $pageView->assertStatus(200);\n-            $pageView->assertElementNotContains('.page-content', '<a id=\"xss\">');\n+            $pageView->assertElementNotContains('.page-content', '<a id=\"xss\"');\n             $pageView->assertElementNotContains('.page-content', 'href=javascript:');\n         }\n     }\n@@ -188,8 +203,10 @@ public function test_form_actions_with_javascript_are_removed()\n     {\n         $checks = [\n             '<form><input id=\"xss\" type=submit formaction=javascript:alert(document.domain) value=Submit><input></form>',\n+            '<form ><button id=\"xss\" formaction=\"JaVaScRiPt:alert(document.domain)\">Click me</button></form>',\n             '<form ><button id=\"xss\" formaction=javascript:alert(document.domain)>Click me</button></form>',\n             '<form id=\"xss\" action=javascript:alert(document.domain)><input type=submit value=Submit></form>',\n+            '<form id=\"xss\" action=\"JaVaScRiPt:alert(document.domain)\"><input type=submit value=Submit></form>',\n         ];\n \n         $this->asEditor();\n@@ -213,6 +230,8 @@ public function test_metadata_redirects_are_removed()\n     {\n         $checks = [\n             '<meta http-equiv=\"refresh\" content=\"0; url=//external_url\">',\n+            '<meta http-equiv=\"refresh\" ConTeNt=\"0; url=//external_url\">',\n+            '<meta http-equiv=\"refresh\" content=\"0; UrL=//external_url\">',\n         ];\n \n         $this->asEditor();\n@@ -249,11 +268,13 @@ public function test_more_complex_inline_on_attributes_escaping_scenarios()\n     {\n         $checks = [\n             '<p onclick=\"console.log(\\'test\\')\">Hello</p>',\n+            '<p OnCliCk=\"console.log(\\'test\\')\">Hello</p>',\n             '<div>Lorem ipsum dolor sit amet.</div><p onclick=\"console.log(\\'test\\')\">Hello</p>',\n             '<div>Lorem ipsum dolor sit amet.<p onclick=\"console.log(\\'test\\')\">Hello</p></div>',\n             '<div><div><div><div>Lorem ipsum dolor sit amet.<p onclick=\"console.log(\\'test\\')\">Hello</p></div></div></div></div>',\n             '<div onclick=\"console.log(\\'test\\')\">Lorem ipsum dolor sit amet.</div><p onclick=\"console.log(\\'test\\')\">Hello</p><div></div>',\n             '<a a=\"<img src=1 onerror=\\'alert(1)\\'> ',\n+            '\\<a onclick=\"alert(document.cookie)\"\\>xss link\\</a\\>',\n         ];\n \n         $this->asEditor();"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 2,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "786a434c03faa996e630f4a0a523567d3b093f43",
            "date": "2025-01-14T14:56:43Z",
            "author_login": "ssddanbrown"
          },
          {
            "sha": "25c4f4b02ba06f66f5239de48ae005f895146f8d",
            "date": "2025-01-14T14:53:10Z",
            "author_login": "ssddanbrown"
          },
          {
            "sha": "481580be172a4813ee98ad1b945d12d731e71cdb",
            "date": "2025-01-13T16:51:07Z",
            "author_login": "ssddanbrown"
          },
          {
            "sha": "593645acfe8521db97d7469c92546c8529703969",
            "date": "2025-01-13T14:30:53Z",
            "author_login": "ssddanbrown"
          },
          {
            "sha": "b9751807e7bad4b7d477b6977f630881f730abad",
            "date": "2025-01-13T13:27:32Z",
            "author_login": "ssddanbrown"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 5.4,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N",
    "cwe_id": "CWE-79",
    "description": "bookstack is vulnerable to Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2021-09-06T12:15:08.307",
    "last_modified": "2024-11-21T06:22:22.747",
    "fix_date": "2021-09-02T21:02:30Z"
  },
  "references": [
    {
      "url": "https://github.com/bookstackapp/bookstack/commit/5e6092aaf8fd420202016038286554860bf8ea64",
      "source": "security@huntr.dev",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/64a0229f-ff5e-4c64-b83e-9bfc0698a78e",
      "source": "security@huntr.dev",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/bookstackapp/bookstack/commit/5e6092aaf8fd420202016038286554860bf8ea64",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/64a0229f-ff5e-4c64-b83e-9bfc0698a78e",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:05.133699",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "BookStack",
    "owner": "bookstackapp",
    "created_at": "2015-08-29T10:26:44Z",
    "updated_at": "2025-01-14T12:14:34Z",
    "pushed_at": "2025-01-13T20:16:47Z",
    "size": 41179,
    "stars": 15786,
    "forks": 1978,
    "open_issues": 598,
    "watchers": 15786,
    "has_security_policy": false,
    "default_branch": "development",
    "protected_branches": [
      "release"
    ],
    "languages": {
      "PHP": 7963438,
      "TypeScript": 1856418,
      "Blade": 444101,
      "JavaScript": 287858,
      "SCSS": 139395,
      "Dockerfile": 1282,
      "Shell": 347
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-14T13:05:28.288711"
  }
}