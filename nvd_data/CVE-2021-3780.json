{
  "cve_id": "CVE-2021-3780",
  "github_data": {
    "repository": "chocobozzz/peertube",
    "fix_commit": "0ea2f79d45b301fcd660efc894469a99b2239bf6",
    "related_commits": [
      "0ea2f79d45b301fcd660efc894469a99b2239bf6",
      "0ea2f79d45b301fcd660efc894469a99b2239bf6"
    ],
    "patch_url": "https://github.com/chocobozzz/peertube/commit/0ea2f79d45b301fcd660efc894469a99b2239bf6.patch",
    "fix_commit_details": {
      "sha": "0ea2f79d45b301fcd660efc894469a99b2239bf6",
      "commit_date": "2021-09-08T08:10:51Z",
      "author": {
        "login": "Chocobozzz",
        "type": "User",
        "stats": {
          "total_commits": 7381,
          "average_weekly_commits": 17.657894736842106,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 332
        }
      },
      "commit_message": {
        "title": "Safer image preview",
        "length": 19,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 38,
        "additions": 24,
        "deletions": 14
      },
      "files": [
        {
          "filename": "client/src/app/shared/shared-actor-image-edit/actor-avatar-edit.component.ts",
          "status": "modified",
          "additions": 3,
          "deletions": 4,
          "patch": "@@ -1,9 +1,9 @@\n import { Component, ElementRef, EventEmitter, Input, OnInit, Output, ViewChild } from '@angular/core'\n-import { DomSanitizer, SafeResourceUrl } from '@angular/platform-browser'\n import { Notifier, ServerService } from '@app/core'\n import { Account, VideoChannel } from '@app/shared/shared-main'\n import { NgbPopover } from '@ng-bootstrap/ng-bootstrap'\n import { getBytes } from '@root-helpers/bytes'\n+import { imageToDataURL } from '@root-helpers/images'\n \n @Component({\n   selector: 'my-actor-avatar-edit',\n@@ -30,10 +30,9 @@ export class ActorAvatarEditComponent implements OnInit {\n   maxAvatarSize = 0\n   avatarExtensions = ''\n \n-  preview: SafeResourceUrl\n+  preview: string\n \n   constructor (\n-    private sanitizer: DomSanitizer,\n     private serverService: ServerService,\n     private notifier: Notifier\n   ) { }\n@@ -63,7 +62,7 @@ export class ActorAvatarEditComponent implements OnInit {\n     this.avatarChange.emit(formData)\n \n     if (this.previewImage) {\n-      this.preview = this.sanitizer.bypassSecurityTrustResourceUrl(URL.createObjectURL(avatarfile))\n+      imageToDataURL(avatarfile).then(result => this.preview = result)\n     }\n   }\n "
        },
        {
          "filename": "client/src/app/shared/shared-actor-image-edit/actor-banner-edit.component.ts",
          "status": "modified",
          "additions": 3,
          "deletions": 3,
          "patch": "@@ -1,9 +1,10 @@\n import { Component, ElementRef, EventEmitter, Input, OnInit, Output, ViewChild } from '@angular/core'\n-import { DomSanitizer, SafeResourceUrl } from '@angular/platform-browser'\n+import { SafeResourceUrl } from '@angular/platform-browser'\n import { Notifier, ServerService } from '@app/core'\n import { VideoChannel } from '@app/shared/shared-main'\n import { NgbPopover } from '@ng-bootstrap/ng-bootstrap'\n import { getBytes } from '@root-helpers/bytes'\n+import { imageToDataURL } from '@root-helpers/images'\n \n @Component({\n   selector: 'my-actor-banner-edit',\n@@ -30,7 +31,6 @@ export class ActorBannerEditComponent implements OnInit {\n   preview: SafeResourceUrl\n \n   constructor (\n-    private sanitizer: DomSanitizer,\n     private serverService: ServerService,\n     private notifier: Notifier\n   ) { }\n@@ -59,7 +59,7 @@ export class ActorBannerEditComponent implements OnInit {\n     this.bannerChange.emit(formData)\n \n     if (this.previewImage) {\n-      this.preview = this.sanitizer.bypassSecurityTrustResourceUrl(URL.createObjectURL(bannerfile))\n+      imageToDataURL(bannerfile).then(result => this.preview = result)\n     }\n   }\n "
        },
        {
          "filename": "client/src/app/shared/shared-actor-image/actor-avatar.component.ts",
          "status": "modified",
          "additions": 1,
          "deletions": 2,
          "patch": "@@ -1,5 +1,4 @@\n import { Component, Input } from '@angular/core'\n-import { SafeResourceUrl } from '@angular/platform-browser'\n import { VideoChannel } from '../shared-main'\n import { Account } from '../shared-main/account/account.model'\n \n@@ -22,7 +21,7 @@ export class ActorAvatarComponent {\n   @Input() account: ActorInput\n   @Input() channel: ActorInput\n \n-  @Input() previewImage: SafeResourceUrl\n+  @Input() previewImage: string\n \n   @Input() size: ActorAvatarSize\n "
        },
        {
          "filename": "client/src/app/shared/shared-forms/preview-upload.component.ts",
          "status": "modified",
          "additions": 3,
          "deletions": 5,
          "patch": "@@ -1,7 +1,7 @@\n import { Component, forwardRef, Input, OnInit } from '@angular/core'\n import { ControlValueAccessor, NG_VALUE_ACCESSOR } from '@angular/forms'\n-import { DomSanitizer, SafeResourceUrl } from '@angular/platform-browser'\n import { ServerService } from '@app/core'\n+import { imageToDataURL } from '@root-helpers/images'\n import { HTMLServerConfig } from '@shared/models'\n import { BytesPipe } from '../shared-main'\n \n@@ -23,7 +23,7 @@ export class PreviewUploadComponent implements OnInit, ControlValueAccessor {\n   @Input() previewWidth: string\n   @Input() previewHeight: string\n \n-  imageSrc: SafeResourceUrl\n+  imageSrc: string\n   allowedExtensionsMessage = ''\n   maxSizeText: string\n \n@@ -32,7 +32,6 @@ export class PreviewUploadComponent implements OnInit, ControlValueAccessor {\n   private file: Blob\n \n   constructor (\n-    private sanitizer: DomSanitizer,\n     private serverService: ServerService\n   ) {\n     this.bytesPipe = new BytesPipe()\n@@ -81,8 +80,7 @@ export class PreviewUploadComponent implements OnInit, ControlValueAccessor {\n \n   private updatePreview () {\n     if (this.file) {\n-      const url = URL.createObjectURL(this.file)\n-      this.imageSrc = this.sanitizer.bypassSecurityTrustResourceUrl(url)\n+      imageToDataURL(this.file).then(result => this.imageSrc = result)\n     }\n   }\n }"
        },
        {
          "filename": "client/src/root-helpers/images.ts",
          "status": "added",
          "additions": 13,
          "deletions": 0,
          "patch": "@@ -0,0 +1,13 @@\n+function imageToDataURL (input: File | Blob) {\n+  return new Promise<string>(res => {\n+    const reader = new FileReader()\n+\n+    reader.onerror = err => console.error('Cannot read input file.', err)\n+    reader.onloadend = () => res(reader.result as string)\n+    reader.readAsDataURL(input)\n+  })\n+}\n+\n+export {\n+  imageToDataURL\n+}"
        },
        {
          "filename": "client/src/root-helpers/index.ts",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -1,5 +1,6 @@\n export * from './users'\n export * from './bytes'\n+export * from './images'\n export * from './peertube-web-storage'\n export * from './utils'\n export * from './plugins-manager'"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 4,
        "max_directory_depth": 5
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "c31084ce5bc31a5ab0d1bfb014afe509e9d9e7a1",
            "date": "2025-01-04T16:19:34Z",
            "author_login": "zbirkenbuel"
          },
          {
            "sha": "4967d25d4619bf98dd30ddf68b780e683a844ba2",
            "date": "2025-01-14T12:27:18Z",
            "author_login": "Chocobozzz"
          },
          {
            "sha": "1a568cc65c3938a2832d4816cd5f34807b0f06f8",
            "date": "2025-01-14T12:25:17Z",
            "author_login": "Khyvodul"
          },
          {
            "sha": "e4b6021310447c5723cb08b5a11347f425d177d9",
            "date": "2025-01-14T10:37:03Z",
            "author_login": "Chocobozzz"
          },
          {
            "sha": "e0960c53a99e1d328f89bc726ee81c3f943cc904",
            "date": "2025-01-14T10:32:04Z",
            "author_login": "Chocobozzz"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.1,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N",
    "cwe_id": "CWE-79",
    "description": "peertube is vulnerable to Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2021-09-15T12:15:16.133",
    "last_modified": "2024-11-21T06:22:24.723",
    "fix_date": "2021-09-08T08:10:51Z"
  },
  "references": [
    {
      "url": "https://github.com/chocobozzz/peertube/commit/0ea2f79d45b301fcd660efc894469a99b2239bf6",
      "source": "security@huntr.dev",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/282807a8-4bf5-4fe2-af62-e05f945b3d65",
      "source": "security@huntr.dev",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/chocobozzz/peertube/commit/0ea2f79d45b301fcd660efc894469a99b2239bf6",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/282807a8-4bf5-4fe2-af62-e05f945b3d65",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:07.755115",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "PeerTube",
    "owner": "chocobozzz",
    "created_at": "2015-10-29T22:09:42Z",
    "updated_at": "2025-01-14T12:54:05Z",
    "pushed_at": "2025-01-14T12:54:00Z",
    "size": 345923,
    "stars": 13329,
    "forks": 1538,
    "open_issues": 625,
    "watchers": 13329,
    "has_security_policy": false,
    "default_branch": "develop",
    "protected_branches": [
      "develop",
      "master"
    ],
    "languages": {
      "TypeScript": 8063880,
      "HTML": 587956,
      "SCSS": 274504,
      "Shell": 34475,
      "Pug": 22110,
      "JavaScript": 12518,
      "Dockerfile": 332
    },
    "commit_activity": {
      "total_commits_last_year": 1307,
      "avg_commits_per_week": 25.134615384615383,
      "days_active_last_year": 233
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "agpl-3.0"
    },
    "collected_at": "2025-01-14T13:52:13.645385"
  }
}