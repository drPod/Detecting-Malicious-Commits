{
  "cve_id": "CVE-2021-39195",
  "github_data": {
    "repository": "misskey-dev/misskey",
    "fix_commit": "e1a8b158e04ad567d92d8daf3cc0898ee18f1a2e",
    "related_commits": [
      "e1a8b158e04ad567d92d8daf3cc0898ee18f1a2e",
      "e1a8b158e04ad567d92d8daf3cc0898ee18f1a2e"
    ],
    "patch_url": "https://github.com/misskey-dev/misskey/commit/e1a8b158e04ad567d92d8daf3cc0898ee18f1a2e.patch",
    "fix_commit_details": {
      "sha": "e1a8b158e04ad567d92d8daf3cc0898ee18f1a2e",
      "commit_date": "2021-09-03T12:00:44Z",
      "author": {
        "login": "mei23",
        "type": "User",
        "stats": {
          "total_commits": 687,
          "average_weekly_commits": 1.631828978622328,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 181
        }
      },
      "commit_message": {
        "title": "Tune download (#2)",
        "length": 126,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 129,
        "additions": 106,
        "deletions": 23
      },
      "files": [
        {
          "filename": ".config/example.yml",
          "status": "modified",
          "additions": 4,
          "deletions": 0,
          "patch": "@@ -157,3 +157,7 @@ id: 'aid'\n \n # Sign to ActivityPub GET request (default: false)\n #signToActivityPubGet: true\n+\n+#allowedPrivateNetworks: [\n+#  '127.0.0.1/32'\n+#]"
        },
        {
          "filename": "package.json",
          "status": "modified",
          "additions": 2,
          "deletions": 0,
          "patch": "@@ -148,6 +148,7 @@\n \t\t\"http-signature\": \"1.3.5\",\n \t\t\"idb-keyval\": \"5.1.3\",\n \t\t\"insert-text-at-cursor\": \"0.3.0\",\n+\t\t\"ip-cidr\": \"3.0.4\",\n \t\t\"is-svg\": \"4.3.1\",\n \t\t\"js-yaml\": \"4.1.0\",\n \t\t\"jsdom\": \"16.7.0\",\n@@ -184,6 +185,7 @@\n \t\t\"postcss\": \"8.3.6\",\n \t\t\"postcss-loader\": \"6.1.1\",\n \t\t\"prismjs\": \"1.24.1\",\n+\t\t\"private-ip\": \"2.2.1\",\n \t\t\"probe-image-size\": \"7.2.1\",\n \t\t\"promise-limit\": \"2.7.0\",\n \t\t\"pug\": \"3.0.2\","
        },
        {
          "filename": "src/config/types.ts",
          "status": "modified",
          "additions": 2,
          "deletions": 0,
          "patch": "@@ -37,6 +37,8 @@ export type Source = {\n \tproxySmtp?: string;\n \tproxyBypassHosts?: string[];\n \n+\tallowedPrivateNetworks?: string[];\n+\n \taccesslog?: string;\n \n \tclusterLimit?: number;"
        },
        {
          "filename": "src/misc/download-url.ts",
          "status": "modified",
          "additions": 49,
          "deletions": 18,
          "patch": "@@ -1,40 +1,71 @@\n import * as fs from 'fs';\n import * as stream from 'stream';\n import * as util from 'util';\n-import { URL } from 'url';\n-import fetch from 'node-fetch';\n-import { getAgentByUrl } from './fetch';\n-import { AbortController } from 'abort-controller';\n+import got, * as Got from 'got';\n+import { httpAgent, httpsAgent } from './fetch';\n import config from '@/config/index';\n import * as chalk from 'chalk';\n import Logger from '@/services/logger';\n+import * as IPCIDR from 'ip-cidr';\n+const PrivateIp = require('private-ip');\n \n const pipeline = util.promisify(stream.pipeline);\n \n export async function downloadUrl(url: string, path: string) {\n \tconst logger = new Logger('download');\n \n \tlogger.info(`Downloading ${chalk.cyan(url)} ...`);\n-\tconst controller = new AbortController();\n-\tsetTimeout(() => {\n-\t\tcontroller.abort();\n-\t}, 60 * 1000);\n \n-\tconst response = await fetch(new URL(url).href, {\n+\tconst timeout = 30 * 1000;\n+\tconst operationTimeout = 60 * 1000;\n+\n+\tconst req = got.stream(url, {\n \t\theaders: {\n \t\t\t'User-Agent': config.userAgent\n \t\t},\n-\t\ttimeout: 10 * 1000,\n-\t\tsignal: controller.signal,\n-\t\tagent: getAgentByUrl,\n+\t\ttimeout: {\n+\t\t\tlookup: timeout,\n+\t\t\tconnect: timeout,\n+\t\t\tsecureConnect: timeout,\n+\t\t\tsocket: timeout,\t// read timeout\n+\t\t\tresponse: timeout,\n+\t\t\tsend: timeout,\n+\t\t\trequest: operationTimeout,\t// whole operation timeout\n+\t\t},\n+\t\tagent: {\n+\t\t\thttp: httpAgent,\n+\t\t\thttps: httpsAgent,\n+\t\t},\n+\t\tretry: 0,\n+\t}).on('response', (res: Got.Response) => {\n+\t\tif ((process.env.NODE_ENV === 'production' || process.env.NODE_ENV === 'test') && !config.proxy && res.ip) {\n+\t\t\tif (isPrivateIp(res.ip)) {\n+\t\t\t\tlogger.warn(`Blocked address: ${res.ip}`);\n+\t\t\t\treq.destroy();\n+\t\t\t}\n+\t\t}\n+\t}).on('error', (e: any) => {\n+\t\tif (e.name === 'HTTPError') {\n+\t\t\tconst statusCode = e.response?.statusCode;\n+\t\t\tconst statusMessage = e.response?.statusMessage;\n+\t\t\te.name = `StatusError`;\n+\t\t\te.statusCode = statusCode;\n+\t\t\te.message = `${statusCode} ${statusMessage}`;\n+\t\t}\n \t});\n \n-\tif (!response.ok) {\n-\t\tlogger.error(`Got ${response.status} (${url})`);\n-\t\tthrow response.status;\n-\t}\n-\n-\tawait pipeline(response.body, fs.createWriteStream(path));\n+\tawait pipeline(req, fs.createWriteStream(path));\n \n \tlogger.succ(`Download finished: ${chalk.cyan(url)}`);\n }\n+\n+function isPrivateIp(ip: string) {\n+\tfor (const net of config.allowedPrivateNetworks || []) {\n+\t\tconst cidr = new IPCIDR(net);\n+\t\tif (cidr.contains(ip)) {\n+\t\t\treturn false;\n+\t\t}\n+\t}\n+\n+\treturn PrivateIp(ip);\n+}"
        },
        {
          "filename": "src/server/file/send-drive-file.ts",
          "status": "modified",
          "additions": 3,
          "deletions": 3,
          "patch": "@@ -83,10 +83,10 @@ export default async function(ctx: Koa.Context) {\n \t\t\t\tctx.set('Content-Type', image.type);\n \t\t\t\tctx.set('Cache-Control', 'max-age=31536000, immutable');\n \t\t\t} catch (e) {\n-\t\t\t\tserverLogger.error(e);\n+\t\t\t\tserverLogger.error(e.statusCode);\n \n-\t\t\t\tif (typeof e == 'number' && e >= 400 && e < 500) {\n-\t\t\t\t\tctx.status = e;\n+\t\t\t\tif (typeof e.statusCode === 'number' && e.statusCode >= 400 && e.statusCode < 500) {\n+\t\t\t\t\tctx.status = e.statusCode;\n \t\t\t\t\tctx.set('Cache-Control', 'max-age=86400');\n \t\t\t\t} else {\n \t\t\t\t\tctx.status = 500;"
        },
        {
          "filename": "src/server/proxy/proxy-media.ts",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -39,8 +39,8 @@ export async function proxyMedia(ctx: Koa.Context) {\n \t} catch (e) {\n \t\tserverLogger.error(e);\n \n-\t\tif (typeof e == 'number' && e >= 400 && e < 500) {\n-\t\t\tctx.status = e;\n+\t\tif (typeof e.statusCode === 'number' && e.statusCode >= 400 && e.statusCode < 500) {\n+\t\t\tctx.status = e.statusCode;\n \t\t} else {\n \t\t\tctx.status = 500;\n \t\t}"
        },
        {
          "filename": "yarn.lock",
          "status": "modified",
          "additions": 44,
          "deletions": 0,
          "patch": "@@ -5742,6 +5742,27 @@ ioredis@^4.27.0:\n     redis-parser \"^3.0.0\"\n     standard-as-callback \"^2.1.0\"\n \n+ip-address@^7.1.0:\n+  version \"7.1.0\"\n+  resolved \"https://registry.yarnpkg.com/ip-address/-/ip-address-7.1.0.tgz#4a9c699e75b51cbeb18b38de8ed216efa1a490c5\"\n+  integrity sha512-V9pWC/VJf2lsXqP7IWJ+pe3P1/HCYGBMZrrnT62niLGjAfCbeiwXMUxaeHvnVlz19O27pvXP4azs+Pj/A0x+SQ==\n+  dependencies:\n+    jsbn \"1.1.0\"\n+    sprintf-js \"1.1.2\"\n+\n+ip-cidr@3.0.4:\n+  version \"3.0.4\"\n+  resolved \"https://registry.yarnpkg.com/ip-cidr/-/ip-cidr-3.0.4.tgz#a915c47e00f47ea8d5f8ed662ea6161471c44375\"\n+  integrity sha512-pKNiqmBlTvEkhaLAa3+FOmYSY0/jjADVxxjA3NbujZZTT8mjLI90Q+6mwg6kd0fNm0RuAOkWJ1u1a/ETmlrPNQ==\n+  dependencies:\n+    ip-address \"^7.1.0\"\n+    jsbn \"^1.1.0\"\n+\n+ip-regex@^4.3.0:\n+  version \"4.3.0\"\n+  resolved \"https://registry.yarnpkg.com/ip-regex/-/ip-regex-4.3.0.tgz#687275ab0f57fa76978ff8f4dddc8a23d5990db5\"\n+  integrity sha512-B9ZWJxHHOHUhUjCPrMpLD4xEq35bUTClHM1S6CBU5ixQnkZmwipwgc96vAd7AAGM9TGHvJR+Uss+/Ak6UphK+Q==\n+\n ip@^1.1.5:\n   version \"1.1.5\"\n   resolved \"https://registry.yarnpkg.com/ip/-/ip-1.1.5.tgz#bdded70114290828c0a039e72ef25f5aaec4354a\"\n@@ -6238,6 +6259,11 @@ js-yaml@~3.7.0:\n     argparse \"^1.0.7\"\n     esprima \"^2.6.0\"\n \n+jsbn@1.1.0, jsbn@^1.1.0:\n+  version \"1.1.0\"\n+  resolved \"https://registry.yarnpkg.com/jsbn/-/jsbn-1.1.0.tgz#b01307cb29b618a1ed26ec79e911f803c4da0040\"\n+  integrity sha1-sBMHyym2GKHtJux56RH4A8TaAEA=\n+\n jsbn@~0.1.0:\n   version \"0.1.1\"\n   resolved \"https://registry.yarnpkg.com/jsbn/-/jsbn-0.1.1.tgz#a5e654c2e5a2deb5f201d96cefbca80c0ef2f513\"\n@@ -7440,6 +7466,11 @@ nested-property@4.0.0:\n   resolved \"https://registry.yarnpkg.com/nested-property/-/nested-property-4.0.0.tgz#a67b5a31991e701e03cdbaa6453bc5b1011bb88d\"\n   integrity sha512-yFehXNWRs4cM0+dz7QxCd06hTbWbSkV0ISsqBfkntU6TOY4Qm3Q88fRRLOddkGh2Qq6dZvnKVAahfhjcUvLnyA==\n \n+netmask@^2.0.2:\n+  version \"2.0.2\"\n+  resolved \"https://registry.yarnpkg.com/netmask/-/netmask-2.0.2.tgz#8b01a07644065d536383835823bc52004ebac5e7\"\n+  integrity sha512-dBpDMdxv9Irdq66304OLfEmQ9tbNRFnFTuZiLo+bD+r332bBmMJ8GBLXklIXXgxd3+v9+KUnZaUR5PJMa75Gsg==\n+\n next-line@^1.1.0:\n   version \"1.1.0\"\n   resolved \"https://registry.yarnpkg.com/next-line/-/next-line-1.1.0.tgz#fcae57853052b6a9bae8208e40dd7d3c2d304603\"\n@@ -8861,6 +8892,14 @@ prismjs@1.24.1:\n   resolved \"https://registry.yarnpkg.com/prismjs/-/prismjs-1.24.1.tgz#c4d7895c4d6500289482fa8936d9cdd192684036\"\n   integrity sha512-mNPsedLuk90RVJioIky8ANZEwYm5w9LcvCXrxHlwf4fNVSn8jEipMybMkWUyyF0JhnC+C4VcOVSBuHRKs1L5Ow==\n \n+private-ip@2.2.1:\n+  version \"2.2.1\"\n+  resolved \"https://registry.yarnpkg.com/private-ip/-/private-ip-2.2.1.tgz#4fe167d04e12eca5c67cdcbd3224e86b38c79253\"\n+  integrity sha512-jN1WT/br/VNW9xEcwHr6DjtOKxQ5qOIqmh7o+co2TWgq56pZJw99iO3UT1tWdfgsQiyK9FqG4ji3ykwpjFqITA==\n+  dependencies:\n+    ip-regex \"^4.3.0\"\n+    netmask \"^2.0.2\"\n+\n probe-image-size@7.2.1:\n   version \"7.2.1\"\n   resolved \"https://registry.yarnpkg.com/probe-image-size/-/probe-image-size-7.2.1.tgz#df0c924e67e247bc94f8fcb0fad7f0081061fc44\"\n@@ -10103,6 +10142,11 @@ split@^1.0.0:\n   dependencies:\n     through \"2\"\n \n+sprintf-js@1.1.2:\n+  version \"1.1.2\"\n+  resolved \"https://registry.yarnpkg.com/sprintf-js/-/sprintf-js-1.1.2.tgz#da1765262bf8c0f571749f2ad6c26300207ae673\"\n+  integrity sha512-VE0SOVEHCk7Qc8ulkWw3ntAzXuqf7S2lvwQaDLRnUeIEaKNQJzV6BwmLKhOqT61aGhfUMrXeaBk+oDGCzvhcug==\n+\n sprintf-js@~1.0.2:\n   version \"1.0.3\"\n   resolved \"https://registry.yarnpkg.com/sprintf-js/-/sprintf-js-1.0.3.tgz#04e6926f662895354f3dd015203633b857297e2c\""
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 3,
        "dependency_files": 1,
        "test_files": 0,
        "unique_directories": 6,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "9760f3d7c9113f5436732bf6d6e454b253061b1d",
            "date": "2025-01-14T13:49:59Z",
            "author_login": "tai-cha"
          },
          {
            "sha": "87cdbaea4fa0955bf217fa6d4cf5bd420ada73eb",
            "date": "2025-01-14T13:28:06Z",
            "author_login": "github-actions[bot]"
          },
          {
            "sha": "1b47e2d4f2e7435a2b4eddef50828f0b7cc7ca15",
            "date": "2025-01-14T13:28:00Z",
            "author_login": "github-actions[bot]"
          },
          {
            "sha": "d018fe58aa91eb702b098df659f23f9a981f4368",
            "date": "2025-01-14T13:06:39Z",
            "author_login": "dahlia"
          },
          {
            "sha": "f45fd01551fb283604297e4c94cca4d04ebf03aa",
            "date": "2025-01-14T12:49:35Z",
            "author_login": "samunohito"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 7.7,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:N/A:N",
    "cwe_id": "CWE-918",
    "description": "Misskey is an open source, decentralized microblogging platform. In affected versions a Server-Side Request Forgery vulnerability exists in \"Upload from URL\" and remote attachment handling. This could result in the disclosure of non-public information within the internal network. This has been fixed in 12.90.0. However, if you are using a proxy, you will need to take additional measures. As a workaround this exploit may be avoided by appropriately restricting access to private networks from the host where the application is running.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2021-09-07T19:15:08.600",
    "last_modified": "2024-11-21T06:18:51.590",
    "fix_date": "2021-09-03T12:00:44Z"
  },
  "references": [
    {
      "url": "https://github.com/misskey-dev/misskey/blob/develop/CHANGELOG.md#12900-20210904",
      "source": "security-advisories@github.com",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/misskey-dev/misskey/commit/e1a8b158e04ad567d92d8daf3cc0898ee18f1a2e",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/misskey-dev/misskey/security/advisories/GHSA-mqv7-gxh4-r5vf",
      "source": "security-advisories@github.com",
      "tags": [
        "Issue Tracking",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/misskey-dev/misskey/blob/develop/CHANGELOG.md#12900-20210904",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/misskey-dev/misskey/commit/e1a8b158e04ad567d92d8daf3cc0898ee18f1a2e",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/misskey-dev/misskey/security/advisories/GHSA-mqv7-gxh4-r5vf",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Issue Tracking",
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:05.139713",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "misskey",
    "owner": "misskey-dev",
    "created_at": "2016-12-25T13:16:07Z",
    "updated_at": "2025-01-14T13:28:10Z",
    "pushed_at": "2025-01-14T13:28:07Z",
    "size": 163993,
    "stars": 10240,
    "forks": 1398,
    "open_issues": 2259,
    "watchers": 10240,
    "has_security_policy": false,
    "default_branch": "develop",
    "protected_branches": [],
    "languages": {
      "TypeScript": 5535094,
      "Vue": 2400709,
      "JavaScript": 550003,
      "SCSS": 24017,
      "Pug": 20568,
      "CSS": 5581,
      "Dockerfile": 4843,
      "HTML": 4126,
      "Shell": 1827,
      "Smarty": 1782,
      "MDX": 575,
      "Procfile": 35
    },
    "commit_activity": {
      "total_commits_last_year": 1573,
      "avg_commits_per_week": 30.25,
      "days_active_last_year": 229
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "agpl-3.0"
    },
    "collected_at": "2025-01-14T13:33:01.563786"
  }
}