{
  "cve_id": "CVE-2021-3944",
  "github_data": {
    "repository": "bookstackapp/bookstack",
    "fix_commit": "88e6f93abf54192a69cc8080e0dc6516ee68ccbb",
    "related_commits": [
      "88e6f93abf54192a69cc8080e0dc6516ee68ccbb",
      "88e6f93abf54192a69cc8080e0dc6516ee68ccbb"
    ],
    "patch_url": "https://github.com/bookstackapp/bookstack/commit/88e6f93abf54192a69cc8080e0dc6516ee68ccbb.patch",
    "fix_commit_details": {
      "sha": "88e6f93abf54192a69cc8080e0dc6516ee68ccbb",
      "commit_date": "2021-11-15T10:50:28Z",
      "author": {
        "login": "ssddanbrown",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Prevented auto-login from direct email confirmation actions",
        "length": 368,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 23,
        "additions": 9,
        "deletions": 14
      },
      "files": [
        {
          "filename": "app/Http/Controllers/Auth/ConfirmEmailController.php",
          "status": "modified",
          "additions": 1,
          "deletions": 2,
          "patch": "@@ -79,9 +79,8 @@ public function confirm(string $token)\n \n         $this->emailConfirmationService->deleteByUser($user);\n         $this->showSuccessNotification(trans('auth.email_confirm_success'));\n-        $this->loginService->login($user, auth()->getDefaultDriver());\n \n-        return redirect('/');\n+        return redirect('/login');\n     }\n \n     /**"
        },
        {
          "filename": "app/Http/Controllers/Auth/UserInviteController.php",
          "status": "modified",
          "additions": 3,
          "deletions": 7,
          "patch": "@@ -2,7 +2,6 @@\n \n namespace BookStack\\Http\\Controllers\\Auth;\n \n-use BookStack\\Auth\\Access\\LoginService;\n use BookStack\\Auth\\Access\\UserInviteService;\n use BookStack\\Auth\\UserRepo;\n use BookStack\\Exceptions\\UserTokenExpiredException;\n@@ -16,19 +15,17 @@\n class UserInviteController extends Controller\n {\n     protected $inviteService;\n-    protected $loginService;\n     protected $userRepo;\n \n     /**\n      * Create a new controller instance.\n      */\n-    public function __construct(UserInviteService $inviteService, LoginService $loginService, UserRepo $userRepo)\n+    public function __construct(UserInviteService $inviteService, UserRepo $userRepo)\n     {\n         $this->middleware('guest');\n         $this->middleware('guard:standard');\n \n         $this->inviteService = $inviteService;\n-        $this->loginService = $loginService;\n         $this->userRepo = $userRepo;\n     }\n \n@@ -73,10 +70,9 @@ public function setPassword(Request $request, string $token)\n         $user->save();\n \n         $this->inviteService->deleteByUser($user);\n-        $this->showSuccessNotification(trans('auth.user_invite_success', ['appName' => setting('app-name')]));\n-        $this->loginService->login($user, auth()->getDefaultDriver());\n+        $this->showSuccessNotification(trans('auth.user_invite_success_login', ['appName' => setting('app-name')]));\n \n-        return redirect('/');\n+        return redirect('/login');\n     }\n \n     /**"
        },
        {
          "filename": "resources/lang/en/auth.php",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -54,7 +54,7 @@\n     'email_confirm_text' => 'Please confirm your email address by clicking the button below:',\n     'email_confirm_action' => 'Confirm Email',\n     'email_confirm_send_error' => 'Email confirmation required but the system could not send the email. Contact the admin to ensure email is set up correctly.',\n-    'email_confirm_success' => 'Your email has been confirmed!',\n+    'email_confirm_success' => 'Your email has been confirmed! You should now be able to login using this email address.',\n     'email_confirm_resent' => 'Confirmation email resent, Please check your inbox.',\n \n     'email_not_confirmed' => 'Email Address Not Confirmed',\n@@ -71,7 +71,7 @@\n     'user_invite_page_welcome' => 'Welcome to :appName!',\n     'user_invite_page_text' => 'To finalise your account and gain access you need to set a password which will be used to log-in to :appName on future visits.',\n     'user_invite_page_confirm_button' => 'Confirm Password',\n-    'user_invite_success' => 'Password set, you now have access to :appName!',\n+    'user_invite_success_login' => 'Password set, you should now be able to login using your set password to access :appName!',\n \n     // Multi-factor Authentication\n     'mfa_setup' => 'Setup Multi-Factor Authentication',"
        },
        {
          "filename": "tests/Auth/AuthTest.php",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -131,8 +131,8 @@ public function test_confirmed_registration()\n         });\n \n         // Check confirmation email confirmation activation.\n-        $this->get('/register/confirm/' . $emailConfirmation->token)->assertRedirect('/');\n-        $this->get('/')->assertSee($user->name);\n+        $this->get('/register/confirm/' . $emailConfirmation->token)->assertRedirect('/login');\n+        $this->get('/login')->assertSee('Your email has been confirmed! You should now be able to login using this email address.');\n         $this->assertDatabaseMissing('email_confirmations', ['token' => $emailConfirmation->token]);\n         $this->assertDatabaseHas('users', ['name' => $dbUser->name, 'email' => $dbUser->email, 'email_confirmed' => true]);\n     }"
        },
        {
          "filename": "tests/Auth/UserInviteTest.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -52,7 +52,7 @@ public function test_invite_set_password()\n         $setPasswordResp = $this->followingRedirects()->post('/register/invite/' . $token, [\n             'password' => 'my test password',\n         ]);\n-        $setPasswordResp->assertSee('Password set, you now have access to BookStack!');\n+        $setPasswordResp->assertSee('Password set, you should now be able to login using your set password to access BookStack!');\n         $newPasswordValid = auth()->validate([\n             'email'    => $user->email,\n             'password' => 'my test password',"
        }
      ],
      "file_patterns": {
        "security_files": 5,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 2,
        "unique_directories": 3,
        "max_directory_depth": 4
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "786a434c03faa996e630f4a0a523567d3b093f43",
            "date": "2025-01-14T14:56:43Z",
            "author_login": "ssddanbrown"
          },
          {
            "sha": "25c4f4b02ba06f66f5239de48ae005f895146f8d",
            "date": "2025-01-14T14:53:10Z",
            "author_login": "ssddanbrown"
          },
          {
            "sha": "481580be172a4813ee98ad1b945d12d731e71cdb",
            "date": "2025-01-13T16:51:07Z",
            "author_login": "ssddanbrown"
          },
          {
            "sha": "593645acfe8521db97d7469c92546c8529703969",
            "date": "2025-01-13T14:30:53Z",
            "author_login": "ssddanbrown"
          },
          {
            "sha": "b9751807e7bad4b7d477b6977f630881f730abad",
            "date": "2025-01-13T13:27:32Z",
            "author_login": "ssddanbrown"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.8,
    "cvss_vector": "CVSS:3.1/AV:N/AC:H/PR:N/UI:R/S:U/C:H/I:H/A:N",
    "cwe_id": "CWE-352",
    "description": "bookstack is vulnerable to Cross-Site Request Forgery (CSRF)",
    "attack_vector": "NETWORK",
    "attack_complexity": "HIGH"
  },
  "temporal_data": {
    "published_date": "2021-12-02T17:15:08.140",
    "last_modified": "2024-11-21T06:23:12.700",
    "fix_date": "2021-11-15T10:50:28Z"
  },
  "references": [
    {
      "url": "https://github.com/bookstackapp/bookstack/commit/88e6f93abf54192a69cc8080e0dc6516ee68ccbb",
      "source": "security@huntr.dev",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/65551490-5ade-49aa-8b8d-274c2ca9fdc9",
      "source": "security@huntr.dev",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/bookstackapp/bookstack/commit/88e6f93abf54192a69cc8080e0dc6516ee68ccbb",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/65551490-5ade-49aa-8b8d-274c2ca9fdc9",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:34.815957",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "BookStack",
    "owner": "bookstackapp",
    "created_at": "2015-08-29T10:26:44Z",
    "updated_at": "2025-01-14T12:14:34Z",
    "pushed_at": "2025-01-13T20:16:47Z",
    "size": 41179,
    "stars": 15786,
    "forks": 1978,
    "open_issues": 598,
    "watchers": 15786,
    "has_security_policy": false,
    "default_branch": "development",
    "protected_branches": [
      "release"
    ],
    "languages": {
      "PHP": 7963438,
      "TypeScript": 1856418,
      "Blade": 444101,
      "JavaScript": 287858,
      "SCSS": 139395,
      "Dockerfile": 1282,
      "Shell": 347
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-14T13:05:28.288711"
  }
}