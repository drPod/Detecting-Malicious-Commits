{
  "cve_id": "CVE-2021-40516",
  "github_data": {
    "repository": "weechat/weechat",
    "fix_commit": "8b1331f98de1714bae15a9ca2e2b393ba49d735b",
    "related_commits": [
      "8b1331f98de1714bae15a9ca2e2b393ba49d735b",
      "8b1331f98de1714bae15a9ca2e2b393ba49d735b"
    ],
    "patch_url": "https://github.com/weechat/weechat/commit/8b1331f98de1714bae15a9ca2e2b393ba49d735b.patch",
    "fix_commit_details": {
      "sha": "8b1331f98de1714bae15a9ca2e2b393ba49d735b",
      "commit_date": "2021-09-04T09:39:22Z",
      "author": {
        "login": "flashcode",
        "type": "User",
        "stats": {
          "total_commits": 11530,
          "average_weekly_commits": 10.35938903863432,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 1034
        }
      },
      "commit_message": {
        "title": "relay: fix crash when decoding a malformed websocket frame",
        "length": 58,
        "has_description": false,
        "references_issue": true
      },
      "stats": {
        "total": 27,
        "additions": 20,
        "deletions": 7
      },
      "files": [
        {
          "filename": "ChangeLog.adoc",
          "status": "modified",
          "additions": 7,
          "deletions": 0,
          "patch": "@@ -15,6 +15,13 @@ https://weechat.org/files/releasenotes/ReleaseNotes-devel.html[release notes]\n (file _ReleaseNotes.adoc_ in sources).\n \n \n+[[v3.2.1]]\n+== Version 3.2.1 (under dev)\n+\n+Bug fixes::\n+\n+  * relay: fix crash when decoding a malformed websocket frame\n+\n [[v3.2]]\n == Version 3.2 (2021-06-13)\n "
        },
        {
          "filename": "src/plugins/relay/relay-websocket.c",
          "status": "modified",
          "additions": 11,
          "deletions": 5,
          "patch": "@@ -278,7 +278,7 @@ relay_websocket_decode_frame (const unsigned char *buffer,\n     index_buffer = 0;\n \n     /* loop to decode all frames in message */\n-    while (index_buffer + 2 <= buffer_length)\n+    while (index_buffer + 1 < buffer_length)\n     {\n         opcode = buffer[index_buffer] & 15;\n \n@@ -293,10 +293,12 @@ relay_websocket_decode_frame (const unsigned char *buffer,\n         length_frame_size = 1;\n         length_frame = buffer[index_buffer + 1] & 127;\n         index_buffer += 2;\n+        if (index_buffer >= buffer_length)\n+            return 0;\n         if ((length_frame == 126) || (length_frame == 127))\n         {\n             length_frame_size = (length_frame == 126) ? 2 : 8;\n-            if (buffer_length < 1 + length_frame_size)\n+            if (index_buffer + length_frame_size > buffer_length)\n                 return 0;\n             length_frame = 0;\n             for (i = 0; i < length_frame_size; i++)\n@@ -306,10 +308,9 @@ relay_websocket_decode_frame (const unsigned char *buffer,\n             index_buffer += length_frame_size;\n         }\n \n-        if (buffer_length < 1 + length_frame_size + 4 + length_frame)\n-            return 0;\n-\n         /* read masks (4 bytes) */\n+        if (index_buffer + 4 > buffer_length)\n+            return 0;\n         int masks[4];\n         for (i = 0; i < 4; i++)\n         {\n@@ -333,6 +334,11 @@ relay_websocket_decode_frame (const unsigned char *buffer,\n         *decoded_length += 1;\n \n         /* decode data using masks */\n+        if ((length_frame > buffer_length)\n+            || (index_buffer + length_frame > buffer_length))\n+        {\n+            return 0;\n+        }\n         for (i = 0; i < length_frame; i++)\n         {\n             decoded[*decoded_length + i] = (int)((unsigned char)buffer[index_buffer + i]) ^ masks[i % 4];"
        },
        {
          "filename": "version.sh",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -33,8 +33,8 @@\n #\n \n WEECHAT_STABLE=3.2\n-WEECHAT_DEVEL=3.2\n-WEECHAT_DEVEL_FULL=3.2\n+WEECHAT_DEVEL=3.2.1\n+WEECHAT_DEVEL_FULL=3.2.1-dev\n \n if [ $# -lt 1 ]; then\n     echo >&2 \"Syntax: $0 stable|devel|devel-full|devel-major|devel-minor|devel-patch\""
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 2,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "1285a7d391536e17211cdfee21d5eac2f29f2100",
            "date": "2025-01-08T20:47:01Z",
            "author_login": "weechatter"
          },
          {
            "sha": "36b62cfc5efad4240ef4f56cc28c5e2bc3e81c10",
            "date": "2025-01-07T19:35:35Z",
            "author_login": "flashcode"
          },
          {
            "sha": "d97fed80cb5ba471c8d2edb73c616754bf5a90fa",
            "date": "2025-01-07T18:24:18Z",
            "author_login": "weechatter"
          },
          {
            "sha": "80ca209e70fa07161dd62428c1ec0d261b9b5933",
            "date": "2025-01-07T16:36:39Z",
            "author_login": "flashcode"
          },
          {
            "sha": "d3022947238957ead139094ce0450621ae5886fb",
            "date": "2025-01-07T06:52:09Z",
            "author_login": "flashcode"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 7.5,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H",
    "cwe_id": "CWE-125",
    "description": "WeeChat before 3.2.1 allows remote attackers to cause a denial of service (crash) via a crafted WebSocket frame that trigger an out-of-bounds read in plugins/relay/relay-websocket.c in the Relay plugin.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2021-09-05T18:15:07.260",
    "last_modified": "2024-11-21T06:24:17.847",
    "fix_date": "2021-09-04T09:39:22Z"
  },
  "references": [
    {
      "url": "https://github.com/weechat/weechat/commit/8b1331f98de1714bae15a9ca2e2b393ba49d735b",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2021/09/msg00018.html",
      "source": "cve@mitre.org",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://weechat.org/doc/security/",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/weechat/weechat/commit/8b1331f98de1714bae15a9ca2e2b393ba49d735b",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2021/09/msg00018.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://weechat.org/doc/security/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:05.132056",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "weechat",
    "owner": "weechat",
    "created_at": "2014-03-03T08:08:02Z",
    "updated_at": "2025-01-11T17:06:21Z",
    "pushed_at": "2025-01-11T09:33:47Z",
    "size": 243956,
    "stars": 3011,
    "forks": 333,
    "open_issues": 428,
    "watchers": 3011,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [
      "main"
    ],
    "languages": {
      "C": 10032646,
      "C++": 2140831,
      "Python": 205278,
      "CMake": 137199,
      "Shell": 27681,
      "PHP": 15699,
      "Makefile": 1174
    },
    "commit_activity": {
      "total_commits_last_year": 944,
      "avg_commits_per_week": 18.153846153846153,
      "days_active_last_year": 217
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "gpl-3.0"
    },
    "collected_at": "2025-01-14T15:36:30.289058"
  }
}