{
  "cve_id": "CVE-2021-41148",
  "github_data": {
    "repository": "Enalean/tuleap",
    "fix_commit": "91535add59f4b3a04b6b8eab123c002cd5af180d",
    "related_commits": [
      "91535add59f4b3a04b6b8eab123c002cd5af180d",
      "91535add59f4b3a04b6b8eab123c002cd5af180d"
    ],
    "patch_url": "https://github.com/Enalean/tuleap/commit/91535add59f4b3a04b6b8eab123c002cd5af180d.patch",
    "fix_commit_details": {
      "sha": "91535add59f4b3a04b6b8eab123c002cd5af180d",
      "commit_date": "2020-06-26T13:27:50Z",
      "author": {
        "login": "LeSuisse",
        "type": "User",
        "stats": {
          "total_commits": 13553,
          "average_weekly_commits": 13.158252427184467,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 479
        }
      },
      "commit_message": {
        "title": "request #15028: The update of the CI job targeted by a widget is vulnerable to blind SQL injections",
        "length": 153,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 56,
        "additions": 37,
        "deletions": 19
      },
      "files": [
        {
          "filename": "plugins/hudson/include/HudsonJobWidget.class.php",
          "status": "modified",
          "additions": 37,
          "deletions": 19,
          "patch": "@@ -42,17 +42,29 @@ public function create(Codendi_Request $request)\n         $vId->required();\n         if ($request->valid($vId)) {\n             $job_id = $request->get($this->widget_id . '_job_id');\n-            $sql = 'INSERT INTO plugin_hudson_widget (widget_name, owner_id, owner_type, job_id) VALUES (\"' . $this->id . '\", ' . $this->owner_id . \", '\" . $this->owner_type . \"', \" . db_escape_int($job_id) . \" )\";\n-            $res = db_query($sql);\n-            $content_id = db_insertid($res);\n+            $db = \\Tuleap\\DB\\DBFactory::getMainTuleapDBConnection()->getDB();\n+            $content_id = (int) $db->insertReturnId(\n+                'plugin_hudson_widget',\n+                [\n+                    'widget_name' => $this->id,\n+                    'owner_id'    => $this->owner_id,\n+                    'owner_type'  => $this->owner_type,\n+                    'job_id'      => $job_id\n+                ]\n+            );\n         }\n         return $content_id;\n     }\n \n     public function destroy($id)\n     {\n-        $sql = 'DELETE FROM plugin_hudson_widget WHERE id = ' . $id . ' AND owner_id = ' . $this->owner_id . \" AND owner_type = '\" . $this->owner_type . \"'\";\n-        db_query($sql);\n+        $db = \\Tuleap\\DB\\DBFactory::getMainTuleapDBConnection()->getDB();\n+        $db->run(\n+            'DELETE FROM plugin_hudson_widget WHERE id = ? AND owner_id = ? AND owner_type = ?',\n+            $id,\n+            $this->owner_id,\n+            $this->owner_type,\n+        );\n     }\n \n     public function getPreferences($widget_id)\n@@ -120,8 +132,14 @@ public function updatePreferences(Codendi_Request $request)\n         $request->valid(new Valid_String('cancel'));\n         if (!$request->exist('cancel')) {\n             $job_id = $request->get($this->widget_id . '_job_id');\n-            $sql = \"UPDATE plugin_hudson_widget SET job_id=\" . $job_id . \" WHERE owner_id = \" . $this->owner_id . \" AND owner_type = '\" . $this->owner_type . \"' AND id = \" . (int) $request->get('content_id');\n-            $res = db_query($sql);\n+            $db = \\Tuleap\\DB\\DBFactory::getMainTuleapDBConnection()->getDB();\n+            $db->run(\n+                'UPDATE plugin_hudson_widget SET job_id=? WHERE owner_id = ? AND owner_type = ? AND id = ?',\n+                $job_id,\n+                $this->owner_id,\n+                $this->owner_type,\n+                $this->content_id,\n+            );\n         }\n         return true;\n     }\n@@ -133,19 +151,19 @@ abstract protected function initContent();\n      */\n     protected function getJobIdFromWidgetConfiguration()\n     {\n-        $sql = \"SELECT *\n-                    FROM plugin_hudson_widget\n-                    WHERE widget_name = '\" . db_es($this->widget_id) . \"'\n-                      AND owner_id = \" . db_ei($this->owner_id) . \"\n-                      AND owner_type = '\" . db_es($this->owner_type) . \"'\n-                      AND id = \" . db_ei($this->content_id);\n-\n-        $res = db_query($sql);\n-        if ($res && db_numrows($res)) {\n-            $data   = db_fetch_array($res);\n-            return $data['job_id'];\n+        $db = \\Tuleap\\DB\\DBFactory::getMainTuleapDBConnection()->getDB();\n+        $job_id = $db->cell(\n+            'SELECT job_id FROM plugin_hudson_widget WHERE widget_name = ? AND owner_id = ? AND owner_type = ? AND id = ?',\n+            $this->widget_id,\n+            $this->owner_id,\n+            $this->owner_type,\n+            $this->content_id,\n+        );\n+\n+        if ($job_id === false) {\n+            return null;\n         }\n \n-        return null;\n+        return $job_id;\n     }\n }"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 1,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "33818218db54e2a64bf71772ac19c612b3ba406a",
            "date": "2025-01-14T09:19:45Z",
            "author_login": "magarnier"
          },
          {
            "sha": "21ae31523ebd4ca66b0531c89d96bbe31b986ee7",
            "date": "2025-01-14T09:19:35Z",
            "author_login": "magarnier"
          },
          {
            "sha": "c111778a4d3adabe2f1c789e7a2bc4cede14e277",
            "date": "2025-01-14T08:27:55Z",
            "author_login": "Gashmob"
          },
          {
            "sha": "a0664bc32c0ddf98f0b9a50d84b5a0fd228f5b64",
            "date": "2025-01-14T08:27:48Z",
            "author_login": "Gashmob"
          },
          {
            "sha": "63581b83f170249fb815ffc1b4325274d2577abf",
            "date": "2025-01-14T08:09:17Z",
            "author_login": "magarnier"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 8.8,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H",
    "cwe_id": "CWE-89",
    "description": "Tuleap Open ALM is a libre and open source tool for end to end traceability of application and system developments. Prior to version 11.16.99.173 of Community Edition and versions 11.16-6 and 11.15-8 of Enterprise Edition, an attacker with the ability to add one the CI widget to its personal dashboard could execute arbitrary SQL queries. Tuleap Community Edition 11.16.99.173, Tuleap Enterprise Edition 11.16-6, and Tuleap Enterprise Edition 11.15-8 contain a patch for this issue.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2021-10-15T14:15:08.307",
    "last_modified": "2024-11-21T06:25:35.867",
    "fix_date": "2020-06-26T13:27:50Z"
  },
  "references": [
    {
      "url": "https://github.com/Enalean/tuleap/commit/91535add59f4b3a04b6b8eab123c002cd5af180d",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/Enalean/tuleap/security/advisories/GHSA-3c4q-8c35-cp63",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://tuleap.net/plugins/git/tuleap/tuleap/stable?a=commit&h=91535add59f4b3a04b6b8eab123c002cd5af180d",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://tuleap.net/plugins/tracker/?aid=15028",
      "source": "security-advisories@github.com",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/Enalean/tuleap/commit/91535add59f4b3a04b6b8eab123c002cd5af180d",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/Enalean/tuleap/security/advisories/GHSA-3c4q-8c35-cp63",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://tuleap.net/plugins/git/tuleap/tuleap/stable?a=commit&h=91535add59f4b3a04b6b8eab123c002cd5af180d",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://tuleap.net/plugins/tracker/?aid=15028",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Vendor Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:31.832328",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "tuleap",
    "owner": "Enalean",
    "created_at": "2012-06-12T15:48:54Z",
    "updated_at": "2025-01-14T09:23:28Z",
    "pushed_at": "2025-01-14T09:23:22Z",
    "size": 382430,
    "stars": 1043,
    "forks": 285,
    "open_issues": 3,
    "watchers": 1043,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "PHP": 64309783,
      "TypeScript": 12164261,
      "JavaScript": 4302645,
      "Vue": 3161023,
      "Mustache": 2174238,
      "SCSS": 1603030,
      "HTML": 502284,
      "CSS": 281155,
      "Shell": 126767,
      "Smarty": 121199,
      "MDX": 89474,
      "Nix": 48015,
      "Go": 44709,
      "Makefile": 41978,
      "Rust": 27741,
      "Groovy": 13947,
      "PEG.js": 12394,
      "Perl": 11384,
      "Dockerfile": 10302,
      "Python": 3977,
      "XSLT": 1077,
      "Awk": 597
    },
    "commit_activity": {
      "total_commits_last_year": 5447,
      "avg_commits_per_week": 104.75,
      "days_active_last_year": 255
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T13:46:56.606881"
  }
}