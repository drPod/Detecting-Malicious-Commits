{
  "cve_id": "CVE-2021-41174",
  "github_data": {
    "repository": "grafana/grafana",
    "fix_commit": "31b78d51c693d828720a5b285107a50e6024c912",
    "related_commits": [
      "31b78d51c693d828720a5b285107a50e6024c912",
      "3cb5214fa45eb5a571fd70d6c6edf0d729983f82",
      "fb85ed691290d211a5baa44d9a641ab137f0de88",
      "31b78d51c693d828720a5b285107a50e6024c912",
      "3cb5214fa45eb5a571fd70d6c6edf0d729983f82",
      "fb85ed691290d211a5baa44d9a641ab137f0de88"
    ],
    "patch_url": "https://github.com/grafana/grafana/commit/31b78d51c693d828720a5b285107a50e6024c912.patch",
    "fix_commit_details": {
      "sha": "31b78d51c693d828720a5b285107a50e6024c912",
      "commit_date": "2021-10-22T14:36:10Z",
      "author": {
        "login": "dsotirakis",
        "type": "User",
        "stats": {
          "total_commits": 434,
          "average_weekly_commits": 0.7469879518072289,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 118
        }
      },
      "commit_message": {
        "title": "Merge pull request #146 from grafana/oscark/sanitize-nav-links",
        "length": 119,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 24,
        "additions": 12,
        "deletions": 12
      },
      "files": [
        {
          "filename": "packages/grafana-data/src/text/index.ts",
          "status": "modified",
          "additions": 2,
          "deletions": 1,
          "patch": "@@ -1,11 +1,12 @@\n export * from './string';\n export * from './markdown';\n export * from './text';\n-import { escapeHtml, hasAnsiCodes, sanitize, sanitizeUrl } from './sanitize';\n+import { escapeHtml, hasAnsiCodes, sanitize, sanitizeUrl, sanitizeAngularInterpolation } from './sanitize';\n \n export const textUtil = {\n   escapeHtml,\n   hasAnsiCodes,\n   sanitize,\n   sanitizeUrl,\n+  sanitizeAngularInterpolation,\n };"
        },
        {
          "filename": "packages/grafana-data/src/text/sanitize.ts",
          "status": "modified",
          "additions": 4,
          "deletions": 0,
          "patch": "@@ -38,3 +38,7 @@ export function hasAnsiCodes(input: string): boolean {\n export function escapeHtml(str: string): string {\n   return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;');\n }\n+\n+export function sanitizeAngularInterpolation(url: string): string {\n+  return url.replace('{{', '%7B%7B').replace('}}', '%7D%7D');\n+}"
        },
        {
          "filename": "public/app/angular/AngularApp.ts",
          "status": "modified",
          "additions": 0,
          "deletions": 6,
          "patch": "@@ -103,12 +103,6 @@ export class AngularApp {\n   }\n \n   bootstrap() {\n-    // Do not initalize angular when the path contains an interpolation directive\n-    const { pathname } = window.location;\n-    if (pathname && (pathname.includes('%7B%7B') || pathname.includes('{{'))) {\n-      return;\n-    }\n-\n     const injector = angular.bootstrap(document, this.ngModuleDependencies);\n \n     monkeyPatchInjectorWithPreAssignedBindings(injector);"
        },
        {
          "filename": "public/app/core/components/NavBar/NavBarItem.tsx",
          "status": "modified",
          "additions": 6,
          "deletions": 5,
          "patch": "@@ -1,6 +1,6 @@\n import React, { ReactNode } from 'react';\n import { css, cx } from '@emotion/css';\n-import { GrafanaTheme2, NavModelItem } from '@grafana/data';\n+import { GrafanaTheme2, NavModelItem, textUtil } from '@grafana/data';\n import { Link, useTheme2 } from '@grafana/ui';\n import NavBarDropdown from './NavBarDropdown';\n \n@@ -34,13 +34,14 @@ const NavBarItem = ({\n       <span className={styles.icon}>{children}</span>\n     </button>\n   );\n+  const sanitizedUrl = textUtil.sanitizeAngularInterpolation(url ?? '');\n \n   if (url) {\n     element =\n-      !target && url.startsWith('/') ? (\n+      !target && sanitizedUrl.startsWith('/') ? (\n         <Link\n           className={styles.element}\n-          href={url}\n+          href={sanitizedUrl}\n           target={target}\n           aria-label={label}\n           onClick={onClick}\n@@ -49,7 +50,7 @@ const NavBarItem = ({\n           <span className={styles.icon}>{children}</span>\n         </Link>\n       ) : (\n-        <a href={url} target={target} className={styles.element} onClick={onClick} aria-label={label}>\n+        <a href={sanitizedUrl} target={target} className={styles.element} onClick={onClick} aria-label={label}>\n           <span className={styles.icon}>{children}</span>\n         </a>\n       );\n@@ -61,7 +62,7 @@ const NavBarItem = ({\n       <NavBarDropdown\n         headerTarget={target}\n         headerText={label}\n-        headerUrl={url}\n+        headerUrl={sanitizedUrl}\n         items={menuItems}\n         onHeaderClick={onClick}\n         reverseDirection={reverseMenuDirection}"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 3,
        "max_directory_depth": 5
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "037570b9c8fc36f2e58949b99166bb887237f639",
            "date": "2025-01-14T14:01:10Z",
            "author_login": "alexanderzobnin"
          },
          {
            "sha": "7c87ff1b84de579e4373ecf59e7e00b9ad951f76",
            "date": "2025-01-14T13:58:36Z",
            "author_login": "leonorfmartins"
          },
          {
            "sha": "2594b4f7aff42712bd0e2b01bea3d3335a7d092f",
            "date": "2025-01-14T13:42:21Z",
            "author_login": "renovate[bot]"
          },
          {
            "sha": "0032e839ceac182e08b5a63c36f4c80365bcc90d",
            "date": "2025-01-14T13:17:49Z",
            "author_login": "renovate[bot]"
          },
          {
            "sha": "6b5146651f873286369b8a288cef27af93431988",
            "date": "2025-01-14T13:16:42Z",
            "author_login": "ashharrison90"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.9,
    "cvss_vector": "CVSS:3.1/AV:N/AC:H/PR:N/UI:R/S:C/C:L/I:H/A:N",
    "cwe_id": "CWE-79",
    "description": "Grafana is an open-source platform for monitoring and observability. In affected versions if an attacker is able to convince a victim to visit a URL referencing a vulnerable page, arbitrary JavaScript content may be executed within the context of the victim's browser. The user visiting the malicious link must be unauthenticated and the link must be for a page that contains the login button in the menu bar. The url has to be crafted to exploit AngularJS rendering and contain the interpolation binding for AngularJS expressions. AngularJS uses double curly braces for interpolation binding: {{ }} ex: {{constructor.constructor(\u2018alert(1)\u2019)()}}. When the user follows the link and the page renders, the login button will contain the original link with a query parameter to force a redirect to the login page. The URL is not validated and the AngularJS rendering engine will execute the JavaScript expression contained in the URL. Users are advised to upgrade as soon as possible. If for some reason you cannot upgrade, you can use a reverse proxy or similar to block access to block the literal string {{ in the path.",
    "attack_vector": "NETWORK",
    "attack_complexity": "HIGH"
  },
  "temporal_data": {
    "published_date": "2021-11-03T18:15:08.413",
    "last_modified": "2024-11-21T06:25:40.410",
    "fix_date": "2021-10-22T14:36:10Z"
  },
  "references": [
    {
      "url": "https://github.com/grafana/grafana/commit/31b78d51c693d828720a5b285107a50e6024c912",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/grafana/grafana/commit/3cb5214fa45eb5a571fd70d6c6edf0d729983f82",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/grafana/grafana/commit/fb85ed691290d211a5baa44d9a641ab137f0de88",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/grafana/grafana/security/advisories/GHSA-3j9m-hcv9-rpj8",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://security.netapp.com/advisory/ntap-20211125-0003/",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/grafana/grafana/commit/31b78d51c693d828720a5b285107a50e6024c912",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/grafana/grafana/commit/3cb5214fa45eb5a571fd70d6c6edf0d729983f82",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/grafana/grafana/commit/fb85ed691290d211a5baa44d9a641ab137f0de88",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/grafana/grafana/security/advisories/GHSA-3j9m-hcv9-rpj8",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://security.netapp.com/advisory/ntap-20211125-0003/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:31.867844",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "grafana",
    "owner": "grafana",
    "created_at": "2013-12-11T15:59:56Z",
    "updated_at": "2025-01-14T13:04:53Z",
    "pushed_at": "2025-01-14T13:12:26Z",
    "size": 1292625,
    "stars": 65883,
    "forks": 12291,
    "open_issues": 4193,
    "watchers": 65883,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [],
    "languages": {
      "TypeScript": 29758164,
      "Go": 20683989,
      "Rich Text Format": 352348,
      "HTML": 334782,
      "CUE": 186863,
      "JavaScript": 170294,
      "Shell": 148477,
      "MDX": 147186,
      "Starlark": 132379,
      "SCSS": 112108,
      "Jsonnet": 39563,
      "Makefile": 24993,
      "Python": 23487,
      "Dockerfile": 21670,
      "Jinja": 11630,
      "HCL": 4097,
      "CSS": 3116,
      "Mustache": 2239,
      "Smarty": 2116,
      "PowerShell": 367,
      "Assembly": 168
    },
    "commit_activity": {
      "total_commits_last_year": 9810,
      "avg_commits_per_week": 188.65384615384616,
      "days_active_last_year": 302
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "agpl-3.0"
    },
    "collected_at": "2025-01-14T13:16:15.724443"
  }
}