{
  "cve_id": "CVE-2021-41252",
  "github_data": {
    "repository": "getkirby/kirby",
    "fix_commit": "25fc5c6b330442e6433c99befc688f3698c5d1fc",
    "related_commits": [
      "25fc5c6b330442e6433c99befc688f3698c5d1fc",
      "25fc5c6b330442e6433c99befc688f3698c5d1fc"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "25fc5c6b330442e6433c99befc688f3698c5d1fc",
      "commit_date": "2021-11-16T09:37:11Z",
      "author": {
        "login": "bastianallgeier",
        "type": "User",
        "stats": {
          "total_commits": 4162,
          "average_weekly_commits": 13.170886075949367,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 244
        }
      },
      "commit_message": {
        "title": "Merge pull request from GHSA-x7j7-qp7j-hw3q",
        "length": 67,
        "has_description": true,
        "references_issue": false
      },
      "stats": {
        "total": 3308,
        "additions": 3270,
        "deletions": 38
      },
      "files": [
        {
          "filename": "cacert.pem",
          "status": "modified",
          "additions": 80,
          "deletions": 22,
          "patch": "@@ -1,7 +1,7 @@\n ##\n ## Bundle of CA Root Certificates\n ##\n-## Certificate data from Mozilla as of: Mon Jul  5 21:35:54 2021 GMT\n+## Certificate data from Mozilla as of: Tue Oct 26 03:12:05 2021 GMT\n ##\n ## This is a bundle of X.509 certificates of public Certificate Authorities\n ## (CA). These were automatically extracted from Mozilla's root certificates\n@@ -14,7 +14,7 @@\n ## Just configure this file as the SSLCACertificateFile.\n ##\n ## Conversion done with mk-ca-bundle.pl version 1.28.\n-## SHA256: c8f6733d1ff4e6a4769c182971a1234f95ae079247a9c439a13423fe8ba5c24f\n+## SHA256: bb36818a81feaa4cca61101e6d6276cd09e972efcb08112dfed846918ca41d7f\n ##\n \n \n@@ -381,26 +381,6 @@ mNEVX58Svnw2Yzi9RKR/5CYrCsSXaQ3pjOLAEFe4yHYSkVXySGnYvCoCWw9E1CAx2/S6cCZdkGCe\n vEsXCS+0yx5DaMkHJ8HSXPfqIbloEpw8nL+e/IBcm2PN7EeqJSdnoDfzAIJ9VNep+OkuE6N36B9K\n -----END CERTIFICATE-----\n \n-DST Root CA X3\n-==============\n------BEGIN CERTIFICATE-----\n-MIIDSjCCAjKgAwIBAgIQRK+wgNajJ7qJMDmGLvhAazANBgkqhkiG9w0BAQUFADA/MSQwIgYDVQQK\n-ExtEaWdpdGFsIFNpZ25hdHVyZSBUcnVzdCBDby4xFzAVBgNVBAMTDkRTVCBSb290IENBIFgzMB4X\n-DTAwMDkzMDIxMTIxOVoXDTIxMDkzMDE0MDExNVowPzEkMCIGA1UEChMbRGlnaXRhbCBTaWduYXR1\n-cmUgVHJ1c3QgQ28uMRcwFQYDVQQDEw5EU1QgUm9vdCBDQSBYMzCCASIwDQYJKoZIhvcNAQEBBQAD\n-ggEPADCCAQoCggEBAN+v6ZdQCINXtMxiZfaQguzH0yxrMMpb7NnDfcdAwRgUi+DoM3ZJKuM/IUmT\n-rE4Orz5Iy2Xu/NMhD2XSKtkyj4zl93ewEnu1lcCJo6m67XMuegwGMoOifooUMM0RoOEqOLl5CjH9\n-UL2AZd+3UWODyOKIYepLYYHsUmu5ouJLGiifSKOeDNoJjj4XLh7dIN9bxiqKqy69cK3FCxolkHRy\n-xXtqqzTWMIn/5WgTe1QLyNau7Fqckh49ZLOMxt+/yUFw7BZy1SbsOFU5Q9D8/RhcQPGX69Wam40d\n-utolucbY38EVAjqr2m7xPi71XAicPNaDaeQQmxkqtilX4+U9m5/wAl0CAwEAAaNCMEAwDwYDVR0T\n-AQH/BAUwAwEB/zAOBgNVHQ8BAf8EBAMCAQYwHQYDVR0OBBYEFMSnsaR7LHH62+FLkHX/xBVghYkQ\n-MA0GCSqGSIb3DQEBBQUAA4IBAQCjGiybFwBcqR7uKGY3Or+Dxz9LwwmglSBd49lZRNI+DT69ikug\n-dB/OEIKcdBodfpga3csTS7MgROSR6cz8faXbauX+5v3gTt23ADq1cEmv8uXrAvHRAosZy5Q6XkjE\n-GB5YGV8eAlrwDPGxrancWYaLbumR9YbK+rlmM6pZW87ipxZzR8srzJmwN0jP41ZL9c8PDHIyh8bw\n-RLtTcm1D9SZImlJnt1ir/md2cXjbDaJWFBM5JDGFoqgCWjBH4d1QB7wCCZAA62RjYJsWvIjJEubS\n-fZGL+T0yjWW06XyxV3bqxbYoOb8VZRzI9neWagqNdwvYkQsEjgfbKbYK7p2CNTUQ\n------END CERTIFICATE-----\n-\n SwissSign Gold CA - G2\n ======================\n -----BEGIN CERTIFICATE-----\n@@ -3172,3 +3152,81 @@ WWRrJ8/vJ8HjJLWG965+Mk2weWjROeiQWMODvA8s1pfrzgzhIMfatz7DP78v3DSk+yshzWePS/Tj\n OPQD8rv7gmsHINFSH5pkAnuYZttcTVoP0ISVoDwUQwbKytu4QTbaakRnh6+v40URFWkIsr4WOZck\n bxJF0WddCajJFdr60qZfE2Efv4WstK2tBZQIgx51F9NxO5NQI1mg7TyRVJ12AMXDuDjb\n -----END CERTIFICATE-----\n+\n+TunTrust Root CA\n+================\n+-----BEGIN CERTIFICATE-----\n+MIIFszCCA5ugAwIBAgIUEwLV4kBMkkaGFmddtLu7sms+/BMwDQYJKoZIhvcNAQELBQAwYTELMAkG\n+A1UEBhMCVE4xNzA1BgNVBAoMLkFnZW5jZSBOYXRpb25hbGUgZGUgQ2VydGlmaWNhdGlvbiBFbGVj\n+dHJvbmlxdWUxGTAXBgNVBAMMEFR1blRydXN0IFJvb3QgQ0EwHhcNMTkwNDI2MDg1NzU2WhcNNDQw\n+NDI2MDg1NzU2WjBhMQswCQYDVQQGEwJUTjE3MDUGA1UECgwuQWdlbmNlIE5hdGlvbmFsZSBkZSBD\n+ZXJ0aWZpY2F0aW9uIEVsZWN0cm9uaXF1ZTEZMBcGA1UEAwwQVHVuVHJ1c3QgUm9vdCBDQTCCAiIw\n+DQYJKoZIhvcNAQEBBQADggIPADCCAgoCggIBAMPN0/y9BFPdDCA61YguBUtB9YOCfvdZn56eY+hz\n+2vYGqU8ftPkLHzmMmiDQfgbU7DTZhrx1W4eI8NLZ1KMKsmwb60ksPqxd2JQDoOw05TDENX37Jk0b\n+bjBU2PWARZw5rZzJJQRNmpA+TkBuimvNKWfGzC3gdOgFVwpIUPp6Q9p+7FuaDmJ2/uqdHYVy7BG7\n+NegfJ7/Boce7SBbdVtfMTqDhuazb1YMZGoXRlJfXyqNlC/M4+QKu3fZnz8k/9YosRxqZbwUN/dAd\n+gjH8KcwAWJeRTIAAHDOFli/LQcKLEITDCSSJH7UP2dl3RxiSlGBcx5kDPP73lad9UKGAwqmDrViW\n+VSHbhlnUr8a83YFuB9tgYv7sEG7aaAH0gxupPqJbI9dkxt/con3YS7qC0lH4Zr8GRuR5KiY2eY8f\n+Tpkdso8MDhz/yV3A/ZAQprE38806JG60hZC/gLkMjNWb1sjxVj8agIl6qeIbMlEsPvLfe/ZdeikZ\n+juXIvTZxi11Mwh0/rViizz1wTaZQmCXcI/m4WEEIcb9PuISgjwBUFfyRbVinljvrS5YnzWuioYas\n+DXxU5mZMZl+QviGaAkYt5IPCgLnPSz7ofzwB7I9ezX/SKEIBlYrilz0QIX32nRzFNKHsLA4KUiwS\n+VXAkPcvCFDVDXSdOvsC9qnyW5/yeYa1E0wCXAgMBAAGjYzBhMB0GA1UdDgQWBBQGmpsfU33x9aTI\n+04Y+oXNZtPdEITAPBgNVHRMBAf8EBTADAQH/MB8GA1UdIwQYMBaAFAaamx9TffH1pMjThj6hc1m0\n+90QhMA4GA1UdDwEB/wQEAwIBBjANBgkqhkiG9w0BAQsFAAOCAgEAqgVutt0Vyb+zxiD2BkewhpMl\n+0425yAA/l/VSJ4hxyXT968pk21vvHl26v9Hr7lxpuhbI87mP0zYuQEkHDVneixCwSQXi/5E/S7fd\n+Ao74gShczNxtr18UnH1YeA32gAm56Q6XKRm4t+v4FstVEuTGfbvE7Pi1HE4+Z7/FXxttbUcoqgRY\n+YdZ2vyJ/0Adqp2RT8JeNnYA/u8EH22Wv5psymsNUk8QcCMNE+3tjEUPRahphanltkE8pjkcFwRJp\n+adbGNjHh/PqAulxPxOu3Mqz4dWEX1xAZufHSCe96Qp1bWgvUxpVOKs7/B9dPfhgGiPEZtdmYu65x\n+xBzndFlY7wyJz4sfdZMaBBSSSFCp61cpABbjNhzI+L/wM9VBD8TMPN3pM0MBkRArHtG5Xc0yGYuP\n+jCB31yLEQtyEFpslbei0VXF/sHyz03FJuc9SpAQ/3D2gu68zngowYI7bnV2UqL1g52KAdoGDDIzM\n+MEZJ4gzSqK/rYXHv5yJiqfdcZGyfFoxnNidF9Ql7v/YQCvGwjVRDjAS6oz/v4jXH+XTgbzRB0L9z\n+ZVcg+ZtnemZoJE6AZb0QmQZZ8mWvuMZHu/2QeItBcy6vVR/cO5JyboTT0GFMDcx2V+IthSIVNg3r\n+AZ3r2OvEhJn7wAzMMujjd9qDRIueVSjAi1jTkD5OGwDxFa2DK5o=\n+-----END CERTIFICATE-----\n+\n+HARICA TLS RSA Root CA 2021\n+===========================\n+-----BEGIN CERTIFICATE-----\n+MIIFpDCCA4ygAwIBAgIQOcqTHO9D88aOk8f0ZIk4fjANBgkqhkiG9w0BAQsFADBsMQswCQYDVQQG\n+EwJHUjE3MDUGA1UECgwuSGVsbGVuaWMgQWNhZGVtaWMgYW5kIFJlc2VhcmNoIEluc3RpdHV0aW9u\n+cyBDQTEkMCIGA1UEAwwbSEFSSUNBIFRMUyBSU0EgUm9vdCBDQSAyMDIxMB4XDTIxMDIxOTEwNTUz\n+OFoXDTQ1MDIxMzEwNTUzN1owbDELMAkGA1UEBhMCR1IxNzA1BgNVBAoMLkhlbGxlbmljIEFjYWRl\n+bWljIGFuZCBSZXNlYXJjaCBJbnN0aXR1dGlvbnMgQ0ExJDAiBgNVBAMMG0hBUklDQSBUTFMgUlNB\n+IFJvb3QgQ0EgMjAyMTCCAiIwDQYJKoZIhvcNAQEBBQADggIPADCCAgoCggIBAIvC569lmwVnlskN\n+JLnQDmT8zuIkGCyEf3dRywQRNrhe7Wlxp57kJQmXZ8FHws+RFjZiPTgE4VGC/6zStGndLuwRo0Xu\n+a2s7TL+MjaQenRG56Tj5eg4MmOIjHdFOY9TnuEFE+2uva9of08WRiFukiZLRgeaMOVig1mlDqa2Y\n+Ulhu2wr7a89o+uOkXjpFc5gH6l8Cct4MpbOfrqkdtx2z/IpZ525yZa31MJQjB/OCFks1mJxTuy/K\n+5FrZx40d/JiZ+yykgmvwKh+OC19xXFyuQnspiYHLA6OZyoieC0AJQTPb5lh6/a6ZcMBaD9YThnEv\n+dmn8kN3bLW7R8pv1GmuebxWMevBLKKAiOIAkbDakO/IwkfN4E8/BPzWr8R0RI7VDIp4BkrcYAuUR\n+0YLbFQDMYTfBKnya4dC6s1BG7oKsnTH4+yPiAwBIcKMJJnkVU2DzOFytOOqBAGMUuTNe3QvboEUH\n+GjMJ+E20pwKmafTCWQWIZYVWrkvL4N48fS0ayOn7H6NhStYqE613TBoYm5EPWNgGVMWX+Ko/IIqm\n+haZ39qb8HOLubpQzKoNQhArlT4b4UEV4AIHrW2jjJo3Me1xR9BQsQL4aYB16cmEdH2MtiKrOokWQ\n+CPxrvrNQKlr9qEgYRtaQQJKQCoReaDH46+0N0x3GfZkYVVYnZS6NRcUk7M7jAgMBAAGjQjBAMA8G\n+A1UdEwEB/wQFMAMBAf8wHQYDVR0OBBYEFApII6ZgpJIKM+qTW8VX6iVNvRLuMA4GA1UdDwEB/wQE\n+AwIBhjANBgkqhkiG9w0BAQsFAAOCAgEAPpBIqm5iFSVmewzVjIuJndftTgfvnNAUX15QvWiWkKQU\n+EapobQk1OUAJ2vQJLDSle1mESSmXdMgHHkdt8s4cUCbjnj1AUz/3f5Z2EMVGpdAgS1D0NTsY9FVq\n+QRtHBmg8uwkIYtlfVUKqrFOFrJVWNlar5AWMxajaH6NpvVMPxP/cyuN+8kyIhkdGGvMA9YCRotxD\n+QpSbIPDRzbLrLFPCU3hKTwSUQZqPJzLB5UkZv/HywouoCjkxKLR9YjYsTewfM7Z+d21+UPCfDtcR\n+j88YxeMn/ibvBZ3PzzfF0HvaO7AWhAw6k9a+F9sPPg4ZeAnHqQJyIkv3N3a6dcSFA1pj1bF1BcK5\n+vZStjBWZp5N99sXzqnTPBIWUmAD04vnKJGW/4GKvyMX6ssmeVkjaef2WdhW+o45WxLM0/L5H9MG0\n+qPzVMIho7suuyWPEdr6sOBjhXlzPrjoiUevRi7PzKzMHVIf6tLITe7pTBGIBnfHAT+7hOtSLIBD6\n+Alfm78ELt5BGnBkpjNxvoEppaZS3JGWg/6w/zgH7IS79aPib8qXPMThcFarmlwDB31qlpzmq6YR/\n+PFGoOtmUW4y/Twhx5duoXNTSpv4Ao8YWxw/ogM4cKGR0GQjTQuPOAF1/sdwTsOEFy9EgqoZ0njnn\n+kf3/W9b3raYvAwtt41dU63ZTGI0RmLo=\n+-----END CERTIFICATE-----\n+\n+HARICA TLS ECC Root CA 2021\n+===========================\n+-----BEGIN CERTIFICATE-----\n+MIICVDCCAdugAwIBAgIQZ3SdjXfYO2rbIvT/WeK/zjAKBggqhkjOPQQDAzBsMQswCQYDVQQGEwJH\n+UjE3MDUGA1UECgwuSGVsbGVuaWMgQWNhZGVtaWMgYW5kIFJlc2VhcmNoIEluc3RpdHV0aW9ucyBD\n+QTEkMCIGA1UEAwwbSEFSSUNBIFRMUyBFQ0MgUm9vdCBDQSAyMDIxMB4XDTIxMDIxOTExMDExMFoX\n+DTQ1MDIxMzExMDEwOVowbDELMAkGA1UEBhMCR1IxNzA1BgNVBAoMLkhlbGxlbmljIEFjYWRlbWlj\n+IGFuZCBSZXNlYXJjaCBJbnN0aXR1dGlvbnMgQ0ExJDAiBgNVBAMMG0hBUklDQSBUTFMgRUNDIFJv\n+b3QgQ0EgMjAyMTB2MBAGByqGSM49AgEGBSuBBAAiA2IABDgI/rGgltJ6rK9JOtDA4MM7KKrxcm1l\n+AEeIhPyaJmuqS7psBAqIXhfyVYf8MLA04jRYVxqEU+kw2anylnTDUR9YSTHMmE5gEYd103KUkE+b\n+ECUqqHgtvpBBWJAVcqeht6NCMEAwDwYDVR0TAQH/BAUwAwEB/zAdBgNVHQ4EFgQUyRtTgRL+BNUW\n+0aq8mm+3oJUZbsowDgYDVR0PAQH/BAQDAgGGMAoGCCqGSM49BAMDA2cAMGQCMBHervjcToiwqfAi\n+rcJRQO9gcS3ujwLEXQNwSaSS6sUUiHCm0w2wqsosQJz76YJumgIwK0eaB8bRwoF8yguWGEEbo/Qw\n+CZ61IygNnxS2PFOiTAZpffpskcYqSUXm7LcT4Tps\n+-----END CERTIFICATE-----"
        },
        {
          "filename": "composer.json",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -8,7 +8,7 @@\n     \"core\"\n   ],\n   \"homepage\": \"https://getkirby.com\",\n-  \"version\": \"3.5.7.1\",\n+  \"version\": \"3.5.8\",\n   \"license\": \"proprietary\",\n   \"authors\": [\n     {"
        },
        {
          "filename": "composer.lock",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -4,7 +4,7 @@\n         \"Read more about it at https://getcomposer.org/doc/01-basic-usage.md#installing-dependencies\",\n         \"This file is @generated automatically\"\n     ],\n-    \"content-hash\": \"c087786719948c60e5d74492f70440a5\",\n+    \"content-hash\": \"039b76eb24f9d5016bc5284c5b366718\",\n     \"packages\": [\n         {\n             \"name\": \"claviska/simpleimage\","
        },
        {
          "filename": "config/blocks/image/image.php",
          "status": "modified",
          "additions": 4,
          "deletions": 4,
          "patch": "@@ -9,7 +9,7 @@\n $src     = null;\n \n if ($block->location() == 'web') {\n-    $src = $block->src();\n+    $src = $block->src()->esc();\n } elseif ($image = $block->image()->toFile()) {\n     $alt = $alt ?? $image->alt();\n     $src = $image->url();\n@@ -19,11 +19,11 @@\n <?php if ($src): ?>\n <figure<?= attr(['data-ratio' => $ratio, 'data-crop' => $crop], ' ') ?>>\n   <?php if ($link->isNotEmpty()): ?>\n-  <a href=\"<?= $link->toUrl() ?>\">\n-    <img src=\"<?= $src ?>\" alt=\"<?= $alt ?>\">\n+  <a href=\"<?= esc($link->toUrl()) ?>\">\n+    <img src=\"<?= $src ?>\" alt=\"<?= $alt->esc() ?>\">\n   </a>\n   <?php else: ?>\n-  <img src=\"<?= $src ?>\" alt=\"<?= $alt ?>\">\n+  <img src=\"<?= $src ?>\" alt=\"<?= $alt->esc() ?>\">\n   <?php endif ?>\n \n   <?php if ($caption->isNotEmpty()): ?>"
        },
        {
          "filename": "config/fields/writer.php",
          "status": "modified",
          "additions": 3,
          "deletions": 1,
          "patch": "@@ -1,5 +1,7 @@\n <?php\n \n+use Kirby\\Sane\\Html;\n+\n return [\n     'props' => [\n         /**\n@@ -27,7 +29,7 @@\n     ],\n     'computed' => [\n         'value' => function () {\n-            return trim($this->value);\n+            return Html::sanitize(trim($this->value));\n         }\n     ],\n ];"
        },
        {
          "filename": "panel/dist/js/app.js",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": null
        },
        {
          "filename": "panel/src/components/Writer/Writer.vue",
          "status": "modified",
          "additions": 15,
          "deletions": 1,
          "patch": "@@ -106,6 +106,7 @@ export default {\n   data() {\n     return {\n       editor: null,\n+      json: {},\n       html: this.value,\n       isEmpty: true,\n       toolbar: false\n@@ -140,7 +141,16 @@ export default {\n           }\n         },\n         update: (payload) => {\n-          this.html    = payload.editor.getHTML();\n+          // compare documents to avoid minor HTML differences\n+          // to cause unwanted updates\n+          const jsonNew = JSON.stringify(this.editor.getJSON());\n+          const jsonOld = JSON.stringify(this.json);\n+\n+          if (jsonNew === jsonOld) {\n+            return;\n+          }\n+\n+          this.json    = jsonNew;\n           this.isEmpty = payload.editor.isEmpty();\n \n           // when a new list item or heading is created, textContent length returns 0\n@@ -156,6 +166,9 @@ export default {\n             this.html = \"\";\n           }\n \n+          // create the final HTML to send to the server\n+          this.html = payload.editor.getHTML();\n+\n           this.$emit(\"input\", this.html);\n         }\n       },\n@@ -172,6 +185,7 @@ export default {\n     });\n \n     this.isEmpty = this.editor.isEmpty();\n+    this.json    = this.editor.getJSON();\n   },\n   beforeDestroy() {\n     this.editor.destroy();"
        },
        {
          "filename": "panel/vite.config.custom.js",
          "status": "added",
          "additions": 11,
          "deletions": 0,
          "patch": "@@ -0,0 +1,11 @@\n+const fs = require(\"fs\");\n+\n+process.env.VUE_APP_DEV_SERVER = \"https://sandbox.kirby.test\";\n+\n+module.exports = {\n+  host: \"sandbox.kirby.test\",\n+  https: {\n+    key: fs.readFileSync('/Users/luX/Library/Application Support/Caddy/certificates/local/sandbox.kirby.test/sandbox.kirby.test.key'),\n+    cert: fs.readFileSync('/Users/luX/Library/Application Support/Caddy/certificates/local/sandbox.kirby.test/sandbox.kirby.test.crt')\n+  }\n+};"
        },
        {
          "filename": "src/Sane/DomHandler.php",
          "status": "added",
          "additions": 165,
          "deletions": 0,
          "patch": "@@ -0,0 +1,165 @@\n+<?php\n+\n+namespace Kirby\\Sane;\n+\n+use DOMAttr;\n+use DOMDocumentType;\n+use DOMElement;\n+use Kirby\\Toolkit\\Dom;\n+\n+/**\n+ * Base class for Sane handlers with DOM file types\n+ * @since 3.5.8\n+ *\n+ * @package   Kirby Sane\n+ * @author    Lukas Bestle <lukas@getkirby.com>\n+ * @link      https://getkirby.com\n+ * @copyright Bastian Allgeier GmbH\n+ * @license   https://opensource.org/licenses/MIT\n+ */\n+class DomHandler extends Handler\n+{\n+    /**\n+     * List of all MIME types that may\n+     * be used in data URIs\n+     *\n+     * @var array\n+     */\n+    public static $allowedDataUris = [\n+        'data:image/png',\n+        'data:image/gif',\n+        'data:image/jpg',\n+        'data:image/jpe',\n+        'data:image/pjp',\n+        'data:img/png',\n+        'data:img/gif',\n+        'data:img/jpg',\n+        'data:img/jpe',\n+        'data:img/pjp',\n+    ];\n+\n+    /**\n+     * Allowed hostnames for HTTP(S) URLs\n+     *\n+     * @var array\n+     */\n+    public static $allowedDomains = [];\n+\n+    /**\n+     * Names of allowed XML processing instructions\n+     *\n+     * @var array\n+     */\n+    public static $allowedPIs = [];\n+\n+    /**\n+     * The document type (`'HTML'` or `'XML'`)\n+     * (to be set in child classes)\n+     *\n+     * @var string\n+     */\n+    protected static $type = 'XML';\n+\n+    /**\n+     * Sanitizes the given string\n+     *\n+     * @param string $string\n+     * @return string\n+     *\n+     * @throws \\Kirby\\Exception\\InvalidArgumentException If the file couldn't be parsed\n+     */\n+    public static function sanitize(string $string): string\n+    {\n+        $dom = static::parse($string);\n+        $dom->sanitize(static::options());\n+        return $dom->toString();\n+    }\n+\n+    /**\n+     * Validates file contents\n+     *\n+     * @param string $string\n+     * @return void\n+     *\n+     * @throws \\Kirby\\Exception\\InvalidArgumentException If the file couldn't be parsed\n+     * @throws \\Kirby\\Exception\\InvalidArgumentException If the file didn't pass validation\n+     */\n+    public static function validate(string $string): void\n+    {\n+        $dom = static::parse($string);\n+        $errors = $dom->sanitize(static::options());\n+        if (count($errors) > 0) {\n+            // there may be multiple errors, we can only throw one of them at a time\n+            throw $errors[0];\n+        }\n+    }\n+\n+    /**\n+     * Custom callback for additional attribute sanitization\n+     * @internal\n+     *\n+     * @param \\DOMAttr $attr\n+     * @return array Array with exception objects for each modification\n+     */\n+    public static function sanitizeAttr(DOMAttr $attr): array\n+    {\n+        // to be extended in child classes\n+        return [];\n+    }\n+\n+    /**\n+     * Custom callback for additional element sanitization\n+     * @internal\n+     *\n+     * @param \\DOMElement $element\n+     * @return array Array with exception objects for each modification\n+     */\n+    public static function sanitizeElement(DOMElement $element): array\n+    {\n+        // to be extended in child classes\n+        return [];\n+    }\n+\n+    /**\n+     * Custom callback for additional doctype validation\n+     * @internal\n+     *\n+     * @param \\DOMDocumentType $doctype\n+     * @return void\n+     */\n+    public static function validateDoctype(DOMDocumentType $doctype): void\n+    {\n+        // to be extended in child classes\n+    }\n+\n+    /**\n+     * Returns the sanitization options for the handler\n+     * (to be extended in child classes)\n+     *\n+     * @return array\n+     */\n+    protected static function options(): array\n+    {\n+        return [\n+            'allowedDataUris' => static::$allowedDataUris,\n+            'allowedDomains'  => static::$allowedDomains,\n+            'allowedPIs'      => static::$allowedPIs,\n+            'attrCallback'    => [static::class, 'sanitizeAttr'],\n+            'doctypeCallback' => [static::class, 'validateDoctype'],\n+            'elementCallback' => [static::class, 'sanitizeElement'],\n+        ];\n+    }\n+\n+    /**\n+     * Parses the given string into a `Toolkit\\Dom` object\n+     *\n+     * @param string $string\n+     * @return \\Kirby\\Toolkit\\Dom\n+     *\n+     * @throws \\Kirby\\Exception\\InvalidArgumentException If the file couldn't be parsed\n+     */\n+    protected static function parse(string $string)\n+    {\n+        return new Dom($string, static::$type);\n+    }\n+}"
        },
        {
          "filename": "src/Sane/Html.php",
          "status": "added",
          "additions": 144,
          "deletions": 0,
          "patch": "@@ -0,0 +1,144 @@\n+<?php\n+\n+namespace Kirby\\Sane;\n+\n+/**\n+ * Sane handler for HTML files\n+ * @since 3.5.8\n+ *\n+ * @package   Kirby Sane\n+ * @author    Bastian Allgeier <bastian@getkirby.com>,\n+ *            Lukas Bestle <lukas@getkirby.com>\n+ * @link      https://getkirby.com\n+ * @copyright Bastian Allgeier GmbH\n+ * @license   https://opensource.org/licenses/MIT\n+ */\n+class Html extends DomHandler\n+{\n+    /**\n+     * Global list of allowed attribute prefixes\n+     *\n+     * @var array\n+     */\n+    public static $allowedAttrPrefixes = [\n+        'aria-',\n+        'data-',\n+    ];\n+\n+    /**\n+     * Global list of allowed attributes\n+     *\n+     * @var array\n+     */\n+    public static $allowedAttrs = [\n+        'class',\n+        'id',\n+    ];\n+\n+    /**\n+     * Allowed hostnames for HTTP(S) URLs\n+     *\n+     * @var array\n+     */\n+    public static $allowedDomains = true;\n+\n+    /**\n+     * Associative array of all allowed tag names with the value\n+     * of either an array with the list of all allowed attributes\n+     * for this tag, `true` to allow any attribute from the\n+     * `allowedAttrs` list or `false` to allow the tag without\n+     * any attributes\n+     *\n+     * @var array\n+     */\n+    public static $allowedTags = [\n+        'a'          => ['href', 'rel', 'title', 'target'],\n+        'abbr'       => ['title'],\n+        'b'          => true,\n+        'body'       => true,\n+        'blockquote' => true,\n+        'br'         => true,\n+        'code'       => true,\n+        'dl'         => true,\n+        'dd'         => true,\n+        'del'        => true,\n+        'div'        => true,\n+        'dt'         => true,\n+        'em'         => true,\n+        'footer'     => true,\n+        'h1'         => true,\n+        'h2'         => true,\n+        'h3'         => true,\n+        'h4'         => true,\n+        'h5'         => true,\n+        'h6'         => true,\n+        'hr'         => true,\n+        'html'       => true,\n+        'i'          => true,\n+        'ins'        => true,\n+        'li'         => true,\n+        'small'      => true,\n+        'span'       => true,\n+        'strong'     => true,\n+        'sub'        => true,\n+        'sup'        => true,\n+        'ol'         => true,\n+        'p'          => true,\n+        'pre'        => true,\n+        's'          => true,\n+        'u'          => true,\n+        'ul'         => true,\n+    ];\n+\n+    /**\n+     * Array of explicitly disallowed tags\n+     *\n+     * IMPORTANT: Use lower-case names here because\n+     * of the case-insensitive matching\n+     *\n+     * @var array\n+     */\n+    public static $disallowedTags = [\n+        'iframe',\n+        'meta',\n+        'object',\n+        'script',\n+        'style',\n+    ];\n+\n+    /**\n+     * List of attributes that may contain URLs\n+     *\n+     * @var array\n+     */\n+    public static $urlAttrs = [\n+        'href',\n+        'src',\n+        'xlink:href',\n+    ];\n+\n+    /**\n+     * The document type (`'HTML'` or `'XML'`)\n+     *\n+     * @var string\n+     */\n+    protected static $type = 'HTML';\n+\n+    /**\n+     * Returns the sanitization options for the handler\n+     *\n+     * @return array\n+     */\n+    protected static function options(): array\n+    {\n+        return array_merge(parent::options(), [\n+            'allowedAttrPrefixes' => static::$allowedAttrPrefixes,\n+            'allowedAttrs'        => static::$allowedAttrs,\n+            'allowedNamespaces'   => [],\n+            'allowedPIs'          => [],\n+            'allowedTags'         => static::$allowedTags,\n+            'disallowedTags'      => static::$disallowedTags,\n+            'urlAttrs'            => static::$urlAttrs,\n+        ]);\n+    }\n+}"
        },
        {
          "filename": "src/Toolkit/Dom.php",
          "status": "added",
          "additions": 920,
          "deletions": 0,
          "patch": "@@ -0,0 +1,920 @@\n+<?php\n+\n+namespace Kirby\\Toolkit;\n+\n+use Closure;\n+use DOMAttr;\n+use DOMDocument;\n+use DOMDocumentType;\n+use DOMElement;\n+use DOMNode;\n+use DOMProcessingInstruction;\n+use DOMXPath;\n+use Kirby\\Cms\\App;\n+use Kirby\\Exception\\Exception;\n+use Kirby\\Exception\\InvalidArgumentException;\n+\n+/**\n+ * Helper class for DOM handling using the DOMDocument class\n+ * @since 3.5.8\n+ *\n+ * @package   Kirby Toolkit\n+ * @author    Bastian Allgeier <bastian@getkirby.com>,\n+ *            Lukas Bestle <lukas@getkirby.com>\n+ * @link      https://getkirby.com\n+ * @copyright Bastian Allgeier GmbH\n+ * @license   https://opensource.org/licenses/MIT\n+ */\n+class Dom\n+{\n+    /**\n+     * Cache for the HTML body\n+     *\n+     * @var \\DOMElement|null\n+     */\n+    protected $body;\n+\n+    /**\n+     * The original input code as\n+     * passed to the constructor\n+     *\n+     * @var string\n+     */\n+    protected $code;\n+\n+    /**\n+     * Document object\n+     *\n+     * @var \\DOMDocument\n+     */\n+    protected $doc;\n+\n+    /**\n+     * Document type (`'HTML'` or `'XML'`)\n+     *\n+     * @var string\n+     */\n+    protected $type;\n+\n+    /**\n+     * Class constructor\n+     *\n+     * @param string $code XML or HTML code\n+     * @param string $type Document type (`'HTML'` or `'XML'`)\n+     */\n+    public function __construct(string $code, string $type = 'HTML')\n+    {\n+        $this->code = $code;\n+        $this->doc  = new DOMDocument();\n+\n+        $loaderSetting = null;\n+        if (\\PHP_VERSION_ID < 80000) {\n+            // prevent loading external entities to protect against XXE attacks;\n+            // only needed for PHP versions before 8.0 (the function was deprecated\n+            // as the disabled state is the new default in PHP 8.0+)\n+            $loaderSetting = libxml_disable_entity_loader(true);\n+        }\n+\n+        // switch to \"user error handling\"\n+        $intErrorsSetting = libxml_use_internal_errors(true);\n+\n+        $this->type = strtoupper($type);\n+        if ($this->type === 'HTML') {\n+            // ensure proper parsing for HTML snippets\n+            if (preg_match('/<(html|body)[> ]/i', $code) !== 1) {\n+                $code = '<body>' . $code . '</body>';\n+            }\n+\n+            // the loadHTML() method expects ISO-8859-1 by default;\n+            // force parsing as UTF-8 by injecting an XML declaration\n+            $xmlDeclaration = 'encoding=\"UTF-8\" id=\"' . Str::random(10) . '\"';\n+            $load = $this->doc->loadHTML('<?xml ' . $xmlDeclaration . '>' . $code);\n+\n+            // remove the injected XML declaration again\n+            $pis = $this->query('//processing-instruction()');\n+            foreach (iterator_to_array($pis, false) as $pi) {\n+                if ($pi->data === $xmlDeclaration) {\n+                    static::remove($pi);\n+                }\n+            }\n+\n+            // remove the default doctype\n+            if (Str::contains($code, '<!DOCTYPE ', true) === false) {\n+                static::remove($this->doc->doctype);\n+            }\n+        } else {\n+            $load = $this->doc->loadXML($code);\n+        }\n+\n+        if (\\PHP_VERSION_ID < 80000) {\n+            // ensure that we don't alter global state by\n+            // resetting the original value\n+            libxml_disable_entity_loader($loaderSetting);\n+        }\n+\n+        // get one error for use below and reset the global state\n+        $error = libxml_get_last_error();\n+        libxml_clear_errors();\n+        libxml_use_internal_errors($intErrorsSetting);\n+\n+        if ($load !== true) {\n+            $message = 'The markup could not be parsed';\n+\n+            if ($error !== false) {\n+                $message .= ': ' . $error->message;\n+            }\n+\n+            throw new InvalidArgumentException([\n+                'fallback' => $message,\n+                'details'  => compact('error')\n+            ]);\n+        }\n+    }\n+\n+    /**\n+     * Returns the HTML body if one exists\n+     *\n+     * @return \\DOMElement|null\n+     */\n+    public function body()\n+    {\n+        return $this->body = $this->body ?? $this->query('/html/body')[0] ?? null;\n+    }\n+\n+    /**\n+     * Returns the document object\n+     *\n+     * @return \\DOMDocument\n+     */\n+    public function document()\n+    {\n+        return $this->doc;\n+    }\n+\n+    /**\n+     * Extracts all URLs wrapped in a url() wrapper. E.g. for style attributes.\n+     * @internal\n+     *\n+     * @param string $value\n+     * @return array\n+     */\n+    public static function extractUrls(string $value): array\n+    {\n+        // remove invisible ASCII characters from the value\n+        $value = trim(preg_replace('/[^ -~]/u', '', $value));\n+\n+        $count = preg_match_all(\n+            '!url\\(\\s*[\\'\"]?(.*?)[\\'\"]?\\s*\\)!i',\n+            $value,\n+            $matches,\n+            PREG_PATTERN_ORDER\n+        );\n+\n+        if (is_int($count) === true && $count > 0) {\n+            return $matches[1];\n+        }\n+\n+        return [];\n+    }\n+\n+    /**\n+     * Checks for allowed attributes according to the allowlist\n+     * @internal\n+     *\n+     * @param \\DOMAttr $attr\n+     * @param array $options\n+     * @return true|string If not allowed, an error message is returned\n+     */\n+    public static function isAllowedAttr(DOMAttr $attr, array $options)\n+    {\n+        $allowedTags = $options['allowedTags'];\n+\n+        // check if the attribute is in the list of global allowed attributes\n+        $isAllowedGlobalAttr = static::isAllowedGlobalAttr($attr, $options);\n+\n+        // no specific tag attribute list\n+        if (is_array($allowedTags) === false) {\n+            return $isAllowedGlobalAttr;\n+        }\n+\n+        // configuration per tag name\n+        $tagName            = $attr->ownerElement->nodeName;\n+        $listedTagName      = static::listContainsName(array_keys($options['allowedTags']), $attr->ownerElement, $options);\n+        $allowedAttrsForTag = $listedTagName ? ($allowedTags[$listedTagName] ?? true) : true;\n+\n+        // the element allows all global attributes\n+        if ($allowedAttrsForTag === true) {\n+            return $isAllowedGlobalAttr;\n+        }\n+\n+        // specific attributes are allowed in addition to the global ones\n+        if (is_array($allowedAttrsForTag) === true) {\n+            // if allowed globally, we don't need further checks\n+            if ($isAllowedGlobalAttr === true) {\n+                return true;\n+            }\n+\n+            // otherwise the tag configuration decides\n+            if (static::listContainsName($allowedAttrsForTag, $attr, $options) !== false) {\n+                return true;\n+            }\n+\n+            return 'Not allowed by the \"' . $tagName . '\" element';\n+        }\n+\n+        return 'The \"' . $tagName . '\" element does not allow attributes';\n+    }\n+\n+    /**\n+     * Checks for allowed attributes according to the global allowlist\n+     * @internal\n+     *\n+     * @param \\DOMAttr $attr\n+     * @param array $options\n+     * @return true|string If not allowed, an error message is returned\n+     */\n+    public static function isAllowedGlobalAttr(DOMAttr $attr, array $options)\n+    {\n+        $allowedAttrs = $options['allowedAttrs'];\n+\n+        if ($allowedAttrs === true) {\n+            // all attributes are allowed\n+            return true;\n+        }\n+\n+        if (\n+            static::listContainsName(\n+                $options['allowedAttrPrefixes'],\n+                $attr,\n+                $options,\n+                function ($expected, $real): bool {\n+                    return Str::startsWith($real, $expected);\n+                }\n+            ) !== false\n+        ) {\n+            return true;\n+        }\n+\n+        if (\n+            is_array($allowedAttrs) === true &&\n+            static::listContainsName($allowedAttrs, $attr, $options) !== false\n+        ) {\n+            return true;\n+        }\n+\n+        return 'Not included in the global allowlist';\n+    }\n+\n+    /**\n+     * Checks if the URL is acceptable for URL attributes\n+     * @internal\n+     *\n+     * @param string $url\n+     * @param array $options\n+     * @return true|string If not allowed, an error message is returned\n+     */\n+    public static function isAllowedUrl(string $url, array $options)\n+    {\n+        $url = Str::lower($url);\n+\n+        // allow empty URL values\n+        if (empty($url) === true) {\n+            return true;\n+        }\n+\n+        // allow URLs that point to fragments inside the file\n+        if (mb_substr($url, 0, 1) === '#') {\n+            return true;\n+        }\n+\n+        // disallow protocol-relative URLs\n+        if (mb_substr($url, 0, 2) === '//') {\n+            return 'Protocol-relative URLs are not allowed';\n+        }\n+\n+        // allow site-internal URLs that didn't match the\n+        // protocol-relative check above\n+        if (mb_substr($url, 0, 1) === '/') {\n+            // if a CMS instance is active, only allow the URL\n+            // if it doesn't point outside of the index URL\n+            if ($kirby = App::instance(null, true)) {\n+                $indexUrl = $kirby->url('index', true)->path()->toString(true);\n+\n+                if (Str::startsWith($url, $indexUrl) !== true) {\n+                    return 'The URL points outside of the site index URL';\n+                }\n+\n+                // disallow directory traversal outside of the index URL\n+                // TODO: the ../ sequences could be cleaned from the URL\n+                //       before the check by normalizing the URL; then the\n+                //       check above can also validate URLs with ../ sequences\n+                if (\n+                    Str::contains($url, '../') !== false ||\n+                    Str::contains($url, '..\\\\') !== false\n+                ) {\n+                    return 'The ../ sequence is not allowed in relative URLs';\n+                }\n+            }\n+\n+            // no active CMS instance, always allow site-internal URLs\n+            return true;\n+        }\n+\n+        // allow relative URLs (= URLs without a scheme);\n+        // this is either a URL without colon or one where the\n+        // part before the colon is definitely no valid scheme;\n+        // see https://url.spec.whatwg.org/#url-writing\n+        if (\n+            Str::contains($url, ':') === false ||\n+            Str::contains(Str::before($url, ':'), '/') === true\n+        ) {\n+            // disallow directory traversal as we cannot know\n+            // in which URL context the URL will be printed\n+            if (\n+                Str::contains($url, '../') !== false ||\n+                Str::contains($url, '..\\\\') !== false\n+            ) {\n+                return 'The ../ sequence is not allowed in relative URLs';\n+            }\n+\n+            return true;\n+        }\n+\n+        // allow specific HTTP(S) URLs\n+        if (\n+            Str::startsWith($url, 'http://') === true ||\n+            Str::startsWith($url, 'https://') === true\n+        ) {\n+            if ($options['allowedDomains'] === true) {\n+                return true;\n+            }\n+\n+            $hostname = parse_url($url, PHP_URL_HOST);\n+\n+            if (in_array($hostname, $options['allowedDomains']) === true) {\n+                return true;\n+            }\n+\n+            return 'The hostname \"' . $hostname . '\" is not allowed';\n+        }\n+\n+        // allow listed data URIs\n+        if (Str::startsWith($url, 'data:') === true) {\n+            if ($options['allowedDataUris'] === true) {\n+                return true;\n+            }\n+\n+            foreach ($options['allowedDataUris'] as $dataAttr) {\n+                if (Str::startsWith($url, $dataAttr) === true) {\n+                    return true;\n+                }\n+            }\n+\n+            return 'Invalid data URI';\n+        }\n+\n+        // allow valid email addresses\n+        if (Str::startsWith($url, 'mailto:') === true) {\n+            $address = Str::after($url, 'mailto:');\n+\n+            if (empty($address) === true || V::email($address) === true) {\n+                return true;\n+            }\n+\n+            return 'Invalid email address';\n+        }\n+\n+        // allow valid telephone numbers\n+        if (Str::startsWith($url, 'tel:') === true) {\n+            $address = Str::after($url, 'tel:');\n+\n+            if (\n+                empty($address) === true ||\n+                preg_match('!^[+]?[0-9]+$!', $address) === 1\n+            ) {\n+                return true;\n+            }\n+\n+            return 'Invalid telephone number';\n+        }\n+\n+        return 'Unknown URL type';\n+    }\n+\n+    /**\n+     * Check if the XML extension is installed on the server.\n+     * Otherwise DOMDocument won't be available and the Dom cannot\n+     * work at all.\n+     *\n+     * @return bool\n+     *\n+     * @codeCoverageIgnore\n+     */\n+    public static function isSupported(): bool\n+    {\n+        return class_exists('DOMDocument') === true;\n+    }\n+\n+    /**\n+     * Returns the XML or HTML markup contained in the node\n+     *\n+     * @param \\DOMNode $node\n+     * @return string\n+     */\n+    public function innerMarkup(DOMNode $node): string\n+    {\n+        $markup = '';\n+        $method = 'save' . $this->type;\n+\n+        foreach ($node->childNodes as $child) {\n+            $markup .= $node->ownerDocument->$method($child);\n+        }\n+\n+        return $markup;\n+    }\n+\n+    /**\n+     * Checks if a list contains the name of a node considering\n+     * the allowed namespaces\n+     * @internal\n+     *\n+     * @param array $list\n+     * @param \\DOMNode $node\n+     * @param array $options See `Dom::sanitize()`\n+     * @param \\Closure|null Comparison callback that returns whether the expected and real name match\n+     * @return string|false Matched name in the list or `false`\n+     */\n+    public static function listContainsName(array $list, DOMNode $node, array $options, ?Closure $compare = null)\n+    {\n+        $allowedNamespaces = $options['allowedNamespaces'];\n+        $localName         = $node->localName;\n+\n+        if ($compare === null) {\n+            $compare = function ($expected, $real): bool {\n+                return $expected === $real;\n+            };\n+        }\n+\n+        if ($allowedNamespaces === true) {\n+            // take the list as it is and only consider\n+            // exact matches of the local name (which will\n+            // contain a namespace if that namespace name\n+            // is not defined in the document)\n+            foreach ($list as $item) {\n+                if ($compare($item, $localName) === true) {\n+                    return $item;\n+                }\n+            }\n+\n+            return false;\n+        }\n+\n+        // we need to consider the namespaces\n+        foreach ($list as $item) {\n+            // try to find the expected origin namespace URI\n+            $namespaceUri = null;\n+            $itemLocal    = $item;\n+            if (Str::contains($item, ':') === true) {\n+                list($namespaceName, $itemLocal) = explode(':', $item);\n+                $namespaceUri = $allowedNamespaces[$namespaceName] ?? null;\n+            } else {\n+                // list items without namespace are from the default namespace\n+                $namespaceUri = $allowedNamespaces[''] ?? null;\n+            }\n+\n+            // try if we can find an exact namespaced match\n+            if ($namespaceUri === $node->namespaceURI && $compare($itemLocal, $localName) === true) {\n+                return $item;\n+            }\n+\n+            // also try to match the fully-qualified name\n+            // if the document doesn't define the namespace\n+            if ($node->namespaceURI === null && $compare($item, $node->nodeName) === true) {\n+                return $item;\n+            }\n+        }\n+\n+        return false;\n+    }\n+\n+    /**\n+     * Removes a node from the document\n+     *\n+     * @param \\DOMNode $node\n+     * @return void\n+     */\n+    public static function remove(DOMNode $node): void\n+    {\n+        $node->parentNode->removeChild($node);\n+    }\n+\n+    /**\n+     * Executes an XPath query in the document\n+     *\n+     * @param string $query\n+     * @param \\DOMNode|null $node Optional context node for relative queries\n+     * @return \\DOMNodeList|false\n+     */\n+    public function query(string $query, ?DOMNode $node = null)\n+    {\n+        return (new DOMXPath($this->doc))->query($query, $node);\n+    }\n+\n+    /**\n+     * Sanitizes the DOM according to the provided configuration\n+     *\n+     * @param array $options Array with the following options:\n+     *                       - `allowedAttrPrefixes`: Global list of allowed attribute prefixes\n+     *                       like `data-` and `aria-`\n+     *                       - `allowedAttrs`: Global list of allowed attrs or `true` to allow\n+     *                       any attribute\n+     *                       - `allowedDataUris`: List of all MIME types that may be used in\n+     *                       data URIs (only checked in `urlAttrs` and inside `url()` wrappers)\n+     *                       or `true` for any\n+     *                       - `allowedDomains`: Allowed hostnames for HTTP(S) URLs in `urlAttrs`\n+     *                       and inside `url()` wrappers or `true` for any\n+     *                       - `allowedNamespaces`: Associative array of all allowed namespace URIs;\n+     *                       the array keys are reference names that can be referred to from the\n+     *                       `allowedAttrPrefixes`, `allowedAttrs`, `allowedTags`, `disallowedTags`\n+     *                       and `urlAttrs` lists; the namespace names as used in the document are *not*\n+     *                       validated; setting the whole option to `true` will allow any namespace\n+     *                       - `allowedPIs`: Names of allowed XML processing instructions or\n+     *                       `true` for any\n+     *                       - `allowedTags`: Associative array of all allowed tag names with the\n+     *                       value of either an array with the list of all allowed attributes for\n+     *                       this tag, `true` to allow any attribute from the `allowedAttrs` list\n+     *                       or `false` to allow the tag without any attributes;\n+     *                       not listed tags will be unwrapped (removed, but children are kept);\n+     *                       setting the whole option to `true` will allow any tag\n+     *                       - `attrCallback`: Closure that will receive each `DOMAttr` and may\n+     *                       modify it; the callback must return an array with exception\n+     *                       objects for each modification\n+     *                       - `disallowedTags`: Array of explicitly disallowed tags, which will\n+     *                       be removed completely including their children (matched case-insensitively)\n+     *                       - `doctypeCallback`: Closure that will receive the `DOMDocumentType`\n+     *                       and may throw exceptions on validation errors\n+     *                       - `elementCallback`: Closure that will receive each `DOMElement` and\n+     *                       may modify it; the callback must return an array with exception\n+     *                       objects for each modification\n+     *                       - `urlAttrs`: List of attributes that may contain URLs\n+     * @return array List of validation errors during sanitization\n+     *\n+     * @throws \\Kirby\\Exception\\InvalidArgumentException If the doctype is not valid\n+     */\n+    public function sanitize(array $options): array\n+    {\n+        $options = array_merge([\n+            'allowedAttrPrefixes' => [],\n+            'allowedAttrs'        => true,\n+            'allowedDataUris'     => true,\n+            'allowedDomains'      => true,\n+            'allowedNamespaces'   => true,\n+            'allowedPIs'          => true,\n+            'allowedTags'         => true,\n+            'attrCallback'        => null,\n+            'disallowedTags'      => [],\n+            'doctypeCallback'     => null,\n+            'elementCallback'     => null,\n+            'urlAttrs'            => ['href', 'src', 'xlink:href'],\n+        ], $options);\n+\n+        $errors = [];\n+\n+        // validate the doctype;\n+        // convert the `DOMNodeList` to an array first, otherwise removing\n+        // nodes would shift the list and make subsequent operations fail\n+        foreach (iterator_to_array($this->doc->childNodes, false) as $child) {\n+            if (is_a($child, 'DOMDocumentType') === true) {\n+                $this->sanitizeDoctype($child, $options, $errors);\n+            }\n+        }\n+\n+        // validate all processing instructions like <?xml-stylesheet\n+        $pis = $this->query('//processing-instruction()');\n+        foreach (iterator_to_array($pis, false) as $pi) {\n+            $this->sanitizePI($pi, $options, $errors);\n+        }\n+\n+        // validate all elements in the document tree\n+        $elements = $this->doc->getElementsByTagName('*');\n+        foreach (iterator_to_array($elements, false) as $element) {\n+            $this->sanitizeElement($element, $options, $errors);\n+        }\n+\n+        return $errors;\n+    }\n+\n+    /**\n+     * Returns the document markup as string\n+     *\n+     * @param bool $normalize If set to `true`, the document\n+     *                        is exported with an XML declaration/\n+     *                        full HTML markup even if the input\n+     *                        didn't have them\n+     * @return string\n+     */\n+    public function toString(bool $normalize = false): string\n+    {\n+        if ($this->type === 'HTML') {\n+            $string = $this->exportHtml($normalize);\n+        } else {\n+            $string = $this->exportXml($normalize);\n+        }\n+\n+        // add trailing newline if the input contained one\n+        if (rtrim($this->code, \"\\r\\n\") !== $this->code) {\n+            $string .= \"\\n\";\n+        }\n+\n+        return $string;\n+    }\n+\n+    /**\n+     * Removes a node from the document but keeps its children\n+     * by moving them one level up\n+     *\n+     * @param \\DOMNode $node\n+     * @return void\n+     */\n+    public static function unwrap(DOMNode $node): void\n+    {\n+        foreach ($node->childNodes as $childNode) {\n+            // discard text nodes as they can be unexpected\n+            // directly in the parent element\n+            if (is_a($childNode, 'DOMText') === true) {\n+                continue;\n+            }\n+\n+            $node->parentNode->insertBefore(clone $childNode, $node);\n+        }\n+\n+        static::remove($node);\n+    }\n+\n+    /**\n+     * Returns the document markup as HTML string\n+     *\n+     * @param bool $normalize If set to `true`, the document\n+     *                        is exported with full HTML markup\n+     *                        even if the input didn't have it\n+     * @return string\n+     */\n+    protected function exportHtml(bool $normalize = false): string\n+    {\n+        // enforce export as UTF-8 by injecting a <meta> tag\n+        // at the beginning of the document\n+        $metaTag = $this->doc->createElement('meta');\n+        $metaTag->setAttribute('http-equiv', 'Content-Type');\n+        $metaTag->setAttribute('content', 'text/html; charset=utf-8');\n+        $metaTag->setAttribute('id', $metaId = Str::random(10));\n+        $this->doc->insertBefore($metaTag, $this->doc->documentElement);\n+\n+        if (\n+            preg_match('/<html[> ]/i', $this->code) === 1 ||\n+            $this->doc->doctype !== null ||\n+            $normalize === true\n+        ) {\n+            // full document\n+            $html = $this->doc->saveHTML();\n+        } elseif (preg_match('/<body[> ]/i', $this->code) === 1) {\n+            // there was a <body>, but no <html>; export just the <body>\n+            $html = $this->doc->saveHTML($this->body());\n+        } else {\n+            // just an HTML snippet\n+            $html = $this->innerMarkup($this->body());\n+        }\n+\n+        // remove the <meta> tag from the document and from the output\n+        static::remove($metaTag);\n+        $html = str_replace($this->doc->saveHTML($metaTag), '', $html);\n+\n+        return trim($html);\n+    }\n+\n+    /**\n+     * Returns the document markup as XML string\n+     *\n+     * @param bool $normalize If set to `true`, the document\n+     *                        is exported with an XML declaration\n+     *                        even if the input didn't have it\n+     * @return string\n+     */\n+    protected function exportXml(bool $normalize = false): string\n+    {\n+        if (Str::contains($this->code, '<?xml ', true) === false && $normalize === false) {\n+            // the input didn't contain an XML declaration;\n+            // only return child nodes, which omits it\n+            $result = [];\n+            foreach ($this->doc->childNodes as $node) {\n+                $result[] = $this->doc->saveXML($node);\n+            }\n+\n+            return implode(\"\\n\", $result);\n+        }\n+\n+        // ensure that the document is encoded as UTF-8\n+        // unless a different encoding was specified in\n+        // the input or before exporting\n+        if ($this->doc->encoding === null) {\n+            $this->doc->encoding = 'UTF-8';\n+        }\n+\n+        return trim($this->doc->saveXML());\n+    }\n+\n+    /**\n+     * Sanitizes an attribute\n+     *\n+     * @param \\DOMAttr $attr\n+     * @param array $options See `Dom::sanitize()`\n+     * @param array $errors Array to store additional errors in by reference\n+     * @return void\n+     */\n+    protected function sanitizeAttr(DOMAttr $attr, array $options, array &$errors): void\n+    {\n+        $element = $attr->ownerElement;\n+        $name    = $attr->nodeName;\n+        $value   = $attr->value;\n+\n+        $allowed = static::isAllowedAttr($attr, $options);\n+        if ($allowed !== true) {\n+            $errors[] = new InvalidArgumentException(\n+                'The \"' . $name . '\" attribute (line ' .\n+                $attr->getLineNo() . ') is not allowed: ' .\n+                $allowed\n+            );\n+            $element->removeAttributeNode($attr);\n+        } elseif (static::listContainsName($options['urlAttrs'], $attr, $options) !== false) {\n+            $allowed = static::isAllowedUrl($value, $options);\n+            if ($allowed !== true) {\n+                $errors[] = new InvalidArgumentException(\n+                    'The URL is not allowed in attribute \"' .\n+                    $name . '\" (line ' . $attr->getLineNo() . '): ' .\n+                    $allowed\n+                );\n+                $element->removeAttributeNode($attr);\n+            }\n+        } else {\n+            // check for unwanted URLs in other attributes\n+            foreach (static::extractUrls($value) as $url) {\n+                $allowed = static::isAllowedUrl($url, $options);\n+                if ($allowed !== true) {\n+                    $errors[] = new InvalidArgumentException(\n+                        'The URL is not allowed in attribute \"' .\n+                        $name . '\" (line ' . $attr->getLineNo() . '): ' .\n+                        $allowed\n+                    );\n+                    $element->removeAttributeNode($attr);\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Sanitizes the doctype\n+     *\n+     * @param \\DOMDocumentType $doctype\n+     * @param array $options See `Dom::sanitize()`\n+     * @param array $errors Array to store additional errors in by reference\n+     * @return void\n+     */\n+    protected function sanitizeDoctype(DOMDocumentType $doctype, array $options, array &$errors): void\n+    {\n+        try {\n+            $this->validateDoctype($doctype, $options);\n+        } catch (InvalidArgumentException $e) {\n+            $errors[] = $e;\n+            static::remove($doctype);\n+        }\n+    }\n+\n+    /**\n+     * Sanitizes a single DOM element and its attribute\n+     *\n+     * @param \\DOMElement $element\n+     * @param array $options See `Dom::sanitize()`\n+     * @param array $errors Array to store additional errors in by reference\n+     * @return void\n+     */\n+    protected function sanitizeElement(DOMElement $element, array $options, array &$errors): void\n+    {\n+        $name = $element->nodeName;\n+\n+        // check defined namespaces (`xmlns` attributes);\n+        // we need to check this first as the namespace can affect\n+        // whether the tag name is valid according to the configuration\n+        if (is_array($options['allowedNamespaces']) === true) {\n+            $simpleXmlElement = simplexml_import_dom($element);\n+            foreach ($simpleXmlElement->getDocNamespaces(false, false) as $namespace => $value) {\n+                if (array_search($value, $options['allowedNamespaces']) === false) {\n+                    $element->removeAttributeNS($value, $namespace);\n+                    $errors[] = new InvalidArgumentException(\n+                        'The namespace \"' . $value . '\" is not allowed' .\n+                        ' (around line ' . $element->getLineNo() . ')'\n+                    );\n+                }\n+            }\n+        }\n+\n+        // check if the tag is blocklisted; remove the element completely\n+        if (\n+            static::listContainsName(\n+                $options['disallowedTags'],\n+                $element,\n+                $options,\n+                function ($expected, $real): bool {\n+                    return Str::lower($expected) === Str::lower($real);\n+                }\n+            ) !== false\n+        ) {\n+            $errors[] = new InvalidArgumentException(\n+                'The \"' . $name . '\" element (line ' .\n+                $element->getLineNo() . ') is not allowed'\n+            );\n+            static::remove($element);\n+\n+            return;\n+        }\n+\n+        // check if the tag is not allowlisted; keep children\n+        if ($options['allowedTags'] !== true) {\n+            $listedName = static::listContainsName(array_keys($options['allowedTags']), $element, $options);\n+\n+            if ($listedName === false) {\n+                $errors[] = new InvalidArgumentException(\n+                    'The \"' . $name . '\" element (line ' .\n+                    $element->getLineNo() . ') is not allowed, ' .\n+                    'but its children can be kept'\n+                );\n+                static::unwrap($element);\n+\n+                return;\n+            }\n+        }\n+\n+        // check attributes\n+        if ($element->hasAttributes()) {\n+            // convert the `DOMNodeList` to an array first, otherwise removing\n+            // attributes would shift the list and make subsequent operations fail\n+            foreach (iterator_to_array($element->attributes, false) as $attr) {\n+                $this->sanitizeAttr($attr, $options, $errors);\n+\n+                // custom check (if the attribute is still in the document)\n+                if ($attr->ownerElement !== null && $options['attrCallback']) {\n+                    $errors = array_merge($errors, $options['attrCallback']($attr) ?? []);\n+                }\n+            }\n+        }\n+\n+        // custom check\n+        if ($options['elementCallback']) {\n+            $errors = array_merge($errors, $options['elementCallback']($element) ?? []);\n+        }\n+    }\n+\n+    /**\n+     * Sanitizes a single XML processing instruction\n+     *\n+     * @param \\DOMProcessingInstruction $pi\n+     * @param array $options See `Dom::sanitize()`\n+     * @param array $errors Array to store additional errors in by reference\n+     * @return void\n+     */\n+    protected function sanitizePI(DOMProcessingInstruction $pi, array $options, array &$errors): void\n+    {\n+        $name = $pi->nodeName;\n+\n+        // check for allow-listed processing instructions\n+        if (is_array($options['allowedPIs']) === true && in_array($name, $options['allowedPIs']) === false) {\n+            $errors[] = new InvalidArgumentException(\n+                'The \"' . $name . '\" processing instruction (line ' .\n+                $pi->getLineNo() . ') is not allowed'\n+            );\n+            static::remove($pi);\n+        }\n+    }\n+\n+    /**\n+     * Validates the document type\n+     *\n+     * @param \\DOMDocumentType $doctype\n+     * @param array $options See `Dom::sanitize()`\n+     * @return void\n+     *\n+     * @throws \\Kirby\\Exception\\InvalidArgumentException If the doctype is not valid\n+     */\n+    protected function validateDoctype(DOMDocumentType $doctype, array $options): void\n+    {\n+        if (empty($doctype->publicId) === false || empty($doctype->systemId) === false) {\n+            throw new InvalidArgumentException('The doctype must not reference external files');\n+        }\n+\n+        if (empty($doctype->internalSubset) === false) {\n+            throw new InvalidArgumentException('The doctype must not define a subset');\n+        }\n+\n+        if ($options['doctypeCallback']) {\n+            $options['doctypeCallback']($doctype);\n+        }\n+    }\n+}"
        },
        {
          "filename": "tests/Form/Fields/WriterFieldTest.php",
          "status": "added",
          "additions": 36,
          "deletions": 0,
          "patch": "@@ -0,0 +1,36 @@\n+<?php\n+\n+namespace Kirby\\Form\\Fields;\n+\n+class WriterFieldTest extends TestCase\n+{\n+    public function testDefaultProps()\n+    {\n+        $field = $this->field('writer');\n+\n+        $this->assertSame('writer', $field->type());\n+        $this->assertSame('writer', $field->name());\n+        $this->assertSame(false, $field->inline());\n+        $this->assertSame(true, $field->marks());\n+        $this->assertSame(null, $field->nodes());\n+        $this->assertTrue($field->save());\n+    }\n+\n+    public function testValueSanitized()\n+    {\n+        $field = $this->field('writer', [\n+            'value' => 'This is a <strong>test</strong><script>alert(\"Hacked\")</script> with <em>formatting</em>'\n+        ]);\n+\n+        $this->assertSame('This is a <strong>test</strong> with <em>formatting</em>', $field->value());\n+    }\n+\n+    public function testValueTrimmed()\n+    {\n+        $field = $this->field('writer', [\n+            'value' => 'test '\n+        ]);\n+\n+        $this->assertSame('test', $field->value());\n+    }\n+}"
        },
        {
          "filename": "tests/Sane/DomHandlerTest.php",
          "status": "added",
          "additions": 48,
          "deletions": 0,
          "patch": "@@ -0,0 +1,48 @@\n+<?php\n+\n+namespace Kirby\\Sane;\n+\n+require_once __DIR__ . '/mocks.php';\n+\n+/**\n+ * @covers \\Kirby\\Sane\\DomHandler\n+ */\n+class DomHandlerTest extends TestCase\n+{\n+    protected $type = 'sane';\n+\n+    public function testSanitize()\n+    {\n+        $fixture = '<xml><test attr=\"value\">Hello world</test></xml>';\n+        $this->assertSame($fixture, DomHandler::sanitize($fixture));\n+\n+        $fixture   = '<?xml version=\"1.0\"?><xml><test>Hello world</test></xml>';\n+        $sanitized = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n<xml><test>Hello world</test></xml>\";\n+        $this->assertSame($sanitized, DomHandler::sanitize($fixture));\n+\n+        $fixture   = '<?xml version=\"1.0\" standalone=\"no\"?><xml><test>Hello world</test></xml>';\n+        $sanitized = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\" standalone=\\\"no\\\"?>\\n<xml><test>Hello world</test></xml>\";\n+        $this->assertSame($sanitized, DomHandler::sanitize($fixture));\n+    }\n+\n+    public function testValidate()\n+    {\n+        $this->assertNull(DomHandler::validate('<!DOCTYPE xml><xml><test attr=\"value\">Hello world</test></xml>'));\n+    }\n+\n+    public function testValidateException1()\n+    {\n+        $this->expectException('Kirby\\Exception\\InvalidArgumentException');\n+        $this->expectExceptionMessage('The URL is not allowed in attribute \"href\" (line 2): Unknown URL type');\n+\n+        DomHandler::validate(\"<xml>\\n<a href='javascript:alert(1)'></a>\\n</xml>\");\n+    }\n+\n+    public function testValidateException2()\n+    {\n+        $this->expectException('Kirby\\Exception\\InvalidArgumentException');\n+        $this->expectExceptionMessage('The doctype must not reference external files');\n+\n+        DomHandler::validate(\"<!DOCTYPE xml SYSTEM \\\"https://malicious.com/something.dtd\\\">\\n<xml>\\n<a href='javascript:alert(1)'></a>\\n</xml>\");\n+    }\n+}"
        },
        {
          "filename": "tests/Sane/HtmlTest.php",
          "status": "added",
          "additions": 30,
          "deletions": 0,
          "patch": "@@ -0,0 +1,30 @@\n+<?php\n+\n+namespace Kirby\\Sane;\n+\n+/**\n+ * @covers \\Kirby\\Sane\\Html\n+ * @todo Add more tests from DOMPurify and the other test classes\n+ */\n+class HtmlTest extends TestCase\n+{\n+    protected $type = 'html';\n+\n+    /**\n+     * @dataProvider allowedProvider\n+     */\n+    public function testAllowed(string $file)\n+    {\n+        $fixture = $this->fixture($file);\n+\n+        $this->assertNull(Html::validateFile($fixture));\n+\n+        $sanitized = Html::sanitize(file_get_contents($fixture));\n+        $this->assertStringEqualsFile($fixture, $sanitized);\n+    }\n+\n+    public function allowedProvider()\n+    {\n+        return $this->fixtureList('allowed', 'html');\n+    }\n+}"
        },
        {
          "filename": "tests/Sane/TestCase.php",
          "status": "modified",
          "additions": 19,
          "deletions": 3,
          "patch": "@@ -3,23 +3,39 @@\n namespace Kirby\\Sane;\n \n use FilesystemIterator;\n+use Kirby\\Toolkit\\Dir;\n+use Kirby\\Toolkit\\F;\n use PHPUnit\\Framework\\TestCase as BaseTestCase;\n use RecursiveDirectoryIterator;\n use RecursiveIteratorIterator;\n \n class TestCase extends BaseTestCase\n {\n-    protected $type = 'svg';\n+    protected $type;\n+\n+    public function tearDown(): void\n+    {\n+        Dir::remove(__DIR__ . '/tmp');\n+    }\n \n     /**\n      * Returns the path to a test fixture file\n      *\n      * @param string $name Fixture name including file extension\n+     * @param bool $tmp If true, the fixture will be copied to a temporary location\n      * @return string\n      */\n-    protected function fixture(string $name): string\n+    protected function fixture(string $name, bool $tmp = false): string\n     {\n-        return __DIR__ . '/fixtures/' . $this->type . '/' . $name;\n+        $fixtureRoot = __DIR__ . '/fixtures/' . $this->type . '/' . $name;\n+\n+        if ($tmp === false) {\n+            return $fixtureRoot;\n+        }\n+\n+        $tmpRoot = __DIR__ . '/tmp/' . $this->type . '/' . $name;\n+        F::copy($fixtureRoot, $tmpRoot);\n+        return $tmpRoot;\n     }\n \n     /**"
        },
        {
          "filename": "tests/Sane/fixtures/html/allowed/full-document-1.html",
          "status": "added",
          "additions": 11,
          "deletions": 0,
          "patch": "@@ -0,0 +1,11 @@\n+<!DOCTYPE html>\n+<html>\n+    <body>\n+        <p>Lorem ipsum dolor sit, amet consectetur adipisicing elit.</p>\n+        <ol>\n+            <li>One</li>\n+            <li>Two</li>\n+            <li>Three</li>\n+        </ol>\n+    </body>\n+</html>"
        },
        {
          "filename": "tests/Sane/fixtures/html/allowed/full-document-2.html",
          "status": "added",
          "additions": 10,
          "deletions": 0,
          "patch": "@@ -0,0 +1,10 @@\n+<html id=\"root\">\n+    <body class=\"body\">\n+        <p>Lorem ipsum dolor sit, amet consectetur adipisicing elit.</p>\n+        <ol>\n+            <li>One</li>\n+            <li>Two</li>\n+            <li>Three</li>\n+        </ol>\n+    </body>\n+</html>"
        },
        {
          "filename": "tests/Sane/fixtures/html/allowed/sandbox-blocks.html",
          "status": "added",
          "additions": 23,
          "deletions": 0,
          "patch": "@@ -0,0 +1,23 @@\n+<p>Far far away, behind the word mountains, far from the countries Vokalia and Consonantia, there live the blind texts. Separated they live in Bookmarksgrove right at the coast of the Semantics, a large language ocean. A small river named Duden flows by <strong>their</strong> place and supplies it with the necessary regelialia. It is a paradisematic country, in which roasted parts of sentences fly into your mouth. Even the all-powerful Pointing has no control about the blind texts it is an almost unorthographic life One day however a small line of blind text by the name of Lorem Ipsum decided to leave for the far World of Grammar.</p>\n+<p><strong>The Big Oxmox</strong> advised her not to do so, because there were thousands of bad Commas, wild Question Marks and devious Semikoli, but the Little Blind Text didn\u2019t listen. She packed her seven versalia, put her initial into the belt and made herself on the way. When she reached the first hills of the Italic <a href=\"https://getkirby.com\" rel=\"noopener noreferrer nofollow\">Mountains</a>, she had a last view back on the skyline of her hometown Bookmarksgrove, the headline of Alphabet Village and the subline of her own road, the Line Lane. Pityful a rethoric question ran over her cheek, then she continued her way. On her way she met a copy.</p>\n+<blockquote>\n+    Time flies like an arrow; fruit flies like a banana\n+    <footer>\n+        <a href=\"https://en.wikipedia.org/wiki/Anthony_Oettinger\" rel=\"noopener noreferrer nofollow\">Anthony Oettinger</a>\n+    </footer>\n+</blockquote>\n+<h2>Let's put a heading here</h2>\n+<p>But nothing the <u>copy</u> said could convince her and so it didn\u2019t take long until a few insidious Copy Writers ambushed her, made her drunk with Longe and Parole and dragged her into their agency, where they abused her for their <em>projects</em> again and again. And if she hasn\u2019t been rewritten, then they are still using her. Far far away, behind the word mountains, far from the countries Vokalia and Consonantia, there live the blind texts. Separated they live in <small>Bookmarksgrove</small> right at the coast of the Semantics, a large language ocean.</p>\n+<h2>This is created by some good old markdown</h2>\n+<p>You can mix it with the other blocks to get even more <strong>flexibility</strong>. Markdown can be <strong>mixed</strong> with HTML too, which is nice. And of course <a href=\"https://getkirby.com\">Kirbytags</a> are cool too.</p>\n+<ul><li><p>Look, it's a list</p></li><li><p>With some nice bullet points</p></li><li><p>Here's another one</p><ol><li><p>This is a nested list</p></li><li><p>With even more list items</p></li><li><p>Mixed list types are possible as well</p></li></ol></li></ul>\n+<h2>Stars stars stars</h2>\n+<p>Donec ullamcorper nulla non metus auctor fringilla. Fusce dapibus, tellus ac cursus commodo, tortor mauris condimentum nibh, ut fermentum massa justo sit amet risus. Etiam porta sem malesuada magna <code>mollis</code> euismod. Nulla vitae elit libero, a pharetra augue. Nullam quis risus eget urna mollis ornare vel eu leo. Aenean lacinia bibendum nulla sed consectetur. Duis mollis, est non commodo luctus, nisi erat porttitor ligula, eget lacinia odio sem nec elit.</p>\n+<pre class=\" language-php\"><code class=\" language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$page</span><span class=\"token operator\">-</span><span class=\"token operator\">&gt;</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token operator\">&gt;</span><span class=\"token function\">toBlocks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token variable\">$block</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token delimiter important\">?&gt;</span></span>\n+<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>block<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n+<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?=</span> <span class=\"token variable\">$block</span> <span class=\"token delimiter important\">?&gt;</span></span>\n+<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">&gt;</span></span>\n+<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token keyword\">endforeach</span> <span class=\"token delimiter important\">?&gt;</span></span></code>\n+</pre>\n+<h3>Last heading \u2013 promised!</h3>\n+<p>Aenean lacinia bibendum nulla sed consectetur. Fusce dapibus, tellus ac cursus commodo, tortor mauris condimentum nibh, ut fermentum massa justo sit amet risus. <s>Nullam id dolor id nibh ultricies vehicula ut id elit.</s> Vivamus sagittis lacus vel augue laoreet rutrum faucibus dolor auctor. Lorem ipsum dolor sit amet, consectetur adipiscing elit.</p>"
        },
        {
          "filename": "tests/Toolkit/DomTest.php",
          "status": "added",
          "additions": 1738,
          "deletions": 0,
          "patch": "@@ -0,0 +1,1738 @@\n+<?php\n+\n+namespace Kirby\\Toolkit;\n+\n+use Closure;\n+use DOMAttr;\n+use DOMDocument;\n+use DOMDocumentType;\n+use DOMElement;\n+use Kirby\\Cms\\App;\n+use Kirby\\Exception\\InvalidArgumentException;\n+\n+/**\n+ * @coversDefaultClass \\Kirby\\Toolkit\\Dom\n+ */\n+class DomTest extends TestCase\n+{\n+    public function parseSaveProvider(): array\n+    {\n+        return [\n+            // full document with doctype\n+            [\n+                'html',\n+                '<!DOCTYPE html><html><body><p>Lorem ipsum</p></body></html>',\n+                \"<!DOCTYPE html>\\n<html><body><p>Lorem ipsum</p></body></html>\"\n+            ],\n+\n+            // full document with lowercase doctype\n+            [\n+                'html',\n+                '<!doctype html><html><body><p>Lorem ipsum</p></body></html>',\n+                \"<!DOCTYPE html>\\n<html><body><p>Lorem ipsum</p></body></html>\"\n+            ],\n+\n+            // full document with doctype (with whitespace)\n+            [\n+                'html',\n+                \"<!DOCTYPE html>\\n\\n<html><body><p>Lorem ipsum</p></body></html>\\n\\n\",\n+                \"<!DOCTYPE html>\\n<html><body><p>Lorem ipsum</p></body></html>\\n\"\n+            ],\n+\n+            // Unicode string\n+            [\n+                'html',\n+                '<html><body><p>TEST \u2014\u00a0j\u016bs\u0173 \u0161ildymo sistemai</p></body></html>'\n+            ],\n+\n+            // Unicode string with entities\n+            [\n+                'html',\n+                '<html><body><p>TEST &mdash;&nbsp;j\u016bs&#371; &scaron;ildymo sistemai</p></body></html>',\n+                '<html><body><p>TEST \u2014\u00a0j\u016bs\u0173 \u0161ildymo sistemai</p></body></html>',\n+            ],\n+\n+            // weird whitespace\n+            [\n+                'html',\n+                \"<html>\\n  <body>\\n    <p>Lorem ipsum\\n</p>\\n  </body>\\n</html>\\n\"\n+            ],\n+\n+            // HTML snippet with syntax issue\n+            [\n+                'html',\n+                '<p>This is <strong>important</strong!</p>',\n+                '<p>This is <strong>important</strong>!</p>'\n+            ],\n+\n+            // HTML snippet with doctype\n+            [\n+                'html',\n+                '<!DOCTYPE html><p>This is <strong>important</strong>!</p>',\n+                \"<!DOCTYPE html>\\n<html><body><p>This is <strong>important</strong>!</p></body></html>\"\n+            ],\n+\n+            // HTML snippet without wrapper tag\n+            [\n+                'html',\n+                'This is <em>very</em> <strong>important</strong>!',\n+                'This is <em>very</em> <strong>important</strong>!'\n+            ],\n+\n+            // just a <body>\n+            [\n+                'html',\n+                '<body><p>This is <strong>important</strong>!</p></body>',\n+                '<body><p>This is <strong>important</strong>!</p></body>'\n+            ],\n+\n+            // just a <body> with attributes\n+            [\n+                'html',\n+                '<body id=\"test\"><p>This is <strong>important</strong>!</p></body>',\n+                '<body id=\"test\"><p>This is <strong>important</strong>!</p></body>'\n+            ],\n+\n+            // full document, but without body\n+            [\n+                'html',\n+                '<html><p>This is <strong>important</strong>!</p><html>',\n+                '<html><body><p>This is <strong>important</strong>!</p></body></html>'\n+            ],\n+\n+            // full document, but without body; <html> with attributes\n+            [\n+                'html',\n+                '<html id=\"test\"><p>This is <strong>important</strong>!</p><html>',\n+                '<html id=\"test\"><body><p>This is <strong>important</strong>!</p></body></html>'\n+            ],\n+\n+            // document with doctype\n+            [\n+                'xml',\n+                '<!DOCTYPE svg><svg><text>Lorem ipsum</text></svg>',\n+                \"<!DOCTYPE svg>\\n<svg><text>Lorem ipsum</text></svg>\"\n+            ],\n+\n+            // document with doctype (with whitespace)\n+            [\n+                'xml',\n+                \"<!DOCTYPE svg>\\n\\n<svg><text>Lorem ipsum</text></svg>\",\n+                \"<!DOCTYPE svg>\\n<svg><text>Lorem ipsum</text></svg>\"\n+            ],\n+\n+            // document with XML declaration\n+            [\n+                'xml',\n+                '<?xml version=\"1.0\"?><svg><text>Lorem ipsum</text></svg>',\n+                \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n<svg><text>Lorem ipsum</text></svg>\"\n+            ],\n+\n+            // document with XML declaration and doctype\n+            [\n+                'xml',\n+                '<?xml version=\"1.0\" encoding=\"utf-8\"?><!DOCTYPE svg><svg><text>Lorem ipsum</text></svg>',\n+                \"<?xml version=\\\"1.0\\\" encoding=\\\"utf-8\\\"?>\\n<!DOCTYPE svg>\\n<svg><text>Lorem ipsum</text></svg>\"\n+            ],\n+\n+            // Unicode string\n+            [\n+                'xml',\n+                '<xml>TEST \u2014\u00a0j\u016bs\u0173 \u0161ildymo sistemai</xml>'\n+            ],\n+\n+            // Unicode string with entities\n+            [\n+                'xml',\n+                '<svg><text>TEST &#x2014;\u00a0j\u016bs&#371; \u0161ildymo sistemai</text></svg>',\n+                '<svg><text>TEST \u2014\u00a0j\u016bs\u0173 \u0161ildymo sistemai</text></svg>',\n+            ],\n+\n+            // weird whitespace\n+            [\n+                'xml',\n+                \"<svg>\\n  <text>\\n    Lorem ipsum\\n</text>\\n  </svg>\"\n+            ],\n+        ];\n+    }\n+\n+    /**\n+     * @dataProvider parseSaveProvider\n+     * @covers ::__construct\n+     * @covers ::toString\n+     * @covers ::exportHtml\n+     * @covers ::exportXml\n+     */\n+    public function testParseSave(string $type, string $code, string $expected = null)\n+    {\n+        $dom = new Dom($code, $type);\n+        $this->assertSame($expected ?? $code, $dom->toString());\n+    }\n+\n+    public function parseSaveNormalizeProvider(): array\n+    {\n+        return [\n+            // full document with doctype\n+            [\n+                'html',\n+                '<!DOCTYPE html><html><body><p>Lorem ipsum</p></body></html>',\n+                \"<!DOCTYPE html>\\n<html><body><p>Lorem ipsum</p></body></html>\"\n+            ],\n+\n+            // Unicode string with entities\n+            [\n+                'html',\n+                '<html><body><p>TEST &mdash;&nbsp;j\u016bs&#371; &scaron;ildymo sistemai</p></body></html>',\n+                '<html><body><p>TEST \u2014\u00a0j\u016bs\u0173 \u0161ildymo sistemai</p></body></html>',\n+            ],\n+\n+            // weird whitespace\n+            [\n+                'html',\n+                \"<html>\\n  <body>\\n    <p>Lorem ipsum\\n</p>\\n  </body>\\n</html>\\n\"\n+            ],\n+\n+            // HTML snippet with syntax issue\n+            [\n+                'html',\n+                '<p>This is <strong>important</strong!</p>',\n+                '<html><body><p>This is <strong>important</strong>!</p></body></html>'\n+            ],\n+\n+            // HTML snippet with doctype\n+            [\n+                'html',\n+                '<!DOCTYPE html><p>This is <strong>important</strong>!</p>',\n+                \"<!DOCTYPE html>\\n<html><body><p>This is <strong>important</strong>!</p></body></html>\"\n+            ],\n+\n+            // just a <body>\n+            [\n+                'html',\n+                '<body><p>This is <strong>important</strong>!</p></body>',\n+                '<html><body><p>This is <strong>important</strong>!</p></body></html>'\n+            ],\n+\n+            // just a <body> with attributes\n+            [\n+                'html',\n+                '<body id=\"test\"><p>This is <strong>important</strong>!</p></body>',\n+                '<html><body id=\"test\"><p>This is <strong>important</strong>!</p></body></html>'\n+            ],\n+\n+            // full document, but without body\n+            [\n+                'html',\n+                '<html><p>This is <strong>important</strong>!</p><html>',\n+                '<html><body><p>This is <strong>important</strong>!</p></body></html>'\n+            ],\n+\n+            // full document, but without body; <html> with attributes\n+            [\n+                'html',\n+                '<html id=\"test\"><p>This is <strong>important</strong>!</p><html>',\n+                '<html id=\"test\"><body><p>This is <strong>important</strong>!</p></body></html>'\n+            ],\n+\n+            // document with doctype\n+            [\n+                'xml',\n+                '<!DOCTYPE svg><svg><text>Lorem ipsum</text></svg>',\n+                \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n<!DOCTYPE svg>\\n<svg><text>Lorem ipsum</text></svg>\"\n+            ],\n+\n+            // document with doctype (with whitespace)\n+            [\n+                'xml',\n+                \"<!DOCTYPE svg>\\n\\n<svg><text>Lorem ipsum</text></svg>\",\n+                \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n<!DOCTYPE svg>\\n<svg><text>Lorem ipsum</text></svg>\"\n+            ],\n+\n+            // document with XML declaration\n+            [\n+                'xml',\n+                '<?xml version=\"1.0\"?><svg><text>Lorem ipsum</text></svg>',\n+                \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n<svg><text>Lorem ipsum</text></svg>\"\n+            ],\n+\n+            // document with XML declaration and doctype\n+            [\n+                'xml',\n+                '<?xml version=\"1.0\" encoding=\"utf-8\"?><!DOCTYPE svg><svg><text>Lorem ipsum</text></svg>',\n+                \"<?xml version=\\\"1.0\\\" encoding=\\\"utf-8\\\"?>\\n<!DOCTYPE svg>\\n<svg><text>Lorem ipsum</text></svg>\"\n+            ],\n+\n+            // Unicode string\n+            [\n+                'xml',\n+                '<xml>TEST \u2014\u00a0j\u016bs\u0173 \u0161ildymo sistemai</xml>',\n+                \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n<xml>TEST \u2014\u00a0j\u016bs\u0173 \u0161ildymo sistemai</xml>\"\n+            ],\n+\n+            // Unicode string with UTF-8 XML declaration\n+            [\n+                'xml',\n+                '<?xml version=\"1.0\" encoding=\"utf-8\"?><xml>TEST \u2014\u00a0j\u016bs\u0173 \u0161ildymo sistemai</xml>',\n+                \"<?xml version=\\\"1.0\\\" encoding=\\\"utf-8\\\"?>\\n<xml>TEST \u2014\u00a0j\u016bs\u0173 \u0161ildymo sistemai</xml>\"\n+            ],\n+\n+            // weird whitespace\n+            [\n+                'xml',\n+                \"<svg>\\n  <text>\\n    Lorem ipsum\\n</text>\\n  </svg>\\n\",\n+                \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n<svg>\\n  <text>\\n    Lorem ipsum\\n</text>\\n  </svg>\\n\"\n+            ],\n+\n+            // weird whitespace with XML declaration\n+            [\n+                'xml',\n+                \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n<svg>\\n  <text>\\n    Lorem ipsum\\n</text>\\n  </svg>\\n\"\n+            ],\n+        ];\n+    }\n+\n+    /**\n+     * @dataProvider parseSaveNormalizeProvider\n+     * @covers ::__construct\n+     * @covers ::toString\n+     * @covers ::exportHtml\n+     * @covers ::exportXml\n+     */\n+    public function testParseSaveNormalize(string $type, string $code, string $expected = null)\n+    {\n+        $dom = new Dom($code, $type);\n+        $this->assertSame($expected ?? $code, $dom->toString(true));\n+    }\n+\n+    /**\n+     * @covers ::__construct\n+     */\n+    public function testParseInvalid()\n+    {\n+        $this->expectException('Kirby\\Exception\\InvalidArgumentException');\n+        $this->expectExceptionMessage(\"The markup could not be parsed: Start tag expected, '<' not found\");\n+\n+        new Dom('{\"this\": \"is not XML\"}', 'XML');\n+    }\n+\n+    /**\n+     * @covers ::body\n+     */\n+    public function testBody()\n+    {\n+        // with full document input\n+        $dom = new Dom('<html><body class=\"test\"><p>This is a test</p></body></html>', 'HTML');\n+        $this->assertInstanceOf('DOMElement', $dom->body());\n+        $this->assertSame('<body class=\"test\"><p>This is a test</p></body>', $dom->document()->saveHtml($dom->body()));\n+\n+        // partial document 1\n+        $dom = new Dom('<body class=\"test\"><p>This is a test</p></body>', 'HTML');\n+        $this->assertInstanceOf('DOMElement', $dom->body());\n+        $this->assertSame('<body class=\"test\"><p>This is a test</p></body>', $dom->document()->saveHtml($dom->body()));\n+\n+        // partial document 2\n+        $dom = new Dom('<p>This is a test</p>', 'HTML');\n+        $this->assertInstanceOf('DOMElement', $dom->body());\n+        $this->assertSame('<body><p>This is a test</p></body>', $dom->document()->saveHtml($dom->body()));\n+\n+        // document without body\n+        $dom = new Dom('<html><head></head></html>', 'HTML');\n+        $this->assertNull($dom->body());\n+    }\n+\n+    /**\n+     * @covers ::document\n+     */\n+    public function testDocument()\n+    {\n+        $dom = new Dom('<p>This is a test</p>', 'HTML');\n+        $this->assertSame(\"<html><body><p>This is a test</p></body></html>\\n\", $dom->document()->saveHtml());\n+    }\n+\n+    public function extractUrlsProvider(): array\n+    {\n+        return [\n+            // empty input\n+            [\n+                '',\n+                []\n+            ],\n+\n+            // one URL\n+            [\n+                'url(https://getkirby.com)',\n+                ['https://getkirby.com']\n+            ],\n+            [\n+                'url(\"https://getkirby.com/?test=test&another=test\")',\n+                ['https://getkirby.com/?test=test&another=test']\n+            ],\n+            [\n+                'url(\\'https://getkirby.com\\')',\n+                ['https://getkirby.com']\n+            ],\n+            [\n+                'url(\\'https://getkirby.com)',\n+                ['https://getkirby.com']\n+            ],\n+            [\n+                'url(https://getkirby.com\")',\n+                ['https://getkirby.com']\n+            ],\n+            [\n+                'url(  https://getkirby.com   )',\n+                ['https://getkirby.com']\n+            ],\n+            [\n+                'url(  \"https://getkirby.com\"   )',\n+                ['https://getkirby.com']\n+            ],\n+            [\n+                'url(  \"  https://getkirby.com \"   )',\n+                ['  https://getkirby.com ']\n+            ],\n+            [\n+                'UrL(  \"  https://getkirby.com \"   )',\n+                ['  https://getkirby.com ']\n+            ],\n+\n+            // multiple URLs\n+            [\n+                'url(https://getkirby.com); url(https://getkirby.com/test)',\n+                ['https://getkirby.com', 'https://getkirby.com/test']\n+            ],\n+            [\n+                'url(\"https://getkirby.com/?test=test&another=test\"), url(https://getkirby.com/test)',\n+                ['https://getkirby.com/?test=test&another=test', 'https://getkirby.com/test']\n+            ],\n+            [\n+                'This is a test with an url(\\'https://getkirby.com\\') and another url(\"https://getkirby.com/test\").',\n+                ['https://getkirby.com', 'https://getkirby.com/test']\n+            ],\n+            [\n+                'An url(\\'https://getkirby.com) and another url(https://getkirby.com/test\")',\n+                ['https://getkirby.com', 'https://getkirby.com/test']\n+            ],\n+            [\n+                'url(  https://getkirby.com   ) and URl(  \"https://getkirby.com/test\"   ) and uRl(  \"  https://getkirby.com/another-test \"   )',\n+                ['https://getkirby.com', 'https://getkirby.com/test', '  https://getkirby.com/another-test ']\n+            ],\n+\n+            // invisible characters\n+            [\n+                \"ur\\0l\\0\\0(\\0'test://te\\0st'\\0)\\0\",\n+                ['test://test']\n+            ],\n+        ];\n+    }\n+\n+    /**\n+     * @dataProvider extractUrlsProvider\n+     * @covers ::extractUrls\n+     */\n+    public function testExtractUrls(string $url, array $expected)\n+    {\n+        $this->assertSame($expected, Dom::extractUrls($url));\n+    }\n+\n+    public function isAllowedAttrProvider(): array\n+    {\n+        return [\n+            // only the global allowlist\n+            [\n+                'html',\n+                'class',\n+                ['class'],\n+                [],\n+                true,\n+\n+                true\n+            ],\n+            [\n+                'html',\n+                'class',\n+                ['class'],\n+                [],\n+                [],\n+\n+                true\n+            ],\n+            [\n+                'html',\n+                'aria-label',\n+                [],\n+                ['aria-'],\n+                true,\n+\n+                true\n+            ],\n+            [\n+                'html',\n+                'test:test-attr',\n+                [],\n+                ['test:test-'],\n+                true,\n+\n+                true\n+            ],\n+            [\n+                'html',\n+                'id',\n+                ['class'],\n+                ['aria-'],\n+                true,\n+\n+                'Not included in the global allowlist'\n+            ],\n+            [\n+                'html',\n+                'test-attr',\n+                [],\n+                ['test:test-'],\n+                true,\n+\n+                'Not included in the global allowlist'\n+            ],\n+            [\n+                'html',\n+                'id',\n+                ['class'],\n+                ['aria-'],\n+                [],\n+\n+                'Not included in the global allowlist'\n+            ],\n+\n+            // specific configuration by tag\n+            [\n+                'html',\n+                'class',\n+                ['class'],\n+                ['aria-'],\n+                ['html' => true],\n+\n+                true\n+            ],\n+            [\n+                'html',\n+                'aria-label',\n+                ['class'],\n+                ['aria-'],\n+                ['html' => true],\n+\n+                true\n+            ],\n+            [\n+                'html',\n+                'class',\n+                ['class'],\n+                ['aria-'],\n+                ['html' => ['class']],\n+\n+                true\n+            ],\n+            [\n+                'html',\n+                'id',\n+                ['class'],\n+                ['aria-'],\n+                ['html' => ['id']],\n+\n+                true\n+            ],\n+            [\n+                'html',\n+                'test:test-attr',\n+                ['class'],\n+                ['aria-'],\n+                ['html' => ['test:test-attr']],\n+\n+                true\n+            ],\n+            [\n+                'html',\n+                'onload',\n+                ['class'],\n+                ['aria-'],\n+                ['html' => ['id']],\n+\n+                'Not allowed by the \"html\" element'\n+            ],\n+            [\n+                'html',\n+                'class',\n+                ['class'],\n+                ['aria-'],\n+                ['html' => false],\n+\n+                'The \"html\" element does not allow attributes'\n+            ],\n+        ];\n+    }\n+\n+    /**\n+     * @dataProvider isAllowedAttrProvider\n+     * @covers ::isAllowedAttr\n+     */\n+    public function testIsAllowedAttr(string $tag, string $attr, $allowedAttrs, $allowedAttrPrefixes, $allowedTags, $expected)\n+    {\n+        $doc = new DOMDocument();\n+        $element = $doc->createElement($tag);\n+        $element->setAttributeNode($attr = new DOMAttr($attr));\n+\n+        $options = [\n+            'allowedAttrPrefixes' => $allowedAttrPrefixes,\n+            'allowedAttrs'        => $allowedAttrs,\n+            'allowedTags'         => $allowedTags,\n+            'allowedNamespaces'   => ['test' => 'https://example.com']\n+        ];\n+\n+        $this->assertSame($expected, Dom::isAllowedAttr($attr, $options));\n+    }\n+\n+    public function isAllowedGlobalAttrProvider(): array\n+    {\n+        return [\n+            // all attrs are allowed\n+            [\n+                'test',\n+                true,\n+                [],\n+\n+                true\n+            ],\n+\n+            // test by prefix\n+            [\n+                'data-test',\n+                [],\n+                ['aria-', 'data-'],\n+\n+                true\n+            ],\n+            [\n+                'test:test-attr',\n+                [],\n+                ['test:test-'],\n+\n+                true\n+            ],\n+            [\n+                'aaria-',\n+                [],\n+                ['aria-', 'data-'],\n+\n+                'Not included in the global allowlist'\n+            ],\n+            [\n+                'test',\n+                [],\n+                ['aria-', 'data-'],\n+\n+                'Not included in the global allowlist'\n+            ],\n+            [\n+                'test:test-attr',\n+                [],\n+                ['test-'],\n+\n+                'Not included in the global allowlist'\n+            ],\n+            [\n+                'custom:test-attr',\n+                [],\n+                ['test:test-'],\n+\n+                'Not included in the global allowlist'\n+            ],\n+\n+            // test by full name\n+            [\n+                'class',\n+                ['class', 'id'],\n+                [],\n+\n+                true\n+            ],\n+            [\n+                'test:test-attr',\n+                ['test:test-attr'],\n+                [],\n+\n+                true\n+            ],\n+            [\n+                'test',\n+                ['class', 'id'],\n+                [],\n+\n+                'Not included in the global allowlist'\n+            ],\n+            [\n+                'test:test-attr',\n+                ['test-attr'],\n+                [],\n+\n+                'Not included in the global allowlist'\n+            ],\n+            [\n+                'custom:test-attr',\n+                ['test:test-attr'],\n+                [],\n+\n+                'Not included in the global allowlist'\n+            ],\n+\n+            // either list may allow the attribute\n+            [\n+                'test-attr',\n+                ['test-attr'],\n+                ['aria-'],\n+\n+                true\n+            ],\n+            [\n+                'test-attr',\n+                ['test'],\n+                ['test-'],\n+\n+                true\n+            ],\n+            [\n+                'aria-label',\n+                ['test'],\n+                ['test-'],\n+\n+                'Not included in the global allowlist'\n+            ],\n+        ];\n+    }\n+\n+    /**\n+     * @dataProvider isAllowedGlobalAttrProvider\n+     * @covers ::isAllowedGlobalAttr\n+     */\n+    public function testIsAllowedGlobalAttr(string $name, $allowedAttrs, $allowedAttrPrefixes, $expected)\n+    {\n+        $attr    = new DOMAttr($name);\n+        $options = [\n+            'allowedAttrs'        => $allowedAttrs,\n+            'allowedAttrPrefixes' => $allowedAttrPrefixes,\n+            'allowedNamespaces'   => ['test' => 'https://example.com']\n+        ];\n+\n+        $this->assertSame($expected, Dom::isAllowedGlobalAttr($attr, $options));\n+    }\n+\n+    public function isAllowedUrlProvider(): array\n+    {\n+        return [\n+            // allowed empty url\n+            ['', true],\n+\n+            // allowed path\n+            ['/', true],\n+\n+            // allowed path\n+            ['/some/path', true],\n+\n+            // allowed path\n+            ['some', true],\n+\n+            // allowed path\n+            ['some/path', true],\n+\n+            // allowed path\n+            ['some/path:test', true],\n+\n+            // allowed path\n+            ['some/path:some/test', true],\n+\n+            // allowed path\n+            ['./some/path', true],\n+\n+            // allowed fragment\n+            ['#', true],\n+\n+            // allowed fragment\n+            ['#test-fragment', true],\n+\n+            // allowed data uri when all are accepted\n+            ['data:image/jpeg;base64,test', true, [\n+                'allowedDataUris' => true\n+            ]],\n+\n+            // allowed data uri\n+            ['data:image/jpeg;base64,test', true, [\n+                'allowedDataUris' => [\n+                    'data:image/jpeg;base64'\n+                ]\n+            ]],\n+\n+            // allowed URL when all domains are accepted\n+            ['http://getkirby.com', true, [\n+                'allowedDomains' => true\n+            ]],\n+\n+            // allowed URL when the domain is accepted\n+            ['http://getkirby.com', true, [\n+                'allowedDomains' => [\n+                    'getkirby.com'\n+                ]\n+            ]],\n+\n+            // allowed empty email address\n+            ['mailto:', true],\n+\n+            // allowed valid email address\n+            ['mailto:test@getkirby.com', true],\n+\n+            // allowed empty phone number\n+            ['tel:', true],\n+\n+            // allowed phone number\n+            ['tel:+491122334455', true],\n+\n+            // forbidden protocol-relative URL\n+            ['//test', 'Protocol-relative URLs are not allowed'],\n+\n+            // forbidden relative URL\n+            ['../some/path', 'The ../ sequence is not allowed in relative URLs'],\n+\n+            // forbidden relative URL\n+            ['..\\some\\path', 'The ../ sequence is not allowed in relative URLs'],\n+\n+            // forbidden relative URL\n+            ['some/../../path', 'The ../ sequence is not allowed in relative URLs'],\n+\n+            // forbidden relative URL\n+            ['some\\..\\..\\path', 'The ../ sequence is not allowed in relative URLs'],\n+\n+            // forbidden data uri\n+            ['data:image/jpeg;base64,test', 'Invalid data URI', [\n+                'allowedDataUris' => []\n+            ]],\n+\n+            // forbidden data uri\n+            ['data:image/png;base64,test', 'Invalid data URI', [\n+                'allowedDataUris' => ['data:image/jpeg;base64']\n+            ]],\n+\n+            // forbidden URL when no domains are accepted\n+            ['https://getkirby.com', 'The hostname \"getkirby.com\" is not allowed', [\n+                'allowedDomains' => []\n+            ]],\n+\n+            // forbidden URL when the particular domain is not accepted\n+            ['https://google.com', 'The hostname \"google.com\" is not allowed', [\n+                'allowedDomains' => [\n+                    'getkirby.com'\n+                ]\n+            ]],\n+\n+            // forbidden invalid email address\n+            ['mailto:test', 'Invalid email address'],\n+\n+            // forbidden phone numbers\n+            ['tel:test', 'Invalid telephone number'],\n+\n+            // forbidden phone numbers - too much formatting\n+            ['tel:+49 (0) 1234 5678', 'Invalid telephone number'],\n+\n+            // forbidden phone numbers - invalid plus sign position\n+            ['tel:491234+5678', 'Invalid telephone number'],\n+\n+            // forbidden URL type\n+            ['javascript:alert()', 'Unknown URL type'],\n+\n+            // forbidden URL type\n+            ['ftp:test', 'Unknown URL type'],\n+\n+            // forbidden URL type\n+            ['ftp://test', 'Unknown URL type'],\n+\n+            // forbidden URL type\n+            ['my-amazing-protocol:test', 'Unknown URL type'],\n+\n+            // forbidden URL type\n+            ['my-amazing-protocol://test', 'Unknown URL type'],\n+        ];\n+    }\n+\n+    /**\n+     * @dataProvider isAllowedUrlProvider\n+     * @covers ::isAllowedUrl\n+     */\n+    public function testIsAllowedUrl(string $url, $expected, array $options = [])\n+    {\n+        $this->assertSame($expected, Dom::isAllowedUrl($url, $options));\n+    }\n+\n+    public function isAllowedUrlCmsProvider()\n+    {\n+        return [\n+            // allowed URL with site at the domain root\n+            ['https://getkirby.com', '/some/path', true],\n+\n+            // allowed URL with site at the domain root\n+            ['/', '/some/path', true],\n+\n+            // allowed URL with site in a subfolder\n+            ['https://getkirby.com/some', '/some/path', true],\n+\n+            // allowed URL with site in a subfolder\n+            ['/some', '/some/path', true],\n+\n+            // disallowed URL with site in a subfolder\n+            ['https://getkirby.com/site', '/some/path', 'The URL points outside of the site index URL'],\n+\n+            // disallowed URL with site in a subfolder\n+            ['/site', '/some/path', 'The URL points outside of the site index URL'],\n+\n+            // disallowed URL with directory traversal\n+            ['https://getkirby.com/site', '/site/../some/path', 'The ../ sequence is not allowed in relative URLs'],\n+\n+            // disallowed URL with directory traversal\n+            ['/site', '/site/../some/path', 'The ../ sequence is not allowed in relative URLs'],\n+        ];\n+    }\n+\n+    /**\n+     * @dataProvider isAllowedUrlCmsProvider\n+     * @covers ::isAllowedUrl\n+     */\n+    public function testIsAllowedUrlCms(string $indexUrl, string $url, $expected)\n+    {\n+        new App([\n+            'urls' => [\n+                'index' => $indexUrl\n+            ]\n+        ]);\n+\n+        $this->assertSame($expected, Dom::isAllowedUrl($url, []));\n+    }\n+\n+    /**\n+     * @covers ::innerMarkup\n+     */\n+    public function testInnerMarkup()\n+    {\n+        // XML markup\n+        $dom  = new Dom('<xml><test>Test <testtest>Test test</testtest>!</test></xml>', 'XML');\n+        $node = $dom->document()->getElementsByTagName('test')[0];\n+        $this->assertSame('Test <testtest>Test test</testtest>!', $dom->innerMarkup($node));\n+\n+        // HTML markup\n+        $dom  = new Dom('<p id=\"test\">Test <strong>Test test</strong>!</p>', 'HTML');\n+        $node = $dom->document()->getElementById('test');\n+        $this->assertSame('Test <strong>Test test</strong>!', $dom->innerMarkup($node));\n+    }\n+\n+    public function listContainsNameProvider(): array\n+    {\n+        return [\n+            // basic tests\n+            [\n+                ['html', 'body'],\n+                ['body', ''],\n+                [],\n+                null,\n+\n+                'body'\n+            ],\n+            [\n+                ['html', 'body'],\n+                ['body', ''],\n+                true,\n+                null,\n+\n+                'body'\n+            ],\n+            [\n+                ['html', 'body'],\n+                ['script', ''],\n+                [],\n+                null,\n+\n+                false\n+            ],\n+            [\n+                ['html', 'body'],\n+                ['script', ''],\n+                true,\n+                null,\n+\n+                false\n+            ],\n+            [\n+                ['html', 'body'],\n+                ['BoDy', ''],\n+                [],\n+                null,\n+\n+                false\n+            ],\n+            [\n+                ['html', 'body'],\n+                ['BoDy', ''],\n+                true,\n+                null,\n+\n+                false\n+            ],\n+\n+            // tests with namespaces\n+            [\n+                ['test', 'another-test'],\n+                ['test', 'https://example.com'],\n+                ['' => 'https://example.com'],\n+                null,\n+\n+                'test' // namespace matches\n+            ],\n+            [\n+                ['test', 'another-test'],\n+                ['test', 'https://example.com'],\n+                true,\n+                null,\n+\n+                'test' // all namespaces allowed\n+            ],\n+            [\n+                ['test', 'another-test'],\n+                ['test', 'https://example.com/different'],\n+                ['' => 'https://example.com'],\n+                null,\n+\n+                false // namespace is not allowed\n+            ],\n+            [\n+                ['test', 'another-test'],\n+                ['test', 'https://example.com'],\n+                ['testns' => 'https://example.com'],\n+                null,\n+\n+                false // namespace name mismatch in list\n+            ],\n+            [\n+                ['test', 'another-test'],\n+                ['testns:test', 'https://example.com'],\n+                ['testns' => 'https://example.com'],\n+                null,\n+\n+                false // the list counts, not the document\n+            ],\n+            [\n+                ['testns:test', 'another-test'],\n+                ['test', 'https://example.com'],\n+                ['testns' => 'https://example.com'],\n+                null,\n+\n+                'testns:test' // correct namespaced configuration\n+            ],\n+            [\n+                ['testns:test', 'another-test'],\n+                ['testns:test', 'https://example.com'],\n+                ['testns' => 'https://example.com'],\n+                null,\n+\n+                'testns:test' // namespace in document does not matter\n+            ],\n+            [\n+                ['testns:test', 'another-test'],\n+                ['customns:test', 'https://example.com'],\n+                ['testns' => 'https://example.com'],\n+                null,\n+\n+                'testns:test' // namespace in document does not matter\n+            ],\n+            [\n+                ['testns:test', 'another-test'],\n+                ['testns:test', null],\n+                ['testns' => 'https://example.com'],\n+                null,\n+\n+                'testns:test' // namespace not defined in document\n+            ],\n+            [\n+                ['testns:test', 'another-test'],\n+                ['testns:test', null],\n+                true,\n+                null,\n+\n+                'testns:test' // all namespaces allowed, local name check\n+            ],\n+            [\n+                ['testns:test', 'another-test'],\n+                ['testns:test', 'https://example.com'],\n+                true,\n+                null,\n+\n+                false // local name check fails because node has namespace\n+            ],\n+\n+            // custom compare function\n+            [\n+                ['html', 'bodY'],\n+                ['BoDy', ''],\n+                [],\n+                function ($expected, $real): bool {\n+                    return strtolower($expected) === strtolower($real);\n+                },\n+\n+                'bodY'\n+            ],\n+            [\n+                ['html', 'bodY'],\n+                ['BoDy', ''],\n+                true,\n+                function ($expected, $real): bool {\n+                    return strtolower($expected) === strtolower($real);\n+                },\n+\n+                'bodY'\n+            ],\n+        ];\n+    }\n+\n+    /**\n+     * @dataProvider listContainsNameProvider\n+     * @covers ::listContainsName\n+     */\n+    public function testListContainsName(array $list, array $node, $allowedNamespaces, ?Closure $compare, $expected)\n+    {\n+        [$nodeName, $nodeNS] = $node;\n+        if ($nodeNS !== null) {\n+            $element = new DOMElement($nodeName, null, $nodeNS);\n+        } else {\n+            $element = (new DOMDocument())->createElement($nodeName);\n+        }\n+\n+        $options = ['allowedNamespaces' => $allowedNamespaces];\n+\n+        $this->assertSame($expected, Dom::listContainsName($list, $element, $options, $compare));\n+    }\n+\n+    /**\n+     * @covers ::remove\n+     */\n+    public function testRemove()\n+    {\n+        $dom = new Dom('<p>Test <strong id=\"strong\">Test test</strong>!</p>', 'HTML');\n+\n+        Dom::remove($dom->document()->getElementById('strong'));\n+        $this->assertSame('<p>Test !</p>', $dom->toString());\n+    }\n+\n+    /**\n+     * @covers ::query\n+     */\n+    public function testQuery()\n+    {\n+        $dom = new Dom('<span>Test <span>Test test</span>!</span>', 'HTML');\n+\n+        // global query\n+        $node = $dom->query('descendant::span')[0];\n+        $this->assertSame('<span>Test <span>Test test</span>!</span>', $dom->document()->saveHtml($node));\n+\n+        // query within a context node\n+        $node = $dom->query('descendant::span', $node)[0];\n+        $this->assertSame('<span>Test test</span>', $dom->document()->saveHtml($node));\n+    }\n+\n+    public function sanitizeProvider(): array\n+    {\n+        return [\n+            // defaults\n+            [\n+                '<p>This <strong id=\"test\">is a test</strong>!</p>',\n+                [],\n+\n+                '<p>This <strong id=\"test\">is a test</strong>!</p>',\n+                []\n+            ],\n+            [\n+                '<a href=\"https://getkirby.com/test\">Link</a>',\n+                [],\n+\n+                '<a href=\"https://getkirby.com/test\">Link</a>',\n+                []\n+            ],\n+            [\n+                '<p style=\"background: url(https://getkirby.com/test)\">Lorem ipsum</p>',\n+                [],\n+\n+                '<p style=\"background: url(https://getkirby.com/test)\">Lorem ipsum</p>',\n+                []\n+            ],\n+            [\n+                '<img src=\"data:image/jpeg;base64,test\"/>',\n+                [],\n+\n+                '<img src=\"data:image/jpeg;base64,test\"/>',\n+                []\n+            ],\n+            [\n+                \"<p>\\n<a href='javascript:alert()'>Link</a>\\n</p>\",\n+                [],\n+\n+                \"<p>\\n<a>Link</a>\\n</p>\",\n+                ['The URL is not allowed in attribute \"href\" (line 2): Unknown URL type']\n+            ],\n+            [\n+                \"<p>\\n<img src='javascript:alert()'/>\\n</p>\",\n+                [],\n+\n+                \"<p>\\n<img/>\\n</p>\",\n+                ['The URL is not allowed in attribute \"src\" (line 2): Unknown URL type']\n+            ],\n+            [\n+                '<a xmlns:xlink=\"https://example.com\" xlink:href=\"https://getkirby.com\">Link</a>',\n+                [],\n+\n+                '<a xmlns:xlink=\"https://example.com\" xlink:href=\"https://getkirby.com\">Link</a>',\n+                []\n+            ],\n+            [\n+                '<a xlink:href=\"javascript:alert()\">Link</a>',\n+                [],\n+\n+                '<a>Link</a>',\n+                ['The URL is not allowed in attribute \"xlink:href\" (line 1): Unknown URL type']\n+            ],\n+            [\n+                '<a xmlns:xlink=\"https://example.com\" xlink:href=\"javascript:alert()\">Link</a>',\n+                [],\n+\n+                '<a xmlns:xlink=\"https://example.com\">Link</a>',\n+                ['The URL is not allowed in attribute \"xlink:href\" (line 1): Unknown URL type']\n+            ],\n+            [\n+                '<p style=\"background: url(javascript:alert())\">Lorem ipsum</p>',\n+                [],\n+\n+                '<p>Lorem ipsum</p>',\n+                ['The URL is not allowed in attribute \"style\" (line 1): Unknown URL type']\n+            ],\n+            [\n+                '<?xml-stylesheet href=\"stylesheet.css\"?><p>This is a test</p>',\n+                [],\n+\n+                \"<?xml-stylesheet href=\\\"stylesheet.css\\\"?>\\n<p>This is a test</p>\",\n+                []\n+            ],\n+\n+            // allowedAttrPrefixes\n+            [\n+                '<p aria-label=\"Test\" data-test=\"Test\">This is a test</p>',\n+                [\n+                    'allowedAttrPrefixes' => ['aria-'],\n+                ],\n+\n+                '<p aria-label=\"Test\" data-test=\"Test\">This is a test</p>',\n+                []\n+            ],\n+            [\n+                '<p aria-label=\"Test\" data-test=\"Test\">This is a test</p>',\n+                [\n+                    'allowedAttrPrefixes' => ['aria-'],\n+                    'allowedAttrs'        => [],\n+                ],\n+\n+                '<p aria-label=\"Test\">This is a test</p>',\n+                ['The \"data-test\" attribute (line 1) is not allowed: Not included in the global allowlist']\n+            ],\n+\n+            // allowedAttrs\n+            [\n+                '<p class=\"test\" onload=\"alert()\">This is a test</p>',\n+                [\n+                    'allowedAttrs' => ['class', 'on'],\n+                ],\n+\n+                '<p class=\"test\">This is a test</p>',\n+                ['The \"onload\" attribute (line 1) is not allowed: Not included in the global allowlist']\n+            ],\n+\n+            // allowedDataUris\n+            [\n+                \"<html>\\n<img class='jpeg' src='data:image/jpeg;base64,test'/>\\n<img class='png' src='data:image/png;base64,test'/>\\n</html>\",\n+                [\n+                    'allowedDataUris' => ['data:image/jpeg'],\n+                ],\n+\n+                \"<html>\\n<img class=\\\"jpeg\\\" src=\\\"data:image/jpeg;base64,test\\\"/>\\n<img class=\\\"png\\\"/>\\n</html>\",\n+                ['The URL is not allowed in attribute \"src\" (line 3): Invalid data URI']\n+            ],\n+\n+            // allowedDomains\n+            [\n+                '<a href=\"https://getkirby.com/test\" src=\"http://example.com/\">Link</a>',\n+                [\n+                    'allowedDomains' => ['getkirby.com']\n+                ],\n+\n+                '<a href=\"https://getkirby.com/test\">Link</a>',\n+                ['The URL is not allowed in attribute \"src\" (line 1): The hostname \"example.com\" is not allowed']\n+            ],\n+\n+            // allowedNamespaces\n+            [\n+                '<p class=\"test\">Lorem ipsum</p>',\n+                [\n+                    'allowedNamespaces' => ['' => 'https://example.com/test', 'xlink' => 'http://www.w3.org/1999/xlink']\n+                ],\n+\n+                '<p class=\"test\">Lorem ipsum</p>',\n+                []\n+            ],\n+            [\n+                '<p xmlns:test=\"https://example.com/test\" xmlns:mylink=\"http://www.w3.org/1999/xlink\" id=\"p\" test:class=\"test\">Lorem ipsum</p>',\n+                [\n+                    'allowedNamespaces' => ['' => 'https://example.com/test', 'xlink' => 'http://www.w3.org/1999/xlink']\n+                ],\n+\n+                '<p xmlns:test=\"https://example.com/test\" xmlns:mylink=\"http://www.w3.org/1999/xlink\" id=\"p\" test:class=\"test\">Lorem ipsum</p>',\n+                []\n+            ],\n+            [\n+                '<p xmlns:test=\"https://example.com/\" xmlns:mylink=\"http://www.w3.org/1999/xlink\">Lorem ipsum</p>',\n+                [\n+                    'allowedNamespaces' => ['' => 'https://example.com/test', 'xlink' => 'http://www.w3.org/1999/xlink']\n+                ],\n+\n+                '<p xmlns:mylink=\"http://www.w3.org/1999/xlink\">Lorem ipsum</p>',\n+                ['The namespace \"https://example.com/\" is not allowed (around line 1)']\n+            ],\n+            [\n+                '<p xmlns:test=\"https://example.com/test\" aria-label=\"p\" test:aria-role=\"test\">Lorem ipsum</p>',\n+                [\n+                    'allowedAttrs' => [],\n+                    'allowedAttrPrefixes' => ['aria-'],\n+                    'allowedNamespaces' => ['' => 'https://example.com/test']\n+                ],\n+\n+                '<p xmlns:test=\"https://example.com/test\" aria-label=\"p\" test:aria-role=\"test\">Lorem ipsum</p>',\n+                []\n+            ],\n+            [\n+                '<a xmlns:test=\"https://example.com/test\" aria-label=\"p\" test:aria-role=\"test\">Link</a>',\n+                [\n+                    'allowedAttrs' => [],\n+                    'allowedAttrPrefixes' => ['namespace:aria-'],\n+                    'allowedNamespaces' => ['namespace' => 'https://example.com/test']\n+                ],\n+\n+                '<a xmlns:test=\"https://example.com/test\" test:aria-role=\"test\">Link</a>',\n+                ['The \"aria-label\" attribute (line 1) is not allowed: Not included in the global allowlist']\n+            ],\n+            [\n+                '<p xmlns:test=\"https://example.com/test\" xmlns:mylink=\"http://www.w3.org/1999/xlink\" id=\"p\" test:class=\"test\">Lorem ipsum</p>',\n+                [\n+                    'allowedAttrs' => ['class', 'id'],\n+                    'allowedNamespaces' => ['' => 'https://example.com/test', 'xlink' => 'http://www.w3.org/1999/xlink']\n+                ],\n+\n+                '<p xmlns:test=\"https://example.com/test\" xmlns:mylink=\"http://www.w3.org/1999/xlink\" id=\"p\" test:class=\"test\">Lorem ipsum</p>',\n+                []\n+            ],\n+            [\n+                '<a xmlns:mylink=\"http://www.w3.org/1999/xlink\" mylink:href=\"https://getkirby.com\">Link</a>',\n+                [\n+                    'allowedAttrs' => ['xlink:href'],\n+                    'allowedNamespaces' => ['' => 'https://example.com/test', 'xlink' => 'http://www.w3.org/1999/xlink']\n+                ],\n+\n+                '<a xmlns:mylink=\"http://www.w3.org/1999/xlink\" mylink:href=\"https://getkirby.com\">Link</a>',\n+                []\n+            ],\n+            [\n+                '<a xmlns:mylink=\"http://www.w3.org/1999/xlink\" mylink:test=\"https://getkirby.com\">Link</a>',\n+                [\n+                    'allowedAttrs' => ['xlink:href'],\n+                    'allowedNamespaces' => ['' => 'https://example.com/test', 'xlink' => 'http://www.w3.org/1999/xlink']\n+                ],\n+\n+                '<a xmlns:mylink=\"http://www.w3.org/1999/xlink\">Link</a>',\n+                ['The \"mylink:test\" attribute (line 1) is not allowed: Not included in the global allowlist']\n+            ],\n+            [\n+                '<a xmlns:mylink=\"http://www.w3.org/1999/xlink\" mylink:href=\"https://getkirby.com\" mylink:test=\"https://getkirby.com\">Link</a>',\n+                [\n+                    'allowedAttrs' => [],\n+                    'allowedNamespaces' => ['xlink' => 'http://www.w3.org/1999/xlink'],\n+                    'allowedTags' => ['a' => ['xlink:href']]\n+                ],\n+\n+                '<a xmlns:mylink=\"http://www.w3.org/1999/xlink\" mylink:href=\"https://getkirby.com\">Link</a>',\n+                ['The \"mylink:test\" attribute (line 1) is not allowed: Not allowed by the \"a\" element']\n+            ],\n+            [\n+                '<xml xmlns:test=\"https://example.com/test\"><a>A</a><test:b>B</test:b></xml>',\n+                [\n+                    'allowedNamespaces' => ['test' => 'https://example.com/test'],\n+                    'allowedTags' => ['xml' => true, 'a' => true, 'test:b' => true]\n+                ],\n+\n+                '<xml xmlns:test=\"https://example.com/test\"><a>A</a><test:b>B</test:b></xml>',\n+                []\n+            ],\n+            [\n+                '<xml xmlns=\"https://example.com/test\"><a>A</a></xml>',\n+                [\n+                    'allowedNamespaces' => ['test' => 'https://example.com/test'],\n+                    'allowedTags' => ['test:xml' => true, 'test:a' => true]\n+                ],\n+\n+                '<xml xmlns=\"https://example.com/test\"><a>A</a></xml>',\n+                []\n+            ],\n+            [\n+                '<xml xmlns=\"https://example.com/test\"><a>A</a></xml>',\n+                [\n+                    'allowedNamespaces' => ['test' => 'https://example.com/test'],\n+                    'allowedTags' => ['xml' => true, 'test:a' => true]\n+                ],\n+\n+                '<a xmlns=\"https://example.com/test\">A</a>',\n+                ['The \"xml\" element (line 1) is not allowed, but its children can be kept']\n+            ],\n+            [\n+                '<xml xmlns:test=\"https://example.com/test\"><a>A</a><test:b>B</test:b></xml>',\n+                [\n+                    'allowedNamespaces' => ['test' => 'https://example.com/test'],\n+                    'allowedTags' => ['xml' => true, 'a' => true, 'b' => true]\n+                ],\n+\n+                '<xml xmlns:test=\"https://example.com/test\"><a>A</a></xml>',\n+                ['The \"test:b\" element (line 1) is not allowed, but its children can be kept']\n+            ],\n+            [\n+                '<xml xmlns:test=\"https://example.com/test\"><a>A</a></xml>',\n+                [\n+                    'allowedNamespaces' => ['test' => 'https://example.com/test'],\n+                    'allowedTags' => ['xml' => true, 'test:a' => true]\n+                ],\n+\n+                '<xml xmlns:test=\"https://example.com/test\"/>',\n+                ['The \"a\" element (line 1) is not allowed, but its children can be kept']\n+            ],\n+            [\n+                '<a xmlns:mylink=\"http://www.w3.org/1999/xlink\" href=\"javascript:\" mylink:href=\"javascript:\" mylink:test=\"javascript:\">Link</a>',\n+                [\n+                    'allowedNamespaces' => ['xlink' => 'http://www.w3.org/1999/xlink'],\n+                    'urlAttrs' => ['href', 'xlink:test']\n+                ],\n+\n+                '<a xmlns:mylink=\"http://www.w3.org/1999/xlink\" mylink:href=\"javascript:\">Link</a>',\n+                [\n+                    'The URL is not allowed in attribute \"href\" (line 1): Unknown URL type',\n+                    'The URL is not allowed in attribute \"mylink:test\" (line 1): Unknown URL type'\n+                ]\n+            ],\n+            [\n+                '<a xmlns:mylink=\"http://www.w3.org/1999/xlink\" href=\"javascript:\" mylink:href=\"javascript:\" mylink:test=\"javascript:\">Link</a>',\n+                [\n+                    'allowedNamespaces' => ['xlink' => 'http://www.w3.org/1999/xlink'],\n+                    'urlAttrs' => ['href', 'xlink:href']\n+                ],\n+\n+                '<a xmlns:mylink=\"http://www.w3.org/1999/xlink\" mylink:test=\"javascript:\">Link</a>',\n+                [\n+                    'The URL is not allowed in attribute \"href\" (line 1): Unknown URL type',\n+                    'The URL is not allowed in attribute \"mylink:href\" (line 1): Unknown URL type'\n+                ]\n+            ],\n+            [\n+                '<xml xmlns:test=\"https://example.com/test\"><a>A</a></xml>',\n+                [\n+                    'allowedNamespaces' => ['test' => 'https://example.com/test'],\n+                    'disallowedTags' => ['a']\n+                ],\n+\n+                '<xml xmlns:test=\"https://example.com/test\"/>',\n+                ['The \"a\" element (line 1) is not allowed']\n+            ],\n+            [\n+                '<xml xmlns:test=\"https://example.com/test\"><a>A</a></xml>',\n+                [\n+                    'allowedNamespaces' => ['test' => 'https://example.com/test'],\n+                    'disallowedTags' => ['test:a']\n+                ],\n+\n+                '<xml xmlns:test=\"https://example.com/test\"><a>A</a></xml>',\n+                []\n+            ],\n+            [\n+                '<xml xmlns:namespace=\"https://example.com/test\"><namespace:a>A</namespace:a></xml>',\n+                [\n+                    'allowedNamespaces' => ['test' => 'https://example.com/test'],\n+                    'disallowedTags' => ['test:a']\n+                ],\n+\n+                '<xml xmlns:namespace=\"https://example.com/test\"/>',\n+                ['The \"namespace:a\" element (line 1) is not allowed']\n+            ],\n+            [\n+                '<xml xmlns:namespace=\"https://example.com/test\"><namespace:a>A</namespace:a></xml>',\n+                [\n+                    'allowedNamespaces' => ['' => 'https://example.com/test'],\n+                    'disallowedTags' => ['a']\n+                ],\n+\n+                '<xml xmlns:namespace=\"https://example.com/test\"/>',\n+                ['The \"namespace:a\" element (line 1) is not allowed']\n+            ],\n+\n+            // allowedPIs\n+            [\n+                '<?xml-stylesheet href=\"stylesheet.css\"?><?invalid-instruction href=\"https://malicious.com\"?><p>This is a test</p>',\n+                [\n+                    'allowedPIs' => ['xml-stylesheet']\n+                ],\n+\n+                \"<?xml-stylesheet href=\\\"stylesheet.css\\\"?>\\n<p>This is a test</p>\",\n+                ['The \"invalid-instruction\" processing instruction (line 1) is not allowed']\n+            ],\n+\n+            // allowedTags\n+            [\n+                '<xml><a>A</a><b>B</b></xml>',\n+                [\n+                    'allowedTags' => ['xml' => true, 'a' => true]\n+                ],\n+\n+                '<xml><a>A</a></xml>',\n+                ['The \"b\" element (line 1) is not allowed, but its children can be kept']\n+            ],\n+            [\n+                \"<xml id='xml' class='test'>\\n<a id='a' class='test'>A</a>\\n</xml>\",\n+                [\n+                    'allowedAttrs' => ['id'],\n+                    'allowedTags' => ['xml' => true, 'a' => false]\n+                ],\n+\n+                \"<xml id=\\\"xml\\\">\\n<a>A</a>\\n</xml>\",\n+                [\n+                    'The \"class\" attribute (line 1) is not allowed: Not included in the global allowlist',\n+                    'The \"id\" attribute (line 2) is not allowed: The \"a\" element does not allow attributes',\n+                    'The \"class\" attribute (line 2) is not allowed: The \"a\" element does not allow attributes'\n+                ]\n+            ],\n+            [\n+                \"<xml aria-role='xml' class='test'>\\n<a aria-role='a' class='test'>A</a>\\n</xml>\",\n+                [\n+                    'allowedAttrs' => [],\n+                    'allowedAttrPrefixes' => ['aria-'],\n+                    'allowedTags' => ['xml' => true, 'a' => false]\n+                ],\n+\n+                \"<xml aria-role=\\\"xml\\\">\\n<a>A</a>\\n</xml>\",\n+                [\n+                    'The \"class\" attribute (line 1) is not allowed: Not included in the global allowlist',\n+                    'The \"aria-role\" attribute (line 2) is not allowed: The \"a\" element does not allow attributes',\n+                    'The \"class\" attribute (line 2) is not allowed: The \"a\" element does not allow attributes'\n+                ]\n+            ],\n+            [\n+                '<xml><a class=\"test\" xmlns=\"https://example.com/test\"><b>B1</b><b>B2</b></a></xml>',\n+                [\n+                    'allowedTags' => ['xml' => true, 'b' => true]\n+                ],\n+\n+                '<xml><b xmlns=\"https://example.com/test\">B1</b><b xmlns=\"https://example.com/test\">B2</b></xml>',\n+                ['The \"a\" element (line 1) is not allowed, but its children can be kept']\n+            ],\n+\n+            // attrCallback\n+            [\n+                '<xml a=\"A\" b=\"B\"/>',\n+                [\n+                    'attrCallback' => function (DOMAttr $attr): void {\n+                        // no return value\n+                    }\n+                ],\n+\n+                '<xml a=\"A\" b=\"B\"/>',\n+                []\n+            ],\n+            [\n+                '<xml a=\"A\" b=\"B\"/>',\n+                [\n+                    'attrCallback' => function (DOMAttr $attr): array {\n+                        if ($attr->nodeName === 'b') {\n+                            $attr->ownerElement->removeAttributeNode($attr);\n+                            return [new InvalidArgumentException('The \"b\" attribute is not allowed')];\n+                        }\n+\n+                        return [];\n+                    }\n+                ],\n+\n+                '<xml a=\"A\"/>',\n+                ['The \"b\" attribute is not allowed']\n+            ],\n+\n+            // disallowedTags\n+            [\n+                '<xml><a>A1</a><disallowed class=\"test\"><a class=\"test\">A2</a></disallowed></xml>',\n+                [\n+                    'disallowedTags' => ['disallowed']\n+                ],\n+\n+                '<xml><a>A1</a></xml>',\n+                ['The \"disallowed\" element (line 1) is not allowed']\n+            ],\n+            [\n+                '<xml><a>A1</a><disAllowed class=\"test\"><a class=\"test\">A2</a></disAllowed></xml>',\n+                [\n+                    'disallowedTags' => ['DISallowed']\n+                ],\n+\n+                '<xml><a>A1</a></xml>',\n+                ['The \"disAllowed\" element (line 1) is not allowed']\n+            ],\n+\n+            // doctype defaults and doctypeCallback\n+            [\n+                '<!DOCTYPE xml><xml/>',\n+                [],\n+\n+                \"<!DOCTYPE xml>\\n<xml/>\",\n+                []\n+            ],\n+            [\n+                '<!DOCTYPE xml PUBLIC \"SOMETHING\" \"https://malicious.com/something.dtd\"><xml/>',\n+                [],\n+\n+                '<xml/>',\n+                ['The doctype must not reference external files']\n+            ],\n+            [\n+                '<!DOCTYPE xml SYSTEM \"https://malicious.com/something.dtd\"><xml/>',\n+                [],\n+\n+                '<xml/>',\n+                ['The doctype must not reference external files']\n+            ],\n+            [\n+                '<!DOCTYPE xml [<!ENTITY lol \"lol\">]><xml/>',\n+                [],\n+\n+                '<xml/>',\n+                ['The doctype must not define a subset']\n+            ],\n+            [\n+                '<!DOCTYPE svg><xml/>',\n+                [\n+                    'doctypeCallback' => function (DOMDocumentType $doctype): void {\n+                        throw new InvalidArgumentException('The \"' . $doctype->name . '\" doctype is not allowed');\n+                    }\n+                ],\n+\n+                '<xml/>',\n+                ['The \"svg\" doctype is not allowed']\n+            ],\n+\n+            // elementCallback\n+            [\n+                '<xml><a class=\"a\">A</a><b class=\"b\">B</b></xml>',\n+                [\n+                    'elementCallback' => function (DOMElement $element): void {\n+                        // no return value\n+                    }\n+                ],\n+\n+                '<xml><a class=\"a\">A</a><b class=\"b\">B</b></xml>',\n+                []\n+            ],\n+            [\n+                '<xml><a class=\"a\">A</a><b class=\"b\">B</b></xml>',\n+                [\n+                    'elementCallback' => function (DOMElement $element): array {\n+                        if ($element->nodeName === 'b') {\n+                            Dom::remove($element);\n+                            return [new InvalidArgumentException('The \"b\" element is not allowed')];\n+                        }\n+\n+                        return [];\n+                    }\n+                ],\n+\n+                '<xml><a class=\"a\">A</a></xml>',\n+                ['The \"b\" element is not allowed']\n+            ],\n+\n+            // urlAttrs\n+            [\n+                '<a class=\"javascript:alert()\" href=\"javascript:alert()\"/>',\n+                [\n+                    'urlAttrs' => []\n+                ],\n+\n+                '<a class=\"javascript:alert()\" href=\"javascript:alert()\"/>',\n+                []\n+            ],\n+            [\n+                '<a class=\"javascript:alert()\" href=\"javascript:alert()\"/>',\n+                [\n+                    'urlAttrs' => ['href']\n+                ],\n+\n+                '<a class=\"javascript:alert()\"/>',\n+                ['The URL is not allowed in attribute \"href\" (line 1): Unknown URL type']\n+            ]\n+        ];\n+    }\n+\n+    /**\n+     * @dataProvider sanitizeProvider\n+     * @covers ::sanitize\n+     * @covers ::sanitizeAttr\n+     * @covers ::sanitizeDoctype\n+     * @covers ::sanitizeElement\n+     * @covers ::sanitizePI\n+     * @covers ::validateDoctype\n+     */\n+    public function testSanitize(string $code, array $options, string $expectedCode, array $expectedErrors)\n+    {\n+        $dom    = new Dom($code, 'XML');\n+        $errors = $dom->sanitize($options);\n+\n+        $this->assertSame($expectedErrors, array_map(function ($error) {\n+            return $error->getMessage();\n+        }, $errors));\n+        $this->assertSame($expectedCode, $dom->toString());\n+    }\n+\n+    /**\n+     * @covers ::sanitize\n+     * @covers ::sanitizeDoctype\n+     * @covers ::validateDoctype\n+     */\n+    public function testSanitizeDoctypeCallbackException()\n+    {\n+        $this->expectException('Exception');\n+        $this->expectExceptionMessage('This exception is not caught as validation error');\n+\n+        $dom = new Dom('<!DOCTYPE xml><xml/>', 'XML');\n+        $dom->sanitize([\n+            'doctypeCallback' => function (DOMDocumentType $doctype): void {\n+                throw new \\InvalidArgumentException('This exception is not caught as validation error');\n+            }\n+        ]);\n+    }\n+\n+    /**\n+     * @covers ::unwrap\n+     */\n+    public function testUnwrap()\n+    {\n+        $dom = new Dom('<body><p>This is a test</p><invalid>And this is <p>Awesome<strong>!</strong></p> but contains text</invalid></body>', 'HTML');\n+\n+        $node = $dom->document()->getElementsByTagName('invalid')[0];\n+        Dom::unwrap($node);\n+\n+        $this->assertSame('<body><p>This is a test</p><p>Awesome<strong>!</strong></p></body>', $dom->toString());\n+    }\n+}"
        },
        {
          "filename": "vendor/composer/autoload_classmap.php",
          "status": "modified",
          "additions": 3,
          "deletions": 0,
          "patch": "@@ -199,7 +199,9 @@\n     'Kirby\\\\Parsley\\\\Schema' => $baseDir . '/src/Parsley/Schema.php',\n     'Kirby\\\\Parsley\\\\Schema\\\\Blocks' => $baseDir . '/src/Parsley/Schema/Blocks.php',\n     'Kirby\\\\Parsley\\\\Schema\\\\Plain' => $baseDir . '/src/Parsley/Schema/Plain.php',\n+    'Kirby\\\\Sane\\\\DomHandler' => $baseDir . '/src/Sane/DomHandler.php',\n     'Kirby\\\\Sane\\\\Handler' => $baseDir . '/src/Sane/Handler.php',\n+    'Kirby\\\\Sane\\\\Html' => $baseDir . '/src/Sane/Html.php',\n     'Kirby\\\\Sane\\\\Sane' => $baseDir . '/src/Sane/Sane.php',\n     'Kirby\\\\Sane\\\\Svg' => $baseDir . '/src/Sane/Svg.php',\n     'Kirby\\\\Sane\\\\Svgz' => $baseDir . '/src/Sane/Svgz.php',\n@@ -220,6 +222,7 @@\n     'Kirby\\\\Toolkit\\\\Config' => $baseDir . '/src/Toolkit/Config.php',\n     'Kirby\\\\Toolkit\\\\Controller' => $baseDir . '/src/Toolkit/Controller.php',\n     'Kirby\\\\Toolkit\\\\Dir' => $baseDir . '/src/Toolkit/Dir.php',\n+    'Kirby\\\\Toolkit\\\\Dom' => $baseDir . '/src/Toolkit/Dom.php',\n     'Kirby\\\\Toolkit\\\\Escape' => $baseDir . '/src/Toolkit/Escape.php',\n     'Kirby\\\\Toolkit\\\\F' => $baseDir . '/src/Toolkit/F.php',\n     'Kirby\\\\Toolkit\\\\Facade' => $baseDir . '/src/Toolkit/Facade.php',"
        },
        {
          "filename": "vendor/composer/autoload_static.php",
          "status": "modified",
          "additions": 3,
          "deletions": 0,
          "patch": "@@ -294,7 +294,9 @@ class ComposerStaticInitc26333d865e0329b638bdc17afd29896\n         'Kirby\\\\Parsley\\\\Schema' => __DIR__ . '/../..' . '/src/Parsley/Schema.php',\n         'Kirby\\\\Parsley\\\\Schema\\\\Blocks' => __DIR__ . '/../..' . '/src/Parsley/Schema/Blocks.php',\n         'Kirby\\\\Parsley\\\\Schema\\\\Plain' => __DIR__ . '/../..' . '/src/Parsley/Schema/Plain.php',\n+        'Kirby\\\\Sane\\\\DomHandler' => __DIR__ . '/../..' . '/src/Sane/DomHandler.php',\n         'Kirby\\\\Sane\\\\Handler' => __DIR__ . '/../..' . '/src/Sane/Handler.php',\n+        'Kirby\\\\Sane\\\\Html' => __DIR__ . '/../..' . '/src/Sane/Html.php',\n         'Kirby\\\\Sane\\\\Sane' => __DIR__ . '/../..' . '/src/Sane/Sane.php',\n         'Kirby\\\\Sane\\\\Svg' => __DIR__ . '/../..' . '/src/Sane/Svg.php',\n         'Kirby\\\\Sane\\\\Svgz' => __DIR__ . '/../..' . '/src/Sane/Svgz.php',\n@@ -315,6 +317,7 @@ class ComposerStaticInitc26333d865e0329b638bdc17afd29896\n         'Kirby\\\\Toolkit\\\\Config' => __DIR__ . '/../..' . '/src/Toolkit/Config.php',\n         'Kirby\\\\Toolkit\\\\Controller' => __DIR__ . '/../..' . '/src/Toolkit/Controller.php',\n         'Kirby\\\\Toolkit\\\\Dir' => __DIR__ . '/../..' . '/src/Toolkit/Dir.php',\n+        'Kirby\\\\Toolkit\\\\Dom' => __DIR__ . '/../..' . '/src/Toolkit/Dom.php',\n         'Kirby\\\\Toolkit\\\\Escape' => __DIR__ . '/../..' . '/src/Toolkit/Escape.php',\n         'Kirby\\\\Toolkit\\\\F' => __DIR__ . '/../..' . '/src/Toolkit/F.php',\n         'Kirby\\\\Toolkit\\\\Facade' => __DIR__ . '/../..' . '/src/Toolkit/Facade.php',"
        },
        {
          "filename": "vendor/composer/installed.php",
          "status": "modified",
          "additions": 4,
          "deletions": 4,
          "patch": "@@ -1,7 +1,7 @@\n <?php return array(\n     'root' => array(\n-        'pretty_version' => '3.5.7.1',\n-        'version' => '3.5.7.1',\n+        'pretty_version' => '3.5.8',\n+        'version' => '3.5.8.0',\n         'type' => 'kirby-cms',\n         'install_path' => __DIR__ . '/../../',\n         'aliases' => array(),\n@@ -29,8 +29,8 @@\n             'dev_requirement' => false,\n         ),\n         'getkirby/cms' => array(\n-            'pretty_version' => '3.5.7.1',\n-            'version' => '3.5.7.1',\n+            'pretty_version' => '3.5.8',\n+            'version' => '3.5.8.0',\n             'type' => 'kirby-cms',\n             'install_path' => __DIR__ . '/../../',\n             'aliases' => array(),"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 4,
        "dependency_files": 0,
        "test_files": 8,
        "unique_directories": 13,
        "max_directory_depth": 5
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "d3f06c71b562b3d25961fcf064349fcb155a0a3e",
            "date": "2025-01-17T22:06:44Z",
            "author_login": "distantnative"
          },
          {
            "sha": "53a5b62c8cd005015589bf21eaed00423aea79cd",
            "date": "2025-01-17T14:55:05Z",
            "author_login": "distantnative"
          },
          {
            "sha": "94cc37ee7c3004ebb4950a53f14e1329ed4d28d3",
            "date": "2024-11-28T10:10:23Z",
            "author_login": "bastianallgeier"
          },
          {
            "sha": "7512f22b46f8a065af3e22ba8ef942d6a0b21c9a",
            "date": "2024-11-27T13:20:40Z",
            "author_login": "bastianallgeier"
          },
          {
            "sha": "470b395c27d7dc79b457ca7b854a27d455398e10",
            "date": "2024-11-27T13:20:04Z",
            "author_login": "bastianallgeier"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 7.3,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:U/C:H/I:H/A:N",
    "cwe_id": "CWE-79",
    "description": "Kirby is an open source file structured CMS ### Impact Kirby's writer field stores its formatted content as HTML code. Unlike with other field types, it is not possible to escape HTML special characters against cross-site scripting (XSS) attacks, otherwise the formatting would be lost. If the user is logged in to the Panel, a harmful script can for example trigger requests to Kirby's API with the permissions of the victim. Because the writer field did not securely sanitize its contents on save, it was possible to inject malicious HTML code into the content file by sending it to Kirby's API directly without using the Panel. This malicious HTML code would then be displayed on the site frontend and executed in the browsers of site visitors and logged in users who are browsing the site. Attackers must be in your group of authenticated Panel users in order to exploit this weakness. Users who do not make use of the writer field are not affected. This issue has been patched in Kirby 3.5.8 by sanitizing all writer field contents on the backend whenever the content is modified via Kirby's API. Please update to this or a later version to fix the vulnerability.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2021-11-16T18:15:07.513",
    "last_modified": "2024-11-21T06:25:53.600",
    "fix_date": "2021-11-16T09:37:11Z"
  },
  "references": [
    {
      "url": "https://github.com/getkirby/kirby/commit/25fc5c6b330442e6433c99befc688f3698c5d1fc",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/getkirby/kirby/releases/tag/3.5.8",
      "source": "security-advisories@github.com",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/getkirby/kirby/security/advisories/GHSA-x7j7-qp7j-hw3q",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/getkirby/kirby/commit/25fc5c6b330442e6433c99befc688f3698c5d1fc",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/getkirby/kirby/releases/tag/3.5.8",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/getkirby/kirby/security/advisories/GHSA-x7j7-qp7j-hw3q",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:34.791973",
    "processing_status": "enhanced"
  },
  "repository_context": {
    "name": "kirby",
    "owner": "getkirby",
    "created_at": "2017-10-06T11:35:25Z",
    "updated_at": "2025-01-26T05:00:06Z",
    "pushed_at": "2025-01-25T22:02:03Z",
    "size": 49575,
    "stars": 1340,
    "forks": 173,
    "open_issues": 167,
    "watchers": 1340,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [
      "develop-minor",
      "develop-patch"
    ],
    "languages": {
      "PHP": 4627131,
      "Vue": 996369,
      "JavaScript": 426063,
      "CSS": 33910,
      "HTML": 11552,
      "Shell": 1881,
      "Hack": 901
    },
    "commit_activity": {
      "total_commits_last_year": 1529,
      "avg_commits_per_week": 29.403846153846153,
      "days_active_last_year": 182
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-26T07:50:25.600173"
  }
}