{
  "cve_id": "CVE-2021-41261",
  "github_data": {
    "repository": "galette/galette",
    "fix_commit": "0d55bc7f420470e0dbca91ebe7899c592905cbc5",
    "related_commits": [
      "0d55bc7f420470e0dbca91ebe7899c592905cbc5",
      "0d55bc7f420470e0dbca91ebe7899c592905cbc5"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "0d55bc7f420470e0dbca91ebe7899c592905cbc5",
      "commit_date": "2021-11-09T07:35:51Z",
      "author": {
        "login": "trasher",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Fix XSS, prevent their storage",
        "length": 84,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 119,
        "additions": 98,
        "deletions": 21
      },
      "files": [
        {
          "filename": "galette/composer.json",
          "status": "modified",
          "additions": 2,
          "deletions": 1,
          "patch": "@@ -49,7 +49,8 @@\n         \"php-di/slim-bridge\": \"2.0.0\",\n         \"doctrine/annotations\": \"^1.8\",\n         \"laminas/laminas-servicemanager\": \"3.7\",\n-        \"symfony/polyfill-php80\": \"^1.23\"\n+        \"symfony/polyfill-php80\": \"^1.23\",\n+        \"ezyang/htmlpurifier\": \"^4.13\"\n     },\n     \"require-dev\": {\n         \"atoum/atoum\": \"dev-master\","
        },
        {
          "filename": "galette/composer.lock",
          "status": "modified",
          "additions": 55,
          "deletions": 1,
          "patch": "@@ -4,7 +4,7 @@\n         \"Read more about it at https://getcomposer.org/doc/01-basic-usage.md#installing-dependencies\",\n         \"This file is @generated automatically\"\n     ],\n-    \"content-hash\": \"abdb30cee5eeb0dad05c159a1c10880d\",\n+    \"content-hash\": \"47d56d47701d9038105bd93cf3b44a02\",\n     \"packages\": [\n         {\n             \"name\": \"akrabat/rka-slim-session-middleware\",\n@@ -366,6 +366,60 @@\n             ],\n             \"time\": \"2020-05-25T17:44:05+00:00\"\n         },\n+        {\n+            \"name\": \"ezyang/htmlpurifier\",\n+            \"version\": \"v4.13.0\",\n+            \"source\": {\n+                \"type\": \"git\",\n+                \"url\": \"https://github.com/ezyang/htmlpurifier.git\",\n+                \"reference\": \"08e27c97e4c6ed02f37c5b2b20488046c8d90d75\"\n+            },\n+            \"dist\": {\n+                \"type\": \"zip\",\n+                \"url\": \"https://api.github.com/repos/ezyang/htmlpurifier/zipball/08e27c97e4c6ed02f37c5b2b20488046c8d90d75\",\n+                \"reference\": \"08e27c97e4c6ed02f37c5b2b20488046c8d90d75\",\n+                \"shasum\": \"\"\n+            },\n+            \"require\": {\n+                \"php\": \">=5.2\"\n+            },\n+            \"require-dev\": {\n+                \"simpletest/simpletest\": \"dev-master#72de02a7b80c6bb8864ef9bf66d41d2f58f826bd\"\n+            },\n+            \"type\": \"library\",\n+            \"autoload\": {\n+                \"psr-0\": {\n+                    \"HTMLPurifier\": \"library/\"\n+                },\n+                \"files\": [\n+                    \"library/HTMLPurifier.composer.php\"\n+                ],\n+                \"exclude-from-classmap\": [\n+                    \"/library/HTMLPurifier/Language/\"\n+                ]\n+            },\n+            \"notification-url\": \"https://packagist.org/downloads/\",\n+            \"license\": [\n+                \"LGPL-2.1-or-later\"\n+            ],\n+            \"authors\": [\n+                {\n+                    \"name\": \"Edward Z. Yang\",\n+                    \"email\": \"admin@htmlpurifier.org\",\n+                    \"homepage\": \"http://ezyang.com\"\n+                }\n+            ],\n+            \"description\": \"Standards compliant HTML filter written in PHP\",\n+            \"homepage\": \"http://htmlpurifier.org/\",\n+            \"keywords\": [\n+                \"html\"\n+            ],\n+            \"support\": {\n+                \"issues\": \"https://github.com/ezyang/htmlpurifier/issues\",\n+                \"source\": \"https://github.com/ezyang/htmlpurifier/tree/master\"\n+            },\n+            \"time\": \"2020-06-29T00:56:53+00:00\"\n+        },\n         {\n             \"name\": \"laminas/laminas-cache\",\n             \"version\": \"2.13.0\","
        },
        {
          "filename": "galette/lib/Galette/Controllers/Crud/PaymentTypeController.php",
          "status": "modified",
          "additions": 7,
          "deletions": 7,
          "patch": "@@ -7,7 +7,7 @@\n  *\n  * PHP version 5\n  *\n- * Copyright \u00a9 2019-2020 The Galette Team\n+ * Copyright \u00a9 2019-2021 The Galette Team\n  *\n  * This file is part of Galette (http://galette.tuxfamily.org).\n  *\n@@ -28,7 +28,7 @@\n  * @package   Galette\n  *\n  * @author    Johan Cwiklinski <johan@x-tnd.be>\n- * @copyright 2019-2020 The Galette Team\n+ * @copyright 2019-2021 The Galette Team\n  * @license   http://www.gnu.org/licenses/gpl-3.0.html GPL License 3.0 or (at your option) any later version\n  * @link      http://galette.tuxfamily.org\n  * @since     Available since 0.9.4dev - 2019-12-09\n@@ -50,7 +50,7 @@\n  * @name      PaymentTypeController\n  * @package   Galette\n  * @author    Johan Cwiklinski <johan@x-tnd.be>\n- * @copyright 2019-2020 The Galette Team\n+ * @copyright 2019-2021 The Galette Team\n  * @license   http://www.gnu.org/licenses/gpl-3.0.html GPL License 3.0 or (at your option) any later version\n  * @link      http://galette.tuxfamily.org\n  * @since     Available since 0.9.4dev - 2019-12-09\n@@ -205,7 +205,7 @@ public function store(Request $request, Response $response, int $id = null): Res\n                     'error_detected',\n                     preg_replace(\n                         '(%s)',\n-                        $ptype->name,\n+                        $ptype->getName(),\n                         _T(\"Payment type '%s' has not been added!\")\n                     )\n                 );\n@@ -214,7 +214,7 @@ public function store(Request $request, Response $response, int $id = null): Res\n                     'error_detected',\n                     preg_replace(\n                         '(%s)',\n-                        $ptype->name,\n+                        $ptype->getName(),\n                         _T(\"Payment type '%s' has not been modified!\")\n                     )\n                 );\n@@ -227,7 +227,7 @@ public function store(Request $request, Response $response, int $id = null): Res\n                     'success_detected',\n                     preg_replace(\n                         '(%s)',\n-                        $ptype->name,\n+                        $ptype->getName(),\n                         _T(\"Payment type '%s' has been successfully added.\")\n                     )\n                 );\n@@ -236,7 +236,7 @@ public function store(Request $request, Response $response, int $id = null): Res\n                     'success_detected',\n                     preg_replace(\n                         '(%s)',\n-                        $ptype->name,\n+                        $ptype->getName(),\n                         _T(\"Payment type '%s' has been successfully modified.\")\n                     )\n                 );"
        },
        {
          "filename": "galette/lib/Galette/Core/Preferences.php",
          "status": "modified",
          "additions": 20,
          "deletions": 0,
          "patch": "@@ -755,6 +755,9 @@ public function validateValue($fieldname, $value)\n                     $this->errors[] = _T(\"- Invalid year for cards.\");\n                 }\n                 break;\n+            case 'pref_footer':\n+                $value = $this->cleanHtmlValue($value);\n+                break;\n         }\n \n         return $value;\n@@ -961,6 +964,8 @@ public function __get($name)\n                 && $name == 'pref_mail_method'\n             ) {\n                 return GaletteMail::METHOD_DISABLED;\n+            } elseif ($name == 'pref_footer') {\n+                return $this->cleanHtmlValue($this->prefs[$name]);\n             } else {\n                 if ($name == 'pref_adhesion_form' && $this->prefs[$name] == '') {\n                     $this->prefs[$name] = self::$defaults['pref_adhesion_form'];\n@@ -1294,4 +1299,19 @@ public function setSocialReplacements(): self\n \n         return $this;\n     }\n+\n+    /**\n+     * Purify HTML value\n+     *\n+     * @param string $value Value to clean\n+     *\n+     * @return string\n+     */\n+    public function cleanHtmlValue(string $value): string\n+    {\n+        $config = \\HTMLPurifier_Config::createDefault();\n+        $config->set('Cache.SerializerPath', GALETTE_CACHE_DIR);\n+        $purifier = new \\HTMLPurifier($config);\n+        return $purifier->purify($value);\n+    }\n }"
        },
        {
          "filename": "galette/lib/Galette/Entity/Entitled.php",
          "status": "modified",
          "additions": 2,
          "deletions": 0,
          "patch": "@@ -429,6 +429,7 @@ public function getIdByLabel($label)\n     public function add($label, $extra)\n     {\n         // Avoid duplicates.\n+        $label = strip_tags($label);\n         $ret = $this->getIdByLabel($label);\n \n         if ($ret !== false) {\n@@ -489,6 +490,7 @@ public function add($label, $extra)\n      */\n     public function update($id, $label, $extra)\n     {\n+        $label = strip_tags($label);\n         $ret = $this->get($id);\n         if (!$ret) {\n             /* get() already logged and set $this->error. */"
        },
        {
          "filename": "galette/lib/Galette/Entity/Title.php",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -139,8 +139,8 @@ private function loadFromRs($rs)\n     public function store($zdb)\n     {\n         $data = array(\n-            'short_label'   => $this->short,\n-            'long_label'    => $this->long\n+            'short_label'   => strip_tags($this->short),\n+            'long_label'    => strip_tags($this->long)\n         );\n         try {\n             if ($this->id !== null && $this->id > 0) {"
        },
        {
          "filename": "galette/lib/Galette/Entity/Transaction.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -357,7 +357,7 @@ public function check($values, $required, $disabled)\n                             break;\n                         case 'trans_desc':\n                             /** TODO: retrieve field length from database and check that */\n-                            $this->_description = $value;\n+                            $this->_description = strip_tags($value);\n                             if (mb_strlen($value) > 150) {\n                                 $this->errors[] = _T(\"- Transaction description must be 150 characters long maximum.\");\n                             }"
        },
        {
          "filename": "galette/templates/default/gestion_intitule_content.tpl",
          "status": "modified",
          "additions": 3,
          "deletions": 3,
          "patch": "@@ -57,7 +57,7 @@\n                     {$eid}\n                     <span class=\"row-title\">\n                         <a href=\"{path_for name=\"editEntitled\" data=[\"class\" => $url_class, \"action\" => \"edit\", \"id\" => $eid]}\">\n-                            {_T string=\"%s field\" pattern=\"/%s/\" replace=$entry.name}\n+                            {_T string=\"%s field\" pattern=\"/%s/\" replace=$entry.name|escape}\n                         </a>\n                     </span>\n                 </td>\n@@ -89,14 +89,14 @@\n                         class=\"action tooltip\"\n                     >\n                         <i class=\"fas fa-edit fa-fw\"></i>\n-                        <span class=\"sr-only\">{_T string=\"Edit '%s' field\" pattern=\"/%s/\" replace=$entry.name}</span>\n+                        <span class=\"sr-only\">{_T string=\"Edit '%s' field\" pattern=\"/%s/\" replace=$entry.name|escape}</span>\n                     </a>\n                     <a\n                         href=\"{path_for name=\"removeEntitled\" data=[\"class\" => $url_class, \"id\" => $eid]}\"\n                         class=\"delete tooltip\"\n                     >\n                         <i class=\"fas fa-trash fa-fw\"></i>\n-                        <span class=\"sr-only\">{_T string=\"Delete '%s' field\" pattern=\"/%s/\" replace=$entry.name}</span>\n+                        <span class=\"sr-only\">{_T string=\"Delete '%s' field\" pattern=\"/%s/\" replace=$entry.name|escape}</span>\n                     </a>\n                 </td>\n             </tr>"
        },
        {
          "filename": "galette/templates/default/gestion_titres.tpl",
          "status": "modified",
          "additions": 5,
          "deletions": 5,
          "patch": "@@ -44,19 +44,19 @@\n     {/if}\n                                 <span class=\"row-title\">\n                                     <a href=\"{path_for name=\"editTitle\" data=[\"id\" => $title->id]}\">\n-                                        {_T string=\"%s title\" pattern=\"/%s/\" replace=$title->short}\n+                                        {_T string=\"%s title\" pattern=\"/%s/\" replace=$title->short|escape}\n                                     </a>\n                                 </span>\n                             </td>\n-                            <td class=\"left\" data-title=\"{_T string=\"Short form\"}\">{$title->short}</td>\n-                            <td class=\"left\" data-title=\"{_T string=\"Long form\"}\">{$title->long}</td>\n+                            <td class=\"left\" data-title=\"{_T string=\"Short form\"}\">{$title->short|escape}</td>\n+                            <td class=\"left\" data-title=\"{_T string=\"Long form\"}\">{$title->long|escape}</td>\n                             <td class=\"center actions_row\">\n                                 <a\n                                     href=\"{path_for name=\"editTitle\" data=[\"id\" => $title->id]}\"\n                                     class=\"tooltip action\"\n                                 >\n                                     <i class=\"fas fa-edit fa-fw\"></i>\n-                                    <span class=\"sr-only\">{_T string=\"Edit '%s' title\" pattern=\"/%s/\" replace=$title->short}</span>\n+                                    <span class=\"sr-only\">{_T string=\"Edit '%s' title\" pattern=\"/%s/\" replace=$title->short|escape}</span>\n                                 </a>\n                 {if $title->id eq 1 or $title->id eq 2}\n                                 <img src=\"{base_url}/{$template_subdir}images/icon-empty.png\" alt=\"\" width=\"16px\" height=\"16px\"/>\n@@ -66,7 +66,7 @@\n                                     class=\"delete tooltip\"\n                                 >\n                                     <i class=\"fa fa-trash fa-fw\"></i>\n-                                    <span class=\"sr-only\">{_T string=\"Delete '%s' title\" pattern=\"/%s/\" replace=$title->short}</span>\n+                                    <span class=\"sr-only\">{_T string=\"Delete '%s' title\" pattern=\"/%s/\" replace=$title->short|escape}</span>\n                                 </a>\n                 {/if}\n                             </td>"
        },
        {
          "filename": "galette/templates/default/gestion_transactions.tpl",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -150,7 +150,7 @@\n                             </a>\n                         </td>\n                     {/if}\n-                    <td class=\"{$cclass} nowrap\" data-title=\"{_T string=\"Description\"}\">{$transaction->description}</td>\n+                    <td class=\"{$cclass} nowrap\" data-title=\"{_T string=\"Description\"}\">{$transaction->description|escape}</td>\n {if $login->isAdmin() or $login->isStaff()}\n                     <td class=\"{$cclass}\" data-title=\"{_T string=\"Originator\"}\">\n     {if $filters->filtre_cotis_adh eq \"\"}"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 1,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 5,
        "max_directory_depth": 5
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "828cdaf3f716565f5f9e6f19f32624f04e5ea378",
            "date": "2025-01-24T20:41:36Z",
            "author_login": "trasher"
          },
          {
            "sha": "fe5d5718c166e84ef99d6e11c124ff5a89aa0d6d",
            "date": "2025-01-24T19:54:27Z",
            "author_login": "trasher"
          },
          {
            "sha": "4b62ed2c622c7a052f723698cd530f64b2a8cfc2",
            "date": "2025-01-24T18:29:18Z",
            "author_login": "weblate"
          },
          {
            "sha": "42837fc671accaa2b3e9d0645e72b9897633e76f",
            "date": "2025-01-24T18:51:20Z",
            "author_login": "trasher"
          },
          {
            "sha": "7614d8c0251fba745c0f2dff9ad0c6336722f6ad",
            "date": "2025-01-24T16:20:25Z",
            "author_login": "gagnieray"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 8.1,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:H/UI:R/S:C/C:H/I:H/A:N",
    "cwe_id": "CWE-79",
    "description": "Galette is a membership management web application built for non profit organizations and released under GPLv3. Versions prior to 0.9.6 are subject to stored cross site scripting attacks via the preferences footer. The preference footer can only be altered by a site admin. This issue has been resolved in the 0.9.6 release and all users are advised to upgrade. There are no known workarounds.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2021-12-16T19:15:08.183",
    "last_modified": "2024-11-21T06:25:54.743",
    "fix_date": "2021-11-09T07:35:51Z"
  },
  "references": [
    {
      "url": "https://github.com/galette/galette/commit/0d55bc7f420470e0dbca91ebe7899c592905cbc5",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/galette/galette/security/advisories/GHSA-28fg-cp22-6c33",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/galette/galette/commit/0d55bc7f420470e0dbca91ebe7899c592905cbc5",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/galette/galette/security/advisories/GHSA-28fg-cp22-6c33",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:34.847954",
    "processing_status": "enhanced"
  },
  "repository_context": {
    "name": "galette",
    "owner": "galette",
    "created_at": "2013-01-14T22:48:07Z",
    "updated_at": "2025-01-24T23:31:53Z",
    "pushed_at": "2025-01-25T07:36:33Z",
    "size": 92508,
    "stars": 55,
    "forks": 33,
    "open_issues": 3,
    "watchers": 55,
    "has_security_policy": false,
    "default_branch": "develop",
    "protected_branches": [],
    "languages": {
      "PHP": 2910353,
      "Twig": 878352,
      "CSS": 72148,
      "Python": 24966,
      "JavaScript": 16960,
      "Makefile": 2637,
      "HTML": 2127,
      "Batchfile": 794,
      "Smarty": 368,
      "Shell": 187
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "gpl-3.0"
    },
    "collected_at": "2025-01-26T08:09:43.679467"
  }
}