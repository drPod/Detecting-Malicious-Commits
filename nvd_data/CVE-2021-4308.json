{
  "cve_id": "CVE-2021-4308",
  "github_data": {
    "repository": "WebPA/WebPA",
    "fix_commit": "8836c4f549181e885a68e0e7ca561fdbcbd04bf0",
    "related_commits": [
      "8836c4f549181e885a68e0e7ca561fdbcbd04bf0",
      "8836c4f549181e885a68e0e7ca561fdbcbd04bf0"
    ],
    "patch_url": "https://github.com/WebPA/WebPA/commit/8836c4f549181e885a68e0e7ca561fdbcbd04bf0.patch",
    "fix_commit_details": {
      "sha": "8836c4f549181e885a68e0e7ca561fdbcbd04bf0",
      "commit_date": "2021-04-22T11:56:26Z",
      "author": {
        "login": "Sephster",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Merge pull request #87 from Sephster/fix-sql-injection-attack",
        "length": 75,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 27586,
        "additions": 14418,
        "deletions": 13168
      },
      "files": [
        {
          "filename": ".env.example",
          "status": "added",
          "additions": 26,
          "deletions": 0,
          "patch": "@@ -0,0 +1,26 @@\n+APP_WWW=http://localhost\n+DOC_ROOT=/var/www/webpa/\n+DB_HOST=localhost\n+DB_USER=root\n+DB_PASS=password\n+DB_NAME=webpa\n+DB_PREFIX=pa2_\n+CUSTOM_CSS_PATH=\n+SESSION_NAME=WEBPA\n+ACADEMIC_YEAR_START_MONTH=9\n+HELP_EMAIL=someone@email.com\n+NO_REPLY_EMAIL=no-reply@email.com\n+LOGO_PATH=/images/logo.png\n+LOGO_ALT_TEXT=\"Your institution name\"\n+LOGO_HEIGHT=25\n+LOGO_WIDTH=102\n+ALLOW_TEXT_INPUT=true\n+ENABLE_USER_DELETE=true\n+ENABLE_MODULE_DELETE=true\n+SMTP_HOST=localhost\n+SMTP_PORT=25\n+EMAIL_ADDRESS=someone@email.com\n+ENABLE_MOODLE_GRADEBOOK=false\n+SEND_OPENING_REMINDER=false\n+SEND_CLOSING_REMINDER=false\n+MARK_TERMINOLOGY=Scores(s)\n\\ No newline at end of file"
        },
        {
          "filename": ".gitignore",
          "status": "modified",
          "additions": 2,
          "deletions": 0,
          "patch": "@@ -2,3 +2,5 @@ vendor/\n /composer.lock\n .idea/\n *.orig\n+.env\n+/src/mod/**"
        },
        {
          "filename": ".php_cs.dist",
          "status": "added",
          "additions": 65,
          "deletions": 0,
          "patch": "@@ -0,0 +1,65 @@\n+<?php\n+\n+$finder = PhpCsFixer\\Finder::create()\n+    ->exclude('mod')\n+    ->in(__DIR__ . '/src');\n+\n+$config = new PhpCsFixer\\Config();\n+\n+return $config\n+    ->setRules([\n+        '@PSR2' => true,\n+        '@PHP74Migration' => true,\n+        'array_syntax' => ['syntax' => 'short'],\n+        'no_alias_language_construct_call' => true,\n+        'no_mixed_echo_print' => true,\n+        'no_multiline_whitespace_around_double_arrow' => true,\n+        'no_trailing_comma_in_singleline_array' => true,\n+        'no_whitespace_before_comma_in_array' => true,\n+        'normalize_index_brace' => true,\n+        'trailing_comma_in_multiline_array' => true,\n+        'trim_array_spaces' => true,\n+        'whitespace_after_comma_in_array' => true,\n+        'lowercase_static_reference' => true,\n+        'magic_constant_casing' => true,\n+        'magic_method_casing' => true,\n+        'native_function_casing' => true,\n+        'native_function_type_declaration_casing' => true,\n+        'cast_spaces' => true,\n+        'lowercase_cast' => true,\n+        'no_short_bool_cast' => true,\n+        'no_unset_cast' => true,\n+        'short_scalar_cast' => true,\n+        'class_attributes_separation' => true,\n+        'class_definition' => true,\n+        'no_blank_lines_after_class_opening' => true,\n+        'no_null_property_initialization' => true,\n+        'protected_to_private' => true,\n+        'self_static_accessor' => true,\n+        'single_class_element_per_statement' => true,\n+        'single_trait_insert_per_statement' => true,\n+        'multiline_comment_opening_closing' => true,\n+        'no_empty_comment' => true,\n+        'single_line_comment_style' => true,\n+        'include' => true,\n+        'no_alternative_syntax' => true,\n+        'no_superfluous_elseif' => true,\n+        'no_trailing_comma_in_list_call' => true,\n+        'no_unneeded_control_parentheses' => true,\n+        'no_unneeded_curly_braces' => true,\n+        'no_useless_else' => true,\n+        'simplified_if_return' => true,\n+        'switch_case_space' => true,\n+        'switch_continue_to_break' => true,\n+        'function_typehint_space' => true,\n+        'method_argument_space' => true,\n+        'nullable_type_declaration_for_default_null_value' => true,\n+        'return_type_declaration' => true,\n+        'fully_qualified_strict_types' => true,\n+        'global_namespace_import' => true,\n+        'no_leading_import_slash' => true,\n+        'no_unused_imports' => true,\n+        'ordered_imports' => true,\n+        'single_quote' => true,\n+    ])\n+    ->setFinder($finder);"
        },
        {
          "filename": ".phpcs.xml.dist",
          "status": "added",
          "additions": 42,
          "deletions": 0,
          "patch": "@@ -0,0 +1,42 @@\n+<?xml version=\"1.0\"?>\n+<ruleset xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" name=\"PHP_CodeSniffer\" xsi:noNamespaceSchemaLocation=\"phpcs.xsd\">\n+    <description>WebPA Coding Standards</description>\n+\n+    <file>src</file>\n+\n+    <exclude-pattern>*/src/*\\.(inc|css|js)$</exclude-pattern>\n+\n+    <arg name=\"basepath\" value=\".\"/>\n+    <arg name=\"colors\"/>\n+    <arg name=\"parallel\" value=\"75\"/>\n+    <arg value=\"np\"/>\n+\n+    <!-- Don't hide tokenizer exceptions -->\n+    <rule ref=\"Internal.Tokenizer.Exception\">\n+        <type>error</type>\n+    </rule>\n+\n+    <!-- Include the whole PEAR standard -->\n+    <rule ref=\"PSR2\" />\n+\n+    <!-- Check var names, but we don't want leading underscores for private vars -->\n+    <rule ref=\"Squiz.NamingConventions.ValidVariableName\"/>\n+    <rule ref=\"Squiz.NamingConventions.ValidVariableName.PrivateNoUnderscore\">\n+        <severity>0</severity>\n+    </rule>\n+\n+    <!-- Private methods MUST not be prefixed with an underscore -->\n+    <rule ref=\"PSR2.Methods.MethodDeclaration.Underscore\">\n+        <type>error</type>\n+    </rule>\n+\n+    <!-- Private properties MUST not be prefixed with an underscore -->\n+    <rule ref=\"PSR2.Classes.PropertyDeclaration.Underscore\">\n+        <type>error</type>\n+    </rule>\n+\n+    <!-- Side effects should be classed as an error because these break PHPStan checks -->\n+    <rule ref=\"PSR1.Files.SideEffects\">\n+        <type>error</type>\n+    </rule>\n+</ruleset>"
        },
        {
          "filename": "CHANGELOG.md",
          "status": "modified",
          "additions": 14,
          "deletions": 2,
          "patch": "@@ -4,7 +4,16 @@ All notable changes to this project will be documented in this file.\n The format is based on [Keep a Changelog](http://keepachangelog.com/en/1.0.0/)\n and this project adheres to [Semantic Versioning](http://semver.org/spec/v2.0.0.html).\n \n-## [Unreleased]\n+## [3.1.2] - 2020-04-22\n+### Changed\n+- Emails are now triggered via a single script, `jobs/Email.php` instead of calling`tutors/asessments/email/ClosingReminder.php` and `tutors/assessments/email/TriggerReminder.php` directly. \n+\n+### Removed\n+- Removed LDAP functionality and options as the implementation did not work.\n+\n+### Security\n+- Fixed a large amount of SQL injection attacks\n+- Change password hashing to use the native password_hash() function in PHP instead of MD5 hashing which is insecure\n \n ## [3.1.1] - 2020-10-02\n ### Fixed\n@@ -18,6 +27,8 @@ and this project adheres to [Semantic Versioning](http://semver.org/spec/v2.0.0.\n ### Fixed\n - Change default authenticator to be database instead of SAML (PR #64)\n \n+## [Unreleased]\n+\n ## [3.0.7] - 2020-01-20\n ### Fixed\n - Remove a blank line at the top of a PHP class that was causing a fatal error\n@@ -65,8 +76,9 @@ and this project adheres to [Semantic Versioning](http://semver.org/spec/v2.0.0.\n \n ## [1.1.0.1] - 2008-07-19\n \n-[Unreleased]: https://github.com/WebPA/WebPA/compare/v3.1.1...HEAD\n+[Unreleased]: https://github.com/WebPA/WebPA/compare/v3.1.2...HEAD\n \n+[3.1.2]: https://github.com/WebPA/WebPA/compare/v3.1.1...v3.1.2\n [3.1.1]: https://github.com/WebPA/WebPA/compare/v3.1.0...v3.1.1\n [3.1.0]: https://github.com/WebPA/WebPA/compare/v3.0.7...v3.1.0\n [3.0.7]: https://github.com/WebPA/WebPA/compare/v3.0.6...v3.0.7"
        },
        {
          "filename": "README.md",
          "status": "modified",
          "additions": 43,
          "deletions": 17,
          "patch": "@@ -9,9 +9,8 @@ student with an individual grade. The individual grade reflects the students con\n \n The following versions of PHP are supported for the latest version of WebPA:\n \n-* PHP 7.2\n-* PHP 7.3\n * PHP 7.4\n+* PHP 8.0\n \n Your PHP instance must also have the following extensions enabled:\n \n@@ -32,30 +31,57 @@ composer create-project --prefer-dist --no-dev webpa/webpa webpa\n \n Alternatively you can download the latest release from this repository's [release page](https://github.com/WebPA/WebPA/releases).\n \n-### Setup\n+### Configuration\n \n-Edit the includes/inc\\_global.php file in the includes directory to configure the application; in particular:\n+WebPA has a number of configuration options allowing you to set your database credentials, SMTP mail host details and \n+various other options.\n \n-- APP\\_\\_WWW: URL to the instance of WebPA (without a closing \"/\");\n-- DOC\\_\\_ROOT: directory path to the WebPA files (with a closing \"/\" or \"\\\\\");\n-- database settings:\n-\t- APP\\_\\_DB\\_HOST: host name\n-\t- APP\\_\\_DB\\_USERNAME: username\n-\t- APP\\_\\_DB\\_PASSWORD: password\n-\t- APP\\_\\_DB\\_DATABASE: database name\n-\t- APP\\_\\_DB\\_TABLE\\_PREFIX: table prefix (default is `pa2_` which means that the new version can share the same database as the old version if required)\n-- Configure the LDAP settings if you wish to authenticate via LDAP.\n+The application comes bundled with a `.env.example` file which lists all of the configuation key-value pairs you can\n+set. \n+\n+For speedy development, you can copy this `.env.example` file to a file called `.env` and change the values to suit your\n+environment. The path of this file can be set in the `includes/inc_global.php` file.\n+\n+For production environments, please *avoid* using the `.env` file as storing sensitive credentials in a file could be a \n+security risk. Instead you should set these key-pairs as environment variables. In Apache, you can set these in your \n+`.htaccess` file as follows:\n+\n+```\n+SetEnv DB_HOST localhost\n+```\n+\n+At a minimum, you should set the following environmental variables to let WebPA function:\n+\n+* APP_WWW - URL to your instance of WebPA (set without a closing '/')\n+* DOC_ROOT - Directory path to the WebPA files (set with a closing '/')\n+* DB_HOST - Database host\n+* DB_USER - Database username\n+* DB_PASS - Database password\n+* DB_NAME - Database name\n+* DB_PREFIX - Database table prefix. Usually set to 'pa2_'\n+\n+For more information on the dotenv file please visit the \n+[dotenv package's repository](https://github.com/vlucas/phpdotenv). For more information on setting environmental \n+variables in Apache, please [visit Apache's website](https://httpd.apache.org/docs/2.4/mod/mod_env.html#setenv).\n+\n+### Initialise the Database\n      \n Run the following scripts to initialise the database (edit the files to change the names and password as reqired):\n \n - install/webpa2\\_database.sql: create the database schema and user account;\n - install/webpa2\\_tables.sql: create the database tables;\n - install/webpa2\\_administrator.sql: create an administrator account and sample module.\n+\n+#### Upgrading an Existing Installation\n+\n+If you already have WebPA installed and are upgrading from version 3.1.0 or below, please run:\n+\n+- install/webpa\\_security\\_update.sql\n      \n-Login to WebPA:\n+### Login to WebPA\n \n-- navigate to root of WebPA application;\n-- enter a username of \"admin\" and a password of \"admin\"\n+- navigate to root of WebPA application\n+- enter a username of _admin_ and a password of _admin_\n - change the password to something more secure after logging in\n \t\t \n Delete the _install_ folder when you're finished.\n@@ -94,4 +120,4 @@ install instructions.\n \n WebPA was originally developed by the Centre for Engineering and Design Education at [Loughborough University](http://www.lboro.ac.uk/) with financial support from [JISC](https://www.jisc.ac.uk/)'s e-Learning Capital Programme.\n \n-It continues to be mainted by a number of [open source contributors](https://github.com/WebPA/WebPA/graphs/contributors). We thank them for their time and effort supporting this system.\n+It continues to be maintained by a number of [open source contributors](https://github.com/WebPA/WebPA/graphs/contributors). We thank them for their time and effort supporting this system."
        },
        {
          "filename": "composer.json",
          "status": "modified",
          "additions": 7,
          "deletions": 3,
          "patch": "@@ -24,10 +24,12 @@\n         }\n     ],\n     \"require\": {\n-        \"php\": \">=7.2\",\n+        \"php\": \">=7.4\",\n         \"ext-xml\": \"*\",\n         \"ext-session\": \"*\",\n-        \"ext-mysqli\": \"*\"\n+        \"ext-mysqli\": \"*\",\n+        \"doctrine/dbal\": \"^3.0\",\n+        \"vlucas/phpdotenv\": \"^5.3\"\n     },\n     \"support\": {\n         \"email\": \"andrew@noexceptions.io\",\n@@ -39,6 +41,8 @@\n         \"psr-4\": {\"WebPA\\\\\": \"src/\"}\n     },\n     \"require-dev\": {\n-        \"phpstan/phpstan\": \"^0.12.25\"\n+        \"phpstan/phpstan\": \"^0.12.25\",\n+        \"friendsofphp/php-cs-fixer\": \"^2.18\",\n+        \"squizlabs/php_codesniffer\": \"^3.5\"\n     }\n }"
        },
        {
          "filename": "phpstan.neon",
          "status": "added",
          "additions": 6,
          "deletions": 0,
          "patch": "@@ -0,0 +1,6 @@\n+parameters:\n+    level: 0\n+    paths:\n+        - src\n+    excludePaths:\n+        - src/mod/*"
        },
        {
          "filename": "src/accounts/reset.php",
          "status": "modified",
          "additions": 138,
          "deletions": 94,
          "patch": "@@ -21,133 +21,178 @@\n This table has the CREATE definition:\n */\n \n-require_once(\"../includes/inc_global.php\");\n+require_once '../includes/inc_global.php';\n \n+use Doctrine\\DBAL\\ParameterType;\n use WebPA\\includes\\classes\\User;\n use WebPA\\includes\\functions\\Common;\n \n $action = Common::fetch_POST('action');\n \n-switch($action) {\n-  case \"init\":\n+switch ($action) {\n+  case 'init':\n     //phase 2\n-    //first, we create a random hash for this user. this doesn't need to be especially secure, so md5(rand()) will do fine.\n-    isset($_POST['username']) or die(\"Username not set.\");\n+    //first, we create a random hash for this user.\n+    isset($_POST['username']) or exit('Username not set.');\n \n-    $DB->open();\n-    $username = $DB->escape_str($_POST['username']);\n-    $DB->close();\n+    $hash = password_hash(mt_rand(), PASSWORD_DEFAULT);\n+\n+    $sql =\n+        'SELECT user_id ' .\n+        'FROM ' . APP__DB_TABLE_PREFIX . 'user ' .\n+        'WHERE username = ? ' .\n+        'AND source_id = \"\" ' .\n+        'AND email IS NOT NULL ' .\n+        'AND email <> \"\"';\n+\n+    $uid = $DB->getConnection()->fetchOne($sql, [$_POST['username']], [ParameterType::STRING]);\n \n-    $hash = md5(rand());\n-    $sql = 'SELECT user_id FROM ' . APP__DB_TABLE_PREFIX . \"user WHERE username = '$username' AND source_id = '' AND \" .\n-           '(email IS NOT NULL) AND (email != \\'\\')';\n-    $uid = $DB->fetch_value($sql);\n     if (!$uid) {\n-      $content = \"Unable to reset the password for this account.\";\n-      break;\n+        $content = 'Unable to reset the password for this account.';\n+        break;\n     }\n-    //inserts the user/hash pair into the database\n-    $sql = \"INSERT INTO \" . APP__DB_TABLE_PREFIX . \"user_reset_request SET hash = '$hash', user_id = $uid\";\n-    $appname = APP__NAME; $appwww = APP__WWW;\n-    $DB->execute($sql);\n+    // inserts the user/hash pair into the database\n+    $insertUserHashPairQuery =\n+        'INSERT INTO ' . APP__DB_TABLE_PREFIX . 'user_reset_request ' .\n+        'SET hash = ?, user_id = ?';\n+\n+    $appname = APP__NAME;\n+    $appwww = APP__WWW;\n+\n+    $DB->getConnection()->executeQuery(\n+        $insertUserHashPairQuery,\n+        [$hash, $uid],\n+        [ParameterType::STRING, ParameterType::INTEGER]\n+    );\n+\n     $email = <<<TXT\n-You have requested for your password to be reset on {$appname}. Please click or copy and paste the following link into your browser to continue the password reset process.\n+        You have requested for your password to be reset on {$appname}. Please click or copy and paste the following link into your browser to continue the password reset process.\n+\n+        {$appwww}/accounts/reset.php?u=$uid&hash=$hash\n+\n+        If you have not requested a password reset, please ignore this email - your password will not be reset without further action.\n+        TXT;\n+    $userEmailQuery = 'SELECT email FROM ' . APP__DB_TABLE_PREFIX . 'user WHERE user_id = ?';\n \n-{$appwww}/accounts/reset.php?u=$uid&hash=$hash\n+    $uemail = $DB->getConnection()->fetchOne($userEmailQuery, [$uid], [ParameterType::INTEGER]);\n \n-If you have not requested a password reset, please ignore this email - your password will not be reset without further action.\n-TXT;\n-    //echo $email;\n-    $uemail = $DB->fetch_value(\"SELECT email FROM \" . APP__DB_TABLE_PREFIX . \"user WHERE user_id = $uid\");\n-    mail($uemail,APP__NAME. \" Password Reset\",$email,\"From: \" . $BRANDING['email.noreply']);\n+    mail($uemail, APP__NAME. ' Password Reset', $email, 'From: ' . $BRANDING['email.noreply']);\n     $content = \"An email has been sent to $uemail.\";\n     break;\n-  case \"reset\":\n+  case 'reset':\n     //phase 4\n     $hash = $_POST['hash'];\n     $uid = $_POST['uid'];\n-    $rslt = $DB->fetch_value(\"SELECT COUNT(*) FROM \" . APP__DB_TABLE_PREFIX . \"user_reset_request WHERE hash = '$hash' AND user_id = $uid\");\n+\n+    $query =\n+        'SELECT COUNT(*) ' .\n+        'FROM ' . APP__DB_TABLE_PREFIX . 'user_reset_request ' .\n+        'WHERE hash = ? ' .\n+        'AND user_id = ?';\n+\n+    $rslt = $DB->getConnection()->fetchOne($query, [$hash, $uid], [ParameterType::STRING, ParameterType::INTEGER]);\n+\n     if ($rslt) {\n-      if ($_POST['newpass']==$_POST['confirmpass']) {\n-        $user = new User();\n-        $user_row = $DB->fetch_row(\"SELECT * FROM \" . APP__DB_TABLE_PREFIX . \"user WHERE user_id = $uid\");\n-        $user->load_from_row($user_row);\n-        $user->set_dao_object($DB);\n-        $user->update_password(md5($_POST['newpass']));\n-        $user->save_user();\n-        $DB->execute(\"DELETE FROM \" . APP__DB_TABLE_PREFIX . \"user_reset_request WHERE user_id = $uid\");\n-        $content = 'Your password has been reset. <a href=\"'.APP__WWW.'/login.php\">Click here</a> to log in again.';\n-      } else {\n-        $content = \"The two passwords did not match.\";\n-      }\n+        if ($_POST['newpass']==$_POST['confirmpass']) {\n+            $user = new User();\n+\n+            $dbConn = $DB->getConnection();\n+\n+            $userQuery = 'SELECT * FROM ' . APP__DB_TABLE_PREFIX . 'user WHERE user_id = ?';\n+\n+            $userRow = $dbConn->fetchAssociative($userQuery, [$uid], [ParameterType::INTEGER]);\n+\n+            $user->load_from_row($userRow);\n+            $user->set_dao_object($DB);\n+            $user->update_password($_POST['newpass']);\n+            $user->save_user();\n+\n+            $DB->getConnection()->executeQuery(\n+                'DELETE FROM ' . APP__DB_TABLE_PREFIX . 'user_reset_request WHERE user_id = ?',\n+                [$uid],\n+                [ParameterType::INTEGER]\n+            );\n+\n+            $content = 'Your password has been reset. <a href=\"'.APP__WWW.'/login.php\">Click here</a> to log in again.';\n+        } else {\n+            $content = 'The two passwords did not match.';\n+        }\n     } else {\n-      $content = \"There was an error resetting this password.\";\n+        $content = 'There was an error resetting this password.';\n     }\n     break;\n   default:\n     if (isset($_GET['hash'])) {\n-      //phase 3\n-      $hash = $_GET['hash'];\n-      $uid = $_GET['u'];\n-      if ((!isset($_GET['hash'])) || (!isset($_GET['u']))) {\n-        $content = \"Error: reset link incorrect. If you copied and pasted the link from your mail client, be sure you did so correctly.\";\n+        //phase 3\n+        $hash = $_GET['hash'];\n+        $uid = $_GET['u'];\n+        if ((!isset($_GET['hash'])) || (!isset($_GET['u']))) {\n+            $content = 'Error: reset link incorrect. If you copied and pasted the link from your mail client, be sure you did so correctly.';\n+            break;\n+        }\n+\n+        $query =\n+          'SELECT COUNT(*) ' .\n+          'FROM ' . APP__DB_TABLE_PREFIX . 'user_reset_request ' .\n+          'WHERE hash = ? ' .\n+          'AND user_id = ?';\n+\n+        $rslt = $DB->getConnection()->fetchOne($query, [$hash, $uid], [ParameterType::STRING, ParameterType::INTEGER]);\n+\n+        if ($rslt) {\n+            $content = <<<HTML\n+                      <form action=\"reset.php\" method=\"post\">\n+                        <table>\n+                          <tr>\n+                            <th scope=\"row\">New Password</th>\n+                            <td><input type=\"password\" name=\"newpass\" value=\"\" id=\"newpass\"/></td>\n+                          </tr>\n+                          <tr>\n+                            <th scope=\"row\">New Password (again)</th>\n+                            <td><input type=\"password\" name=\"confirmpass\" value=\"\" id=\"confirmpass\"/></td>\n+                          </tr>\n+                          <tr>\n+                            <td></td>\n+                            <td><input type=\"submit\" value=\"Reset Password\" /></td>\n+                          </tr>\n+                        </table>\n+                        <input type=\"hidden\" name=\"hash\" value=\"$hash\"/>\n+                        <input type=\"hidden\" name=\"uid\" value=\"$uid\"/>\n+                        <input type=\"hidden\" name=\"action\" value=\"reset\" />\n+                      </form>\n+                HTML;\n+        } else {\n+            $content = 'There was an error resetting this password. Please contact the site administrator.';\n+        }\n         break;\n-      }\n-      $rslt = $DB->fetch_value(\"SELECT COUNT(*) FROM \" . APP__DB_TABLE_PREFIX . \"user_reset_request WHERE hash = '$hash' AND user_id = $uid\");\n-      if ($rslt) {\n-      $content = <<<HTML\n-      <form action=\"reset.php\" method=\"post\">\n-        <table>\n-          <tr>\n-            <th scope=\"row\">New Password</th>\n-            <td><input type=\"password\" name=\"newpass\" value=\"\" id=\"newpass\"/></td>\n-          </tr>\n-          <tr>\n-            <th scope=\"row\">New Password (again)</th>\n-            <td><input type=\"password\" name=\"confirmpass\" value=\"\" id=\"confirmpass\"/></td>\n-          </tr>\n-          <tr>\n-            <td></td>\n-            <td><input type=\"submit\" value=\"Reset Password\" /></td>\n-          </tr>\n-        </table>\n-        <input type=\"hidden\" name=\"hash\" value=\"$hash\"/>\n-        <input type=\"hidden\" name=\"uid\" value=\"$uid\"/>\n-        <input type=\"hidden\" name=\"action\" value=\"reset\" />\n-      </form>\n-HTML;\n-      } else {\n-        $content = \"There was an error resetting this password. Please contact the site administrator.\";\n-      }\n-      break;\n     }\n     //phase 1\n     //just display the form confirming the password reset.\n     $content = <<<HTML\n-<strong>You are about to reset your password.</strong> In order to do so, a link will be sent to your student email account. This link will take you to a page that will enable you to reset your password.<br/>\n-<br/>\n-<form action=\"reset.php\" method=\"post\">\n-  <table>\n-    <tr>\n-      <th scope=\"row\">Username</th>\n-      <td><input type=\"text\" name=\"username\" /></td>\n-    </tr>\n-    <tr>\n-      <td></td>\n-      <td>\n-        <input type=\"submit\" value=\"Reset My Password\"/>\n-      </td>\n-    </tr>\n-  </table>\n-  <input type=\"hidden\" name=\"action\" value=\"init\"/>\n-</form>\n-HTML;\n+        <strong>You are about to reset your password.</strong> In order to do so, a link will be sent to your student email account. This link will take you to a page that will enable you to reset your password.<br/>\n+        <br/>\n+        <form action=\"reset.php\" method=\"post\">\n+          <table>\n+            <tr>\n+              <th scope=\"row\">Username</th>\n+              <td><input type=\"text\" name=\"username\" /></td>\n+            </tr>\n+            <tr>\n+              <td></td>\n+              <td>\n+                <input type=\"submit\" value=\"Reset My Password\"/>\n+              </td>\n+            </tr>\n+          </table>\n+          <input type=\"hidden\" name=\"action\" value=\"init\"/>\n+        </form>\n+        HTML;\n     break;\n }\n \n-$UI->page_title = \"Password Reset\";\n+$UI->page_title = 'Password Reset';\n $UI->menu_selected = '';\n-$UI->breadcrumbs = array('login page' => '../', 'Password Reset' => null);\n+$UI->breadcrumbs = ['login page' => '../', 'Password Reset' => null];\n $UI->help_link = null;\n \n $UI->head();\n@@ -158,4 +203,3 @@\n echo $content;\n echo \"</p>\\n\";\n $UI->content_end(false);\n-?>"
        },
        {
          "filename": "src/admin/delete/index.php",
          "status": "modified",
          "additions": 51,
          "deletions": 56,
          "patch": "@@ -8,17 +8,18 @@\n  * @link https://github.com/webpa/webpa\n  */\n \n- //get the include file required\n- require_once(\"../../includes/inc_global.php\");\n+//get the include file required\n+require_once '../../includes/inc_global.php';\n \n- use WebPA\\includes\\classes\\Module;\n- use WebPA\\includes\\classes\\User;\n- use WebPA\\includes\\functions\\Common;\n+use Doctrine\\DBAL\\ParameterType;\n+use WebPA\\includes\\classes\\Module;\n+use WebPA\\includes\\classes\\User;\n+use WebPA\\includes\\functions\\Common;\n \n- if (!Common::check_user($_user, APP__USER_TYPE_TUTOR)){\n-  header('Location:'. APP__WWW .'/logout.php?msg=denied');\n-  exit;\n-}\n+ if (!Common::check_user($_user, APP__USER_TYPE_TUTOR)) {\n+     header('Location:'. APP__WWW .'/logout.php?msg=denied');\n+     exit;\n+ }\n \n //get the passed user ID passed as u\n $user = Common::fetch_GET('u');\n@@ -27,21 +28,19 @@\n \n //set the page information\n if (!$user) {\n-  $UI->page_title = APP__NAME . ' Delete module';\n-} else if ($user == 'unassigned') {\n-  $UI->page_title = APP__NAME . ' Delete all system users with no module';\n-}else {\n-  $UI->page_title = APP__NAME . ' Delete system user from module';\n+    $UI->page_title = APP__NAME . ' Delete module';\n+} else {\n+    $UI->page_title = APP__NAME . ' Delete system user from module';\n }\n $UI->menu_selected = 'view data';\n $UI->set_page_bar_button('View Student Data', '../../../images/buttons/button_student_user.png', '../review/student/index.php');\n $UI->set_page_bar_button('View Staff Data', '../../../images/buttons/button_staff_user.png', '../review/staff/index.php');\n if (Common::check_user($_user, APP__USER_TYPE_ADMIN)) {\n-  $UI->set_page_bar_button('View Admin Data', '../../../images/buttons/button_admin_user.png', '../review/admin/index.php');\n-  $UI->set_page_bar_button('View Module Data', '../../../images/buttons/button_view_modules.png', '../review/module/index.php');\n+    $UI->set_page_bar_button('View Admin Data', '../../../images/buttons/button_admin_user.png', '../review/admin/index.php');\n+    $UI->set_page_bar_button('View Module Data', '../../../images/buttons/button_view_modules.png', '../review/module/index.php');\n }\n $UI->set_page_bar_button('Search for a user', '../../../images/buttons/button_search_user.png', '../search/index.php');\n-$UI->breadcrumbs = array ('home' => '../','review data'=>'../review/','edit'=>null, );\n+$UI->breadcrumbs = ['home' => '../', 'review data'=>'../review/', 'edit'=>null];\n $UI->help_link = '?q=node/237';\n $UI->head();\n $UI->body();\n@@ -54,42 +53,36 @@\n //----------------------------------------------------------------------\n //process request\n \n-  if (!$user) {\n-    if (intval($module) == $_module_id) {\n-      $sScreenMsg = \"<p>You cannot delete the currently selected module!</p>\";\n-    } else {\n-      $sScreenMsg = \"<p>The module has been deleted.</p>\";\n-      $delete_module = new Module();\n-      $delete_module->module_id = $module;\n-      $delete_module->set_dao_object($DB);\n-      $delete_module->delete();\n-    }\n-  } else if ($user == 'unassigned') {\n-    //increase the execution time to handle large numbers of deletions\n-    ini_set('max_execution_time', 120);\n-    $sScreenMsg = \"<p>Users with no module have been deleted.</p>\";\n-    $users = $DB->fetch_col(\"SELECT u.user_id FROM \" . APP__DB_TABLE_PREFIX . \"user u LEFT OUTER JOIN \" . APP__DB_TABLE_PREFIX . \"user_module um ON u.user_id = um.user_id WHERE (um.user_id IS NULL) AND (u.user_type = '\" . APP__USER_TYPE_STUDENT . \"')\");\n-    $delete_user = new User();\n-    $delete_user->set_dao_object($DB);\n-    for ($i=0; $i<count($users); $i++) {\n-      $delete_user->id = $users[$i];\n-      $delete_user->delete();\n-    }\n-  } else if (intval($user) == $_SESSION['_user_id']) {\n-    $sScreenMsg = \"<p>You cannot delete yourself!</p>\";\n+  if (strlen($module) > 0) {\n+      if ((int) $module === $_module_id) {\n+          $sScreenMsg = '<p>You cannot delete the currently selected module!</p>';\n+      } else {\n+          $sScreenMsg = '<p>The module has been deleted.</p>';\n+          $delete_module = new Module();\n+          $delete_module->module_id = $module;\n+          $delete_module->set_dao_object($DB);\n+          $delete_module->delete();\n+      }\n+  } elseif ((int) $user === $_SESSION['_user_id']) {\n+      $sScreenMsg = '<p>You cannot delete yourself!</p>';\n+  } elseif ($user > 0) {\n+      $user_row = $CIS->get_user($user);\n+      $delete_user = new User();\n+      $delete_user->set_dao_object($DB);\n+      $delete_user->load_from_row($user_row);\n+      if (Common::check_user($_user, APP__USER_TYPE_ADMIN) && $delete_user->is_admin()) {\n+          $sScreenMsg = '<p>The administrator has been deleted.</p>';\n+          $delete_user->delete();\n+      } else {\n+          $sScreenMsg = '<p>The user has been deleted from the module.</p>';\n+          $DB->getConnection()->executeQuery(\n+              'DELETE FROM ' . APP__DB_TABLE_PREFIX . 'user_module WHERE user_id = ? AND module_id = ?',\n+              [$user, $_SESSION['_module_id']],\n+              [ParameterType::INTEGER, ParameterType::INTEGER]\n+          );\n+      }\n   } else {\n-    $user_row = $CIS->get_user($user);\n-    $delete_user = new User();\n-    $delete_user->set_dao_object($DB);\n-    $delete_user->load_from_row($user_row);\n-    if (Common::check_user($_user, APP__USER_TYPE_ADMIN) && $delete_user->is_admin()) {\n-      $sScreenMsg = \"<p>The administrator has been deleted.</p>\";\n-      $delete_user->delete();\n-    } else {\n-      $sScreenMsg = \"<p>The user has been deleted from the module.</p>\";\n-      $sql = 'DELETE FROM ' . APP__DB_TABLE_PREFIX . \"user_module WHERE user_id = {$user} AND module_id = {$_SESSION['_module_id']}\";\n-      $DB->execute($sql);\n-    }\n+      $errorMsg = '<p>No module or user provided to delete</p>';\n   }\n \n \n@@ -104,8 +97,12 @@\n \n <?php\n \n-  if(!empty($sScreenMsg)){\n-    echo \"<div class=\\\"success_box\\\">{$sScreenMsg}</div>\";\n+  if (!empty($sScreenMsg)) {\n+      echo \"<div class=\\\"success_box\\\">{$sScreenMsg}</div>\";\n+  }\n+\n+  if (isset($errorMsg) && strlen($errorMsg) > 0) {\n+      echo \"<div class=\\\"error_box\\\">$errorMsg</div>\";\n   }\n \n ?>\n@@ -114,5 +111,3 @@\n <?php\n \n $UI->content_end();\n-\n-?>"
        },
        {
          "filename": "src/admin/edit/index.php",
          "status": "modified",
          "additions": 237,
          "deletions": 230,
          "patch": "@@ -17,16 +17,17 @@\n  */\n \n //get the include file required\n-require_once('../../includes/inc_global.php');\n+require_once '../../includes/inc_global.php';\n \n+use Doctrine\\DBAL\\ParameterType;\n use WebPA\\includes\\classes\\User;\n use WebPA\\includes\\functions\\Common;\n use WebPA\\includes\\functions\\Form;\n use WebPA\\includes\\functions\\StringFunctions;\n \n if (!Common::check_user($_user, APP__USER_TYPE_TUTOR)) {\n-  header('Location:'. APP__WWW .'/logout.php?msg=denied');\n-  exit;\n+    header('Location:'. APP__WWW .'/logout.php?msg=denied');\n+    exit;\n }\n \n //set the page information\n@@ -35,11 +36,11 @@\n $UI->set_page_bar_button('View Student Data', '../../../images/buttons/button_student_user.png', '../review/student/index.php');\n $UI->set_page_bar_button('View Staff Data', '../../../images/buttons/button_staff_user.png', '../review/staff/index.php');\n if (Common::check_user($_user, APP__USER_TYPE_ADMIN)) {\n-  $UI->set_page_bar_button('View Admin Data', '../../../images/buttons/button_admin_user.png', '../review/admin/index.php');\n-  $UI->set_page_bar_button('View Module Data', '../../../images/buttons/button_view_modules.png', '../review/module/index.php');\n+    $UI->set_page_bar_button('View Admin Data', '../../../images/buttons/button_admin_user.png', '../review/admin/index.php');\n+    $UI->set_page_bar_button('View Module Data', '../../../images/buttons/button_view_modules.png', '../review/module/index.php');\n }\n $UI->set_page_bar_button('Search for a user', '../../../images/buttons/button_search_user.png', '../search/index.php');\n-$UI->breadcrumbs = array ('home' => '../','review data'=>'../review/','edit'=>null, );\n+$UI->breadcrumbs = ['home' => '../', 'review data'=>'../review/', 'edit'=>null];\n $UI->help_link = '?q=node/237';\n \n //build the content to be written to the screen\n@@ -53,42 +54,42 @@\n $username = Common::fetch_POST('username');\n $new_user = empty($user_id);\n $type = Common::fetch_POST('t', Common::fetch_GET('t', ''));\n-$user_found = FALSE;\n+$user_found = false;\n \n $sScreenMsg = '';\n \n //-----------------------------------------------------------------------\n //collect all the information about the person to populate the fields\n $edit_user = new User();\n if (!$new_user) {\n-  $user_row = $CIS->get_user($user_id);\n-  $edit_user->load_from_row($user_row);\n+    $user_row = $CIS->get_user($user_id);\n+    $edit_user->load_from_row($user_row);\n } else {\n-  if (!empty($username)) {\n-    $user_row = $CIS->get_user_for_username($username);\n-    if ($user_row) {\n-      $user_found = TRUE;\n-      $edit_user->load_from_row($user_row);\n-      $user_id = $edit_user->id;\n+    if (!empty($username)) {\n+        $user_row = $CIS->get_user_for_username($username);\n+        if ($user_row) {\n+            $user_found = true;\n+            $edit_user->load_from_row($user_row);\n+            $user_id = $edit_user->id;\n+        }\n     }\n-  }\n-  if ($_user->is_admin() && ($type == APP__USER_TYPE_ADMIN)) {\n-    if ($user_found) {\n-      $user_found = FALSE;\n-      $user_id = '';\n-      $edit_user = new User();\n-      $action = '';\n-      $sScreenMsg = 'The username already exists; please use another.';\n+    if ($_user->is_admin() && ($type == APP__USER_TYPE_ADMIN)) {\n+        if ($user_found) {\n+            $user_found = false;\n+            $user_id = '';\n+            $edit_user = new User();\n+            $action = '';\n+            $sScreenMsg = 'The username already exists; please use another.';\n+        }\n+        $edit_user->admin = 1;\n     }\n-    $edit_user->admin = 1;\n-  }\n }\n if ($edit_user->is_admin() && ($type != APP__USER_TYPE_ADMIN)) {\n-  $user_found = FALSE;\n-  $user_id = '';\n-  $edit_user = new User();\n-  $action = '';\n-  $sScreenMsg = 'Administrators cannot be enrolled in modules.';\n+    $user_found = false;\n+    $user_id = '';\n+    $edit_user = new User();\n+    $action = '';\n+    $sScreenMsg = 'Administrators cannot be enrolled in modules.';\n }\n \n //----------------------------------------------------------------------\n@@ -99,163 +100,179 @@\n if ($canEdit) {\n \n   //put all the elements back into the structures\n-  $value = Common::fetch_POST('name');\n-  if (!empty($value)) {\n-    $edit_user->forename = $value;\n-  }\n-  $value = Common::fetch_POST('lastname');\n-  if (!empty($value)) {\n-    $edit_user->lastname = $value;\n-  }\n-  $value = Common::fetch_POST('id_number');\n-  if (!empty($value)) {\n-    $edit_user->id_number = $value;\n-  }\n-  $value = Common::fetch_POST('department_id');\n-  if (!empty($value)) {\n-    $edit_user->department_id = $value;\n-  }\n-  $value = Common::fetch_POST('email');\n-  if (!empty($value)) {\n-    $edit_user->email = $value;\n-  }\n-  //check to see if the password needs to be saved\n-  $password = Common::fetch_POST('password', '');\n-  if ((($password != '!!!!!!') && !empty($password)) || empty($user_id)) {\n-    if (($password == '!!!!!!') || empty($password)) {\n-      $password = StringFunctions::str_random();\n+    $value = Common::fetch_POST('name');\n+    if (!empty($value)) {\n+        $edit_user->forename = $value;\n     }\n-    $edit_user->update_password(md5($password));\n-  }\n+    $value = Common::fetch_POST('lastname');\n+    if (!empty($value)) {\n+        $edit_user->lastname = $value;\n+    }\n+    $value = Common::fetch_POST('id_number');\n+    if (!empty($value)) {\n+        $edit_user->id_number = $value;\n+    }\n+    $value = Common::fetch_POST('department_id');\n+    if (!empty($value)) {\n+        $edit_user->department_id = $value;\n+    }\n+    $value = Common::fetch_POST('email');\n+    if (!empty($value)) {\n+        $edit_user->email = $value;\n+    }\n+    //check to see if the password needs to be saved\n+    $password = Common::fetch_POST('password', '');\n \n-  if ((($new_user && !$user_found) || $_user->is_admin()) && Common::fetch_POST('username')) {\n-    $edit_user->update_username(Common::fetch_POST('username'));\n-  }\n+    if ((($password != '!!!!!!') && !empty($password)) || empty($user_id)) {\n+        if (($password == '!!!!!!') || empty($password)) {\n+            $password = StringFunctions::str_random();\n+        }\n+\n+        $edit_user->update_password($password);\n+    }\n+\n+    if ((($new_user && !$user_found) || $_user->is_admin()) && Common::fetch_POST('username')) {\n+        $edit_user->update_username(Common::fetch_POST('username'));\n+    }\n }\n \n if ($action) {          //incase we want to do more than save changes in the future\n-  switch ($action) {\n+    switch ($action) {\n     case 'Save Changes':\n \n       $complete = !empty($edit_user->forename) && !empty($edit_user->lastname) &&\n                   !empty($edit_user->password) && !empty($edit_user->username);\n-    \t\n+        \n       if (!$complete) {\n-        $sScreenMsg = 'Unable to save user: please make sure the user has a username, first name, last name and password.';\n+          $sScreenMsg = 'Unable to save user: please make sure the user has a username, first name, last name and password.';\n       } elseif ($edit_user->email != '' && !Form::is_email($edit_user->email)) {\n-      \t$sScreenMsg = 'Unable to save user: email address is not valid.';\n+          $sScreenMsg = 'Unable to save user: email address is not valid.';\n       } else {\n-        //send notification to the screen that the save has occured.\n-        if ($new_user && !$user_found) {\n-          $sScreenMsg = 'The user has been created';\n-        } else {\n-          $sScreenMsg = 'The changes made for the user have been saved';\n-        }\n-\n-        if ($canEdit) {\n-          $edit_user->set_dao_object($DB);\n-\n-          //save all of the data\n+          //send notification to the screen that the save has occured.\n           if ($new_user && !$user_found) {\n-            $user = $edit_user->add_user();\n-            $user_row = $CIS->get_user($user);\n-            //reload user\n-            $edit_user = new User();\n-            $edit_user->load_from_row($user_row);\n-            $user_id = $edit_user->id;\n+              $sScreenMsg = 'The user has been created';\n           } else {\n-            $edit_user->save_user();\n+              $sScreenMsg = 'The changes made for the user have been saved';\n           }\n-        }\n \n-        if (!$new_user && !$edit_user->is_admin()) {\n-          $modules = $CIS->get_module(NULL, 'name');\n-          $user_modules = $CIS->get_user_modules($user_id);\n-\n-          foreach ($modules as $module) {\n-\n-            if (empty($user_modules) || !array_key_exists($module['module_id'], $user_modules)) {\n-              $old_role = '';\n-            } else {\n-              $old_role = $user_modules[$module['module_id']]['user_type'];\n-            }\n-            if (isset($_POST[\"rdo_type_{$module['module_id']}\"])) {\n-              $new_role = $_POST[\"rdo_type_{$module['module_id']}\"];\n-            } else {\n-              $new_role = '';\n-            }\n-            if ($old_role != $new_role) {\n-              if (empty($new_role)) {\n-                $delete[] = $module['module_id'];\n+          if ($canEdit) {\n+              $edit_user->set_dao_object($DB);\n+\n+              //save all of the data\n+              if ($new_user && !$user_found) {\n+                  $user = $edit_user->add_user();\n+                  $user_row = $CIS->get_user($user);\n+                  //reload user\n+                  $edit_user = new User();\n+                  $edit_user->load_from_row($user_row);\n+                  $user_id = $edit_user->id;\n               } else {\n-                $update[$new_role][] = $module['module_id'];\n+                  $edit_user->save_user();\n               }\n-            }\n           }\n-        } else if (!$edit_user->is_admin() && ($type != APP__USER_TYPE_ADMIN)) {\n-          $user_modules = $CIS->get_user_modules($user_id);\n-          if (!is_array($user_modules)) {\n-            $user_modules = array();\n-          }\n-          if (!array_key_exists($_module_id, $user_modules)) {\n-            $update[$type][] = $_module_id;\n-          } else if ($user_modules[$_module_id]['user_type'] == $type) {\n-            $sScreenMsg = 'User is already enrolled';\n-          } else {\n-            $sScreenMsg = 'User currently has a different role in this module - change not saved';\n-          }\n-        }\n-        if (isset($update)) {\n-          if (isset($update[APP__USER_TYPE_TUTOR])) {\n-            $sql = 'INSERT INTO ' . APP__DB_TABLE_PREFIX . 'user_module (user_id, module_id, user_type) ' .\n-                   \"VALUES \";\n-            $sep = '';\n-            foreach ($update[APP__USER_TYPE_TUTOR] as $module) {\n-              $sql .= \"{$sep}({$user_id}, {$module}, '\" . APP__USER_TYPE_TUTOR . \"')\";\n-              $sep = ', ';\n-            }\n-            $sql .= \" ON DUPLICATE KEY UPDATE user_type = '\" . APP__USER_TYPE_TUTOR . \"'\";\n-            $DB->execute($sql);\n-          }\n-          if (isset($update[APP__USER_TYPE_STUDENT])) {\n-            $sql = 'INSERT INTO ' . APP__DB_TABLE_PREFIX . 'user_module (user_id, module_id, user_type) ' .\n-                   \"VALUES \";\n-            $sep = '';\n-            foreach ($update[APP__USER_TYPE_STUDENT] as $module) {\n-              $sql .= \"{$sep}({$user_id}, {$module}, '\" . APP__USER_TYPE_STUDENT . \"')\";\n-              $sep = ', ';\n-            }\n-            $sql .= \" ON DUPLICATE KEY UPDATE user_type = '\" . APP__USER_TYPE_STUDENT . \"'\";\n-            $DB->execute($sql);\n+\n+          if (!$new_user && !$edit_user->is_admin()) {\n+              $modules = $CIS->get_module(null, 'name');\n+              $user_modules = $CIS->get_user_modules($user_id);\n+\n+              foreach ($modules as $module) {\n+                  if (empty($user_modules) || !array_key_exists($module['module_id'], $user_modules)) {\n+                      $old_role = '';\n+                  } else {\n+                      $old_role = $user_modules[$module['module_id']]['user_type'];\n+                  }\n+                  if (isset($_POST[\"rdo_type_{$module['module_id']}\"])) {\n+                      $new_role = $_POST[\"rdo_type_{$module['module_id']}\"];\n+                  } else {\n+                      $new_role = '';\n+                  }\n+                  if ($old_role != $new_role) {\n+                      if (empty($new_role)) {\n+                          $delete[] = $module['module_id'];\n+                      } else {\n+                          $update[$new_role][] = $module['module_id'];\n+                      }\n+                  }\n+              }\n+          } elseif (!$edit_user->is_admin() && ($type != APP__USER_TYPE_ADMIN)) {\n+              $user_modules = $CIS->get_user_modules($user_id);\n+              if (!is_array($user_modules)) {\n+                  $user_modules = [];\n+              }\n+              if (!array_key_exists($_module_id, $user_modules)) {\n+                  $update[$type][] = $_module_id;\n+              } elseif ($user_modules[$_module_id]['user_type'] == $type) {\n+                  $sScreenMsg = 'User is already enrolled';\n+              } else {\n+                  $sScreenMsg = 'User currently has a different role in this module - change not saved';\n+              }\n           }\n-        }\n-        if (isset($delete)) {\n-          $sql = \"DELETE FROM \" . APP__DB_TABLE_PREFIX . \"user_module \" .\n-                 \"WHERE (user_id = {$user_id}) AND (module_id IN (\";\n-          $sep = '';\n-          foreach ($delete as $module) {\n-            $sql .= \"{$sep}{$module}\";\n-            $sep = ', ';\n+          if (isset($update)) {\n+              if (isset($update[APP__USER_TYPE_TUTOR])) {\n+                  $createUserModuleQuery =\n+                'INSERT INTO ' . APP__DB_TABLE_PREFIX . 'user_module ' .\n+                '(user_id, module_id, user_type) ' .\n+                'VALUES (?, ? , ?) ' .\n+                'ON DUPLICATE KEY UPDATE user_type = ?';\n+\n+                  foreach ($update[APP__USER_TYPE_TUTOR] as $module) {\n+                      $DB->getConnection()->executeQuery(\n+                          $createUserModuleQuery,\n+                          [$user_id, $module, APP__USER_TYPE_TUTOR, APP__USER_TYPE_TUTOR],\n+                          [ParameterType::INTEGER, ParameterType::INTEGER, ParameterType::STRING, ParameterType::STRING]\n+                      );\n+                  }\n+              }\n+\n+              if (isset($update[APP__USER_TYPE_STUDENT])) {\n+                  $createUserModuleQuery =\n+                'INSERT INTO ' . APP__DB_TABLE_PREFIX . 'user_module ' .\n+                '(user_id, module_id, user_type) ' .\n+                'VALUES (?, ?, ?) ' .\n+                'ON DUPLICATE KEY UPDATE user_type = ?';\n+\n+                  foreach ($update[APP__USER_TYPE_STUDENT] as $module) {\n+                      $DB->getConnection()->executeQuery(\n+                          $createUserModuleQuery,\n+                          [$user_id, $module, APP__USER_TYPE_STUDENT, APP__USER_TYPE_STUDENT],\n+                          [ParameterType::INTEGER, ParameterType::INTEGER, ParameterType::STRING, ParameterType::STRING]\n+                      );\n+                  }\n+              }\n           }\n-          $sql .= '))';\n-          $DB->execute($sql);\n-          if (in_array($_module_id, $delete)) {\n-            header('Location: ../review/');\n+          if (isset($delete)) {\n+              $queryBuilder = $DB->getConnection()->createQueryBuilder();\n+\n+              $queryBuilder\n+                ->delete(APP__DB_TABLE_PREFIX . 'user_module')\n+                ->where(\n+                    $queryBuilder->expr()->and(\n+                        $queryBuilder->expr()->eq('user_id', '?'),\n+                        $queryBuilder->expr()->in('module_id', '?')\n+                    )\n+                );\n+\n+              $queryBuilder->setParameter(0, $user_id, ParameterType::INTEGER);\n+              $queryBuilder->setParameter(1, $delete, $DB->getConnection()::PARAM_INT_ARRAY);\n+\n+              $queryBuilder->execute();\n+\n+              if (in_array($_module_id, $delete)) {\n+                  header('Location: ../review/');\n+              }\n           }\n-        }\n \n-        if (isset($update) || isset($delete)) {\n-          //collect all the updated information\n-          $user_row = $CIS->get_user($user_id);\n-          $edit_user = new User();\n-          $edit_user->load_from_row($user_row);\n-        }\n+          if (isset($update) || isset($delete)) {\n+              //collect all the updated information\n+              $user_row = $CIS->get_user($user_id);\n+              $edit_user = new User();\n+              $edit_user->load_from_row($user_row);\n+          }\n       }\n \n       break;\n \n   }\n-\n }\n \n $UI->head();\n@@ -268,27 +285,21 @@\n $page_intro = 'Here you are able to edit the details of a user within the system. There may be some elements of the information which do not appear' .\n     '   to have been completed and this will be dependant on the information stored in the system.';\n if (empty($user_id)) {\n-  $page_intro .= ' Just enter the username for users already added to the system.';\n+    $page_intro .= ' Just enter the username for users already added to the system.';\n }\n \n-if (!in_array('LDAP', $LOGIN_AUTHENTICATORS)) {\n-  $page_conditions = 'N.B. Users authenticated directly from the WebPA <strong>database</strong> must be given a password.';\n-} else if (LDAP__AUTO_CREATE_USER) {\n-  $page_conditions = 'N.B. Users authenticated via <strong>LDAP</strong> will automatically be added to the database and updated each time they log in; the password stored is a random value.';\n-}else{\n-  $page_conditions = 'N.B. Users authenticated via <strong>LDAP</strong> must be added to the database before they are able to log in; a random password will be added automatically.';\n-}\n+$page_conditions = 'N.B. Users authenticated directly from the WebPA <strong>database</strong> must be given a password.';\n \n echo '<p>' . $page_intro . '</p>';\n \n if ($type == APP__USER_TYPE_ADMIN) {\n-  $cancel = '../review/admin/';\n-} else if ($type == APP__USER_TYPE_TUTOR) {\n-  $cancel = '../review/staff/';\n-} else if ($type == APP__USER_TYPE_STUDENT) {\n-  $cancel = '../review/student/';\n+    $cancel = '../review/admin/';\n+} elseif ($type == APP__USER_TYPE_TUTOR) {\n+    $cancel = '../review/staff/';\n+} elseif ($type == APP__USER_TYPE_STUDENT) {\n+    $cancel = '../review/student/';\n } else {\n-  $cancel = '../review/';\n+    $cancel = '../review/';\n }\n \n ?>\n@@ -299,7 +310,7 @@\n echo '<p>' . $page_conditions . '</p>';\n \n if (!empty($sScreenMsg)) {\n-  echo \"<div class=\\\"success_box\\\">{$sScreenMsg}</div>\";\n+    echo \"<div class=\\\"success_box\\\">{$sScreenMsg}</div>\";\n }\n ?>\n \n@@ -313,9 +324,9 @@\n $canEdit = ($_source_id == '') && (empty($user_id) || ($_user->is_admin()));\n \n if (!$canEdit) {\n-  $disabled = ' disabled=\"disabled\"';\n+    $disabled = ' disabled=\"disabled\"';\n } else {\n-  $disabled = '';\n+    $disabled = '';\n }\n ?>\n       <input type=\"text\" name=\"username\" id=\"username\" value=\"<?php echo $edit_user->username; ?>\"<?php echo $disabled; ?>>\n@@ -357,9 +368,9 @@\n     <td>\n <?php\n if (!empty($edit_user->password)) {\n-  $show = '!!!!!!';\n+    $show = '!!!!!!';\n } else {\n-  $show = '';\n+    $show = '';\n }\n ?>\n       <input id=\"password\" name=\"password\" type=\"password\" value=\"<?php echo $show; ?>\"<?php echo $disabled; ?>>\n@@ -371,73 +382,69 @@\n \n <?php\n if (!empty($user_id) && !Common::check_user($edit_user, APP__USER_TYPE_ADMIN)) {\n-?>\n+    ?>\n   <tr><td colspan=\"4\"><hr/></td></tr>\n   <tr><td colspan=\"4\"><h2>Module</h2></td></tr>\n   <tr>\n     <td colspan=\"4\">\n \n <?php\n   $canEdit = ($_source_id == '') && ($user_id != $_user_id);\n-  if (!$canEdit) {\n-    $disabled = ' disabled=\"disabled\"';\n-  } else {\n-    $disabled = '';\n-  }\n-\n-  echo \"<table>\\n\";\n-  echo \"<tr>\\n\";\n-  echo \"  <th>Title</th><th style=\\\"width: 5em; text-align: center;\\\">NA</th><th style=\\\"width: 5em; text-align: center;\\\">Tutor</th><th style=\\\"width: 5em; text-align: center;\\\">Student</th>\\n\";\n-  echo \"</tr>\\n\";\n-\n-  $modules = $CIS->get_module(NULL, 'name');\n-  $user_modules = $CIS->get_user_modules($user_id);\n-\n-  foreach ($modules as $module) {\n-\n-    if (empty($user_modules) || !array_key_exists($module['module_id'], $user_modules)) {\n-      $role = '';\n-    } else {\n-      $role = $user_modules[$module['module_id']]['user_type'];\n-    }\n-    if ($module['module_id'] == $_module_id) {\n-      $tagStart = '<em>';\n-      $tagEnd = '</em>';\n+    if (!$canEdit) {\n+        $disabled = ' disabled=\"disabled\"';\n     } else {\n-      $tagStart = '';\n-      $tagEnd = '';\n+        $disabled = '';\n     }\n \n+    echo \"<table>\\n\";\n     echo \"<tr>\\n\";\n-    echo \"  <td>\\n    {$tagStart}{$module['module_title']}{$tagEnd}&nbsp;&nbsp;&nbsp;\\n  </td>\\n\";\n-    echo \"  <td style=\\\"text-align: center;\\\">\\n\";\n-    echo '    <input type=\"radio\" value=\"\" name=\"rdo_type_' . $module['module_id'] . '\"';\n-    if (empty($role)) {\n-      echo ' checked=\"checked\"';\n-    }\n-    echo \"{$disabled}>\\n\";\n-    echo \"  </td>\\n\";\n-    echo \"  <td style=\\\"text-align: center;\\\">\\n\";\n-    echo '    <input type=\"radio\" value=\"' . APP__USER_TYPE_TUTOR . '\" name=\"rdo_type_' . $module['module_id'] . '\"';\n-    if ($role == APP__USER_TYPE_TUTOR) {\n-      echo ' checked=\"checked\"';\n-    }\n-    echo \"{$disabled}>\\n\";\n-    echo \"  </td>\\n\";\n-    echo \"  <td style=\\\"text-align: center;\\\">\\n\";\n-    echo '    <input type=\"radio\" value=\"' . APP__USER_TYPE_STUDENT . '\" name=\"rdo_type_' . $module['module_id'] . '\"';\n-    if ($role == APP__USER_TYPE_STUDENT) {\n-      echo ' checked=\"checked\"';\n-    }\n-    echo \"{$disabled}>\\n\";\n-    echo \"  </td>\\n\";\n+    echo \"  <th>Title</th><th style=\\\"width: 5em; text-align: center;\\\">NA</th><th style=\\\"width: 5em; text-align: center;\\\">Tutor</th><th style=\\\"width: 5em; text-align: center;\\\">Student</th>\\n\";\n     echo \"</tr>\\n\";\n \n-  }\n+    $modules = $CIS->get_module(null, 'name');\n+    $user_modules = $CIS->get_user_modules($user_id);\n \n-  echo \"</table>\\n\";\n+    foreach ($modules as $module) {\n+        if (empty($user_modules) || !array_key_exists($module['module_id'], $user_modules)) {\n+            $role = '';\n+        } else {\n+            $role = $user_modules[$module['module_id']]['user_type'];\n+        }\n+        if ($module['module_id'] == $_module_id) {\n+            $tagStart = '<em>';\n+            $tagEnd = '</em>';\n+        } else {\n+            $tagStart = '';\n+            $tagEnd = '';\n+        }\n \n-?>\n+        echo \"<tr>\\n\";\n+        echo \"  <td>\\n    {$tagStart}{$module['module_title']}{$tagEnd}&nbsp;&nbsp;&nbsp;\\n  </td>\\n\";\n+        echo \"  <td style=\\\"text-align: center;\\\">\\n\";\n+        echo '    <input type=\"radio\" value=\"\" name=\"rdo_type_' . $module['module_id'] . '\"';\n+        if (empty($role)) {\n+            echo ' checked=\"checked\"';\n+        }\n+        echo \"{$disabled}>\\n\";\n+        echo \"  </td>\\n\";\n+        echo \"  <td style=\\\"text-align: center;\\\">\\n\";\n+        echo '    <input type=\"radio\" value=\"' . APP__USER_TYPE_TUTOR . '\" name=\"rdo_type_' . $module['module_id'] . '\"';\n+        if ($role == APP__USER_TYPE_TUTOR) {\n+            echo ' checked=\"checked\"';\n+        }\n+        echo \"{$disabled}>\\n\";\n+        echo \"  </td>\\n\";\n+        echo \"  <td style=\\\"text-align: center;\\\">\\n\";\n+        echo '    <input type=\"radio\" value=\"' . APP__USER_TYPE_STUDENT . '\" name=\"rdo_type_' . $module['module_id'] . '\"';\n+        if ($role == APP__USER_TYPE_STUDENT) {\n+            echo ' checked=\"checked\"';\n+        }\n+        echo \"{$disabled}>\\n\";\n+        echo \"  </td>\\n\";\n+        echo \"</tr>\\n\";\n+    }\n+\n+    echo \"</table>\\n\"; ?>\n     </td>\n   </tr>\n <?php"
        },
        {
          "filename": "src/admin/edit/module.php",
          "status": "modified",
          "additions": 11,
          "deletions": 12,
          "patch": "@@ -16,14 +16,14 @@\n  */\n \n //get the include file required\n-require_once(\"../../includes/inc_global.php\");\n+require_once '../../includes/inc_global.php';\n \n use WebPA\\includes\\classes\\Module;\n use WebPA\\includes\\functions\\Common;\n \n-if (!Common::check_user($_user, APP__USER_TYPE_ADMIN)){\n-  header('Location:'. APP__WWW .'/logout.php?msg=denied');\n-  exit;\n+if (!Common::check_user($_user, APP__USER_TYPE_ADMIN)) {\n+    header('Location:'. APP__WWW .'/logout.php?msg=denied');\n+    exit;\n }\n \n  //set the page information\n@@ -34,7 +34,7 @@\n $UI->set_page_bar_button('View Admin Data', '../../../images/buttons/button_admin_user.png', '../review/admin/index.php');\n $UI->set_page_bar_button('View Module Data', '../../../images/buttons/button_view_modules.png', '../review/module/index.php');\n $UI->set_page_bar_button('Search for a user', '../../../images/buttons/button_search_user.png', '../search/index.php');\n-$UI->breadcrumbs = array ('home' => '../','review data'=>'../review/','edit'=>null, );\n+$UI->breadcrumbs = ['home' => '../', 'review data'=>'../review/', 'edit'=>null];\n $UI->help_link = '?q=node/237';\n $UI->head();\n $UI->body();\n@@ -63,7 +63,7 @@\n $action = Common::fetch_POST('save');\n \n if ($action) {          //incase we want to do more than save changes in the future\n-  switch ($action) {\n+    switch ($action) {\n     case 'Save Changes':\n     //put all the elements back into the structures\n     $edit_module->module_code = Common::fetch_POST('module_code');\n@@ -72,9 +72,9 @@\n     //save all of the data\n     $edit_module->set_dao_object($DB);\n     if (empty($module)) {\n-      $module = $edit_module->add_module();\n+        $module = $edit_module->add_module();\n     } else {\n-      $edit_module->save_module();\n+        $edit_module->save_module();\n     }\n \n     //reload module\n@@ -83,10 +83,9 @@\n     $edit_module->load_from_row($module_id);\n \n     //send notification to the screen that the save has occured.\n-    $sScreenMsg = \"The changes made for the module have been saved\";\n+    $sScreenMsg = 'The changes made for the module have been saved';\n \n   }\n-\n }\n \n //-----------------------------------------------------------------------\n@@ -103,8 +102,8 @@\n \n <?php\n \n-  if(!empty($sScreenMsg)){\n-    echo \"<div class=\\\"success_box\\\">{$sScreenMsg}</div>\";\n+  if (!empty($sScreenMsg)) {\n+      echo \"<div class=\\\"success_box\\\">{$sScreenMsg}</div>\";\n   }\n \n ?>"
        },
        {
          "filename": "src/admin/index.php",
          "status": "modified",
          "additions": 24,
          "deletions": 24,
          "patch": "@@ -12,19 +12,19 @@\n  */\n \n //get the include file required\n-require_once(\"../includes/inc_global.php\");\n+require_once '../includes/inc_global.php';\n \n use WebPA\\includes\\functions\\Common;\n \n-if (!Common::check_user($_user, APP__USER_TYPE_TUTOR)){\n-  header('Location:'. APP__WWW .'/logout.php?msg=denied');\n-  exit;\n+if (!Common::check_user($_user, APP__USER_TYPE_TUTOR)) {\n+    header('Location:'. APP__WWW .'/logout.php?msg=denied');\n+    exit;\n }\n \n  //set the page information\n $UI->page_title = APP__NAME;\n $UI->menu_selected = 'admin home';\n-$UI->breadcrumbs = array ('home' => null);\n+$UI->breadcrumbs = ['home' => null];\n $UI->help_link = '?q=node/237';\n $UI->head();\n $UI->body();\n@@ -34,31 +34,31 @@\n \n $page_intro = 'Welcome to the Administration Area for ' . APP__NAME . '. In this section you are able to manage the users of the system (both adding new and editing existing)';\n if ($_user->is_admin()) {\n-  $page_intro .= ' as well as generate basic reports on the usage of ' . APP__NAME . ' (the metrics)';\n+    $page_intro .= ' as well as generate basic reports on the usage of ' . APP__NAME . ' (the metrics)';\n }\n $page_intro .= '.<br/><br/>The admin area contains the following sections:';\n $menu = $UI->get_menu('Admin');\n if (isset($menu['upload data'])) {\n-  $upload = $menu['upload data'];\n-  if ($_user->is_admin()) {\n-    $section_name = array('Upload Data', 'View Data', 'WebPA Metrics');\n-    $section_link = array($upload, 'review/', 'metrics/');\n-  } else {\n-    $section_name = array('Upload Data', 'View Data');\n-    $section_link = array($upload, 'review/');\n-  }\n+    $upload = $menu['upload data'];\n+    if ($_user->is_admin()) {\n+        $section_name = ['Upload Data', 'View Data', 'WebPA Metrics'];\n+        $section_link = [$upload, 'review/', 'metrics/'];\n+    } else {\n+        $section_name = ['Upload Data', 'View Data'];\n+        $section_link = [$upload, 'review/'];\n+    }\n } else {\n-  if ($_user->is_admin()) {\n-    $section_name = array('View Data', 'WebPA Metrics');\n-    $section_link = array('review/', 'metrics/');\n-  } else {\n-    $section_name = array('View Data');\n-    $section_link = array('review/');\n-  }\n+    if ($_user->is_admin()) {\n+        $section_name = ['View Data', 'WebPA Metrics'];\n+        $section_link = ['review/', 'metrics/'];\n+    } else {\n+        $section_name = ['View Data'];\n+        $section_link = ['review/'];\n+    }\n }\n-$section_definition = array('This is where you can upload the data to the system.',\n+$section_definition = ['This is where you can upload the data to the system.',\n               'This area allows you to view the uploaded data as well as search and edit user information.',\n-              'This section allows you to generate reports on the usage of WebPA locally.');\n+              'This section allows you to generate reports on the usage of WebPA locally.', ];\n ?>\n <p><?php echo $page_intro; ?></p>\n \n@@ -67,7 +67,7 @@\n <table class=\"option_list\" style=\"width: 500px;\">\n <?php\n   for ($i = 0; $i < count($section_link); $i++) {\n-?>\n+      ?>\n <tr>\n   <td><a href=\"<?php echo $section_link[$i]; ?>\"><img src=\"../images/icons/load_data.gif\" width=\"32\" height=\"32\" alt=\"\" /></a></td>\n   <td>"
        },
        {
          "filename": "src/admin/load/index.php",
          "status": "modified",
          "additions": 29,
          "deletions": 30,
          "patch": "@@ -17,20 +17,20 @@\n  */\n \n //get the include file required\n-require_once(\"../../includes/inc_global.php\");\n+require_once '../../includes/inc_global.php';\n \n use WebPA\\includes\\classes\\GroupHandler;\n use WebPA\\includes\\functions\\Common;\n \n if (!Common::check_user($_user, APP__USER_TYPE_TUTOR) || ($_source_id != '')) {\n-  header('Location:'. APP__WWW .'/logout.php?msg=denied');\n-  exit;\n+    header('Location:'. APP__WWW .'/logout.php?msg=denied');\n+    exit;\n }\n \n //set the page information\n $UI->page_title = APP__NAME;\n $UI->menu_selected = 'upload data';\n-$UI->breadcrumbs = array ('home' => null);\n+$UI->breadcrumbs = ['home' => null];\n $UI->help_link = '?q=node/237';\n \n $UI->head();\n@@ -59,7 +59,7 @@ function fileTypeSelected(id) {\n $page_intro = 'You can upload the data the system requires from this page';\n $filename = 'Enter the file name to be used:';\n $filecontent = 'Select the type of information you are uploading:<br>';\n-$filecontenttype = array(4);\n+$filecontenttype = [4];\n //even though it appears second, the 'student data with groups' option has a filecontenttype.value of 4 (to prevent possible breakage)\n \n //this code is for use when one wants to create group collections first, then upload data\n@@ -69,30 +69,30 @@ function fileTypeSelected(id) {\n $groupsAnnex = '<div style=\"display: none;\" id=\"collectionNameDiv\">\n   <label>Collection:';\n if (count($collections) > 0) {\n-  $groupsAnnex .= '&nbsp;<select name=\"collectionlist\">';\n-  $groupsAnnex .= '<option value=\"\">Create using name entered...</option>';\n-  foreach($collections as $collection) {\n-    $groupsAnnex .= \"<option value=\\\"{$collection['collection_id']}\\\">{$collection['collection_name']}</option>\";\n-  }\n-  $groupsAnnex .= '</select></label>&nbsp;<label>new:';\n+    $groupsAnnex .= '&nbsp;<select name=\"collectionlist\">';\n+    $groupsAnnex .= '<option value=\"\">Create using name entered...</option>';\n+    foreach ($collections as $collection) {\n+        $groupsAnnex .= \"<option value=\\\"{$collection['collection_id']}\\\">{$collection['collection_name']}</option>\";\n+    }\n+    $groupsAnnex .= '</select></label>&nbsp;<label>new:';\n }\n $groupsAnnex .= '&nbsp;<input type=\"text\" name=\"collection\"/></label></div>';\n \n if ($_user->is_admin()) {\n-  $filecontenttype[1] = array('screen'=>'<strong>Student Data</strong><p>CSV File format = id_number, forename, lastname, email, username, password, department_id, module_code</p>', 'value'=>'1');\n-  $filecontenttype[2] = array('screen'=>'<strong>Student Data with Groups</strong>'.$groupsAnnex.'<p>CSV File format = id_number, forename, lastname, email, username, group_name, password, module_code</p>', 'value'=>'4');\n-  $filecontenttype[3] = array('screen'=>'<strong>Staff Data</strong><p>CSV File format = id_number, forename, lastname, email, username, password, department_id, module_code</p>', 'value'=>'2');\n+    $filecontenttype[1] = ['screen'=>'<strong>Student Data</strong><p>CSV File format = id_number, forename, lastname, email, username, password, department_id, module_code</p>', 'value'=>'1'];\n+    $filecontenttype[2] = ['screen'=>'<strong>Student Data with Groups</strong>'.$groupsAnnex.'<p>CSV File format = id_number, forename, lastname, email, username, group_name, password, module_code</p>', 'value'=>'4'];\n+    $filecontenttype[3] = ['screen'=>'<strong>Staff Data</strong><p>CSV File format = id_number, forename, lastname, email, username, password, department_id, module_code</p>', 'value'=>'2'];\n } else {\n-  $filecontenttype[1] = array('screen'=>'<strong>Student Data</strong><p>CSV File format = id_number, forename, lastname, email, username, password, department_id</p>', 'value'=>'1');\n-  $filecontenttype[2] = array('screen'=>'<strong>Student Data with Groups</strong>'.$groupsAnnex.'<p>CSV File format = id_number, forename, lastname, email, username, group_name, password</p>', 'value'=>'4');\n-  $filecontenttype[3] = array('screen'=>'<strong>Staff Data</strong><p>CSV File format = id_number, forename, lastname, email, username, password, department_id</p>', 'value'=>'2');\n+    $filecontenttype[1] = ['screen'=>'<strong>Student Data</strong><p>CSV File format = id_number, forename, lastname, email, username, password, department_id</p>', 'value'=>'1'];\n+    $filecontenttype[2] = ['screen'=>'<strong>Student Data with Groups</strong>'.$groupsAnnex.'<p>CSV File format = id_number, forename, lastname, email, username, group_name, password</p>', 'value'=>'4'];\n+    $filecontenttype[3] = ['screen'=>'<strong>Staff Data</strong><p>CSV File format = id_number, forename, lastname, email, username, password, department_id</p>', 'value'=>'2'];\n }\n-$filecontenttype[4] = array('screen'=>'<strong>Module Data</strong><p>CSV File format = module_code, module_title</p>', 'value'=>'3');\n+$filecontenttype[4] = ['screen'=>'<strong>Module Data</strong><p>CSV File format = module_code, module_title</p>', 'value'=>'3'];\n $fileseparator = 'Select the type of file separator that has been used:';\n-$separator = array(3);\n-$separator[1] = array('screen'=> 'Comma separated', 'value'=>',', 'status' => '');\n-$separator[2] = array('screen'=> 'Tab separated', 'value'=>'\\t','status' => 'disabled');\n-$separator[3] = array('screen'=> 'Semi-colon', 'value'=>';','status' => 'disabled');\n+$separator = [3];\n+$separator[1] = ['screen'=> 'Comma separated', 'value'=>',', 'status' => ''];\n+$separator[2] = ['screen'=> 'Tab separated', 'value'=>'\\t', 'status' => 'disabled'];\n+$separator[3] = ['screen'=> 'Semi-colon', 'value'=>';', 'status' => 'disabled'];\n \n $btn_name = 'Upload';\n $pasteinstruction ='Copy and paste the contents of the file you want to add to the system, ensuring that the information is comma separated and that each entry begins on a new line.';\n@@ -119,14 +119,13 @@ function fileTypeSelected(id) {\n     </td>\n     <td>\n       <?php\n-        for($checkbox = 1; $checkbox<= count($filecontenttype)-1; $checkbox++){\n-\n-          echo '<input type=\"radio\" name=\"rdoFileContentType\" value=\"';\n-          echo $filecontenttype[$checkbox]['value'] . '\" ';\n-          echo \"onclick=\\\"fileTypeSelected({$filecontenttype[$checkbox]['value']})\\\" id=\\\"rdoFileContentType-{$filecontenttype[$checkbox]['value']}\\\"\";\n-          echo ' />';\n-          echo $filecontenttype[$checkbox]['screen'];\n-          echo '<br/>';\n+        for ($checkbox = 1; $checkbox<= count($filecontenttype)-1; $checkbox++) {\n+            echo '<input type=\"radio\" name=\"rdoFileContentType\" value=\"';\n+            echo $filecontenttype[$checkbox]['value'] . '\" ';\n+            echo \"onclick=\\\"fileTypeSelected({$filecontenttype[$checkbox]['value']})\\\" id=\\\"rdoFileContentType-{$filecontenttype[$checkbox]['value']}\\\"\";\n+            echo ' />';\n+            echo $filecontenttype[$checkbox]['screen'];\n+            echo '<br/>';\n         }\n       ?>\n     </td>"
        },
        {
          "filename": "src/admin/load/simple.php",
          "status": "modified",
          "additions": 233,
          "deletions": 193,
          "patch": "@@ -12,247 +12,285 @@\n  * @link https://github.com/webpa/webpa\n  */\n \n-require_once('../../includes/inc_global.php');\n+require_once '../../includes/inc_global.php';\n \n+use Doctrine\\DBAL\\ParameterType;\n use WebPA\\includes\\classes\\GroupCollection;\n use WebPA\\includes\\functions\\Common;\n use WebPA\\includes\\functions\\StringFunctions;\n \n if (!Common::check_user($_user, APP__USER_TYPE_TUTOR) || ($_source_id != '')) {\n- header('Location:'. APP__WWW .'/logout.php?msg=denied');\n- exit;\n+    header('Location:' . APP__WWW . '/logout.php?msg=denied');\n+    exit;\n }\n \n-$uploadtype = $_REQUEST[\"rdoFileContentType\"];\n+$uploadtype = $_REQUEST['rdoFileContentType'];\n $filename = $_FILES['uploadedfile']['tmp_name'];\n \n //define variable we are using\n $user_warning = '';\n $user_msg = '';\n \n-$filecontenttype[1] = array('screen'=>'<strong>Student Data</strong>',);\n-$filecontenttype[2] = array('screen'=>'<strong>Staff Data</strong>',);\n-$filecontenttype[3] = array('screen'=>'<strong>Module Data</strong>');\n-$filecontenttype[4] = array('screen'=>'<strong>Student Data with Groups</strong>');\n+$filecontenttype[1] = ['screen' => '<strong>Student Data</strong>'];\n+$filecontenttype[2] = ['screen' => '<strong>Staff Data</strong>'];\n+$filecontenttype[3] = ['screen' => '<strong>Module Data</strong>'];\n+$filecontenttype[4] = ['screen' => '<strong>Student Data with Groups</strong>'];\n \n-$expected_fields[1] = array(0=>'id_number', 'forename', 'lastname', 'email', 'username', 'password', 'department_id');\n-$expected_fields[2] = array(0=>'id_number', 'forename', 'lastname', 'email', 'username', 'password', 'department_id');\n-$expected_fields[3] = array(0=>'module_code', 'module_title');\n-$expected_fields[4] = array(0=>'id_number', 'forename', 'lastname', 'email', 'username', 'password', 'department_id', 'group_name');\n+$expected_fields[1] = [0 => 'id_number', 'forename', 'lastname', 'email', 'username', 'password', 'department_id'];\n+$expected_fields[2] = [0 => 'id_number', 'forename', 'lastname', 'email', 'username', 'password', 'department_id'];\n+$expected_fields[3] = [0 => 'module_code', 'module_title'];\n+$expected_fields[4] = [0 => 'id_number', 'forename', 'lastname', 'email', 'username', 'password', 'department_id', 'group_name'];\n \n if ($_user->is_admin()) {\n- $expected_fields[1][] = 'module_code';\n- $expected_fields[2][] = 'module_code';\n- $expected_fields[4][] = 'module_code';\n+    $expected_fields[1][] = 'module_code';\n+    $expected_fields[2][] = 'module_code';\n+    $expected_fields[4][] = 'module_code';\n }\n $flg_match = false;\n \n //increase the execution time to handle large files\n ini_set('max_execution_time', 120);\n \n $row = 0;\n-$fields = array();\n-$final_rows = array();\n-if (($handle = fopen($filename, \"r\")) !== FALSE) {\n-  while (($data = fgetcsv($handle, 2000, \",\")) !== FALSE) {\n-    $num = count($data);\n-\n-    //if in the first row we should be getting the field names\n-    //make them into an array\n-    if ($row == 0) {\n-      for ($c = 0; $c < $num; $c++) {\n-        $fields[$c] = trim($data[$c]);\n-      }\n-\n-      //check to see that we have the correct information in the array\n-      if (array_diff($expected_fields[$uploadtype], $fields)) {\n-\n-        //we have diferences. We need to check to see if any of the key elements have matched\n-        foreach ($expected_fields[$uploadtype] as $key_field) {\n-          if (array_search($key_field, $fields) !== false) {\n-            $flg_match = true;\n-          }\n+$fields = [];\n+$final_rows = [];\n+\n+if (($handle = fopen($filename, 'r')) !== false) {\n+    while (($data = fgetcsv($handle, 2000, ',')) !== false) {\n+        $num = count($data);\n+\n+        //if in the first row we should be getting the field names\n+        //make them into an array\n+        if ($row == 0) {\n+            for ($c = 0; $c < $num; $c++) {\n+                $fields[$c] = trim($data[$c]);\n+            }\n+\n+            //check to see that we have the correct information in the array\n+            if (array_diff($expected_fields[$uploadtype], $fields)) {\n+\n+                //we have diferences. We need to check to see if any of the key elements have matched\n+                foreach ($expected_fields[$uploadtype] as $key_field) {\n+                    if (array_search($key_field, $fields) !== false) {\n+                        $flg_match = true;\n+                    }\n+                }\n+                if (!$flg_match) {\n+                    for ($c = 0; $c < $num; $c++) {\n+                        $final_rows[$row][$c] = trim($data[$c]);\n+                        $fields[$c] = $c;\n+                    }\n+                    $row++;\n+                }\n+            } else {\n+                $flg_match = true;\n+            }\n+        } else {\n+            //build the associative array for the table entrys\n+            for ($c = 0; $c < $num; $c++) {\n+                $final_rows[$row - 1][$fields[$c]] = trim($data[$c]);\n+            }\n         }\n-        if (!$flg_match) {\n-          for ($c = 0; $c < $num; $c++) {\n-            $final_rows[$row][$c] = trim($data[$c]);\n-            $fields[$c] = $c;\n-          }\n-          $row++;\n-        }\n-\n-      } else {\n-        $flg_match = true;\n-      }\n-\n-    } else {\n-      //build the associative array for the table entrys\n-      for ($c = 0; $c < $num; $c++) {\n-        $final_rows[$row-1][$fields[$c]] = trim($data[$c]);\n-      }\n+        $row++;\n     }\n-    $row++;\n-  }\n-\n-//now we have the information in arrays continue to process.\n-  fclose($handle);\n \n+    //now we have the information in arrays continue to process.\n+    fclose($handle);\n }\n \n //check which array we are being given at this point (the one with the named fields or the other)\n if ($flg_match) {\n-  //we can process this very easily into the database\n+    //we can process this very easily into the database\n+\n+    //check to see if we have staff or student.\n+    if (($uploadtype == '1') || ($uploadtype == '2') || ($uploadtype == '4')) {\n+        //set the user type\n+        if ($uploadtype == '2') {\n+            $user_type = APP__USER_TYPE_TUTOR;\n+        } else {\n+            $user_type = APP__USER_TYPE_STUDENT;\n+        }\n \n-  //check to see if we have staff or student.\n-  if (($uploadtype == '1') || ($uploadtype == '2') || ($uploadtype == '4')) {\n+        $finalRowsCount = count($final_rows);\n \n-    //set the user type\n-    if ($uploadtype=='2') {\n-      $user_type = APP__USER_TYPE_TUTOR;\n-    } else {\n-      $user_type = APP__USER_TYPE_STUDENT;\n-    }\n-    for ($counter = 0; $counter<count($final_rows); $counter++) {\n-\n-      //if there are passwords in the list, they will need to be MD5 hashed\n-      if (!empty($final_rows[$counter]['password'])) {\n-        $final_rows[$counter]['password'] = md5($final_rows[$counter]['password']);\n-      } else {\n-        $final_rows[$counter]['password'] = md5(StringFunctions::str_random());\n-      }\n-    }\n-\n-    $_module_id = Common::fetch_SESSION('_module_id', null);\n-\n-    if ($uploadtype == '4') {\n-\n-// get collection\n-      $collection = new GroupCollection($DB);\n-      $collection_id = null;\n-      if (isset($_REQUEST['collectionlist'])) {\n-        $collection_id = $_REQUEST['collectionlist'];\n-      }\n-      $modules = array();\n-      if (empty($collection_id)) {\n-        $collection_name = $_REQUEST['collection'];\n-        if (!empty($collection_name)) {\n-          $collection->create();\n-          $collection->module_id = $_module_id;\n-          $collection->name = $collection_name;\n-          $collection->save();\n-          $collection_id = $collection->id;\n+        for ($counter = 0; $counter < $finalRowsCount; $counter++) {\n+            // if there are passwords in the list, they will need to be hashed\n+            if (!empty($final_rows[$counter]['password'])) {\n+                $final_rows[$counter]['password'] = password_hash($final_rows[$counter]['password'], PASSWORD_DEFAULT);\n+            } else {\n+                $final_rows[$counter]['password'] = password_hash(StringFunctions::str_random(), PASSWORD_DEFAULT);\n+            }\n         }\n-      } else {\n-        $collection->load($collection_id);\n-        $modules = $collection->get_modules();\n-      }\n-      $module_count = count($modules);\n \n-    }\n+        $_module_id = Common::fetch_SESSION('_module_id', null);\n \n-    $fields = $expected_fields[$uploadtype];\n-    foreach ($final_rows as $i) {\n-\n-      $module_code = '';\n-      $group_name = '';\n-      $els = array();\n-      $els[] = \"source_id = '{$_source_id}'\";\n-      for ($c = 0; $c < count($fields); $c++) {\n-        $key = $fields[$c];\n-        if (isset($i[$key])) {\n-          $val = $i[$key];\n-          if ($key == 'module_code') {\n-            $module_code = $val;\n-          } else if ($key == 'group_name') {\n-            $group_name = $val;\n-          } else {\n-            $els[] = \"$key = '\" . $DB->escape_str($val) . '\\'';\n-          }\n-        }\n-      }\n-      $sql = 'INSERT INTO ' . APP__DB_TABLE_PREFIX . 'user SET ' . implode(', ',$els) . ', admin = 0';\n-      if ($_user->is_admin()) {\n-        $sql .= ' ON DUPLICATE KEY UPDATE ' . implode(', ',$els);\n-      }\n-      $DB->execute($sql);\n-      $id = $DB->get_insert_id();\n-      if (!$id) {\n-        $id = $DB->fetch_value('SELECT user_id FROM ' . APP__DB_TABLE_PREFIX . \"user WHERE source_id = '{$_source_id}' AND username = '{$i['username']}'\");\n-      }\n-\n-      if ($_user->is_admin() && !empty($module_code)) {\n-        $sql = \"SELECT module_id FROM \" . APP__DB_TABLE_PREFIX . \"module WHERE source_id = '{$_source_id}' AND module_code = '$module_code'\";\n-        $module_id = $DB->fetch_value($sql);\n-      } else {\n-        $module_id = $_module_id;\n-      }\n-      if (!empty($module_id)) {\n-        $sql = \"INSERT INTO \" . APP__DB_TABLE_PREFIX . \"user_module SET user_id = {$id}, module_id = {$module_id}, user_type = '{$user_type}'\";\n-        $sql .= \" ON DUPLICATE KEY UPDATE user_type = '{$user_type}'\";\n-        $DB->execute($sql);\n-        if (!empty($collection_id) && !empty($group_name)) {\n-          if (!in_array($module_id, $modules)) {\n-            $modules[] = $module_id;\n-          }\n-          if (!$collection->group_exists($group_name)) {\n-            $group = $collection->new_group($group_name);\n-            $group->save();\n-            $collection->refresh_groups();\n-          }\n-          $collection->add_member($id, $group_name);\n-        }\n-      }\n+        if ($uploadtype == '4') {\n+            // get collection\n+            $collection = new GroupCollection($DB);\n+            $collection_id = null;\n \n-    }\n+            if (isset($_REQUEST['collectionlist'])) {\n+                $collection_id = $_REQUEST['collectionlist'];\n+            }\n \n-  } else {\n-\n-  //as we don't have staff or student then we must have \"module\"\n-\n-    $fields = $expected_fields[$uploadtype];\n-    foreach($final_rows as $i) {\n-\n-    //build the SQL\n-      $els = array();\n-      $els[] = \"source_id = '{$_source_id}'\";\n-      for ($c = 0; $c < count($fields); $c++) {\n-        $key = $fields[$c];\n-        $val = $i[$key];\n-        $els[] = \"$key = '\" . $DB->escape_str($val) . '\\'';\n-      }\n-      $sql = 'INSERT INTO ' . APP__DB_TABLE_PREFIX . 'module SET ' . implode(', ',$els);\n-      $els = array();\n-      for ($c = 0; $c < count($fields); $c++) {\n-        $key = $fields[$c];\n-        $val = $i[$key];\n-        if ($key != 'module_code') {\n-          $els[] = \"$key = '\" . $DB->escape_str($val) . '\\'';\n-        }\n-      }\n-      $sql .= ' ON DUPLICATE KEY UPDATE ' . implode(', ',$els);\n-      $DB->execute($sql);\n-    }\n+            $modules = [];\n \n-  }\n+            if (empty($collection_id)) {\n+                $collection_name = $_REQUEST['collection'];\n+\n+                if (!empty($collection_name)) {\n+                    $collection->create();\n+                    $collection->module_id = $_module_id;\n+                    $collection->name = $collection_name;\n+                    $collection->save();\n+                    $collection_id = $collection->id;\n+                }\n+            } else {\n+                $collection->load($collection_id);\n+                $modules = $collection->get_modules();\n+            }\n+\n+            $module_count = count($modules);\n+        }\n \n-  $user_msg = \"<p>Successful upload of the {$filecontenttype[$uploadtype]['screen']} information to the database.</p>\";\n+        $fields = $expected_fields[$uploadtype];\n+\n+        foreach ($final_rows as $i) {\n+            $module_code = $i['module_code'] ?? '';\n+            $group_name = $i['group_name'] ?? '';\n+\n+            $insertUserQuery =\n+                'INSERT INTO ' . APP__DB_TABLE_PREFIX . 'user ' .\n+                '(id_number, forename, lastname, email, username, password, department_id, source_id, admin) ' .\n+                'VALUES (?, ?, ?, ?, ?, ?, ?, ?, 0)';\n+\n+            if ($_user->is_admin()) {\n+                $insertUserQuery .=\n+                   ' ON DUPLICATE KEY UPDATE ' .\n+                   'id_number = ?, ' .\n+                   'forename = ?, ' .\n+                   'lastname = ?, ' .\n+                   'email = ?, ' .\n+                   'username = ?, ' .\n+                   'password = ?, ' .\n+                   'department_id = ?, ' .\n+                   'source_id = ? ';\n+            }\n+\n+            $stmt = $DB->getConnection()->prepare($insertUserQuery);\n+\n+            $stmt->bindValue(1, $i['id_number']);\n+            $stmt->bindValue(2, $i['forename']);\n+            $stmt->bindValue(3, $i['lastname']);\n+            $stmt->bindValue(4, $i['email']);\n+            $stmt->bindValue(5, $i['username']);\n+            $stmt->bindValue(6, $i['password']);\n+            $stmt->bindValue(7, $i['department_id']);\n+            $stmt->bindValue(8, $_source_id);\n+\n+            if ($_user->is_admin()) {\n+                $stmt->bindValue(9, $i['id_number']);\n+                $stmt->bindValue(10, $i['forename']);\n+                $stmt->bindValue(11, $i['lastname']);\n+                $stmt->bindValue(12, $i['email']);\n+                $stmt->bindValue(13, $i['username']);\n+                $stmt->bindValue(14, $i['password']);\n+                $stmt->bindValue(15, $i['department_id']);\n+                $stmt->bindValue(16, $_source_id);\n+            }\n+\n+            $stmt->execute();\n+\n+            $id = $DB->getConnection()->lastInsertId();\n+\n+            if (!$id) {\n+                $getUserIdQuery =\n+                    'SELECT user_id ' .\n+                    'FROM ' . APP__DB_TABLE_PREFIX . 'user ' .\n+                    'WHERE source_id = ? ' .\n+                    'AND username = ?';\n+\n+                $id = $DB->getConnection()->fetchOne($getUserIdQuery, [$_source_id, $i['username']], [ParameterType::STRING, ParameterType::STRING]);\n+            }\n+\n+            if ($_user->is_admin() && !empty($module_code)) {\n+                $sql =\n+                    'SELECT module_id ' .\n+                    'FROM ' . APP__DB_TABLE_PREFIX . 'module ' .\n+                    'WHERE source_id = ? ' .\n+                    'AND module_code = ?';\n+\n+                $module_id = $DB->getConnection()->fetchOne($sql, [$_source_id, $module_code], [ParameterType::STRING, ParameterType::STRING]);\n+            } else {\n+                $module_id = $_module_id;\n+            }\n+            if (!empty($module_id)) {\n+                $insertUserModuleQuery =\n+                    'INSERT INTO ' . APP__DB_TABLE_PREFIX . 'user_module ' .\n+                    'VALUES (?, ?, ?) ' .\n+                    'ON DUPLICATE KEY UPDATE user_type = ?';\n+\n+                $DB->getConnection()->executeQuery(\n+                    $insertUserModuleQuery,\n+                    [$id, $module_id, $user_type, $user_type],\n+                    [ParameterType::INTEGER, ParameterType::INTEGER, ParameterType::STRING, ParameterType::STRING]\n+                );\n+\n+                if (!empty($collection_id) && !empty($group_name)) {\n+                    if (!in_array($module_id, $modules)) {\n+                        $modules[] = $module_id;\n+                    }\n+                    if (!$collection->group_exists($group_name)) {\n+                        $group = $collection->new_group($group_name);\n+                        $group->save();\n+                        $collection->refresh_groups();\n+                    }\n+                    $collection->add_member($id, $group_name);\n+                }\n+            }\n+        }\n+    } else {\n+        // as we don't have staff or student then we must have \"module\"\n+        $fields = $expected_fields[$uploadtype];\n+\n+        foreach ($final_rows as $i) {\n+            $insertModuleQuery =\n+                'INSERT INTO ' . APP__DB_TABLE_PREFIX . 'module ' .\n+                '(module_code, module_title, source_id) ' .\n+                'VALUES (?, ? , ?) ' .\n+                'ON DUPLICATE KEY UPDATE ' .\n+                'module_title = ?, ' .\n+                'source_id = ?';\n+\n+            $stmt = $DB->getConnection()->prepare($insertModuleQuery);\n+\n+            $stmt->bindValue(1, $i['module_code']);\n+            $stmt->bindValue(2, $i['module_title']);\n+            $stmt->bindValue(3, $_source_id);\n+            $stmt->bindValue(4, $i['module_title']);\n+            $stmt->bindValue(5, $_source_id);\n+\n+            $stmt->execute();\n+        }\n+    }\n \n+    $user_msg = \"<p>Successful upload of the {$filecontenttype[$uploadtype]['screen']} information to the database.</p>\";\n } else {\n-  //we want to notify that the information is not structured as expected therefore bounce back to the user\n-  $user_warning .= \"The information supplied cannot be processed.</div><div><p>We suggest that you review the information to be uploaded and they <a href=\\\"../\\\">try again</a>. Alternatively you may wish to download a template to put the information in.</p>\";\n+    //we want to notify that the information is not structured as expected therefore bounce back to the user\n+    $user_warning .= 'The information supplied cannot be processed.</div><div><p>We suggest that you review the information to be uploaded and they <a href=\"../\">try again</a>. Alternatively you may wish to download a template to put the information in.</p>';\n }\n \n //write to screen the page information\n //set the page information\n $UI->page_title = APP__NAME;\n $UI->menu_selected = 'upload data';\n-$UI->breadcrumbs = array ('home' => null);\n+$UI->breadcrumbs = ['home' => null];\n $UI->help_link = '?q=node/237';\n $UI->set_page_bar_button('View Student Data', '../../../images/buttons/button_student_user.png', '../review/student/index.php');\n $UI->set_page_bar_button('View Staff Data', '../../../images/buttons/button_staff_user.png', '../review/staff/index.php');\n if (Common::check_user($_user, APP__USER_TYPE_ADMIN)) {\n-  $UI->set_page_bar_button('View Admin Data', '../../../images/buttons/button_admin_user.png', '../review/admin/index.php');\n-  $UI->set_page_bar_button('View Module Data', '../../../images/buttons/button_view_modules.png', '../review/module/index.php');\n+    $UI->set_page_bar_button('View Admin Data', '../../../images/buttons/button_admin_user.png', '../review/admin/index.php');\n+    $UI->set_page_bar_button('View Module Data', '../../../images/buttons/button_view_modules.png', '../review/module/index.php');\n }\n $UI->set_page_bar_button('Search for a user', '../../../images/buttons/button_search_user.png', '../review/search/index.php');\n \n@@ -261,15 +299,17 @@\n $UI->content_start();\n ?>\n <div class=\"content_box\">\n-<?php if(!empty($user_warning)){echo \"<div class=\\\"warning_box\\\">{$user_warning}</div>\";}?>\n+    <?php if (!empty($user_warning)) {\n+    echo \"<div class=\\\"warning_box\\\">{$user_warning}</div>\";\n+} ?>\n \n-<?php if(!empty($user_msg)){echo $user_msg;}?>\n+    <?php if (!empty($user_msg)) {\n+    echo $user_msg;\n+} ?>\n \n </div>\n \n \n <?php\n \n $UI->content_end();\n-\n-?>"
        },
        {
          "filename": "src/admin/load/templates.php",
          "status": "modified",
          "additions": 9,
          "deletions": 9,
          "patch": "@@ -10,31 +10,31 @@\n  * @link https://github.com/webpa/webpa\n  */\n \n-require_once(\"../../includes/inc_global.php\");\n+require_once '../../includes/inc_global.php';\n \n use WebPA\\includes\\functions\\Common;\n \n-if (!Common::check_user($_user, APP__USER_TYPE_TUTOR)){\n-  header('Location:'. APP__WWW .'/logout.php?msg=denied');\n-  exit;\n+if (!Common::check_user($_user, APP__USER_TYPE_TUTOR)) {\n+    header('Location:'. APP__WWW .'/logout.php?msg=denied');\n+    exit;\n }\n \n //write to screen the page information\n //set the page information\n-$UI->page_title = APP__NAME .\" Upload templates\";\n+$UI->page_title = APP__NAME .' Upload templates';\n $UI->menu_selected = 'upload data';\n-$UI->breadcrumbs = array ('home' => '../../',\n-              'Upload'=>'../');\n+$UI->breadcrumbs = ['home' => '../../',\n+              'Upload'=>'../', ];\n $UI->help_link = '?q=node/237';\n \n $UI->head();\n $UI->body();\n $UI->content_start();\n \n if ($_user->is_admin()) {\n-  $usersfile = 'users_a.csv';\n+    $usersfile = 'users_a.csv';\n } else {\n-  $usersfile = 'users.csv';\n+    $usersfile = 'users.csv';\n }\n ?>\n <div class=\"content_box\">"
        },
        {
          "filename": "src/admin/metrics/index.php",
          "status": "modified",
          "additions": 15,
          "deletions": 15,
          "patch": "@@ -12,23 +12,23 @@\n  */\n \n //get the include file required\n-require_once(\"../../includes/inc_global.php\");\n+require_once '../../includes/inc_global.php';\n \n-use WebPA\\includes\\functions\\Common;\n use WebPA\\includes\\functions\\AcademicYear;\n+use WebPA\\includes\\functions\\Common;\n \n if (!Common::check_user($_user, APP__USER_TYPE_ADMIN)) {\n-  header('Location:'. APP__WWW .'/logout.php?msg=denied');\n-  exit;\n+    header('Location:'. APP__WWW .'/logout.php?msg=denied');\n+    exit;\n }\n \n-$intro_text = \"<p>This page allows you to build a report on commonly requested metrics about the WebPA systems usage.</p>\";\n-$task_text = \"<p>Please tick all the boxes for the information that you would like to have in your report. Then click the generate button to view the report.</p>\";\n+$intro_text = '<p>This page allows you to build a report on commonly requested metrics about the WebPA systems usage.</p>';\n+$task_text = '<p>Please tick all the boxes for the information that you would like to have in your report. Then click the generate button to view the report.</p>';\n \n //set the page information\n-$UI->page_title = APP__NAME . \" metrics of use\";\n+$UI->page_title = APP__NAME . ' metrics of use';\n $UI->menu_selected = 'metrics';\n-$UI->breadcrumbs = array ('home' => '../../');\n+$UI->breadcrumbs = ['home' => '../../'];\n $UI->help_link = '?q=node/237';\n $UI->head();\n ?>\n@@ -46,7 +46,7 @@\n $UI->content_start();\n \n echo $intro_text;\n-echo \"<div class=\\\"content_box\\\">\";\n+echo '<div class=\"content_box\">';\n echo $task_text;\n \n //write a list of the elements that can be selected for the report\n@@ -59,12 +59,12 @@\n   <select name=\"academic_year\" id=\"academic_year\">\n <?php\n for ($i = $years[0]; $i <= $years[1]; $i++) {\n-  $selected_str = ($i == $year) ? 'selected=\"selected\"' : '';\n-  echo(\"<option value=\\\"$i\\\" $selected_str>\". $i);\n-  if (APP__ACADEMIC_YEAR_START_MONTH > 1) {\n-    echo('/' . substr($i + 1, 2, 2));\n-  }\n-  echo ('</option>');\n+    $selected_str = ($i == $year) ? 'selected=\"selected\"' : '';\n+    echo \"<option value=\\\"$i\\\" $selected_str>\". $i;\n+    if (APP__ACADEMIC_YEAR_START_MONTH > 1) {\n+        echo '/' . substr($i + 1, 2, 2);\n+    }\n+    echo '</option>';\n }\n ?>\n   </select>"
        },
        {
          "filename": "src/admin/metrics/report.php",
          "status": "modified",
          "additions": 795,
          "deletions": 680,
          "patch": "@@ -13,27 +13,27 @@\n  */\n \n //get the include file required\n-require_once(\"../../includes/inc_global.php\");\n+require_once '../../includes/inc_global.php';\n \n-use WebPA\\includes\\functions\\Common;\n use WebPA\\includes\\functions\\AcademicYear;\n+use WebPA\\includes\\functions\\Common;\n \n-if (!Common::check_user($_user, APP__USER_TYPE_ADMIN)){\n-  header('Location:'. APP__WWW .'/logout.php?msg=denied');\n-  exit;\n+if (!Common::check_user($_user, APP__USER_TYPE_ADMIN)) {\n+    header('Location:'. APP__WWW .'/logout.php?msg=denied');\n+    exit;\n }\n \n $year = (int) Common::fetch_POST('academic_year', Common::fetch_SESSION('year', AcademicYear::get_academic_year()));\n $_SESSION['year'] = $year;\n \n $academic_year = strval($year);\n if (APP__ACADEMIC_YEAR_START_MONTH > 1) {\n-  $academic_year .= '/' . substr($year + 1, 2, 2);\n+    $academic_year .= '/' . substr($year + 1, 2, 2);\n }\n \n $this_year = '-';\n if (APP__ACADEMIC_YEAR_START_MONTH <= 10) {\n-  $this_year .= '0';\n+    $this_year .= '0';\n }\n $this_year .= APP__ACADEMIC_YEAR_START_MONTH . '-01 00:00:00';\n $next_year = strval($year + 1) . $this_year;\n@@ -57,804 +57,919 @@\n \n $this_accademic_year = AcademicYear::get_academic_year() . '-';\n if (APP__ACADEMIC_YEAR_START_MONTH <= 10) {\n-  $this_accademic_year .= '0';\n+    $this_accademic_year .= '0';\n }\n $this_accademic_year .= APP__ACADEMIC_YEAR_START_MONTH . '-01 00:00:00';\n \n // formulate all the sql for the reports\n //assessments which have been run\n-$run_assessments_SQL = 'SELECT a.assessment_name, m.module_code, m.module_title, a.open_date, a.close_date ' .\n+$dbConn = $DB->getConnection();\n+\n+$runAssessmentsStmt = $dbConn->prepare(\n+    'SELECT a.assessment_name, m.module_code, m.module_title, a.open_date, a.close_date ' .\n    'FROM ' . APP__DB_TABLE_PREFIX . 'assessment a ' .\n    'INNER JOIN ' . APP__DB_TABLE_PREFIX . 'module m ON a.module_id = m.module_id ' .\n-   \"WHERE m.source_id = '{$_source_id}' AND a.open_date >= '{$this_year}' AND a.open_date < '{$next_year}' \" .\n-   'ORDER BY a.close_date, a.open_date, a.assessment_name, a.assessment_id';\n+   'WHERE m.source_id = ? AND a.open_date >= ? AND a.open_date < ? ' .\n+   'ORDER BY a.close_date, a.open_date, a.assessment_name, a.assessment_id'\n+);\n+\n+$runAssessmentsStmt->bindValue(1, $_source_id);\n+$runAssessmentsStmt->bindValue(2, $this_year);\n+$runAssessmentsStmt->bindValue(3, $next_year);\n \n //number of groups per assessment\n-$run_groups_per_assessment_SQL = 'SELECT a.assessment_name, m.module_code, m.module_title, COUNT(g.group_id) as group_count ' .\n+$runGroupsPerAssessmentStmt = $dbConn->prepare('SELECT a.assessment_name, m.module_code, m.module_title, COUNT(g.group_id) as group_count ' .\n    'FROM ' . APP__DB_TABLE_PREFIX . 'assessment a ' .\n    'INNER JOIN ' . APP__DB_TABLE_PREFIX . 'user_group g ON a.collection_id = g.collection_id ' .\n    'INNER JOIN ' . APP__DB_TABLE_PREFIX . 'module m ON a.module_id = m.module_id ' .\n-   \"WHERE m.source_id = '{$_source_id}' AND a.open_date >= '{$this_year}' AND a.open_date < '{$next_year}' \" .\n+   'WHERE m.source_id = ? AND a.open_date >= ? AND a.open_date < ? ' .\n    'GROUP BY a.assessment_name, m.module_code, m.module_title ' .\n-   'ORDER BY a.assessment_name';\n+   'ORDER BY a.assessment_name');\n+\n+$runGroupsPerAssessmentStmt->bindValue(1, $_source_id);\n+$runGroupsPerAssessmentStmt->bindValue(2, $this_year);\n+$runGroupsPerAssessmentStmt->bindValue(3, $next_year);\n \n //number of students per assessment\n-$run_students_per_assessment_SQL = 'SELECT a.assessment_name, m.module_code, m.module_title, COUNT(ugm.user_id) as student_count ' .\n+$runStudentsPerAssessmentStmt = $dbConn->prepare('SELECT a.assessment_name, m.module_code, m.module_title, COUNT(ugm.user_id) as student_count ' .\n    'FROM ' . APP__DB_TABLE_PREFIX . 'assessment a ' .\n    'INNER JOIN ' . APP__DB_TABLE_PREFIX . 'user_group g ON a.collection_id = g.collection_id ' .\n    'INNER JOIN ' . APP__DB_TABLE_PREFIX . 'user_group_member ugm ON g.group_id = ugm.group_id ' .\n    'INNER JOIN ' . APP__DB_TABLE_PREFIX . 'module m ON a.module_id = m.module_id ' .\n-   \"WHERE m.source_id = '{$_source_id}' AND a.open_date >= '{$this_year}' AND a.open_date < '{$next_year}' \" .\n+   'WHERE m.source_id = ? AND a.open_date >= ? AND a.open_date < ? ' .\n    'GROUP BY a.assessment_name, m.module_code, m.module_title ' .\n-   'ORDER BY a.assessment_name, m.module_code';\n+   'ORDER BY a.assessment_name, m.module_code');\n+\n+$runStudentsPerAssessmentStmt->bindValue(1, $_source_id);\n+$runStudentsPerAssessmentStmt->bindValue(2, $this_year);\n+$runStudentsPerAssessmentStmt->bindValue(3, $next_year);\n \n //assessments where feedback has been used\n-$run_feedback_SQL = 'SELECT a.assessment_name, m.module_code, m.module_title ' .\n+$runFeedbackStmt = $dbConn->prepare('SELECT a.assessment_name, m.module_code, m.module_title ' .\n    'FROM ' . APP__DB_TABLE_PREFIX . 'assessment a ' .\n    'INNER JOIN ' . APP__DB_TABLE_PREFIX . 'module m ON a.module_id = m.module_id ' .\n-   \"WHERE m.source_id = '{$_source_id}' AND a.open_date >= '{$this_year}' AND a.open_date < '{$next_year}' \" .\n+   'WHERE m.source_id = ? AND a.open_date >= ? AND a.open_date < ? ' .\n    'AND a.allow_feedback = 1 ' .\n-   'ORDER BY a.assessment_name, a.assessment_id';\n+   'ORDER BY a.assessment_name, a.assessment_id');\n+\n+$runFeedbackStmt->bindValue(1, $_source_id);\n+$runFeedbackStmt->bindValue(2, $this_year);\n+$runFeedbackStmt->bindValue(3, $next_year);\n+\n \n //number of respondents per assessment\n-$run_respondents = 'SELECT a.assessment_name, m.module_code, m.module_title, COUNT(DISTINCT um.user_id) as response_count ' .\n+$runRespondentsStmt = $dbConn->prepare('SELECT a.assessment_name, m.module_code, m.module_title, COUNT(DISTINCT um.user_id) as response_count ' .\n    'FROM ' . APP__DB_TABLE_PREFIX . 'assessment a ' .\n    'INNER JOIN ' . APP__DB_TABLE_PREFIX . 'user_mark um ON a.assessment_id=um.assessment_id ' .\n    'INNER JOIN ' . APP__DB_TABLE_PREFIX . 'module m ON a.module_id = m.module_id ' .\n-   \"WHERE m.source_id = '{$_source_id}' AND a.open_date >= '{$this_year}' AND a.open_date < '{$next_year}' \" .\n+   'WHERE m.source_id = ? AND a.open_date >= ? AND a.open_date < ? ' .\n    'GROUP BY a.assessment_name, m.module_code, m.module_title ' .\n-   'ORDER BY a.assessment_name, m.module_code';\n+   'ORDER BY a.assessment_name, m.module_code');\n+\n+$runRespondentsStmt->bindValue(1, $_source_id);\n+$runRespondentsStmt->bindValue(2, $this_year);\n+$runRespondentsStmt->bindValue(3, $next_year);\n \n //who has run an assessment in the current academic year\n-$run_modules_per_assessments_SQL = 'SELECT DISTINCT m.module_code, m.module_title ' .\n+$runModulesPerAssessmentsStmt = $dbConn->prepare('SELECT DISTINCT m.module_code, m.module_title ' .\n    'FROM ' . APP__DB_TABLE_PREFIX . 'assessment a ' .\n    'INNER JOIN ' . APP__DB_TABLE_PREFIX . 'module m ON a.module_id = m.module_id ' .\n-   \"WHERE m.source_id = '{$_source_id}' AND a.open_date >= '{$this_year}' AND a.open_date < '{$next_year}' \" .\n-   'ORDER BY a.assessment_name, m.module_code';\n+   'WHERE m.source_id = ? AND a.open_date >= ? AND a.open_date < ? ' .\n+   'ORDER BY m.module_code');\n+\n+$runModulesPerAssessmentsStmt->bindValue(1, $_source_id);\n+$runModulesPerAssessmentsStmt->bindValue(2, $this_year);\n+$runModulesPerAssessmentsStmt->bindValue(3, $next_year);\n \n //number of students who has carried out an assessment this year\n-$run_students_assessed_SQL = 'SELECT COUNT(DISTINCT ugm.user_id) as \\'Total unique students assessed\\' ' .\n+$runStudentsAssessedStmt = $dbConn->prepare('SELECT COUNT(DISTINCT ugm.user_id) as \\'Total unique students assessed\\' ' .\n    'FROM ' . APP__DB_TABLE_PREFIX . 'assessment a ' .\n    'INNER JOIN ' . APP__DB_TABLE_PREFIX . 'user_group ug ON a.collection_id = ug.collection_id ' .\n    'INNER JOIN ' . APP__DB_TABLE_PREFIX . 'user_group_member ugm ON ug.group_id = ugm.group_id ' .\n    'INNER JOIN ' . APP__DB_TABLE_PREFIX . 'module m ON a.module_id = m.module_id ' .\n-   \"WHERE m.source_id = '{$_source_id}' AND a.open_date >= '{$this_year}' AND a.open_date < '{$next_year}'\";\n+   'WHERE m.source_id = ? AND a.open_date >= ? AND a.open_date < ?');\n+\n+$runStudentsAssessedStmt->bindValue(1, $_source_id);\n+$runStudentsAssessedStmt->bindValue(2, $this_year);\n+$runStudentsAssessedStmt->bindValue(3, $next_year);\n \n //-------------------------------------------------------\n //view on screen\n-if($format == 'html') {\n-  //set the page information\n-  $UI->page_title = APP__NAME . \" general usage report\";\n-  $UI->menu_selected = 'metrics';\n-  $UI->breadcrumbs = array ('home' => '../../');\n-  $UI->help_link = '?q=node/237';\n-  $UI->head();\n-  $UI->body();\n-  $UI->content_start();\n-\n-  echo \"<div class=\\\"content_box\\\">\";\n-\n-  if (!empty($assessments_run)) {\n-\n-    $rs_assessments = $DB->fetch($run_assessments_SQL);\n-\n-    echo \"<h2>Assessments run in WebPA ({$academic_year})</h2>\";\n-\n-    if ($rs_assessments) {\n-      echo \"<table class=\\\"grid\\\">\";\n-      $icounter = 0;\n-\n-      //loop round the initial array\n-      foreach ($rs_assessments as $assessment) {\n-        if($icounter==0){\n-          //get an array of the key to the $assessment array\n-          $field_names = array_keys($assessment);\n-\n-          foreach($field_names as $row){\n-            echo \"<th>{$row}</th>\";\n-          }\n-        }\n-\n-        echo \"<tr>\";\n-        foreach($assessment as $row){\n-          echo \"<td>{$row}</td>\";\n+if ($format == 'html') {\n+    //set the page information\n+    $UI->page_title = APP__NAME . ' general usage report';\n+    $UI->menu_selected = 'metrics';\n+    $UI->breadcrumbs = ['home' => '../../'];\n+    $UI->help_link = '?q=node/237';\n+    $UI->head();\n+    $UI->body();\n+    $UI->content_start();\n+\n+    echo '<div class=\"content_box\">';\n+\n+    if (!empty($assessments_run)) {\n+        // This returns a Result object... what can we do with it?\n+        $runAssessmentsResult = $runAssessmentsStmt->execute();\n+\n+        $rs_assessments = $runAssessmentsResult->fetchAllAssociative();\n+\n+        echo \"<h2>Assessments run in WebPA ({$academic_year})</h2>\";\n+\n+        if ($rs_assessments) {\n+            echo '<table class=\"grid\">';\n+            $icounter = 0;\n+\n+            //loop round the initial array\n+            foreach ($rs_assessments as $assessment) {\n+                if ($icounter==0) {\n+                    //get an array of the key to the $assessment array\n+                    $field_names = array_keys($assessment);\n+\n+                    foreach ($field_names as $row) {\n+                        echo \"<th>{$row}</th>\";\n+                    }\n+                }\n+\n+                echo '<tr>';\n+                foreach ($assessment as $row) {\n+                    echo \"<td>{$row}</td>\";\n+                }\n+                echo '</tr>';\n+                $icounter ++;\n+            }\n+            echo '</table>';\n+        } else {\n+            echo '<p>None</p>';\n         }\n-        echo \"</tr>\";\n-        $icounter ++;\n-      }\n-      echo \"</table>\";\n-    } else {\n-      echo '<p>None</p>';\n     }\n-  }\n \n-  if(!empty($assessment_groups)){\n-    $rs_groups = $DB->fetch($run_groups_per_assessment_SQL);\n-    echo \"<h2>Number of groups per assessment ({$academic_year})</h2>\";\n+    if (!empty($assessment_groups)) {\n+        $runGroupsPerAssessmentResult = $runGroupsPerAssessmentStmt->execute();\n \n-    if ($rs_groups) {\n-      echo \"<table class=\\\"grid\\\">\";\n+        $rs_groups = $runGroupsPerAssessmentResult->fetchAllAssociative();\n \n-      $icounter = 0;\n-      //loop round the initial array\n-      foreach ($rs_groups as $groups) {\n-        if($icounter==0){\n-          $field_names = array_keys($groups);\n+        echo \"<h2>Number of groups per assessment ({$academic_year})</h2>\";\n \n-          foreach($field_names as $row){\n-            echo \"<th>{$row}</th>\";\n-          }\n-        }\n+        if ($rs_groups) {\n+            echo '<table class=\"grid\">';\n \n-        echo \"<tr>\";\n-        foreach ($groups as $row) {\n-          echo \"<td>{$row}</td>\";\n-        }\n-        echo \"</tr>\";\n-        $icounter ++;\n-      }\n-      echo \"</table>\";\n-    } else {\n-      echo '<p>None</p>';\n-    }\n-  }\n-\n-  if(!empty($assessment_students)){\n-    $rs_students = $DB->fetch($run_students_per_assessment_SQL);\n-    echo \"<h2>Number of students per assessment ({$academic_year})</h2>\";\n-\n-    if ($rs_students) {\n-      echo \"<table class=\\\"grid\\\">\";\n+            $icounter = 0;\n+            //loop round the initial array\n+            foreach ($rs_groups as $groups) {\n+                if ($icounter==0) {\n+                    $field_names = array_keys($groups);\n \n-      $icounter = 0;\n-      //loop round the initial array\n-      foreach ($rs_students as $students) {\n-        if($icounter==0){\n-          $field_names = array_keys($students);\n+                    foreach ($field_names as $row) {\n+                        echo \"<th>{$row}</th>\";\n+                    }\n+                }\n \n-          foreach ($field_names as $row) {\n-            echo \"<th>{$row}</th>\";\n-          }\n+                echo '<tr>';\n+                foreach ($groups as $row) {\n+                    echo \"<td>{$row}</td>\";\n+                }\n+                echo '</tr>';\n+                $icounter ++;\n+            }\n+            echo '</table>';\n+        } else {\n+            echo '<p>None</p>';\n         }\n-        echo \"<tr>\";\n-        foreach ($students as $row) {\n-          echo \"<td>{$row}</td>\";\n-        }\n-        echo \"</tr>\";\n-        $icounter++;\n-      }\n-      echo \"</table>\";\n-    } else {\n-      echo '<p>None</p>';\n     }\n-  }\n-  if(!empty($assessment_feedback)){\n-    $rs_feedback = $DB->fetch($run_feedback_SQL);\n-    echo \"<h2>Assessments where feedback has been used ({$academic_year})</h2>\";\n-\n-    if ($rs_feedback) {\n-      echo \"<table class=\\\"grid\\\">\";\n-\n-      $icounter = 0;\n \n-      //loop round the initial array\n-      foreach($rs_feedback as $feedback){\n-\n-        if($icounter==0){\n-          $field_names = array_keys($feedback);\n-          foreach($field_names as $row){\n-            echo\"<th>{$row}</th>\";\n-          }\n+    if (!empty($assessment_students)) {\n+        $runStudentsPerAssessmentResult = $runStudentsPerAssessmentStmt->execute();\n+\n+        $rs_students = $runStudentsPerAssessmentResult->fetchAllAssociative();\n+\n+        echo \"<h2>Number of students per assessment ({$academic_year})</h2>\";\n+\n+        if ($rs_students) {\n+            echo '<table class=\"grid\">';\n+\n+            $icounter = 0;\n+            //loop round the initial array\n+            foreach ($rs_students as $students) {\n+                if ($icounter==0) {\n+                    $field_names = array_keys($students);\n+\n+                    foreach ($field_names as $row) {\n+                        echo \"<th>{$row}</th>\";\n+                    }\n+                }\n+                echo '<tr>';\n+                foreach ($students as $row) {\n+                    echo \"<td>{$row}</td>\";\n+                }\n+                echo '</tr>';\n+                $icounter++;\n+            }\n+            echo '</table>';\n+        } else {\n+            echo '<p>None</p>';\n         }\n-\n-        echo \"<tr>\";\n-        foreach($feedback as $row){\n-          echo \"<td>{$row}</td>\";\n+    }\n+    if (!empty($assessment_feedback)) {\n+        $runFeedbackResult = $runFeedbackStmt->execute();\n+\n+        $rs_feedback = $runFeedbackResult->fetchAllAssociative();\n+\n+        echo \"<h2>Assessments where feedback has been used ({$academic_year})</h2>\";\n+\n+        if ($rs_feedback) {\n+            echo '<table class=\"grid\">';\n+\n+            $icounter = 0;\n+\n+            //loop round the initial array\n+            foreach ($rs_feedback as $feedback) {\n+                if ($icounter==0) {\n+                    $field_names = array_keys($feedback);\n+                    foreach ($field_names as $row) {\n+                        echo\"<th>{$row}</th>\";\n+                    }\n+                }\n+\n+                echo '<tr>';\n+                foreach ($feedback as $row) {\n+                    echo \"<td>{$row}</td>\";\n+                }\n+                echo '</tr>';\n+                $icounter++;\n+            }\n+            echo '</table>';\n+        } else {\n+            echo '<p>None</p>';\n         }\n-        echo \"</tr>\";\n-        $icounter++;\n-      }\n-      echo \"</table>\";\n-    } else {\n-      echo '<p>None</p>';\n     }\n-  }\n-\n-  if(!empty($assessment_respondents)){\n-    $rs_respondents = $DB->fetch($run_respondents);\n-    echo \"<h2>Number of Respondents per assessment ({$academic_year})</h2>\";\n-\n-    if ($rs_respondents) {\n-      echo \"<table class=\\\"grid\\\">\";\n \n-      $icounter=0;\n-      //loop round the initial array\n-      foreach($rs_respondents as $responses){\n-\n-        if($icounter == 0){\n-          $field_names = array_keys($responses);\n-          foreach($field_names as $row){\n-            echo\"<th>{$row}</th>\";\n-          }\n+    if (!empty($assessment_respondents)) {\n+        $runRespondentsResult = $runRespondentsStmt->execute();\n+\n+        $rs_respondents = $runRespondentsResult->fetchAllAssociative();\n+\n+        echo \"<h2>Number of Respondents per assessment ({$academic_year})</h2>\";\n+\n+        if ($rs_respondents) {\n+            echo '<table class=\"grid\">';\n+\n+            $icounter=0;\n+            //loop round the initial array\n+            foreach ($rs_respondents as $responses) {\n+                if ($icounter == 0) {\n+                    $field_names = array_keys($responses);\n+                    foreach ($field_names as $row) {\n+                        echo\"<th>{$row}</th>\";\n+                    }\n+                }\n+\n+                echo '<tr>';\n+                foreach ($responses as $row) {\n+                    echo \"<td>{$row}</td>\";\n+                }\n+                echo '</tr>';\n+                $icounter++;\n+            }\n+            echo '</table>';\n+        } else {\n+            echo '<p>None</p>';\n         }\n+    }\n \n-        echo \"<tr>\";\n-        foreach($responses as $row){\n-          echo \"<td>{$row}</td>\";\n+    if (!empty($assessment_modules)) {\n+        $runModulesPerAssessmentsResult = $runModulesPerAssessmentsStmt->execute();\n+\n+        $rs_runners = $runModulesPerAssessmentsResult->fetchAllAssociative();\n+\n+        echo \"<h2>Modules which have run an assessment ({$academic_year})</h2>\";\n+\n+        if ($rs_runners) {\n+            echo '<table class=\"grid\">';\n+\n+            $icounter = 0;\n+            //loop round the initial array\n+            foreach ($rs_runners as $runner) {\n+                if ($icounter==0) {\n+                    $field_names = array_keys($runner);\n+                    foreach ($field_names as $row) {\n+                        echo \"<th>{$row}</th>\";\n+                    }\n+                }\n+\n+                echo '<tr>';\n+                foreach ($runner as $row) {\n+                    echo \"<td>{$row}</td>\";\n+                }\n+                echo '</tr>';\n+                $icounter++;\n+            }\n+            echo '</table>';\n+        } else {\n+            echo '<p>None</p>';\n         }\n-        echo \"</tr>\";\n-        $icounter++;\n-      }\n-      echo \"</table>\";\n-    } else {\n-      echo '<p>None</p>';\n     }\n-  }\n \n-  if(!empty($assessment_modules)){\n-    $rs_runners = $DB->fetch($run_modules_per_assessments_SQL);\n-    echo \"<h2>Modules which have run an assessment ({$academic_year})</h2>\";\n+    if (!empty($assessment_students_thisyear)) {\n+        $runStudentsAssessedResult = $runStudentsAssessedStmt->execute();\n \n-    if ($rs_runners) {\n-      echo \"<table class=\\\"grid\\\">\";\n+        $rs_students = $runStudentsAssessedResult->fetchAllAssociative();\n \n-      $icounter = 0;\n-      //loop round the initial array\n-      foreach($rs_runners as $runner){\n+        echo \"<h2>Number of students who have carried out an assessment ({$academic_year})</h2>\";\n \n-        if($icounter==0){\n-          $field_names = array_keys($runner);\n-          foreach($field_names as $row){\n-            echo \"<th>{$row}</th>\";\n-          }\n-        }\n-\n-        echo \"<tr>\";\n-        foreach($runner as $row){\n-          echo \"<td>{$row}</td>\";\n-        }\n-        echo \"</tr>\";\n-        $icounter++;\n-      }\n-      echo \"</table>\";\n-    } else {\n-      echo '<p>None</p>';\n-    }\n-  }\n-\n-  if(!empty($assessment_students_thisyear)){\n-    $rs_students = $DB->fetch($run_students_assessed_SQL);\n-    echo \"<h2>Number of students who have carried out an assessment ({$academic_year})</h2>\";\n-\n-    if ($rs_students) {\n-      echo \"<table class=\\\"grid\\\">\";\n-      //loop round the initial array\n-      foreach($rs_students as $student){\n-        echo \"<tr>\";\n-        foreach($student as $row){\n-          echo \"<td>{$row}</td>\";\n+        if ($rs_students) {\n+            echo '<table class=\"grid\">';\n+            //loop round the initial array\n+            foreach ($rs_students as $student) {\n+                echo '<tr>';\n+                foreach ($student as $row) {\n+                    echo \"<td>{$row}</td>\";\n+                }\n+                echo '</tr>';\n+            }\n+            echo '</table>';\n+        } else {\n+            echo '<p>None</p>';\n         }\n-        echo \"</tr>\";\n-      }\n-      echo \"</table>\";\n-    } else {\n-      echo '<p>None</p>';\n     }\n-  }\n \n-  echo \"</div>\";\n-  $UI->content_end();\n+    echo '</div>';\n+    $UI->content_end();\n }\n \n //-------------------------------------------------------------------------------\n //output csv\n if ($format == 'csv') {\n-    header(\"Content-Disposition: attachment; filename=\\\"metrics.csv\\\"\");\n+    header('Content-Disposition: attachment; filename=\"metrics.csv\"');\n     header('Content-Type: text/csv');\n \n-    echo('\"WebPA - Metrics report\"'.\"\\n\");\n-\n-\n-  if (!empty($assessments_run)){\n-    $rs_assessments = $DB->fetch($run_assessments_SQL);\n-    echo \"\\n\\\"Assessments run in WebPA ({$academic_year})\\\"\\n\";\n-    if ($rs_assessments) {\n-      $icounter = 0;\n-      //loop round the initial array\n-      foreach ($rs_assessments as $assessment) {\n-        if ($icounter==0) {\n-          //get an array of the key to the $assessment array\n-          echo \"\\n\";\n-          $field_names = array_keys($assessment);\n-          foreach ($field_names as $row) {\n-            echo \"\\\"{$row}\\\",\";\n-          }\n-          echo \"\\n\";\n-        }\n-        foreach ($assessment as $row) {\n-          echo \"\\\"{$row}\\\",\";\n+    echo '\"WebPA - Metrics report\"'.\"\\n\";\n+\n+\n+    if (!empty($assessments_run)) {\n+        $runAssessmentsResult = $runAssessmentsStmt->execute();\n+\n+        $rs_assessments = $runAssessmentsResult->fetchAllAssociative();\n+\n+        echo \"\\n\\\"Assessments run in WebPA ({$academic_year})\\\"\\n\";\n+        if ($rs_assessments) {\n+            $icounter = 0;\n+            //loop round the initial array\n+            foreach ($rs_assessments as $assessment) {\n+                if ($icounter==0) {\n+                    //get an array of the key to the $assessment array\n+                    echo \"\\n\";\n+                    $field_names = array_keys($assessment);\n+                    foreach ($field_names as $row) {\n+                        echo \"\\\"{$row}\\\",\";\n+                    }\n+                    echo \"\\n\";\n+                }\n+                foreach ($assessment as $row) {\n+                    echo \"\\\"{$row}\\\",\";\n+                }\n+                echo \"\\n\";\n+                $icounter ++;\n+            }\n         }\n-        echo \"\\n\";\n-        $icounter ++;\n-      }\n     }\n \n-  }\n-\n-  if (!empty($assessment_groups)) {\n-    $rs_groups = $DB->fetch($run_groups_per_assessment_SQL);\n-    echo \"\\n\\\"Number of groups per assessment ({$academic_year})\\\"\\n\";\n-    if ($rs_groups) {\n-      $icounter = 0;\n-      //loop round the initial array\n-      foreach ($rs_groups as $groups) {\n-        if ($icounter==0) {\n-          echo \"\\n\";\n-          $field_names = array_keys($groups);\n-          foreach ($field_names as $row) {\n-            echo \"\\\"{$row}\\\",\";\n-          }\n-          echo \"\\n\";\n-        }\n-        foreach ($groups as $row) {\n-          echo \"\\\"{$row}\\\",\";\n+    if (!empty($assessment_groups)) {\n+        $runGroupsPerAssessmentResult = $runGroupsPerAssessmentStmt->execute();\n+\n+        $rs_groups = $runGroupsPerAssessmentResult->fetchAllAssociative();\n+\n+        echo \"\\n\\\"Number of groups per assessment ({$academic_year})\\\"\\n\";\n+        if ($rs_groups) {\n+            $icounter = 0;\n+            //loop round the initial array\n+            foreach ($rs_groups as $groups) {\n+                if ($icounter==0) {\n+                    echo \"\\n\";\n+                    $field_names = array_keys($groups);\n+                    foreach ($field_names as $row) {\n+                        echo \"\\\"{$row}\\\",\";\n+                    }\n+                    echo \"\\n\";\n+                }\n+                foreach ($groups as $row) {\n+                    echo \"\\\"{$row}\\\",\";\n+                }\n+                echo \"\\n\";\n+                $icounter ++;\n+            }\n         }\n-        echo \"\\n\";\n-        $icounter ++;\n-      }\n     }\n-  }\n-\n-  if (!empty($assessment_students)) {\n-    $rs_students = $DB->fetch($run_students_per_assessment_SQL);\n-    echo \"\\n\\\"Number of students per assessment ({$academic_year})\\\"\\n\";\n-    if ($rs_students) {\n-      $icounter = 0;\n-      //loop round the initial array\n-      foreach ($rs_students as $students) {\n-        if ($icounter==0) {\n-          echo \"\\n\";\n-          $field_names = array_keys($students);\n-          foreach ($field_names as $row) {\n-            echo \"\\\"{$row}\\\",\";\n-          }\n-          echo \"\\n\";\n-        }\n-        foreach ($students as $row) {\n-          echo \"\\\"{$row}\\\",\";\n+\n+    if (!empty($assessment_students)) {\n+        $runStudentsPerAssessmentResult = $runStudentsPerAssessmentStmt->execute();\n+\n+        $rs_students = $runStudentsPerAssessmentResult->fetchAllAssociative();\n+\n+        echo \"\\n\\\"Number of students per assessment ({$academic_year})\\\"\\n\";\n+        if ($rs_students) {\n+            $icounter = 0;\n+            //loop round the initial array\n+            foreach ($rs_students as $students) {\n+                if ($icounter==0) {\n+                    echo \"\\n\";\n+                    $field_names = array_keys($students);\n+                    foreach ($field_names as $row) {\n+                        echo \"\\\"{$row}\\\",\";\n+                    }\n+                    echo \"\\n\";\n+                }\n+                foreach ($students as $row) {\n+                    echo \"\\\"{$row}\\\",\";\n+                }\n+                echo \"\\n\";\n+                $icounter++;\n+            }\n         }\n-        echo \"\\n\";\n-        $icounter++;\n-      }\n     }\n-  }\n-\n-  if (!empty($assessment_feedback)) {\n-    $rs_feedback = $DB->fetch($run_feedback_SQL);\n-    echo \"\\n\\\"Assessments where feedback has been used ({$academic_year})\\\"\\n\";\n-    if ($rs_feedback) {\n-      $icounter = 0;\n-      //loop round the initial array\n-      foreach ($rs_feedback as $feedback) {\n-        if ($icounter==0) {\n-          echo \"\\n\";\n-          $field_names = array_keys($feedback);\n-          foreach ($field_names as $row) {\n-            echo\"\\\"{$row}\\\",\";\n-          }\n-          echo \"\\n\";\n-        }\n-        foreach ($feedback as $row) {\n-          echo \"\\\"{$row}\\\",\";\n+\n+    if (!empty($assessment_feedback)) {\n+        $runFeedbackResult = $runFeedbackStmt->execute;\n+\n+        $rs_feedback = $runFeedbackResult->fetchAllAssociative();\n+\n+        echo \"\\n\\\"Assessments where feedback has been used ({$academic_year})\\\"\\n\";\n+        if ($rs_feedback) {\n+            $icounter = 0;\n+            //loop round the initial array\n+            foreach ($rs_feedback as $feedback) {\n+                if ($icounter==0) {\n+                    echo \"\\n\";\n+                    $field_names = array_keys($feedback);\n+                    foreach ($field_names as $row) {\n+                        echo\"\\\"{$row}\\\",\";\n+                    }\n+                    echo \"\\n\";\n+                }\n+                foreach ($feedback as $row) {\n+                    echo \"\\\"{$row}\\\",\";\n+                }\n+                echo \"\\n\";\n+                $icounter++;\n+            }\n         }\n-        echo \"\\n\";\n-        $icounter++;\n-      }\n     }\n-  }\n-\n-  if (!empty($assessment_respondents)) {\n-    $rs_respondents = $DB->fetch($run_respondents);\n-    echo \"\\n\\\"Number of respondents per assessment ({$academic_year})\\\"\\n\";\n-    if ($rs_respondents) {\n-      $icounter=0;\n-      //loop round the initial array\n-      foreach ($rs_respondents as $responses) {\n-        if ($icounter == 0) {\n-          echo \"\\n\";\n-          $field_names = array_keys($responses);\n-          foreach ($field_names as $row) {\n-            echo\"\\\"{$row}\\\",\";\n-          }\n-          echo \"\\n\";\n-        }\n-        foreach ($responses as $row) {\n-          echo \"\\\"{$row}\\\",\";\n+\n+    if (!empty($assessment_respondents)) {\n+        $runRespondentsResult = $runRespondentsStmt->execute();\n+\n+        $rs_respondents = $runRespondentsResult->fetchAllAssociative();\n+\n+        echo \"\\n\\\"Number of respondents per assessment ({$academic_year})\\\"\\n\";\n+\n+        if ($rs_respondents) {\n+            $icounter=0;\n+            //loop round the initial array\n+            foreach ($rs_respondents as $responses) {\n+                if ($icounter == 0) {\n+                    echo \"\\n\";\n+                    $field_names = array_keys($responses);\n+                    foreach ($field_names as $row) {\n+                        echo\"\\\"{$row}\\\",\";\n+                    }\n+                    echo \"\\n\";\n+                }\n+                foreach ($responses as $row) {\n+                    echo \"\\\"{$row}\\\",\";\n+                }\n+                echo \"\\n\";\n+                $icounter++;\n+            }\n         }\n-        echo \"\\n\";\n-        $icounter++;\n-      }\n     }\n-  }\n-\n-  if (!empty($assessment_modules)) {\n-    $rs_runners = $DB->fetch($run_modules_per_assessments_SQL);\n-    echo \"\\n\\\"Modules which have run an assessment ({$academic_year})\\\"\\n\";\n-    if ($rs_runners) {\n-      $icounter = 0;\n-      //loop round the initial array\n-      foreach ($rs_runners as $runner) {\n-        if ($icounter==0) {\n-          echo \"\\n\";\n-          $field_names = array_keys($runner);\n-          foreach ($field_names as $row) {\n-            echo \"\\\"{$row}\\\",\";\n-          }\n-          echo \"\\n\";\n-        }\n-        foreach ($runner as $row) {\n-          echo \"\\\"{$row}\\\",\";\n+\n+    if (!empty($assessment_modules)) {\n+        $runModulesPerAssessmentsResult = $runModulesPerAssessmentsStmt->execute();\n+\n+        $rs_runners = $runModulesPerAssessmentsResult->fetchAllAssociative();\n+\n+        echo \"\\n\\\"Modules which have run an assessment ({$academic_year})\\\"\\n\";\n+\n+        if ($rs_runners) {\n+            $icounter = 0;\n+            //loop round the initial array\n+            foreach ($rs_runners as $runner) {\n+                if ($icounter==0) {\n+                    echo \"\\n\";\n+                    $field_names = array_keys($runner);\n+                    foreach ($field_names as $row) {\n+                        echo \"\\\"{$row}\\\",\";\n+                    }\n+                    echo \"\\n\";\n+                }\n+                foreach ($runner as $row) {\n+                    echo \"\\\"{$row}\\\",\";\n+                }\n+                echo \"\\n\";\n+                $icounter++;\n+            }\n         }\n-        echo \"\\n\";\n-        $icounter++;\n-      }\n     }\n-  }\n-\n-  if(!empty($assessment_students_thisyear)){\n-    $rs_students = $DB->fetch($run_students_assessed_SQL);\n-    echo \"\\n\\\"Number of students who have carried out an assessment ({$academic_year})\\\"\\n\";\n-    if ($rs_students) {\n-      //loop round the initial array\n-      echo \"\\n\";\n-      foreach ($rs_students as $student) {\n-        foreach ($student as $row) {\n-          echo\"\\\"{$row}\\\",\";\n+\n+    if (!empty($assessment_students_thisyear)) {\n+        $runStudentsAssessedResult = $runStudentsAssessedStmt->execute();\n+\n+        $rs_students = $runStudentsAssessedResult->fetchAllAssociative();\n+        echo \"\\n\\\"Number of students who have carried out an assessment ({$academic_year})\\\"\\n\";\n+        if ($rs_students) {\n+            //loop round the initial array\n+            echo \"\\n\";\n+            foreach ($rs_students as $student) {\n+                foreach ($student as $row) {\n+                    echo\"\\\"{$row}\\\",\";\n+                }\n+            }\n+            echo\"\\n\";\n         }\n-      }\n-      echo\"\\n\";\n     }\n-  }\n }\n \n //------------------------------------------------------------------------------------\n //export as rtf\n-if ($format == 'rtf'){\n-  header(\"Content-Disposition: attachment;filename=student_grades.rtf\");\n-  header(\"Content-Type: text/enriched\\n\");\n-\n-  echo('WebPA - Metrics report'.\"\\n\\n\");\n-\n-  if (!empty($assessments_run)){\n-    $rs_assessments = $DB->fetch($run_assessments_SQL);\n-    echo \"\\nAssessments run in WebPA ({$academic_year})\\n\\n\";\n-    $icounter = 0;\n-    //loop round the initial array\n-    foreach($rs_assessments as $assessment ){\n-      if($icounter==0){\n-        //get an array of the key to the $assessment array\n-        $field_names = array_keys($assessment);\n-        foreach($field_names as $row){\n-          echo \" {$row}  \";\n+if ($format == 'rtf') {\n+    header('Content-Disposition: attachment;filename=student_grades.rtf');\n+    header(\"Content-Type: text/enriched\\n\");\n+\n+    echo 'WebPA - Metrics report'.\"\\n\\n\";\n+\n+    if (!empty($assessments_run)) {\n+        $runAssessmentsResult = $runAssessmentsStmt->execute();\n+\n+        $rs_assessments = $runAssessmentsResult->fetchAllAssociative();\n+\n+        echo \"\\nAssessments run in WebPA ({$academic_year})\\n\\n\";\n+        $icounter = 0;\n+        //loop round the initial array\n+        foreach ($rs_assessments as $assessment) {\n+            if ($icounter==0) {\n+                //get an array of the key to the $assessment array\n+                $field_names = array_keys($assessment);\n+                foreach ($field_names as $row) {\n+                    echo \" {$row}  \";\n+                }\n+            }\n+            echo \"\\n\";\n+            foreach ($assessment as $row) {\n+                echo \" {$row}  \";\n+            }\n+            $icounter ++;\n         }\n-      }\n-      echo \"\\n\";\n-      foreach($assessment as $row){\n-        echo \" {$row}  \";\n-      }\n-      $icounter ++;\n     }\n \n-  }\n-\n-  if(!empty($assessment_groups)){\n-    $rs_groups = $DB->fetch($run_groups_per_assessment_SQL);\n-    echo \"\\nNumber of groups per assessment ({$academic_year})\\n\\n\";\n-    if ($rs_groups) {\n-      $icounter = 0;\n-      //loop round the initial array\n-      foreach($rs_groups as $groups){\n-        if($icounter==0){\n-          $field_names = array_keys($groups);\n-          foreach($field_names as $row){\n-            echo \" {$row}  \";\n-          }\n-        }\n-        echo \"\\n\";\n-        foreach($groups as $row){\n-          echo \" {$row}  \";\n+    if (!empty($assessment_groups)) {\n+        $runGroupsPerAssessmentResult = $runGroupsPerAssessmentStmt->execute();\n+\n+        $rs_groups = $runGroupsPerAssessmentResult->fetchAllAssociative();\n+\n+        echo \"\\nNumber of groups per assessment ({$academic_year})\\n\\n\";\n+\n+        if ($rs_groups) {\n+            $icounter = 0;\n+            //loop round the initial array\n+            foreach ($rs_groups as $groups) {\n+                if ($icounter==0) {\n+                    $field_names = array_keys($groups);\n+                    foreach ($field_names as $row) {\n+                        echo \" {$row}  \";\n+                    }\n+                }\n+                echo \"\\n\";\n+                foreach ($groups as $row) {\n+                    echo \" {$row}  \";\n+                }\n+                $icounter ++;\n+            }\n         }\n-        $icounter ++;\n-      }\n     }\n-  }\n-\n-  if(!empty($assessment_students)){\n-    $rs_students = $DB->fetch($run_students_per_assessment_SQL);\n-    echo \"\\nNumber of students per assessment ({$academic_year})\\n\\n\";\n-    if ($rs_students) {\n-      $icounter = 0;\n-      //loop round the initial array\n-      foreach($rs_students as $students){\n-        if($icounter==0){\n-          $field_names = array_keys($students);\n-          foreach($field_names as $row){\n-            echo \" {$row}  \";\n-          }\n-        }\n-        echo \"\\n\";\n-        foreach($students as $row){\n-          echo \" {$row}  \";\n+\n+    if (!empty($assessment_students)) {\n+        $runStudentsPerAssessmentResult = $runStudentsPerAssessmentStmt->execute();\n+\n+        $rs_students = $runStudentsPerAssessmentResult->fetchAllAssociative();\n+\n+        echo \"\\nNumber of students per assessment ({$academic_year})\\n\\n\";\n+        if ($rs_students) {\n+            $icounter = 0;\n+            //loop round the initial array\n+            foreach ($rs_students as $students) {\n+                if ($icounter==0) {\n+                    $field_names = array_keys($students);\n+                    foreach ($field_names as $row) {\n+                        echo \" {$row}  \";\n+                    }\n+                }\n+                echo \"\\n\";\n+                foreach ($students as $row) {\n+                    echo \" {$row}  \";\n+                }\n+                echo \"\\n\";\n+                $icounter++;\n+            }\n         }\n-        echo \"\\n\";\n-        $icounter++;\n-      }\n     }\n-  }\n-\n-  if(!empty($assessment_feedback)){\n-    $rs_feedback = $DB->fetch($run_feedback_SQL);\n-    echo \"\\nAssessments where feedback has been used ({$academic_year})\\n\\n\";\n-    if ($rs_feedback) {\n-      $icounter = 0;\n-      //loop round the initial array\n-      foreach($rs_feedback as $feedback){\n-        if($icounter==0){\n-          $field_names = array_keys($feedback);\n-          foreach($field_names as $row){\n-            echo\"{$row}  \";\n-          }\n-        }\n-        echo \"\\n\";\n-        foreach($feedback as $row){\n-          echo \"{$row}  \";\n+\n+    if (!empty($assessment_feedback)) {\n+        $runFeedbackResult = $runFeedbackStmt->execute;\n+\n+        $rs_feedback = $runFeedbackResult->fetchAllAssociative();\n+\n+        echo \"\\nAssessments where feedback has been used ({$academic_year})\\n\\n\";\n+        if ($rs_feedback) {\n+            $icounter = 0;\n+            //loop round the initial array\n+            foreach ($rs_feedback as $feedback) {\n+                if ($icounter==0) {\n+                    $field_names = array_keys($feedback);\n+                    foreach ($field_names as $row) {\n+                        echo\"{$row}  \";\n+                    }\n+                }\n+                echo \"\\n\";\n+                foreach ($feedback as $row) {\n+                    echo \"{$row}  \";\n+                }\n+                echo \"\\n\";\n+                $icounter++;\n+            }\n         }\n-        echo \"\\n\";\n-        $icounter++;\n-      }\n     }\n-  }\n-\n-  if(!empty($assessment_respondents)){\n-    $rs_respondents = $DB->fetch($run_respondents);\n-    echo \"\\nNumber of Respondents per assessment ({$academic_year})\\n\\n\";\n-    if ($rs_respondents) {\n-      $icounter=0;\n-      //loop round the initial array\n-      foreach($rs_respondents as $responses){\n-        if($icounter == 0){\n-          $field_names = array_keys($responses);\n-          foreach($field_names as $row){\n-            echo\"{$row}  \";\n-          }\n-        }\n-        echo \"\\n\";\n-        foreach($responses as $row){\n-          echo \"{$row}  \";\n+\n+    if (!empty($assessment_respondents)) {\n+        $runRespondentsResult = $runRespondentsStmt->execute();\n+\n+        $rs_respondents = $runRespondentsResult->fetchAllAssociative();\n+\n+        echo \"\\nNumber of Respondents per assessment ({$academic_year})\\n\\n\";\n+\n+        if ($rs_respondents) {\n+            $icounter=0;\n+            //loop round the initial array\n+            foreach ($rs_respondents as $responses) {\n+                if ($icounter == 0) {\n+                    $field_names = array_keys($responses);\n+                    foreach ($field_names as $row) {\n+                        echo\"{$row}  \";\n+                    }\n+                }\n+                echo \"\\n\";\n+                foreach ($responses as $row) {\n+                    echo \"{$row}  \";\n+                }\n+                echo \"\\n\";\n+                $icounter++;\n+            }\n         }\n-        echo \"\\n\";\n-        $icounter++;\n-      }\n     }\n-  }\n-\n-  if(!empty($assessment_modules)){\n-    $rs_runners = $DB->fetch($run_modules_per_assessments_SQL);\n-    echo \"\\nModules which have run an assessment ({$academic_year})\\n\\n\";\n-    if ($rs_runners) {\n-      $icounter = 0;\n-      //loop round the initial array\n-      foreach($rs_runners as $runner){\n-        if($icounter==0){\n-          $field_names = array_keys($runner);\n-          foreach($field_names as $row){\n-            echo \"{$row}  \";\n-          }\n-        }\n-        echo \"\\n\";\n-        foreach($runner as $row){\n-          echo \"{$row}  \";\n+\n+    if (!empty($assessment_modules)) {\n+        $runModulesPerAssessmentsResult = $runModulesPerAssessmentsStmt->execute();\n+\n+        $rs_runners = $runModulesPerAssessmentsResult->fetchAllAssociative();\n+\n+        echo \"\\nModules which have run an assessment ({$academic_year})\\n\\n\";\n+\n+        if ($rs_runners) {\n+            $icounter = 0;\n+            //loop round the initial array\n+            foreach ($rs_runners as $runner) {\n+                if ($icounter==0) {\n+                    $field_names = array_keys($runner);\n+                    foreach ($field_names as $row) {\n+                        echo \"{$row}  \";\n+                    }\n+                }\n+                echo \"\\n\";\n+                foreach ($runner as $row) {\n+                    echo \"{$row}  \";\n+                }\n+                echo \"\\n\";\n+                $icounter++;\n+            }\n         }\n-        echo \"\\n\";\n-        $icounter++;\n-      }\n     }\n-  }\n-\n-  if(!empty($assessment_students_thisyear)){\n-    $rs_students = $DB->fetch($run_students_assessed_SQL);\n-    echo \"\\nNumber of students who have carried out an assessment ({$academic_year})\\n\\n\";\n-    if ($rs_students) {\n-      //loop round the initial array\n-      foreach($rs_students as $student){\n-        foreach($student as $row){\n-          echo\"{$row}  \";\n+\n+    if (!empty($assessment_students_thisyear)) {\n+        $runStudentsAssessedResult = $runStudentsAssessedStmt->execute();\n+\n+        $rs_students = $runStudentsAssessedResult->fetchAllAssociative();\n+\n+        echo \"\\nNumber of students who have carried out an assessment ({$academic_year})\\n\\n\";\n+        if ($rs_students) {\n+            //loop round the initial array\n+            foreach ($rs_students as $student) {\n+                foreach ($student as $row) {\n+                    echo\"{$row}  \";\n+                }\n+            }\n+            echo\"\\n\";\n         }\n-      }\n-      echo\"\\n\";\n     }\n-  }\n }\n \n //------------------------------------------------------------------------------------\n //export as xml\n-if ($format == 'xml'){\n-  header(\"Content-Disposition: attachment; file=\\\"webpa_metrics.xml\\\"\");\n-  header('Content-Type: text/xml');\n-\n-  echo(\"<?xml version=\\\"1.0\\\" ?> \");\n-  echo\"<metrics_report>\";\n-\n-  if (!empty($assessments_run)){\n-    $rs_assessments = $DB->fetch($run_assessments_SQL);\n-    echo \"<metrics>\";\n-    echo \"<description>Assessments run in WebPA ({$academic_year})</description>\";\n-    if ($rs_assessments) {\n-      //loop round the initial array\n-      foreach($rs_assessments as $assessment ){\n-        //get an array of the key to the $assessment array\n-        $field_names = array_keys($assessment);\n-        $field_content = array_values($assessment);\n-\n-        //get the number of elements in the arrays\n-        $array_count = count($field_names);\n-        echo \"<metric>\";\n-        for ($count=0; $count<$array_count; $count++){\n-          echo \"<field_{$count}>{$field_names[$count]}</field_{$count}>\";\n-          echo \"<value_{$count}>{$field_content[$count]}</value_{$count}>\";\n-        }\n-        echo \"</metric>\";\n-      }\n+if ($format == 'xml') {\n+    header('Content-Disposition: attachment; file=\"webpa_metrics.xml\"');\n+    header('Content-Type: text/xml');\n+\n+    echo '<?xml version=\"1.0\" ?> ';\n+    echo'<metrics_report>';\n+\n+    if (!empty($assessments_run)) {\n+        $runAssessmentsResult = $runAssessmentsStmt->execute();\n+\n+        $rs_assessments = $runAssessmentsResult->fetchAllAssociative();\n+\n+        echo '<metrics>';\n+        echo \"<description>Assessments run in WebPA ({$academic_year})</description>\";\n+        if ($rs_assessments) {\n+            //loop round the initial array\n+            foreach ($rs_assessments as $assessment) {\n+                //get an array of the key to the $assessment array\n+                $field_names = array_keys($assessment);\n+                $field_content = array_values($assessment);\n+\n+                //get the number of elements in the arrays\n+                $array_count = count($field_names);\n+                echo '<metric>';\n+                for ($count=0; $count<$array_count; $count++) {\n+                    echo \"<field_{$count}>{$field_names[$count]}</field_{$count}>\";\n+                    echo \"<value_{$count}>{$field_content[$count]}</value_{$count}>\";\n+                }\n+                echo '</metric>';\n+            }\n+        }\n+        echo '</metrics>';\n     }\n-    echo \"</metrics>\";\n-\n-  }\n-\n-  if(!empty($assessment_groups)){\n-    $rs_groups = $DB->fetch($run_groups_per_assessment_SQL);\n-    echo \"<metrics>\";\n-    echo \"<description>Number of groups per assessment ({$academic_year})</description>\";\n-    if ($rs_groups) {\n-      foreach($rs_groups as $groups ){\n-        //get an array of the key to the $groups array\n-        $field_names = array_keys($groups);\n-        $field_content = array_values($groups);\n-\n-        //get the number of elements in the arrays\n-        $array_count = count($field_names);\n-        echo \"<metric>\";\n-        for ($count=0; $count<$array_count; $count++){\n-          echo \"<field_{$count}>{$field_names[$count]}</field_{$count}>\";\n-          echo \"<value_{$count}>{$field_content[$count]}</value_{$count}>\";\n-        }\n-        echo \"</metric>\";\n-      }\n+\n+    if (!empty($assessment_groups)) {\n+        $runGroupsPerAssessmentResult = $runGroupsPerAssessmentStmt->execute();\n+\n+        $rs_groups = $runGroupsPerAssessmentResult->fetchAllAssociative();\n+\n+        echo '<metrics>';\n+        echo \"<description>Number of groups per assessment ({$academic_year})</description>\";\n+        if ($rs_groups) {\n+            foreach ($rs_groups as $groups) {\n+                //get an array of the key to the $groups array\n+                $field_names = array_keys($groups);\n+                $field_content = array_values($groups);\n+\n+                //get the number of elements in the arrays\n+                $array_count = count($field_names);\n+                echo '<metric>';\n+                for ($count=0; $count<$array_count; $count++) {\n+                    echo \"<field_{$count}>{$field_names[$count]}</field_{$count}>\";\n+                    echo \"<value_{$count}>{$field_content[$count]}</value_{$count}>\";\n+                }\n+                echo '</metric>';\n+            }\n+        }\n+        echo '</metrics>';\n     }\n-    echo \"</metrics>\";\n-  }\n-\n-  if(!empty($assessment_students)){\n-    $rs_students = $DB->fetch($run_students_per_assessment_SQL);\n-    echo \"<metrics>\";\n-    echo \"<description>Number of students per assessment ({$academic_year})</description>\";\n-\n-    if ($rs_students) {\n-      //loop round the initial array\n-      foreach($rs_students as $students){\n-        //get an array of the key to the $students array\n-        $field_names = array_keys($students);\n-        $field_content = array_values($students);\n-\n-        //get the number of elements in the arrays\n-        $array_count = count($field_names);\n-        echo \"<metric>\";\n-        for ($count=0; $count<$array_count; $count++){\n-          echo \"<field_{$count}>{$field_names[$count]}</field_{$count}>\";\n-          echo \"<value_{$count}>{$field_content[$count]}</value_{$count}>\";\n+\n+    if (!empty($assessment_students)) {\n+        $runStudentsPerAssessmentResult = $runStudentsPerAssessmentStmt->execute();\n+\n+        $rs_students = $runStudentsPerAssessmentResult->fetchAllAssociative();\n+\n+        echo '<metrics>';\n+        echo \"<description>Number of students per assessment ({$academic_year})</description>\";\n+\n+        if ($rs_students) {\n+            //loop round the initial array\n+            foreach ($rs_students as $students) {\n+                //get an array of the key to the $students array\n+                $field_names = array_keys($students);\n+                $field_content = array_values($students);\n+\n+                //get the number of elements in the arrays\n+                $array_count = count($field_names);\n+                echo '<metric>';\n+                for ($count=0; $count<$array_count; $count++) {\n+                    echo \"<field_{$count}>{$field_names[$count]}</field_{$count}>\";\n+                    echo \"<value_{$count}>{$field_content[$count]}</value_{$count}>\";\n+                }\n+                echo '</metric>';\n+            }\n         }\n-        echo \"</metric>\";\n-      }\n+        echo '</metrics>';\n     }\n-    echo \"</metrics>\";\n-  }\n-\n-  if(!empty($assessment_feedback)){\n-    $rs_feedback = $DB->fetch($run_feedback_SQL);\n-    echo \"<metrics>\";\n-    echo \"<description>Assessments where feedback has been used ({$academic_year})</description>\";\n-    if ($rs_feedback) {\n-      //loop round the initial array\n-      foreach($rs_feedback as $feedback){\n-        //get an array of the key to the $feedback array\n-        $field_names = array_keys($feedback);\n-        $field_content = array_values($feedback);\n-\n-        //get the number of elements in the arrays\n-        $array_count = count($field_names);\n-        echo \"<metric>\";\n-        for ($count=0; $count<$array_count; $count++){\n-          echo \"<field_{$count}>{$field_names[$count]}</field_{$count}>\";\n-          echo \"<value_{$count}>{$field_content[$count]}</value_{$count}>\";\n-        }\n-        echo \"</metric>\";\n-      }\n+\n+    if (!empty($assessment_feedback)) {\n+        $runFeedbackResult = $runFeedbackStmt->execute;\n+\n+        $rs_feedback = $$runFeedbackResult->fetchAllAssociative();\n+\n+        echo '<metrics>';\n+        echo \"<description>Assessments where feedback has been used ({$academic_year})</description>\";\n+        if ($rs_feedback) {\n+            //loop round the initial array\n+            foreach ($rs_feedback as $feedback) {\n+                //get an array of the key to the $feedback array\n+                $field_names = array_keys($feedback);\n+                $field_content = array_values($feedback);\n+\n+                //get the number of elements in the arrays\n+                $array_count = count($field_names);\n+                echo '<metric>';\n+                for ($count=0; $count<$array_count; $count++) {\n+                    echo \"<field_{$count}>{$field_names[$count]}</field_{$count}>\";\n+                    echo \"<value_{$count}>{$field_content[$count]}</value_{$count}>\";\n+                }\n+                echo '</metric>';\n+            }\n+        }\n+        echo '</metrics>';\n     }\n-    echo \"</metrics>\";\n-  }\n-\n-  if(!empty($assessment_respondents)){\n-    $rs_respondents = $DB->fetch($run_respondents);\n-    echo \"<metrics>\";\n-    echo \"<description>Number of Respondents per assessment ({$academic_year})</description>\";\n-    if ($rs_respondents) {\n-      //loop round the initial array\n-      foreach($rs_respondents as $responses){\n-        //get an array of the key to the $responses array\n-        $field_names = array_keys($responses);\n-        $field_content = array_values($responses);\n-\n-        //get the number of elements in the arrays\n-        $array_count = count($field_names);\n-        echo \"<metric>\";\n-        for ($count=0; $count<$array_count; $count++){\n-          echo \"<field_{$count}>{$field_names[$count]}</field_{$count}>\";\n-          echo \"<value_{$count}>{$field_content[$count]}</value_{$count}>\";\n+\n+    if (!empty($assessment_respondents)) {\n+        $runRespondentsResult = $runRespondentsStmt->execute();\n+\n+        $rs_respondents = $runRespondentsResult->fetchAllAssociative();\n+\n+        echo '<metrics>';\n+\n+        echo \"<description>Number of Respondents per assessment ({$academic_year})</description>\";\n+\n+        if ($rs_respondents) {\n+            //loop round the initial array\n+            foreach ($rs_respondents as $responses) {\n+                //get an array of the key to the $responses array\n+                $field_names = array_keys($responses);\n+                $field_content = array_values($responses);\n+\n+                //get the number of elements in the arrays\n+                $array_count = count($field_names);\n+                echo '<metric>';\n+                for ($count=0; $count<$array_count; $count++) {\n+                    echo \"<field_{$count}>{$field_names[$count]}</field_{$count}>\";\n+                    echo \"<value_{$count}>{$field_content[$count]}</value_{$count}>\";\n+                }\n+                echo '</metric>';\n+            }\n         }\n-        echo \"</metric>\";\n-      }\n+        echo '</metrics>';\n     }\n-    echo \"</metrics>\";\n-  }\n-\n-  if(!empty($assessment_modules)){\n-    $rs_runners = $DB->fetch($run_modules_per_assessments_SQL);\n-    echo \"<metrics>\";\n-    echo \"<description>Modules which have run an assessment ({$academic_year})</description>\";\n-    if ($rs_runners) {\n-      //loop round the initial array\n-      foreach($rs_runners as $runner){\n-        //get an array of the key to the $runner array\n-        $field_names = array_keys($runner);\n-        $field_content = array_values($runner);\n-\n-        //get the number of elements in the arrays\n-        $array_count = count($field_names);\n-        echo \"<metric>\";\n-        for ($count=0; $count<$array_count; $count++){\n-          echo \"<field_{$count}>{$field_names[$count]}</field_{$count}>\";\n-          echo \"<value_{$count}>{$field_content[$count]}</value_{$count}>\";\n+\n+    if (!empty($assessment_modules)) {\n+        $runModulesPerAssessmentsResult = $runModulesPerAssessmentsStmt->execute();\n+\n+        $rs_runners = $runModulesPerAssessmentsResult->fetchAllAssociative();\n+\n+        echo '<metrics>';\n+        echo \"<description>Modules which have run an assessment ({$academic_year})</description>\";\n+\n+        if ($rs_runners) {\n+            //loop round the initial array\n+            foreach ($rs_runners as $runner) {\n+                //get an array of the key to the $runner array\n+                $field_names = array_keys($runner);\n+                $field_content = array_values($runner);\n+\n+                //get the number of elements in the arrays\n+                $array_count = count($field_names);\n+                echo '<metric>';\n+                for ($count=0; $count<$array_count; $count++) {\n+                    echo \"<field_{$count}>{$field_names[$count]}</field_{$count}>\";\n+                    echo \"<value_{$count}>{$field_content[$count]}</value_{$count}>\";\n+                }\n+                echo '</metric>';\n+            }\n         }\n-        echo \"</metric>\";\n-      }\n+        echo '</metrics>';\n     }\n-    echo \"</metrics>\";\n-  }\n-\n-  if(!empty($assessment_students_thisyear)){\n-    $rs_students = $DB->fetch($run_students_assessed_SQL);\n-    echo \"<metrics>\";\n-    echo \"<description>Number of students who have carried out an assessment ({$academic_year})</description>\";\n-    if ($rs_students) {\n-      //loop round the initial array\n-      foreach($rs_students as $student){\n-        //get an array of the key to the $student array\n-        $field_names = array_keys($student);\n-        $field_content = array_values($student);\n-\n-        //get the number of elements in the arrays\n-        $array_count = count($field_names);\n-        echo \"<metric>\";\n-        for ($count=0; $count<$array_count; $count++){\n-          echo \"<field_{$count}>{$field_names[$count]}</field_{$count}>\";\n-          echo \"<value_{$count}>{$field_content[$count]}</value_{$count}>\";\n-        }\n-        echo \"</metric>\";\n-      }\n+\n+    if (!empty($assessment_students_thisyear)) {\n+        $runStudentsAssessedResult = $runStudentsAssessedStmt->execute();\n+\n+        $rs_students = $runStudentsAssessedResult->fetchAllAssociative();\n+\n+        echo '<metrics>';\n+        echo \"<description>Number of students who have carried out an assessment ({$academic_year})</description>\";\n+        if ($rs_students) {\n+            //loop round the initial array\n+            foreach ($rs_students as $student) {\n+                //get an array of the key to the $student array\n+                $field_names = array_keys($student);\n+                $field_content = array_values($student);\n+\n+                //get the number of elements in the arrays\n+                $array_count = count($field_names);\n+                echo '<metric>';\n+                for ($count=0; $count<$array_count; $count++) {\n+                    echo \"<field_{$count}>{$field_names[$count]}</field_{$count}>\";\n+                    echo \"<value_{$count}>{$field_content[$count]}</value_{$count}>\";\n+                }\n+                echo '</metric>';\n+            }\n+        }\n+        echo '</metrics>';\n     }\n-    echo \"</metrics>\";\n-  }\n \n-  echo\"</metrics_report>\";\n+    echo'</metrics_report>';\n }\n-\n-?>"
        },
        {
          "filename": "src/admin/review/admin/index.php",
          "status": "modified",
          "additions": 5,
          "deletions": 5,
          "patch": "@@ -9,13 +9,13 @@\n  */\n \n //get the include file required\n-require_once(\"../../../includes/inc_global.php\");\n+require_once '../../../includes/inc_global.php';\n \n use WebPA\\includes\\functions\\Common;\n \n if (!Common::check_user($_user, APP__USER_TYPE_ADMIN)) {\n-  header('Location:'. APP__WWW .'/logout.php?msg=denied');\n-  exit;\n+    header('Location:'. APP__WWW .'/logout.php?msg=denied');\n+    exit;\n }\n \n $table = 'user';\n@@ -25,9 +25,9 @@\n \n \n //set the page information\n-$UI->page_title = APP__NAME . \" view administrator data\";\n+$UI->page_title = APP__NAME . ' view administrator data';\n $UI->menu_selected = 'view data';\n-$UI->breadcrumbs = array ('home' => '../../','review data'=>'../', 'administrator information'=>null,);\n+$UI->breadcrumbs = ['home' => '../../', 'review data'=>'../', 'administrator information'=>null];\n $UI->help_link = '?q=node/237';\n $UI->set_page_bar_button('View Student Data', '../../../../images/buttons/button_student_user.png', '../student/index.php');\n $UI->set_page_bar_button('View Staff Data', '../../../../images/buttons/button_staff_user.png', '../staff/index.php');"
        },
        {
          "filename": "src/admin/review/all.php",
          "status": "modified",
          "additions": 125,
          "deletions": 114,
          "patch": "@@ -11,134 +11,145 @@\n  * @link https://github.com/webpa/webpa\n  */\n \n+use Doctrine\\DBAL\\ParameterType;\n use WebPA\\includes\\functions\\Common;\n \n //build the string for the information to be collected from the database\n-if ($type == 'module') {\n-  if (Common::check_user($_user, APP__USER_TYPE_ADMIN)) {\n-    $query = 'SELECT module_id, module_code, module_title FROM '. APP__DB_TABLE_PREFIX . \"module WHERE source_id = '{$_source_id}'\";\n-  }\n-} else if ($type == APP__USER_TYPE_ADMIN) {\n-  if (Common::check_user($_user, APP__USER_TYPE_ADMIN)) {\n-    $query = 'SELECT u.user_id, u.source_id, u.username AS id, u.lastname, u.forename, u.email, u.id_number AS `id number`, u.date_last_login AS `last login` FROM ' .\n-             APP__DB_TABLE_PREFIX . 'user u ' .\n-             \"WHERE (u.admin = 1) \" .\n-             'ORDER BY u.lastname, u.forename, u.source_id, u.username';\n-  }\n-} else if (Common::check_user($_user, APP__USER_TYPE_TUTOR)) {\n-  $_module_id = Common::fetch_SESSION('_module_id', null);\n-  $query = 'SELECT u.user_id, u.source_id, u.username AS id, u.lastname, u.forename, u.email, u.id_number AS `id number`, u.date_last_login AS `last login` FROM ' .\n-           APP__DB_TABLE_PREFIX . 'user u INNER JOIN ' . APP__DB_TABLE_PREFIX . 'user_module um ON u.user_id = um.user_id ' .\n-           \"WHERE (um.module_id = {$_module_id}) AND (um.user_type = '{$type}') \" .  // AND (source_id = '{$_source_id}')\";\n-           'ORDER BY u.lastname, u.forename, u.source_id, u.username';\n-}\n-if (!isset($query)) {\n-  echo ' <p>You need to be logged into the system to see this information.</p>';\n-} else {\n-  //run the query\n-  $rs = $DB->fetch($query);\n-\n-  echo '<h2>' . $rstitle . '</h2>';\n-  echo '<div class=\"obj\">';\n-  echo '<table class=\"obj\" cellpadding=\"2\" cellspacing=\"2\">';\n+$dbConn = $DB->getConnection();\n \n-  //work through the recordset if it is not empty\n-  for ($recordcounter = 0; $recordcounter < count($rs); $recordcounter++) {\n+if ($type === 'module') {\n+    if (Common::check_user($_user, APP__USER_TYPE_ADMIN)) {\n+        $stmt = $dbConn->prepare('SELECT module_id, module_code, module_title FROM ' . APP__DB_TABLE_PREFIX . 'module WHERE source_id = ?');\n \n-    if ($recordcounter == 0) {\n-      //write the table field headers to the screen\n-      echo '<tr>';\n-      foreach ($rs[$recordcounter] as $field_name => $field_value){\n-        if ($field_name == 'source_id') {\n-        } else if (($field_name != 'user_id') && ($field_name != 'module_id')) {\n-          echo \"<th>{$field_name}</th>\";\n-        } else if (($type == 'module') || !$_source_id) {\n-          echo \"<th class=\\\"icon\\\">&nbsp;</th>\";\n-        }\n-      }\n-      echo \"</tr>\\n\";\n+        $stmt->bindParam(1, $_source_id);\n     }\n-    if (($type != 'module') && ($rs[$recordcounter]['source_id'] != $_user_source_id)) {\n-      $style = ' style=\"background-color: #c0c0c0;\"';\n-    } else {\n-      $style = '';\n+} elseif ($type == APP__USER_TYPE_ADMIN) {\n+    if (Common::check_user($_user, APP__USER_TYPE_ADMIN)) {\n+        $stmt = $dbConn->prepare('SELECT u.user_id, u.source_id, u.username AS id, u.lastname, u.forename, u.email, u.id_number AS `id number`, u.date_last_login AS `last login` FROM ' .\n+        APP__DB_TABLE_PREFIX . 'user u ' .\n+        'WHERE u.admin = 1 ' .\n+        'ORDER BY u.lastname, u.forename, u.source_id, u.username');\n     }\n-    echo \"<tr{$style}>\";\n-    $consumer_instance_guid = null;\n-    $uid = '';\n-    foreach ($rs[$recordcounter] as $field_name => $field_value){\n+} elseif (Common::check_user($_user, APP__USER_TYPE_TUTOR)) {\n+    $_module_id = Common::fetch_SESSION('_module_id', null);\n \n-      if (($field_name == 'id') && ($type != 'module')) {\n-        $field_value = \"<a href=\\\"../log.php?u={$uid}\\\" title=\\\"View activity log\\\">{$field_value}</a>\";\n-      }\n-      if ($field_name == 'source_id') {\n-        $source_id = $field_value;\n-      } else if ($field_name == 'user_id') {\n-        $uid = $field_value;\n-        if (!$_source_id) {\n-          echo '<td class=\"icon\">';\n-          echo '<a href=\"../../edit/index.php?u=' .$field_value . '&amp;t=' . $type . '\">';\n-          echo '<img src=\"../../../images/buttons/edit.gif\" width=\"16\" height=\"16\" alt=\"Edit user\" title=\"Edit user\" /></a>';\n-          if (APP__ENABLE_USER_DELETE) {\n-            if ($_SESSION['_user_id'] != $field_value) {\n-              echo '&nbsp;<a href=\"../../delete/index.php?u=' .$field_value . '\" onclick=\"return confirm(\\'Delete user; are you sure?\\');\">';\n-              echo '<img src=\"../../../images/buttons/cross.gif\" width=\"16\" height=\"16\" alt=\"Delete user\" title=\"Delete user\" /></a>';\n-            } else {\n-              echo '<img src=\"../../../images/buttons/blank.gif\" width=\"16\" height=\"16\" alt=\"\" />';\n+    $query =\n+      'SELECT u.user_id, u.source_id, u.username AS id, u.lastname, u.forename, u.email, u.id_number AS `id number`, u.date_last_login AS `last login` ' .\n+      'FROM ' . APP__DB_TABLE_PREFIX . 'user u ' .\n+      'INNER JOIN ' . APP__DB_TABLE_PREFIX . 'user_module um ' .\n+      'ON u.user_id = um.user_id ' .\n+      'WHERE um.module_id = ? AND um.user_type = ? ' .\n+      'ORDER BY u.lastname, u.forename, u.source_id, u.username';\n+\n+    $stmt = $dbConn->prepare($query);\n+\n+    $stmt->bindParam(1, $_module_id, ParameterType::INTEGER);\n+    $stmt->bindParam(2, $type);\n+}\n+if (!isset($stmt)) {\n+    echo ' <p>You need to be logged into the system to see this information.</p>';\n+} else {\n+    $rs = $stmt->execute()->fetchAllAssociative();\n+\n+    echo '<h2>' . $rstitle . '</h2>';\n+    echo '<div class=\"obj\">';\n+    echo '<table class=\"obj\" cellpadding=\"2\" cellspacing=\"2\">';\n+\n+    //work through the recordset if it is not empty\n+    for ($recordcounter = 0; $recordcounter < count($rs); $recordcounter++) {\n+        if ($recordcounter == 0) {\n+            //write the table field headers to the screen\n+            echo '<tr>';\n+            foreach ($rs[$recordcounter] as $field_name => $field_value) {\n+                if ($field_name == 'source_id') {\n+                } elseif (($field_name != 'user_id') && ($field_name != 'module_id')) {\n+                    echo \"<th>{$field_name}</th>\";\n+                } elseif (($type == 'module') || !$_source_id) {\n+                    echo '<th class=\"icon\">&nbsp;</th>';\n+                }\n             }\n-          }\n-          echo '</td>';\n-        }\n-      } else if ($field_name == 'module_id') {\n-        echo \"<td class=\\\"icon\\\">\";\n-        if (!$_source_id) {\n-          echo '<a href=\"../../edit/module.php?m=' .$field_value . '\">';\n-          echo '<img src=\"../../../images/buttons/edit.gif\" width=\"16\" height=\"16\" alt=\"Edit module\" title=\"Edit module\" /></a>';\n-        } else {\n-          echo '<img src=\"../../../images/buttons/blank.gif\" width=\"16\" height=\"16\" alt=\"\" />';\n+            echo \"</tr>\\n\";\n         }\n-        if (APP__ENABLE_MODULE_DELETE) {\n-          if ($_SESSION['_module_id'] != $field_value) {\n-            echo '<a href=\"../../delete/index.php?m=' .$field_value . '\" onclick=\"return confirm(\\'Delete module; are you sure?\\');\">';\n-            echo '<img src=\"../../../images/buttons/cross.gif\" width=\"16\" height=\"16\" alt=\"Delete module\" title=\"Delete module\" /></a>';\n-          } else {\n-            echo '<img src=\"../../../images/buttons/blank.gif\" width=\"16\" height=\"16\" alt=\"\" />';\n-          }\n+        if (($type != 'module') && ($rs[$recordcounter]['source_id'] != $_user_source_id)) {\n+            $style = ' style=\"background-color: #c0c0c0;\"';\n         } else {\n-          echo '<img src=\"../../../images/buttons/blank.gif\" width=\"16\" height=\"16\" alt=\"\" />';\n+            $style = '';\n         }\n-        echo '</td>';\n-      } else if ($field_name == 'enabled') {\n-        echo \"<td class=\\\"obj_info_text\\\">\";\n-        if ($field_value == 1) {\n-          echo 'Yes';\n-        } else {\n-          echo 'No';\n+        echo \"<tr{$style}>\";\n+        $consumer_instance_guid = null;\n+        $uid = '';\n+        foreach ($rs[$recordcounter] as $field_name => $field_value) {\n+            if (($field_name == 'id') && ($type != 'module')) {\n+                $field_value = \"<a href=\\\"../log.php?u={$uid}\\\" title=\\\"View activity log\\\">{$field_value}</a>\";\n+            }\n+            if ($field_name == 'source_id') {\n+                $source_id = $field_value;\n+            } elseif ($field_name == 'user_id') {\n+                $uid = $field_value;\n+                if (!$_source_id) {\n+                    echo '<td class=\"icon\">';\n+                    echo '<a href=\"../../edit/index.php?u=' .$field_value . '&amp;t=' . $type . '\">';\n+                    echo '<img src=\"../../../images/buttons/edit.gif\" width=\"16\" height=\"16\" alt=\"Edit user\" title=\"Edit user\" /></a>';\n+                    if (APP__ENABLE_USER_DELETE) {\n+                        if ($_SESSION['_user_id'] != $field_value) {\n+                            echo '&nbsp;<a href=\"../../delete/index.php?u=' .$field_value . '\" onclick=\"return confirm(\\'Delete user; are you sure?\\');\">';\n+                            echo '<img src=\"../../../images/buttons/cross.gif\" width=\"16\" height=\"16\" alt=\"Delete user\" title=\"Delete user\" /></a>';\n+                        } else {\n+                            echo '<img src=\"../../../images/buttons/blank.gif\" width=\"16\" height=\"16\" alt=\"\" />';\n+                        }\n+                    }\n+                    echo '</td>';\n+                }\n+            } elseif ($field_name == 'module_id') {\n+                echo '<td class=\"icon\">';\n+                if (!$_source_id) {\n+                    echo '<a href=\"../../edit/module.php?m=' .$field_value . '\">';\n+                    echo '<img src=\"../../../images/buttons/edit.gif\" width=\"16\" height=\"16\" alt=\"Edit module\" title=\"Edit module\" /></a>';\n+                } else {\n+                    echo '<img src=\"../../../images/buttons/blank.gif\" width=\"16\" height=\"16\" alt=\"\" />';\n+                }\n+                if (APP__ENABLE_MODULE_DELETE) {\n+                    if ($_SESSION['_module_id'] != $field_value) {\n+                        echo '<a href=\"../../delete/index.php?m=' .$field_value . '\" onclick=\"return confirm(\\'Delete module; are you sure?\\');\">';\n+                        echo '<img src=\"../../../images/buttons/cross.gif\" width=\"16\" height=\"16\" alt=\"Delete module\" title=\"Delete module\" /></a>';\n+                    } else {\n+                        echo '<img src=\"../../../images/buttons/blank.gif\" width=\"16\" height=\"16\" alt=\"\" />';\n+                    }\n+                } else {\n+                    echo '<img src=\"../../../images/buttons/blank.gif\" width=\"16\" height=\"16\" alt=\"\" />';\n+                }\n+                echo '</td>';\n+            } elseif ($field_name == 'enabled') {\n+                echo '<td class=\"obj_info_text\">';\n+                if ($field_value == 1) {\n+                    echo 'Yes';\n+                } else {\n+                    echo 'No';\n+                }\n+                echo '</td>';\n+            } elseif (strlen($field_value) <= 0) {\n+                echo '<td class=\"obj_info_text\">&nbsp;</td>';\n+            } elseif (($field_name == 'id') && $style) {\n+                echo \"<td class=\\\"obj_info_text\\\"><span title=\\\"{$source_id}\\\">{$field_value}</span></td>\";\n+            } elseif ($field_name == 'email') {\n+                echo \"<td class=\\\"obj_info_text\\\"><a href=\\\"mailto:'{$field_value}\\\">{$field_value}</a></td>\";\n+            } else {\n+                echo \"<td class=\\\"obj_info_text\\\">{$field_value}</td>\";\n+            }\n         }\n-        echo '</td>';\n-      } else if (strlen($field_value) <= 0) {\n-        echo \"<td class=\\\"obj_info_text\\\">&nbsp;</td>\";\n-      } else if (($field_name == 'id') && $style) {\n-        echo \"<td class=\\\"obj_info_text\\\"><span title=\\\"{$source_id}\\\">{$field_value}</span></td>\";\n-      } else if ($field_name == 'email') {\n-        echo \"<td class=\\\"obj_info_text\\\"><a href=\\\"mailto:'{$field_value}\\\">{$field_value}</a></td>\";\n-      } else {\n-        echo \"<td class=\\\"obj_info_text\\\">{$field_value}</td>\";\n-      }\n+        echo \"</tr>\\n\";\n+    }\n+    if (count($rs) <= 0) {\n+        echo \"<tr><td>No records</td></tr>\\n\";\n     }\n-    echo \"</tr>\\n\";\n-  }\n-  if (count($rs) <= 0) {\n-    echo \"<tr><td>No records</td></tr>\\n\";\n-  }\n \n-  echo '</table>';\n-  echo '</div>';\n-  if ($_source_id == '') {\n-    if ($type == 'module') {\n-      echo '<form action=\"../../edit/module.php?m=\" method=\"GET\"><p><input type=\"submit\" value=\"Create new module\" /></p></form>';\n-    } else {\n-      echo '<form action=\"../../edit/index.php\" method=\"GET\"><p><input type=\"hidden\" name=\"u\" value=\"\" /><input type=\"hidden\" name=\"t\" value=\"' . $type . '\" /><input type=\"submit\" value=\"Add new ' . $user_type . '\" /></p></form>';\n+    echo '</table>';\n+    echo '</div>';\n+    if ($_source_id == '') {\n+        if ($type == 'module') {\n+            echo '<form action=\"../../edit/module.php?m=\" method=\"GET\"><p><input type=\"submit\" value=\"Create new module\" /></p></form>';\n+        } else {\n+            echo '<form action=\"../../edit/index.php\" method=\"GET\"><p><input type=\"hidden\" name=\"u\" value=\"\" /><input type=\"hidden\" name=\"t\" value=\"' . $type . '\" /><input type=\"submit\" value=\"Add new ' . $user_type . '\" /></p></form>';\n+        }\n     }\n-  }\n }"
        },
        {
          "filename": "src/admin/review/index.php",
          "status": "modified",
          "additions": 15,
          "deletions": 15,
          "patch": "@@ -9,34 +9,34 @@\n  */\n \n //get the include file required\n-require_once(\"../../includes/inc_global.php\");\n+require_once '../../includes/inc_global.php';\n \n use WebPA\\includes\\functions\\Common;\n \n if (!Common::check_user($_user, APP__USER_TYPE_TUTOR)) {\n-  header('Location:'. APP__WWW .'/logout.php?msg=denied');\n-  exit;\n+    header('Location:'. APP__WWW .'/logout.php?msg=denied');\n+    exit;\n }\n \n-$filecontenttype = array();\n-$filecontenttype[] = array('link'=>'student','screen'=>'Student', 'def'=>'View the student data currently in the system',);\n-$filecontenttype[] = array('link'=>'staff','screen'=>'Staff', 'def'=>'View the staff data currently in the system',);\n+$filecontenttype = [];\n+$filecontenttype[] = ['link'=>'student', 'screen'=>'Student', 'def'=>'View the student data currently in the system'];\n+$filecontenttype[] = ['link'=>'staff', 'screen'=>'Staff', 'def'=>'View the staff data currently in the system'];\n if (Common::check_user($_user, APP__USER_TYPE_ADMIN)) {\n-  $filecontenttype[] = array('link'=>'admin','screen'=>'Administrators', 'def'=>'View the administrator data currently in the system',);\n-  $filecontenttype[] = array('link'=>'module','screen'=>'Module', 'def'=>'View the module information currently in the system',);\n+    $filecontenttype[] = ['link'=>'admin', 'screen'=>'Administrators', 'def'=>'View the administrator data currently in the system'];\n+    $filecontenttype[] = ['link'=>'module', 'screen'=>'Module', 'def'=>'View the module information currently in the system'];\n }\n-$filecontenttype[] = array('link'=>'../search', 'screen'=>'Search', 'def'=>'Search for a student or staff user of the system',);\n+$filecontenttype[] = ['link'=>'../search', 'screen'=>'Search', 'def'=>'Search for a student or staff user of the system'];\n \n //set the page information\n-$UI->page_title = APP__NAME . \" view data\";\n+$UI->page_title = APP__NAME . ' view data';\n $UI->menu_selected = 'view data';\n-$UI->breadcrumbs = array ('home' => null);\n+$UI->breadcrumbs = ['home' => null];\n $UI->help_link = '?q=node/237';\n $UI->set_page_bar_button('View Student Data', '../../../images/buttons/button_student_user.png', 'student/index.php');\n $UI->set_page_bar_button('View Staff Data', '../../../images/buttons/button_staff_user.png', 'staff/index.php');\n if (Common::check_user($_user, APP__USER_TYPE_ADMIN)) {\n-  $UI->set_page_bar_button('View Admin Data', '../../../images/buttons/button_admin_user.png', 'admin/index.php');\n-  $UI->set_page_bar_button('View Module Data', '../../../images/buttons/button_view_modules.png', 'module/index.php');\n+    $UI->set_page_bar_button('View Admin Data', '../../../images/buttons/button_admin_user.png', 'admin/index.php');\n+    $UI->set_page_bar_button('View Module Data', '../../../images/buttons/button_view_modules.png', 'module/index.php');\n }\n $UI->set_page_bar_button('Search for a user', '../../../images/buttons/button_search_user.png', '../search/index.php');\n $UI->head();\n@@ -47,8 +47,8 @@\n <div class=\"content_box\">\n <table class=\"option_list\" style=\"width: 500px;\">\n <?php\n-  for($checkbox = 0; $checkbox<= count($filecontenttype)-1; $checkbox++){\n-?>\n+  for ($checkbox = 0; $checkbox<= count($filecontenttype)-1; $checkbox++) {\n+      ?>\n <tr>\n   <td><a href=\"<?php echo $filecontenttype[$checkbox]['link']; ?>/index.php\"><img src=\"../../images/icons/form.gif\" width=\"32\" height=\"32\" alt=\"\" /></a></td><td>\n     <div class=\"option_list\"> <div class=\"option_list_title\"><a class=\"hidden\" href=\"<?php echo $filecontenttype[$checkbox]['link']; ?>/index.php\"><?php echo $filecontenttype[$checkbox]['screen']; ?></a></div>"
        },
        {
          "filename": "src/admin/review/log.php",
          "status": "modified",
          "additions": 35,
          "deletions": 27,
          "patch": "@@ -11,29 +11,30 @@\n  */\n \n //get the include file required\n-require_once(\"../../includes/inc_global.php\");\n+require_once '../../includes/inc_global.php';\n \n+use Doctrine\\DBAL\\ParameterType;\n use WebPA\\includes\\classes\\User;\n use WebPA\\includes\\functions\\Common;\n \n-if (!Common::check_user($_user, APP__USER_TYPE_TUTOR)){\n-  header('Location:'. APP__WWW .'/logout.php?msg=denied');\n-  exit;\n+if (!Common::check_user($_user, APP__USER_TYPE_TUTOR)) {\n+    header('Location:'. APP__WWW .'/logout.php?msg=denied');\n+    exit;\n }\n \n-$type = \"log\";\n-$rstitle = \"Log Data\";\n+$type = 'log';\n+$rstitle = 'Log Data';\n \n //set the page information\n-$UI->page_title = APP__NAME . \" view log data\";\n+$UI->page_title = APP__NAME . ' view log data';\n $UI->menu_selected = 'view data';\n-$UI->breadcrumbs = array ('home' => '../','review data'=>'./','log data'=>null);\n+$UI->breadcrumbs = ['home' => '../', 'review data'=>'./', 'log data'=>null];\n $UI->help_link = '?q=node/237';\n $UI->set_page_bar_button('View Student Data', '../../../images/buttons/button_student_user.png', 'student/index.php');\n $UI->set_page_bar_button('View Staff Data', '../../../images/buttons/button_staff_user.png', 'staff/index.php');\n if (Common::check_user($_user, APP__USER_TYPE_ADMIN)) {\n-  $UI->set_page_bar_button('View Admin Data', '../../../images/buttons/button_admin_user.png', 'admin/index.php');\n-  $UI->set_page_bar_button('View Module Data', '../../../images/buttons/button_view_modules.png', 'module/index.php');\n+    $UI->set_page_bar_button('View Admin Data', '../../../images/buttons/button_admin_user.png', 'admin/index.php');\n+    $UI->set_page_bar_button('View Module Data', '../../../images/buttons/button_view_modules.png', 'module/index.php');\n }\n $UI->set_page_bar_button('Search for a user', '../../../images/buttons/button_search_user.png', '../search/index.php');\n $UI->head();\n@@ -53,17 +54,25 @@\n $user->load_from_row($user_info);\n \n if ($_user->is_admin()) {\n-  $query = 'SELECT datetime, description, ip_address AS `ip address`, object_id AS object ';\n+    $query = 'SELECT datetime, description, ip_address AS `ip address`, object_id AS object ';\n } else {\n-  $query = 'SELECT datetime, description, object_id AS object ';\n+    $query = 'SELECT datetime, description, object_id AS object ';\n }\n \n $query .= 'FROM ' . APP__DB_TABLE_PREFIX . 'user_tracking ' .\n-          \"WHERE user_id = {$user_id} AND ((module_id = {$_module_id}) OR (module_id IS NULL)) \" .\n+          'WHERE user_id = ? AND ((module_id = ?) OR (module_id IS NULL)) ' .\n           'ORDER BY datetime DESC, description';\n \n-//run the query\n-$rs = $DB->fetch($query);\n+$dbConn = $DB->getConnection();\n+\n+$stmt = $dbConn->prepare($query);\n+\n+$stmt->bindValue(1, $user_id, ParameterType::INTEGER);\n+$stmt->bindValue(2, $_module_id, ParameterType::INTEGER);\n+\n+$results = $stmt->execute();\n+\n+$rs = $results->fetchAllAssociative();\n \n echo \"<h2>{$rstitle} for {$user->forename} {$user->lastname} ({$user->username})</h2>\";\n \n@@ -73,23 +82,22 @@\n \n //work through the recordset if it is not empty\n for ($recordcounter = 0; $recordcounter < count($rs); $recordcounter++) {\n-\n-  if ($recordcounter == 0) {\n-    //write the table field headers to the screen\n+    if ($recordcounter == 0) {\n+        //write the table field headers to the screen\n+        echo '<tr>';\n+        foreach ($rs[$recordcounter] as $field_name => $field_value) {\n+            echo \"<th>{$field_name}</th>\";\n+        }\n+        echo \"</tr>\\n\";\n+    }\n     echo '<tr>';\n-    foreach ($rs[$recordcounter] as $field_name => $field_value){\n-      echo \"<th>{$field_name}</th>\";\n+    foreach ($rs[$recordcounter] as $field_name => $field_value) {\n+        echo '<td class=\"obj_info_text\">'.$field_value.'</td>';\n     }\n     echo \"</tr>\\n\";\n-  }\n-  echo '<tr>';\n-  foreach ($rs[$recordcounter] as $field_name => $field_value){\n-    echo '<td class=\"obj_info_text\">'.$field_value.'</td>';\n-  }\n-  echo \"</tr>\\n\";\n }\n if (count($rs) <= 0) {\n-  echo \"<tr><td>No records</td></tr>\\n\";\n+    echo \"<tr><td>No records</td></tr>\\n\";\n }\n \n echo '</table>';"
        },
        {
          "filename": "src/admin/review/module/index.php",
          "status": "modified",
          "additions": 9,
          "deletions": 9,
          "patch": "@@ -12,23 +12,23 @@\n  */\n \n //get the include file required\n-require_once(\"../../../includes/inc_global.php\");\n+require_once '../../../includes/inc_global.php';\n \n use WebPA\\includes\\functions\\Common;\n \n-if (!Common::check_user($_user, APP__USER_TYPE_ADMIN)){\n-  header('Location:'. APP__WWW .'/logout.php?msg=denied');\n-  exit;\n+if (!Common::check_user($_user, APP__USER_TYPE_ADMIN)) {\n+    header('Location:'. APP__WWW .'/logout.php?msg=denied');\n+    exit;\n }\n \n-$table = \"module\";\n-$type = \"module\";\n-$rstitle = \"Module Data\";\n+$table = 'module';\n+$type = 'module';\n+$rstitle = 'Module Data';\n \n //set the page information\n-$UI->page_title = APP__NAME . \" view module data\";\n+$UI->page_title = APP__NAME . ' view module data';\n $UI->menu_selected = 'view data';\n-$UI->breadcrumbs = array ('home' => '../../','review data'=>'../', ' module information'=>null);\n+$UI->breadcrumbs = ['home' => '../../', 'review data'=>'../', ' module information'=>null];\n $UI->help_link = '?q=node/237';\n $UI->set_page_bar_button('View Student Data', '../../../../images/buttons/button_student_user.png', '../student/index.php');\n $UI->set_page_bar_button('View Staff Data', '../../../../images/buttons/button_staff_user.png', '../staff/index.php');"
        },
        {
          "filename": "src/admin/review/staff/index.php",
          "status": "modified",
          "additions": 7,
          "deletions": 7,
          "patch": "@@ -9,13 +9,13 @@\n  */\n \n //get the include file required\n-require_once(\"../../../includes/inc_global.php\");\n+require_once '../../../includes/inc_global.php';\n \n use WebPA\\includes\\functions\\Common;\n \n if (!Common::check_user($_user, APP__USER_TYPE_TUTOR)) {\n-  header('Location:'. APP__WWW .'/logout.php?msg=denied');\n-  exit;\n+    header('Location:'. APP__WWW .'/logout.php?msg=denied');\n+    exit;\n }\n \n $table = 'user';\n@@ -24,15 +24,15 @@\n $user_type = 'tutor';\n \n //set the page information\n-$UI->page_title = APP__NAME . \" view staff data\";\n+$UI->page_title = APP__NAME . ' view staff data';\n $UI->menu_selected = 'view data';\n-$UI->breadcrumbs = array ('home' => '../../','review data'=>'../', 'staff information'=>null,);\n+$UI->breadcrumbs = ['home' => '../../', 'review data'=>'../', 'staff information'=>null];\n $UI->help_link = '?q=node/237';\n $UI->set_page_bar_button('View Student Data', '../../../../images/buttons/button_student_user.png', '../student/index.php');\n $UI->set_page_bar_button('View Staff Data', '../../../../images/buttons/button_staff_user.png', '../staff/index.php');\n if (Common::check_user($_user, APP__USER_TYPE_ADMIN)) {\n-  $UI->set_page_bar_button('View Admin Data', '../../../../images/buttons/button_admin_user.png', '../admin/index.php');\n-  $UI->set_page_bar_button('View Module Data', '../../../../images/buttons/button_view_modules.png', '../module/index.php');\n+    $UI->set_page_bar_button('View Admin Data', '../../../../images/buttons/button_admin_user.png', '../admin/index.php');\n+    $UI->set_page_bar_button('View Module Data', '../../../../images/buttons/button_view_modules.png', '../module/index.php');\n }\n $UI->set_page_bar_button('Search for a user', '../../../../images/buttons/button_search_user.png', '../../search/index.php');\n $UI->head();"
        },
        {
          "filename": "src/admin/review/student/index.php",
          "status": "modified",
          "additions": 7,
          "deletions": 7,
          "patch": "@@ -9,13 +9,13 @@\n  */\n \n //get the include file required\n-require_once(\"../../../includes/inc_global.php\");\n+require_once '../../../includes/inc_global.php';\n \n use WebPA\\includes\\functions\\Common;\n \n if (!Common::check_user($_user, APP__USER_TYPE_TUTOR)) {\n-  header('Location:'. APP__WWW .'/logout.php?msg=denied');\n-  exit;\n+    header('Location:'. APP__WWW .'/logout.php?msg=denied');\n+    exit;\n }\n \n $table = 'user';\n@@ -24,15 +24,15 @@\n $user_type = 'student';\n \n //set the page information\n-$UI->page_title = APP__NAME . \" view student data\";\n+$UI->page_title = APP__NAME . ' view student data';\n $UI->menu_selected = 'view data';\n-$UI->breadcrumbs = array ('home' => '../../','review data'=>'../','student information'=>null,);\n+$UI->breadcrumbs = ['home' => '../../', 'review data'=>'../', 'student information'=>null];\n $UI->help_link = '?q=node/237';\n $UI->set_page_bar_button('View Student Data', '../../../../images/buttons/button_student_user.png', '../student/index.php');\n $UI->set_page_bar_button('View Staff Data', '../../../../images/buttons/button_staff_user.png', '../staff/index.php');\n if (Common::check_user($_user, APP__USER_TYPE_ADMIN)) {\n-  $UI->set_page_bar_button('View Admin Data', '../../../../images/buttons/button_admin_user.png', '../admin/index.php');\n-  $UI->set_page_bar_button('View Module Data', '../../../../images/buttons/button_view_modules.png', '../module/index.php');\n+    $UI->set_page_bar_button('View Admin Data', '../../../../images/buttons/button_admin_user.png', '../admin/index.php');\n+    $UI->set_page_bar_button('View Module Data', '../../../../images/buttons/button_view_modules.png', '../module/index.php');\n }\n $UI->set_page_bar_button('Search for a user', '../../../../images/buttons/button_search_user.png', '../../search/index.php');\n $UI->head();"
        },
        {
          "filename": "src/admin/search/index.php",
          "status": "modified",
          "additions": 143,
          "deletions": 105,
          "patch": "@@ -12,13 +12,13 @@\n  */\n \n //get the include file required\n-require_once(\"../../includes/inc_global.php\");\n+require_once '../../includes/inc_global.php';\n \n use WebPA\\includes\\functions\\Common;\n \n-if (!Common::check_user($_user, APP__USER_TYPE_TUTOR)){\n-  header('Location:'. APP__WWW .'/logout.php?msg=denied');\n-  exit;\n+if (!Common::check_user($_user, APP__USER_TYPE_TUTOR)) {\n+    header('Location:'. APP__WWW .'/logout.php?msg=denied');\n+    exit;\n }\n \n //-------------------------------------------------------------------------\n@@ -30,57 +30,96 @@\n $post_id_number = Common::fetch_GET('id_number');\n $post_search = Common::fetch_GET('search');\n \n-$where = '';\n-$order = '';\n+$whereClauseSet = false;\n $sMessage = '';\n \n+$dbConn = $DB->getConnection();\n+\n+// set up the query builder\n+$queryBuilder = $dbConn->createQueryBuilder();\n+\n+// write the base query\n+$queryBuilder->select(\n+    'u.user_id',\n+    'u.username AS id',\n+    'u.lastname',\n+    'u.forename',\n+    'u.email',\n+    'u.id_number AS id_number',\n+    'u.date_last_login AS last_login',\n+    'CASE u.admin WHEN 0 THEN COUNT(um.module_id) ELSE NULL END as modules'\n+)\n+        ->from(APP__DB_TABLE_PREFIX . 'user', 'u')\n+        ->leftJoin('u', APP__DB_TABLE_PREFIX . 'user_module', 'um', 'u.user_id = um.user_id')\n+        ->where('u.source_id = :source_id')\n+        ->setParameter('source_id', $_source_id);\n+\n if (!empty($post_search)) {\n-  //build the search string dependant on the data entered\n-  if (!empty($post_lastname)) {\n-    $where .= \" AND (u.lastname LIKE '{$post_lastname}%')\";\n-    $order .= ', u.lastname';\n-  }\n-  if (!empty($post_firstname)) {\n-    $where .= \" AND (u.forename LIKE '{$post_firstname}%')\";\n-    $order .= ', u.forename';\n-  }\n-  if (!empty($post_username)) {\n-    $where .= \" AND (u.username LIKE '{$post_username}%')\";\n-    $order .= ', u.username';\n-  }\n-  if (!empty($post_id_number)) {\n-    $where .= \" AND (u.id_number LIKE '{$post_id_number}%')\";\n-    $order .= ', u.id_number';\n-  }\n-  if (!empty($where)) {\n-    if (!Common::check_user($_user, APP__USER_TYPE_ADMIN)) {\n-      $where .= ' AND (u.admin = 0)';\n+    //build the search string dependant on the data entered\n+    if (!empty($post_lastname)) {\n+        $queryBuilder->andWhere($queryBuilder->expr()->like('u.lastname', ':last_name'));\n+        $queryBuilder->addOrderBy('u.lastname');\n+        $queryBuilder->setParameter('last_name', $post_lastname . '%');\n+\n+        $whereClauseSet = true;\n+    }\n+\n+    if (!empty($post_firstname)) {\n+        $queryBuilder->andWhere($queryBuilder->expr()->like('u.forename', ':forename'));\n+        $queryBuilder->addOrderBy('u.forename');\n+        $queryBuilder->setParameter('forename', $post_firstname . '%');\n+\n+        $whereClauseSet = true;\n+    }\n+\n+    if (!empty($post_username)) {\n+        $queryBuilder->andWhere($queryBuilder->expr()->like('u.username', ':username'));\n+        $queryBuilder->addOrderBy('u.username');\n+        $queryBuilder->setParameter('username', $post_username . '%');\n+\n+        $whereClauseSet = true;\n+    }\n+\n+    if (!empty($post_id_number)) {\n+        $queryBuilder->andWhere($queryBuilder->expr()->like('u.id_number', ':id_number'));\n+        $queryBuilder->addOrderBy('u.id_number');\n+        $queryBuilder->setParameter('id_number', $post_id_number . '%');\n+\n+        $whereClauseSet = true;\n+    }\n+\n+    if ($whereClauseSet === true) {\n+        if (!Common::check_user($_user, APP__USER_TYPE_ADMIN)) {\n+            $queryBuilder->andWhere('u.admin = 0');\n+        }\n+\n+        // add the groupBy clause\n+        $queryBuilder->groupBy('u.user_id');\n+        $queryBuilder->addGroupBy('u.username');\n+        $queryBuilder->addGroupBy('u.lastname');\n+        $queryBuilder->addGroupBy('u.forename');\n+        $queryBuilder->addGroupBy('u.email');\n+        $queryBuilder->addGroupBy('u.id_number');\n+        $queryBuilder->addGroupBy('u.date_last_login');\n+\n+        $rs = $queryBuilder->execute()->fetchAllAssociative();\n+    } else {\n+        //nothing has been entered that can be searched for\n+        $sMessage = '<p>You have not entered any information for the search<br/>Please check and re-try.</p>';\n     }\n-    $order = substr($order, 2);\n-    $sQuery = 'SELECT u.user_id, u.username AS id, u.lastname, u.forename, u.email, u.id_number AS `id number`, ' .\n-       'u.date_last_login AS `last login`, CASE u.admin WHEN 0 THEN COUNT(um.module_id) ELSE NULL END AS modules ' .\n-       'FROM ' . APP__DB_TABLE_PREFIX . 'user u LEFT OUTER JOIN ' . APP__DB_TABLE_PREFIX . 'user_module um ON u.user_id = um.user_id ' .\n-       \"WHERE (u.source_id = '{$_source_id}'){$where} \" .\n-       'GROUP BY u.user_id, u.username, u.lastname, u.forename, u.email, u.id_number, u.date_last_login ' .\n-       \"ORDER BY {$order}\";\n-    $rs = $DB->fetch($sQuery);\n-  } else {\n-    //nothing has been entered that can be searched for\n-    $sMessage = \"<p>You have not entered any information for the search<br/>Please check and re-try.</p>\";\n-  }\n }\n \n //------------------------------------------------------------------------\n \n //set the page information\n-$UI->page_title = APP__NAME . \"  search for a user\";\n+$UI->page_title = APP__NAME . '  search for a user';\n $UI->menu_selected = 'view data';\n-$UI->breadcrumbs = array ('home' => '../review/', 'search'=>null,);\n+$UI->breadcrumbs = ['home' => '../review/', 'search'=>null];\n $UI->set_page_bar_button('View Student Data', '../../../images/buttons/button_student_user.png', '../review/student/index.php');\n $UI->set_page_bar_button('View Staff Data', '../../../images/buttons/button_staff_user.png', '../review/staff/index.php');\n if (Common::check_user($_user, APP__USER_TYPE_ADMIN)) {\n-  $UI->set_page_bar_button('View Admin Data', '../../../images/buttons/button_admin_user.png', '../review/admin/index.php');\n-  $UI->set_page_bar_button('View Module Data', '../../../images/buttons/button_view_modules.png', '../review/module/index.php');\n+    $UI->set_page_bar_button('View Admin Data', '../../../images/buttons/button_admin_user.png', '../review/admin/index.php');\n+    $UI->set_page_bar_button('View Module Data', '../../../images/buttons/button_view_modules.png', '../review/module/index.php');\n }\n $UI->set_page_bar_button('Search for a user', '../../../images/buttons/button_search_user.png', 'index.php');\n \n@@ -92,80 +131,79 @@\n \n $page_intro = '<p>Search the WebPA system for a user within the system</p>';\n $page_description = '<p>Enter the any combination of the information below for the individual that you would like to locate in the WebPA system. The person being searched for can be a student or staff member. When you are ready click the \"Search Button\".</p>';\n-$rstitle = \"Search results\";\n+$rstitle = 'Search results';\n ?>\n <?php echo $page_intro; ?>\n \n <div class=\"content_box\">\n <?php\n if (empty($sMessage)) {\n-  echo  '<h2>' . $rstitle . '</h2>';\n-\n-  if (!empty($rs)) {\n-    echo '<div class=\"obj\">';\n-    echo '<table class=\"obj\" cellpadding=\"2\" cellspacing=\"2\">';\n-    //work through the recordset if it is not empty\n-    $recordcounter = 0;\n-    while ($recordcounter<=count($rs)-1) {\n-\n-      if ($recordcounter == 0) {\n-        //write the table field headers to the screen\n-        echo '<tr>';\n-        foreach ($rs[$recordcounter] as $field_name => $field_value){\n-          if ($field_name == 'source_id') {\n-          } else if (($field_name != 'user_id') && ($field_name != 'module_id')) {\n-            echo \"<th>{$field_name}</th>\";\n-          } else if (!$_source_id) {\n-            echo \"<th class=\\\"icon\\\">&nbsp;</th>\";\n-          }\n+    echo  '<h2>' . $rstitle . '</h2>';\n+\n+    if (!empty($rs)) {\n+        echo '<div class=\"obj\">';\n+        echo '<table class=\"obj\" cellpadding=\"2\" cellspacing=\"2\">';\n+        //work through the recordset if it is not empty\n+        $recordcounter = 0;\n+        while ($recordcounter<=count($rs)-1) {\n+            if ($recordcounter == 0) {\n+                //write the table field headers to the screen\n+                echo '<tr>';\n+                foreach ($rs[$recordcounter] as $field_name => $field_value) {\n+                    if ($field_name == 'source_id') {\n+                    } elseif (($field_name != 'user_id') && ($field_name != 'module_id')) {\n+                        echo \"<th>{$field_name}</th>\";\n+                    } elseif (!$_source_id) {\n+                        echo '<th class=\"icon\">&nbsp;</th>';\n+                    }\n+                }\n+                echo \"</tr>\\n\";\n+            }\n+            echo '<tr>';\n+            foreach ($rs[$recordcounter] as $field_index => $field_name) {\n+                if ($field_index=='user_id') {\n+                    echo '<td class=\"icon\" width=\"16\">';\n+                    echo \"<a href='../edit/index.php?u=\" . $field_name . \"'>\";\n+                    echo '<img src=\"../../images/buttons/edit.gif\" width=\"16\" height=\"16\" alt=\"Edit user\" /></a>';\n+                    echo '</td>';\n+                } else {\n+                    echo '<td class=\"obj_info_text\">'.$field_name.'</td>';\n+                }\n+            }\n+            echo '</tr>';\n+            $recordcounter++;\n         }\n-        echo \"</tr>\\n\";\n-      }\n-      echo '<tr>';\n-      foreach ($rs[$recordcounter] as $field_index => $field_name){\n-        if ($field_index=='user_id') {\n-          echo '<td class=\"icon\" width=\"16\">';\n-          echo \"<a href='../edit/index.php?u=\" . $field_name . \"'>\";\n-          echo '<img src=\"../../images/buttons/edit.gif\" width=\"16\" height=\"16\" alt=\"Edit user\" /></a>';\n-          echo '</td>';\n-        } else {\n-          echo '<td class=\"obj_info_text\">'.$field_name.'</td>';\n+        echo '</table>';\n+        echo '</div>';\n+    } else {\n+        if (!empty($post_search)) {\n+            echo '<div class=\"warning_box\">The search has not found any matching information.</div>';\n         }\n-      }\n-      echo '</tr>';\n-      $recordcounter++;\n+        echo $page_description;\n+        echo '<form method=\"get\" name=\"search\" action=\"index.php\">' ;\n+        echo '<table class=\"option_list\" style=\"width: 500px;\">';\n+        echo  '<tr><td><label for=\"firstname\">First name</label></td><td><input type=\"text\" id=\"firstname\" name=\"firstname\" ></td></tr>';\n+        echo  '<tr><td><label for=\"lastname\">Last name</label></td><td><input type=\"text\" id=\"lastname\" name=\"lastname\"></td></tr>';\n+        echo  '<tr><td><label for=\"username\">Username</label></td><td><input type=\"text\" id=\"username\" name=\"username\"></td></tr>';\n+        echo  '<tr><td><label for=\"id_number\">ID number</label></td><td><input type=\"text\" id=\"id_number\" name=\"id_number\"></td></tr>';\n+        echo  '<tr><td><input type=\"hidden\" id=\"search\" name=\"search\" value=\"search\"></td><td><input type=\"Submit\" value=\"Search\" id=\"Search\"></td></tr>';\n+        echo '</table>';\n+        echo '</form>';\n     }\n-    echo '</table>';\n-    echo '</div>';\n-  } else {\n-    if (!empty($post_search)) {\n-      echo \"<div class=\\\"warning_box\\\">The search has not found any matching information.</div>\";\n+} else {\n+    if (!empty($sMessage)) {\n+        echo \"<div class=\\\"warning_box\\\">{$sMessage}</div>\";\n     }\n     echo $page_description;\n-    echo \"<form method=\\\"get\\\" name=\\\"search\\\" action=\\\"index.php\\\">\" ;\n-    echo \"<table class=\\\"option_list\\\" style=\\\"width: 500px;\\\">\";\n-    echo  \"<tr><td><label for=\\\"firstname\\\">First name</label></td><td><input type=\\\"text\\\" id=\\\"firstname\\\" name=\\\"firstname\\\" ></td></tr>\";\n-    echo  \"<tr><td><label for=\\\"lastname\\\">Last name</label></td><td><input type=\\\"text\\\" id=\\\"lastname\\\" name=\\\"lastname\\\"></td></tr>\";\n-    echo  \"<tr><td><label for=\\\"username\\\">Username</label></td><td><input type=\\\"text\\\" id=\\\"username\\\" name=\\\"username\\\"></td></tr>\";\n-    echo  \"<tr><td><label for=\\\"id_number\\\">ID number</label></td><td><input type=\\\"text\\\" id=\\\"id_number\\\" name=\\\"id_number\\\"></td></tr>\";\n-    echo  \"<tr><td><input type=\\\"hidden\\\" id=\\\"search\\\" name=\\\"search\\\" value=\\\"search\\\"></td><td><input type=\\\"Submit\\\" value=\\\"Search\\\" id=\\\"Search\\\"></td></tr>\";\n-    echo \"</table>\";\n-    echo \"</form>\";\n-  }\n-} else {\n-  if (!empty($sMessage)) {\n-    echo \"<div class=\\\"warning_box\\\">{$sMessage}</div>\";\n-  }\n-  echo $page_description;\n-  echo \"<form method=\\\"get\\\" name=\\\"search\\\" action=\\\"index.php\\\">\" ;\n-  echo \"<table class=\\\"option_list\\\" style=\\\"width: 500px;\\\">\";\n-  echo  \"<tr><td><label for=\\\"lastname\\\">Last name</label></td><td><input type=\\\"text\\\" id=\\\"lastname\\\" name=\\\"lastname\\\"></td></tr>\";\n-  echo  \"<tr><td><label for=\\\"name\\\">First name</label></td><td><input type=\\\"text\\\" id=\\\"name\\\" name=\\\"name\\\" ></td></tr>\";\n-  echo  \"<tr><td><label for=\\\"username\\\">Username</label></td><td><input type=\\\"text\\\" id=\\\"username\\\" name=\\\"username\\\"></td></tr>\";\n-  echo  \"<tr><td><label for=\\\"id_number\\\">ID number</label></td><td><input type=\\\"text\\\" id=\\\"id_number\\\" name=\\\"id_number\\\"></td></tr>\";\n-  echo  \"<tr><td><input type=\\\"hidden\\\" id=\\\"search\\\" name=\\\"search\\\" value=\\\"search\\\"></td><td><input type=\\\"Submit\\\" value=\\\"Search\\\" id=\\\"Search\\\"></td></tr>\";\n-  echo \"</table>\";\n-  echo \"</form>\";\n+    echo '<form method=\"get\" name=\"search\" action=\"index.php\">' ;\n+    echo '<table class=\"option_list\" style=\"width: 500px;\">';\n+    echo  '<tr><td><label for=\"lastname\">Last name</label></td><td><input type=\"text\" id=\"lastname\" name=\"lastname\"></td></tr>';\n+    echo  '<tr><td><label for=\"name\">First name</label></td><td><input type=\"text\" id=\"name\" name=\"name\" ></td></tr>';\n+    echo  '<tr><td><label for=\"username\">Username</label></td><td><input type=\"text\" id=\"username\" name=\"username\"></td></tr>';\n+    echo  '<tr><td><label for=\"id_number\">ID number</label></td><td><input type=\"text\" id=\"id_number\" name=\"id_number\"></td></tr>';\n+    echo  '<tr><td><input type=\"hidden\" id=\"search\" name=\"search\" value=\"search\"></td><td><input type=\"Submit\" value=\"Search\" id=\"Search\"></td></tr>';\n+    echo '</table>';\n+    echo '</form>';\n }\n ?>\n </div>"
        },
        {
          "filename": "src/contact/contact_send.php",
          "status": "modified",
          "additions": 50,
          "deletions": 53,
          "patch": "@@ -8,7 +8,7 @@\n  * @link https://github.com/webpa/webpa\n  */\n \n-require_once(\"../includes/inc_global.php\");\n+require_once '../includes/inc_global.php';\n \n use WebPA\\includes\\classes\\Email;\n use WebPA\\includes\\functions\\Common;\n@@ -38,71 +38,68 @@\n \n $app_www = APP__WWW;\n \n-$errors = array();\n+$errors = [];\n \n if ($contact_fullname == '') {\n-\t$errors[] = 'Name is required';\n+    $errors[] = 'Name is required';\n }\n \n if ($contact_message == '') {\n-\t$errors[] = 'Message is required';\n+    $errors[] = 'Message is required';\n }\n \n if ($contact_email == '') {\n-\t$errors[] = 'Email is required';\n-\n+    $errors[] = 'Email is required';\n } elseif (!Form::is_email($contact_email)) {\n-\t$errors[] = 'Email is not valid';\n+    $errors[] = 'Email is not valid';\n }\n \n if (empty($errors)) {\n-\n-$email_body = <<<EndBody\n-Contact Sent\n-----------------------------------------\n-Application  : $contact_app_id ($app_www)\n-Contact Type : $contact_type\n-Date         : $contact_date\n-----------------------------------------\n-\n-Contact Details\n-----------------------------------------\n-Fullname : $contact_fullname\n-Username : $contact_username\n-Email    : $contact_email\n-Phone    : $contact_phone\n-----------------------------------------\n-\n-User Account Details\n-----------------------------------------\n-User ID  : $contact_user_id\n-Fullname : $contact_user_fullname\n-Username : $contact_user_username\n-Email    : $contact_user_email\n-----------------------------------------\n-\n-Message:\n-----------------------------------------\n-$contact_message\n-----------------------------------------\n-EndBody;\n-\n-// Send the email\n-$email = new Email();\n-$email->set_to($contact_to);\n-$email->set_from($contact_email);\n-$email->set_subject(\"$contact_app_id : $contact_type\");\n-$email->set_body($email_body);\n-$email->send();\n-\n+    $email_body = <<<EndBody\n+        Contact Sent\n+        ----------------------------------------\n+        Application  : $contact_app_id ($app_www)\n+        Contact Type : $contact_type\n+        Date         : $contact_date\n+        ----------------------------------------\n+\n+        Contact Details\n+        ----------------------------------------\n+        Fullname : $contact_fullname\n+        Username : $contact_username\n+        Email    : $contact_email\n+        Phone    : $contact_phone\n+        ----------------------------------------\n+\n+        User Account Details\n+        ----------------------------------------\n+        User ID  : $contact_user_id\n+        Fullname : $contact_user_fullname\n+        Username : $contact_user_username\n+        Email    : $contact_user_email\n+        ----------------------------------------\n+\n+        Message:\n+        ----------------------------------------\n+        $contact_message\n+        ----------------------------------------\n+        EndBody;\n+\n+    // Send the email\n+    $email = new Email();\n+    $email->set_to($contact_to);\n+    $email->set_from($contact_email);\n+    $email->set_subject(\"$contact_app_id : $contact_type\");\n+    $email->set_body($email_body);\n+    $email->send();\n }\n \n // Begin Page\n \n $UI->page_title = APP__NAME . ' Message Sent';\n $UI->menu_selected = 'contact';\n-$UI->breadcrumbs = array  ('home'   => '/' ,\n-              'contact' => null ,);\n+$UI->breadcrumbs = ['home'   => '/',\n+              'contact' => null, ];\n \n $UI->head();\n $UI->body();\n@@ -111,20 +108,20 @@\n ?>\n \n   <div class=\"content_box\">\n-    <?php if (empty($errors)) : ?>\n+    <?php if (empty($errors)) { ?>\n     <p>Your message has now been sent.</p>\n     <p>We will try and respond as soon as possible, but at times our team can be very busy. We apologise in advance for any delay in getting back to you.</p>\n     <p>Thanks for your time</p>\n-    <?php else : ?>\n+    <?php } else { ?>\n     \t<p>Please correct the following errors:</p>\n     \t<ul>\n-    \t<?php foreach ($errors as $error) : ?>\n+    \t<?php foreach ($errors as $error) { ?>\n     \t\t<li><?php echo $error?></li>\n-    \t<?php endforeach; ?>\n+    \t<?php } ?>\n     \t</ul>\n     \t<br>\n     \t<button onclick=\"javascript:window.history.back();\">Fix Errors</button>\n-    <?php endif; ?>\n+    <?php } ?>\n   </div>\n <?php\n "
        },
        {
          "filename": "src/contact/index.php",
          "status": "modified",
          "additions": 15,
          "deletions": 15,
          "patch": "@@ -10,7 +10,7 @@\n  * @link https://github.com/webpa/webpa\n  */\n \n-require_once(\"../includes/inc_global.php\");\n+require_once '../includes/inc_global.php';\n \n use WebPA\\includes\\functions\\Common;\n use WebPA\\includes\\functions\\Form;\n@@ -26,8 +26,8 @@\n $UI->page_title = APP__NAME . ' Contact';\n $UI->menu_selected = 'contact';\n $UI->help_link = '?q=node/379#intool';\n-$UI->breadcrumbs = array\t('home'\t\t=> '../' ,\n-\t\t\t\t\t\t\t 'contact'\t=> null ,);\n+$UI->breadcrumbs = ['home'\t\t=> '../',\n+                             'contact'\t=> null, ];\n \n \n $UI->head();\n@@ -53,21 +53,21 @@ function do_send() {\n \t\t<p>Please supply as much information with your message as possible (especially when sending a bug report!), this will allow us to respond to your message much faster!</p>\n \n \t\t<form action=\"contact_send.php\" method=\"post\" name=\"contact_form\">\n-\t\t<input type=\"hidden\" name=\"contact_app\" value=\"<?php echo($_config['app_id']); ?>\" />\n+\t\t<input type=\"hidden\" name=\"contact_app\" value=\"<?php echo $_config['app_id']; ?>\" />\n \n \t\t<div class=\"form_section\">\n \t\t\t<table class=\"form\" cellpadding=\"2\" cellspacing=\"2\">\n \t\t\t<tr>\n \t\t\t\t<td><label for=\"contact_name\">Your Name</label></td>\n-\t\t\t\t<td><input type=\"text\" name=\"contact_name\" id=\"contact_name\" maxlength=\"60\" size=\"50\" value=\"<?php echo(\"{$_user->forename} {$_user->lastname}\"); ?>\" /></td>\n+\t\t\t\t<td><input type=\"text\" name=\"contact_name\" id=\"contact_name\" maxlength=\"60\" size=\"50\" value=\"<?php echo \"{$_user->forename} {$_user->lastname}\"; ?>\" /></td>\n \t\t\t</tr>\n \t\t\t<tr>\n \t\t\t\t<td><label for=\"contact_username\">Your Username</label></td>\n-\t\t\t\t<td><input type=\"text\" name=\"contact_username\" id=\"contact_username\" maxlength=\"15\" size=\"10\" value=\"<?php echo($_user->username); ?>\" /></td>\n+\t\t\t\t<td><input type=\"text\" name=\"contact_username\" id=\"contact_username\" maxlength=\"15\" size=\"10\" value=\"<?php echo $_user->username; ?>\" /></td>\n \t\t\t</tr>\n \t\t\t<tr>\n \t\t\t\t<td><label for=\"contact_email\">Your Email</label></td>\n-\t\t\t\t<td><input type=\"text\" name=\"contact_email\" id=\"contact_email\" maxlength=\"255\" size=\"50\" value=\"<?php echo($_user->email); ?>\" /></td>\n+\t\t\t\t<td><input type=\"text\" name=\"contact_email\" id=\"contact_email\" maxlength=\"255\" size=\"50\" value=\"<?php echo $_user->email; ?>\" /></td>\n \t\t\t</tr>\n \t\t\t<tr>\n \t\t\t\t<td><label for=\"contact_phone\">Your Phone Number</label></td>\n@@ -79,14 +79,14 @@ function do_send() {\n \t\t\t\t<td>\n \t\t\t\t\t<select name=\"contact_type\" id=\"contact_type\">\n \t\t\t\t\t\t<?php\n-\t\t\t\t\t\t\t$contact_types = array\t('help'\t\t=> 'Request for help!' ,\n-\t\t\t\t\t\t\t\t\t\t\t\t\t 'info'\t\t=> 'Information request' ,\n-\t\t\t\t\t\t\t\t\t\t\t\t\t 'bug'\t\t=> 'Bug / Error report' ,\n-\t\t\t\t\t\t\t\t\t\t\t\t\t 'wish'\t\t=> 'Suggestion / Wish List' ,\n-\t\t\t\t\t\t\t\t\t\t\t\t\t 'misc'\t\t=> 'Other type of message' ,);\n-\n-\t\t\t\t\t\t\tForm::render_options($contact_types, $contact_type);\n-\t\t\t\t\t\t?>\n+                            $contact_types = ['help'\t\t=> 'Request for help!',\n+                                                     'info'\t\t=> 'Information request',\n+                                                     'bug'\t\t=> 'Bug / Error report',\n+                                                     'wish'\t\t=> 'Suggestion / Wish List',\n+                                                     'misc'\t\t=> 'Other type of message', ];\n+\n+                            Form::render_options($contact_types, $contact_type);\n+                        ?>\n \t\t\t\t\t</select>\n \t\t\t\t</td>\n \t\t\t</tr>"
        },
        {
          "filename": "src/cookie.php",
          "status": "modified",
          "additions": 15,
          "deletions": 17,
          "patch": "@@ -8,30 +8,28 @@\n  * @link https://github.com/webpa/webpa\n  */\n \n-require_once('includes/inc_global.php');\n+require_once 'includes/inc_global.php';\n \n $url = '';\n if (isset($_GET['url'])) {\n-  $url = $_GET['url'];\n+    $url = $_GET['url'];\n }\n \n if ($_user) {\n-  $id = '';\n-  if (isset($_GET['id'])) {\n-    $id = $_GET['id'];\n-  }\n-  header('Location: ' . APP__WWW . '/index.php?id=' . $id);\n-} else if ($url) {\n-  if (strpos($url, '?') === FALSE) {\n-    $url .= '?';\n-  } else {\n-    $url .= '&';\n-  }\n-  header('Location: ' . $url . 'lti_errormsg=' . urlencode('Unable to connect to ' . APP__NAME . '; please ensure that your browser is not blocking third-party cookies'));\n+    $id = '';\n+    if (isset($_GET['id'])) {\n+        $id = $_GET['id'];\n+    }\n+    header('Location: ' . APP__WWW . '/index.php?id=' . $id);\n+} elseif ($url) {\n+    if (strpos($url, '?') === false) {\n+        $url .= '?';\n+    } else {\n+        $url .= '&';\n+    }\n+    header('Location: ' . $url . 'lti_errormsg=' . urlencode('Unable to connect to ' . APP__NAME . '; please ensure that your browser is not blocking third-party cookies'));\n } else {\n-  header('Location: ' . APP__WWW . '/login.php?msg=cookies');\n+    header('Location: ' . APP__WWW . '/login.php?msg=cookies');\n }\n \n exit;\n-\n-?>"
        },
        {
          "filename": "src/images/icon.png",
          "status": "added",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "src/includes/classes/AlgorithmFactory.php",
          "status": "modified",
          "additions": 29,
          "deletions": 29,
          "patch": "@@ -14,32 +14,33 @@\n \n use WebPA\\includes\\classes\\algorithms\\WebPAAlgorithm;\n \n-class AlgorithmFactory {\n-\n-/*\n-* ================================================================================\n-* Public Methods\n-* ================================================================================\n-*/\n-\n-  /**\n-   * Get an instance of the requested algorithm class.\n-   *\n-   * @param  string  $algorithm_name  The algorithm to create.\n-   *\n-   * @return  mixed  The algorithm object requested. On fail, null.\n-   */\n-  public static function get_algorithm($algorithm_name) {\n-    $algorithm = null;\n-\n-    switch($algorithm_name) {\n+class AlgorithmFactory\n+{\n+    /*\n+    * ================================================================================\n+    * Public Methods\n+    * ================================================================================\n+    */\n+\n+    /**\n+     * Get an instance of the requested algorithm class.\n+     *\n+     * @param  string  $algorithm_name  The algorithm to create.\n+     *\n+     * @return  mixed  The algorithm object requested. On fail, null.\n+     */\n+    public static function get_algorithm($algorithm_name)\n+    {\n+        $algorithm = null;\n+\n+        switch ($algorithm_name) {\n       case 'pets':\n-\t\t// @todo : There appear to be grading problems with the PETS algorithm in peer-only mode.\n-\t\t// Until we have conducted a full investigation and nailed down what's happening\n-\t\t// this algorithm is disabled.\n-\t\t//\n-\t\t//require_once(DOC__ROOT.'includes/classes/algorithms/class_pets_algorithm.php');\n-\t\t//$algorithm = new PETSAlgorithm();\n+        // @todo : There appear to be grading problems with the PETS algorithm in peer-only mode.\n+        // Until we have conducted a full investigation and nailed down what's happening\n+        // this algorithm is disabled.\n+        //\n+        //require_once(DOC__ROOT.'includes/classes/algorithms/class_pets_algorithm.php');\n+        //$algorithm = new PETSAlgorithm();\n         break;\n       case 'webpa':\n       default:\n@@ -48,9 +49,8 @@ public static function get_algorithm($algorithm_name) {\n         break;\n     }\n \n-    return $algorithm;\n-  }// /->get_algorithm()\n+        return $algorithm;\n+    }\n \n+    // /->get_algorithm()\n }// /class\n-\n-?>"
        },
        {
          "filename": "src/includes/classes/Assessment.php",
          "status": "modified",
          "additions": 551,
          "deletions": 370,
          "patch": "@@ -10,410 +10,591 @@\n \n namespace WebPA\\includes\\classes;\n \n+use Doctrine\\DBAL\\ParameterType;\n use WebPA\\includes\\functions\\Common;\n \n-class Assessment {\n+class Assessment\n+{\n+    // Public Vars\n+    public $id;\n \n-  // Public Vars\n-  public $id = null;\n-  public $name = '';\n-  public $module_id = null;\n+    public $name = '';\n \n-  public $open_date = null;\n-  public $close_date = null;\n-  public $introduction = '';\n+    public $module_id;\n \n-  public $allow_feedback = false;\n-  public $assessment_type = 1;\n-  public $allow_assessment_feedback = false;\n-  public $feedback_name = 'feedback';\n-  public $email_opening = false;\n-  public $email_closing = false;\n+    public $open_date;\n \n-  // Private Vars\n-  private $_DAO = null;\n-  private $_xml_parser = null;\n+    public $close_date;\n \n-  private $_collection = null;\n-  private $_collection_id = null;\n+    public $introduction = '';\n \n-  private $_form = null;\n-  private $_form_xml = '';\n+    public $allow_feedback = false;\n \n-  private $_finished = false;\n+    public $assessment_type = 1;\n \n-  private $_locked = null;\n+    public $allow_assessment_feedback = false;\n \n-  /**\n-  * CONSTRUCTOR for the assessment class\n-  *\n-  * @param string $DAO\n-  */\n-  function __construct(&$DAO) {\n-    $this->_DAO =& $DAO;\n-    $this->_locked = null;\n-  }// /->Assessment()\n+    public $feedback_name = 'feedback';\n \n-/**\n-* ================================================================================\n-* Public Methods\n-* ================================================================================\n-*/\n+    public $email_opening = false;\n \n-/**\n-* --------------------------------------------------------------------------------\n-* Load/Save Functions\n-* --------------------------------------------------------------------------------\n-*/\n-\n-  /**\n-  * Create a new Assessment ID\n-  */\n-  function create() {\n-    // generate a new project_id\n-    while (true) {\n-      $new_id = Common::uuid_create();\n-      if ($this->_DAO->fetch_value(\"SELECT COUNT(assessment_id) FROM \" . APP__DB_TABLE_PREFIX . \"assessment WHERE assessment_id = '$new_id'\") == 0) {\n-        break;\n-      }\n+    public $email_closing = false;\n+\n+    // Private Vars\n+    private DAO $_DAO;\n+\n+    private $dbConn;\n+\n+    private $_xml_parser;\n+\n+    private $_collection;\n+\n+    private $_collection_id;\n+\n+    private $_form;\n+\n+    private $_form_xml = '';\n+\n+    private $_finished = false;\n+\n+    private $_locked;\n+\n+    /**\n+    * CONSTRUCTOR for the assessment class\n+    *\n+    * @param DAO $DAO\n+    */\n+    public function __construct(DAO $DAO)\n+    {\n+        $this->_DAO =& $DAO;\n+        $this->dbConn = $this->_DAO->getConnection();\n+        $this->_locked = null;\n+    }\n+\n+    // /->Assessment()\n+\n+    /**\n+    * ================================================================================\n+    * Public Methods\n+    * ================================================================================\n+    */\n+\n+    /**\n+    * --------------------------------------------------------------------------------\n+    * Load/Save Functions\n+    * --------------------------------------------------------------------------------\n+    */\n+\n+    /**\n+    * Create a new Assessment ID\n+    */\n+    public function create()\n+    {\n+        // generate a new project_id\n+        while (true) {\n+            $new_id = Common::uuid_create();\n+            $projectIdQuery =\n+          'SELECT COUNT(assessment_id) ' .\n+          'FROM ' . APP__DB_TABLE_PREFIX . 'assessment ' .\n+          'WHERE assessment_id = ?';\n+\n+            $projectCount = $this->dbConn->fetchOne($projectIdQuery, [$new_id], [ParameterType::STRING]);\n+\n+            if ($projectCount == 0) {\n+                break;\n+            }\n+        }\n+\n+        $this->id = $new_id;\n+    }\n+\n+    /**\n+    * Delete this Assessment\n+    *\n+    * @return boolean true\n+    */\n+    public function delete()\n+    {\n+        $this->dbConn->executeQuery(\n+            'DELETE FROM ' . APP__DB_TABLE_PREFIX . 'assessment_group_marks WHERE assessment_id = ?',\n+            [$this->id],\n+            [ParameterType::STRING]\n+        );\n+\n+        $this->dbConn->executeQuery(\n+            'DELETE FROM ' . APP__DB_TABLE_PREFIX . 'assessment_marking WHERE assessment_id = ?',\n+            [$this->id],\n+            [ParameterType::STRING]\n+        );\n+\n+        $this->dbConn->executeQuery(\n+            'DELETE FROM ' . APP__DB_TABLE_PREFIX . 'user_mark WHERE assessment_id = ?',\n+            [$this->id],\n+            [ParameterType::STRING]\n+        );\n+\n+        $this->dbConn->executeQuery(\n+            'DELETE FROM ' . APP__DB_TABLE_PREFIX . 'user_justification WHERE assessment_id = ?',\n+            [$this->id],\n+            [ParameterType::STRING]\n+        );\n+\n+        $this->dbConn->executeQuery(\n+            'DELETE FROM ' . APP__DB_TABLE_PREFIX . 'user_response WHERE assessment_id = ?',\n+            [$this->id],\n+            [ParameterType::STRING]\n+        );\n+\n+        $collectionQuery =\n+        'SELECT collection_id ' .\n+        'FROM ' . APP__DB_TABLE_PREFIX . 'assessment ' .\n+        'WHERE assessment_id = ?';\n+\n+        $collection = $this->dbConn->fetchOne($collectionQuery, [$this->id], [ParameterType::STRING]);\n+\n+        $this->dbConn->executeQuery(\n+            'DELETE FROM ' . APP__DB_TABLE_PREFIX . 'assessment WHERE assessment_id = ?',\n+            [$this->id],\n+            [ParameterType::STRING]\n+        );\n+\n+        $group_handler = new GroupHandler();\n+        $collection = $group_handler->get_collection($collection);\n+        $collection->delete();\n+\n+        return true;\n+    }\n+\n+    /**\n+    * Load the Assessment from the database\n+    *\n+    * @param string $id id of Group to load\n+    *\n+    * @return boolean did load succeed\n+    */\n+    public function load($id)\n+    {\n+        $this->_locked = null;\n+\n+        $assessmentQuery =\n+        'SELECT * ' .\n+        'FROM ' . APP__DB_TABLE_PREFIX . 'assessment ' .\n+        'WHERE assessment_id = ? ' .\n+        'LIMIT 1';\n+\n+        $row = $this->dbConn->fetchAssociative($assessmentQuery, [$id], [ParameterType::STRING]);\n+\n+        return $row ? $this->load_from_row($row) : false;\n+    }\n+\n+    /**\n+    * Load the Assessment from the given row\n+    *\n+    * @param array $row associative-array of assessment information\n+    *\n+    * @return boolean did load sucessed\n+    */\n+    public function load_from_row($row)\n+    {\n+        $this->id = $row['assessment_id'];\n+        $this->name = $row['assessment_name'];\n+        $this->module_id = $row['module_id'];\n+        $this->_collection_id = $row['collection_id'];\n+        $this->_form_xml = $row['form_xml'];\n+        $this->open_date = strtotime($row['open_date']);\n+        $this->close_date = strtotime($row['close_date']);\n+        $this->introduction = $row['introduction'];\n+        $this->allow_feedback = ($row['allow_feedback']==1);\n+        $this->assessment_type = ($row['assessment_type']); //==1);\n+        $this->allow_assessment_feedback = ($row['student_feedback']);\n+        $this->email_opening = ($row['email_opening']);\n+        $this->email_closing = ($row['email_closing']);\n+        $this->feedback_name = ($row['feedback_name']);\n+\n+        return true;\n+    }\n+\n+    // /->load_from_row()\n+\n+    /**\n+    * Save this Assessment\n+    *\n+    * @return boolean did save succeed\n+    */\n+    public function save()\n+    {\n+        if (!$this->id) {\n+            return false;\n+        }\n+\n+        // check if assessment already exists in the database\n+        $storedAssessmentId = $this->dbConn->fetchOne(\n+            'SELECT assessment_id FROM ' . APP__DB_TABLE_PREFIX . 'assessment WHERE assessment_id = ?',\n+            [$this->id],\n+            [ParameterType::STRING]\n+        );\n+\n+        $queryBuilder = $this->dbConn->createQueryBuilder();\n+\n+        if (!empty($storedAssessmentId)) {\n+            // the assessment already exists so we should update it\n+            $queryBuilder\n+          ->update(APP__DB_TABLE_PREFIX . 'assessment')\n+          ->set('assessment_name', '?')\n+          ->set('module_id', '?')\n+          ->set('collection_id', '?')\n+          ->set('form_xml', '?')\n+          ->set('open_date', '?')\n+          ->set('close_date', '?')\n+          ->set('retract_date', '?')\n+          ->set('introduction', '?')\n+          ->set('allow_feedback', $this->allow_feedback ? 1 : 0)\n+          ->set('assessment_type', $this->assessment_type ? 1 : 0)\n+          ->set('student_feedback', $this->allow_assessment_feedback ? 1 : 0)\n+          ->set('contact_email', '\"\"')\n+          ->set('email_opening', $this->email_opening ? 1 : 0)\n+          ->set('email_closing', $this->email_closing ? 1 : 0)\n+          ->set('feedback_name', '?')\n+          ->set('feedback_length', 0)\n+          ->set('feedback_optional', 0)\n+          ->where('assessment_id = ?')\n+          ->setParameter(0, $this->name)\n+          ->setParameter(1, $this->module_id, ParameterType::INTEGER)\n+          ->setParameter(2, $this->_collection_id)\n+          ->setParameter(3, $this->_form_xml)\n+          ->setParameter(4, date(MYSQL_DATETIME_FORMAT, $this->open_date))\n+          ->setParameter(5, date(MYSQL_DATETIME_FORMAT, $this->close_date))\n+          ->setParameter(6, date(MYSQL_DATETIME_FORMAT, $this->close_date))\n+          ->setParameter(7, $this->introduction)\n+          ->setParameter(8, $this->feedback_name)\n+          ->setParameter(9, $this->id);\n+        } else {\n+            // the assessment does not exist. Create it\n+            $queryBuilder\n+          ->insert(APP__DB_TABLE_PREFIX . 'assessment')\n+          ->values(\n+              [\n+                 'assessment_id' => '?',\n+                 'assessment_name' => '?',\n+                 'module_id' => '?',\n+                 'collection_id' => '?',\n+                 'form_xml' => '?',\n+                 'open_date' => '?',\n+                 'close_date' => '?',\n+                 'retract_date' => '?',\n+                 'introduction' => '?',\n+                 'allow_feedback' => $this->allow_feedback ? 1 : 0,\n+                 'assessment_type' => $this->assessment_type ? 1 : 0,\n+                 'student_feedback' => $this->allow_assessment_feedback ? 1 : 0,\n+                 'contact_email' => '\"\"',\n+                 'email_opening' => $this->email_opening ? 1 : 0,\n+                 'email_closing' => $this->email_closing ? 1 : 0,\n+                 'feedback_name' => '?',\n+                 'feedback_length' => 0,\n+                 'feedback_optional' => 0,\n+              ]\n+          )\n+          ->setParameter(0, $this->id)\n+          ->setParameter(1, $this->name)\n+          ->setParameter(2, $this->module_id, ParameterType::INTEGER)\n+          ->setParameter(3, $this->_collection_id)\n+          ->setParameter(4, $this->_form_xml)\n+          ->setParameter(5, date(MYSQL_DATETIME_FORMAT, $this->open_date))\n+          ->setParameter(6, date(MYSQL_DATETIME_FORMAT, $this->close_date))\n+          ->setParameter(7, date(MYSQL_DATETIME_FORMAT, $this->close_date))\n+          ->setParameter(8, $this->introduction)\n+          ->setParameter(9, $this->feedback_name);\n+        }\n+\n+        $queryBuilder->execute();\n+\n+        return true;\n+    }\n+\n+    /*\n+    * --------------------------------------------------------------------------------\n+    * Other Methods\n+    * --------------------------------------------------------------------------------\n+    */\n+\n+    /**\n+    * Create a clone of this assessment\n+    * @return mixed\n+    */\n+    public function & get_clone()\n+    {\n+        $clone_assessment = new Assessment($this->_DAO);\n+        $clone_assessment->load($this->id);   // Creates an EXACT clone of this assessment\n+        $clone_assessment->create();\n+        return $clone_assessment;\n+    }\n+\n+    /*\n+    * --------------------------------------------------------------------------------\n+    * Accessor Methods\n+    * --------------------------------------------------------------------------------\n+    */\n+\n+    public function get_db()\n+    {\n+        return $this->_DAO;\n+    }\n+\n+    public function get_form()\n+    {\n+        // Get the number of questions used in this assessment, and create an array of that size\n+        $form = new Form($this->get_db());\n+        $form_xml =& $this->_form_xml;\n+        $form->load_from_xml($form_xml);\n+\n+        return $form;\n+    }\n+\n+    // /->get_form()\n+\n+    public function get_form_xml()\n+    {\n+        return $this->_form_xml;\n+    }\n+\n+    // /->get_form_xml()\n+\n+    /**\n+     * Get the group marks.\n+     *\n+     */\n+    public function get_group_marks()\n+    {\n+        $groups_and_marks = [];\n+\n+        $groupsAndMarksQuery =\n+        'SELECT group_mark_xml ' .\n+        'FROM ' . APP__DB_TABLE_PREFIX . 'assessment_group_marks ' .\n+        'WHERE assessment_id = ?';\n+\n+        $group_marks_xml = $this->dbConn->fetchOne($groupsAndMarksQuery, [$this->id], [ParameterType::STRING]);\n+\n+        if ($group_marks_xml) {\n+            $xml_parser = new XMLParser();\n+            $xml_array = $xml_parser->parse($group_marks_xml);\n+\n+            // If there's more than 1 group that's fine, else make it a 0-based array of 1 group\n+            if (array_key_exists(0, $xml_array['groups']['group'])) {\n+                $groups = $xml_array['groups']['group'];\n+            } else {\n+                $groups[0] = $xml_array['groups']['group'];\n+            }\n+            foreach ($groups as $i => $group) {\n+                $groups_and_marks[\"{$group['_attributes']['id']}\"] = $group['_attributes']['mark'];\n+            }\n+        }\n+\n+        return $groups_and_marks;\n+    }\n+\n+    // /->get_group_marks()\n+\n+    public function set_form_xml($xml)\n+    {\n+        $this->_form_xml = $xml;\n+    }\n+\n+    // /->set_form_xml()\n+\n+    public function get_collection_id()\n+    {\n+        return $this->_collection_id;\n+    }\n+\n+    // /->get_collection_id()\n+\n+    public function set_collection_id($collection_id)\n+    {\n+        $this->_collection_id = $collection_id;\n     }\n-    $this->id = $new_id;\n-  }// ->create()\n-\n-  /**\n-  * Delete this Assessment\n-  *\n-  * @return boolean true\n-  */\n-  function delete() {\n-    $this->_DAO->execute(\"DELETE FROM \" . APP__DB_TABLE_PREFIX . \"assessment_group_marks WHERE assessment_id = '{$this->id}'\");\n-    $this->_DAO->execute(\"DELETE FROM \" . APP__DB_TABLE_PREFIX . \"assessment_marking WHERE assessment_id = '{$this->id}'\");\n-    $this->_DAO->execute(\"DELETE FROM \" . APP__DB_TABLE_PREFIX . \"user_mark WHERE assessment_id = '{$this->id}'\");\n-    $this->_DAO->execute(\"DELETE FROM \" . APP__DB_TABLE_PREFIX . \"user_justification WHERE assessment_id = '{$this->id}'\");\n-    $this->_DAO->execute(\"DELETE FROM \" . APP__DB_TABLE_PREFIX . \"user_response WHERE assessment_id = '{$this->id}'\");\n-    $collection = $this->_DAO->fetch_value(\"SELECT collection_id FROM \" . APP__DB_TABLE_PREFIX . \"assessment WHERE assessment_id = '{$this->id}'\");\n-    $this->_DAO->execute(\"DELETE FROM \" . APP__DB_TABLE_PREFIX . \"assessment WHERE assessment_id = '{$this->id}'\");\n-    $group_handler = new GroupHandler();\n-    $collection = $group_handler->get_collection($collection);\n-    $collection->delete();\n-    return true;\n-  }// /->delete()\n-\n-  /**\n-  * Load the Assessment from the database\n-  *\n-  * @param string $id id of Group to load\n-  *\n-  * @return boolean did load succeed\n-  */\n-  function load($id) {\n-    $this->_locked = null;\n-\n-    $row = $this->_DAO->fetch_row(\"SELECT * FROM \" . APP__DB_TABLE_PREFIX . \"assessment WHERE assessment_id = '$id' LIMIT 1\");\n-    return ($row) ? $this->load_from_row($row) : false;\n-  }// /->load()\n-\n-  /**\n-  * Load the Assessment from the given row\n-  *\n-  * @param array $row associative-array of assessment information\n-  *\n-  * @return boolean did load sucessed\n-  */\n-  function load_from_row($row) {\n-    $this->id = $row['assessment_id'];\n-    $this->name = $row['assessment_name'];\n-    $this->module_id = $row['module_id'];\n-    $this->_collection_id = $row['collection_id'];\n-    $this->_form_xml = $row['form_xml'];\n-    $this->open_date = strtotime($row['open_date']);\n-    $this->close_date = strtotime($row['close_date']);\n-    $this->introduction = $row['introduction'];\n-    $this->allow_feedback = ($row['allow_feedback']==1);\n-    $this->assessment_type = ($row['assessment_type']); //==1);\n-    $this->allow_assessment_feedback = ($row['student_feedback']);\n-    $this->email_opening = ($row['email_opening']);\n-    $this->email_closing = ($row['email_closing']);\n-    $this->feedback_name = ($row['feedback_name']);\n-\n-    return true;\n-  }// /->load_from_row()\n-\n-  /**\n-  * Save this Assessment\n-  *\n-  * @return boolean did save succeed\n-  */\n-  function save() {\n-    if (!$this->id) {\n-      return false;\n-    } else {\n-      // Save the Form\n-      $fields = array (\n-      \t       'assessment_id'    => $this->id ,\n-               'assessment_name'    => $this->name ,\n-               'module_id'       => $this->module_id ,\n-               'collection_id'    => $this->_collection_id ,\n-               'form_xml'       => $this->_form_xml ,\n-               'open_date'      => date(MYSQL_DATETIME_FORMAT, $this->open_date) ,\n-               'close_date'     => date(MYSQL_DATETIME_FORMAT, $this->close_date) ,\n-               'retract_date'     => date(MYSQL_DATETIME_FORMAT, $this->close_date) ,\n-               'introduction'     => $this->introduction ,\n-               'allow_feedback'   => ($this->allow_feedback) ? 1 : 0 ,\n-               'assessment_type'    => ($this->assessment_type)? 1 : 0 ,\n-               'student_feedback'   => ($this->allow_assessment_feedback)? 1 : 0 ,\n-               'contact_email'    => '' ,\n-               'email_opening'    => ($this->email_opening)? 1 : 0 ,\n-               'email_closing'    =>($this->email_closing)? 1 : 0 ,\n-               'feedback_name'    => $this->feedback_name ,\n-               'feedback_length'    => 0 ,\n-               'feedback_optional'    => 0\n-      );\n-\n-      $ass_name = $this->_DAO->escape_str($fields['assessment_name']);\n-      $ass_intro = $this->_DAO->escape_str($fields['introduction']);\n-      $xml = $this->_DAO->_prepare_field_value($fields['form_xml']);\n-\n-      $sql = 'INSERT INTO ' . APP__DB_TABLE_PREFIX . 'assessment ({fields}) VALUES ({values}) ';\n-      $sql .= \"ON DUPLICATE KEY UPDATE assessment_name = '{$ass_name}', module_id = {$fields['module_id']}, \" .\n-              \"collection_id = '{$fields['collection_id']}', form_xml = {$xml}, \" .\n-              \"open_date = '{$fields['open_date']}', close_date = '{$fields['close_date']}', \" .\n-              \"retract_date = '{$fields['retract_date']}', \" .\n-              \"introduction = '{$ass_intro}', allow_feedback = {$fields['allow_feedback']}, \" .\n-              \"assessment_type = {$fields['assessment_type']}, student_feedback = {$fields['student_feedback']}, \" .\n-              \"contact_email = '{$fields['contact_email']}', \" .\n-              \"email_opening = {$fields['email_opening']}, email_closing = {$fields['email_closing']}, \" .\n-              \"feedback_name = '{$fields['feedback_name']}', \" .\n-              \"feedback_length = {$fields['feedback_length']}, feedback_optional = {$fields['feedback_optional']}\";\n-      $this->_DAO->do_insert($sql, $fields);\n-\n-      return true;\n+\n+    // /->set_collection_id()\n+\n+    /*\n+    * Get the current status of this assessment\n+    *\n+    * @return  string  ['pending','open','closed','finished']\n+    */\n+    public function get_status()\n+    {\n+        $now = time();\n+\n+        $status = 'unknown';\n+        if ($this->open_date > $now) {\n+            $status = 'pending';\n+        }\n+        if ($this->open_date < $now) {\n+            $status = 'open';\n+        }\n+        if ($this->close_date < $now) {\n+            $status = 'closed';\n+        }\n+        if ($this->_finished) {\n+            $status = 'finished';\n+        }\n+\n+        return $status;\n     }\n-  }// /->save()\n-\n-/*\n-* --------------------------------------------------------------------------------\n-* Other Methods\n-* --------------------------------------------------------------------------------\n-*/\n-\n-  /**\n-  * Create a clone of this assessment\n-  * @return mixed\n-  */\n-  function & get_clone() {\n-    $clone_assessment = new Assessment($this->_DAO);\n-    $clone_assessment->load($this->id);   // Creates an EXACT clone of this assessment\n-    $clone_assessment->create();\n-    return $clone_assessment;\n-  }\n-\n-/*\n-* --------------------------------------------------------------------------------\n-* Accessor Methods\n-* --------------------------------------------------------------------------------\n-*/\n-\n-  function get_db() {\n-    return $this->_DAO;\n-  }// /->get_db\n-\n-  function get_form() {\n-    // Get the number of questions used in this assessment, and create an array of that size\n-    $form = new Form($db);\n-    $form_xml =& $this->_form_xml;\n-    $form->load_from_xml($form_xml);\n-\n-    return $form;\n-  }// /->get_form()\n-\n-  function get_form_xml() {\n-    return $this->_form_xml;\n-  }// /->get_form_xml()\n-\n-  /**\n-   * Get the group marks.\n-   *\n-   */\n-  function get_group_marks() {\n-    $groups_and_marks = array();\n-\n-    $group_marks_xml = $this->_DAO->fetch_value(\"\n-       SELECT group_mark_xml\n-       FROM \" . APP__DB_TABLE_PREFIX . \"assessment_group_marks\n-       WHERE assessment_id = '{$this->id}'\");\n-\n-    if ($group_marks_xml) {\n-      $xml_parser = new XMLParser();\n-      $xml_array = $xml_parser->parse($group_marks_xml);\n-\n-      // If there's more than 1 group that's fine, else make it a 0-based array of 1 group\n-      if (array_key_exists(0, $xml_array['groups']['group'])) {\n-        $groups = $xml_array['groups']['group'];\n-      } else {\n-        $groups[0] = $xml_array['groups']['group'];\n-      }\n-      foreach($groups as $i => $group) {\n-        $groups_and_marks[\"{$group['_attributes']['id']}\"] = $group['_attributes']['mark'];\n-      }\n+\n+    // /->get_status\n+\n+    /**\n+     * function to get the date string\n+     * @param date $date\n+     * @return string formated date\n+    */\n+    public function get_date_string($date)\n+    {\n+        $date_format = 'D, jS F, Y \\a\\t G:i';\n+        if ($date == 'open_date') {\n+            return date($date_format, $this->open_date);\n+        }\n+        if ($date == 'close_date') {\n+            return date($date_format, $this->close_date);\n+        }\n     }\n \n-    return $groups_and_marks;\n-  }// /->get_group_marks()\n-\n-  function set_form_xml($xml) {\n-    $this->_form_xml = $xml;\n-  }// /->set_form_xml()\n-\n-  function get_collection_id() {\n-    return $this->_collection_id;\n-  }// /->get_collection_id()\n-\n-  function set_collection_id($collection_id) {\n-    $this->_collection_id = $collection_id;\n-  }// /->set_collection_id()\n-\n-  /*\n-  * Get the current status of this assessment\n-  *\n-  * @return  string  ['pending','open','closed','finished']\n-  */\n-  function get_status() {\n-    $now = time();\n-\n-    $status = 'unknown';\n-    if ($this->open_date > $now) { $status = 'pending'; }\n-    if ($this->open_date < $now) { $status = 'open'; }\n-    if ($this->close_date < $now) { $status = 'closed'; }\n-    if ($this->_finished) { $status = 'finished'; }\n-\n-    return $status;\n-  }// /->get_status\n-\n-  /**\n-   * function to get the date string\n-   * @param date $date\n-   * @return string formated date\n-  */\n-  function get_date_string($date) {\n-    $date_format = 'D, jS F, Y \\a\\t G:i';\n-    if ($date == 'open_date') { return date($date_format,$this->open_date); }\n-    if ($date == 'close_date') { return date($date_format,$this->close_date); }\n-  }// /->get_date_string()\n-\n-  /**\n-   * Get all the marksheets available for this assessment.\n-   *\n-   * Output of the form: array ( date_created => array ( <params> ) )\n-   *\n-   * @return  mixed  An assoc array of marksheets available. On fail, null.\n-   */\n-  function get_all_marking_params() {\n-    $params = null;\n-\n-    $mark_sheets = $this->_DAO->fetch(\"\n-      SELECT date_created, marking_params\n-      FROM \" . APP__DB_TABLE_PREFIX . \"assessment_marking\n-      WHERE assessment_id = '{$this->id}'\n-      ORDER BY date_created ASC\n-    \");\n-\n-    if ($mark_sheets) {\n-      foreach($mark_sheets as $i => $mark_sheet) {\n-        $params[$mark_sheet['date_created']] = $this->_parse_marking_params($mark_sheet['marking_params']);\n-      }\n+    // /->get_date_string()\n+\n+    /**\n+     * Get all the marksheets available for this assessment.\n+     *\n+     * Output of the form: array ( date_created => array ( <params> ) )\n+     *\n+     * @return  mixed  An assoc array of marksheets available. On fail, null.\n+     */\n+    public function get_all_marking_params()\n+    {\n+        $params = null;\n+\n+        $markSheetsQuery =\n+      'SELECT date_created, marking_params ' .\n+      'FROM ' . APP__DB_TABLE_PREFIX . 'assessment_marking ' .\n+      'WHERE assessment_id = ? ' .\n+      'ORDER BY date_created ASC';\n+\n+        $mark_sheets = $this->dbConn->fetchAllAssociative($markSheetsQuery, [$this->id], [ParameterType::STRING]);\n+\n+        if ($mark_sheets) {\n+            foreach ($mark_sheets as $i => $mark_sheet) {\n+                $params[$mark_sheet['date_created']] = $this->_parse_marking_params($mark_sheet['marking_params']);\n+            }\n+        }\n+\n+        return $params;\n     }\n \n-    return $params;\n-  }// /->get_all_marking_params()\n-\n-  /**\n-   * Enter description here...\n-   *\n-   * @param  datetime  $marksheet_id  The marksheet to load\n-   *\n-   * return  mixed  An array of marking parameters. On fail, null.\n-   */\n-  function get_marking_params($marksheet_id) {\n-    $params = null;\n-\n-    $marking_date_sql = date(MYSQL_DATETIME_FORMAT, $marksheet_id);\n-\n-    $marking_params = $this->_DAO->fetch_value(\"SELECT marking_params\n-                          FROM \" . APP__DB_TABLE_PREFIX . \"assessment_marking\n-                          WHERE assessment_id = '{$this->id}'\n-                            AND date_created='$marking_date_sql'\n-                          LIMIT 1\");\n-    if ($marking_params) {\n-      $params = $this->_parse_marking_params($marking_params);\n+    // /->get_all_marking_params()\n+\n+    /**\n+     * Enter description here...\n+     *\n+     * @param  datetime  $marksheet_id  The marksheet to load\n+     *\n+     * return  mixed  An array of marking parameters. On fail, null.\n+     */\n+    public function get_marking_params($marksheet_id)\n+    {\n+        $params = null;\n+\n+        $marking_date_sql = date(MYSQL_DATETIME_FORMAT, $marksheet_id);\n+\n+        $markingParamsQuery =\n+        'SELECT marking_params ' .\n+        'FROM ' . APP__DB_TABLE_PREFIX . 'assessment_marking ' .\n+        'WHERE assessment_id = ? ' .\n+        'AND date_created = ? ' .\n+        'LIMIT 1';\n+\n+        $marking_params = $this->dbConn->fetchOne($markingParamsQuery, [$this->id, $marking_date_sql], [ParameterType::STRING, ParameterType::STRING]);\n+\n+        if ($marking_params) {\n+            $params = $this->_parse_marking_params($marking_params);\n+        }\n+\n+        return $params;\n     }\n \n-    return $params;\n-  }// /->get_marking_params()\n-\n-  /**\n-  * Is this Assessment locked for editing\n-  *\n-  * @return bool lock status\n-  */\n-  function is_locked() {\n-    if (is_null($this->_locked)) {\n-      $result_count = $this->_DAO->fetch_value(\"SELECT COUNT(assessment_id)\n-                           FROM \" . APP__DB_TABLE_PREFIX . \"user_mark\n-                           WHERE assessment_id = '{$this->id}'\");\n-\n-      $this->_locked = ($result_count>0);\n+    // /->get_marking_params()\n+\n+    /**\n+    * Is this Assessment locked for editing\n+    *\n+    * @return bool lock status\n+    */\n+    public function is_locked()\n+    {\n+        if (is_null($this->_locked)) {\n+            $countAssessmentsQuery =\n+          'SELECT COUNT(assessment_id) ' .\n+          'FROM ' . APP__DB_TABLE_PREFIX . 'user_mark ' .\n+          'WHERE assessment_id = ?';\n+\n+            $result_count = $this->dbConn->fetchOne($countAssessmentsQuery, [$this->id], [ParameterType::STRING]);\n+\n+            $this->_locked = ($result_count>0);\n+        }\n+        return $this->_locked;\n     }\n-    return $this->_locked;\n-  }// /->is_locked()\n \n-  /**\n-  * Set database connection\n-  * @param  object  $db  The database connection object to use\n-  */\n-  function set_db(& $db) {\n-    $this->_DAO =& $db;\n-  }// /->set_db()\n+    // /->is_locked()\n \n-/*\n-* --------------------------------------------------------------------------------\n-* Methods\n-* --------------------------------------------------------------------------------\n-*/\n+    /**\n+    * Set database connection\n+    * @param  object  $db  The database connection object to use\n+    */\n+    public function set_db(& $db)\n+    {\n+        $this->_DAO =& $db;\n+    }\n \n-  /*\n-  * Finish this assessment, save settings and lock from editing/marking\n-  */\n-  function finish() {\n-  }// /->finish()\n+    // /->set_db()\n \n-/*\n-* ================================================================================\n-* Private Methods\n-* ================================================================================\n-*/\n+    /*\n+    * --------------------------------------------------------------------------------\n+    * Methods\n+    * --------------------------------------------------------------------------------\n+    */\n \n-  protected function _parse_marking_params($marking_params_xml) {\n-    $params = null;\n+    // Finish this assessment, save settings and lock from editing/marking\n+    public function finish()\n+    {\n+    }\n+\n+    // /->finish()\n \n-    if (!is_object($this->_xml_parser)) { $xml_parser = new XMLParser(); }\n+    /*\n+    * ================================================================================\n+    * Private Methods\n+    * ================================================================================\n+    */\n \n-    $xml_array = $xml_parser->parse($marking_params_xml);\n+    protected function _parse_marking_params($marking_params_xml)\n+    {\n+        $params = null;\n \n-    $params['weighting'] = $xml_array['parameters']['weighting']['_attributes']['value'];\n-    $params['penalty'] = $xml_array['parameters']['penalty']['_attributes']['value'];\n+        if (!is_object($this->_xml_parser)) {\n+            $xml_parser = new XMLParser();\n+        }\n \n-    $params['penalty_type'] = (array_key_exists('penalty_type', $xml_array['parameters'])) ? $xml_array['parameters']['penalty_type']['_attributes']['value'] : '%' ;\n+        $xml_array = $xml_parser->parse($marking_params_xml);\n \n-    $params['tolerance'] = (array_key_exists('tolerance', $xml_array['parameters'])) ? $xml_array['parameters']['tolerance']['_attributes']['value'] : null ;\n+        $params['weighting'] = $xml_array['parameters']['weighting']['_attributes']['value'];\n+        $params['penalty'] = $xml_array['parameters']['penalty']['_attributes']['value'];\n \n-    $params['grading'] = (array_key_exists('grading', $xml_array['parameters'])) ? $xml_array['parameters']['grading']['_attributes']['value'] : 'numeric' ;\n+        $params['penalty_type'] = (array_key_exists('penalty_type', $xml_array['parameters'])) ? $xml_array['parameters']['penalty_type']['_attributes']['value'] : '%' ;\n \n-    $params['algorithm'] = (array_key_exists('algorithm', $xml_array['parameters'])) ? $xml_array['parameters']['algorithm']['_attributes']['value'] : 'webpa' ;\n+        $params['tolerance'] = (array_key_exists('tolerance', $xml_array['parameters'])) ? $xml_array['parameters']['tolerance']['_attributes']['value'] : null ;\n \n-    return $params;\n-  }// /->_parse_marking_params()\n+        $params['grading'] = (array_key_exists('grading', $xml_array['parameters'])) ? $xml_array['parameters']['grading']['_attributes']['value'] : 'numeric' ;\n \n-}// /class: Assessment\n+        $params['algorithm'] = (array_key_exists('algorithm', $xml_array['parameters'])) ? $xml_array['parameters']['algorithm']['_attributes']['value'] : 'webpa' ;\n \n-?>\n+        return $params;\n+    }\n+}"
        },
        {
          "filename": "src/includes/classes/Authenticator.php",
          "status": "modified",
          "additions": 126,
          "deletions": 101,
          "patch": "@@ -12,79 +12,104 @@\n \n namespace WebPA\\includes\\classes;\n \n+use Doctrine\\DBAL\\ParameterType;\n+\n class Authenticator\n {\n+    // Public variables\n+    public $user_id;\n+\n+    public $source_id;\n+\n+    public $user_type;\n+\n+    public $module_id;\n+\n+    public $module_code;\n+\n+    // Private variables\n+    protected $username;\n+\n+    protected $password;\n+\n+    protected $_authenticated = false;\n+\n+    protected $_disabled;\n+\n+    protected $_error;\n+\n+    private $_DAO;\n \n-// Public variables\n-    public $user_id = NULL;\n-    public $source_id = NULL;\n-    public $user_type = NULL;\n-    public $module_id = NULL;\n-    public $module_code = NULL;\n-\n-// Private variables\n-    protected $username = NULL;\n-    protected $password = NULL;\n-    protected $_authenticated = FALSE;\n-    protected $_disabled = NULL;\n-    protected $_error = NULL;\n-    private $_DAO = NULL;\n     private $cis;\n \n+    private $dbConn;\n+\n     /**\n      *  CONSTRUCTOR for the Authenticator class\n      */\n-    public function __construct(EngCIS $cis, $username = NULL, $password = NULL)\n+    public function __construct(EngCIS $cis, $username = null, $password = null)\n     {\n         $this->cis = $cis;\n \n         $this->username = $username;\n         $this->password = $password;\n-    }// /->Authenticator()\n+    }\n+\n+    // /->Authenticator()\n \n     /*\n     ================================================================================\n       PUBLIC\n     ================================================================================\n     */\n \n-    /*\n-    Initialise the user details\n-    */\n-    function initialise($sql)\n+    /**\n+     * Initialise the user details.\n+     *\n+     * @param $user\n+     *\n+     * @return bool\n+     */\n+    public function initialise($user)\n     {\n-        $this->user_type = NULL;\n-        $this->_authenticated = FALSE;\n-        $this->_disabled = TRUE;\n+        $this->user_type = null;\n+        $this->_authenticated = false;\n+        $this->_disabled = true;\n \n-        $is_admin = FALSE;\n+        $is_admin = false;\n         $DAO = $this->get_DAO();\n-        $user_data = $DAO->fetch_row($sql);\n-        if (!is_null($user_data)) {\n-            $is_admin = $user_data['admin'] == 1;\n-            $source_id = $user_data['source_id'];\n+        $this->dbConn = $DAO->getConnection();\n+\n+        if (!is_null($user)) {\n+            $is_admin = $user['admin'] == 1;\n+            $source_id = $user['source_id'];\n+\n+            $this->module_id = $user['last_module_id'];\n \n-            $this->module_id = $user_data['last_module_id'];\n             if (!empty($this->module_id)) {\n                 if (!$is_admin) {\n-                    $sql_user_module = 'SELECT module_id, user_type FROM ' . APP__DB_TABLE_PREFIX . \"user_module WHERE module_id = {$user_data['last_module_id']} AND user_id = {$user_data['user_id']}\";\n-                    $user_module = $DAO->fetch_row($sql_user_module);\n-                    if (is_null($user_module)) {\n-                        $this->module_id = NULL;\n+                    $userModuleQuery = 'SELECT module_id, user_type FROM ' . APP__DB_TABLE_PREFIX . 'user_module WHERE module_id = ? AND user_id = ?';\n+\n+                    $userModule = $this->dbConn->fetchAssociative($userModuleQuery, [$user['last_module_id'], $user['user_id']], [ParameterType::INTEGER, ParameterType::INTEGER]);\n+\n+                    if (is_null($userModule)) {\n+                        $this->module_id = null;\n                     }\n                 } else {\n-                    $sql_admin_module = 'SELECT source_id FROM ' . APP__DB_TABLE_PREFIX . \"module WHERE module_id = {$user_data['last_module_id']}\";\n-                    $admin_module = $DAO->fetch_row($sql_admin_module);\n-                    if (!is_null($admin_module)) {\n-                        $source_id = $admin_module['source_id'];\n+                    $adminModuleQuery = 'SELECT source_id FROM ' . APP__DB_TABLE_PREFIX . 'module WHERE module_id = ?';\n+\n+                    $adminModule = $this->dbConn->fetchAssociative($adminModuleQuery, [$user['last_module_id']], [ParameterType::INTEGER]);\n+\n+                    if (!is_null($adminModule)) {\n+                        $source_id = $adminModule['source_id'];\n                     }\n                 }\n             }\n             if (empty($this->module_id)) {\n                 if ($is_admin) {\n-                    $modules = $this->cis->get_user_modules(NULL, NULL, NULL, $source_id);\n+                    $modules = $this->cis->get_user_modules(null, null, null, $source_id);\n                 } else {\n-                    $modules = $this->cis->get_user_modules($user_data['user_id']);\n+                    $modules = $this->cis->get_user_modules($user['user_id']);\n                 }\n                 if (count($modules) > 0) {\n                     $ids = array_keys($modules);\n@@ -93,122 +118,122 @@ function initialise($sql)\n             }\n \n             if (!empty($this->module_id)) {\n+                $moduleQuery = 'SELECT module_code FROM ' . APP__DB_TABLE_PREFIX . 'module WHERE module_id = ?';\n+\n+                $moduleCode = $this->dbConn->fetchOne($moduleQuery, [$this->module_id], [ParameterType::INTEGER]);\n \n-                $sql_module = 'SELECT module_code FROM ' . APP__DB_TABLE_PREFIX . \"module WHERE module_id = {$this->module_id}\"; // AND source_id = '{$source_id}'\";\n-                $module = $DAO->fetch_row($sql_module);\n-                if (is_null($module)) {\n-                    $this->module_id = NULL;\n+                if (is_null($moduleCode)) {\n+                    $this->module_id = null;\n                 } else {\n-                    $this->module_code = $module['module_code'];\n+                    $this->module_code = $moduleCode;\n                 }\n             }\n \n             if (!is_null($this->module_id)) {\n+                $userTypeQuery = 'SELECT user_type FROM ' . APP__DB_TABLE_PREFIX . 'user_module WHERE module_id = ? AND user_id = ?';\n \n-                $sql_user_module = 'SELECT user_type FROM ' . APP__DB_TABLE_PREFIX . \"user_module WHERE module_id = {$this->module_id} AND user_id = {$user_data['user_id']}\";\n-                $user_module = $DAO->fetch_row($sql_user_module);\n+                $userType = $this->dbConn->fetchOne($userTypeQuery, [$this->module_id, $user['user_id']], [ParameterType::INTEGER, ParameterType::INTEGER]);\n \n                 // Update last login date\n                 $now = date(MYSQL_DATETIME_FORMAT, time());\n-                $sql_login_date = 'UPDATE ' . APP__DB_TABLE_PREFIX . \"user SET date_last_login = '{$now}' WHERE user_id = '{$user_data['user_id']}'\";\n-                $DAO->execute($sql_login_date);\n+                $sql_login_date =\n+                    'UPDATE ' . APP__DB_TABLE_PREFIX . 'user ' .\n+                    'SET date_last_login = ? ' .\n+                    'WHERE user_id = ?';\n+\n+                $stmt = $this->dbConn->prepare($sql_login_date);\n+\n+                $stmt->bindParam(1, $now);\n+                $stmt->bindParam(2, $user['user_id'], ParameterType::INTEGER);\n+\n+                $stmt->execute();\n \n                 //with the database row data returned get all the information and add it to the class holders\n-                $this->user_id = $user_data['user_id'];\n+                $this->user_id = $user['user_id'];\n                 $this->source_id = $source_id;\n                 if (!$is_admin) {\n-                    $this->user_type = $user_module['user_type'];\n+                    $this->user_type = $userType;\n                 } else {\n                     $this->user_type = APP__USER_TYPE_ADMIN;\n                 }\n \n-                $this->_disabled = ($user_data['disabled'] == 1);\n+                $this->_disabled = ($user['disabled'] == 1);\n                 $this->_authenticated = !$this->_disabled;\n-\n             }\n-\n         }\n \n         return $this->_authenticated;\n-\n     }\n \n-    /*\n-    Is the user authenticated?\n-    */\n-    function is_authenticated()\n+    // Is the user authenticated?\n+    public function is_authenticated()\n     {\n         return $this->_authenticated;\n-    }// /->is_authenticated()\n+    }\n \n-    /*\n-    Is the user disabled?\n-    */\n-    function is_disabled()\n+    // /->is_authenticated()\n+\n+    // Is the user disabled?\n+    public function is_disabled()\n     {\n         return $this->_disabled;\n-    }// /->is_disabled()\n+    }\n \n-    /*\n-    Is this user admin?\n-    */\n-    function is_admin()\n+    // /->is_disabled()\n+\n+    // Is this user admin?\n+    public function is_admin()\n     {\n-        return ($this->user_type == APP__USER_TYPE_ADMIN);\n-    }// /->is_admin()\n+        return $this->user_type == APP__USER_TYPE_ADMIN;\n+    }\n \n-    /*\n-    Is this user staff?\n-    */\n-    function is_staff()\n+    // /->is_admin()\n+\n+    // Is this user staff?\n+    public function is_staff()\n     {\n         return ($this->user_type == APP__USER_TYPE_TUTOR) || ($this->user_type == APP__USER_TYPE_ADMIN);\n-    }// /->is_staff()\n+    }\n \n-    /*\n-    Is this user tutor?\n-    */\n-    function is_tutor()\n+    // /->is_staff()\n+\n+    // Is this user tutor?\n+    public function is_tutor()\n     {\n-        return ($this->user_type == APP__USER_TYPE_TUTOR);\n-    }// /->is_staff()\n+        return $this->user_type == APP__USER_TYPE_TUTOR;\n+    }\n \n-    /*\n-    Is this user student?\n-    */\n-    function is_student()\n+    // /->is_staff()\n+\n+    // Is this user student?\n+    public function is_student()\n     {\n-        return ($this->user_type == APP__USER_TYPE_STUDENT);\n-    }// /->is_student()\n+        return $this->user_type == APP__USER_TYPE_STUDENT;\n+    }\n \n-    /*\n-    Get the last authorisation error\n-    */\n-    function get_error()\n+    // /->is_student()\n+\n+    // Get the last authorisation error\n+    public function get_error()\n     {\n         return $this->_error;\n-    }// /->get_error()\n+    }\n \n-    /*\n-    Get the DAO object\n-    */\n-    function get_DAO()\n-    {\n+    // /->get_error()\n \n+    // Get the DAO object\n+    public function get_DAO()\n+    {\n         if (is_null($this->_DAO)) {\n             $this->_DAO = new DAO(APP__DB_HOST, APP__DB_USERNAME, APP__DB_PASSWORD, APP__DB_DATABASE);\n         }\n \n         return $this->_DAO;\n-\n     }\n \n     /*\n     ================================================================================\n       PRIVATE\n     ================================================================================\n     */\n-\n }// /class Authenticator\n-\n-?>"
        },
        {
          "filename": "src/includes/classes/DAO.php",
          "status": "modified",
          "additions": 22,
          "deletions": 636,
          "patch": "@@ -1,8 +1,7 @@\n <?php\n+\n /**\n- * Class : DAO\n- *\n- * This data access object is designed for MySQL only\n+ * The database access object which serves a Doctrine DBAL connection.\n  *\n  * @copyright Loughborough University\n  * @license https://www.gnu.org/licenses/gpl-3.0.en.html GPL version 3\n@@ -12,657 +11,44 @@\n \n namespace WebPA\\includes\\classes;\n \n+use Doctrine\\DBAL\\Connection;\n+use Doctrine\\DBAL\\DriverManager;\n+\n class DAO\n {\n-    // Public Vars\n-\n-    // Private Vars\n-    private $_host = '';        // DB Connection info\n-    private $_user = '';\n-    private $_password = '';\n-    private $_database = '';\n-    private $_persistent = false;\n-\n-    private $_conn = null;        // DB Connection object\n-\n-    private $_result_set = null;    // Contains the result set (temporarily)\n-    private $_result_cols = null;   // Array of columns for the result set\n-\n-    private $_last_sql = null;      // Last query run\n-    private $_result = [];      // Query results, as array of row objects\n-\n-    private $_output_type = 'ARRAY_A';  // 'ARRAY_A': Associative Array : $results[row]['field']\n-    // 'ARRAY_N': Numeric Array : $results[row][col]\n-    // 'ARRAY_B': Assoc + Numeric Array : use $results[row]['field'] or $results[row][col]\n-\n-    private $_output_type_int = MYSQLI_ASSOC;  // MYSQLI_ASSOC, MYSQLI_BOTH, MYSQLI_NUM\n-\n-    private $_insert_id = null;     // Last inserted id (on auto-increment columns)\n-\n-    private $_num_cols = null;\n-    private $_num_rows = null;\n-    private $_num_affected = null;\n-\n-    private $_debug = false;      // debug mode (default: off)\n-    private $_last_error = null;\n+    private Connection $_conn;\n \n     /**\n-     * CONSTRUCTOR\n-     * Set database connection strings\n+     * Set up the doctrine connection.\n+     *\n      * @param string $host\n      * @param string $user\n      * @param string $password\n      * @param string $database\n      * @param boolean $persistent\n-     */\n-    function __construct($host, $user, $password, $database, $persistent = false)\n-    {\n-        $this->_host = $host;\n-        $this->_user = $user;\n-        $this->_password = $password;\n-        $this->_database = $database;\n-        $this->_persistent = $persistent;\n-    } // /DAO()\n-\n-    /*\n-    * ================================================================================\n-    * Public Methods\n-    * ================================================================================\n-    */\n-\n-    /**\n-     * Open database connection\n-     * @param boolean $new_link block reusing an existing database connection when the same server/username/password are used\n-     * @return boolean\n-     */\n-    function open($new_link = true)\n-    {\n-        if (is_null($this->_conn)) {\n-            if ($this->_persistent) {\n-                $func = 'mysqli_pconnect';\n-            } else {\n-                $func = 'mysqli_connect';\n-            }\n-\n-            if ($this->_debug) {\n-                $this->_conn = $func($this->_host, $this->_user, $this->_password, $this->_database);\n-\n-                if (!$this->_conn) {\n-                    die ('Can\\'t use database due to  : ' . mysqli_connect_errno() . ' - ' . mysqli_connect_error());\n-\n-                    return false;\n-                }\n-\n-                return true;\n-            } else {\n-                $this->_conn = $func($this->_host, $this->_user, $this->_password, $this->_database);\n-\n-                if (!$this->_conn) {\n-                    die ('Can\\'t use database due to  : ' . mysqli_connect_errno() . ' - ' . mysqli_connect_error());\n-\n-                    return false;\n-                }\n-\n-                return true;\n-            }\n-\n-        }\n-\n-        return true;\n-    } // /->open()\n-\n-    /**\n-     * Close database connection.\n      *\n-     * @return bool\n+     * @return void\n      */\n-    function close()\n+    public function __construct($host, $user, $password, $database, $persistent = false)\n     {\n-        $this->flush();\n-        $isClosed = @mysqli_close($this->_conn);\n-        $this->_conn = null;\n+        $connectionParams = [\n+            'dbname' => $database,\n+            'user' => $user,\n+            'password' => $password,\n+            'host' => $host,\n+            'driver' => 'mysqli',\n+        ];\n \n-        return $isClosed;\n+        $this->_conn = DriverManager::getConnection($connectionParams);\n     }\n \n     /**\n-     * Clear results and reset result vars\n-     */\n-    function flush()\n-    {\n-        $this->_result = [];\n-        $this->_num_rows = null;\n-        $this->_num_affected = null;\n-        $this->_insert_id = null;\n-    } // /->flush()\n-\n-    /**\n-     * Execute the SQL query, and ignore results (ie, not a SELECT)\n-     * Sets affected rows (ie could be DELETE/INSERT/REPLACE/UPDATE)\n-     * Sets inserted id if query is INSERT/REPLACE (checks first word of query)\n-     * @param string $sql\n-     * @return boolean\n-     */\n-    function execute($sql)\n-    {\n-\n-        $this->flush();\n-        $this->open();\n-        $this->_last_sql = trim($sql);  // Save query\n-\n-        if ($this->_debug) {\n-            $this->_result_set = mysqli_query($this->_conn, $sql) or $this->_throw_error('Executing SQL');\n-        } else {\n-            $this->_result_set = @mysqli_query($this->_conn, $sql);\n-        }\n-\n-        if ($this->_result_set) {\n-            $this->_num_affected = mysqli_affected_rows($this->_conn);\n-\n-            if (preg_match(\"/^\\\\s*(insert|replace) /i\", $sql)) {\n-                $this->_insert_id = mysqli_insert_id($this->_conn);\n-            }\n-\n-            if ($this->_num_affected) {\n-                return true;\n-            } else {\n-                return false;\n-            }\n-        } else {\n-            return false;\n-        }\n-    }// /->execute()\n-\n-    /**\n-     * Get results of the given query\n-     * @param string $sql\n-     * @return object\n-     */\n-    function fetch($sql = null)\n-    {\n-        // If there is an SQL query, get its results instead..\n-        if ($sql) {\n-            $this->_process_query($sql);\n-        }\n-\n-        return $this->_result;\n-    } // /->fetch()\n-\n-    /**\n-     * Get a single row (of the given query or cache)\n-     * Row indexes are 0-based\n-     * @param string $sql\n-     * @param integer $y\n-     * @return object\n-     */\n-    function fetch_row($sql = null, $y = 0)\n-    {\n-        // If there is an SQL query, get its results instead..\n-        if ($sql) {\n-            $this->_process_query($sql);\n-        }\n-        return isset($this->_result[$y]) ? $this->_result[$y] : null;\n-    } // /->fetch_row()\n-\n-    /**\n-     * Get a single column as a numeric array\n-     * column indexes are 0-based\n-     * @param string $sql\n-     * @param integer $x\n-     * @return array\n-     */\n-    function fetch_col($sql = null, $x = 0)\n-    {\n-        // If there is an SQL query, get its results instead..\n-        if ($sql) {\n-            $this->_process_query($sql);\n-        }\n-\n-        $new_array = null;\n-\n-        // Extract the column value\n-        if ($this->_num_rows > 0) {\n-            for ($i = 0; $i < $this->_num_rows; $i++) {\n-                $new_array[$i] = $this->fetch_value(null, $x, $i);\n-            }\n-        }\n-        return $new_array;\n-    } // /->fetch_col()\n-\n-    /**\n-     * Get a single value from the result set. Column/row indexes are 0-based. An empty string ('') or no value, will\n-     * return null\n-     *\n-     * @param string $sql\n-     * @param integer $x\n-     * @param integer $y\n-     *\n-     * @return integer\n-     */\n-    function fetch_value($sql = null, $x = 0, $y = 0)\n-    {\n-        // If there is an SQL query, get its results instead\n-        if ($sql) {\n-            $this->_process_query($sql);\n-        }\n-\n-        // Extract value using x,y vals\n-        if (!empty($this->_result) && isset($this->_result[$y])) {\n-            $values = array_values($this->_result[$y]);\n-        }\n-\n-        // If there is a value return it, else return null\n-        return isset($values[$x]) && $values[$x] !== '' ? $values[$x] : null;\n-    }\n-\n-    /**\n-     * Get an associative array ( field1-value => field2-value ) from the result set\n-     * If you retrieve more than 2 fields, you will get an associative array of row-arrays\n-     * e.g.   field1-value => array ( field2 => field2-value, field3 => field3-value, ... ), ...\n-     * @param string $sql\n-     * @return array\n-     */\n-    function fetch_assoc($sql = null)\n-    {\n-        // Need to be in Numeric+Assoc Array mode, so set it\n-        $original_output_mode = $this->get_output_mode();\n-        $this->set_output($output = 'ARRAY_B');\n-\n-        // Fetch the new result set\n-        $this->_process_query($sql);\n-\n-        // Reset mode to what it was before\n-        $this->set_output($original_output_mode);\n-\n-        $new_array = null;\n-\n-        if ($this->_num_rows > 0) {\n-            if ($this->get_num_cols() == 2) {\n-                // Convert rows to simple associative array\n-                for ($i = 0; $i < $this->_num_rows; $i++) {\n-                    $new_array[\"{$this->_result[$i][0]}\"] = $this->_result[$i][1];\n-                }\n-            } else {\n-                // Convert rows to associative array of arrays\n-                for ($i = 0; $i < $this->_num_rows; $i++) {\n-                    $row_array = null;\n-                    for ($j = 1; $j < $this->_num_cols; $j++) {\n-                        $row_array[$this->_result_cols[\"$j\"]] = $this->_result[$i][$j];\n-                    }\n-                    $new_array[\"{$this->_result[$i][0]}\"] = $row_array;\n-                }\n-            }\n-        }\n-        return $new_array;\n-    }// /->fetch_assoc()\n-\n-    /**\n-     * Execute the insert query in $sql, using the fields in $fields\n-     * auto-slashes the given fields\n-     * @param string $sql string of the form 'INSERT INTO tbl_name ({fields}) VALUES ({values}) '\n-     * @param array $fields array ( fieldname1 => ???, fieldname2 => ???, ... )\n-     */\n-    function do_insert($sql, $fields)\n-    {\n-        $fields_str = implode(',', (array)array_keys($fields));\n-\n-        $values = array();\n-        foreach ($fields as $k => $v) {\n-            $values[] = $this->_prepare_field_value($v);\n-        }\n-        $values_str = implode(',', $values);\n-\n-        $sql = str_replace('{fields}', $fields_str, $sql);\n-        $sql = str_replace('{values}', $values_str, $sql);\n-\n-        return $this->execute($sql);\n-    } // /->do_insert()\n-\n-    /**\n-     * Execute the insert query in $sql, using multiple VALUES statements as given in $fields\n-     * Auto-slashes the given fields\n-     *\n-     * NOTE  : Unlike ->do_insert, the $fields array is an array[0..n] of assoc-arrays\n-     * NOTE  : Only the last insert-id will be available from ->get_insert_id() following execution\n-     *\n-     * @param string $sql of the form, 'INSERT INTO tbl_name ({fields}) VALUES {values}\n-     * @param array $fields array[0..n] of array ( fieldname1 -> ???, fieldname2 => ???, ... )\n-     * @return object\n-     */\n-    function do_insert_multi($sql, $fields)\n-    {\n-        if (is_array($fields)) {\n-            $fields_str = implode(',', array_keys($fields[0]));\n-\n-            $value_row = null;\n-\n-            foreach ($fields as $i => $row) {\n-                $value_row[\"$i\"] = array();\n-                foreach ($row as $k => $v) {\n-                    $value_row[\"$i\"][] = $this->_prepare_field_value($v);\n-                }\n-                $value_row[\"$i\"] = '(' . implode(',', $value_row[\"$i\"]) . ')';\n-            }\n-            $values_str = implode(',', $value_row);\n-\n-            $sql = str_replace('{fields}', $fields_str, $sql);\n-            $sql = str_replace('{values}', $values_str, $sql);\n-\n-            return $this->execute($sql);\n-        } else {\n-            return null;\n-        }\n-    }// /->do_insert_multi()\n-\n-    /**\n-     * Execute the update query in $sql, setting the fields in $fields\n-     * Auto-slashes the given fields\n-     * @param string $sql sql query of the form  'UPDATE tbl_name SET {fields} WHERE xxx=yyy'\n-     * @param array $fields of fields and values to set - of the form  array ( fieldname1 => ???, fieldname2 => ???, ... )\n-     * @return mixed\n-     */\n-    function do_update($sql, $fields)\n-    {\n-        $set_str = '';\n-        $fields_count = count($fields);\n-        $i = 1;\n-\n-        foreach ($fields AS $k => $v) {\n-            $set_str .= \" $k=\" . $this->_prepare_field_value($v);\n-            if ($i < $fields_count) {\n-                $set_str .= ',';\n-            }\n-            ++$i;\n-        }\n-\n-        $sql = str_replace('{fields}', $set_str, $sql);\n-        return $this->execute($sql);\n-    } // /->do_update()\n-\n-    /**\n-     * Builds filter clause of the form  (aaa='bbb' OR aaa='ccc' OR aaa='ddd' ... )\n+     * Return the Doctrine database connection object.\n      *\n-     * @param string $field_name the field name being checked (aaa in example above)\n-     * @param array/value $filter_values the values to compare against.\n-     * @param string $logical_operator the operator to use to concatenate the filters (AND, OR, XOR)\n-     * @return string\n-     */\n-    function build_filter($field_name, $filter_values, $logical_operator = 'OR')\n-    {\n-        $filter_values = (array)$filter_values;  // cast values to array (in case it was only passed one)\n-\n-        $filter_clause = '(';\n-        $w_count = count($filter_values);\n-        $i = 1;\n-        foreach ($filter_values as $k => $v) {\n-            if (!is_int($v)) {\n-                $v = $this->escape_str($v);\n-            }\n-            $filter_clause .= \"$field_name = \" . $this->_prepare_field_value($v);\n-            if ($i < $w_count) {\n-                $filter_clause .= \" $logical_operator \";\n-            }\n-            $i++;\n-        }\n-        $filter_clause .= ')';\n-\n-        return $filter_clause;\n-    }// ->build_filter()\n-\n-    /**\n-     * Builds an SQL set of the form  ('aaa','bbb','ccc') for use with IN operators\n-     *\n-     * @param array/value $value_array array of values to include in the set\n-     * @return string\n-     */\n-    function build_set($value_array, $quoted = true)\n-    {\n-        $value_array = array_map('addslashes', (array)$value_array);\n-        if ($quoted) {\n-            return '(\\'' . implode('\\',\\'', $value_array) . '\\')';\n-        } else {\n-            return '(' . implode(',', $value_array) . ')';\n-        }\n-    }// /->build_set()\n-\n-    /*\n-    * --------------------------------------------------------------------------------\n-    * Accessor Methods\n-    * --------------------------------------------------------------------------------\n-    */\n-\n-    // GET_xxx functions\n-\n-    /**\n-     * Return an array of columns names from the last query\n-     * @return boolean\n-     */\n-    function get_cols()\n-    {\n-        return (is_array($this->_result_cols)) ? $this->_result_cols : null;\n-    }\n-\n-    /**\n-     * Return the number of columns from the last query\n-     * @return integer\n-     */\n-    function get_num_cols()\n-    {\n-        return $this->_num_cols;\n-    }\n-\n-    /**\n-     * Return the number of rows from the last query\n-     * @return integer\n+     * @return Connection\n      */\n-    function get_num_rows()\n+    public function getConnection()\n     {\n-        return $this->_num_rows;\n-    }\n-\n-    /**\n-     * Return the number of affected rows from the last query (insert/replace/update)\n-     * @return integer\n-     */\n-    function get_num_affected()\n-    {\n-        return $this->_num_affected;\n-    }\n-\n-    /**\n-     * Return last inserted id (for auto-increment columns)\n-     * @return integer\n-     */\n-    function get_insert_id()\n-    {\n-        return $this->_insert_id;\n-    }\n-\n-    /**\n-     * Return last run query\n-     * @return string\n-     */\n-    function get_last_sql()\n-    {\n-        return $this->_last_sql;\n-    }\n-\n-    /**\n-     *  Get last mysql error\n-     */\n-    function get_last_error()\n-    {\n-        mysqli_error($this->_conn);\n-    }\n-\n-    /**\n-     * Get output mode\n-     * @return mixed\n-     */\n-    function get_output_mode()\n-    {\n-        return $this->_output_type;\n-    }\n-\n-    function getConnection()\n-    {\n-\n         return $this->_conn;\n-\n-    }\n-\n-    /*\n-    * --------------------------------------------------------------------------------\n-    * SET_xxx functions\n-    * --------------------------------------------------------------------------------\n-    */\n-\n-    /**\n-     * Set debug mode\n-     * When in debug mode, detailed error reports are echoed\n-     * @param boolean\n-     */\n-    function set_debug($on)\n-    {\n-        $this->_debug = $on;\n     }\n-\n-    /**\n-     * Set default output mode for results array\n-     * @param string $output\n-     * @return boolean\n-     */\n-    function set_output($output = 'ARRAY_A')\n-    {\n-        switch ($output) {\n-            case 'ARRAY_A'  :\n-                $this->_output_type_int = MYSQLI_ASSOC;\n-                $this->_output_type = $output;\n-                return true;\n-                break;\n-            // ----------------------------------------\n-            case 'ARRAY_B'  :\n-                $this->_output_type_int = MYSQLI_BOTH;\n-                $this->_output_type = $output;\n-                return true;\n-                break;\n-            // ----------------------------------------\n-            case 'ARRAY_N'  :\n-                $this->_output_type_int = MYSQLI_NUM;\n-                $this->_output_type = $output;\n-                return true;\n-                break;\n-            // ----------------------------------------\n-            default :\n-                return false;\n-                break;\n-        }\n-    }// /->set_output()\n-\n-    /**\n-     * Escape character string\n-     * @param string $str\n-     * @return string\n-     */\n-    function escape_str($str)\n-    {\n-        return mysqli_real_escape_string($this->_conn, stripslashes($str));\n-    }\n-\n-    /*\n-    * ================================================================================\n-    * Private Methods\n-    * ================================================================================\n-    */\n-\n-    /**\n-     * Execute the SQL and collect the result set\n-     * @param string $sql\n-     * @return boolean\n-     */\n-    function _process_query($sql)\n-    {\n-        $this->flush();\n-        $this->open();\n-        $this->_last_sql = trim($sql);  // Save query\n-\n-        if ($this->_debug) {\n-            $this->_result_set = mysqli_query($this->_conn, $sql) or $this->_throw_error('Querying database');\n-        } else {\n-            $this->_result_set = @mysqli_query($this->_conn, $sql);\n-        }\n-\n-        // If got a result set..\n-        if ($this->_result_set) {\n-\n-            // number of columns returned\n-            $this->_num_cols = mysqli_num_fields($this->_result_set);\n-\n-            // Store column names as an array\n-            $this->_result_cols = array();\n-\n-            while ($field = @mysqli_fetch_field($this->_result_set)) {\n-                $this->_result_cols[] = $field->name;\n-            }\n-\n-            // Store the results as an array of row objects\n-            while ($row = @mysqli_fetch_array($this->_result_set, $this->_output_type_int)) {\n-                $this->_result[] = $row;\n-            }\n-\n-            // number of rows returned\n-            $this->_num_rows = count($this->_result);\n-\n-            // Free the actual result set\n-            @mysqli_free_result($this->_result_set);\n-\n-            // If there were results.. return true\n-            return ($this->_num_rows >= 1);\n-        } else {\n-            $this->_num_cols = 0;\n-            $this->_num_rows = 0;\n-            $this->_result_cols = null;\n-            return false;\n-        }\n-    } // /->process_query()\n-\n-    /**\n-     * function to capture the thrown error and out put to the screen\n-     * @param string $err_msg\n-     * @return boolean\n-     */\n-    function _throw_error($err_msg)\n-    {\n-        if ($this->_conn) {\n-            die(\"<hr />DATABASE ERROR<hr />$err_msg :: \" . mysqli_error($this->_conn) . '<hr />' . $this->get_last_sql() . '<hr />');\n-        } else {\n-            die(\"<hr />DATABASE ERROR<hr />$err_msg :: &lt;NO SERVER&gt;<hr />\" . $this->get_last_sql() . '<hr />');\n-        }\n-        return false;\n-    }// /->_throw_error()\n-\n-    /**\n-     * Prepare a value for putting into the database\n-     * Escapes special characters, checks for NULL, and puts in quotes as necessary\n-     *\n-     * @param integer $value value to prepare\n-     *\n-     * @return string   en-quoted value, ready for insertion into a database (of the form 'value' or NULL)\n-     */\n-    function _prepare_field_value($value)\n-    {\n-        // NULL values don't need quotes, so if it's null, just return a string containing NULL\n-        // Else, return an escaped string containing the value enclosed in quotes\n-        if (is_null($value)) {\n-            return 'NULL';\n-        } else if (is_int($value)) {\n-            return \"$value\";\n-        } else {\n-            return '\\'' . $this->escape_str($value) . '\\'';\n-        }\n-\n-    }// /->_prepare_field_value()\n-\n-} // /class: DAO\n-\n-?>\n+}"
        },
        {
          "filename": "src/includes/classes/DBAuthenticator.php",
          "status": "modified",
          "additions": 58,
          "deletions": 18,
          "patch": "@@ -12,33 +12,73 @@\n \n namespace WebPA\\includes\\classes;\n \n-class DBAuthenticator extends Authenticator {\n+use Doctrine\\DBAL\\ParameterType;\n \n-    public function __construct(EngCIS $cis, $username = NULL, $password = NULL)\n+class DBAuthenticator extends Authenticator\n+{\n+    private DAO $dao;\n+\n+    public function __construct(EngCIS $cis, $username = null, $password = null)\n     {\n         parent::__construct($cis, $username, $password);\n     }\n \n-    /*\n-    Authenticate the user against the internal database\n-    */\n-  function authenticate() {\n+    // Authenticate the user against the internal database\n+    public function authenticate()\n+    {\n+        $this->_error = null;\n+\n+        //match the username and password to the values in the database.\n+        $this->dao = new DAO(APP__DB_HOST, APP__DB_USERNAME, APP__DB_PASSWORD, APP__DB_DATABASE);\n+\n+        $dbConn = $this->dao->getConnection();\n+\n+        $query = 'SELECT * FROM ' . APP__DB_TABLE_PREFIX . 'user WHERE username = ? AND source_id = \"\"';\n \n-    $this->_error = NULL;\n+        $user = $dbConn->fetchAssociative($query, [$this->username], [ParameterType::STRING]);\n \n-    //match the username and password to the values in the database.\n-    $password = md5($this->password);\n+        // verify the password provided\n+        if (password_verify($this->password, $user['password'])) {\n+            if (password_needs_rehash($user['password'], PASSWORD_DEFAULT)) {\n+                $this->rehashPassword($user['username'], $this->password);\n+            }\n \n-    $sql = 'SELECT * FROM ' . APP__DB_TABLE_PREFIX . \"user WHERE (username = '{$this->username}') AND (password = '$password') AND (source_id = '')\";\n+            $this->initialise($user);\n+        } else {\n+            // we could be using the old md5 hash. Check this and if it is the case, rehash the password\n+            $md5HashedPass = md5($this->password);\n \n-    return $this->initialise($sql);\n+            if ($md5HashedPass === $user['password']) {\n+                $this->rehashPassword($user['username'], $this->password);\n \n-  }// /->authenticate()\n+                $this->initialise($user);\n+            }\n+        }\n \n-/*\n-================================================================================\n-  PRIVATE\n-================================================================================\n-*/\n+        return $this->_authenticated;\n+    }\n+\n+    /**\n+     * Rehash existing passwords to use the more secure default PHP password hash.\n+     *\n+     * @param string $username\n+     * @param string $password\n+     *\n+     * @throws \\Doctrine\\DBAL\\Exception\n+     */\n+    private function rehashPassword($username, $password)\n+    {\n+        $newHash = password_hash($password, PASSWORD_DEFAULT);\n \n-}// /class DBAuthenticator\n+        $updatePasswordQuery =\n+            'UPDATE ' . APP__DB_TABLE_PREFIX . 'user ' .\n+            'SET password = ? ' .\n+            'WHERE username = ?';\n+\n+        $this->dao->getConnection()->executeQuery(\n+            $updatePasswordQuery,\n+            [$newHash, $username],\n+            [ParameterType::STRING, ParameterType::STRING]\n+        );\n+    }\n+}"
        },
        {
          "filename": "src/includes/classes/Email.php",
          "status": "modified",
          "additions": 178,
          "deletions": 133,
          "patch": "@@ -13,163 +13,208 @@\n \n namespace WebPA\\includes\\classes;\n \n-class Email {\n-  // Public Vars\n+class Email\n+{\n+    // Public Vars\n \n+    // Private Vars\n+    private $_to;\n \n-  // Private Vars\n-  private $_to = null;\n-  private $_cc = null;\n-  private $_bcc = null;\n+    private $_cc;\n \n-  private $_from = null;\n+    private $_bcc;\n \n-  private $_subject = null;\n-  private $_body = null;\n+    private $_from;\n \n-  private $_message_type = 'text';\n-  private $_headers = null;\n+    private $_subject;\n \n-  /**\n-  * CONSTRUCTOR for the email class\n-  */\n-  function __construct() {\n-    $this->_init();\n-  } // /->Email()\n+    private $_body;\n \n-/*\n-* ================================================================================\n-* Public Methods\n-* ================================================================================\n-*/\n-/**\n- * Function to set who the email will go to\n- * @param string $to\n- */\n-  function set_to($to) {\n-    if (!is_array($to)) { $this->_to[] = $to; }\n-    else {$this->_to = $to; }\n-  }// ->set_to()\n+    private $_message_type = 'text';\n \n-/**\n- * function to set the cc person for an email\n- * @param string $cc\n- */\n-  function set_cc($cc) {\n-    if (is_null($cc)) {\n-      unset($this->_headers['Cc']);\n-    } else {\n-      if (!is_array($cc)) { $this->_cc[] = $cc; }\n-      else {$this->_cc = $cc; }\n-      $this->_headers['Cc'] = implode(',',$cc);\n+    private $_headers;\n+\n+    /**\n+    * CONSTRUCTOR for the email class\n+    */\n+    public function __construct()\n+    {\n+        $this->_init();\n     }\n-  }// /->set_cc()\n \n-/**\n- * function to set the bcc for the email\n- * @param string $bcc\n- */\n-  function set_bcc($bcc) {\n-    if (is_null($bcc)) {\n-      unset($this->_headers['Bcc']);\n-    } else {\n-      if (!is_array($bcc)) { $this->_bcc[] = $bcc; }\n-      else {$this->_bcc = $bcc; }\n-      $this->_headers['Bcc'] = implode(',',$bcc);\n+    // /->Email()\n+\n+    /*\n+    * ================================================================================\n+    * Public Methods\n+    * ================================================================================\n+    */\n+\n+    /**\n+     * Function to set who the email will go to\n+     * @param string $to\n+     */\n+    public function set_to($to)\n+    {\n+        if (!is_array($to)) {\n+            $this->_to[] = $to;\n+        } else {\n+            $this->_to = $to;\n+        }\n     }\n-  }// /->set_bcc()\n \n-/**\n- * function to set who the email is from\n- * @param string $from\n- */\n-  function set_from($from) {\n-    $this->_from = $from;\n-    $this->_headers['From'] = $this->_from;\n-    $this->_headers['Reply-To'] = $this->_from;\n-  }// /->set_from()\n+    // ->set_to()\n+\n+    /**\n+     * function to set the cc person for an email\n+     * @param string $cc\n+     */\n+    public function set_cc($cc)\n+    {\n+        if (is_null($cc)) {\n+            unset($this->_headers['Cc']);\n+        } else {\n+            if (!is_array($cc)) {\n+                $this->_cc[] = $cc;\n+            } else {\n+                $this->_cc = $cc;\n+            }\n+            $this->_headers['Cc'] = implode(',', $cc);\n+        }\n+    }\n \n-/**\n- * function to set the message type\n- * @param string  $type\n- */\n-  function set_message_type($type) {\n-    if ($type == 'html') {\n-      $this->_message_type = 'html';\n-      $this->_headers['MIME-Version'] = '1.0';\n-      $this->_headers['Content-Type'] = 'text/html;charset=iso-8859-1';\n-    } else {\n-      $this->_message_type = 'text';\n-      unset($this->_headers['MIME-Version']);\n-      unset($this->_headers['Content-Type']);\n+    // /->set_cc()\n+\n+    /**\n+     * function to set the bcc for the email\n+     * @param string $bcc\n+     */\n+    public function set_bcc($bcc)\n+    {\n+        if (is_null($bcc)) {\n+            unset($this->_headers['Bcc']);\n+        } else {\n+            if (!is_array($bcc)) {\n+                $this->_bcc[] = $bcc;\n+            } else {\n+                $this->_bcc = $bcc;\n+            }\n+            $this->_headers['Bcc'] = implode(',', $bcc);\n+        }\n     }\n-  }// /->set_message_type()\n \n-/**\n- * function to set the subject from the email\n- * @param string $subject\n- */\n-  function set_subject($subject) {\n-    $this->_subject = $subject;\n-  }// /->set_subject()\n+    // /->set_bcc()\n+\n+    /**\n+     * function to set who the email is from\n+     * @param string $from\n+     */\n+    public function set_from($from)\n+    {\n+        $this->_from = $from;\n+        $this->_headers['From'] = $this->_from;\n+        $this->_headers['Reply-To'] = $this->_from;\n+    }\n \n-/**\n- * Function to set the message body\n- * @param string $body\n- */\n-  function set_body($body) {\n-    $this->_body = $body;\n-  }// /->set_body()\n+    // /->set_from()\n+\n+    /**\n+     * function to set the message type\n+     * @param string  $type\n+     */\n+    public function set_message_type($type)\n+    {\n+        if ($type == 'html') {\n+            $this->_message_type = 'html';\n+            $this->_headers['MIME-Version'] = '1.0';\n+            $this->_headers['Content-Type'] = 'text/html;charset=iso-8859-1';\n+        } else {\n+            $this->_message_type = 'text';\n+            unset($this->_headers['MIME-Version']);\n+            unset($this->_headers['Content-Type']);\n+        }\n+    }\n \n-/**\n- * Function to send the email\n- */\n-  function send() {\n-    $this->_send();\n-  }// /->send()\n-\n-/*\n-* ================================================================================\n-* Private Methods\n-* ================================================================================\n-*/\n-/**\n- * function to initalise\n- */\n-  function _init() {\n-    $this->_to = null;\n-    $this->_cc = null;\n-    $this->_bcc = null;\n+    // /->set_message_type()\n+\n+    /**\n+     * function to set the subject from the email\n+     * @param string $subject\n+     */\n+    public function set_subject($subject)\n+    {\n+        $this->_subject = $subject;\n+    }\n \n-    $this->_from = null;\n+    // /->set_subject()\n \n-    $this->_subject = null;\n-    $this->_body = null;\n+    /**\n+     * Function to set the message body\n+     * @param string $body\n+     */\n+    public function set_body($body)\n+    {\n+        $this->_body = $body;\n+    }\n \n-    $this->_message_type = 'text';\n-    $this->_headers['X-Mailer'] = 'PHP/'. phpversion();\n-  }// /->_init()\n+    // /->set_body()\n \n-/**\n- * Function to send the email\n- * @return array\n- */\n-  function _send() {\n-    $to = ($this->_to) ? implode(',',$this->_to) : null;\n-    $cc = (is_array($this->_cc)) ? implode(',',$this->_cc) : null ;\n-    $bcc = (is_array($this->_bcc)) ? implode(',',$this->_bcc) : null ;\n+    /**\n+     * Function to send the email\n+     */\n+    public function send()\n+    {\n+        $this->_send();\n+    }\n+\n+    // /->send()\n \n-    $subject = $this->_subject;\n-    $message = str_replace(\"\\n.\", \"\\n..\", $this->_body);  // single '.' as first character fix for Windows SMTP servers\n+    /*\n+    * ================================================================================\n+    * Private Methods\n+    * ================================================================================\n+    */\n \n-    $headers = '';\n-    foreach($this->_headers as $header_name => $header_content) {\n-      $headers .= \"{$header_name}: {$header_content}\\r\\n\";\n+    /**\n+     * function to initalise\n+     */\n+    public function _init()\n+    {\n+        $this->_to = null;\n+        $this->_cc = null;\n+        $this->_bcc = null;\n+\n+        $this->_from = null;\n+\n+        $this->_subject = null;\n+        $this->_body = null;\n+\n+        $this->_message_type = 'text';\n+        $this->_headers['X-Mailer'] = 'PHP/'. phpversion();\n     }\n \n-    return mail($to, $subject, $message, $headers);\n-  }// /->_send()\n+    // /->_init()\n \n-} // /class: Email\n+    /**\n+     * Function to send the email\n+     * @return array\n+     */\n+    public function _send()\n+    {\n+        $to = ($this->_to) ? implode(',', $this->_to) : null;\n+        $cc = (is_array($this->_cc)) ? implode(',', $this->_cc) : null ;\n+        $bcc = (is_array($this->_bcc)) ? implode(',', $this->_bcc) : null ;\n+\n+        $subject = $this->_subject;\n+        $message = str_replace(\"\\n.\", \"\\n..\", $this->_body);  // single '.' as first character fix for Windows SMTP servers\n \n-?>\n+        $headers = '';\n+        foreach ($this->_headers as $header_name => $header_content) {\n+            $headers .= \"{$header_name}: {$header_content}\\r\\n\";\n+        }\n+\n+        return mail($to, $subject, $message, $headers);\n+    }\n+\n+    // /->_send()\n+} // /class: Email"
        },
        {
          "filename": "src/includes/classes/EngCIS.php",
          "status": "modified",
          "additions": 265,
          "deletions": 305,
          "patch": "@@ -10,20 +10,25 @@\n \n namespace WebPA\\includes\\classes;\n \n+use Doctrine\\DBAL\\ParameterType;\n+use WebPA\\includes\\functions\\AcademicYear;\n use WebPA\\includes\\functions\\ArrayFunctions;\n use WebPA\\includes\\functions\\Common;\n-use WebPA\\includes\\functions\\AcademicYear;\n-\n-include_once __DIR__ . '/../inc_global.php';\n \n class EngCIS\n {\n     private $_DAO;\n+\n     private $_ordering_types;\n+\n     private $user;\n+\n     private $sourceId;\n+\n     private $moduleId;\n \n+    private $dbConn;\n+\n     /**\n      * CONSTRUCTOR\n      */\n@@ -33,7 +38,8 @@ public function __construct($sourceId, $moduleId)\n         $this->moduleId = $moduleId;\n \n         $this->_DAO = new DAO(APP__DB_HOST, APP__DB_USERNAME, APP__DB_PASSWORD, APP__DB_DATABASE);\n-        $this->_DAO->set_debug(false);\n+\n+        $this->dbConn = $this->_DAO->getConnection();\n     }\n \n     public function setUser(User $user)\n@@ -55,46 +61,69 @@ public function setUser(User $user)\n      *\n      * @return array  either an assoc-array of module info or an array of assoc-arrays, containing many modules' info\n      */\n-    function get_module($modules = null, $ordering = 'id')\n+    public function get_module($modules = null, $ordering = 'id')\n     {\n-        $module_search = $this->_DAO->build_filter('module_id', (array)$modules);\n-        $order_by_clause = $this->_order_by_clause('module', $ordering);\n+        $queryBuilder = $this->dbConn->createQueryBuilder();\n+\n+        if ($ordering === 'name') {\n+            $queryBuilder->orderBy('lcm.module_id');\n+        } else {\n+            $queryBuilder->orderBy('lcm.module_title');\n+        }\n \n         // If there's more than one module to search for, get all the rows\n         if (is_array($modules)) {\n-            return $this->_DAO->fetch(\"SELECT lcm.module_id, lcm.module_title, lcm.module_code\n-                    FROM \" . APP__DB_TABLE_PREFIX . \"module lcm\n-                    WHERE (lcm.source_id = '{$this->sourceId}') AND $module_search\n-                    $order_by_clause\");\n-        } else if (!empty($modules)) {  // else, just return one row\n-            return $this->_DAO->fetch_row(\"SELECT lcm.module_id, lcm.module_title, lcm.module_code\n-                      FROM \" . APP__DB_TABLE_PREFIX . \"module lcm\n-                      WHERE (lcm.source_id = '{$this->sourceId}') AND $module_search\n-                      LIMIT 1\");\n-        } else if ($this->user->is_admin()) {\n-            return $this->_DAO->fetch(\"SELECT lcm.module_id, lcm.module_title, lcm.module_code\n-                    FROM \" . APP__DB_TABLE_PREFIX . \"module lcm\n-                    WHERE (lcm.source_id = '{$this->sourceId}')\n-                    $order_by_clause\");\n-        } else {\n-            return $this->_DAO->fetch(\"SELECT lcm.module_id, lcm.module_title, lcm.module_code\n-                  FROM \" . APP__DB_TABLE_PREFIX . \"module lcm\n-                  INNER JOIN \" . APP__DB_TABLE_PREFIX . \"user_module lcsm ON lcm.module_id = lcsm.module_id\n-                  WHERE (lcsm.user_type = '\" . APP__USER_TYPE_TUTOR . \"') AND\n-                        (user_id = $this->user->id) AND (lcm.source_id = '{$this->sourceId}')\n-                  $order_by_clause\");\n+            // get all modules\n+            $queryBuilder\n+                ->select('lcm.module_id', 'lcm.module_title', 'lcm.module_code')\n+                ->from(APP__DB_TABLE_PREFIX . 'module', 'lcm')\n+                ->where('lcm.source_id = :source_id')\n+                ->andWhere('module_id IN (:modules)')\n+                ->setParameter(':source_id', $this->sourceId)\n+                ->setParameter(':modules', $modules, $this->dbConn::PARAM_INT_ARRAY);\n+\n+            return $queryBuilder->execute()->fetchAllAssociative();\n+        }\n+        if (!empty($modules)) {  // else, just return one row\n+            $moduleQuery = 'SELECT module_id, module_title, module_code FROM ' . APP__DB_TABLE_PREFIX . 'module WHERE source_id = ? AND module_id = ? LIMIT 1';\n+\n+            return $this->dbConn->fetchAssociative(\n+                $moduleQuery,\n+                [$this->sourceId, $modules],\n+                [ParameterType::STRING, ParameterType::INTEGER]\n+            );\n+        }\n+        if ($this->user->is_admin()) {\n+            $queryBuilder\n+                ->select('lcm.module_id', 'lcm.module_title', 'lcm.module_code')\n+                ->from(APP__DB_TABLE_PREFIX . 'module', 'lcm')\n+                ->where('lcm.source_id = ?')\n+                ->setParameter(0, $this->sourceId, ParameterType::STRING);\n+\n+            return $queryBuilder->execute()->fetchAllAssociative();\n         }\n-    }// /->get_module()\n+        $queryBuilder\n+                ->select('lcm.module_id', 'lcm.module_title', 'lcm.module_code')\n+                ->from(APP__DB_TABLE_PREFIX . 'module', 'lcm')\n+                ->innerJoin('lcm', APP__DB_TABLE_PREFIX . 'user_module', 'lcsm', 'lcm.module_id = lcsm.module_id')\n+                ->where('lcsm.user_type = ?')\n+                ->andWhere('user_id = ?')\n+                ->andWhere('lcm.source_id = ?')\n+                ->setParameter(0, APP__USER_TYPE_TUTOR, ParameterType::STRING)\n+                ->setParameter(1, $this->user->id, ParameterType::INTEGER)\n+                ->setParameter(2, $this->sourceId, ParameterType::STRING);\n+\n+        return $queryBuilder->execute()->fetchAllAssociative();\n+    }\n \n     /**\n      * Get all the module info as an array\n      *\n      * @return array\n      */\n-    function get_all_modules()\n+    public function get_all_modules()\n     {\n-        return $this->_DAO->fetch(\"SELECT lcm.module_id, lcm.module_title\n-                    FROM \" . APP__DB_TABLE_PREFIX . \"module lcm\");\n+        return $this->dbConn->fetchAllAssociative('SELECT lcm.module_id, lcm.module_title FROM ' . APP__DB_TABLE_PREFIX . 'module lcm');\n     }\n \n     /**\n@@ -103,154 +132,133 @@ function get_all_modules()\n      * @param string $ordering\n      * @return array\n      */\n-    function get_module_staff($module_id, $ordering)\n+    public function get_module_staff($module_id, $ordering)\n     {\n-        $order_by_clause = $this->_order_by_clause('staff', $ordering);\n+        $queryBuilder = $this->dbConn->createQueryBuilder();\n+\n+        if ($ordering === 'id') {\n+            $queryBuilder->orderBy('lcs.user_id');\n+        } else {\n+            $queryBuilder->orderBy('lcs.lastname');\n+            $queryBuilder->addOrderBy('lcs.forename');\n+        }\n \n-        return $this->_DAO->fetch(\"SELECT lcs.*\n-                  FROM \" . APP__DB_TABLE_PREFIX . \"user lcs\n-                  INNER JOIN \" . APP__DB_TABLE_PREFIX . \"user_module lcsm ON lcs.user_id = lcsm.user_id\n-                  WHERE lcsm.user_type = '\" . APP__USER_TYPE_TUTOR . \"'\n-                    AND module_id = $module_id\n-                  $order_by_clause\");\n-    }// /->get_module_staff()\n+        $queryBuilder\n+            ->select('lcs.*')\n+            ->from(APP__DB_TABLE_PREFIX . 'user lcs')\n+            ->innerJoin('lcs', APP__DB_TABLE_PREFIX . 'user_module', 'lcsm', 'lcs.user_id = lcsm.user_id')\n+            ->where('lcsm.user_type = ?')\n+            ->andWhere('module_id = ?')\n+            ->setParameter(0, APP__USER_TYPE_TUTOR, ParameterType::STRING)\n+            ->setParameter(1, $module_id, ParameterType::INTEGER);\n+\n+        return $queryBuilder->execute()->fetchAllAssociative();\n+    }\n \n     /**\n      * Get array of students for one or more modules\n      * @param integer $modules\n      * @param string $ordering\n      * @return array\n      */\n-    function get_module_students($module, $ordering = 'name')\n+    public function get_module_students($module, $ordering = 'name')\n     {\n-        $order_by_clause = $this->_order_by_clause('student', $ordering);\n+        $queryBuilder = $this->dbConn->createQueryBuilder();\n \n-        $sql = \"SELECT DISTINCT lcs.*, lcs.id_number AS student_id\n-                  FROM \" . APP__DB_TABLE_PREFIX . \"user lcs\n-                  INNER JOIN \" . APP__DB_TABLE_PREFIX . \"user_module lcsm ON lcs.user_id = lcsm.user_id AND lcsm.module_id = $module\n-                  WHERE lcsm.user_type = '\" . APP__USER_TYPE_STUDENT . \"'\n-                  $order_by_clause\n-                  \";\n-        return $this->_DAO->fetch($sql);\n-    }// /->get_module_students()\n+        if ($ordering === 'id') {\n+            $queryBuilder->orderBy('lcs.user_id');\n+        } else {\n+            $queryBuilder->orderBy('lcs.lastname');\n+            $queryBuilder->addOrderBy('lcs.forename');\n+        }\n+\n+        $queryBuilder\n+            ->select('lcs.*', 'lcs.id_number as student_id')\n+            ->distinct()\n+            ->from(APP__DB_TABLE_PREFIX . 'user', 'lcs')\n+            ->innerJoin('lcs', APP__DB_TABLE_PREFIX . 'user_module', 'lcsm', 'lcs.user_id = lcsm.user_id AND lcsm.module_id = ?')\n+            ->where('lcsm.user_type = ?')\n+            ->setParameter(0, $module, ParameterType::INTEGER)\n+            ->setParameter(1, APP__USER_TYPE_STUDENT, ParameterType::STRING);\n+\n+        return $queryBuilder->execute()->fetchAllAssociative();\n+    }\n \n     /**\n      * Get total number of students on one or more modules\n      *\n-     * @param integer $module module to count students for\n-     * @return integer\n-     */\n-    function get_module_students_count($module)\n-    {\n-        $sql = \"SELECT COUNT(DISTINCT u.user_id)\n-        FROM \" . APP__DB_TABLE_PREFIX . \"user u\n-            INNER JOIN \" . APP__DB_TABLE_PREFIX . \"user_module um ON u.user_id = um.user_id\n-        WHERE um.module_id = $module\n-          AND um.user_type = '\" . APP__USER_TYPE_STUDENT . \"'\";\n-        return $this->_DAO->fetch_value($sql);\n-    }// /->get_module_students_count\n-\n-    /**\n-     * Get an array of student IDs for students on the given modules\n-     * @param array $modules modules to count students for\n-     * @return array\n+     * @param int $moduleId module to count students for\n+     *\n+     * @return int\n      */\n-    function get_module_students_id($modules)\n+    public function get_module_students_count($moduleId)\n     {\n-        if (!empty($modules)) {\n-            $module_set = $this->_DAO->build_set((array)$modules, false);\n-            return $this->_DAO->fetch_col(\"SELECT DISTINCT u.id_number AS staff_id\n-                      FROM \" . APP__DB_TABLE_PREFIX . \"user u\n-                      INNER JOIN \" . APP__DB_TABLE_PREFIX . \"user_module um ON u.user_id = um.user_id\n-                      WHERE um.module_id IN $module_set\n-                        AND um.user_type = '\" . APP__USER_TYPE_STUDENT . \"'\n-                      ORDER BY u.user_id ASC\");\n-        }\n-    }// /->get_module_students_id()\n+        $studentsCountQuery =\n+            'SELECT COUNT(DISTINCT u.user_id) AS user_count ' .\n+            'FROM ' . APP__DB_TABLE_PREFIX . 'user u ' .\n+            'INNER JOIN ' . APP__DB_TABLE_PREFIX . 'user_module um ' .\n+            'ON u.user_id = um.user_id ' .\n+            'WHERE um.module_id = ? ' .\n+            'AND um.user_type = ?';\n+\n+        return $this->dbConn->fetchOne($studentsCountQuery, [$moduleId, APP__USER_TYPE_STUDENT], [ParameterType::INTEGER, ParameterType::STRING]);\n+    }\n \n     /**\n      * Get an array of user IDs for students on the given modules (user_id = 'student_{studentID}'\n+     *\n      * @param array $modules modules to count students for\n-     * @return array\n+     *\n+     * @return array|void\n      */\n-    function get_module_students_user_id($modules)\n+    public function get_module_students_user_id($modules)\n     {\n-        if (!empty($modules)) {\n-            $module_set = $this->_DAO->build_set((array)$modules, false);\n-            $sql = \"SELECT DISTINCT u.user_id\n-          FROM \" . APP__DB_TABLE_PREFIX . \"user u\n-            INNER JOIN \" . APP__DB_TABLE_PREFIX . \"user_module um ON u.user_id = um.user_id\n-          WHERE um.module_id IN $module_set\n-            AND um.user_type = '\" . APP__USER_TYPE_STUDENT . \"'\n-          ORDER BY u.user_id ASC\n-          \";\n-            return $this->_DAO->fetch_col($sql);\n+        if (empty($modules)) {\n+            return;\n         }\n-    }// /->get_module_students_user_id()\n+\n+        $sql =\n+            'SELECT DISTINCT u.user_id ' .\n+            'FROM ' . APP__DB_TABLE_PREFIX . 'user u ' .\n+            'INNER JOIN ' . APP__DB_TABLE_PREFIX . 'user_module um ' .\n+            'ON u.user_id = um.user_id ' .\n+            'WHERE um.module_id IN (?) ' .\n+            'AND um.user_type = ? ' .\n+            'ORDER BY u.user_id ASC';\n+\n+        return $this->dbConn->fetchFirstColumn($sql, [$modules, APP__USER_TYPE_STUDENT], [$this->dbConn::PARAM_STR_ARRAY, ParameterType::STRING]);\n+    }\n \n     /**\n      * Get number of students on individual multiple modules, grouped by module\n      *\n      * @param array $modules modules to count students for\n      * @return array\n      */\n-    function get_module_grouped_students_count($modules)\n+    public function get_module_grouped_students_count($modules)\n     {\n-        $module_search = $this->_DAO->build_filter('module_id', (array)$modules, 'OR');\n+        $queryBuilder = $this->_DAO->getConnection()->createQueryBuilder();\n+\n+        $queryBuilder\n+            ->select('module_id', 'COUNT(user_id')\n+            ->from(APP__DB_TABLE_PREFIX . 'user_module', 'lcsm')\n+            ->where(\n+                $queryBuilder->expr()->in('module_id', '?')\n+            )\n+            ->groupBy('module_id')\n+            ->orderBy('module_id');\n \n-        return $this->_DAO->fetch_assoc(\"SELECT module_id, COUNT(user_id)\n-                    FROM \" . APP__DB_TABLE_PREFIX . \"user_module lcsm\n-                    WHERE $module_search\n-                    GROUP BY module_id\n-                    ORDER BY module_id\");\n-    }// ->get_modules_grouped_students_count()\n+        $queryBuilder->setParameter(0, $modules, $this->_DAO->getConnection()::PARAM_INT_ARRAY);\n+\n+        return $queryBuilder->execute()->fetchAllKeyValue();\n+    }\n \n     /*\n     * --------------------------------------------------------------------------------\n     * Staff Methods\n     * --------------------------------------------------------------------------------\n     */\n \n-    /**\n-     * Get staff info\n-     * Can work with either staff_id or staff_username alone (staff_id takes precedent)\n-     *\n-     * @param string/array $staff_id  staff ID(s) to search for (use NULL if searching on username)\n-     * @param string/array $staff_username  staff username(s) to search for\n-     * @param string $ordering ordering mode\n-     *\n-     * @return array either an assoc-array of staff member info or an array of assoc-arrays, containting many staff members' info\n-     */\n-    function get_staff($staff_id, $staff_username = null, $ordering = 'name')\n-    {\n-        if ($staff_id) {\n-            $staff_set = $this->_DAO->build_set($staff_id, false);\n-            $sql_WHERE = \"user_id IN $staff_set \";\n-        } else {\n-            if ($staff_username) {\n-                $staff_set = $this->_DAO->build_set($staff_username);\n-                $sql_WHERE = \"username IN $staff_set \";\n-            } else {\n-                return null;\n-            }\n-        }\n-\n-        $order_by_clause = $this->_order_by_clause('staff', $ordering);\n-\n-        // If there's more than one staff member to search for, get all the rows\n-        if ((is_array($staff_id)) || (is_array($staff_username))) {\n-            return $this->_DAO->fetch(\"SELECT lcs.*\n-                    FROM \" . APP__DB_TABLE_PREFIX . \"user lcs\n-                    WHERE $sql_WHERE\n-                    $order_by_clause\");\n-        } else {  // else, just return one row\n-            return $this->_DAO->fetch_row(\"SELECT lcs.*\n-                      FROM \" . APP__DB_TABLE_PREFIX . \"user lcs\n-                      WHERE $sql_WHERE\n-                      LIMIT 1\");\n-        }\n-    }// /->get_staff()\n-\n     /**\n      * Get array of modules for the given staff member(s)\n      * Can work with either staff_id or staff_username alone (staff_id takes precedent)\n@@ -261,12 +269,12 @@ function get_staff($staff_id, $staff_username = null, $ordering = 'name')\n      *\n      * @return array  an array of assoc-arrays, containting many module info\n      */\n-    function get_staff_modules($staff_id, $staff_username = null, $ordering = 'id')\n+    public function get_staff_modules($staff_id, $staff_username = null, $ordering = 'id')\n     {\n-\n         return $this->get_user_modules($staff_id, $staff_username, $ordering);\n+    }\n \n-    }// /->get_staff_modules\n+    // /->get_staff_modules\n \n     /**\n      * Is the given staff member associated with the given modules?\n@@ -275,66 +283,28 @@ function get_staff_modules($staff_id, $staff_username = null, $ordering = 'id')\n      * @param string/array $module_id  either a single module_id, or an array of module_ids\n      * @return integer\n      */\n-    function staff_has_module($staff_id, $module_id)\n+    public function staff_has_module($staff_id, $module_id)\n     {\n-        $module_id = (array)$module_id;\n+        $module_id = (array) $module_id;\n         $staff_modules = $this->get_staff_modules($staff_id);\n         if (!$staff_modules) {\n             return false;\n-        } else {\n-            $arr_module_id = ArrayFunctions::array_extract_column($staff_modules, 'module_id');\n-            $diff = array_diff($module_id, $arr_module_id);\n-\n-            // If the array is empty, then the staff member has those modules\n-            return (count(array_diff($module_id, $arr_module_id)) === 0);\n         }\n-    }// /->staff_has_module()\n+        $arr_module_id = ArrayFunctions::array_extract_column($staff_modules, 'module_id');\n+        $diff = array_diff($module_id, $arr_module_id);\n+\n+        // If the array is empty, then the staff member has those modules\n+        return count(array_diff($module_id, $arr_module_id)) === 0;\n+    }\n+\n+    // /->staff_has_module()\n \n     /*\n     * --------------------------------------------------------------------------------\n     * Student Methods\n     * --------------------------------------------------------------------------------\n     */\n \n-    /**\n-     * Get student info\n-     * Can work with either student_id or student_username alone (student_id takes precedent)\n-     *\n-     * @param string/array $student_id  student ID(s) to search for (use NULL if searching on username)\n-     * @param string/array $student_username  student\n-     * @param string $ordering ordering mode\n-     *\n-     * @returns  array either an assoc-array of student info or an array of assoc-arrays, containting many students info\n-     */\n-    function get_student($student_id = null, $student_username = null, $ordering = 'name')\n-    {\n-        if ($student_id) {\n-            $student_set = $this->_DAO->build_set($student_id, false);\n-            $sql_WHERE = \"user_id IN $student_set \";\n-        } else {\n-            if ($student_username) {\n-                $student_set = $this->_DAO->build_set($student_username);\n-                $sql_WHERE = \"username IN $student_set \";\n-            } else {\n-                return null;\n-            }\n-        }\n-\n-        // If there's more than one student to search for, get all the rows\n-        if ((is_array($student_id)) || (is_array($student_username))) {\n-            $order_by_clause = $this->_order_by_clause('student', $ordering);\n-            return $this->_DAO->fetch(\"SELECT lcs.*\n-                    FROM \" . APP__DB_TABLE_PREFIX . \"user lcs\n-                    WHERE $sql_WHERE\n-                    $order_by_clause\");\n-        } else {  // else, just return one row\n-            return $this->_DAO->fetch_row(\"SELECT lcs.*\n-                      FROM \" . APP__DB_TABLE_PREFIX . \"user lcs\n-                      WHERE $sql_WHERE\n-                      LIMIT 1\");\n-        }\n-    }// /->get_student()\n-\n     /**\n      * Get array of modules for the given student(s)\n      * Can work with either student_id or student_username alone (student_id takes precedent)\n@@ -345,12 +315,12 @@ function get_student($student_id = null, $student_username = null, $ordering = '\n      *\n      * @return array an array of module info arrays\n      */\n-    function get_student_modules($student_id, $student_username = null, $ordering = 'id')\n+    public function get_student_modules($student_id, $student_username = null, $ordering = 'id')\n     {\n-\n         return $this->get_user_modules($student_id, $student_username, $ordering);\n+    }\n \n-    }// /->get_student_modules()\n+    // /->get_student_modules()\n \n     /*\n     * --------------------------------------------------------------------------------\n@@ -366,34 +336,38 @@ function get_student_modules($student_id, $student_username = null, $ordering =\n      *\n      * @return object\n      */\n-    function get_user($user_id, $ordering = 'name')\n+    public function get_user($user_id, $ordering = 'name')\n     {\n-        $user_set = $this->_DAO->build_set($user_id, false);\n+        $queryBuilder = $this->dbConn->createQueryBuilder();\n \n         if (is_array($user_id)) {\n-            $order_by_clause = $this->_order_by_clause('user', $ordering);\n+            if ($ordering === 'id') {\n+                $queryBuilder->orderBy('u.user_id');\n+            } else {\n+                $queryBuilder->orderBy('u.lastname');\n+                $queryBuilder->addOrderBy('u.forename');\n+            }\n \n-            $sql = \"SELECT u.*, um.user_type\n-              FROM \" . APP__DB_TABLE_PREFIX . \"user u\n-              LEFT OUTER JOIN \" . APP__DB_TABLE_PREFIX . \"user_module um\n-              ON u.user_id = um.user_id\n-              WHERE (u.user_id IN {$user_set})\n-              AND (um.module_id = {$this->moduleId})\n-              $order_by_clause\";\n+            $queryBuilder\n+                ->select('u.*', 'um.user_type')\n+                ->from(APP__DB_TABLE_PREFIX . 'user', 'u')\n+                ->leftJoin('u', APP__DB_TABLE_PREFIX . 'user_module', 'um', 'u.user_id = um.user_id')\n+                ->where('u.user_id IN (?)')\n+                ->andWhere('um.module_id = ?')\n+                ->setParameter(0, $user_id, $this->dbConn::PARAM_INT_ARRAY)\n+                ->setParameter(1, $this->moduleId, ParameterType::INTEGER);\n \n-            return $this->_DAO->fetch($sql);\n-        } else {\n-            $sql = \"SELECT u.*, um.user_type\n-              FROM \" . APP__DB_TABLE_PREFIX . \"user u\n-              LEFT OUTER JOIN \" . APP__DB_TABLE_PREFIX . \"user_module um\n-              ON u.user_id = um.user_id\n-              WHERE (u.user_id IN {$user_set})\n-              AND (um.module_id = {$this->moduleId} OR u.admin = 1)\n-              LIMIT 1\";\n-\n-            return $this->_DAO->fetch_row($sql);\n+            return $queryBuilder->execute()->fetchAllAssociative();\n         }\n-    }// /->get_user()\n+        $query = 'SELECT u.*, um.user_type FROM ' . APP__DB_TABLE_PREFIX . 'user u '\n+                   . 'LEFT OUTER JOIN ' . APP__DB_TABLE_PREFIX . 'user_module um '\n+                   . 'ON u.user_id = um.user_id '\n+                   . 'WHERE u.user_id = ? '\n+                   . 'AND (um.module_id = ? OR u.admin = 1) '\n+                   . 'LIMIT 1';\n+\n+        return $this->dbConn->fetchAssociative($query, [$user_id, $this->moduleId], [ParameterType::INTEGER, ParameterType::INTEGER]);\n+    }\n \n     /**\n      * Get a user's info by searching on email address\n@@ -402,13 +376,12 @@ function get_user($user_id, $ordering = 'name')\n      *\n      * Returns : an assoc-array of user info\n      */\n-    function get_user_for_email($email)\n+    public function get_user_for_email($email)\n     {\n-        return $this->_DAO->fetch_row(\"SELECT scu.*\n-                     FROM \" . APP__DB_TABLE_PREFIX . \"user scu\n-                     WHERE email = '$email'\n-                     LIMIT 1\");\n-    }// /->get_user_for_email()\n+        $query = 'SELECT * FROM ' . APP__DB_TABLE_PREFIX . 'user WHERE email = ? LIMIT 1';\n+\n+        return $this->dbConn->fetchAssociative($query, [$email], [ParameterType::STRING]);\n+    }\n \n     /**\n      * Get a user's info by searching on username\n@@ -417,24 +390,25 @@ function get_user_for_email($email)\n      *\n      * Returns : an assoc-array of user info\n      */\n-    function get_user_for_username($username, $source_id = NULL)\n+    public function get_user_for_username($username, $source_id = null)\n     {\n-\n         if (is_null($source_id) && isset($_SESSION['_source_id'])) {\n             $source_id = $_SESSION['_source_id'];\n-        } else if (is_null($source_id)) {\n+        } elseif (is_null($source_id)) {\n             $source_id = '';\n         }\n         $this->moduleId = Common::fetch_SESSION('_module_id', null);\n \n-        $sql = 'SELECT u.*, um.user_type FROM ' . APP__DB_TABLE_PREFIX . 'user u LEFT OUTER JOIN ' .\n-            '  (SELECT * FROM ' . APP__DB_TABLE_PREFIX . \"user_module WHERE module_id = {$this->moduleId}) um \" .\n-            '  ON u.user_id = um.user_id ' .\n-            \"WHERE username = '{$username}' AND source_id = '{$source_id}'\";\n-\n-        return $this->_DAO->fetch_row($sql);\n+        $query = 'SELECT u.*, um.user_type FROM ' . APP__DB_TABLE_PREFIX . 'user u '\n+               . 'LEFT OUTER JOIN ( '\n+               . 'SELECT * FROM ' . APP__DB_TABLE_PREFIX . 'user_module WHERE module_id = ? '\n+               . ') um '\n+               . 'ON u.user_id = um.user_id '\n+               . 'WHERE username = ? '\n+               . 'AND source_id = ?';\n \n-    }// /->get_user_for_username()\n+        return $this->dbConn->fetchAssociative($query, [$this->moduleId, $username, $source_id], [ParameterType::INTEGER, ParameterType::STRING, ParameterType::STRING]);\n+    }\n \n     /**\n      * Get array of modules for the given user(s)\n@@ -446,102 +420,91 @@ function get_user_for_username($username, $source_id = NULL)\n      *\n      * @return array an array of module info arrays\n      */\n-    function get_user_modules($user_id, $username = NULL, $ordering = 'id', $source_id = NULL)\n+    public function get_user_modules($user_id, $username = null, $ordering = 'id', $source_id = null)\n     {\n+        $dbConn = $this->_DAO->getConnection();\n+        $queryBuilder = $dbConn->createQueryBuilder();\n \n         if (is_null($source_id) && isset($_SESSION['_source_id'])) {\n             $source_id = $_SESSION['_source_id'];\n-        } else if (is_null($source_id)) {\n+        } elseif (is_null($source_id)) {\n             $source_id = '';\n         }\n \n-        $order_by_clause = $this->_order_by_clause('module', $ordering);\n+        $queryBuilder->orderBy($ordering === 'name' ? 'lcm.module_title' : 'lcm.module_id');\n \n         if ($user_id) {\n-            $user_set = $this->_DAO->build_set($user_id, false);\n-            $sql = 'SELECT lcm.module_id, lcm.module_title, lcm.module_code, lcsm.user_type ' .\n-                'FROM ' . APP__DB_TABLE_PREFIX . 'module lcm INNER JOIN ' . APP__DB_TABLE_PREFIX . 'user_module lcsm ON lcm.module_id = lcsm.module_id ' .\n-                'INNER JOIN ' . APP__DB_TABLE_PREFIX . 'user u ON lcsm.user_id = u.user_id ' .\n-                \"WHERE ((lcm.source_id = '{$source_id}') OR (u.source_id <> '')) AND (lcsm.user_id IN {$user_set}) \" .\n-                \"{$order_by_clause}\";\n-        } else if ($username) {\n-            $user_set = $this->_DAO->build_set($username);\n-            $sql = 'SELECT lcm.module_id, lcm.module_title, lcm.module_code, lcsm.user_type ' .\n-                'FROM ' . APP__DB_TABLE_PREFIX . 'module lcm INNER JOIN ' . APP__DB_TABLE_PREFIX . 'user_module lcsm ON lcm.module_id = lcsm.module_id ' .\n-                'INNER JOIN ' . APP__DB_TABLE_PREFIX . 'user u ON lcsm.user_id = u.user_id ' .\n-                \"WHERE (u.source_id = '{$source_id}') AND (u.username IN {$user_set}) \" .\n-                \"{$order_by_clause}\";\n+            if (!is_array($user_id)) {\n+                $user_id = [$user_id];\n+            }\n+\n+            $queryBuilder\n+                ->select('lcm.module_id', 'lcm.module_title', 'lcm.module_code', 'lcsm.user_type')\n+                ->from(APP__DB_TABLE_PREFIX . 'module', 'lcm')\n+                ->innerJoin('lcm', APP__DB_TABLE_PREFIX . 'user_module', 'lcsm', 'lcm.module_id = lcsm.module_id')\n+                ->innerJoin('lcsm', APP__DB_TABLE_PREFIX . 'user', 'u', 'lcsm.user_id = u.user_id')\n+                ->where(\n+                    $queryBuilder->expr()->and(\n+                        $queryBuilder->expr()->or(\n+                            $queryBuilder->expr()->eq('lcm.source_id', '?'),\n+                            $queryBuilder->expr()->neq('u.source_id', '\"\"')\n+                        ),\n+                        $queryBuilder->expr()->in('lcsm.user_id', '?')\n+                    )\n+                );\n+\n+            $queryBuilder->setParameter(0, $source_id, ParameterType::STRING);\n+            $queryBuilder->setParameter(1, $user_id, $dbConn::PARAM_INT_ARRAY);\n+        } elseif ($username) {\n+            if (!is_array($username)) {\n+                $username = [$username];\n+            }\n+\n+            $queryBuilder\n+                ->select('lcm.module_id', 'lcm.module_title', 'lcm.module_code', 'lcsm.user_type')\n+                ->from(APP__DB_TABLE_PREFIX . 'module lcm')\n+                ->innerJoin('lcm', APP__DB_TABLE_PREFIX . 'user_module', 'lcsm', 'lcm.module_id = lcsm.module_id')\n+                ->innerJoin('lcsm', APP__DB_TABLE_PREFIX . 'user', 'u', 'lcsm.user_id = u.user_id')\n+                ->where('u.source_id = ?')\n+                ->andWhere('u.username IN (?)');\n+\n+            $queryBuilder->setParameter(0, $source_id);\n+            $queryBuilder->setParameter(1, $username, $dbConn::PARAM_INT_ARRAY);\n         } else {\n-            $sql = 'SELECT lcm.module_id, lcm.module_title, lcm.module_code, \\'' . APP__USER_TYPE_ADMIN . '\\' user_type ' .\n-                'FROM ' . APP__DB_TABLE_PREFIX . 'module lcm ' .\n-                \"WHERE (lcm.source_id = '{$source_id}') \" .\n-                \"{$order_by_clause}\";\n-        }\n+            $queryBuilder\n+                ->select('lcm.module_id', 'lcm.module_title', 'lcm.module_code', '\"' . APP__USER_TYPE_ADMIN . '\" as user_type')\n+                ->from(APP__DB_TABLE_PREFIX . 'module lcm')\n+                ->where('lcm.source_id = ?');\n \n-        return $this->_DAO->fetch_assoc($sql);\n+            $queryBuilder->setParameter(0, $source_id);\n+        }\n \n-    }// /->get_user_modules\n+        return $queryBuilder->execute()->fetchAllAssociativeIndexed();\n+    }\n \n     /*\n     * ================================================================================\n     * Private Methods\n     * ================================================================================\n     */\n \n-    /**\n-     * Return an ORDER BY clause matching the given parameters\n-     *\n-     * @param string $row_type type of row being ordered. ['course','module','staff','student']\n-     * @param string $ordering type of ordering to do. ['id','name']\n-     *\n-     * @return string  SQL ORDER BY clause of the form 'ORDER BY fieldname' or NULL if row_type/ordering are invalid\n-     */\n-    function _order_by_clause($row_type, $ordering = null)\n-    {\n-        if (!is_array($this->_ordering_types)) {\n-            // All available ordering types\n-            $this->_ordering_types = array(\n-                'module' => array(\n-                    'id' => 'lcm.module_id',\n-                    'name' => 'lcm.module_title',\n-                ),\n-                'staff' => array(\n-                    'id' => 'lcs.user_id',\n-                    'name' => 'lcs.lastname, lcs.forename',\n-                ),\n-                'student' => array(\n-                    'id' => 'lcs.user_id',\n-                    'name' => 'lcs.lastname, lcs.forename',\n-                ),\n-                'user' => array(\n-                    'id' => 'u.user_id',\n-                    'name' => 'u.lastname, u.forename',\n-                ),\n-            );\n-        }\n-\n-        if ((array_key_exists($row_type, $this->_ordering_types)) && (array_key_exists($ordering, $this->_ordering_types[\"$row_type\"]))) {\n-            return 'ORDER BY ' . $this->_ordering_types[\"$row_type\"][\"$ordering\"];\n-        } else {\n-            return null;\n-        }\n-    }// /->_order_by_clause()\n-\n-    function get_user_academic_years($user_id = null)\n+    public function get_user_academic_years($user_id = null)\n     {\n         if (!empty($user_id)) {\n-            $sql = 'SELECT MIN(a.open_date) first, MAX(a.open_date) last ' .\n+            $query = 'SELECT MIN(a.open_date) first, MAX(a.open_date) last ' .\n                 'FROM ' . APP__DB_TABLE_PREFIX . 'assessment a ' .\n                 'INNER JOIN ' . APP__DB_TABLE_PREFIX . 'module m ON a.module_id = m.module_id ' .\n-                \"WHERE m.source_id = '{$this->sourceId}' AND m.module_id = '{$this->moduleId}'\";\n+                'WHERE m.source_id = ? AND m.module_id = ?';\n+\n+            $dates = $this->dbConn->fetchAssociative($query, [$this->sourceId, $this->moduleId], [ParameterType::STRING, ParameterType::INTEGER]);\n         } else {\n-            $sql = 'SELECT MIN(a.open_date) first, MAX(a.open_date) last ' .\n+            $query = 'SELECT MIN(a.open_date) first, MAX(a.open_date) last ' .\n                 'FROM ' . APP__DB_TABLE_PREFIX . 'assessment a ' .\n                 'INNER JOIN ' . APP__DB_TABLE_PREFIX . 'module m ON a.module_id = m.module_id ' .\n-                \"WHERE m.source_id = '{$this->sourceId}'\";\n-        }\n+                'WHERE m.source_id = ?';\n \n-        $dates = $this->_DAO->fetch_row($sql);\n+            $dates = $this->dbConn->fetchAssociative($query, [$this->sourceId], [ParameterType::STRING]);\n+        }\n \n         // Ensure that the first record contains some dates as we could return a null record\n         if (!empty($dates['first'])) {\n@@ -554,7 +517,4 @@ function get_user_academic_years($user_id = null)\n \n         return $years;\n     }\n-\n-}// /class: EngCIS\n-\n-?>\n+}"
        },
        {
          "filename": "src/includes/classes/Form.php",
          "status": "modified",
          "additions": 341,
          "deletions": 257,
          "patch": "@@ -10,291 +10,375 @@\n \n namespace WebPA\\includes\\classes;\n \n+use Doctrine\\DBAL\\ParameterType;\n use WebPA\\includes\\functions\\Common;\n \n-include_once __DIR__ . '/../inc_global.php';\n-\n-class Form {\n-  // Public Vars\n-  public $id = null;\n-  public $name = '';\n-  public $modules = null;\n-  public $type = null;\n-\n-  // Private Vars\n-  private $_DAO = null;\n-  private $_questions = null;\n-  private $_xml_parser = null;\n-\n-  /*\n-  * CONSTRUCTOR\n-  *\n-  * @param mixed $DAO\n-  */\n-  function __construct(&$DAO) {\n-    $this->_DAO =& $DAO;\n-  }// /->Form()\n+class Form\n+{\n+    // Public Vars\n+    public $id;\n \n-/*\n-* ================================================================================\n-* Public Methods\n-* ================================================================================\n-*/\n+    public $name = '';\n \n-/*\n-* --------------------------------------------------------------------------------\n-* Load/Save Functions\n-* --------------------------------------------------------------------------------\n-*/\n+    public $modules;\n+\n+    public $type;\n \n-  /**\n-  * Create a new form ID\n-  */\n-  function create() {\n-    // generate a new form_id\n-    while (true) {\n-      $new_id = Common::uuid_create();\n-      if ($this->_DAO->fetch_value(\"SELECT COUNT(form_id) FROM \" . APP__DB_TABLE_PREFIX . \"form WHERE form_id = '$new_id'\") == 0) { break; }\n+    // Private Vars\n+    private DAO $_DAO;\n+\n+    private $_questions;\n+\n+    private $_xml_parser;\n+\n+    /*\n+    * CONSTRUCTOR\n+    *\n+    * @param mixed $DAO\n+    */\n+    public function __construct(DAO $DAO)\n+    {\n+        $this->_DAO =& $DAO;\n     }\n-    $this->id = $new_id;\n-  }// ->create()\n-\n-  /**\n-  * Delete this Group (and all its members)\n-  */\n-  function delete() {\n-\n-    $_module_id = Common::fetch_SESSION('_module_id', null);\n-\n-    $this->_DAO->execute(\"DELETE FROM \" . APP__DB_TABLE_PREFIX . \"form_module WHERE (form_id = '{$this->id}') AND (module_id = {$_module_id})\");\n-    $this->_DAO->execute(\"DELETE FROM \" . APP__DB_TABLE_PREFIX . \"form WHERE form_id = '{$this->id}'\");\n-\n-    return true;\n-\n-  }// /->delete()\n-\n-  /**\n-  * Load the Form from the database\n-  *\n-  * @param string $id  id of Group to load\n-  * @return boolean did load succeed\n-  */\n-  function load($id) {\n-    $row = $this->_DAO->fetch_row(\"SELECT * FROM \" . APP__DB_TABLE_PREFIX . \"form f WHERE f.form_id = '$id'\");\n-    return ($row) ? $this->load_from_row($row) : false;\n-  }// /->load()\n-\n-  /**\n-  * Load the Form from an array row\n-  *\n-  *\n-  * @param array $row assoc array ( field => value, ... ) - corresponds to row in database\n-  * @return boolean  did load succeed\n-  */\n-  function load_from_row(&$row) {\n-    $this->id = $row['form_id'];\n-    $this->name = $row['form_name'];\n-    $this->type = (is_null($row['form_type'])) ? 'likert' : $row['form_type'];\n-    $this->_load_xml($row['form_xml']);\n-    return true;\n-  }// /->load_from_row()\n-\n-  /**\n-  * Load the Form from xml\n-  *\n-  * @param string $xml xml fragment to load\n-   *\n-  * @return boolean did load succeed\n-  */\n-  function load_from_xml($xml) {\n-    $this->_load_xml($xml);\n-\n-    return true;\n-  }\n-\n-  /**\n-  * Save this Form\n-  * @return boolean did save succeed\n-  */\n-  function save() {\n-    if (!$this->id) {\n-      return false;\n-    } else {\n-      // Actually create and save the xml\n-      $form_xml = $this->_DAO->escape_str($this->get_xml());\n-\n-      // Save the Form\n-      $this->_DAO->execute('INSERT INTO ' . APP__DB_TABLE_PREFIX . 'form (form_id, form_name, form_type, form_xml) ' .\n-         \"VALUES ('{$this->id}', '\" . $this->_DAO->escape_str($this->name) . \"', '\" . $this->_DAO->escape_str($this->type) . \"', '') \" .\n-         \"ON DUPLICATE KEY UPDATE form_name = '\" . $this->_DAO->escape_str($this->name) . \"', form_type = '\" . $this->_DAO->escape_str($this->type) . \"'\");\n-      $this->_DAO->execute('UPDATE ' . APP__DB_TABLE_PREFIX . \"form SET form_xml = '{$form_xml}' WHERE form_id = '{$this->id}'\");\n-\n-      if ($this->modules !== null && count($this->modules) > 0) {\n-        $values = array();\n-        foreach($this->modules as $module_id) {\n-          $values[] = \"('{$this->id}', {$module_id})\";\n+\n+    /*\n+    * ================================================================================\n+    * Public Methods\n+    * ================================================================================\n+    */\n+\n+    /*\n+    * --------------------------------------------------------------------------------\n+    * Load/Save Functions\n+    * --------------------------------------------------------------------------------\n+    */\n+\n+    /**\n+    * Create a new form ID\n+    */\n+    public function create()\n+    {\n+        // generate a new form_id\n+        while (true) {\n+            $new_id = Common::uuid_create();\n+\n+            $existingFormIdQuery =\n+          'SELECT COUNT(form_id) ' .\n+          'FROM ' . APP__DB_TABLE_PREFIX . 'form ' .\n+          'WHERE form_id = ?';\n+\n+            $formIdCount = $this->_DAO->getConnection()->fetchOne($existingFormIdQuery, [$new_id], [ParameterType::STRING]);\n+\n+            if ($formIdCount == 0) {\n+                break;\n+            }\n         }\n-        $sql = 'INSERT INTO ' . APP__DB_TABLE_PREFIX . 'form_module (form_id, module_id) VALUES ' . implode(', ', $values);\n-        $this->_DAO->execute($sql);\n-      }\n+        $this->id = $new_id;\n+    }\n+\n+    // ->create()\n+\n+    /**\n+    * Delete this Group (and all its members)\n+    */\n+    public function delete()\n+    {\n+        $_module_id = Common::fetch_SESSION('_module_id', null);\n \n-      return true;\n+        $dbConn = $this->_DAO->getConnection();\n+\n+        $dbConn->executeQuery(\n+            'DELETE FROM ' . APP__DB_TABLE_PREFIX . 'form_module WHERE form_id = ? AND module_id = ?',\n+            [$this->id, $_module_id],\n+            [ParameterType::STRING, ParameterType::INTEGER]\n+        );\n+\n+        $dbConn->executeQuery(\n+            'DELETE FROM ' . APP__DB_TABLE_PREFIX . 'form WHERE form_id = ?',\n+            [$this->id],\n+            [ParameterType::STRING]\n+        );\n+\n+        return true;\n     }\n-  }// /->save()\n \n-/*\n-* --------------------------------------------------------------------------------\n-* Other Methods\n-* --------------------------------------------------------------------------------\n-*/\n+    /**\n+    * Load the Form from the database\n+    *\n+    * @param string $id  id of Group to load\n+     *\n+    * @return boolean did load succeed\n+    */\n+    public function load($id)\n+    {\n+        $dbConn = $this->_DAO->getConnection();\n \n-  /**\n-  * Create a clone of this form\n-  * @return mixed returns the clone of the form\n-  */\n-  function & get_clone() {\n-    $clone_form = new self($this->_DAO);\n-    $clone_form->create();  // Changes the form's ID so it is officially a new form\n-    $temp_id = $clone_form->id;\n-    $clone_form->load_from_xml($this->get_xml()); // Creates an EXACT clone of the existing form\n-    $clone_form->id = $temp_id;\n-    return $clone_form;\n-  }// /->get_clone()\n+        $query = 'SELECT * FROM ' . APP__DB_TABLE_PREFIX . 'form  WHERE form_id = ?';\n \n-/*\n-* --------------------------------------------------------------------------------\n-* Question Manipulation Methods\n-* --------------------------------------------------------------------------------\n-*/\n+        $form = $dbConn->fetchAssociative($query, [$id], [ParameterType::STRING]);\n+\n+        return $form ? $this->load_from_row($form) : false;\n+    }\n+\n+    /**\n+    * Load the Form from an array row\n+    *\n+    *\n+    * @param array $row assoc array ( field => value, ... ) - corresponds to row in database\n+    * @return boolean  did load succeed\n+    */\n+    public function load_from_row(&$row)\n+    {\n+        $this->id = $row['form_id'];\n+        $this->name = $row['form_name'];\n+        $this->type = (is_null($row['form_type'])) ? 'likert' : $row['form_type'];\n+        $this->_load_xml($row['form_xml']);\n+\n+        return true;\n+    }\n+\n+    // /->load_from_row()\n+\n+    /**\n+    * Load the Form from xml\n+    *\n+    * @param string $xml xml fragment to load\n+     *\n+    * @return boolean did load succeed\n+    */\n+    public function load_from_xml($xml)\n+    {\n+        $this->_load_xml($xml);\n+\n+        return true;\n+    }\n+\n+    /**\n+    * Save this Form\n+    * @return boolean did save succeed\n+    */\n+    public function save()\n+    {\n+        if (!$this->id) {\n+            return false;\n+        }\n+        // Actually create and save the xml\n+        $form_xml = $this->get_xml();\n+\n+        // Save the Form\n+        $dbConn = $this->_DAO->getConnection();\n+\n+        $insertFormQuery =\n+        'INSERT INTO ' . APP__DB_TABLE_PREFIX . 'form ' .\n+        '(form_id, form_name, form_type, form_xml) ' .\n+        'VALUES (?, ?, ?, \"\") ' .\n+        'ON DUPLICATE KEY UPDATE ' .\n+        'form_name = ?, ' .\n+        'form_type = ?';\n+\n+        $dbConn->executeQuery(\n+                $insertFormQuery,\n+                [$this->id, $this->name, $this->type, $this->name, $this->type],\n+                [ParameterType::STRING, ParameterType::STRING, ParameterType::STRING, ParameterType::STRING, ParameterType::STRING]\n+            );\n+\n+        $dbConn->executeQuery(\n+                'UPDATE ' . APP__DB_TABLE_PREFIX . 'form SET form_xml = ? WHERE form_id = ?',\n+                [$form_xml, $this->id],\n+                [ParameterType::STRING, ParameterType::STRING]\n+            );\n+\n+        if ($this->modules !== null && count($this->modules) > 0) {\n+            foreach ($this->modules as $module_id) {\n+                $dbConn->executeQuery(\n+                        'INSERT INTO ' . APP__DB_TABLE_PREFIX . 'form_module (form_id, module_id) VALUES (?, ?)',\n+                        [$this->id, $module_id],\n+                        [ParameterType::STRING, ParameterType::INTEGER]\n+                    );\n+            }\n+        }\n \n-  /**\n-  * Add a question to this form\n-  * @param array $question_array\n-  */\n-  function add_question($question_array) {\n-    if ($this->get_question_count()>0) {\n-      $this->_questions[] = $question_array;\n-    } else {\n-      $this->_questions[0] = $question_array;\n+        return true;\n     }\n-  }// /->add_question()\n-\n-  /**\n-  * Get an individual question's info\n-  * @param integer $index\n-  * @return array Questions at the point in the array\n-  */\n-  function get_question($index) {\n-    $index = (int) $index;\n-    if (array_key_exists($index, (array) $this->_questions)) {\n-      return $this->_questions[$index];\n+\n+    /*\n+    * --------------------------------------------------------------------------------\n+    * Other Methods\n+    * --------------------------------------------------------------------------------\n+    */\n+\n+    /**\n+    * Create a clone of this form\n+    * @return mixed returns the clone of the form\n+    */\n+    public function & get_clone()\n+    {\n+        $clone_form = new self($this->_DAO);\n+        $clone_form->create();  // Changes the form's ID so it is officially a new form\n+        $temp_id = $clone_form->id;\n+        $clone_form->load_from_xml($this->get_xml()); // Creates an EXACT clone of the existing form\n+        $clone_form->id = $temp_id;\n+        return $clone_form;\n     }\n-  }// /->get_question()\n-\n-  /**\n-  * Get a count of the number of questions\n-  * @return integer result of the count of the number of questions\n-  */\n-  function get_question_count() {\n-    $result = 0;\n-    if (is_array($this->_questions)) {\n-      $result = count($this->_questions);\n+\n+    // /->get_clone()\n+\n+    /*\n+    * --------------------------------------------------------------------------------\n+    * Question Manipulation Methods\n+    * --------------------------------------------------------------------------------\n+    */\n+\n+    /**\n+    * Add a question to this form\n+    * @param array $question_array\n+    */\n+    public function add_question($question_array)\n+    {\n+        if ($this->get_question_count()>0) {\n+            $this->_questions[] = $question_array;\n+        } else {\n+            $this->_questions[0] = $question_array;\n+        }\n     }\n-    return  $result;\n-  }// /->get_question_count()\n-\n-  /**\n-  * Set an individual question's info\n-  * @param integer $index\n-  * @param array $question_array\n-  */\n-  function set_question($index, $question_array) {\n-    $index = (int) $index;\n-    $this->_questions[$index] = $question_array;\n-  }// /->set_question()\n-\n-  /**\n-  * Remove a question from this form\n-  * @param integer $index\n-  */\n-  function remove_question($index) {\n-    $index = (int) $index;\n-    if (array_key_exists($index, (array) $this->_questions)) {\n-      unset($this->_questions[$index]);\n-      $this->_questions = array_values($this->_questions);\n+\n+    // /->add_question()\n+\n+    /**\n+    * Get an individual question's info\n+    * @param integer $index\n+    * @return array Questions at the point in the array\n+    */\n+    public function get_question($index)\n+    {\n+        $index = (int) $index;\n+        if (array_key_exists($index, (array) $this->_questions)) {\n+            return $this->_questions[$index];\n+        }\n     }\n-  }// /->remove_question()\n \n-/*\n-* --------------------------------------------------------------------------------\n-* XML Methods\n-* --------------------------------------------------------------------------------\n-*/\n+    // /->get_question()\n+\n+    /**\n+    * Get a count of the number of questions\n+    * @return integer result of the count of the number of questions\n+    */\n+    public function get_question_count()\n+    {\n+        $result = 0;\n+        if (is_array($this->_questions)) {\n+            $result = count($this->_questions);\n+        }\n+        return  $result;\n+    }\n \n-  /**\n-  * Get the xml representation of this form\n-  * @return string xml fragment (no <?xml ?> starting tag)\n-  */\n-  function get_xml() {\n-    if (!is_object($this->_xml_parser)) { $this->_xml_parser = new XMLParser(); }\n-\n-    // Create an array representation of the form's xml\n-    $xml_array['form']['formid']['_data'] = $this->id;\n-    $xml_array['form']['formname']['_data'] = $this->name;\n-    $xml_array['form']['formtype']['_data'] = $this->type;\n-\n-    // Add any questions to the xml\n-    if ($this->get_question_count()>0) {\n-      foreach ($this->_questions as $i => $question) {\n-        $question_desc = (array_key_exists('desc', $question)) ? $question['desc']['_data'] : '' ;\n-        $new_question = array ('questionid' => 'Q'.($i+1) ,\n-                     'text'       => $question['text']['_data'] ,\n-                     'desc'       => $question_desc ,);\n-\n-        $questions_to_save[] = $new_question;\n-      }\n-      $xml_array['form']['question'] = $this->_questions;\n+    // /->get_question_count()\n+\n+    /**\n+    * Set an individual question's info\n+    * @param integer $index\n+    * @param array $question_array\n+    */\n+    public function set_question($index, $question_array)\n+    {\n+        $index = (int) $index;\n+        $this->_questions[$index] = $question_array;\n     }\n \n-    $this->_xml_parser->set_cdata_tags('desc');\n-    return $this->_xml_parser->generate_xml($xml_array);\n-  }// /->get_xml()\n-\n-  /**\n-  * Load the xml data of the form (questions, etc)\n-  * @param mixed $xml_data\n-  */\n-  function _load_xml(&$xml_data) {\n-    if (!is_object($this->_xml_parser)) { $this->_xml_parser = new XMLParser(); }\n-    $xml_array = $this->_xml_parser->parse($xml_data);\n-\n-    // Load form properties\n-    $this->id = $xml_array['form']['formid']['_data'];\n-    $this->name = $xml_array['form']['formname']['_data'];\n-    $this->type =  (array_key_exists('formtype', $xml_array['form'])) ? $xml_array['form']['formtype']['_data'] : 'likert';\n-\n-    // Load the questions\n-    if ( (is_array($xml_array['form'])) && (array_key_exists('question',$xml_array['form'])) ) {\n-      $temp_questions =& $xml_array['form']['question'];\n-      if ($temp_questions) {\n-        // If there's only one question, make sure the array is restructured properly\n-        if ( (is_array($temp_questions)) && (array_key_exists(0, $temp_questions)) ) {\n-          $this->_questions =& $temp_questions;\n+    // /->set_question()\n+\n+    /**\n+    * Remove a question from this form\n+    * @param integer $index\n+    */\n+    public function remove_question($index)\n+    {\n+        $index = (int) $index;\n+        if (array_key_exists($index, (array) $this->_questions)) {\n+            unset($this->_questions[$index]);\n+            $this->_questions = array_values($this->_questions);\n+        }\n+    }\n+\n+    // /->remove_question()\n+\n+    /*\n+    * --------------------------------------------------------------------------------\n+    * XML Methods\n+    * --------------------------------------------------------------------------------\n+    */\n+\n+    /**\n+    * Get the xml representation of this form\n+    * @return string xml fragment (no <?xml ?> starting tag)\n+    */\n+    public function get_xml()\n+    {\n+        if (!is_object($this->_xml_parser)) {\n+            $this->_xml_parser = new XMLParser();\n+        }\n+\n+        // Create an array representation of the form's xml\n+        $xml_array['form']['formid']['_data'] = $this->id;\n+        $xml_array['form']['formname']['_data'] = $this->name;\n+        $xml_array['form']['formtype']['_data'] = $this->type;\n+\n+        // Add any questions to the xml\n+        if ($this->get_question_count()>0) {\n+            foreach ($this->_questions as $i => $question) {\n+                $question_desc = (array_key_exists('desc', $question)) ? $question['desc']['_data'] : '' ;\n+                $new_question = ['questionid' => 'Q'.($i+1),\n+                     'text'       => $question['text']['_data'],\n+                     'desc'       => $question_desc, ];\n+\n+                $questions_to_save[] = $new_question;\n+            }\n+            $xml_array['form']['question'] = $this->_questions;\n+        }\n+\n+        $this->_xml_parser->set_cdata_tags('desc');\n+        return $this->_xml_parser->generate_xml($xml_array);\n+    }\n+\n+    // /->get_xml()\n+\n+    /**\n+    * Load the xml data of the form (questions, etc)\n+    * @param mixed $xml_data\n+    */\n+    public function _load_xml(&$xml_data)\n+    {\n+        if (!is_object($this->_xml_parser)) {\n+            $this->_xml_parser = new XMLParser();\n+        }\n+        $xml_array = $this->_xml_parser->parse($xml_data);\n+\n+        // Load form properties\n+        $this->id = $xml_array['form']['formid']['_data'];\n+        $this->name = $xml_array['form']['formname']['_data'];\n+        $this->type =  (array_key_exists('formtype', $xml_array['form'])) ? $xml_array['form']['formtype']['_data'] : 'likert';\n+\n+        // Load the questions\n+        if ((is_array($xml_array['form'])) && (array_key_exists('question', $xml_array['form']))) {\n+            $temp_questions =& $xml_array['form']['question'];\n+            if ($temp_questions) {\n+                // If there's only one question, make sure the array is restructured properly\n+                if ((is_array($temp_questions)) && (array_key_exists(0, $temp_questions))) {\n+                    $this->_questions =& $temp_questions;\n+                } else {\n+                    $this->_questions[] =& $temp_questions;\n+                }\n+            }\n         } else {\n-          $this->_questions[] =& $temp_questions;\n+            $this->_questions = null;\n         }\n-      }\n-    } else {\n-      $this->_questions = null;\n     }\n-  }// /->_load_xml()\n+\n+    // /->_load_xml()\n \n /*\n * ================================================================================\n * Private Methods\n * ================================================================================\n */\n-\n }// /class: Form\n-\n-?>"
        },
        {
          "filename": "src/includes/classes/FormRenderer.php",
          "status": "modified",
          "additions": 200,
          "deletions": 193,
          "patch": "@@ -12,96 +12,110 @@\n \n use WebPA\\includes\\functions\\Common;\n \n-class FormRenderer {\n-  // Public Vars\n-  public $participant_name = '';\n-  public $participant_id = null;\n-  public $assessment_feedback = '0';\n-  public $assessment_feedback_title;\n-\n-  // Private Vars\n-  private $_form = null;\n-  private $_questions = null;\n-  private $_participants = null;\n-  private $_results = null;\n-\n-  /*\n-  * CONSTRUCTOR\n-  */\n-  function __construct() {\n-  }// /->FormRenderer()\n+class FormRenderer\n+{\n+    // Public Vars\n+    public $participant_name = '';\n \n-/*\n-* ================================================================================\n-* Public Methods\n-* ================================================================================\n-*/\n+    public $participant_id;\n+\n+    public $assessment_feedback = '0';\n+\n+    public $assessment_feedback_title;\n+\n+    // Private Vars\n+    private $_form;\n+\n+    private $_questions;\n+\n+    private $_participants;\n+\n+    private $_results;\n+\n+    // CONSTRUCTOR\n+    public function __construct()\n+    {\n+    }\n+\n+    // /->FormRenderer()\n+\n+    /*\n+    * ================================================================================\n+    * Public Methods\n+    * ================================================================================\n+    */\n+\n+    /*\n+    * Set the form to render\n+    *\n+    * @param object $form_object  form object to use when rendering\n+    */\n+    public function set_form(&$form_object)\n+    {\n+        $this->_form =& $form_object;\n+    }\n+\n+    // /->set_form()\n+\n+    /**\n+     * Set the participants\n+     * @param array $participants_array\n+    */\n+    public function set_participants($participants_array)\n+    {\n+        $this->_participants = $participants_array;\n+    }\n+\n+    // /->set_participants()\n+\n+    /**\n+    * Set the results to display\n+    *\n+    * @param array $results results to load\n+    *\n+    */\n+    public function set_results($results_array)\n+    {\n+        $this->_results = $results_array;\n+    }\n \n-  /*\n-  * Set the form to render\n-  *\n-  * @param object $form_object  form object to use when rendering\n-  */\n-  function set_form(&$form_object) {\n-    $this->_form =& $form_object;\n-  }// /->set_form()\n-\n-  /**\n-   * Set the participants\n-   * @param array $participants_array\n-  */\n-  function set_participants($participants_array) {\n-\n-    $this->_participants = $participants_array;\n-  }// /->set_participants()\n-\n-  /**\n-  * Set the results to display\n-  *\n-  * @param array $results results to load\n-  *\n-  */\n-  function set_results($results_array) {\n-    $this->_results = $results_array;\n-  }// /->set_results()\n-\n-  /**\n-   * Draw the <head> section for this form\n-   */\n-  function draw_description() {\n-    if ($this->_form->type =='split100') {\n-\n-      $participant_count = count($this->_participants);\n-      $remainder = 100 % $participant_count;\n-      $group_total = 100 - $remainder;\n-      $default_score = floor(100 / $participant_count);\n-\n-      ?>\n-      <p>For each criterion you have <?php echo($group_total); ?> marks to split between your teammates.  If everyone contributed equally, then everyone should receive the same score, <?php echo($default_score); ?> marks.  However, you can take points away from teammates who performed poorly, and re-allocate them to those you thought performed better.</p>\n-\n-      <p>For each criterion, the total number of marks you allocate must equal <?php echo($group_total); ?>.</p>\n+    // /->set_results()\n+\n+    /**\n+     * Draw the <head> section for this form\n+     */\n+    public function draw_description()\n+    {\n+        if ($this->_form->type =='split100') {\n+            $participant_count = count($this->_participants);\n+            $remainder = 100 % $participant_count;\n+            $group_total = 100 - $remainder;\n+            $default_score = floor(100 / $participant_count); ?>\n+      <p>For each criterion you have <?php echo $group_total; ?> marks to split between your teammates.  If everyone contributed equally, then everyone should receive the same score, <?php echo $default_score; ?> marks.  However, you can take points away from teammates who performed poorly, and re-allocate them to those you thought performed better.</p>\n+\n+      <p>For each criterion, the total number of marks you allocate must equal <?php echo $group_total; ?>.</p>\n       <?php\n-    } else {\n-      ?>\n+        } else {\n+            ?>\n       <p>For each criterion you must rate your teammates using the scale provided.  High <?php echo APP__MARK_TEXT; ?> indicate better performance in the criteria.</p>\n       <?php\n+        }\n     }\n-  }// /->draw_description()\n-\n-  /**\n-   * Draw the <head> section for this form\n-   */\n-  function draw_head() {\n-    if ($this->_form->type =='split100') {\n \n-      $participant_count = count($this->_participants);\n-      $remainder = 100 % $participant_count;\n-      $group_total = 100 - $remainder;\n-\n-      ?>\n+    // /->draw_description()\n+\n+    /**\n+     * Draw the <head> section for this form\n+     */\n+    public function draw_head()\n+    {\n+        if ($this->_form->type =='split100') {\n+            $participant_count = count($this->_participants);\n+            $remainder = 100 % $participant_count;\n+            $group_total = 100 - $remainder; ?>\n       <script type=\"text/javascript\"><!--\n \n-        var group_total = <?php echo($group_total); ?>;\n+        var group_total = <?php echo $group_total; ?>;\n \n         function calcTotal(q_id, participant_count) {\n           var total_obj = document.getElementById('total_'+q_id);\n@@ -155,186 +169,179 @@ function calcTotal(q_id, participant_count) {\n       // -->\n       </script>\n       <?php\n+        }\n     }\n-  }// /->draw_head()\n \n-  /**\n-   * Function to draw the form\n-  */\n-  function draw_form() {\n-    $question_count = $this->_form->get_question_count();\n+    // /->draw_head()\n \n-    //\n-    if ($this->_form->type=='split100') {\n+    /**\n+     * Function to draw the form\n+    */\n+    public function draw_form()\n+    {\n+        $question_count = $this->_form->get_question_count();\n \n-      $participant_count = count($this->_participants);\n-      $remainder = 100 % $participant_count;\n-      $group_total = 100 - $remainder;\n-      $default_score = floor(100 / $participant_count);\n+        \n+        if ($this->_form->type=='split100') {\n+            $participant_count = count($this->_participants);\n+            $remainder = 100 % $participant_count;\n+            $group_total = 100 - $remainder;\n+            $default_score = floor(100 / $participant_count);\n \n-      for ($q=0; $q<$question_count; $q++) {\n-        $question = $this->_form->get_question($q);\n+            for ($q=0; $q<$question_count; $q++) {\n+                $question = $this->_form->get_question($q);\n \n-        $q_num = $q + 1;\n-?>\n+                $q_num = $q + 1; ?>\n         <div class=\"question\">\n \n-          <div class=\"question_text\"><?php echo(\"{$q_num}. {$question['text']['_data']}\"); ?></div>\n+          <div class=\"question_text\"><?php echo \"{$q_num}. {$question['text']['_data']}\"; ?></div>\n <?php\n         if (array_key_exists('desc', $question)) {\n-          $question_desc = (array_key_exists('desc', $question)) ? $question['desc']['_data'] : '' ;\n-          echo(\"<div>$question_desc</div>\");\n-        }\n-?>\n+            $question_desc = (array_key_exists('desc', $question)) ? $question['desc']['_data'] : '' ;\n+            echo \"<div>$question_desc</div>\";\n+        } ?>\n \n           <div class=\"info_box\" style=\"float: right; width: 250px; margin: 2em 2em 0 2em; font-size: 0.9em;\">\n <?php\n         if ($remainder==0) {\n-?>\n-              <p>You have <span style=\"font-weight: bold;\"><?php echo($group_total); ?> marks</span> to divide between your teammates.</p>\n+            ?>\n+              <p>You have <span style=\"font-weight: bold;\"><?php echo $group_total; ?> marks</span> to divide between your teammates.</p>\n <?php\n         } else {\n-?>\n-              <p>For a group of <?php echo($participant_count); ?>, you have <span style=\"font-weight: bold;\"><?php echo($group_total); ?> marks</span> to divide between your teammates.</p>\n+            ?>\n+              <p>For a group of <?php echo $participant_count; ?>, you have <span style=\"font-weight: bold;\"><?php echo $group_total; ?> marks</span> to divide between your teammates.</p>\n <?php\n-        }\n-?>\n-            <p style=\"font-weight: bold;\">For equal performance, every student should receive <?php echo($default_score); ?> marks.</p>\n+        } ?>\n+            <p style=\"font-weight: bold;\">For equal performance, every student should receive <?php echo $default_score; ?> marks.</p>\n           </div>\n \n           <table class=\"question_grid\" cellpadding=\"3\" cellspacing=\"1\">\n <?php\n         // header row\n-        echo('<tr><td style=\"background-color: transparent\">&nbsp;</td><th align=\"center\">score</th></tr>');\n+        echo '<tr><td style=\"background-color: transparent\">&nbsp;</td><th align=\"center\">score</th></tr>';\n \n-        // show participant rows\n-        $initial_total = 0;\n-        $index = 1;\n+                // show participant rows\n+                $initial_total = 0;\n+                $index = 1;\n \n-        foreach($this->_participants as $id => $name) {\n-          $class = ($id==$this->participant_id) ? 'class=\"this_participant\"' : '';\n+                foreach ($this->_participants as $id => $name) {\n+                    $class = ($id==$this->participant_id) ? 'class=\"this_participant\"' : '';\n \n-          $score = Common::fetch_POST(\"q_{$q}_{$id}\");\n+                    $score = Common::fetch_POST(\"q_{$q}_{$id}\");\n \n-          $initial_total += $score;\n+                    $initial_total += (int) $score;\n \n-          echo(\"<tr id=\\\"q_{$q}_{$id}\\\" $class>\");\n-          echo(\"<td class=\\\"participant\\\" width=\\\"200\\\" valign=\\\"middle\\\">$name</th>\\n\");\n-          echo(\"<td><input type=\\\"text\\\" name=\\\"q_{$q}_{$id}\\\" id=\\\"q_{$q}_{$index}\\\" size=\\\"6\\\" maxlength=\\\"4\\\" value=\\\"$score\\\" onchange=\\\"calcTotal({$q},{$participant_count})\\\" onkeyup=\\\"calcTotal({$q},{$participant_count})\\\" /></label></td>\\n\");\n-          $index++;\n-        }\n-        echo(\"</tr>\\n\");\n+                    echo \"<tr id=\\\"q_{$q}_{$id}\\\" $class>\";\n+                    echo \"<td class=\\\"participant\\\" width=\\\"200\\\" valign=\\\"middle\\\">$name</th>\\n\";\n+                    echo \"<td><input type=\\\"text\\\" name=\\\"q_{$q}_{$id}\\\" id=\\\"q_{$q}_{$index}\\\" size=\\\"6\\\" maxlength=\\\"4\\\" value=\\\"$score\\\" onchange=\\\"calcTotal({$q},{$participant_count})\\\" onkeyup=\\\"calcTotal({$q},{$participant_count})\\\" /></label></td>\\n\";\n+                    $index++;\n+                }\n+                echo \"</tr>\\n\";\n \n-        // Footer row\n-        if ($initial_total==$group_total) {\n-          $bgcolor = 'transparent';\n-        } else {\n-          if ($initial_total>$group_total) {\n-            $bgcolor = '#f99';\n-          } else {\n-            $bgcolor = '#ff9';\n-          }\n-        }\n+                // Footer row\n+                if ($initial_total==$group_total) {\n+                    $bgcolor = 'transparent';\n+                } else {\n+                    if ($initial_total>$group_total) {\n+                        $bgcolor = '#f99';\n+                    } else {\n+                        $bgcolor = '#ff9';\n+                    }\n+                }\n \n-        echo(\"<tr><th style=\\\"text-align: right;\\\">Total&nbsp;</th><th><div style=\\\"background-color: $bgcolor;\\\" id=\\\"total_{$q}\\\">$initial_total</div></th></tr>\");\n-?>\n+                echo \"<tr><th style=\\\"text-align: right;\\\">Total&nbsp;</th><th><div style=\\\"background-color: $bgcolor;\\\" id=\\\"total_{$q}\\\">$initial_total</div></th></tr>\"; ?>\n           </table>\n         </div>\n <?php\n-      }// /foreach(question)\n-    } else {\n-      for ($q=0; $q<$question_count; $q++) {\n-        $question = $this->_form->get_question($q);\n-\n-        $q_num = $q + 1;\n-        $range = explode('-', $question['range']['_data']);\n-        $min_score = $range[0];\n-        $max_score = $range[1];\n-?>\n+            }// /foreach(question)\n+        } else {\n+            for ($q=0; $q<$question_count; $q++) {\n+                $question = $this->_form->get_question($q);\n+\n+                $q_num = $q + 1;\n+                $range = explode('-', $question['range']['_data']);\n+                $min_score = $range[0];\n+                $max_score = $range[1]; ?>\n         <div class=\"question\">\n-          <div class=\"question_text\"><?php echo(\"{$q_num}. {$question['text']['_data']}\"); ?></div>\n+          <div class=\"question_text\"><?php echo \"{$q_num}. {$question['text']['_data']}\"; ?></div>\n <?php\n         if (array_key_exists('desc', $question)) {\n-          $question_desc = (array_key_exists('desc', $question)) ? $question['desc']['_data'] : '' ;\n-          echo(\"<div>$question_desc</div>\");\n-        }\n-?>\n+            $question_desc = (array_key_exists('desc', $question)) ? $question['desc']['_data'] : '' ;\n+            echo \"<div>$question_desc</div>\";\n+        } ?>\n           <div class=\"question_scoring_labels\">\n <?php\n         foreach ($question as $k => $v) {\n-          if (strpos($k,'scorelabel')===0) {\n-            $num = str_replace('scorelabel','',$k);\n-            echo(\"<div class=\\\"question_score_label\\\">Score $num : {$v['_data']}</div>\");\n-          }\n-        }\n-?>\n+            if (strpos($k, 'scorelabel')===0) {\n+                $num = str_replace('scorelabel', '', $k);\n+                echo \"<div class=\\\"question_score_label\\\">Score $num : {$v['_data']}</div>\";\n+            }\n+        } ?>\n           </div>\n \n           <table class=\"question_grid\" cellpadding=\"3\" cellspacing=\"1\">\n <?php\n         // header row\n-        echo('<tr><td style=\"background-color: transparent\">&nbsp;</td>');\n-        for ($score=$min_score; $score<=$max_score; $score++) {\n-          echo(\"<th align=\\\"center\\\" width=\\\"40\\\">$score</th>\\n\");\n-        }\n-        echo('</tr>');\n+        echo '<tr><td style=\"background-color: transparent\">&nbsp;</td>';\n+                for ($score=$min_score; $score<=$max_score; $score++) {\n+                    echo \"<th align=\\\"center\\\" width=\\\"40\\\">$score</th>\\n\";\n+                }\n+                echo '</tr>';\n \n-        // show participant rows\n-        foreach ($this->_participants as $id => $name) {\n-          $class = ($id==$this->participant_id) ? 'class=\"this_participant\"' : '';\n+                // show participant rows\n+                foreach ($this->_participants as $id => $name) {\n+                    $class = ($id==$this->participant_id) ? 'class=\"this_participant\"' : '';\n \n-          $q_score = ( (is_array($this->_results))\n+                    $q_score = ((is_array($this->_results))\n                         && (array_key_exists(\"$q\", $this->_results))\n-                        && (array_key_exists($id, $this->_results[\"$q\"])) ) ? $this->_results[\"$q\"][\"$id\"] : null;\n-\n-          echo(\"<tr id=\\\"q_{$q}_{$id}\\\" $class>\");\n-          echo(\"<td class=\\\"participant\\\" width=\\\"200\\\" valign=\\\"middle\\\">$name</th>\\n\");\n-          for ($score=$min_score; $score<=$max_score; $score++) {\n-            $checked = ($q_score==$score) ? 'checked=\"checked\"' : '';\n-            echo(\"<td width=\\\"40\\\" valign=\\\"middle\\\"><label for=\\\"q_{$q}_{$id}_{$score}\\\" style=\\\"display: block;\\\"><input type=\\\"radio\\\" name=\\\"q_{$q}_{$id}\\\" id=\\\"q_{$q}_{$id}_{$score}\\\" value=\\\"$score\\\" $checked /></label></td>\\n\");\n-          }\n-        }\n-        echo(\"</tr>\\n\");\n-?>\n+                        && (array_key_exists($id, $this->_results[\"$q\"]))) ? $this->_results[\"$q\"][\"$id\"] : null;\n+\n+                    echo \"<tr id=\\\"q_{$q}_{$id}\\\" $class>\";\n+                    echo \"<td class=\\\"participant\\\" width=\\\"200\\\" valign=\\\"middle\\\">$name</th>\\n\";\n+                    for ($score=$min_score; $score<=$max_score; $score++) {\n+                        $checked = ($q_score==$score) ? 'checked=\"checked\"' : '';\n+                        echo \"<td width=\\\"40\\\" valign=\\\"middle\\\"><label for=\\\"q_{$q}_{$id}_{$score}\\\" style=\\\"display: block;\\\"><input type=\\\"radio\\\" name=\\\"q_{$q}_{$id}\\\" id=\\\"q_{$q}_{$id}_{$score}\\\" value=\\\"$score\\\" $checked /></label></td>\\n\";\n+                    }\n+                }\n+                echo \"</tr>\\n\"; ?>\n           </table>\n         </div>\n <?php\n-      }// /foreach(question)\n-    }// /if-else (likert)\n+            }// /foreach(question)\n+        }// /if-else (likert)\n \n-    if (APP__ALLOW_TEXT_INPUT){\n-      if (!empty($this->assessment_feedback)){\n-        if($this->assessment_feedback){\n-?>\n+    if (APP__ALLOW_TEXT_INPUT) {\n+        if (!empty($this->assessment_feedback)) {\n+            if ($this->assessment_feedback) {\n+                ?>\n         <div class=\"question\">\n         <p><b><?php echo $this->assessment_feedback_title; ?></b></p>\n           <p>This section of the assessment is for you to provide general feedback and/or justification of the <?php echo APP__MARK_TEXT; ?> you have awarded in the section above.</p>\n           <table class=\"question_grid\" >\n <?php\n           //now we know that the assessment feedback is allowed by the system we need to find out if the tutor has set feedback\n-          if($this->assessment_feedback){\n-            //out put the boxes\n-            foreach($this->_participants as $id => $name) {\n-              echo(\"<tr><td class=\\\"participant\\\" width=\\\"200\\\" valign=\\\"middle\\\">$name</th>\\n\");\n-              echo(\"<td><textarea name=\\\"$id\\\" rows=\\\"4\\\" cols=\\\"75\\\">\". Common::fetch_POST($id) .\"</textarea></td></tr>\");\n-            }\n-          }\n-?>\n+          if ($this->assessment_feedback) {\n+              //out put the boxes\n+              foreach ($this->_participants as $id => $name) {\n+                  echo \"<tr><td class=\\\"participant\\\" width=\\\"200\\\" valign=\\\"middle\\\">$name</th>\\n\";\n+                  echo \"<td><textarea name=\\\"$id\\\" rows=\\\"4\\\" cols=\\\"75\\\">\". Common::fetch_POST($id) .'</textarea></td></tr>';\n+              }\n+          } ?>\n           </table>\n         </div>\n <?php\n+            }\n         }\n-      }\n+    }\n     }\n \n-  }// /->draw_form()\n+    // /->draw_form()\n \n /*\n * ================================================================================\n * Private Methods\n * ================================================================================\n */\n-\n }// /class: Form\n \n ?>"
        },
        {
          "filename": "src/includes/classes/Group.php",
          "status": "modified",
          "additions": 403,
          "deletions": 280,
          "patch": "@@ -18,296 +18,419 @@\n \n namespace WebPA\\includes\\classes;\n \n+use Doctrine\\DBAL\\Connection;\n+use Doctrine\\DBAL\\ParameterType;\n use WebPA\\includes\\functions\\Common;\n \n-class Group {\n-  // Public Vars\n-  public $id = null;\n-  public $name = '';\n-  public $collection_id = '';   // READONLY\n-\n-  // Private Vars\n-  private $_DAO = null;\n-  private $_collection = null;\n-  private $_members = null;\n-\n-  /**\n-  * CONSTRUCTOR for group\n-  */\n-  function __construct() {\n-    $this->_collection = null;\n-    $this->_members = null;\n-  }// /->Group()\n-\n-/*\n-* ================================================================================\n-* Public Methods\n-* ================================================================================\n-*/\n-\n-/*\n-* --------------------------------------------------------------------------------\n-* Load/Save Functions\n-* --------------------------------------------------------------------------------\n-*/\n-\n-  /**\n-   *  Create a new group id\n-  */\n-  function create() {\n-    // generate a new project_id\n-    while (true) {\n-      $new_id = Common::uuid_create();\n-      if ($this->_DAO->fetch_value(\"SELECT COUNT(group_id) FROM \" . APP__DB_TABLE_PREFIX . \"user_group WHERE group_id = '$new_id' \") == 0) { break; }\n+class Group\n+{\n+    // Public Vars\n+    public $id;\n+\n+    public $name = '';\n+\n+    public $collection_id = '';   // READONLY\n+\n+    // Private Vars\n+    private DAO $_DAO;\n+\n+    private Connection $dbConn;\n+\n+    private $_collection;\n+\n+    private $_members;\n+\n+    /**\n+    * CONSTRUCTOR for group\n+    */\n+    public function __construct()\n+    {\n+        $this->_collection = null;\n+        $this->_members = null;\n     }\n-    $this->id = $new_id;\n-  }// ->create()\n-\n-  /**\n-  * Delete this Group (and all its members)\n-  * @return boolean\n-  */\n-  function delete() {\n-    if ($this->_collection->is_locked()) {\n-      return false;\n-    } else {\n-      $this->_DAO->execute(\"DELETE FROM \" . APP__DB_TABLE_PREFIX . \"user_group_member WHERE group_id = '{$this->id}' \");\n-      $this->_DAO->execute(\"DELETE FROM \" . APP__DB_TABLE_PREFIX . \"user_group WHERE group_id = '{$this->id}' \");\n-      return true;\n+\n+    // /->Group()\n+\n+    /*\n+    * ================================================================================\n+    * Public Methods\n+    * ================================================================================\n+    */\n+\n+    /*\n+    * --------------------------------------------------------------------------------\n+    * Load/Save Functions\n+    * --------------------------------------------------------------------------------\n+    */\n+\n+    /**\n+     *  Create a new group id\n+    */\n+    public function create()\n+    {\n+        // generate a new project_id\n+        while (true) {\n+            $new_id = Common::uuid_create();\n+\n+            $countGroupsQuery =\n+          'SELECT COUNT(group_id) ' .\n+          'FROM ' . APP__DB_TABLE_PREFIX . 'user_group ' .\n+          'WHERE group_id = ?';\n+\n+            $groupCount = $this->dbConn->fetchOne($countGroupsQuery, [$new_id], [ParameterType::STRING]);\n+\n+            if ($groupCount == 0) {\n+                break;\n+            }\n+        }\n+        $this->id = $new_id;\n     }\n-  }// /->delete()\n-\n-  /*\n-  * Load the Group from the database\n-  *\n-  * @param string $id  id of Group to load\n-  *\n-  * @return boolean did load succeed\n-  */\n-  function load($id) {\n-    $row = $this->_DAO->fetch_row(\"SELECT * FROM \" . APP__DB_TABLE_PREFIX . \"user_group WHERE group_id = '$id' LIMIT 1\");\n-    return ($row) ? $this->load_from_row($row) : false;\n-  }// /->load()\n-\n-  /**\n-  * Load the Group from an array row\n-  *\n-  * @param array $row assocated array ( field => value, ... ) - corresponds to row in database\n-  *\n-  * @return boolean did load succeed\n-  */\n-  function load_from_row(&$row) {\n-    $this->id = $row['group_id'];\n-    $this->name = $row['group_name'];\n-    $this->collection_id = $row['collection_id'];\n-    return true;\n-  }// /->load_from_row()\n-\n-\n-  /*\n-  * Save this Group\n-  *\n-  * @return boolean did save succeed\n-  */\n-  function save() {\n-    if ( (!$this->id) || ($this->_collection->is_locked()) ) {\n-      return false;\n-    } else {\n-      if (!is_array($this->_members)) { $this->refresh_members(); }\n-\n-      $_fields = array (\n-                'group_id'    => $this->id ,\n-                'collection_id' => $this->_collection->id ,\n-                'group_name'  => $this->name );\n-\n-      // Save the Group\n-      $sql = 'INSERT ' . APP__DB_TABLE_PREFIX . 'user_group ({fields}) VALUES ({values}) ' .\n-         'ON DUPLICATE KEY UPDATE group_name = ' . $this->_DAO->_prepare_field_value($_fields['group_name']);\n-      $this->_DAO->do_insert($sql, $_fields);\n-\n-      // Save the Group's members by deleting them all, then re-inserting\n-      $this->_DAO->execute( \"DELETE FROM \" . APP__DB_TABLE_PREFIX . \"user_group_member\n-                   WHERE group_id = '{$this->id}'\n-                  \");\n-\n-      // If there are members to re-insert, do it\n-      if (count($this->_members) > 0) {\n-        $fields = null;\n-        foreach($this->_members as $user_id => $role) {\n-          $fields[] = array ('group_id'   => $this->id ,\n-                     'user_id'    => $user_id ,\n-                    );\n-\n-          // This double-delete nonsense solves a referential integrity problem\n-          // with students managing to get themselves into TWO groups at once.\n-          $this->_DAO->execute(\"  DELETE FROM \" . APP__DB_TABLE_PREFIX . \"user_group_member\n-                        WHERE user_id = $user_id AND group_id IN\n-                          (\n-                            SELECT group_id\n-                            FROM \" . APP__DB_TABLE_PREFIX . \"user_group\n-                            WHERE collection_id = '{$this->_collection->id}'\n-                          )\n-                    \");\n+\n+    // ->create()\n+\n+    /**\n+    * Delete this Group (and all its members)\n+    * @return boolean\n+    */\n+    public function delete()\n+    {\n+        if ($this->_collection->is_locked()) {\n+            return false;\n         }\n+        $this->dbConn->executeQuery(\n+                'DELETE FROM ' . APP__DB_TABLE_PREFIX . 'user_group_member WHERE group_id = ?',\n+                [$this->id],\n+                [ParameterType::STRING]\n+            );\n+\n+        $this->dbConn->executeQuery(\n+                'DELETE FROM ' . APP__DB_TABLE_PREFIX . 'user_group WHERE group_id = ?',\n+                [$this->id],\n+                [ParameterType::STRING]\n+            );\n+\n+        return true;\n+    }\n \n-        $this->_DAO->do_insert_multi(\"REPLACE INTO \" . APP__DB_TABLE_PREFIX . \"user_group_member ({fields}) VALUES {values} \", $fields);\n-      }\n+    /*\n+    * Load the Group from the database\n+    *\n+    * @param string $id  id of Group to load\n+    *\n+    * @return boolean did load succeed\n+    */\n+    public function load($id)\n+    {\n+        $groupQuery =\n+        'SELECT * ' .\n+        'FROM ' . APP__DB_TABLE_PREFIX . 'user_group ' .\n+        'WHERE group_id = ? ' .\n+        'LIMIT 1';\n+\n+        $row = $this->dbConn->fetchAssociative($groupQuery, [$id], [ParameterType::STRING]);\n+\n+        return ($row) ? $this->load_from_row($row) : false;\n+    }\n \n-      return true;\n+    /**\n+    * Load the Group from an array row\n+    *\n+    * @param array $row assocated array ( field => value, ... ) - corresponds to row in database\n+    *\n+    * @return boolean did load succeed\n+    */\n+    public function load_from_row(&$row)\n+    {\n+        $this->id = $row['group_id'];\n+        $this->name = $row['group_name'];\n+        $this->collection_id = $row['collection_id'];\n+        return true;\n     }\n-  }// /->save()\n-\n-/*\n-* --------------------------------------------------------------------------------\n-* Accessor Methods\n-* --------------------------------------------------------------------------------\n-*/\n-\n-  /**\n-  * Get this Group object's data as an array\n-  */\n-  function get_as_array() {\n-    return array  ('group_id'   => $this->id ,\n-             'collection_id'=> $this->_collection->id ,\n-             'group_name' => $this->name ,);\n-  }// /->get_as_array()\n-\n-  /**\n-  * Set this group to use the given DAO object\n-  */\n-  function set_dao_object(&$DAO) {\n-    $this->_DAO =& $DAO;\n-  }// /->set_dao_object()\n-\n-  /**\n-  * Set this group to use the given GroupCollection as a parent\n-  */\n-  function set_collection_object(&$collection) {\n-    $this->_collection =& $collection;\n-    $this->collection_id = $this->_collection->id;\n-  }// /->set_collection_object()\n-\n-/*\n-* --------------------------------------------------------------------------------\n-* Member-Manipulation Methods\n-* --------------------------------------------------------------------------------\n-*/\n-\n-  /**\n-  * Add a member to this group\n-  *\n-  *\n-  * @param string $user_id   User ID to add\n-  * @param string $role   Role within the group\n-  */\n-  function add_member($user_id, $role) {\n-    //if (!is_array($this->_members)) { $this->refresh_members(); }\n-    $this->_members[$user_id] = $role;\n-  }// /->add_member()\n-\n-  /**\n-  * Returns the member list belonging to this group\n-  *\n-  * @return array array[0..n] of array array ( user_id => user_role )\n-  */\n-  function get_members() {\n-    if (!is_array($this->_members)) { $this->refresh_members(); }\n-    return $this->_members;\n-  }// /->get_members()\n-\n-  /**\n-  * Returns the member list belonging to this group\n-  *\n-  * @return array  array[0..n] of array ( user_id => user_role )\n-  */\n-  function get_member_ids() {\n-    if (!is_array($this->_members)) { $this->refresh_members(); }\n-    return array_keys($this->_members);\n-  }// /->get_member_ids()\n-\n-  /**\n-  * Returns a count of the number of members belonging to this group\n-  *\n-  * @return integer count of members\n-  */\n-  function get_members_count() {\n-    if (!is_array($this->_members)) { $this->refresh_members(); }\n-    return count($this->_members);\n-  }// ->get_members_count()\n-\n-  /**\n-  * Purge the group of members using include/exclude lists\n-  * Due to the way the lists work, you need only use one of them at a time\n-  *\n-  * @param string|array $target_roles     role to purge\n-  *                  array of roles to purge\n-  *                   If a $target_roles list is given (not null), and a user's role is not in it, they are kept regardless of the $protect_list\n-  *                   If a user's role is in the $target_roles list, they are removed\n-  *\n-  * @param string|array $protect_roles  single role to keep\n-  *                   array of roles to keep\n-  *                   If a user's role is in the $protect_roles list, they are kept\n-  *@return boolean\n-  */\n-  function purge_members($target_roles = null, $protect_roles = null) {\n-    if (!is_array($this->_members)) { $this->refresh_members(); }\n-\n-    // If we're purging everything, do it\n-    if ( (!$target_roles) && (!$protect_roles) ) {\n-      $this->_members = array();  // empty array, not NULL, as that would usually trigger a ->refresh_members() call in other member functions\n-    } else {\n-      $post_purge_members = array();\n-\n-      // If there's a target list.. save the untargetted roles\n-      if ($target_roles) {\n-        $target_roles = (array) $target_roles;\n-        foreach ($this->_members as $user_id => $role) {\n-          if (!in_array($role,$target_roles)) { $post_purge_members[$user_id] = $role; }\n-        }// /for\n-      } else {  // Else.. save every user with a protected role\n-        $protect_roles = (array) $protect_roles;\n-        foreach ($this->_members as $user_id => $role) {\n-          if (in_array($role, $protect_roles)) { $post_purge_members[$user_id] = $role; }\n-        }// /for\n-      }\n-      $this->_members = $post_purge_members;\n+\n+    // /->load_from_row()\n+\n+    /*\n+    * Save this Group\n+    *\n+    * @return boolean did save succeed\n+    */\n+    public function save()\n+    {\n+        if ((!$this->id) || ($this->_collection->is_locked())) {\n+            return false;\n+        }\n+\n+        if (!is_array($this->_members)) {\n+            $this->refresh_members();\n+        }\n+\n+        // check if the group already exists in the database\n+        $groupId = $this->dbConn->fetchOne(\n+            'SELECT group_id FROM ' . APP__DB_TABLE_PREFIX . 'user_group WHERE group_id = ?',\n+            [$this->id],\n+            [ParameterType::STRING]\n+        );\n+\n+        $queryBuilder = $this->dbConn->createQueryBuilder();\n+\n+        if (!empty($groupId)) {\n+            // group already exists so update it\n+            $queryBuilder\n+            ->update(APP__DB_TABLE_PREFIX . 'user_group')\n+            ->set('group_name', '?')\n+            ->where('group_id = ?')\n+            ->setParameter(0, $this->name)\n+            ->setParameter(1, $this->id);\n+        } else {\n+            // the group doesn't exist so create it\n+            $queryBuilder\n+            ->insert(APP__DB_TABLE_PREFIX . 'user_group')\n+            ->values([\n+               'group_id' => '?',\n+               'collection_id' => '?',\n+               'group_name' => '?',\n+            ])\n+            ->setParameter(0, $this->id)\n+            ->setParameter(1, $this->_collection->id)\n+            ->setParameter(2, $this->name);\n+        }\n+\n+        $queryBuilder->execute();\n+\n+        // Save the Group's members by deleting them all, then re-inserting\n+        $this->dbConn->executeQuery(\n+            'DELETE FROM ' . APP__DB_TABLE_PREFIX . 'user_group_member WHERE group_id = ?',\n+            [$this->id],\n+            [ParameterType::STRING]\n+        );\n+\n+        // If there are members to re-insert, do it\n+        if (count($this->_members) > 0) {\n+            $fields = null;\n+\n+            foreach ($this->_members as $user_id => $role) {\n+                $fields[] = ['group_id'   => $this->id,\n+                     'user_id'    => $user_id,\n+                    ];\n+\n+                // This double-delete nonsense solves a referential integrity problem\n+                // with students managing to get themselves into TWO groups at once.\n+                $deleteQuery =\n+                'DELETE FROM ' . APP__DB_TABLE_PREFIX . 'user_group_member ' .\n+                'WHERE user_id = ? ' .\n+                'AND group_id IN ' .\n+                '( ' .\n+                'SELECT group_id ' .\n+                'FROM ' . APP__DB_TABLE_PREFIX . 'user_group ' .\n+                'WHERE collection_id = ? ' .\n+                ')';\n+\n+                $this->dbConn->executeQuery(\n+                    $deleteQuery,\n+                    [$user_id, $this->_collection->id],\n+                    [ParameterType::INTEGER, ParameterType::STRING]\n+                );\n+            }\n+\n+            foreach ($fields as $values) {\n+                $this->dbConn\n+                ->createQueryBuilder()\n+                ->insert(APP__DB_TABLE_PREFIX . 'user_group_member')\n+                ->values([\n+                    'group_id' => '?',\n+                    'user_id' => '?',\n+                ])\n+                ->setParameter(0, $this->id)\n+                ->setParameter(1, $values['user_id'])\n+                ->execute();\n+            }\n+        }\n+\n+        return true;\n+    }\n+\n+    /*\n+    * --------------------------------------------------------------------------------\n+    * Accessor Methods\n+    * --------------------------------------------------------------------------------\n+    */\n+\n+    /**\n+    * Get this Group object's data as an array\n+    */\n+    public function get_as_array()\n+    {\n+        return ['group_id'   => $this->id,\n+             'collection_id'=> $this->_collection->id,\n+             'group_name' => $this->name, ];\n+    }\n+\n+    // /->get_as_array()\n+\n+    /**\n+    * Set this group to use the given DAO object\n+    */\n+    public function set_dao_object(&$DAO)\n+    {\n+        $this->_DAO =& $DAO;\n+        $this->dbConn = $this->_DAO->getConnection();\n+    }\n+\n+    /**\n+    * Set this group to use the given GroupCollection as a parent\n+    */\n+    public function set_collection_object(&$collection)\n+    {\n+        $this->_collection =& $collection;\n+        $this->collection_id = $this->_collection->id;\n+    }\n+\n+    // /->set_collection_object()\n+\n+    /*\n+    * --------------------------------------------------------------------------------\n+    * Member-Manipulation Methods\n+    * --------------------------------------------------------------------------------\n+    */\n+\n+    /**\n+    * Add a member to this group\n+    *\n+    *\n+    * @param string $user_id   User ID to add\n+    * @param string $role   Role within the group\n+    */\n+    public function add_member($user_id, $role)\n+    {\n+        $this->_members[$user_id] = $role;\n+    }\n+\n+    /**\n+    * Returns the member list belonging to this group\n+    *\n+    * @return array array[0..n] of array array ( user_id => user_role )\n+    */\n+    public function get_members()\n+    {\n+        if (!is_array($this->_members)) {\n+            $this->refresh_members();\n+        }\n+        return $this->_members;\n     }\n-    return true;\n-  }// /->purge_members()\n-\n-  /**\n-  * Refresh the member list for this object from the database\n-  * Any unsaved-changes made to the members list are lost\n-  */\n-  function refresh_members() {\n-    $this->_members = $this->_DAO->fetch_assoc(\"SELECT user_id, 'member' AS user_role\n-                          FROM \" . APP__DB_TABLE_PREFIX . \"user_group_member\n-                          WHERE group_id = '{$this->id}'\n-                          ORDER BY user_id ASC\n-                          \");\n-\n-    if (!$this->_members) { $this->_members = array(); }\n-  }// /->refresh_members()\n-\n-  /**\n-  * Remove a member from this group\n-  *\n-  * @param string $user_id  User ID to remove\n-  */\n-  function remove_member($user_id) {\n-    if (!is_array($this->_members)) { $this->refresh_members(); }\n-\n-    if (array_key_exists($user_id, $this->_members)) {\n-      unset($this->_members[$user_id]);\n+\n+    // /->get_members()\n+\n+    /**\n+    * Returns the member list belonging to this group\n+    *\n+    * @return array  array[0..n] of array ( user_id => user_role )\n+    */\n+    public function get_member_ids()\n+    {\n+        if (!is_array($this->_members)) {\n+            $this->refresh_members();\n+        }\n+        return array_keys($this->_members);\n     }\n-  }// /->remove_member();\n \n-/*\n-* ================================================================================\n-* Private Methods\n-* ================================================================================\n-*/\n+    // /->get_member_ids()\n+\n+    /**\n+    * Returns a count of the number of members belonging to this group\n+    *\n+    * @return integer count of members\n+    */\n+    public function get_members_count()\n+    {\n+        if (!is_array($this->_members)) {\n+            $this->refresh_members();\n+        }\n+        return count($this->_members);\n+    }\n \n-}// /class: Group\n+    // ->get_members_count()\n+\n+    /**\n+    * Purge the group of members using include/exclude lists\n+    * Due to the way the lists work, you need only use one of them at a time\n+    *\n+    * @param string|array $target_roles     role to purge\n+    *                  array of roles to purge\n+    *                   If a $target_roles list is given (not null), and a user's role is not in it, they are kept regardless of the $protect_list\n+    *                   If a user's role is in the $target_roles list, they are removed\n+    *\n+    * @param string|array $protect_roles  single role to keep\n+    *                   array of roles to keep\n+    *                   If a user's role is in the $protect_roles list, they are kept\n+    *@return boolean\n+    */\n+    public function purge_members($target_roles = null, $protect_roles = null)\n+    {\n+        if (!is_array($this->_members)) {\n+            $this->refresh_members();\n+        }\n \n-?>\n+        // If we're purging everything, do it\n+        if ((!$target_roles) && (!$protect_roles)) {\n+            $this->_members = [];  // empty array, not NULL, as that would usually trigger a ->refresh_members() call in other member functions\n+        } else {\n+            $post_purge_members = [];\n+\n+            // If there's a target list.. save the untargetted roles\n+            if ($target_roles) {\n+                $target_roles = (array) $target_roles;\n+                foreach ($this->_members as $user_id => $role) {\n+                    if (!in_array($role, $target_roles)) {\n+                        $post_purge_members[$user_id] = $role;\n+                    }\n+                }// /for\n+            } else {  // Else.. save every user with a protected role\n+        $protect_roles = (array) $protect_roles;\n+                foreach ($this->_members as $user_id => $role) {\n+                    if (in_array($role, $protect_roles)) {\n+                        $post_purge_members[$user_id] = $role;\n+                    }\n+                }// /for\n+            }\n+            $this->_members = $post_purge_members;\n+        }\n+        return true;\n+    }\n+\n+    // /->purge_members()\n+\n+    /**\n+    * Refresh the member list for this object from the database\n+    * Any unsaved-changes made to the members list are lost\n+    */\n+    public function refresh_members()\n+    {\n+        $membersQuery =\n+        'SELECT user_id, \"member\" AS user_role ' .\n+        'FROM ' . APP__DB_TABLE_PREFIX . 'user_group_member ' .\n+        'WHERE group_id = ? ' .\n+        'ORDER BY user_id ASC';\n+\n+        $this->_members = $this->dbConn->fetchAllKeyValue($membersQuery, [$this->id], [ParameterType::STRING]);\n+\n+        if (!$this->_members) {\n+            $this->_members = [];\n+        }\n+    }\n+\n+    /**\n+    * Remove a member from this group\n+    *\n+    * @param string $user_id  User ID to remove\n+    */\n+    public function remove_member($user_id)\n+    {\n+        if (!is_array($this->_members)) {\n+            $this->refresh_members();\n+        }\n+\n+        if (array_key_exists($user_id, $this->_members)) {\n+            unset($this->_members[$user_id]);\n+        }\n+    }\n+}"
        },
        {
          "filename": "src/includes/classes/GroupCollection.php",
          "status": "modified",
          "additions": 292,
          "deletions": 148,
          "patch": "@@ -15,32 +15,40 @@\n \n namespace WebPA\\includes\\classes;\n \n+use Doctrine\\DBAL\\ParameterType;\n use WebPA\\includes\\functions\\Common;\n \n class GroupCollection\n {\n     // Public Vars\n-    public $id = null;\n-    public $module_id = null;\n+    public $id;\n+\n+    public $module_id;\n+\n     public $name = '';\n \n     // Private Vars\n-    private $_DAO = null;\n+    private $_DAO;\n+\n+    private $dbConn;\n \n-    private $_groups = null;\n-    private $_group_objects = null;\n+    private $_groups;\n \n-    private $_created_on = null;\n-    private $_locked_on = null;\n+    private $_group_objects;\n \n-    private $_assessment_id = null;\n+    private $_created_on;\n+\n+    private $_locked_on;\n+\n+    private $_assessment_id;\n \n     /**\n      * CONSTRUCTOR for the Group collection function\n      */\n-    function __construct($DAO)\n+    public function __construct(DAO $DAO)\n     {\n         $this->_DAO = $DAO;\n+        $this->dbConn = $this->_DAO->getConnection();\n         $this->_created_on = time();\n     }\n \n@@ -59,16 +67,26 @@ function __construct($DAO)\n     /**\n      *  Create a new GroupCollection (generates unique collection_id)\n      */\n-    function create()\n+    public function create()\n     {\n         while (true) {\n             $new_id = Common::uuid_create();\n-            if ($this->_DAO->fetch_value(\"SELECT COUNT(collection_id) AS num_id FROM \" . APP__DB_TABLE_PREFIX . \"collection WHERE collection_id = '$new_id' \") == 0) {\n+\n+            $countCollectionsQuery =\n+                'SELECT COUNT(collection_id) AS num_id ' .\n+                'FROM ' . APP__DB_TABLE_PREFIX . 'collection ' .\n+                'WHERE collection_id = ?';\n+\n+            $collectionCount = $this->dbConn->fetchOne($countCollectionsQuery, [$new_id], [ParameterType::STRING]);\n+\n+            if ($collectionCount == 0) {\n                 break;\n             }\n         }\n         $this->id = $new_id;\n-    }// ->create()\n+    }\n+\n+    // ->create()\n \n     /**\n      * Load the GroupCollection from the database\n@@ -77,14 +95,19 @@ function create()\n      *\n      * @return boolean did load succeed\n      */\n-    function load($id)\n+    public function load($id)\n     {\n-        $row = $this->_DAO->fetch_row(\"SELECT c.*, a.assessment_id AS collection_assessment_id\n-       FROM \" . APP__DB_TABLE_PREFIX . \"collection c\n-         LEFT OUTER JOIN \" . APP__DB_TABLE_PREFIX . \"assessment a ON c.collection_id = a.collection_id\n-       WHERE c.collection_id = '$id'\");\n+        $groupCollectionQuery =\n+            'SELECT c.*, a.assessment_id AS collection_assessment_id ' .\n+            'FROM ' . APP__DB_TABLE_PREFIX . 'collection c ' .\n+            'LEFT OUTER JOIN ' . APP__DB_TABLE_PREFIX . 'assessment a ' .\n+            'ON c.collection_id = a.collection_id ' .\n+            'WHERE c.collection_id = ?';\n+\n+        $row = $this->dbConn->fetchAssociative($groupCollectionQuery, [$id], [ParameterType::STRING]);\n+\n         return ($row) ? $this->load_from_row($row) : false;\n-    }// /->load()\n+    }\n \n     /**\n      * Load the GroupCollection from an array row\n@@ -93,72 +116,130 @@ function load($id)\n      *\n      * @return boolean\n      */\n-    function load_from_row(&$row)\n+    public function load_from_row(&$row)\n     {\n         $this->id = $row['collection_id'];\n         $this->module_id = $row['module_id'];\n         $this->name = $row['collection_name'];\n         $this->_created_on = strtotime($row['collection_created_on']);\n         $this->_locked_on = ((is_null($row['collection_locked_on'])) ? null : strtotime($row['collection_locked_on']));\n-        $this->_assessment_id = $row['collection_assessment_id'];\n+        $this->_assessment_id = $row['collection_assessment_id'] ?? null;\n         return true;\n-    }// /->load_from_row()\n+    }\n+\n+    // /->load_from_row()\n \n     /**\n      * Delete this GroupCollection (and all its groups, members, and module links)\n      * If the collection is locked, the delete will fail\n      *\n      * @retutn  boolean did deletion succeed\n      */\n-    function delete()\n+    public function delete()\n     {\n         if ($this->is_locked()) {\n             return false;\n-        } else {\n-            $this->_DAO->execute(\"DELETE FROM \" . APP__DB_TABLE_PREFIX . \"user_group_member WHERE group_id IN (SELECT group_id FROM \" . APP__DB_TABLE_PREFIX . \"user_group WHERE collection_id = '{$this->id}')\");\n-            $this->_DAO->execute(\"DELETE FROM \" . APP__DB_TABLE_PREFIX . \"user_group WHERE collection_id = '{$this->id}'\");\n-            $this->_DAO->execute(\"DELETE FROM \" . APP__DB_TABLE_PREFIX . \"collection WHERE collection_id = '{$this->id}'\");\n-            return true;\n         }\n-    }// /->delete()\n+\n+        $this->dbConn->executeQuery(\n+                'DELETE FROM ' . APP__DB_TABLE_PREFIX . 'user_group_member WHERE group_id IN (SELECT group_id FROM ' . APP__DB_TABLE_PREFIX . 'user_group WHERE collection_id = ?)',\n+                [$this->id],\n+                [ParameterType::STRING]\n+            );\n+\n+        $this->dbConn->executeQuery(\n+                'DELETE FROM ' . APP__DB_TABLE_PREFIX . 'user_group WHERE collection_id = ?',\n+                [$this->id],\n+                [ParameterType::STRING]\n+            );\n+\n+        $this->dbConn->executeQuery(\n+                'DELETE FROM ' . APP__DB_TABLE_PREFIX . 'collection WHERE collection_id = ?',\n+                [$this->id],\n+                [ParameterType::STRING]\n+            );\n+\n+        return true;\n+    }\n \n     /**\n      * Save this GroupCollection\n      *\n      * @return boolean did save succeed\n      */\n-    function save()\n+    public function save()\n     {\n         if ((!$this->id) || ($this->is_locked())) {\n             return false;\n-        } else {\n-            // load all necessary info\n-            $fields = array('collection_id' => $this->id,\n+        }\n+        // load all necessary info\n+        $fields = ['collection_id' => $this->id,\n                 'module_id' => $this->module_id,\n                 'collection_name' => $this->name,\n                 'collection_created_on' => date(MYSQL_DATETIME_FORMAT, $this->_created_on),\n                 'collection_locked_on' => ((!$this->_locked_on) ? null : date(MYSQL_DATETIME_FORMAT, $this->_locked_on)),\n-            );\n-\n-            // Save this collection\n-            $sql = 'INSERT ' . APP__DB_TABLE_PREFIX . 'collection ({fields}) VALUES ({values}) ' .\n-                \"ON DUPLICATE KEY UPDATE module_id = {$fields['module_id']}, collection_name = '{$fields['collection_name']}', collection_created_on = '{$fields['collection_created_on']}', \";\n-            if (is_null($fields['collection_locked_on'])) {\n-                $sql .= 'collection_locked_on = NULL';\n+            ];\n+\n+        // before saving, check if this collection already exists in the db\n+        $storedCollectionId =\n+                $this->dbConn->fetchOne(\n+                    'SELECT collection_id FROM ' . APP__DB_TABLE_PREFIX . 'collection WHERE collection_id = ?',\n+                    [$this->id],\n+                    [ParameterType::STRING]\n+                );\n+\n+        $queryBuilder = $this->dbConn->createQueryBuilder();\n+\n+        $createdOn = date(MYSQL_DATETIME_FORMAT, $this->_created_on);\n+        $lockedOn = !$this->_locked_on ? null : date(MYSQL_DATETIME_FORMAT, $this->_locked_on);\n+\n+        if (!$storedCollectionId) {\n+            // the collection does not exist so create it\n+            $queryBuilder\n+                    ->insert(APP__DB_TABLE_PREFIX . 'collection')\n+                    ->values([\n+                        'collection_id' => '?',\n+                        'module_id' => '?',\n+                        'collection_name' => '?',\n+                        'collection_created_on' => '?',\n+                        'collection_locked_on' => '?',\n+                    ])\n+                    ->setParameter(0, $this->id)\n+                    ->setParameter(1, $this->module_id, ParameterType::INTEGER)\n+                    ->setParameter(2, $this->name)\n+                    ->setParameter(3, $createdOn)\n+                    ->setParameter(4, $lockedOn);\n+        } else {\n+            // the collection exists so update it\n+            $queryBuilder\n+                    ->update(APP__DB_TABLE_PREFIX . 'collection')\n+                    ->set('module_id', '?')\n+                    ->set('collection_name', '?')\n+                    ->set('collection_created_on', '?')\n+                    ->where('collection_id = ?')\n+                    ->setParameter(0, $this->module_id, ParameterType::INTEGER)\n+                    ->setParameter(1, $this->name)\n+                    ->setParameter(2, $createdOn)\n+                    ->setParameter(3, $this->id);\n+\n+            // check if the locked field needs to be set\n+            if (is_null($lockedOn)) {\n+                $queryBuilder->set('collection_locked_on', 'NULL');\n             } else {\n-                $sql .= \"collection_locked_on = '{$fields['collection_locked_on']}'\";\n+                $queryBuilder->set('collection_locked_on', '?')->setParameter(3, $lockedOn);\n             }\n-            $this->_DAO->do_insert($sql, $fields);\n-\n-            return true;\n         }\n-    }// /->save()\n+\n+        $queryBuilder->execute();\n+\n+        return true;\n+    }\n \n     /**\n      * Save open Group objects attached to this GroupCollection\n      * Loops through the group objects opened through the GroupCollection and saves any changes\n      */\n-    function save_groups()\n+    public function save_groups()\n     {\n         if (is_array($this->_group_objects)) {\n             foreach ($this->_group_objects as $group_id => $group) {\n@@ -167,7 +248,9 @@ function save_groups()\n                 }\n             }\n         }\n-    }// /->save_groups()\n+    }\n+\n+    // /->save_groups()\n \n     /*\n     * --------------------------------------------------------------------------------\n@@ -178,7 +261,7 @@ function save_groups()\n     /**\n      * Set the GroupCollection's owner info\n      */\n-    function set_owner_info($id, $type)\n+    public function set_owner_info($id, $type)\n     {\n         $this->_assessment_id = null;\n         switch ($type) {\n@@ -188,17 +271,21 @@ function set_owner_info($id, $type)\n                 $this->_assessment_id = $id;\n                 break;\n         }\n-    }// /->set_owner_info()\n+    }\n+\n+    // /->set_owner_info()\n \n     /**\n      * Is this GroupCollection locked?\n      *\n      * @return boolean is the collection locked\n      */\n-    function is_locked()\n+    public function is_locked()\n     {\n-        return ((!is_null($this->_locked_on)) || ($this->_locked_on));\n-    }// /->is_locked()\n+        return (!is_null($this->_locked_on)) || ($this->_locked_on);\n+    }\n+\n+    // /->is_locked()\n \n     /*\n     * --------------------------------------------------------------------------------\n@@ -210,16 +297,18 @@ function is_locked()\n      * Lock the collection - should prevent applications editing/deleting the groups involved\n      * The locked_on datetime is IMMEDIATELY SAVED to the database (no other fields are saved)\n      */\n-    function lock()\n+    public function lock()\n     {\n         $this->_locked_on = time();\n         if ($this->id) {\n-            $_fields = array(\n-                'collection_locked_on' => date(MYSQL_DATETIME_FORMAT, $this->_locked_on),\n-            );\n-            $this->_DAO->do_update(\"UPDATE \" . APP__DB_TABLE_PREFIX . \"collection ({fields}) WHERE collection_id = '{$this->id}' \", $_fields);\n+            $stmt = $this->dbConn->prepare('UPDATE ' . APP__DB_TABLE_PREFIX . 'collection SET collection_locked_on = ? WHERE collection_id = ?');\n+\n+            $stmt->bindValue(1, date(MYSQL_DATETIME_FORMAT, $this->_locked_on));\n+            $stmt->bindValue(2, $this->id);\n+\n+            $stmt->execute();\n         }\n-    }// /->lock()\n+    }\n \n     /*\n     * --------------------------------------------------------------------------------\n@@ -238,20 +327,22 @@ function lock()\n      *\n      * @return assoc array ( group_name => group_id )\n      */\n-    function get_groups_array()\n+    public function get_groups_array()\n     {\n         if (!$this->_groups) {\n             $this->refresh_groups();\n         }\n         return $this->_groups;\n-    }// /->get_groups_array()\n+    }\n+\n+    // /->get_groups_array()\n \n     /**\n      * Check if there is a group in this GroupCollection with the given name\n      * @param string $group_name\n      * @return boolean\n      */\n-    function group_exists($group_name)\n+    public function group_exists($group_name)\n     {\n         if (!$this->_groups) {\n             $this->refresh_groups();\n@@ -266,14 +357,16 @@ function group_exists($group_name)\n         }\n \n         return $is_valid_group;\n-    }// /->group_exists()\n+    }\n+\n+    // /->group_exists()\n \n     /**\n      * Check if the group exists\n      * @param mixed $group_id\n      * @return bool  does the group exist in this collection\n      */\n-    function group_id_exists($group_id)\n+    public function group_id_exists($group_id)\n     {\n         if (!$this->_groups) {\n             $this->refresh_groups();\n@@ -288,24 +381,30 @@ function group_id_exists($group_id)\n         }\n \n         return $is_valid_group;\n-    }// /->group_id_exists()\n+    }\n+\n+    // /->group_id_exists()\n \n     /**\n      * Refresh this collection's list of groups\n      */\n-    function refresh_groups()\n+    public function refresh_groups()\n     {\n-        $this->_groups = $this->_DAO->fetch(\"\n-      SELECT *\n-      FROM \" . APP__DB_TABLE_PREFIX . \"user_group\n-      WHERE collection_id = '{$this->id}'\n-      ORDER BY group_name ASC\n-    \");\n+        $groupsQuery =\n+            'SELECT * ' .\n+            'FROM ' . APP__DB_TABLE_PREFIX . 'user_group ' .\n+            'WHERE collection_id = ? ' .\n+            'ORDER BY group_name ASC';\n+\n+        $this->_groups = $this->dbConn->fetchAllAssociative($groupsQuery, [$this->id], [ParameterType::STRING]);\n+\n         if (!$this->_groups) {\n-            $this->_groups = array();\n+            $this->_groups = [];\n         }\n         uasort($this->_groups, ['self', 'group_title_natural_sort']);\n-    }// /->refresh_groups()\n+    }\n+\n+    // /->refresh_groups()\n \n     private static function group_title_natural_sort($group_a, $group_b)\n     {\n@@ -324,7 +423,7 @@ private static function group_title_natural_sort($group_a, $group_b)\n      *\n      * @param object $group_object The group to add\n      */\n-    function add_group_object(&$group_object)\n+    public function add_group_object(&$group_object)\n     {\n         if (!is_array($this->_groups)) {\n             $this->refresh_groups();\n@@ -335,7 +434,9 @@ function add_group_object(&$group_object)\n             $this->_group_objects[\"{$group_object->id}\"] =& $group_object;\n             $group_object->set_collection_object($this);\n         }\n-    }// /->add_group_object()\n+    }\n+\n+    // /->add_group_object()\n \n     /**\n      * Get the group object corresponding to the given group_id\n@@ -345,7 +446,7 @@ function add_group_object(&$group_object)\n      *\n      * @return object Group object (or NULL)\n      */\n-    function & get_group_object($group_id)\n+    public function & get_group_object($group_id)\n     {\n         if (!is_array($this->_groups)) {\n             $this->refresh_groups();\n@@ -354,19 +455,20 @@ function & get_group_object($group_id)\n         // If this group exists in this collection\n         if ($this->group_id_exists($group_id)) {\n             // If we already have a copy of the Group object, return it\n-            if ((array_key_exists($group_id, (array)$this->_group_objects)) && (is_object($this->_group_objects[$group_id]))) {\n+            if ((array_key_exists($group_id, (array) $this->_group_objects)) && (is_object($this->_group_objects[$group_id]))) {\n                 return $this->_group_objects[$group_id];\n-            } else {\n-                $new_group = new Group();\n-                $new_group->set_dao_object($this->_DAO);\n-                $new_group->set_collection_object($this);\n-                $new_group->load($group_id);\n-                $this->_group_objects[$group_id] =& $new_group;\n-                return $new_group;\n             }\n+            $new_group = new Group();\n+            $new_group->set_dao_object($this->_DAO);\n+            $new_group->set_collection_object($this);\n+            $new_group->load($group_id);\n+            $this->_group_objects[$group_id] =& $new_group;\n+            return $new_group;\n         }\n         return null;\n-    }// /->get_group_object()\n+    }\n+\n+    // /->get_group_object()\n \n     /**\n      * Create a new Group object using this GroupCollection as the parent\n@@ -375,7 +477,7 @@ function & get_group_object($group_id)\n      * @param string $group_name Name of new group to add\n      * @return array\n      */\n-    function & new_group($group_name = 'new group')\n+    public function & new_group($group_name = 'new group')\n     {\n         $new_group = new Group();\n         $new_group->set_dao_object($this->_DAO);\n@@ -386,14 +488,16 @@ function & new_group($group_name = 'new group')\n         $this->_group[$new_group->id] = $new_group->get_as_array();\n         $this->_group_objects[$new_group->id] =& $new_group;\n         return $new_group;\n-    }// /->new_group()\n+    }\n+\n+    // /->new_group()\n \n     /**\n      * Get an iterator object containg the groups belonging to this collection\n      *\n      * @return object GroupIterator object\n      */\n-    function & get_groups_iterator()\n+    public function & get_groups_iterator()\n     {\n         if (!$this->_groups) {\n             $this->refresh_groups();\n@@ -404,7 +508,7 @@ function & get_groups_iterator()\n         }\n \n         if ($this->_group_objects !== null) {\n-           $iterator = new SimpleIterator($this->_group_objects);\n+            $iterator = new SimpleIterator($this->_group_objects);\n         } else {\n             $iterator = new SimpleIterator();\n         }\n@@ -425,14 +529,17 @@ function & get_groups_iterator()\n      *\n      * @return integer\n      */\n-    function get_member_count($role = null)\n+    public function get_member_count($role = null)\n     {\n-        return $this->_DAO->fetch_value(\"SELECT COUNT(ugm.user_id)\n-                    FROM \" . APP__DB_TABLE_PREFIX . \"user_group_member ugm\n-                      INNER JOIN \" . APP__DB_TABLE_PREFIX . \"user_group ug ON ugm.group_id = ug.group_id\n-                    WHERE ug.collection_id = '{$this->id}'\n-                    \");\n-    }// /->get_member_count()\n+        $memberCountQuery =\n+            'SELECT COUNT(ugm.user_id) ' .\n+            'FROM ' . APP__DB_TABLE_PREFIX . 'user_group_member ugm ' .\n+            'INNER JOIN ' . APP__DB_TABLE_PREFIX . 'user_group ug ' .\n+            'ON ugm.group_id = ug.group_id ' .\n+            'WHERE ug.collection_id = ?';\n+\n+        return $this->dbConn->fetchOne($memberCountQuery, [$this->id], [ParameterType::STRING]);\n+    }\n \n     /**\n      * Get a count of the members in this collection by group\n@@ -441,15 +548,19 @@ function get_member_count($role = null)\n      *\n      * @return array  array ( group_id => member_count )\n      */\n-    function get_member_count_by_group($role = null)\n+    public function get_member_count_by_group($role = null)\n     {\n-        return $this->_DAO->fetch_assoc(\"SELECT ugm.group_id, COUNT(user_id)\n-                    FROM \" . APP__DB_TABLE_PREFIX . \"user_group_member ugm\n-                      INNER JOIN \" . APP__DB_TABLE_PREFIX . \"user_group ug ON ugm.group_id = ug.group_id\n-                    WHERE ug.collection_id = '{$this->id}'\n-                    GROUP BY ugm.group_id\n-                    ORDER BY ugm.group_id\");\n-    }// /->get_member_count_by_group()\n+        $memberCountQuery =\n+            'SELECT ugm.group_id, COUNT(user_id) ' .\n+            'FROM ' . APP__DB_TABLE_PREFIX . 'user_group_member ugm ' .\n+            'INNER JOIN ' . APP__DB_TABLE_PREFIX . 'user_group ug ' .\n+            'ON ugm.group_id = ug.group_id ' .\n+            'WHERE ug.collection_id = ? ' .\n+            'GROUP BY ugm.group_id ' .\n+            'ORDER BY ugm.group_id';\n+\n+        return $this->dbConn->fetchAllKeyValue($memberCountQuery, [$this->id], [ParameterType::STRING]);\n+    }\n \n     /**\n      * Get the members actually contained within this collection's groups\n@@ -458,28 +569,36 @@ function get_member_count_by_group($role = null)\n      *\n      * @return array - assoc array ( user_id => user_role )\n      */\n-    function get_members($role = null)\n+    public function get_members($role = null)\n     {\n-        return $this->_DAO->fetch_assoc(\"SELECT ugm.user_id, 'member' AS user_role\n-                    FROM \" . APP__DB_TABLE_PREFIX . \"user_group_member ugm\n-                      INNER JOIN \" . APP__DB_TABLE_PREFIX . \"user_group ug ON ugm.group_id = ug.group_id\n-                    WHERE ug.collection_id = '{$this->id}'\n-                    ORDER BY ugm.user_id ASC\");\n-    }// /->get_members()\n+        $membersQuery =\n+            'SELECT ugm.user_id, \"member\" AS user_role ' .\n+            'FROM ' . APP__DB_TABLE_PREFIX . 'user_group_member ugm ' .\n+            'INNER JOIN ' . APP__DB_TABLE_PREFIX . 'user_group ug ' .\n+            'ON ugm.group_id = ug.group_id ' .\n+            'WHERE ug.collection_id = ? ' .\n+            'ORDER BY ugm.user_id ASC';\n+\n+        return $this->dbConn->fetchAllKeyValue($membersQuery, [$this->id], [ParameterType::STRING]);\n+    }\n \n     /**\n      * Get row data for this collection's members\n      *\n      * @return array - array ( group_id, user_id, user_role )\n      */\n-    function get_member_rows()\n+    public function get_member_rows()\n     {\n-        return $this->_DAO->fetch(\"SELECT ugm.group_id, ugm.user_id\n-                  FROM \" . APP__DB_TABLE_PREFIX . \"user_group_member ugm\n-                    INNER JOIN \" . APP__DB_TABLE_PREFIX . \"user_group ug ON ugm.group_id = ug.group_id\n-                  WHERE ug.collection_id = '{$this->id}'\n-                  ORDER BY ugm.group_id ASC\");\n-    }// /->get_member_rows()\n+        $memberRowsQuery =\n+            'SELECT ugm.group_id, ugm.user_id ' .\n+            'FROM ' . APP__DB_TABLE_PREFIX . 'user_group_member ugm ' .\n+            'INNER JOIN ' . APP__DB_TABLE_PREFIX . 'user_group ug ' .\n+            'ON ugm.group_id = ug.group_id ' .\n+            'WHERE ug.collection_id = ? ' .\n+            'ORDER BY ugm.group_id ASC';\n+\n+        return $this->_DAO->getConnection()->fetchAllAssociative($memberRowsQuery, [$this->id], [ParameterType::STRING]);\n+    }\n \n     /**\n      * Get group objects for all the groups the given member belongs to\n@@ -488,7 +607,7 @@ function get_member_rows()\n      *\n      * @return array array of group objects\n      */\n-    function & get_member_groups($user_id)\n+    public function & get_member_groups($user_id)\n     {\n         $member_roles = $this->get_member_roles($user_id);\n         if ($member_roles) {\n@@ -498,7 +617,9 @@ function & get_member_groups($user_id)\n             }\n             return $groups;\n         }\n-    }// /->get_member_groups()\n+    }\n+\n+    // /->get_member_groups()\n \n     /**\n      * Get a user's roles for each group in this collection\n@@ -507,14 +628,19 @@ function & get_member_groups($user_id)\n      *\n      * @return array - assoc array ( group_id => user_role );\n      */\n-    function get_member_roles($user_id)\n+    public function get_member_roles($user_id)\n     {\n-        return $this->_DAO->fetch_assoc(\"SELECT ugm.group_id, 'member' AS user_role\n-                    FROM \" . APP__DB_TABLE_PREFIX . \"user_group_member ugm\n-                      INNER JOIN \" . APP__DB_TABLE_PREFIX . \"user_group ug ON ugm.group_id = ug.group_id\n-                    WHERE ug.collection_id = '{$this->id}' AND ugm.user_id = $user_id\n-                    ORDER BY ugm.group_id ASC\");\n-    }// /->get_member_roles()\n+        $memberRolesQuery =\n+            'SELECT ugm.group_id, \"member\" AS user_role ' .\n+            'FROM ' . APP__DB_TABLE_PREFIX . 'user_group_member ugm ' .\n+            'INNER JOIN ' . APP__DB_TABLE_PREFIX . 'user_group ug ' .\n+            'ON ugm.group_id = ug.group_id ' .\n+            'WHERE ug.collection_id = ? ' .\n+            'AND ugm.user_id = ? ' .\n+            'ORDER BY ugm.group_id ASC';\n+\n+        return $this->dbConn->fetchAllKeyValue($memberRolesQuery, [$this->id, $user_id], [ParameterType::STRING, ParameterType::INTEGER]);\n+    }\n \n     /**\n      * Purge a collection of its members using include/exclude lists\n@@ -529,7 +655,7 @@ function get_member_roles($user_id)\n      *                   (array) - array of roles to keep\n      *                   If a user's role is in the $protect_roles list, they are kept\n      */\n-    function purge_members($target_roles = null, $protect_roles = null)\n+    public function purge_members($target_roles = null, $protect_roles = null)\n     {\n         if ($this->is_locked()) {\n             return false;\n@@ -542,7 +668,9 @@ function purge_members($target_roles = null, $protect_roles = null)\n                 $group->purge_members($target_roles, $protect_roles);\n             }\n         }\n-    }// /->purge_members()\n+    }\n+\n+    // /->purge_members()\n \n     /**\n      * Add member to the collection\n@@ -551,20 +679,26 @@ function purge_members($target_roles = null, $protect_roles = null)\n      * @param string $user_id The ID of the user to add\n      * @param string $group_name The name of the group to add the user to\n      */\n-    function add_member($user_id, $group_name)\n+    public function add_member($user_id, $group_name)\n     {\n-\n         $this->remove_member($user_id);\n         $groups = $this->get_groups_array();\n         foreach ($groups as $i => $group_row) {\n             if ($group_row['group_name'] == $group_name) {\n                 $group_id = $group_row['group_id'];\n-                $this->_DAO->execute(\"INSERT INTO \" . APP__DB_TABLE_PREFIX . \"user_group_member SET group_id = '$group_id', user_id = $user_id\");\n+\n+                $this->dbConn->executeQuery(\n+                    'INSERT INTO ' . APP__DB_TABLE_PREFIX . 'user_group_member VALUES (?, ?)',\n+                    [$group_id, $user_id],\n+                    [ParameterType::STRING, ParameterType::INTEGER]\n+                );\n+\n                 break;\n             }\n         }\n+    }\n \n-    }// /->add_member()\n+    // /->add_member()\n \n     /**\n      * Remove members from the collection\n@@ -574,18 +708,29 @@ function add_member($user_id, $group_name)\n      *               (array) - An array of IDs to remove (all of the same user_type)\n      * @param string $role (optional) Group to remove members from. If unused, remove from all groups\n      */\n-    function remove_member($user_id, $role = null)\n+    public function remove_member($user_id, $role = null)\n     {\n-        $user_set = $this->_DAO->build_set((array)$user_id);\n-        $role_clause = ($role) ? \" AND user_role='$role'\" : '';\n-        $this->_DAO->execute(\"DELETE FROM \" . APP__DB_TABLE_PREFIX . \"user_group_member ugm\n-                      WHERE ugm.user_id IN $user_set AND ugm.group_id IN\n-                        (SELECT group_id\n-                         FROM \" . APP__DB_TABLE_PREFIX . \"user_group\n-                         WHERE collection_id = '{$this->id}'\n-                        )\");\n+        $userIdClause = is_array($user_id) ? 'user_id IN (?) ' : 'user_id = ? ';\n+\n+        $removeMemberQuery =\n+            'DELETE FROM ' . APP__DB_TABLE_PREFIX . 'user_group_member ' .\n+            'WHERE ' . $userIdClause .\n+            'AND group_id IN ' .\n+            '(' .\n+            '   SELECT group_id ' .\n+            '   FROM ' . APP__DB_TABLE_PREFIX . 'user_group ' .\n+            '   WHERE collection_id = ? ' .\n+            ')';\n+\n+        $stmt = $this->dbConn->prepare($removeMemberQuery);\n+\n+        $userIdParamType = is_array($user_id) ? $this->_DAO->getConnection()::PARAM_INT_ARRAY : ParameterType::INTEGER;\n \n-    }// /->remove_member()\n+        $stmt->bindValue(1, $user_id, $userIdParamType);\n+        $stmt->bindValue(2, $this->id);\n+\n+        $stmt->execute();\n+    }\n \n     /*\n     * --------------------------------------------------------------------------------\n@@ -598,17 +743,16 @@ function remove_member($user_id, $role = null)\n      *\n      * @return array  array ( module_id )\n      */\n-    function get_modules()\n+    public function get_modules()\n     {\n-        return $this->_DAO->fetch_assoc(\"SELECT DISTINCT c.module_id FROM \" . APP__DB_TABLE_PREFIX . \"collection c\");\n+        $modulesQuery = 'SELECT DISTINCT c.module_id FROM ' . APP__DB_TABLE_PREFIX . 'collection c';\n+\n+        return $this->dbConn->fetchFirstColumn($modulesQuery);\n     }\n \n     /*\n     * ================================================================================\n     * Private Methods\n     * ================================================================================\n     */\n-\n-}// /class: GroupCollection\n-\n-?>\n+}"
        },
        {
          "filename": "src/includes/classes/GroupHandler.php",
          "status": "modified",
          "additions": 53,
          "deletions": 35,
          "patch": "@@ -10,20 +10,22 @@\n \n namespace WebPA\\includes\\classes;\n \n+use Doctrine\\DBAL\\ParameterType;\n+\n class GroupHandler\n {\n-    // Public Vars\n-    public $_DAO = null;  // [pmn] due to a poor iterator implementation, this is currently public\n+    public $_DAO;  // [pmn] due to a poor iterator implementation, this is currently public\n \n-    // Private Vars\n+    private $dbConn;\n \n     /**\n      * CONSTRUCTOR\n      */\n-    function __construct()\n+    public function __construct()\n     {\n         $this->_DAO = new DAO(APP__DB_HOST, APP__DB_USERNAME, APP__DB_PASSWORD, APP__DB_DATABASE);\n-    }// /->GroupHandler()\n+        $this->dbConn = $this->_DAO->getConnection();\n+    }\n \n     /*\n     * ================================================================================\n@@ -38,7 +40,7 @@ function __construct()\n      * @param string $group_numbering\n      * @return array group names\n      */\n-    function generate_group_names($num_groups, $group_name_stub = 'Group', $group_numbering = 'numeric')\n+    public function generate_group_names($num_groups, $group_name_stub = 'Group', $group_numbering = 'numeric')\n     {\n         $group_names = null;\n \n@@ -81,7 +83,7 @@ private function group_suffix_alphabetic($group_num)\n         $prefix = '';\n \n         if ($group_num >= 26) {\n-            $prefix = chr(64 + (int)($group_num / 26));\n+            $prefix = chr(64 + (int) ($group_num / 26));\n         }\n \n         $suffix = chr(65 + ($group_num % 26));\n@@ -125,7 +127,7 @@ private function group_suffix_numeric($group_num)\n      *\n      * @return object  GroupCollection object\n      */\n-    function & clone_collection($collection_id, $include_roles = null)\n+    public function & clone_collection($collection_id, $include_roles = null)\n     {\n         // get the collection to clone\n         $org_collection = new GroupCollection($this->_DAO);\n@@ -166,7 +168,9 @@ function & clone_collection($collection_id, $include_roles = null)\n         }\n \n         return $clone_collection;\n-    }// /->clone_collection()\n+    }\n+\n+    // /->clone_collection()\n \n     /**\n      * Create a new GroupCollection object (gives it a new UUID and returns the object)\n@@ -175,24 +179,28 @@ function & clone_collection($collection_id, $include_roles = null)\n      *\n      * @return array\n      */\n-    function & create_collection()\n+    public function & create_collection()\n     {\n         $new_collection = new GroupCollection($this->_DAO);\n         $new_collection->create();\n         return $new_collection;\n-    }// /->create_collection()\n+    }\n+\n+    // /->create_collection()\n \n     /**\n      * Get a GroupCollection object corresponding to the given group_set_id\n      *\n      * @param string $collection_id ID of GroupCollection to fetch\n      * @return object GroupCollection object\n      */\n-    function get_collection($collection_id)\n+    public function get_collection($collection_id)\n     {\n         $collection = new GroupCollection($this->_DAO);\n         return ($collection->load($collection_id)) ? $collection : null;\n-    }// /->get_collection()\n+    }\n+\n+    // /->get_collection()\n \n     /**\n      * Get collections belonging to the given user\n@@ -202,12 +210,20 @@ function get_collection($collection_id)\n      *\n      * @return array array of collections\n      */\n-    function get_user_collections($user_id, $application_id = null)\n+    public function get_user_collections($user_id)\n     {\n-        return $this->_DAO->fetch('SELECT c.* FROM ' . APP__DB_TABLE_PREFIX . '_collection c INNER JOIN ' .\n-            APP__DB_TABLE_PREFIX . '_user_module um ON c.module_id = um.module_id LEFT OUTER JOIN ' .\n-            APP__DB_TABLE_PREFIX . \"assessment a ON cm.collection_id = a.collection_id WHERE um.user_id = {$user_id} AND a.collection_id IS NULL\");\n-    }// /->get_user_collections()\n+        $query =\n+            'SELECT c.* ' .\n+            'FROM ' . APP__DB_TABLE_PREFIX . 'collection c ' .\n+            'INNER JOIN ' . APP__DB_TABLE_PREFIX . 'user_module um ' .\n+            'ON c.module_id = um.module_id ' .\n+            'LEFT OUTER JOIN ' . APP__DB_TABLE_PREFIX . 'assessment a ' .\n+            'ON c.collection_id = a.collection_id ' .\n+            'WHERE um.user_id = ? ' .\n+            'AND a.collection_id IS NULL';\n+\n+        return $this->dbConn->fetchAllAssociative($query, [$user_id], [ParameterType::INTEGER]);\n+    }\n \n     /**\n      * Get collections belonging to the given module\n@@ -216,47 +232,49 @@ function get_user_collections($user_id, $application_id = null)\n      *\n      * @return array array of collections\n      */\n-    function get_module_collections($module_id)\n+    public function get_module_collections($module_id)\n     {\n-        return $this->_DAO->fetch('SELECT c.*, a.assessment_id AS collection_assessment_id FROM ' . APP__DB_TABLE_PREFIX . 'collection c ' .\n-            'LEFT OUTER JOIN ' . APP__DB_TABLE_PREFIX . 'assessment a ON c.collection_id = a.collection_id ' .\n-            \"WHERE c.module_id = {$module_id} AND a.collection_id IS NULL \" .\n-            'ORDER BY c.collection_name');\n-\n-    }// /->get_module_collections()\n+        $query =\n+            'SELECT c.*, a.assessment_id AS collection_assessment_id ' .\n+            'FROM ' . APP__DB_TABLE_PREFIX . 'collection c ' .\n+            'LEFT OUTER JOIN ' . APP__DB_TABLE_PREFIX . 'assessment a ' .\n+            'ON c.collection_id = a.collection_id ' .\n+            'WHERE c.module_id = ? ' .\n+            'AND a.collection_id IS NULL ' .\n+            'ORDER BY c.collection_name';\n+\n+        return $this->dbConn->fetchAllAssociative($query, [$module_id], [ParameterType::INTEGER]);\n+    }\n \n     /**\n      * function to get member collections\n      * @param string $user_id ID of the member\n-     * @param string $application_id (optional) name of owner-application to search for\n      * @param string $owner_type (optional) type of collection-owner to filter against\n      *\n      * @return array array of collections\n      */\n-    function get_member_collections($user_id, $application_id = null, $owner_type)\n+    public function get_member_collections($user_id, $owner_type)\n     {\n-        if ($owner_type == 'user') {\n+        if ($owner_type === 'user') {\n             $sql = 'SELECT DISTINCT c.*, NULL AS collection_assessment_id FROM ' . APP__DB_TABLE_PREFIX .\n                 'collection c INNER JOIN ' . APP__DB_TABLE_PREFIX .\n                 'user_group ug ON c.collection_id = ug.collection_id INNER JOIN ' . APP__DB_TABLE_PREFIX .\n                 'user_group_member ugm ON ug.group_id = ugm.group_id LEFT OUTER JOIN ' . APP__DB_TABLE_PREFIX .\n-                \"assessment a ON a.collection_id = c.collection_id WHERE ugm.user_id = {$user_id} AND a.collection_id IS NULL\";\n-        } else if ($owner_type == 'assessment') {\n+                'assessment a ON a.collection_id = c.collection_id WHERE ugm.user_id = ? AND a.collection_id IS NULL';\n+        } elseif ($owner_type === 'assessment') {\n             $sql = 'SELECT DISTINCT c.*, a.assessment_id AS collection_assessment_id FROM ' . APP__DB_TABLE_PREFIX .\n                 'collection c INNER JOIN ' . APP__DB_TABLE_PREFIX .\n                 'user_group ug ON c.collection_id = ug.collection_id INNER JOIN ' . APP__DB_TABLE_PREFIX .\n                 'user_group_member ugm ON ug.group_id = ugm.group_id INNER JOIN ' . APP__DB_TABLE_PREFIX .\n-                \"assessment a ON a.collection_id = c.collection_id WHERE ugm.user_id = {$user_id}\";\n+                'assessment a ON a.collection_id = c.collection_id WHERE ugm.user_id = ?';\n         }\n \n-        $res = $this->_DAO->fetch($sql);\n-        return $res;\n-    }// /->get_member_collections()\n+        return $this->dbConn->fetchAllAssociative($sql, [$user_id], [ParameterType::INTEGER]);\n+    }\n \n     /*\n     * ================================================================================\n     * Private Methods\n     * ================================================================================\n     */\n-\n }// /->class: GroupHandler"
        },
        {
          "filename": "src/includes/classes/LDAPAuthenticator.php",
          "status": "removed",
          "additions": 0,
          "deletions": 141,
          "patch": "@@ -1,141 +0,0 @@\n-<?php\n-/**\n- * Class : Authenticate\n- *\n- * Authenticates the given username and password against the LDAP server\n- * In the event of an authentication error, ->get_error() will return:\n- * 'connfailed' : A connection to the authentication server could not be established\n- *  'invalid'   : The login details were invalid\n- *\n- *\n- * @copyright Loughborough University\n- * @license https://www.gnu.org/licenses/gpl-3.0.en.html GPL version 3\n- *\n- * @link https://github.com/webpa/webpa\n- */\n-\n-\n-namespace WebPA\\includes\\classes;\n-\n-use WebPA\\includes\\functions\\StringFunctions;\n-\n-class LDAPAuthenticator extends Authenticator\n-{\n-\n-    private $ldapRequiredFields;\n-\n-    public function __construct(EngCIS $cis, $username = NULL, $password = NULL)\n-    {\n-        parent::__construct($cis, $username, $password);\n-    }\n-\n-    public function setRequiredInfo(array $ldapRequiredFields)\n-    {\n-        $this->ldapRequiredFields = $ldapRequiredFields;\n-    }\n-\n-    /**\n-     * Authenticate users against the LDAP server.\n-     *\n-     * @return bool\n-     */\n-    function authenticate()\n-    {\n-        $this->_authenticated = false;\n-        $this->_error = null;\n-\n-        //set the debug level\n-        ldap_set_option(null, LDAP_OPT_DEBUG_LEVEL, LDAP__DEBUG_LEVEL);\n-\n-        //using the ldap function connect with the specified server\n-        $ldapconn = ldap_connect(LDAP__HOST, LDAP__PORT);\n-\n-        //check the connection\n-        if (!$ldapconn) {\n-            $this->_error = 'connfailed';\n-\n-            return false;\n-        }\n-\n-        //Set this option to cope with Windows Server 2003 Active directories\n-        ldap_set_option($ldapconn, LDAP_OPT_REFERRALS, 0);\n-\n-        //Set the version of LDAP that we will be using\n-        ldap_set_option($ldapconn, LDAP_OPT_PROTOCOL_VERSION, 3);\n-\n-        //construct login name\n-        $user = $this->username . LDAP__USERNAME_EXT;\n-\n-        //bind with the username and password\n-        $bind = ldap_bind($ldapconn, $user, $this->password);\n-\n-        //check the bind has worked\n-        if (!$bind) {\n-            // drop the ldap connection\n-            ldap_unbind($ldapconn);\n-            $this->_error = 'connfailed';\n-\n-            return false;\n-        }\n-\n-        $filter = str_replace('{username}', $this->username, LDAP__FILTER);\n-\n-        $info_req = $this->ldapRequiredFields;\n-        $info_req[] = LDAP__USER_TYPE_ATTRIBUTE;\n-        $result = ldap_search($ldapconn, LDAP__BASE, $filter, $info_req);\n-\n-        //check the bind has worked\n-        if (!$result) {\n-            //drop the ldap connection\n-            ldap_unbind($ldapconn);\n-            $this->_error = 'invalid';\n-\n-            return false;\n-        }\n-\n-        $info = ldap_get_entries($ldapconn, $result);\n-\n-        ldap_unbind($ldapconn);\n-\n-        if ($info['count'] == 0) {\n-            return false;\n-        }\n-\n-        $_fields = [\n-            'forename' => $info[0]['givenname'][0],\n-            'lastname' => $info[0]['sn'][0],\n-            'email' => $info[0]['mail'][0],\n-            'user_type' => get_LDAP_user_type($info[0][LDAP__USER_TYPE_ATTRIBUTE]),\n-        ];\n-\n-        $els = [];\n-\n-        foreach ($_fields as $key => $val) {\n-            $els[] = \"$key = '$val'\";\n-        }\n-\n-        $DAO = $this->get_DAO();\n-        if (LDAP__AUTO_CREATE_USER) {\n-\n-            $sql = 'INSERT INTO ' . APP__DB_TABLE_PREFIX . 'user SET ' . implode(', ', $els) . \", username = '{$this->username}', password = '\" . md5(StringFunctions::str_random()) . \"', source_id = ''\";\n-            $sql .= ' ON DUPLICATE KEY UPDATE ' . implode(', ', $els);\n-            $DAO->execute($sql);\n-            $id = $DAO->get_insert_id();\n-            if (!$id) {\n-                $sql = 'SELECT user_id FROM ' . APP__DB_TABLE_PREFIX . \"user WHERE username = '{$this->username}' AND source_id = ''\";\n-                $id = $DAO->fetch_value($sql);\n-            }\n-            $sql = 'SELECT * FROM ' . APP__DB_TABLE_PREFIX . \"user WHERE user_id = $id\";\n-\n-        } else {\n-\n-            $sql = 'UPDATE ' . APP__DB_TABLE_PREFIX . 'user SET ' . implode(', ', $els) . \" WHERE username = '{$this->username}' AND source_id = ''\";\n-            $DAO->execute($sql);\n-            $sql = 'SELECT * FROM ' . APP__DB_TABLE_PREFIX . \"user WHERE username = '{$this->username}' AND source_id = ''\";\n-\n-            $sql = 'SELECT * FROM ' . APP__DB_TABLE_PREFIX . \"user WHERE username = '{$this->username}' AND source_id = ''\";\n-        }\n-\n-        return $this->initialise($sql);\n-    }\n-}"
        },
        {
          "filename": "src/includes/classes/Module.php",
          "status": "modified",
          "additions": 125,
          "deletions": 90,
          "patch": "@@ -12,111 +12,146 @@\n \n namespace WebPA\\includes\\classes;\n \n-class Module {\n-  // Public Vars\n-  public $module_code = NULL;\n-  public $module_title = NULL;\n-  public $module_id = NULL;\n-\n-  public $DAO = NULL;\n-\n-  /**\n-  * CONSTRUCTOR for the class function\n-  * @param string $code\n-  * @param string $title\n-  */\n-  function __construct($module_code = null, $module_title = null) {\n-    $this->module_code = $module_code;\n-    $this->module_title = $module_title;\n-    $this->module_id = null;\n-  }// /->Module()\n-\n-/*\n-* ================================================================================\n-* PUBLIC\n-*================================================================================\n-*/\n-\n-  /**\n-  * Load the object from the given data\n-  *\n-  * @param array $module_info  assoc-array of Module info\n-  *\n-  * @return boolean did the load succeed\n-  */\n-  function load_from_row($module_info) {\n-    if (is_array($module_info) && isset($module_info['module_id'])) {\n-      $this->module_id = $module_info['module_id'];\n-      $this->module_code = $module_info['module_code'];\n-      $this->module_title = $module_info['module_title'];\n-    }\n-    return true;\n-  }// /->load_from_row()\n+use Doctrine\\DBAL\\ParameterType;\n \n-  /**\n-   * Function to update the module details\n-   */\n-   function save_module(){\n+class Module\n+{\n+    // Public Vars\n+    public $module_code;\n \n-    $_fields = array ('module_code'        => $this->module_code ,\n-              'module_title'        => $this->module_title,\n-               );\n+    public $module_title;\n \n-    //save the changes to the module\n-    $this->DAO->do_update(\"UPDATE \" . APP__DB_TABLE_PREFIX . \"module SET {fields} WHERE module_id = {$this->module_id}; \",$_fields);\n+    public $module_id;\n \n-    return true;\n-   }\n+    public DAO $DAO;\n \n-   /**\n-    * Function to set the database connection to be used\n-    * @param database connection $DB\n+    /**\n+    * CONSTRUCTOR for the class function\n+    * @param string $code\n+    * @param string $title\n     */\n-    function set_dao_object($DB){\n-      $this->DAO = $DB;\n+    public function __construct($module_code = null, $module_title = null)\n+    {\n+        $this->module_code = $module_code;\n+        $this->module_title = $module_title;\n+        $this->module_id = null;\n     }\n \n-  /**\n-   * Function to add new module details\n-   */\n-   function add_module(){\n+    // /->Module()\n \n-    $_fields = array ('module_code'        => $this->module_code ,\n-              'module_title'        => $this->module_title,\n-               );\n+    /*\n+    * ================================================================================\n+    * PUBLIC\n+    *================================================================================\n+    */\n \n-    //save the changes to the module\n-    $this->DAO->do_update('INSERT INTO ' . APP__DB_TABLE_PREFIX . \"module SET {fields}\", $_fields);\n+    /**\n+    * Load the object from the given data\n+    *\n+    * @param array $module_info  assoc-array of Module info\n+    *\n+    * @return boolean did the load succeed\n+    */\n+    public function load_from_row($module_info)\n+    {\n+        if (is_array($module_info) && isset($module_info['module_id'])) {\n+            $this->module_id = $module_info['module_id'];\n+            $this->module_code = $module_info['module_code'];\n+            $this->module_title = $module_info['module_title'];\n+        }\n+        return true;\n+    }\n \n-    return $this->DAO->get_insert_id() ;\n-   }\n+    // /->load_from_row()\n \n-  /**\n-   * Function to delete a module\n-   */\n-   function delete(){\n+    /**\n+     * Function to update the module details\n+     */\n+    public function save_module()\n+    {\n+        $dbConn = $this->DAO->getConnection();\n \n-     $collections = $this->DAO->fetch_col(\"SELECT collection_id FROM \" . APP__DB_TABLE_PREFIX . \"collection WHERE module_id = $this->module_id\");\n-     $group_handler = new GroupHandler();\n-     for ($i=0; $i<count($collections); $i++) {\n-       $collection = $group_handler->get_collection($collections[$i]);\n-       $collection->delete();\n-     }\n-     $this->DAO->execute('DELETE FROM ' . APP__DB_TABLE_PREFIX . \"user_module WHERE module_id = {$this->module_id}\");\n-     $this->DAO->execute('DELETE FROM ' . APP__DB_TABLE_PREFIX . \"module WHERE module_id = {$this->module_id}\");\n+        $stmt = $dbConn->prepare('UPDATE ' . APP__DB_TABLE_PREFIX . 'module SET module_code = ?, module_title = ? WHERE module_id = ?');\n \n-     $this->module_code = null;\n-     $this->module_title = null;\n-     $this->module_id = null;\n+        $stmt->bindValue(1, $this->module_code);\n+        $stmt->bindValue(2, $this->module_title);\n+        $stmt->bindValue(3, $this->module_id, ParameterType::INTEGER);\n \n-   }\n+        $stmt->execute();\n \n-/*\n-* ================================================================================\n-* PRIVATE\n-* ================================================================================\n-*/\n+        return true;\n+    }\n \n-}// /class: Module\n+    /**\n+     * Function to set the database connection to be used\n+     * @param DAO connection $DB\n+     */\n+    public function set_dao_object(DAO $DB)\n+    {\n+        $this->DAO = $DB;\n+    }\n+\n+    /**\n+     * Function to add new module details\n+     */\n+    public function add_module()\n+    {\n+        $addModuleQuery =\n+        'INSERT INTO ' . APP__DB_TABLE_PREFIX . 'module ' .\n+        '(module_code, module_title) ' .\n+        'VALUES (?, ?)';\n+\n+        $stmt = $this->DAO->getConnection()->prepare($addModuleQuery);\n \n-?>\n+        $stmt->bindValue(1, $this->module_code);\n+        $stmt->bindValue(2, $this->module_title);\n+\n+        $stmt->execute();\n+\n+        return $this->DAO->getConnection()->lastInsertId('module_id');\n+    }\n+\n+    /**\n+     * Function to delete a module\n+     */\n+    public function delete()\n+    {\n+        $deleteModuleQuery =\n+           'SELECT collection_id ' .\n+           'FROM ' . APP__DB_TABLE_PREFIX . 'collection ' .\n+           'WHERE module_id = ?';\n+\n+        $collections = $this->DAO->getConnection()->fetchFirstColumn($deleteModuleQuery, [$this->module_id], [ParameterType::INTEGER]);\n+\n+        $group_handler = new GroupHandler();\n+\n+        for ($i=0; $i<count($collections); $i++) {\n+            $collection = $group_handler->get_collection($collections[$i]);\n+            $collection->delete();\n+        }\n+\n+        $dbConn = $this->DAO->getConnection();\n+\n+        $dbConn->executeQuery(\n+            'DELETE FROM ' . APP__DB_TABLE_PREFIX . 'user_module WHERE module_id = ?',\n+            [$this->module_id],\n+            [ParameterType::INTEGER]\n+        );\n+\n+        $dbConn->executeQuery(\n+            'DELETE FROM ' . APP__DB_TABLE_PREFIX . 'module WHERE module_id = ?',\n+            [$this->module_id],\n+            [ParameterType::INTEGER]\n+        );\n+\n+        $this->module_code = null;\n+        $this->module_title = null;\n+        $this->module_id = null;\n+    }\n+\n+    /*\n+    * ================================================================================\n+    * PRIVATE\n+    * ================================================================================\n+    */\n+}// /class: Module"
        },
        {
          "filename": "src/includes/classes/NewAlgorithm.php",
          "status": "modified",
          "additions": 146,
          "deletions": 155,
          "patch": "@@ -16,206 +16,197 @@\n \n namespace WebPA\\includes\\classes;\n \n-class NewAlgorithm extends WebPAAlgorithm {\n-\n-  private $group_member_awarded;\n+class NewAlgorithm extends WebPAAlgorithm\n+{\n+    private $group_member_awarded;\n     \n-  function __construct() {\n-    WebPAAlgorithm::_init();\n-  }// /->NewAlgorithm()\n-\n-/*\n-* ================================================================================\n-* Public Methods\n-* ================================================================================\n-*/\n+    public function __construct()\n+    {\n+        WebPAAlgorithm::_init();\n+    }\n \n-  /*\n-  * Calculate the WebPA and group scores for each member\n-  */\n-  function calculate() {\n+    // /->NewAlgorithm()\n \n     /*\n-    * Perform a few different tasks and initialisations by looping through all the responses\n+    * ================================================================================\n+    * Public Methods\n+    * ================================================================================\n     */\n-    foreach ($this->_responses as $i => $response) {\n-      // Process the responses and re-factor the array into a more usable form\n-      $this->_group_member_responses[\"{$response['group_id']}\"][\"{$response['user_id']}\"][\"{$response['question_id']}\"][\"{$response['marked_user_id']}\"] = $response['score'];\n \n-      // Record the fact this group member submitted\n-      $this->_group_member_submitted[\"{$response['group_id']}\"][\"{$response['user_id']}\"] = true;\n+    // Calculate the WebPA and group scores for each member\n+    public function calculate()\n+    {\n \n-      // Record the fact this member submitted (separate from group-member)\n-      $this->_member_submitted[\"{$response['user_id']}\"] = true;\n+    // Perform a few different tasks and initialisations by looping through all the responses\n+        foreach ($this->_responses as $i => $response) {\n+            // Process the responses and re-factor the array into a more usable form\n+            $this->_group_member_responses[\"{$response['group_id']}\"][\"{$response['user_id']}\"][\"{$response['question_id']}\"][\"{$response['marked_user_id']}\"] = $response['score'];\n \n-    }\n+            // Record the fact this group member submitted\n+            $this->_group_member_submitted[\"{$response['group_id']}\"][\"{$response['user_id']}\"] = true;\n \n-    /*\n-    * Begin the actual scoring algorithm.\n-    * Individual algorithmic steps are numbered\n-    */\n+            // Record the fact this member submitted (separate from group-member)\n+            $this->_member_submitted[\"{$response['user_id']}\"] = true;\n+        }\n \n-    // Take each group in turn\n-    foreach ($this->_groups as $group_id => $group_mark) {\n+        /*\n+        * Begin the actual scoring algorithm.\n+        * Individual algorithmic steps are numbered\n+        */\n \n-      $group_had_submissions = false;\n+        // Take each group in turn\n+        foreach ($this->_groups as $group_id => $group_mark) {\n+            $group_had_submissions = false;\n \n-      $this->_group_member_frac_scores_awarded[\"$group_id\"] = array ();\n-      $this->_group_member_total_received[$group_id] =  array();\n+            $this->_group_member_frac_scores_awarded[\"$group_id\"] = [];\n+            $this->_group_member_total_received[$group_id] =  [];\n \n-      // Take each member in turn\n-      foreach ($this->_group_members[\"$group_id\"] as $i => $member_id) {\n+            // Take each member in turn\n+            foreach ($this->_group_members[\"$group_id\"] as $i => $member_id) {\n \n         // Initialise each member's totals and scores\n-        $this->_group_member_total_received[\"$group_id\"][\"$member_id\"] = 0;\n-        $this->_group_member_webpa_scores[\"$group_id\"][\"$member_id\"] = 0;\n-        $this->_group_member_grades[\"$group_id\"][\"$member_id\"] = 0;\n+                $this->_group_member_total_received[\"$group_id\"][\"$member_id\"] = 0;\n+                $this->_group_member_webpa_scores[\"$group_id\"][\"$member_id\"] = 0;\n+                $this->_group_member_grades[\"$group_id\"][\"$member_id\"] = 0;\n \n-        // If the member submitted a response, then we need to normalise the scores awarded\n-        if (array_key_exists($member_id, $this->_member_submitted)) {\n+                // If the member submitted a response, then we need to normalise the scores awarded\n+                if (array_key_exists($member_id, $this->_member_submitted)) {\n \n           /*\n            * We need to signal that at least one member submitted marks\n            * If we don't we can't differentiate between 0-marks because someone was poor\n            * and 0-marks because no one submitted anything - in which case every member\n            * should automatically get a WebPA score of 1.\n            */\n-          $group_had_submissions = true;\n+                    $group_had_submissions = true;\n \n-          /*\n-           * (1)\n-           * Get the total number of marks each member awarded\n-           * This will form the basis for our normalisation in step (2)\n-           */\n+                    /*\n+                     * (1)\n+                     * Get the total number of marks each member awarded\n+                     * This will form the basis for our normalisation in step (2)\n+                     */\n \n-          $this->_group_member_total_awarded[\"$group_id\"][\"$member_id\"] = 0;  // Initialise member-total\n-          $this->group_member_awarded[\"$group_id\"][\"$member_id\"] = array();\n+                    $this->_group_member_total_awarded[\"$group_id\"][\"$member_id\"] = 0;  // Initialise member-total\n+                    $this->group_member_awarded[\"$group_id\"][\"$member_id\"] = [];\n \n-          if (!array_key_exists($group_id, $this->_group_member_responses)) {\n+                    if (!array_key_exists($group_id, $this->_group_member_responses)) {\n \n             // Do nothing, there's nothing to process\n-\n-          } else {\n-\n-            foreach ($this->_questions as $i => $question_id) {\n-\n-              foreach($this->_group_member_responses[\"$group_id\"][\"$member_id\"][\"$question_id\"] as $marked_user_id => $score) {\n-                // Add the given score to the total\n-                $this->_group_member_total_awarded[\"$group_id\"][\"$member_id\"] += $score;\n-                if (!array_key_exists($marked_user_id, $this->group_member_awarded[\"$group_id\"][\"$member_id\"])) {\n-                  $this->group_member_awarded[\"$group_id\"][\"$member_id\"][\"$marked_user_id\"] = null;\n-                } else {\n-                  $this->group_member_awarded[\"$group_id\"][\"$member_id\"][\"$marked_user_id\"] += $score;\n+                    } else {\n+                        foreach ($this->_questions as $i => $question_id) {\n+                            foreach ($this->_group_member_responses[\"$group_id\"][\"$member_id\"][\"$question_id\"] as $marked_user_id => $score) {\n+                                // Add the given score to the total\n+                                $this->_group_member_total_awarded[\"$group_id\"][\"$member_id\"] += $score;\n+                                if (!array_key_exists($marked_user_id, $this->group_member_awarded[\"$group_id\"][\"$member_id\"])) {\n+                                    $this->group_member_awarded[\"$group_id\"][\"$member_id\"][\"$marked_user_id\"] = null;\n+                                } else {\n+                                    $this->group_member_awarded[\"$group_id\"][\"$member_id\"][\"$marked_user_id\"] += $score;\n+                                }\n+                            }// /foreach(member-response)\n+                        }// /foreach(question)\n+                    }\n+\n+                    /*\n+                     * (2)\n+                     * Get the normalised fraction awarded by each member to each member\n+                     * If member-A gave member-B 4 marks, then the fraction awarded = 4 / total-marks-member-A-awarded\n+                     */\n+\n+                    // If the member gave more than 0 marks in total, calculate the fraction awarded\n+                    if ($this->_group_member_total_awarded[\"$group_id\"][\"$member_id\"]>0) {\n+                        foreach ($this->_questions as $i => $question_id) {\n+                            foreach ($this->_group_member_responses[\"$group_id\"][\"$member_id\"][\"$question_id\"] as $marked_user_id => $score) {\n+                                $this->_group_member_frac_scores_awarded[\"$group_id\"][\"$member_id\"][\"$question_id\"][\"$marked_user_id\"] = $score / $this->_group_member_total_awarded[\"$group_id\"][\"$member_id\"];\n+                            }// /foreach(member-response)\n+                        }// /foreach(question)\n+                    }// /if (member-total-award==0)\n+                }// /if(member-submitted)\n+            }// /foreach(member)\n+\n+            // All the scores are now normalised. Time to calculate the actual WebPA scores\n+\n+            /*\n+             * (3)\n+             * Get the multiplication factor we need to calculate the WebPA scores\n+             * factor = num-members-total / num-members-submitted\n+             */\n+\n+            $num_members = ((is_array($this->_group_members)) && (array_key_exists($group_id, $this->_group_members))) ? count($this->_group_members[\"$group_id\"]) : 0 ;\n+            $num_submitted = ((is_array($this->_group_member_submitted)) && (array_key_exists($group_id, $this->_group_member_submitted))) ? count($this->_group_member_submitted[\"$group_id\"]) : 0 ;\n+\n+            $multi_factor = ($num_submitted>0) ? ($num_members / $num_submitted) : 1 ;\n+\n+            $pa_group_mark = ($this->_marking_params['weighting']/100) * $group_mark;\n+            $nonpa_group_mark = ((100-$this->_marking_params['weighting']) /100) * $group_mark;\n+\n+            /*\n+             * (4)\n+             * Get the total fractional score awarded to each member for each question\n+             */\n+\n+            foreach ($this->_group_member_frac_scores_awarded[\"$group_id\"] as $member_id => $q_array) {\n+                foreach ($q_array as $question_id => $marked_array) {\n+                    foreach ($marked_array as $marked_user_id => $frac_score) {\n+                        $this->_group_member_total_received[\"$group_id\"][\"$marked_user_id\"] += $frac_score;\n+                    }\n                 }\n-              }// /foreach(member-response)\n-\n-            }// /foreach(question)\n-\n-          }\n-\n-          /*\n-           * (2)\n-           * Get the normalised fraction awarded by each member to each member\n-           * If member-A gave member-B 4 marks, then the fraction awarded = 4 / total-marks-member-A-awarded\n-           */\n-\n-          // If the member gave more than 0 marks in total, calculate the fraction awarded\n-          if ($this->_group_member_total_awarded[\"$group_id\"][\"$member_id\"]>0) {\n-\n-            foreach ($this->_questions as $i => $question_id) {\n+            }\n \n-              foreach ($this->_group_member_responses[\"$group_id\"][\"$member_id\"][\"$question_id\"] as $marked_user_id => $score) {\n-                $this->_group_member_frac_scores_awarded[\"$group_id\"][\"$member_id\"][\"$question_id\"][\"$marked_user_id\"] = $score / $this->_group_member_total_awarded[\"$group_id\"][\"$member_id\"];\n-              }// /foreach(member-response)\n+            if (array_key_exists($group_id, $this->_group_member_total_received)) {\n+                foreach ($this->_group_member_total_received[\"$group_id\"] as $member_id => $total_frac_score) {\n+                    /*\n+                     * (5)\n+                     * Get the WebPA score = total fractional score awarded to a member * multiplication-factor\n+                     */\n+                    $this->_group_member_webpa_scores[\"$group_id\"][\"$member_id\"] = $total_frac_score * $multi_factor;\n \n-            }// /foreach(question)\n+                    /*\n+                     * (6)\n+                     * Get the member's intermediate grade = WebPA score * weighted-group-mark     (does not include penalties)\n+                     */\n+                    if ($group_had_submissions) {\n+                        $intermediate_grade = (($total_frac_score * $multi_factor * $pa_group_mark) + $nonpa_group_mark);\n+                    } else {\n+                        $intermediate_grade = $pa_group_mark + $nonpa_group_mark;\n+                    }\n \n-          }// /if (member-total-award==0)\n+                    if ($intermediate_grade<0) {\n+                        $intermediate_grade = 0;\n+                    } elseif ($intermediate_grade>100) {\n+                        $intermediate_grade = 100;\n+                    }\n \n-        }// /if(member-submitted)\n+                    $this->_group_member_intermediate_grades[\"$group_id\"][\"$member_id\"] = $intermediate_grade;\n \n-      }// /foreach(member)\n \n-      // All the scores are now normalised. Time to calculate the actual WebPA scores\n+                    /* (7)\n+                     * Get the member's grade = WebPA score * weighted-group-mark * any penalty\n+                     */\n \n-      /*\n-       * (3)\n-       * Get the multiplication factor we need to calculate the WebPA scores\n-       * factor = num-members-total / num-members-submitted\n-       */\n+                    $penalty = (array_key_exists($member_id, $this->_member_submitted)) ? 1 : 1-($this->_marking_params['penalty']/100) ;\n \n-      $num_members = ( (is_array($this->_group_members)) && (array_key_exists($group_id, $this->_group_members)) ) ? count($this->_group_members[\"$group_id\"]) : 0 ;\n-      $num_submitted = ( (is_array($this->_group_member_submitted)) && (array_key_exists($group_id, $this->_group_member_submitted)) ) ? count($this->_group_member_submitted[\"$group_id\"]) : 0 ;\n+                    // Don't need this bit now:\n+                    // $final_grade = (($total_frac_score * $multi_factor * $pa_group_mark) + $nonpa_group_mark) * $penalty;\n \n-      $multi_factor = ($num_submitted>0) ? ($num_members / $num_submitted) : 1 ;\n+                    $final_grade = $intermediate_grade * $penalty;\n \n-      $pa_group_mark = ($this->_marking_params['weighting']/100) * $group_mark;\n-      $nonpa_group_mark = ( (100-$this->_marking_params['weighting']) /100 ) * $group_mark;\n+                    if ($final_grade<0) {\n+                        $final_grade = 0;\n+                    } elseif ($final_grade>100) {\n+                        $final_grade = 100;\n+                    }\n \n-      /*\n-       * (4)\n-       * Get the total fractional score awarded to each member for each question\n-       */\n-\n-      foreach ($this->_group_member_frac_scores_awarded[\"$group_id\"] as $member_id => $q_array) {\n-        foreach ($q_array as $question_id => $marked_array) {\n-          foreach ($marked_array as $marked_user_id => $frac_score) {\n-            $this->_group_member_total_received[\"$group_id\"][\"$marked_user_id\"] += $frac_score;\n-          }\n-        }\n-      }\n-\n-      if (array_key_exists($group_id, $this->_group_member_total_received)) {\n-        foreach ($this->_group_member_total_received[\"$group_id\"] as $member_id => $total_frac_score) {\n-          /*\n-           * (5)\n-           * Get the WebPA score = total fractional score awarded to a member * multiplication-factor\n-           */\n-          $this->_group_member_webpa_scores[\"$group_id\"][\"$member_id\"] = $total_frac_score * $multi_factor;\n-\n-          /*\n-           * (6)\n-           * Get the member's intermediate grade = WebPA score * weighted-group-mark     (does not include penalties)\n-           */\n-          if ($group_had_submissions) {\n-            $intermediate_grade = (($total_frac_score * $multi_factor * $pa_group_mark) + $nonpa_group_mark);\n-          } else {\n-            $intermediate_grade = $pa_group_mark + $nonpa_group_mark;\n-          }\n-\n-          if ($intermediate_grade<0) { $intermediate_grade = 0; }\n-          elseif ($intermediate_grade>100) { $intermediate_grade = 100; }\n-\n-          $this->_group_member_intermediate_grades[\"$group_id\"][\"$member_id\"] = $intermediate_grade;\n-\n-\n-          /* (7)\n-           * Get the member's grade = WebPA score * weighted-group-mark * any penalty\n-           */\n-\n-          $penalty = (array_key_exists($member_id, $this->_member_submitted)) ? 1 : 1-($this->_marking_params['penalty']/100) ;\n-\n-          // Don't need this bit now:\n-          // $final_grade = (($total_frac_score * $multi_factor * $pa_group_mark) + $nonpa_group_mark) * $penalty;\n-\n-          $final_grade = $intermediate_grade * $penalty;\n-\n-          if ($final_grade<0) { $final_grade = 0; }\n-          elseif ($final_grade>100) { $final_grade = 100; }\n-\n-          $this->_group_member_grades[\"$group_id\"][\"$member_id\"] = $final_grade;\n-        }\n-      }\n-    }// /foreach(group)\n+                    $this->_group_member_grades[\"$group_id\"][\"$member_id\"] = $final_grade;\n+                }\n+            }\n+        }// /foreach(group)\n+    }\n \n-  }// /->calculate()\n+    // /->calculate()\n \n /*\n * ================================================================================\n * Private Methods\n * ================================================================================\n */\n-\n }// /class: NewAlgorithm\n-\n-?>"
        },
        {
          "filename": "src/includes/classes/ResultHandler.php",
          "status": "modified",
          "additions": 130,
          "deletions": 77,
          "patch": "@@ -10,25 +10,33 @@\n \n namespace WebPA\\includes\\classes;\n \n+use Doctrine\\DBAL\\ParameterType;\n use WebPA\\includes\\functions\\Common;\n \n class ResultHandler\n {\n     private $_DAO;\n+\n     private $_assessment;\n+\n     private $_collection;\n+\n     private $_collection_id;\n+\n+    private $dbConn;\n+\n     private $moduleId;\n \n     /*\n     * CONSTRUCTOR for the result handler\n     * @param mixed $DAO\n     */\n-    function __construct(DAO $DAO)\n+    public function __construct(DAO $DAO)\n     {\n         $this->moduleId = Common::fetch_SESSION('_module_id', null);\n \n         $this->_DAO = $DAO;\n+        $this->dbConn = $this->_DAO->getConnection();\n     }\n \n     /*\n@@ -47,7 +55,7 @@ function __construct(DAO $DAO)\n      * Set Assessment object\n      * @param object $assessment assessment object to use\n      */\n-    function set_assessment(&$assessment)\n+    public function set_assessment(&$assessment)\n     {\n         $this->_assessment =& $assessment;\n \n@@ -62,160 +70,205 @@ function set_assessment(&$assessment)\n      * Return the Assessment object being used\n      * @return object assessment object used\n      */\n-    function & get_assessment()\n+    public function & get_assessment()\n     {\n         return $this->_assessment;\n-    }// /->get_assessment()\n+    }\n+\n+    // /->get_assessment()\n \n     /**\n      * Fetch all responses for this assessment\n      * @return array array of the responses for the given assessment\n      */\n-    function get_responses()\n+    public function get_responses()\n     {\n-        return $this->_DAO->fetch(\"SELECT um.group_id, um.user_id, um.marked_user_id, um.question_id, um.score\n-                      FROM \" . APP__DB_TABLE_PREFIX . \"user_mark um\n-                        INNER JOIN \" . APP__DB_TABLE_PREFIX . \"assessment a ON um.assessment_id = a.assessment_id\n-                      WHERE um.assessment_id = '{$this->_assessment->id}'\n-                        AND a.collection_id = '{$this->_collection_id}'\n-                      ORDER BY um.group_id, um.user_id, um.marked_user_id, um.question_id\");\n-    }// /->get_responses()\n+        $query =\n+            'SELECT um.group_id, um.user_id, um.marked_user_id, um.question_id, um.score ' .\n+            'FROM ' . APP__DB_TABLE_PREFIX . 'user_mark um ' .\n+            'INNER JOIN ' . APP__DB_TABLE_PREFIX . 'assessment a ' .\n+            'ON um.assessment_id = a.assessment_id ' .\n+            'WHERE um.assessment_id = ? ' .\n+            'AND a.collection_id = ? ' .\n+            'ORDER BY um.group_id, um.user_id, um.marked_user_id, um.question_id';\n+\n+        return $this->dbConn->fetchAllAssociative($query, [$this->_assessment->id, $this->_collection_id], [ParameterType::STRING, ParameterType::STRING]);\n+    }\n \n     /**\n      * Function to get the marks fot the assessment\n      * @return integer number of users\n      */\n-    function get_responses_count_for_assessment()\n+    public function get_responses_count_for_assessment()\n     {\n-        return $this->_DAO->fetch_value(\"SELECT COUNT(DISTINCT um.user_id)\n-                    FROM \" . APP__DB_TABLE_PREFIX . \"user_mark um\n-                      INNER JOIN \" . APP__DB_TABLE_PREFIX . \"assessment a ON um.assessment_id = a.assessment_id\n-                    WHERE um.assessment_id = '{$this->_assessment->id}'\n-                      AND a.collection_id = '{$this->_collection->id}'\");\n+        $responseCountsQuery =\n+            'SELECT COUNT(DISTINCT um.user_id) ' .\n+            'FROM ' . APP__DB_TABLE_PREFIX . 'user_mark um ' .\n+            'INNER JOIN ' . APP__DB_TABLE_PREFIX . 'assessment a ' .\n+            'ON um.assessment_id = a.assessment_id ' .\n+            'WHERE um.assessment_id = ? ' .\n+            'AND a.collection_id = ?';\n \n-    }// /->get_responses_count_for_assessment()\n+        return $this->dbConn->fetchOne($responseCountsQuery, [$this->_assessment->id, $this->_collection->id], [ParameterType::STRING, ParameterType::STRING]);\n+    }\n \n     /**\n      * Function to get the number of students who have responded to the assessment\n      * @return array all the user ids of those who has responded\n      */\n-    function get_responded_users()\n+    public function get_responded_users()\n     {\n-        return $this->_DAO->fetch_col(\"\n-      SELECT DISTINCT um.user_id\n-      FROM \" . APP__DB_TABLE_PREFIX . \"user_mark um\n-        INNER JOIN \" . APP__DB_TABLE_PREFIX . \"assessment a ON um.assessment_id = a.assessment_id\n-      WHERE um.assessment_id = '{$this->_assessment->id}'\n-            AND a.collection_id = '{$this->_collection->id}'\n-      ORDER BY um.user_id\n-    \");\n-    }// /->get_responded_users()\n+        $usersThatRespondedQuery =\n+            'SELECT DISTINCT um.user_id ' .\n+            'FROM ' . APP__DB_TABLE_PREFIX . 'user_mark um ' .\n+            'INNER JOIN ' . APP__DB_TABLE_PREFIX . 'assessment a ' .\n+            'ON um.assessment_id = a.assessment_id ' .\n+            'WHERE um.assessment_id = ? ' .\n+            'AND a.collection_id = ? ' .\n+            'ORDER BY um.user_id';\n+\n+        return $this->dbConn->fetchFirstColumn($usersThatRespondedQuery, [$this->_assessment->id, $this->_collection->id], [ParameterType::STRING, ParameterType::STRING]);\n+    }\n \n     /**\n      * Fetch a count of the responses for the given group\n      * @param integer $group_id\n      * @return integer count of the responses\n      */\n-    function get_responses_count($group_id)\n+    public function get_responses_count($group_id)\n     {\n         if ($this->_collection->group_id_exists($group_id)) {\n-            return $this->_DAO->fetch_value(\"\n-        SELECT COUNT(DISTINCT user_id)\n-        FROM \" . APP__DB_TABLE_PREFIX . \"user_mark um\n-          INNER JOIN \" . APP__DB_TABLE_PREFIX . \"assessment a ON um.assessment_id = a.assessment_id\n-        WHERE um.assessment_id = '{$this->_assessment->id}'\n-          AND a.collection_id = '{$this->_collection->id}'\n-          AND um.group_id = '$group_id'\n-      \");\n-        } else {\n-            return null;\n+            $responseCountQuery =\n+                'SELECT COUNT(DISTINCT user_id) ' .\n+                'FROM ' . APP__DB_TABLE_PREFIX . 'user_mark um ' .\n+                'INNER JOIN ' . APP__DB_TABLE_PREFIX . 'assessment a ' .\n+                'ON um.assessment_id = a.assessment_id ' .\n+                'WHERE um.assessment_id = ? ' .\n+                'AND a.collection_id = ? ' .\n+                'AND um.group_id = ?';\n+\n+            return $this->dbConn->fetchOne($responseCountQuery, [$this->_assessment->id, $this->_collection->id, $group_id], [ParameterType::STRING, ParameterType::STRING, ParameterType::STRING]);\n         }\n-    }// /->get_responses_count()\n+        return null;\n+    }\n+\n+    // /->get_responses_count()\n \n     /**\n      * Fetch a count of the responses for all this user's assessments (that opened this academic year)\n      * @param integer $user_id\n      * @param date $year\n      * @return array\n      */\n-    function get_responses_count_for_user($user_id, $year = NULL)\n+    public function get_responses_count_for_user($user_id, $year = null)\n     {\n-        $sql = \"SELECT a.assessment_id, COUNT(DISTINCT um.user_id)\n-      FROM \" . APP__DB_TABLE_PREFIX . \"assessment a\n-        LEFT JOIN \" . APP__DB_TABLE_PREFIX . \"user_mark um ON a.assessment_id = um.assessment_id\n-          AND a.module_id = {$this->moduleId} \";\n+        $sql =\n+            'SELECT a.assessment_id, COUNT(DISTINCT um.user_id) AS response_count ' .\n+            'FROM ' . APP__DB_TABLE_PREFIX . 'assessment a ' .\n+            'LEFT JOIN ' . APP__DB_TABLE_PREFIX . 'user_mark um ' .\n+            'ON a.assessment_id = um.assessment_id ' .\n+            'AND a.module_id = ? ';\n+\n         if (!empty($year)) {\n             $next_year = $year + 1;\n-            $month = strval(APP__ACADEMIC_YEAR_START_MONTH);\n+\n+            $month = (string) APP__ACADEMIC_YEAR_START_MONTH;\n+\n             if (APP__ACADEMIC_YEAR_START_MONTH < 10) {\n                 $month = '0' . $month;\n             }\n-            $sql .= \"AND a.open_date >= '{$year}-{$month}-01 00:00:00'\n-          AND a.open_date < '{$next_year}-{$month}-01 00:00:00' \";\n+\n+            $startDate = \"$year-$month-01 00:00:00\";\n+            $endDate = \"$next_year-$month-01 00:00:00\";\n+\n+            $sql .=\n+                'AND a.open_date >= ? ' .\n+                'AND a.open_date < ? ';\n         }\n+\n         $sql .= 'GROUP BY assessment_id';\n-        return $this->_DAO->fetch_assoc($sql);\n-    }// /->get_responses_count_for_user()\n+\n+        if (!empty($year)) {\n+            return  $this->dbConn->fetchAllKeyValue($sql, [$this->moduleId, $startDate, $endDate], [ParameterType::INTEGER, ParameterType::STRING, ParameterType::STRING]);\n+        }\n+\n+        return $this->dbConn->fetchAllKeyValue($sql, [$this->moduleId], [ParameterType::INTEGER]);\n+    }\n \n     /**\n      * Fetch a count of the members for all this user's assessments (that opened this academic year)\n      * @param integer $user_id\n      * @param date $year\n      * @return array assoc array ( assessment_id => member_count )\n      */\n-    function get_members_count_for_user($user_id, $year = NULL)\n+    public function get_members_count_for_user($user_id, $year = null)\n     {\n-        $sql = \"SELECT a.assessment_id, COUNT(DISTINCT ugm.user_id)\n-      FROM \" . APP__DB_TABLE_PREFIX . \"assessment a\n-        LEFT JOIN \" . APP__DB_TABLE_PREFIX . \"user_group ug ON a.collection_id = ug.collection_id\n-        LEFT JOIN \" . APP__DB_TABLE_PREFIX . \"user_group_member ugm ON ug.group_id = ugm.group_id\n-          AND a.module_id = {$this->moduleId} \";\n+        $sql =\n+            'SELECT a.assessment_id, COUNT(DISTINCT ugm.user_id) AS members_count ' .\n+            'FROM ' . APP__DB_TABLE_PREFIX . 'assessment a ' .\n+            'LEFT JOIN ' . APP__DB_TABLE_PREFIX . 'user_group ug ' .\n+            'ON a.collection_id = ug.collection_id ' .\n+            'LEFT JOIN ' . APP__DB_TABLE_PREFIX . 'user_group_member ugm ' .\n+            'ON ug.group_id = ugm.group_id ' .\n+            'AND a.module_id = ? ';\n+\n         if (!empty($year)) {\n             $next_year = $year + 1;\n-            $month = strval(APP__ACADEMIC_YEAR_START_MONTH);\n+            $month = (string) APP__ACADEMIC_YEAR_START_MONTH;\n+\n             if (APP__ACADEMIC_YEAR_START_MONTH < 10) {\n                 $month = '0' . $month;\n             }\n-            $sql .= \"AND a.open_date >= '{$year}-{$month}-01 00:00:00'\n-          AND a.open_date < '{$next_year}-{$month}-01 00:00:00' \";\n+\n+            $startDate = \"$year-$month-01 00:00:00\";\n+            $endDate = \"$next_year-$month-01 00:00:00\";\n+\n+            $sql .=\n+                'AND a.open_date >= ? ' .\n+                'AND a.open_date < ? ';\n         }\n+\n         $sql .= 'GROUP BY a.assessment_id';\n-        return $this->_DAO->fetch_assoc($sql);\n-    }// /->get_members_count_for_user()\n+\n+        if (!empty($year)) {\n+            return $this->dbConn->fetchAllKeyValue($sql, [$this->moduleId, $startDate, $endDate], [ParameterType::INTEGER, ParameterType::STRING, ParameterType::STRING]);\n+        }\n+\n+        return $this->dbConn->fetchAllKeyValue($sql, [$this->moduleId], [ParameterType::INTEGER]);\n+    }\n \n     /**\n      * Has the user submitted marks for the given assessment already\n      * @param string $user_id user to check\n      * @param string $assessment_id assessment to check\n      * @return boolean  has the user responded\n      */\n-    function user_has_responded($user_id, $assessment_id)\n+    public function user_has_responded($user_id, $assessment_id)\n     {\n-        $num_responses = $this->_DAO->fetch_value(\"\n-      SELECT COUNT(DISTINCT um.marked_user_id)\n-      FROM \" . APP__DB_TABLE_PREFIX . \"assessment a\n-        LEFT JOIN \" . APP__DB_TABLE_PREFIX . \"user_mark um ON a.assessment_id = um.assessment_id\n-          AND a.assessment_id = '$assessment_id'\n-          AND um.user_id = $user_id\n-    \");\n-        return ($num_responses > 0);\n-    }// /->user_has_responded()\n+        $numberOfResponsesQuery =\n+            'SELECT COUNT(DISTINCT um.marked_user_id) ' .\n+            'FROM ' . APP__DB_TABLE_PREFIX . 'assessment a ' .\n+            'LEFT JOIN ' . APP__DB_TABLE_PREFIX . 'user_mark um ' .\n+            'ON a.assessment_id = um.assessment_id ' .\n+            'AND a.assessment_id = ? ' .\n+            'AND um.user_id = ?';\n+\n+        $num_responses = $this->dbConn->fetchOne($numberOfResponsesQuery, [$assessment_id, $user_id], [ParameterType::STRING, ParameterType::INTEGER]);\n+\n+        return $num_responses > 0;\n+    }\n \n     /**\n      * Function for the assessments taken by a user\n      * @param string $user_id\n      */\n-    function assessments_taken_by_user($user_id)\n+    public function assessments_taken_by_user($user_id)\n     {\n-\n     }\n \n     /*\n     * ================================================================================\n     * Private Methods\n     * ================================================================================\n     */\n-\n }// /class: ResultHandler\n-\n-?>"
        },
        {
          "filename": "src/includes/classes/SimpleIterator.php",
          "status": "modified",
          "additions": 108,
          "deletions": 80,
          "patch": "@@ -13,91 +13,119 @@\n \n namespace WebPA\\includes\\classes;\n \n-class SimpleIterator {\n-  // Public Vars\n-  public $array = null;\n-  public $count = 0;\n-\n-  // Private Vars\n-\n-  private $_key = null;\n-  private $_value = null;\n-\n-  /**\n-  * CONSTRUCTOR for the simple iterator class\n-  * @param array $array\n-  */\n-  function __construct(&$array = []) {\n-    // sub-classes can override the creator, so all the work is done in _initialise()\n-    $this->_initialise($array);\n-  }// /->SimpleIterator()\n-\n-/*\n-* ================================================================================\n-* Public Methods\n-* ================================================================================\n-*/\n+class SimpleIterator\n+{\n+    // Public Vars\n+    public $array;\n \n-/**\n- * function current\n- * @return integer\n- */\n-  function &current() {\n-    return $this->_value;\n-  }// /->current()\n+    public $count = 0;\n \n-/**\n- * function next\n- */\n-  function next() {\n-    next($this->array);\n-    $this->_key = key($this->array);\n-    if (\"$this->_key\" != '') { $this->_value =& $this->array[$this->_key]; }\n-    else { $this->_value = null; }\n-  }// /->next()\n+    // Private Vars\n \n-/**\n- * function reset\n- */\n-  function reset() {\n-    reset($this->array);\n-    $this->_key = key($this->array);\n-    if (\"$this->_key\" != '') { $this->_value =& $this->array[$this->_key]; }\n-    else { $this->_value = null; }\n-  }// /->reset()\n+    private $_key;\n \n-/**\n- * function size\n- * @return integer\n- */\n-  function size() {\n-    return $this->count;\n-  }// /->size()\n+    private $_value;\n \n-/**\n- * function to check validity\n- * @return boolean\n- */\n-  function is_valid() {\n-    return (\"$this->_key\" != '');\n-  }// /->is_valid()\n-\n-/*\n-* ================================================================================\n-* Private Methods\n-* ================================================================================\n-*/\n-/**\n- * Function to initalise\n- * @param array $array\n- */\n-  function _initialise(&$array = []) {\n-    $this->array =& $array;\n-    $this->count = count($array);\n+    /**\n+    * CONSTRUCTOR for the simple iterator class\n+    * @param array $array\n+    */\n+    public function __construct(&$array = [])\n+    {\n+        // sub-classes can override the creator, so all the work is done in _initialise()\n+        $this->_initialise($array);\n+    }\n \n-    $this->reset();\n-  }// /->_intialise()\n+    // /->SimpleIterator()\n \n-}// /class: SimpleIterator\n+    /*\n+    * ================================================================================\n+    * Public Methods\n+    * ================================================================================\n+    */\n+\n+    /**\n+     * function current\n+     * @return integer\n+     */\n+    public function &current()\n+    {\n+        return $this->_value;\n+    }\n \n-?>\n+    // /->current()\n+\n+    /**\n+     * function next\n+     */\n+    public function next()\n+    {\n+        next($this->array);\n+        $this->_key = key($this->array);\n+        if (\"$this->_key\" != '') {\n+            $this->_value =& $this->array[$this->_key];\n+        } else {\n+            $this->_value = null;\n+        }\n+    }\n+\n+    // /->next()\n+\n+    /**\n+     * function reset\n+     */\n+    public function reset()\n+    {\n+        reset($this->array);\n+        $this->_key = key($this->array);\n+        if (\"$this->_key\" != '') {\n+            $this->_value =& $this->array[$this->_key];\n+        } else {\n+            $this->_value = null;\n+        }\n+    }\n+\n+    // /->reset()\n+\n+    /**\n+     * function size\n+     * @return integer\n+     */\n+    public function size()\n+    {\n+        return $this->count;\n+    }\n+\n+    // /->size()\n+\n+    /**\n+     * function to check validity\n+     * @return boolean\n+     */\n+    public function is_valid()\n+    {\n+        return \"$this->_key\" != '';\n+    }\n+\n+    // /->is_valid()\n+\n+    /*\n+    * ================================================================================\n+    * Private Methods\n+    * ================================================================================\n+    */\n+\n+    /**\n+     * Function to initalise\n+     * @param array $array\n+     */\n+    public function _initialise(&$array = [])\n+    {\n+        $this->array =& $array;\n+        $this->count = count($array);\n+\n+        $this->reset();\n+    }\n+\n+    // /->_intialise()\n+}// /class: SimpleIterator"
        },
        {
          "filename": "src/includes/classes/SimpleObjectIterator.php",
          "status": "modified",
          "additions": 117,
          "deletions": 95,
          "patch": "@@ -14,41 +14,48 @@\n \n namespace WebPA\\includes\\classes;\n \n-class SimpleObjectIterator {\n-  // Public Vars\n-  public $array;\n-  public $class_name;\n-  public $class_constructor_args;\n-  public $count;\n-\n-  // Private Vars\n-  private $_key;\n-  private $_value;\n-\n-  /**\n-  * CONSTRUCTOR for the simple object iterator\n-  * @param array $array\n-  * @param string $class_name\n-  * @param string $constructor_args\n-  */\n-  function __construct(&$array, $class_name = '', $constructor_args = '') {\n-    $this->_initialise($array);\n-    $this->class_name = $class_name;\n-    $this->class_constructor_args = $constructor_args;\n-  }\n-\n-/*\n-* --------------------------------------------------------------------------------\n-* Public Methods\n-* --------------------------------------------------------------------------------\n-*/\n-\n-  /**\n-  * Get object at current pointer position\n-  * @return integer\n-  */\n-  function &current() {\n-    switch ($this->class_name) {\n+class SimpleObjectIterator\n+{\n+    // Public Vars\n+    public $array;\n+\n+    public $class_name;\n+\n+    public $class_constructor_args;\n+\n+    public $count;\n+\n+    // Private Vars\n+    private $_key;\n+\n+    private $_value;\n+\n+    /**\n+    * CONSTRUCTOR for the simple object iterator\n+    * @param array $array\n+    * @param string $class_name\n+    * @param string $constructor_args\n+    */\n+    public function __construct(&$array, $class_name = '', $constructor_args = '')\n+    {\n+        $this->_initialise($array);\n+        $this->class_name = $class_name;\n+        $this->class_constructor_args = $constructor_args;\n+    }\n+\n+    /*\n+    * --------------------------------------------------------------------------------\n+    * Public Methods\n+    * --------------------------------------------------------------------------------\n+    */\n+\n+    /**\n+    * Get object at current pointer position\n+    * @return integer\n+    */\n+    public function &current()\n+    {\n+        switch ($this->class_name) {\n       case 'GroupCollection':\n         $temp = new GroupCollection($this->class_constructor_args);\n         break;\n@@ -59,67 +66,82 @@ function &current() {\n         $temp = null;\n     }\n \n-    $temp->load_from_row($this->_value);\n-\n-    return $temp;\n-  }// /->current()\n-\n-  /**\n-  * Move pointer to the next object in the list\n-  */\n-  function next() {\n-    next($this->array);\n-    $this->_key = key($this->array);\n-    $this->_value = (\"$this->_key\" != '') ? $this->array[$this->_key] : null ;\n-  }// /->next()\n-\n-  /**\n-  * Reset pointer to the start of the list\n-  */\n-  function reset() {\n-    reset($this->array);\n-    $this->_key = key($this->array);\n-    $this->_value = (\"$this->_key\" != '') ? $this->array[$this->_key] : null ;\n-  }// /->reset()\n-\n-  /**\n-  * Get the number of objects in the list\n-  *\n-  * @return integer size of the object list\n-  */\n-  function size() {\n-    return $this->count;\n-  }// /->size()\n-\n-  /*\n-  * Is the current pointer position valid?\n-  * @return boolean\n-  */\n-  function is_valid() {\n-    return (\"$this->_key\" != '');\n-  }// /->is_valid()\n-\n-/*\n-* --------------------------------------------------------------------------------\n-* Private Methods\n-* --------------------------------------------------------------------------------\n-*/\n-\n-  /**\n-  * Initialise the object iterator\n-  * @param array $array\n-  */\n-  function _initialise(&$array) {\n-    $this->array =& $array;\n-    $this->count = count($array);\n-\n-    if ($this->count==0) {\n-        $this->array = array();\n+        $temp->load_from_row($this->_value);\n+\n+        return $temp;\n+    }\n+\n+    // /->current()\n+\n+    /**\n+    * Move pointer to the next object in the list\n+    */\n+    public function next()\n+    {\n+        next($this->array);\n+        $this->_key = key($this->array);\n+        $this->_value = (\"$this->_key\" != '') ? $this->array[$this->_key] : null ;\n+    }\n+\n+    // /->next()\n+\n+    /**\n+    * Reset pointer to the start of the list\n+    */\n+    public function reset()\n+    {\n+        reset($this->array);\n+        $this->_key = key($this->array);\n+        $this->_value = (\"$this->_key\" != '') ? $this->array[$this->_key] : null ;\n     }\n \n-    $this->reset();\n+    // /->reset()\n+\n+    /**\n+    * Get the number of objects in the list\n+    *\n+    * @return integer size of the object list\n+    */\n+    public function size()\n+    {\n+        return $this->count;\n+    }\n+\n+    // /->size()\n+\n+    /*\n+    * Is the current pointer position valid?\n+    * @return boolean\n+    */\n+    public function is_valid()\n+    {\n+        return \"$this->_key\" != '';\n+    }\n \n-    $this->class_name = '';\n-    $this->class_constructor_args = '';\n-  }\n+    // /->is_valid()\n+\n+    /*\n+    * --------------------------------------------------------------------------------\n+    * Private Methods\n+    * --------------------------------------------------------------------------------\n+    */\n+\n+    /**\n+    * Initialise the object iterator\n+    * @param array $array\n+    */\n+    public function _initialise(&$array)\n+    {\n+        $this->array =& $array;\n+        $this->count = count($array);\n+\n+        if ($this->count==0) {\n+            $this->array = [];\n+        }\n+\n+        $this->reset();\n+\n+        $this->class_name = '';\n+        $this->class_constructor_args = '';\n+    }\n }"
        },
        {
          "filename": "src/includes/classes/UI.php",
          "status": "modified",
          "additions": 123,
          "deletions": 111,
          "patch": "@@ -10,28 +10,36 @@\n \n namespace WebPA\\includes\\classes;\n \n-include_once __DIR__ . '/../inc_global.php';\n-\n class UI\n {\n     public $page_title = '';\n+\n     public $menu_selected = '';\n-    public $breadcrumbs = null;\n+\n+    public $breadcrumbs;\n+\n     public $help_link = '';\n \n     private $user;\n+\n     private $_menu;\n+\n     private $_page_bar_buttons;\n+\n     private $cis;\n+\n     private $installedMods;\n+\n     private $sourceId;\n+\n     private $branding;\n+\n     private $module;\n \n     /**\n      * CONSTRUCTOR for the UI\n      */\n-    function __construct($installedMods, $sourceId, $branding, $cis, $module, $user)\n+    public function __construct($installedMods, $sourceId, $branding, $cis, $module, $user)\n     {\n         $this->cis = $cis;\n         $this->installedMods = $installedMods;\n@@ -44,26 +52,24 @@ function __construct($installedMods, $sourceId, $branding, $cis, $module, $user)\n \n         // Initialise the menu - sets either staff or student menu items\n         if ($this->user) {\n-\n             if ($this->user->is_staff()) {\n                 // Staff menu\n-                $this->set_menu('Tutors', array('home' => APP__WWW . '/tutors/index.php',\n+                $this->set_menu('Tutors', ['home' => APP__WWW . '/tutors/index.php',\n                     'my forms' => APP__WWW . '/tutors/forms/',\n                     'my groups' => APP__WWW . '/tutors/groups/',\n-                    'my assessments' => APP__WWW . '/tutors/assessments/'));// /$this->set_menu()\n-\n-            } else if ($this->user->is_student()) {\n+                    'my assessments' => APP__WWW . '/tutors/assessments/', ]);// /$this->set_menu()\n+            } elseif ($this->user->is_student()) {\n                 // Student menu\n-                $this->set_menu('Students', array('home' => APP__WWW . '/students/index.php',\n+                $this->set_menu('Students', ['home' => APP__WWW . '/students/index.php',\n                     'my groups' => APP__WWW . '/students/groups/',\n-                    'my assessments' => APP__WWW . '/students/assessments/'));// /$this->set_menu()\n+                    'my assessments' => APP__WWW . '/students/assessments/', ]);// /$this->set_menu()\n             }\n \n             //Admin menu\n             if ($this->user->is_staff()) {\n-                $menu = array('admin home' => APP__WWW . '/admin/index.php',\n+                $menu = ['admin home' => APP__WWW . '/admin/index.php',\n                     'upload data' => APP__WWW . '/admin/load/index.php',\n-                    'view data' => APP__WWW . '/admin/review/index.php');\n+                    'view data' => APP__WWW . '/admin/review/index.php', ];\n                 if ($this->user->is_admin()) {\n                     $menu['metrics'] = APP__WWW . '/admin/metrics/index.php';\n                 }\n@@ -75,23 +81,23 @@ function __construct($installedMods, $sourceId, $branding, $cis, $module, $user)\n                 $mod = strtolower($mod);\n                 $menu_file = DOC__ROOT . \"mod/$mod/menu.php\";\n                 if (file_exists($menu_file)) {\n-                    require_once($menu_file);\n+                    require_once $menu_file;\n                 }\n             }\n-\n         }\n \n-        $this->set_menu('Support', array('help' => $helper_link, //this is a link set in each page / area to link to the approriate help\n-            'contact' => APP__WWW . '/contact/'));// /$this->set_menu();\n+        $this->set_menu('Support', ['help' => $helper_link, //this is a link set in each page / area to link to the approriate help\n+            'contact' => APP__WWW . '/contact/', ]);// /$this->set_menu();\n \n         if ($this->user) {\n             if ($user->is_admin()) {\n-                $modules = $this->cis->get_user_modules(NULL, NULL, 'name');\n+                $modules = $this->cis->get_user_modules(null, null, 'name');\n             } else {\n-                $modules = $this->cis->get_user_modules($user->id, NULL, 'name');\n+                $modules = $this->cis->get_user_modules($user->id, null, 'name');\n             }\n+\n             if ((($this->sourceId == '') || $this->user->is_admin()) && (count($modules) > 1)) {\n-                $this->set_menu('  ', array('change module' => APP__WWW . '/module.php'));\n+                $this->set_menu('  ', ['change module' => APP__WWW . '/module.php']);\n             }\n         }\n \n@@ -103,8 +109,9 @@ function __construct($installedMods, $sourceId, $branding, $cis, $module, $user)\n             $menu['logout'] = APP__WWW . '/logout.php';\n         }\n         $this->set_menu(' ', $menu);// /$this->set_menu();\n+    }\n \n-    }// /->UI()\n+    // /->UI()\n \n     // --------------------------------------------------------------------------------\n     // Public Methods\n@@ -115,7 +122,7 @@ function __construct($installedMods, $sourceId, $branding, $cis, $module, $user)\n      * @param string $expire_date\n      * @param string $modified_date\n      */\n-    function headers_expire($expire_date = null, $modified_date = null)\n+    public function headers_expire($expire_date = null, $modified_date = null)\n     {\n         // If no expiry date, expire at 00:00:01 today\n         if (!$expire_date) {\n@@ -131,40 +138,40 @@ function headers_expire($expire_date = null, $modified_date = null)\n         header('Last-Modified: ' . gmdate('D, d M Y H:i:s', $modified_date) . ' GMT');\n         header('Cache-Control: no-store, no-cache, must-revalidate');   // HTTP/1.1\n         header('Cache-Control: post-check=0, pre-check=0', false);    // HTTP/1.1\n-        header(\"Cache-control: private\", false);\n+        header('Cache-control: private', false);\n         header('Pragma: no-cache');   // HTTP/1.0\n-    } // /-headers_expire()\n+    }\n \n+    // /-headers_expire()\n \n     /**\n      * Function to generate the header\n      */\n-    function head()\n+    public function head()\n     {\n         /*\n         Commented out until the day IE can show a full XHTML page without entering quirks mode\n         echo('<?xml version=\"1.0\" encoding=\"UTF-8\"?>'.\"\\n\");\n-        */\n-        ?>\n+        */ ?>\n         <!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\"\n                 \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n         <html lang=\"en\" xml:lang=\"en\" xmlns=\"http://www.w3.org/1999/xhtml\">\n         <head>\n         <meta http-equiv=\"content-language\" content=\"EN\"/>\n         <meta http-equiv=\"content-type\" content=\"text/html; charset=UTF-8\"/>\n-        <title><?php echo(APP__NAME) ?></title>\n-        <link href=\"<?php echo(APP__WWW) ?>/css/webpa.css\" media=\"screen\" rel=\"stylesheet\" type=\"text/css\"/>\n-        <link href=\"<?php echo(APP__WWW) ?>/css/webpa_print.css\" media=\"print\" rel=\"stylesheet\" type=\"text/css\"/>\n+        <title><?php echo APP__NAME ?></title>\n+        <link href=\"<?php echo APP__WWW ?>/css/webpa.css\" media=\"screen\" rel=\"stylesheet\" type=\"text/css\"/>\n+        <link href=\"<?php echo APP__WWW ?>/css/webpa_print.css\" media=\"print\" rel=\"stylesheet\" type=\"text/css\"/>\n         <style type=\"text/css\">\n             <?php\n               if (!isset($_SESSION['_no_header'])) {\n-            ?>\n+                  ?>\n             #app_bar {\n-                height: <?php echo $this->branding['logo.margin'];?>px;\n+                height: <?php echo $this->branding['logo.margin']; ?>px;\n             }\n \n             #app_bar #inst_logo {\n-                width: <?php echo $this->branding['logo.width'];?>px;\n+                width: <?php echo $this->branding['logo.width']; ?>px;\n             }\n \n             #main {\n@@ -173,7 +180,7 @@ function head()\n \n             <?php\n               } else {\n-            ?>\n+                  ?>\n             #side_bar {\n                 padding-top: 20px;\n                 top: 20px;\n@@ -188,33 +195,33 @@ function head()\n             }\n \n             <?php\n-              }\n-            ?>\n+              } ?>\n         </style>\n         <?php\n         if (isset($this->branding['css']) && !empty($this->branding['css'])) {\n             ?>\n             <link href=\"<?php echo $this->branding['css']; ?>\" rel=\"stylesheet\" type=\"text/css\"/>\n             <?php\n         }\n-    } // /->head()\n+    }\n \n+    // /->head()\n \n     /**\n      * function to close the body area of the page\n      * @param string $extra_attributes\n      */\n-    function body($extra_attributes = '')\n+    public function body($extra_attributes = '')\n     {\n-        echo(\"\\n</head>\\n<body $extra_attributes>\\n\\n\");\n-\n-    } // /->body()\n+        echo \"\\n</head>\\n<body $extra_attributes>\\n\\n\";\n+    }\n \n+    // /->body()\n \n     /**\n      * render page header\n      */\n-    function header()\n+    public function header()\n     {\n         ?>\n         <div id=\"header\">\n@@ -233,37 +240,34 @@ function header()\n                             if (isset($this->module)) {\n                                 echo \"<td>{$this->module['module_title']} [{$this->module['module_code']}]</td>\";\n                             } else {\n-                                echo('<td>&nbsp;</td>');\n-                            }\n-                            echo '<td align=\"right\">';\n-                            if (isset($this->branding['logo']) && !empty($this->branding['logo'])) {\n-                                echo '<div id=\"inst_logo\"><img src=\"' . $this->branding['logo'] . '\"';\n-                                if (isset($this->branding['name']) && !empty($this->branding['name'])) {\n-                                    echo ' alt=\"' . htmlentities($this->branding['name']) . '\"';\n-                                    echo ' title=\"' . htmlentities($this->branding['name']) . '\"';\n-                                }\n-                                echo ' /></div>';\n-                            } else {\n-                                echo '&nbsp;';\n+                                echo '<td>&nbsp;</td>';\n                             }\n-                            echo '</td>';\n-                            ?>\n+                echo '<td align=\"right\">';\n+                if (isset($this->branding['logo']) && !empty($this->branding['logo'])) {\n+                    echo '<div id=\"inst_logo\"><img src=\"' . $this->branding['logo'] . '\"';\n+                    if (isset($this->branding['name']) && !empty($this->branding['name'])) {\n+                        echo ' alt=\"' . htmlentities($this->branding['name']) . '\"';\n+                        echo ' title=\"' . htmlentities($this->branding['name']) . '\"';\n+                    }\n+                    echo ' /></div>';\n+                } else {\n+                    echo '&nbsp;';\n+                }\n+                echo '</td>'; ?>\n \n                         </tr>\n                     </table>\n                 </div>\n                 <div id=\"module_bar\">\n                     <?php\n                     if ($this->user) {\n-                        echo(\"<td>User: {$this->user->forename} {$this->user->lastname}</td>\");\n+                        echo \"<td>User: {$this->user->forename} {$this->user->lastname}</td>\";\n                     } else {\n-                        echo('<td>&nbsp;</td>');\n-                    }\n-                    ?>\n+                        echo '<td>&nbsp;</td>';\n+                    } ?>\n                 </div>\n                 <?php\n-            }\n-            ?>\n+            } ?>\n             <div id=\"breadcrumb_bar\">\n                 You are in:\n                 <?php\n@@ -272,45 +276,45 @@ function header()\n                     foreach ($this->breadcrumbs as $k => $v) {\n                         --$num_crumbs;\n                         if (!is_null($v)) {\n-                            echo(\"<a class=\\\"breadcrumb\\\" href=\\\"$v\\\">$k</a>\");\n+                            echo \"<a class=\\\"breadcrumb\\\" href=\\\"$v\\\">$k</a>\";\n                             if ($num_crumbs > 0) {\n-                                echo(' &gt; ');\n+                                echo ' &gt; ';\n                             }\n                         } else {\n-                            echo($k);\n+                            echo $k;\n                         }\n                     }\n-                }\n-                ?>\n+                } ?>\n             </div>\n         </div>\n         <?php\n-    }// /->header()\n+    }\n+\n+    // /->header()\n \n     /**\n      * Set the given section name to the given assoc-array of links\n      * Does NO checking of $section_array\n      * @param string $section_name\n      * @param array $section_array\n      */\n-    function set_menu($section_name, $section_array)\n+    public function set_menu($section_name, $section_array)\n     {\n         $this->_menu[$section_name] = $section_array;\n     }\n \n-    function get_menu($section_name)\n+    public function get_menu($section_name)\n     {\n         if (isset($this->_menu[$section_name])) {\n             return $this->_menu[$section_name];\n-        } else {\n-            return array();\n         }\n+        return [];\n     }\n \n     /**\n      * Draw the menu\n      */\n-    function menu()\n+    public function menu()\n     {\n         // If there's a menu, draw it\n         if ($this->_menu) {\n@@ -333,9 +337,11 @@ function menu()\n             }// /for\n \n             $menu_html .= '</div>';\n-            echo($menu_html);\n+            echo $menu_html;\n         }\n-    }// /->menu()\n+    }\n+\n+    // /->menu()\n \n     /**\n      * Set a page bar button\n@@ -344,16 +350,17 @@ function menu()\n      * @param string $link\n      * @param string $side\n      */\n-    function set_page_bar_button($text, $img, $link, $side = 'left')\n+    public function set_page_bar_button($text, $img, $link, $side = 'left')\n     {\n-        $this->_page_bar_buttons[$side][$text] = array('img' => \"../images/buttons/$img\", 'link' => $link);\n+        $this->_page_bar_buttons[$side][$text] = ['img' => \"../images/buttons/$img\", 'link' => $link];\n+    }\n \n-    }// /->set_page_bar_button()\n+    // /->set_page_bar_button()\n \n     /**\n      * Draw the page toolbar\n      */\n-    function page_bar()\n+    public function page_bar()\n     {\n         if (is_array($this->_page_bar_buttons)) {\n             ?>\n@@ -363,75 +370,80 @@ function page_bar()\n                         <?php\n                         if (array_key_exists('left', $this->_page_bar_buttons)) {\n                             foreach ($this->_page_bar_buttons['left'] as $text => $button) {\n-                                echo(\"<td><a class=\\\"page_bar_link\\\" href=\\\"{$button['link']}\\\" title=\\\"$text\\\"><img src=\\\"{$button['img']}\\\" alt=\\\"$text\\\" height=\\\"50\\\" /></a></td>\");\n+                                echo \"<td><a class=\\\"page_bar_link\\\" href=\\\"{$button['link']}\\\" title=\\\"$text\\\"><img src=\\\"{$button['img']}\\\" alt=\\\"$text\\\" height=\\\"50\\\" /></a></td>\";\n                             }\n-                        }\n-                        ?>\n+                        } ?>\n                         <td width=\"100%\">&nbsp;</td>\n                         <?php\n                         // right-hand buttons are automatically set to target=\"_blank\"\n                         if (array_key_exists('right', $this->_page_bar_buttons)) {\n                             foreach ($this->_page_bar_buttons['right'] as $text => $button) {\n-                                echo(\"<td><a class=\\\"page_bar_link\\\" href=\\\"{$button['link']}\\\" target=\\\"$text\\\" title=\\\"$text\\\"><img src=\\\"{$button['img']}\\\" alt=\\\"$text\\\" height=\\\"50\\\" /></a></td>\");\n+                                echo \"<td><a class=\\\"page_bar_link\\\" href=\\\"{$button['link']}\\\" target=\\\"$text\\\" title=\\\"$text\\\"><img src=\\\"{$button['img']}\\\" alt=\\\"$text\\\" height=\\\"50\\\" /></a></td>\";\n                             }\n-                        }\n-                        ?>\n+                        } ?>\n                     </tr>\n                 </table>\n             </div>\n             <?php\n         }\n-    }// /->page_bar()\n+    }\n+\n+    // /->page_bar()\n \n     /**\n      * Footer\n      */\n-    function footer()\n+    public function footer()\n     {\n         ?>\n         <div id=\"footer\">\n             <div style=\"margin-top: 50px\">\n                 &copy; Loughborough University and University of Hull, 2005 - <?php echo date('Y'); ?>&nbsp;&nbsp;&nbsp;\n                 <span style=\"font-size: small;\">Version: <?php\n                     echo APP__VERSION;\n-                    if (count($this->installedMods) > 0) echo ' [' . implode(\",\", $this->installedMods) . ']'; ?></span>\n+        if (count($this->installedMods) > 0) {\n+            echo ' [' . implode(',', $this->installedMods) . ']';\n+        } ?></span>\n                 <?php\n                 if (isset($this->user) && $this->user->is_admin() && $this->sourceId) {\n                     echo \"<br />\\n\";\n                     echo '      <span style=\"font-size: small;\">Source:&nbsp;';\n                     echo ($this->sourceId) ? $this->sourceId : '&lt;' . APP__NAME . '&gt;';\n                     echo \"</span>\\n\";\n-                }\n-                ?>\n+                } ?>\n             </div>\n             <iframe src=\"<?php echo APP__WWW; ?>/keep_alive.php\" height=\"1\" width=\"1\" style=\"display: none;\">keep\n                 alive\n             </iframe>\n         </div>\n         <?php\n-    }// /->footer()\n+    }\n+\n+    // /->footer()\n \n     /**\n      * Start main page content\n      */\n-    function content_start()\n+    public function content_start()\n     {\n-        echo('<div id=\"container\">');\n-        echo('<div id=\"main\">');\n+        echo '<div id=\"container\">';\n+        echo '<div id=\"main\">';\n         $this->page_bar();\n-        echo('<div id=\"content\">');\n+        echo '<div id=\"content\">';\n         if ($this->page_title) {\n-            echo(\"<h1>{$this->page_title}</h1>\\n\\n\");\n+            echo \"<h1>{$this->page_title}</h1>\\n\\n\";\n         }\n-    }// /content_start()\n+    }\n+\n+    // /content_start()\n \n     /**\n      * End main page content\n      * @param boolean $render_menu\n      * @param boolean $render_header\n      * @param boolean $renders_footer\n      */\n-    function content_end($render_menu = true, $render_header = true, $render_footer = true)\n+    public function content_end($render_menu = true, $render_header = true, $render_footer = true)\n     {\n         ?>\n         </div>\n@@ -440,8 +452,7 @@ function content_end($render_menu = true, $render_header = true, $render_footer\n         <div id=\"side_bar\">\n             <?php\n             if ($render_menu) {\n-                $this->menu();\n-                ?>\n+                $this->menu(); ?>\n                 <div class=\"alert_box\" style=\"margin: 40px 8px 8px 8px; font-size: 0.7em;\">\n                     <p><strong>Technical Problem?</strong></p>\n                     <p>If you have a problem, find a bug or discover a technical problem in the system, <a\n@@ -457,23 +468,23 @@ function content_end($render_menu = true, $render_header = true, $render_footer\n                                 title=\"(email: <?php echo $this->branding['email.help']; ?>)\">email us</a> to report it!</p>\n                 </div>\n                 <?php\n-            }\n-            ?>\n+            } ?>\n         </div>\n         <?php\n         if ($render_header) {\n             $this->header();\n         }\n         if ($render_footer) {\n             $this->footer();\n-        }\n-        ?>\n+        } ?>\n         <div class=\"clear\"></div>\n         </div> <!-- id=\"container\" -->\n         </body>\n         </html>\n         <?php\n-    }// /content_end()\n+    }\n+\n+    // /content_end()\n \n     /**\n      * function to draw the boxed list\n@@ -482,20 +493,21 @@ function content_end($render_menu = true, $render_header = true, $render_footer\n      * @param string $header_text\n      * @param string $footer_text\n      */\n-    function draw_boxed_list($list, $box_class, $header_text, $footer_text)\n+    public function draw_boxed_list($list, $box_class, $header_text, $footer_text)\n     {\n         if (is_array($list)) {\n-            echo(\"<div class=\\\"$box_class\\\"><p style=\\\"font-weight: bold;\\\">$header_text</p><ul class=\\\"spaced\\\">\");\n+            echo \"<div class=\\\"$box_class\\\"><p style=\\\"font-weight: bold;\\\">$header_text</p><ul class=\\\"spaced\\\">\";\n             foreach ($list as $item) {\n-                echo(\"<li>$item</li>\");\n+                echo \"<li>$item</li>\";\n             }\n-            echo(\"</ul><p>$footer_text</p></div>\");\n+            echo \"</ul><p>$footer_text</p></div>\";\n         }\n-    }// ->draw_boxed_list()\n+    }\n+\n+    // ->draw_boxed_list()\n \n     // --------------------------------------------------------------------------------\n     // Private Methods\n-\n }// /class: UI\n \n ?>"
        },
        {
          "filename": "src/includes/classes/User.php",
          "status": "modified",
          "additions": 296,
          "deletions": 200,
          "patch": "@@ -12,209 +12,305 @@\n \n namespace WebPA\\includes\\classes;\n \n-class User {\n-  // Public Vars\n-  public $username = null;\n-  public $source_id = null;\n-  public $password = null;\n-  public $id = null;\n-  public $admin = null;\n-  public $id_number = null;\n-  public $department_id = null;\n-  public $forename = null;\n-  public $lastname = null;\n-  public $email = null;\n-  public $type = null;\n-\n-  public $DAO = null;\n-\n-  /**\n-  * CONSTRUCTOR for the class function\n-  * @param string $username\n-  * @param string $passsword\n-  */\n-  function __construct($username = null, $password = null) {\n-    $this->username = $username;\n-    $this->source_id = '';\n-    $this->password = $password;\n-    $this->id = null;\n-    $this->type = null;\n-    $this->id_number = null;\n-    $this->department_id = null;\n-    $this->forename = null;\n-    $this->lastname = null;\n-    $this->admin = 0;\n-  }// /->User()\n-\n-/*\n-* ================================================================================\n-* PUBLIC\n-*================================================================================\n-*/\n-\n-  /**\n-  * Load the object from the given data\n-  *\n-  * @param array $user_info  assoc-array of User info\n-  *\n-  * @return boolean did the load succeed\n-  */\n-  function load_from_row($user_info) {\n-    if (is_array($user_info)) {\n-      $this->id = $user_info['user_id'];\n-      $this->admin = $user_info['admin'];\n-      $this->id_number = $user_info['id_number'];\n-      $this->department_id = $user_info['department_id'];\n-      $this->username = $user_info['username'];\n-      $this->source_id = $user_info['source_id'];\n-      $this->password = $user_info['password'];\n-      $this->forename = $user_info['forename'];\n-      $this->lastname = $user_info['lastname'];\n-      $this->email = $user_info['email'];\n-      if ($this->admin) {\n-        $this->type = APP__USER_TYPE_ADMIN;\n-      } else {\n-        $this->type = $user_info['user_type'];\n-      }\n+use Doctrine\\DBAL\\ParameterType;\n+\n+class User\n+{\n+    // Public Vars\n+    public $username;\n+\n+    public $source_id;\n+\n+    public $password;\n+\n+    public $id;\n+\n+    public $admin;\n+\n+    public $id_number;\n+\n+    public $department_id;\n+\n+    public $forename;\n+\n+    public $lastname;\n+\n+    public $email;\n+\n+    public $type;\n+\n+    public DAO $DAO;\n+\n+    /**\n+    * CONSTRUCTOR for the class function\n+    * @param string $username\n+    * @param string $passsword\n+    */\n+    public function __construct($username = null, $password = null)\n+    {\n+        $this->username = $username;\n+        $this->source_id = '';\n+        $this->password = password_hash($password, PASSWORD_DEFAULT);\n+        $this->id = null;\n+        $this->type = null;\n+        $this->id_number = null;\n+        $this->department_id = null;\n+        $this->forename = null;\n+        $this->lastname = null;\n+        $this->admin = 0;\n+    }\n+\n+    // /->User()\n+\n+    /*\n+    * ================================================================================\n+    * PUBLIC\n+    *================================================================================\n+    */\n+\n+    /**\n+    * Load the object from the given data\n+    *\n+    * @param array $user_info  assoc-array of User info\n+    *\n+    * @return boolean did the load succeed\n+    */\n+    public function load_from_row($user_info)\n+    {\n+        if (is_array($user_info)) {\n+            $this->id = $user_info['user_id'];\n+            $this->admin = $user_info['admin'];\n+            $this->id_number = $user_info['id_number'];\n+            $this->department_id = $user_info['department_id'];\n+            $this->username = $user_info['username'];\n+            $this->source_id = $user_info['source_id'];\n+            $this->password = $user_info['password'];\n+            $this->forename = $user_info['forename'];\n+            $this->lastname = $user_info['lastname'];\n+            $this->email = $user_info['email'];\n+            if ($this->admin) {\n+                $this->type = APP__USER_TYPE_ADMIN;\n+            } else {\n+                $this->type = $user_info['user_type'];\n+            }\n+        }\n+        return true;\n     }\n-    return true;\n-  }// /->load_from_row()\n-\n-  /**\n-  * Is this user admin?\n-  *\n-  * @return boolean user is admin\n-  */\n-  function is_admin() {\n-    return ($this->admin == 1);\n-  }// /->is_admin()\n-\n-  /**\n-  * Is this user staff?\n-  *\n-  * @return boolean user is staff\n-  */\n-  function is_staff() {\n-    return ($this->type == APP__USER_TYPE_ADMIN) || ($this->type == APP__USER_TYPE_TUTOR);\n-  }// /->is_staff()\n-\n-  /*\n-  Is this user tutor?\n-  */\n-  function is_tutor() {\n-    return ($this->type == APP__USER_TYPE_TUTOR);\n-  }// /->is_staff()\n-\n-  /*\n-  Is this user student?\n-  */\n-  function is_student() {\n-    return ($this->type == APP__USER_TYPE_STUDENT);\n-  }// /->is_student()\n-\n-  /**\n-   * Update password\n-   *\n-   * Updates the password used by the user\n-   *\n-   * @param string $password\n-   */\n-  function update_password($password){\n-    $this->password = $password;\n-  }\n-\n-  /**\n-   * Function to update the username\n-   * @param string $username\n-   */\n-   function update_username($username){\n-    $this->username = $username;\n-   }\n-\n-  /**\n-   * Function to update the source_id\n-   * @param string $source_id\n-   */\n-   function update_source_id($source_id){\n-    $this->source_id = $source_id;\n-   }\n-\n-  /**\n-   * Function to update the user details\n-   */\n-   function save_user(){\n-\n-    $_fields = array ('forename'        => $this->forename ,\n-              'lastname'        => $this->lastname ,\n-              'email'         => $this->email,\n-              'username'        => $this->username,\n-              'source_id'      => $this->source_id,\n-              'password'        => $this->password,\n-              'id_number' => $this->id_number,\n-              'department_id' => $this->department_id\n-              );\n-\n-    //save the changes to the user\n-    $this->DAO->do_update(\"UPDATE \" . APP__DB_TABLE_PREFIX . \"user SET {fields} WHERE user_id = {$this->id}; \",$_fields);\n-\n-    return true;\n-   }\n-\n-   /**\n-    * Function to set the database connection to be used\n-    * @param database connection $this->DAO\n+\n+    // /->load_from_row()\n+\n+    /**\n+    * Is this user admin?\n+    *\n+    * @return boolean user is admin\n     */\n-    function set_dao_object($DB){\n-      $this->DAO = $DB;\n+    public function is_admin()\n+    {\n+        return $this->admin == 1;\n     }\n \n-  /**\n-   * Function to add new user details\n-   */\n-   function add_user(){\n-\n-    $_fields = array ('forename'        => $this->forename ,\n-              'lastname'        => $this->lastname ,\n-              'email'         => $this->email,\n-              'username'        => $this->username,\n-              'source_id'      => $this->source_id,\n-              'password'        => $this->password,\n-              'id_number' => $this->id_number,\n-              'department_id' => $this->department_id,\n-              'admin' => $this->admin\n-              );\n-\n-    //save the changes to the user\n-    $this->DAO->do_update(\"INSERT INTO \" . APP__DB_TABLE_PREFIX . \"user SET {fields}\", $_fields);\n-\n-    return $this->DAO->get_insert_id() ;\n-   }\n-\n-  /**\n-   * Function to delete a user\n-   */\n-   function delete(){\n-\n-     $this->DAO->execute(\"DELETE FROM \" . APP__DB_TABLE_PREFIX . \"user_reset_request WHERE user_id = {$this->id}\");\n-     $this->DAO->execute(\"DELETE FROM \" . APP__DB_TABLE_PREFIX . \"form WHERE form_owner_id = {$this->id}\");\n-     $this->DAO->execute(\"DELETE FROM \" . APP__DB_TABLE_PREFIX . \"user_justification WHERE (marked_user_id = {$this->id}) OR (user_id = {$this->id})\");\n-     $this->DAO->execute(\"DELETE FROM \" . APP__DB_TABLE_PREFIX . \"user_mark WHERE (marked_user_id = {$this->id}) OR (user_id = {$this->id})\");\n-     $this->DAO->execute(\"DELETE FROM \" . APP__DB_TABLE_PREFIX . \"user_group_member WHERE user_id = {$this->id}\");\n-     $this->DAO->execute(\"DELETE FROM \" . APP__DB_TABLE_PREFIX . \"user_response WHERE user_id = {$this->id}\");\n-     $this->DAO->execute(\"DELETE FROM \" . APP__DB_TABLE_PREFIX . \"user_module WHERE user_id = {$this->id}\");\n-     $this->DAO->execute(\"DELETE FROM \" . APP__DB_TABLE_PREFIX . \"user_tracking WHERE user_id = {$this->id}\");\n-     $this->DAO->execute(\"DELETE FROM \" . APP__DB_TABLE_PREFIX . \"user WHERE user_id = {$this->id}\");\n-\n-     $this->id = null;\n-\n-   }\n-\n-/*\n-* ================================================================================\n-* PRIVATE\n-* ================================================================================\n-*/\n+    // /->is_admin()\n \n-}// /class: User\n+    /**\n+    * Is this user staff?\n+    *\n+    * @return boolean user is staff\n+    */\n+    public function is_staff()\n+    {\n+        return ($this->type == APP__USER_TYPE_ADMIN) || ($this->type == APP__USER_TYPE_TUTOR);\n+    }\n+\n+    // /->is_staff()\n+\n+    // Is this user tutor?\n+    public function is_tutor()\n+    {\n+        return $this->type == APP__USER_TYPE_TUTOR;\n+    }\n+\n+    // /->is_staff()\n+\n+    // Is this user student?\n+    public function is_student()\n+    {\n+        return $this->type == APP__USER_TYPE_STUDENT;\n+    }\n+\n+    // /->is_student()\n+\n+    /**\n+     * Update password\n+     *\n+     * Updates the password used by the user\n+     *\n+     * @param string $password\n+     */\n+    public function update_password($password)\n+    {\n+        $this->password = password_hash($password, PASSWORD_DEFAULT);\n+    }\n+\n+    /**\n+     * Function to update the username\n+     * @param string $username\n+     */\n+    public function update_username($username)\n+    {\n+        $this->username = $username;\n+    }\n+\n+    /**\n+     * Function to update the source_id\n+     * @param string $source_id\n+     */\n+    public function update_source_id($source_id)\n+    {\n+        $this->source_id = $source_id;\n+    }\n+\n+    /**\n+     * Function to update the user details\n+     */\n+    public function save_user()\n+    {\n+        $this->DAO\n+        ->getConnection()\n+        ->createQueryBuilder()\n+        ->update(APP__DB_TABLE_PREFIX . 'user')\n+        ->set('forename', '?')\n+        ->set('lastname', '?')\n+        ->set('email', '?')\n+        ->set('username', '?')\n+        ->set('source_id', '?')\n+        ->set('password', '?')\n+        ->set('id_number', '?')\n+        ->set('department_id', '?')\n+        ->where('user_id = ?')\n+        ->setParameter(0, $this->forename)\n+        ->setParameter(1, $this->lastname)\n+        ->setParameter(2, $this->email)\n+        ->setParameter(3, $this->username)\n+        ->setParameter(4, $this->source_id)\n+        ->setParameter(5, $this->password)\n+        ->setParameter(6, $this->id_number)\n+        ->setParameter(7, $this->department_id)\n+        ->setParameter(8, $this->id, ParameterType::INTEGER)\n+        ->execute();\n+\n+        return true;\n+    }\n+\n+    /**\n+     * Function to set the database connection to be used\n+     * @param DAO connection $this->DAO\n+     */\n+    public function set_dao_object(DAO $DB)\n+    {\n+        $this->DAO = $DB;\n+    }\n+\n+    /**\n+     * Function to add new user details\n+     */\n+    public function add_user()\n+    {\n+        $this->DAO\n+           ->getConnection()\n+           ->createQueryBuilder()\n+           ->insert(APP__DB_TABLE_PREFIX . 'user')\n+           ->values([\n+               'forename' => '?',\n+               'lastname' => '?',\n+               'email' => '?',\n+               'username' => '?',\n+               'source_id' => '?',\n+               'password' => '?',\n+               'id_number' => '?',\n+               'department_id' => '?',\n+               'admin' => '?',\n+           ])\n+           ->setParameter(0, $this->forename)\n+           ->setParameter(1, $this->lastname)\n+           ->setParameter(2, $this->email)\n+           ->setParameter(3, $this->username)\n+           ->setParameter(4, $this->source_id)\n+           ->setParameter(5, $this->password)\n+           ->setParameter(6, $this->id_number)\n+           ->setParameter(7, $this->department_id)\n+           ->setParameter(8, $this->admin, ParameterType::INTEGER)\n+           ->execute();\n+\n+        return $this->DAO->getConnection()->lastInsertId('user_id');\n+    }\n+\n+    /**\n+     * Function to delete a user\n+     */\n+    public function delete()\n+    {\n+        $dbConn = $this->DAO->getConnection();\n+\n+        $dbConn->executeQuery(\n+            'DELETE FROM ' . APP__DB_TABLE_PREFIX . 'user_reset_request WHERE user_id = ?',\n+            [$this->id],\n+            [ParameterType::INTEGER]\n+        );\n+\n+        $dbConn->executeQuery(\n+            'DELETE FROM ' . APP__DB_TABLE_PREFIX . 'form WHERE form_owner_id = ?',\n+            [$this->id],\n+            [ParameterType::INTEGER]\n+        );\n+\n+        $dbConn->executeQuery(\n+            'DELETE FROM ' . APP__DB_TABLE_PREFIX . 'user_justification WHERE marked_user_id = ? OR user_id = ?',\n+            [$this->id, $this->id],\n+            [ParameterType::INTEGER, ParameterType::INTEGER]\n+        );\n+\n+        $dbConn->executeQuery(\n+            'DELETE FROM ' . APP__DB_TABLE_PREFIX . 'user_mark WHERE marked_user_id = ? OR user_id = ?',\n+            [$this->id, $this->id],\n+            [ParameterType::INTEGER, ParameterType::INTEGER]\n+        );\n+\n+        $dbConn->executeQuery(\n+            'DELETE FROM ' . APP__DB_TABLE_PREFIX . 'user_group_member WHERE user_id = ?',\n+            [$this->id],\n+            [ParameterType::INTEGER]\n+        );\n+\n+        $dbConn->executeQuery(\n+            'DELETE FROM ' . APP__DB_TABLE_PREFIX . 'user_response WHERE user_id = ?',\n+            [$this->id],\n+            [ParameterType::INTEGER]\n+        );\n \n-?>\n+        $dbConn->executeQuery(\n+            'DELETE FROM ' . APP__DB_TABLE_PREFIX . 'user_module WHERE user_id = ?',\n+            [$this->id],\n+            [ParameterType::INTEGER]\n+        );\n+\n+        $dbConn->executeQuery(\n+            'DELETE FROM ' . APP__DB_TABLE_PREFIX . 'user_tracking WHERE user_id = ?',\n+            [$this->id],\n+            [ParameterType::INTEGER]\n+        );\n+\n+        $dbConn->executeQuery(\n+            'DELETE FROM ' . APP__DB_TABLE_PREFIX . 'user WHERE user_id = ?',\n+            [$this->id],\n+            [ParameterType::INTEGER]\n+        );\n+\n+        $this->id = null;\n+    }\n+\n+    /*\n+    * ================================================================================\n+    * PRIVATE\n+    * ================================================================================\n+    */\n+}// /class: User"
        },
        {
          "filename": "src/includes/classes/WebPAAlgorithm.php",
          "status": "modified",
          "additions": 263,
          "deletions": 228,
          "patch": "@@ -12,247 +12,282 @@\n \n namespace WebPA\\includes\\classes;\n \n-class WebPAAlgorithm {\n-  // Public Vars\n-  public $_groups = null;\n-  public $_group_members = null;\n-  public $_questions = null;\n-  public $_responses = null;\n-  public $_marking_params = null;\n-\n-  public $_group_member_responses = null;\n-  public $_group_member_total_awarded = null;\n-  public $_group_member_frac_scores_awarded = null;\n-  public $_group_member_total_received = null;\n-  public $_group_member_webpa_scores = null;\n-  public $_group_member_intermediate_grades = null;\n-  public $_group_member_grades = null;\n-\n-  public $_group_member_submitted = null;\n-  public $_member_submitted = null;\n-\n-  // Private Vars\n-\n-  /**\n-  * CONSTRUCTOR\n-  */\n-  function __construct() {\n-    $this->_init();\n-  }\n+class WebPAAlgorithm\n+{\n+    // Public Vars\n+    public $_groups;\n \n-/**\n-* ================================================================================\n-* Public Methods\n-* ================================================================================\n-*/\n+    public $_group_members;\n \n-/**\n-* --------------------------------------------------------------------------------\n-* Accessor Methods (GET)\n-* --------------------------------------------------------------------------------\n-*/\n-\n-  /**\n-  * Function to get WebPA scores\n-  *\n-  * @param int $group_id\n-  * @return array $scores\n-  */\n-  function get_webpa_scores($group_id = null) {\n-\n-    if (!is_array($this->_group_member_webpa_scores)) {\n-      return array();\n-    } else {\n-      if ($group_id) {\n-        return $this->_group_member_webpa_scores[\"$group_id\"];\n-      } else {\n-        $scores = array();\n-        foreach($this->_group_member_webpa_scores as $group_id => $member_scores) {\n-          // [pmn] FIXED : needs this foreach to list scores by member_id\n-\n-          foreach($member_scores as $member_id => $score) {\n-            $scores[$member_id] = $score;\n-\n-          }\n-          //$scores = array_merge($scores, $member_scores);\n+    public $_questions;\n+\n+    public $_responses;\n+\n+    public $_marking_params;\n+\n+    public $_group_member_responses;\n+\n+    public $_group_member_total_awarded;\n+\n+    public $_group_member_frac_scores_awarded;\n+\n+    public $_group_member_total_received;\n+\n+    public $_group_member_webpa_scores;\n+\n+    public $_group_member_intermediate_grades;\n+\n+    public $_group_member_grades;\n+\n+    public $_group_member_submitted;\n+\n+    public $_member_submitted;\n+\n+    // Private Vars\n+\n+    /**\n+    * CONSTRUCTOR\n+    */\n+    public function __construct()\n+    {\n+        $this->_init();\n+    }\n+\n+    /**\n+    * ================================================================================\n+    * Public Methods\n+    * ================================================================================\n+    */\n+\n+    /**\n+    * --------------------------------------------------------------------------------\n+    * Accessor Methods (GET)\n+    * --------------------------------------------------------------------------------\n+    */\n+\n+    /**\n+    * Function to get WebPA scores\n+    *\n+    * @param int $group_id\n+    * @return array $scores\n+    */\n+    public function get_webpa_scores($group_id = null)\n+    {\n+        if (!is_array($this->_group_member_webpa_scores)) {\n+            return [];\n+        }\n+        if ($group_id) {\n+            return $this->_group_member_webpa_scores[\"$group_id\"];\n+        }\n+        $scores = [];\n+        foreach ($this->_group_member_webpa_scores as $group_id => $member_scores) {\n+            // [pmn] FIXED : needs this foreach to list scores by member_id\n+\n+            foreach ($member_scores as $member_id => $score) {\n+                $scores[$member_id] = $score;\n+            }\n+            //$scores = array_merge($scores, $member_scores);\n         }\n         ksort($scores);\n         return $scores;\n-      }\n     }\n-  } // /->get_webpa_scores()\n-\n-  /**\n-  * Function to Get grades\n-  *\n-  * @param int $group_id\n-  * @return array $grades\n-  */\n-  function get_intermediate_grades($group_id = null) {\n-    if ($group_id) {\n-      return $this->_group_member_intermediate_grades[\"$group_id\"];\n-    } else {\n-      $grades = array();\n-      foreach($this->_group_member_intermediate_grades as $group_id => $member_grades) {\n-        foreach($member_grades as $member_id => $grade) {\n-          $grades[$member_id] = $grade;\n+\n+    // /->get_webpa_scores()\n+\n+    /**\n+    * Function to Get grades\n+    *\n+    * @param int $group_id\n+    * @return array $grades\n+    */\n+    public function get_intermediate_grades($group_id = null)\n+    {\n+        if ($group_id) {\n+            return $this->_group_member_intermediate_grades[\"$group_id\"];\n+        }\n+        $grades = [];\n+        foreach ($this->_group_member_intermediate_grades as $group_id => $member_grades) {\n+            foreach ($member_grades as $member_id => $grade) {\n+                $grades[$member_id] = $grade;\n+            }\n         }\n-      }\n-      ksort($grades);\n-      return $grades;\n+        ksort($grades);\n+        return $grades;\n     }\n-  } // /->get_intermediate_grades()\n-\n-  /**\n-  * Function to Get grades\n-  *\n-  * @param int $group_id\n-  * @return array $grades\n-  */\n-  function get_grades($group_id = null) {\n-    if ($group_id) {\n-      return $this->_group_member_grades[\"$group_id\"];\n-    } else {\n-      $grades = array();\n-      foreach($this->_group_member_grades as $group_id => $member_grades) {\n-        foreach($member_grades as $member_id => $grade) {\n-          $grades[$member_id] = $grade;\n+\n+    // /->get_intermediate_grades()\n+\n+    /**\n+    * Function to Get grades\n+    *\n+    * @param int $group_id\n+    * @return array $grades\n+    */\n+    public function get_grades($group_id = null)\n+    {\n+        if ($group_id) {\n+            return $this->_group_member_grades[\"$group_id\"];\n         }\n-      }\n-      ksort($grades);\n-      return $grades;\n+        $grades = [];\n+        foreach ($this->_group_member_grades as $group_id => $member_grades) {\n+            foreach ($member_grades as $member_id => $grade) {\n+                $grades[$member_id] = $grade;\n+            }\n+        }\n+        ksort($grades);\n+        return $grades;\n     }\n-  } // /->get_grades()\n-\n-  /**\n-   * Function to get members submitting\n-   *\n-   * @param int $group_id\n-   * @return mixed returns the members of the group that have submitted the assessment\n-   */\n-  function get_members_submitting($group_id = null) {\n-    if ($group_id) {\n-      return (array_key_exists($group_id, $this->_group_member_submitted)) ? $this->_group_member_submitted[\"$group_id\"] : null ;\n-    } else {\n-      return $this->_member_submitted;\n+\n+    // /->get_grades()\n+\n+    /**\n+     * Function to get members submitting\n+     *\n+     * @param int $group_id\n+     * @return mixed returns the members of the group that have submitted the assessment\n+     */\n+    public function get_members_submitting($group_id = null)\n+    {\n+        if ($group_id) {\n+            return (array_key_exists($group_id, $this->_group_member_submitted)) ? $this->_group_member_submitted[\"$group_id\"] : null ;\n+        }\n+        return $this->_member_submitted;\n     }\n-  }// /->get_members_submitting()\n-\n-  /**\n-   * Get the response given by one member of a group to another member for a particular question\n-   *\n-   * @param int $group_id\n-   * @param int $member_id\n-   * @param int $question_id\n-   * @param int $target_member_id\n-   *\n-   * @return array $response_score\n-   */\n-  function get_member_response($group_id, $member_id, $question_id, $target_member_id) {\n-    $response_score = null;\n-    if (array_key_exists($group_id, $this->_group_member_responses)) {\n-      if (array_key_exists($member_id, $this->_group_member_responses[$group_id])) {\n-        if (array_key_exists($question_id, $this->_group_member_responses[$group_id][$member_id])) {\n-          if (array_key_exists($target_member_id, $this->_group_member_responses[$group_id][$member_id][$question_id])) {\n-            $response_score = $this->_group_member_responses[$group_id][$member_id][$question_id][$target_member_id];\n-          }\n+\n+    // /->get_members_submitting()\n+\n+    /**\n+     * Get the response given by one member of a group to another member for a particular question\n+     *\n+     * @param int $group_id\n+     * @param int $member_id\n+     * @param int $question_id\n+     * @param int $target_member_id\n+     *\n+     * @return array $response_score\n+     */\n+    public function get_member_response($group_id, $member_id, $question_id, $target_member_id)\n+    {\n+        $response_score = null;\n+        if (array_key_exists($group_id, $this->_group_member_responses)) {\n+            if (array_key_exists($member_id, $this->_group_member_responses[$group_id])) {\n+                if (array_key_exists($question_id, $this->_group_member_responses[$group_id][$member_id])) {\n+                    if (array_key_exists($target_member_id, $this->_group_member_responses[$group_id][$member_id][$question_id])) {\n+                        $response_score = $this->_group_member_responses[$group_id][$member_id][$question_id][$target_member_id];\n+                    }\n+                }\n+            }\n         }\n-      }\n+        return $response_score;\n     }\n-    return $response_score;\n-  }\n \n-/**\n-* --------------------------------------------------------------------------------\n-* Accessor Methods (SET)\n-* --------------------------------------------------------------------------------\n-*/\n-\n-  /**\n-  * Set groups\n-  *\n-  *@param array $groups groups to use in this algorithm : array[group_id] = group_mark\n-  */\n-  function set_groups(& $groups) {\n-    $this->_groups =& $groups;\n-  }// /->set_groups()\n-\n-  /*\n-  * Set group members\n-  *\n-  * $group_members  : (array) - members to use in this algorithm : array[group_id] = array ( member_id, ... )\n-  */\n-  function set_group_members(& $group_members) {\n-    $this->_group_members =& $group_members;\n-  }// /->set_group_members()\n-\n-  /*\n-  * Set marking parameters\n-  *\n-  * $params : (array) - marking parameters for this report : array ( int weighting , int penalty )\n-  */\n-  function set_marking_params(& $marking_params) {\n-    $this->_marking_params =& $marking_params;\n-  }// /->set_marking_params()\n-\n-  /*\n-  * Set questions\n-  * This could've just accepted an integer, but for future proofing (just in case) it takes an array (0-based)\n-  *\n-  * $questions  : (array) - questions in this assessment : array ( question_id, ... )\n-  */\n-  function set_questions(& $questions) {\n-    $this->_questions =& $questions;\n-  }// /->set_questions()\n-\n-  /*\n-  * Set member responses\n-  *\n-  * $responses  : (array) - responses given for this assessment : array[member_id][question_id][marked_member_id] = score\n-  */\n-  function set_responses(& $responses) {\n-    $this->_responses =& $responses;\n-  }// /->set_responses()\n-\n-/*\n-* --------------------------------------------------------------------------------\n-* Methods\n-* --------------------------------------------------------------------------------\n-*/\n-\n-  /*\n-  * Calculate the WebPA and group scores for each student\n-  */\n-  function calculate() {\n-    echo('<p>ERROR: WebPAAlgorithm->calculate() is an abstract method and should be overridden.</p>');\n-    exit;\n-  }// /->calculate()\n-\n-/*\n-* ================================================================================\n-* Private Methods\n-* ================================================================================\n-*/\n-\n-  function _init() {\n-    $this->_groups = null;\n-    $this->_group_members = null;\n-    $this->_questions = null;\n-    $this->_responses = null;\n-    $this->_marking_params = null;\n-\n-    $this->_group_member_responses = null;\n-    $this->_group_member_total_awarded = null;\n-    $this->_group_member_frac_scores_awarded = null;\n-    $this->_group_member_total_received = null;\n-    $this->_group_member_webpa_scores = null;\n-    $this->_group_member_intermediate_grades = null;\n-    $this->_group_member_grades = null;\n-\n-    $this->_group_member_submitted = null;\n-    $this->_member_submitted = null;\n-  }// /->_init()\n+    /**\n+    * --------------------------------------------------------------------------------\n+    * Accessor Methods (SET)\n+    * --------------------------------------------------------------------------------\n+    */\n \n-}// /class: WebPAAlgorithm\n+    /**\n+    * Set groups\n+    *\n+    *@param array $groups groups to use in this algorithm : array[group_id] = group_mark\n+    */\n+    public function set_groups(& $groups)\n+    {\n+        $this->_groups =& $groups;\n+    }\n+\n+    // /->set_groups()\n+\n+    /*\n+    * Set group members\n+    *\n+    * $group_members  : (array) - members to use in this algorithm : array[group_id] = array ( member_id, ... )\n+    */\n+    public function set_group_members(& $group_members)\n+    {\n+        $this->_group_members =& $group_members;\n+    }\n+\n+    // /->set_group_members()\n+\n+    /*\n+    * Set marking parameters\n+    *\n+    * $params : (array) - marking parameters for this report : array ( int weighting , int penalty )\n+    */\n+    public function set_marking_params(& $marking_params)\n+    {\n+        $this->_marking_params =& $marking_params;\n+    }\n+\n+    // /->set_marking_params()\n+\n+    /*\n+    * Set questions\n+    * This could've just accepted an integer, but for future proofing (just in case) it takes an array (0-based)\n+    *\n+    * $questions  : (array) - questions in this assessment : array ( question_id, ... )\n+    */\n+    public function set_questions(& $questions)\n+    {\n+        $this->_questions =& $questions;\n+    }\n \n-?>\n+    // /->set_questions()\n+\n+    /*\n+    * Set member responses\n+    *\n+    * $responses  : (array) - responses given for this assessment : array[member_id][question_id][marked_member_id] = score\n+    */\n+    public function set_responses(& $responses)\n+    {\n+        $this->_responses =& $responses;\n+    }\n+\n+    // /->set_responses()\n+\n+    /*\n+    * --------------------------------------------------------------------------------\n+    * Methods\n+    * --------------------------------------------------------------------------------\n+    */\n+\n+    // Calculate the WebPA and group scores for each student\n+    public function calculate()\n+    {\n+        echo '<p>ERROR: WebPAAlgorithm->calculate() is an abstract method and should be overridden.</p>';\n+        exit;\n+    }\n+\n+    // /->calculate()\n+\n+    /*\n+    * ================================================================================\n+    * Private Methods\n+    * ================================================================================\n+    */\n+\n+    public function _init()\n+    {\n+        $this->_groups = null;\n+        $this->_group_members = null;\n+        $this->_questions = null;\n+        $this->_responses = null;\n+        $this->_marking_params = null;\n+\n+        $this->_group_member_responses = null;\n+        $this->_group_member_total_awarded = null;\n+        $this->_group_member_frac_scores_awarded = null;\n+        $this->_group_member_total_received = null;\n+        $this->_group_member_webpa_scores = null;\n+        $this->_group_member_intermediate_grades = null;\n+        $this->_group_member_grades = null;\n+\n+        $this->_group_member_submitted = null;\n+        $this->_member_submitted = null;\n+    }\n+\n+    // /->_init()\n+}// /class: WebPAAlgorithm"
        },
        {
          "filename": "src/includes/classes/Wizard.php",
          "status": "modified",
          "additions": 265,
          "deletions": 214,
          "patch": "@@ -14,296 +14,347 @@\n \n use WebPA\\includes\\functions\\Common;\n \n-class Wizard {\n-  // Public Vars\n-  public $back_button = '&lt; Back';\n-  public $next_button = 'Next &gt;';\n-  public $cancel_button = 'Cancel';\n-  public $cancel_url = '';\n+class Wizard\n+{\n+    // Public Vars\n+    public $back_button = '&lt; Back';\n \n-  public $name = '';\n+    public $next_button = 'Next &gt;';\n \n-  // Private Vars\n-  private $_page_url = null;\n-  private $_head_content = null;\n-  private $_form_content = null;\n+    public $cancel_button = 'Cancel';\n \n-  private $_current_step = 1;\n-  private $_total_steps = 1;\n-  private $_override_num_steps = null;\n+    public $cancel_url = '';\n \n-  private $_last_wizstep = null;\n-  private $_current_wizstep = null;\n+    public $name = '';\n \n-  private $_step_includes = array();\n-  private $_fields = array();\n-  private $_vars = array ();\n+    // Private Vars\n+    private $_page_url;\n \n-  private $_errors = null;\n+    private $_head_content;\n \n-  /**\n-  * CONSTRUCTOR for the wizard class\n-  * @param string $name\n-  */\n-  function __construct($name) {\n-    $this->name = $name;\n-    $this->_page_url = $_SERVER[\"PHP_SELF\"];\n+    private $_form_content;\n \n-    $this->_fields = unserialize( base64_decode( Common::fetch_POST('wiz_stored_fields',null) ) );\n-    if (!is_array($this->_fields)) { $this->_fields = array(); }\n-  }// /->Wizard()\n+    private $_current_step = 1;\n \n-/*\n-* --------------------------------------------------------------------------------\n-* Public Methods\n-* --------------------------------------------------------------------------------\n-*/\n+    private $_total_steps = 1;\n \n-/**\n- * Function to add a step to the wizard\n- * @param string $step_num\n- * @param string $step_include_file\n- */\n-  function add_step($step_num, $step_include_file) {\n-    $step_num = (int) $step_num;\n-    $this->_step_includes[\"$step_num\"] = $step_include_file;\n-  }// /add_step()\n+    private $_override_num_steps;\n \n-/**\n- * Function to write errors to screen\n- */\n-  function draw_errors() {\n-    if ($this->_errors) {\n-      ?>\n+    private $_last_wizstep;\n+\n+    private $_current_wizstep;\n+\n+    private $_step_includes = [];\n+\n+    private $_fields = [];\n+\n+    private $_vars = [];\n+\n+    private $_errors;\n+\n+    /**\n+    * CONSTRUCTOR for the wizard class\n+    * @param string $name\n+    */\n+    public function __construct($name)\n+    {\n+        $this->name = $name;\n+        $this->_page_url = $_SERVER['PHP_SELF'];\n+\n+        $this->_fields = unserialize(base64_decode(Common::fetch_POST('wiz_stored_fields', null)));\n+        if (!is_array($this->_fields)) {\n+            $this->_fields = [];\n+        }\n+    }\n+\n+    // /->Wizard()\n+\n+    /*\n+    * --------------------------------------------------------------------------------\n+    * Public Methods\n+    * --------------------------------------------------------------------------------\n+    */\n+\n+    /**\n+     * Function to add a step to the wizard\n+     * @param string $step_num\n+     * @param string $step_include_file\n+     */\n+    public function add_step($step_num, $step_include_file)\n+    {\n+        $step_num = (int) $step_num;\n+        $this->_step_includes[\"$step_num\"] = $step_include_file;\n+    }\n+\n+    // /add_step()\n+\n+    /**\n+     * Function to write errors to screen\n+     */\n+    public function draw_errors()\n+    {\n+        if ($this->_errors) {\n+            ?>\n       <div class=\"error_box\" style=\"\">\n         <p style=\"font-weight: bold;\">The following errors were found:</p>\n         <ul class=\"spaced\">\n         <?php\n-        foreach($this->_errors as $error_msg) {\n-          echo(\"<li>$error_msg</li>\");\n-        }\n-        ?>\n+        foreach ($this->_errors as $error_msg) {\n+            echo \"<li>$error_msg</li>\";\n+        } ?>\n         </ul>\n         <p>Please check the information in the form and try again.</p>\n       </div>\n       <?php\n+        }\n     }\n-  }// ->draw_errors()\n \n-/**\n- * function to write the wizard information to the screen\n- */\n-  function draw_wizard() {\n-    $wiz_fields = base64_encode( serialize( $this->_fields ) );\n+    // ->draw_errors()\n \n-    // build the wizard HTML code\n-    $html = <<<HTMLEnd\n-    <form action=\"{$this->_page_url}\" method=\"post\" name=\"wizard_form\" onsubmit=\"return wizard_form_onsubmit();\">\n-    <input type=\"hidden\" name=\"wiz_stored_fields\" value=\"$wiz_fields\" />\n-    <input type=\"hidden\" name=\"wiz_command\" id=\"wiz_command\" value=\"none\" />\n+    /**\n+     * function to write the wizard information to the screen\n+     */\n+    public function draw_wizard()\n+    {\n+        $wiz_fields = base64_encode(serialize($this->_fields));\n \n-    <div style=\"min-height: 170px;\">\n-HTMLEnd;\n-    echo($html);\n+        // build the wizard HTML code\n+        $html = <<<HTMLEnd\n+                <form action=\"{$this->_page_url}\" method=\"post\" name=\"wizard_form\" onsubmit=\"return wizard_form_onsubmit();\">\n+                <input type=\"hidden\" name=\"wiz_stored_fields\" value=\"$wiz_fields\" />\n+                <input type=\"hidden\" name=\"wiz_command\" id=\"wiz_command\" value=\"none\" />\n \n-    if ($this->_current_wizstep) {\n-      $this->_current_wizstep->form();\n-    }\n+                <div style=\"min-height: 170px;\">\n+            HTMLEnd;\n+        echo $html;\n \n-    // set the text for the wizard buttons\n-    $temp_back = (empty($this->back_button)) ? '&nbsp;': \"<input type=\\\"button\\\" name=\\\"wiz_command_back\\\" id=\\\"wiz_command_back\\\" onclick=\\\"do_command('back')\\\" value=\\\"$this->back_button\\\" />\";\n-    $temp_next = (empty($this->next_button)) ? '&nbsp;': \"<input type=\\\"button\\\" name=\\\"wiz_command_next\\\" id=\\\"wiz_command_next\\\" onclick=\\\"do_command('next')\\\" value=\\\"$this->next_button\\\" />\";\n-    $temp_cancel = (empty($this->cancel_button)) ? '&nbsp;': \"<input type=\\\"button\\\" name=\\\"wiz_command_cancel\\\" id=\\\"wiz_command_cancel\\\" onclick=\\\"do_command('cancel')\\\" value=\\\"$this->cancel_button\\\" />\";\n+        if ($this->_current_wizstep) {\n+            $this->_current_wizstep->form();\n+        }\n \n-    $html = <<<HTMLEnd\n-    </div>\n+        // set the text for the wizard buttons\n+        $temp_back = (empty($this->back_button)) ? '&nbsp;': \"<input type=\\\"button\\\" name=\\\"wiz_command_back\\\" id=\\\"wiz_command_back\\\" onclick=\\\"do_command('back')\\\" value=\\\"$this->back_button\\\" />\";\n+        $temp_next = (empty($this->next_button)) ? '&nbsp;': \"<input type=\\\"button\\\" name=\\\"wiz_command_next\\\" id=\\\"wiz_command_next\\\" onclick=\\\"do_command('next')\\\" value=\\\"$this->next_button\\\" />\";\n+        $temp_cancel = (empty($this->cancel_button)) ? '&nbsp;': \"<input type=\\\"button\\\" name=\\\"wiz_command_cancel\\\" id=\\\"wiz_command_cancel\\\" onclick=\\\"do_command('cancel')\\\" value=\\\"$this->cancel_button\\\" />\";\n \n-    <table align=\"center\" style=\"margin-top: 20px;\" cellpadding=\"0\" cellspacing=\"0\" width=\"70%\">\n-    <tr>\n-      <td align=\"left\" width=\"33%\">$temp_back</td>\n-      <td align=\"center\" width=\"33%\">$temp_cancel</td>\n-      <td align=\"right\" width=\"33%\">$temp_next</td>\n-    </tr>\n-    </table>\n+        $html = <<<HTMLEnd\n+                </div>\n \n-    </form>\n-HTMLEnd;\n+                <table align=\"center\" style=\"margin-top: 20px;\" cellpadding=\"0\" cellspacing=\"0\" width=\"70%\">\n+                <tr>\n+                  <td align=\"left\" width=\"33%\">$temp_back</td>\n+                  <td align=\"center\" width=\"33%\">$temp_cancel</td>\n+                  <td align=\"right\" width=\"33%\">$temp_next</td>\n+                </tr>\n+                </table>\n \n-    echo($html);\n-  }// /->draw_wizard()\n+                </form>\n+            HTMLEnd;\n \n-/**\n- * function prepare\n- */\n-  function prepare() {\n-    $this->_current_step = (array_key_exists('current_step',$this->_fields)) ? $this->_fields['current_step'] : 1 ;\n-    $this->_total_steps = count($this->_step_includes);\n+        echo $html;\n+    }\n \n-    $do_last = false;\n-    $do_next = true;\n+    // /->draw_wizard()\n \n-    $wiz_command = Common::fetch_POST('wiz_command');\n+    /**\n+     * function prepare\n+     */\n+    public function prepare()\n+    {\n+        $this->_current_step = (array_key_exists('current_step', $this->_fields)) ? $this->_fields['current_step'] : 1 ;\n+        $this->_total_steps = count($this->_step_includes);\n \n-    switch ($wiz_command) {\n-      case 'back' :\n+        $do_last = false;\n+        $do_next = true;\n+\n+        $wiz_command = Common::fetch_POST('wiz_command');\n+\n+        switch ($wiz_command) {\n+      case 'back':\n             $this->_current_step = ($this->_current_step>1) ? ($this->_current_step-1) : 1;\n             $do_last = false;\n             break;\n       // ----------\n-      case 'next' :\n+      case 'next':\n             $this->_current_step = ($this->_current_step<$this->_total_steps) ? ($this->_current_step + 1) : $this->_total_steps;\n             $do_last = true;\n             break;\n       // ----------\n-      case 'cancel' :\n+      case 'cancel':\n             header(\"Location: {$this->cancel_url}\");\n             exit;\n             break;\n       // ----------\n-      default :\n+      default:\n             $do_last = false;\n             break;\n     }// /switch\n \n \n-    // check if we should even try to do the wizard\n-    if ($this->_current_step<=$this->_total_steps) {\n+        // check if we should even try to do the wizard\n+        if ($this->_current_step<=$this->_total_steps) {\n \n       // get the last page we loaded\n-      if ( ($do_last) && ($this->_current_step>1) ) {\n-        $last_wiz_num = $this->_current_step - 1;\n-        include_once($this->_step_includes[\"$last_wiz_num\"]);\n-        eval(\"\\$this->_last_wizstep = new WizardStep{$last_wiz_num}(\\$this);\");\n-\n-        if ($this->_last_wizstep) {\n-          $this->_errors = $this->_last_wizstep->process_form();\n-\n-          // if there are errors, we won't be showing the next page, we'll go back to the last one!\n-          if (is_array($this->_errors)) {\n-            $this->_current_step = $this->_last_wizstep->step;\n-            $this->_current_wizstep =& $this->_last_wizstep;\n-          }\n+            if (($do_last) && ($this->_current_step>1)) {\n+                $last_wiz_num = $this->_current_step - 1;\n+                include_once $this->_step_includes[\"$last_wiz_num\"];\n+                eval(\"\\$this->_last_wizstep = new WizardStep{$last_wiz_num}(\\$this);\");\n+\n+                if ($this->_last_wizstep) {\n+                    $this->_errors = $this->_last_wizstep->process_form();\n+\n+                    // if there are errors, we won't be showing the next page, we'll go back to the last one!\n+                    if (is_array($this->_errors)) {\n+                        $this->_current_step = $this->_last_wizstep->step;\n+                        $this->_current_wizstep =& $this->_last_wizstep;\n+                    }\n+                }\n+            }// /if checking last page\n+\n+            // If the last page of the wizard was OK (or didn't exist), get the next page\n+            if ($do_next) {\n+                // get the current step\n+                include_once $this->_step_includes[\"{$this->_current_step}\"];\n+                eval(\"\\$this->_current_wizstep = new WizardStep{$this->_current_step}(\\$this);\");\n+            }\n+        }\n+\n+        $this->_current_step = $this->_current_wizstep->step;\n+        $this->_fields['current_step'] = $this->_current_step;\n+    }\n+\n+    // /->prepare()\n+\n+    /**\n+     * function to write the title of the wizard step to the screen\n+     */\n+    public function title()\n+    {\n+        if (!is_null($this->_override_num_steps)) {\n+            if ($this->_current_step<=$this->_override_num_steps) {\n+                echo \"<p>You are on <strong>step {$this->_current_step}</strong> of <strong>{$this->_override_num_steps}</strong> in the {$this->name}.</p>\";\n+            }\n+        } else {\n+            echo \"<p>You are on <strong>step {$this->_current_step}</strong> of <strong>{$this->_total_steps}</strong> in the {$this->name}.</p>\";\n         }\n-      }// /if checking last page\n-\n-      // If the last page of the wizard was OK (or didn't exist), get the next page\n-      if ($do_next) {\n-        // get the current step\n-        include_once($this->_step_includes[\"{$this->_current_step}\"]);\n-        eval(\"\\$this->_current_wizstep = new WizardStep{$this->_current_step}(\\$this);\");\n-      }\n     }\n \n-    $this->_current_step = $this->_current_wizstep->step;\n-    $this->_fields['current_step'] = $this->_current_step;\n-  }// /->prepare()\n+    // /->title()\n \n-/**\n- * function to write the title of the wizard step to the screen\n- */\n-  function title() {\n-    if (!is_null($this->_override_num_steps)) {\n-      if ($this->_current_step<=$this->_override_num_steps) {\n-        echo(\"<p>You are on <strong>step {$this->_current_step}</strong> of <strong>{$this->_override_num_steps}</strong> in the {$this->name}.</p>\");\n-      }\n-    } else {\n-      echo(\"<p>You are on <strong>step {$this->_current_step}</strong> of <strong>{$this->_total_steps}</strong> in the {$this->name}.</p>\");\n+    /**\n+     * function to get the field names for the input boxes\n+     * @param string $field_name\n+     * @return array\n+     */\n+    public function get_field($field_name, $default = null)\n+    {\n+        return (array_key_exists($field_name, $this->_fields)) ? $this->_fields[\"$field_name\"] :  $default ;\n     }\n-  }// /->title()\n \n-/**\n- * function to get the field names for the input boxes\n- * @param string $field_name\n- * @return array\n- */\n-  function get_field($field_name, $default = null) {\n-    return (array_key_exists($field_name,$this->_fields)) ? $this->_fields[\"$field_name\"] :  $default ;\n-  }// /->get_field()\n+    // /->get_field()\n \n-/**\n- * function to set the fields used in the wizard\n- * @param string $field_name\n- * @param string $field_value\n- */\n-  function set_field($field_name, $field_value) {\n-    $this->_fields[\"$field_name\"] = $field_value;\n-  }// /->set_field()\n+    /**\n+     * function to set the fields used in the wizard\n+     * @param string $field_name\n+     * @param string $field_value\n+     */\n+    public function set_field($field_name, $field_value)\n+    {\n+        $this->_fields[\"$field_name\"] = $field_value;\n+    }\n \n-/**\n- * function to set variables\n- * @param string $var_name\n- * @param string $var_value\n- */\n-  function set_var($var_name, &$var_value) {\n-    $this->_vars[\"$var_name\"] =& $var_value;\n-  }// /->set_var()\n+    // /->set_field()\n \n-/**\n- * function to get the variable by name\n- * @param string $var_name\n- *\n- * @return mixed|null\n- */\n-  function get_var($var_name) {\n-    return (array_key_exists($var_name,$this->_vars)) ? $this->_vars[\"$var_name\"] :  null ;\n-  }\n+    /**\n+     * function to set variables\n+     * @param string $var_name\n+     * @param string $var_value\n+     */\n+    public function set_var($var_name, &$var_value)\n+    {\n+        $this->_vars[\"$var_name\"] =& $var_value;\n+    }\n \n-/**\n- * Function to get the step\n- * @return string\n- */\n-  function get_step() {\n-    return $this->_current_step;\n-  }// /->get_step()\n+    // /->set_var()\n+\n+    /**\n+     * function to get the variable by name\n+     * @param string $var_name\n+     *\n+     * @return mixed|null\n+     */\n+    public function get_var($var_name)\n+    {\n+        return (array_key_exists($var_name, $this->_vars)) ? $this->_vars[\"$var_name\"] :  null ;\n+    }\n \n-/**\n- * function to set the url for the wizard\n- * @param string $url\n- */\n-  function set_wizard_url($url) {\n-    $this->_page_url = $url;\n-  }// /->set_page_url()\n+    /**\n+     * Function to get the step\n+     * @return string\n+     */\n+    public function get_step()\n+    {\n+        return $this->_current_step;\n+    }\n \n-/**\n- * function to show the steps\n- * @param string|integer $num_steps\n- */\n-  function show_steps($num_steps) {\n-    $this->_override_num_steps = $num_steps;\n-  }// /->show_steps\n+    // /->get_step()\n \n-/**\n- * function to wite the head for the wizard page\n- */\n-  function head() {\n-    $this->_current_wizstep->head();\n+    /**\n+     * function to set the url for the wizard\n+     * @param string $url\n+     */\n+    public function set_wizard_url($url)\n+    {\n+        $this->_page_url = $url;\n+    }\n \n-    $html = <<<HTMLEnd\n-<script language=\"JavaScript\" type=\"text/javascript\">\n-<!--\n+    // /->set_page_url()\n \n-  function do_command(str_comm) {\n-    document.getElementById('wiz_command').value = str_comm;\n-    document.wizard_form.submit();\n-  }// /do_command\n+    /**\n+     * function to show the steps\n+     * @param string|integer $num_steps\n+     */\n+    public function show_steps($num_steps)\n+    {\n+        $this->_override_num_steps = $num_steps;\n+    }\n+\n+    // /->show_steps\n+\n+    /**\n+     * function to wite the head for the wizard page\n+     */\n+    public function head()\n+    {\n+        $this->_current_wizstep->head();\n+\n+        $html = <<<HTMLEnd\n+            <script language=\"JavaScript\" type=\"text/javascript\">\n+            <!--\n \n-  function wizard_form_onsubmit() {\n-    return (document.wizard_form.wiz_command.value !='none');\n-  }\n+              function do_command(str_comm) {\n+                document.getElementById('wiz_command').value = str_comm;\n+                document.wizard_form.submit();\n+              }// /do_command\n \n-//-->\n-</script>\n-HTMLEnd;\n+              function wizard_form_onsubmit() {\n+                return (document.wizard_form.wiz_command.value !='none');\n+              }\n \n-    echo($html);\n-  }// /->head()\n+            //-->\n+            </script>\n+            HTMLEnd;\n+\n+        echo $html;\n+    }\n+\n+    // /->head()\n \n /*\n * --------------------------------------------------------------------------------\n * Private Methods\n * --------------------------------------------------------------------------------\n */\n-\n }// /class: Wizard\n \n ?>"
        },
        {
          "filename": "src/includes/classes/XMLParser.php",
          "status": "modified",
          "additions": 65,
          "deletions": 48,
          "patch": "@@ -38,40 +38,46 @@\n \n class XMLParser\n {\n-\n     // Public Vars\n     public $xml_data = '';\n+\n     public $xml_array;\n \n     // Private Vars\n     private $_parser;            // reference to the XML parser object\n \n     private $_parent;            // used by ->parse()\n+\n     private $_stack;             // used by ->parse()\n+\n     private $_last_opened_tag;   // used by ->parse()\n \n-    private $_cdata_tags = array();     // tags which should be handled as CDATA\n+    private $_cdata_tags = [];     // tags which should be handled as CDATA\n \n     private $data;\n \n     /**\n      * CONSTRUCTOR for the XML parser\n      */\n-    function __construct()\n+    public function __construct()\n     {\n         $this->_init();\n-    }// /XMLParser()\n+    }\n+\n+    // /XMLParser()\n \n     /**\n      * DESTRUCTOR for the xml parser\n      */\n-    function destroy()\n+    public function destroy()\n     {\n         if (is_resource($this->_parser)) {\n             xml_parser_free($this->_parser);\n         }\n         $this->_parser = null;\n-    }// /->destroy()\n+    }\n+\n+    // /->destroy()\n \n     /*\n     * ================================================================================\n@@ -83,18 +89,22 @@ function destroy()\n      * function to set the data tags\n      * @param string $tags\n      */\n-    function set_cdata_tags($tags)\n+    public function set_cdata_tags($tags)\n     {\n-        $this->_cdata_tags = (array)$tags;\n-    }// /->set_cdata_tags()\n+        $this->_cdata_tags = (array) $tags;\n+    }\n+\n+    // /->set_cdata_tags()\n \n     /**\n      * function to clear\n      */\n-    function clear()\n+    public function clear()\n     {\n         $this->_init();\n-    }// /->clear()\n+    }\n+\n+    // /->clear()\n \n     /**\n      * Parse the given XML document into a PHP array.\n@@ -103,7 +113,7 @@ function clear()\n      *\n      * @return array PHP array representing XML structure\n      */\n-    function parse($xml_data)\n+    public function parse($xml_data)\n     {\n         $this->_parser = xml_parser_create('');\n \n@@ -119,7 +129,7 @@ function parse($xml_data)\n \n         $this->data = '';\n         $this->_last_opened_tag = null;\n-        $this->_cdata_tags = (array)$this->_cdata_tags;\n+        $this->_cdata_tags = (array) $this->_cdata_tags;\n \n \n         return xml_parse($this->_parser, $this->xml_data, true) ? $this->xml_array : null;\n@@ -131,16 +141,16 @@ function parse($xml_data)\n      * @param array $data xml array structure\n      * @return string  xml document\n      */\n-    function generate_xml(&$data, $level = 0, $prior_key = null)\n+    public function generate_xml(&$data, $level = 0, $prior_key = null)\n     {\n         if ($level == 0) {\n             ob_start();\n             $prior_key = null;\n-            echo(\"<?xml version=\\\"1.0\\\" ?>\\n\");\n+            echo \"<?xml version=\\\"1.0\\\" ?>\\n\";\n         }\n \n         foreach ($data as $key => $value) {\n-            $key = (string)$key;\n+            $key = (string) $key;\n             // If the array key is NOT attributes or data, then it might be more tags (if it is attributes/data, just ignore it)\n             if (($key != '_attributes') && ($key != '_data')) {\n                 // This tag may contain others, so process them\n@@ -149,55 +159,57 @@ function generate_xml(&$data, $level = 0, $prior_key = null)\n                 } else {\n                     $tag = $prior_key ? $prior_key : $key;\n                     $tab_indent = str_repeat(\"\\t\", $level);\n-                    echo(\"{$tab_indent}<{$tag}\");\n+                    echo \"{$tab_indent}<{$tag}\";\n \n                     // Get a list of all the sub-arrays\n-                    $sub_array = array_flip(array_keys((array)$value));\n+                    $sub_array = array_flip(array_keys((array) $value));\n \n                     // If the tag has attributes, show them\n-                    if ((in_array('_attributes', $sub_array)) && (!empty($value['_attributes']))) {\n+                    // For backwards compatibility reasons, we do a check on if the sub_array is empty. Previously this was an in_array() check which always returned true\n+                    if (!empty($sub_array) && !empty($value['_attributes'])) {\n                         foreach ($value['_attributes'] as $attr_name => $attr_value) {\n-                            echo(' ' . $attr_name . '=\"' . htmlspecialchars($attr_value) . '\"');\n+                            echo ' ' . $attr_name . '=\"' . htmlspecialchars($attr_value) . '\"';\n                         }\n-                        reset($data[$key][\"_attributes\"]);\n                     }\n \n                     // Get the tag's value\n-                    $tag_data = (array_key_exists(\"_data\", (array)$value)) ? $value['_data'] : null;\n+                    $tag_data = (array_key_exists('_data', (array) $value)) ? $value['_data'] : null;\n \n                     // Remove the attributes/data from the sub-array list\n                     unset($sub_array['_attributes'], $sub_array['_data']);\n                     $sub_array = array_flip(array_values($sub_array));\n \n                     // If there are still sub-arrays then they're probably tags, so process them\n                     if (count($sub_array) > 0) {\n-                        echo(\">\\n\");  // ->generate_xml returns the xml by reference, so need to do this in two halves\n-                        echo($this->generate_xml($value, $level + 1) . \"{$tab_indent}</$tag>\\n\");\n+                        echo \">\\n\";  // ->generate_xml returns the xml by reference, so need to do this in two halves\n+                        echo $this->generate_xml($value, $level + 1) . \"{$tab_indent}</$tag>\\n\";\n                     } else {  // need to process the tag value\n                         // If the tag has no value, show an empty tag\n                         if (!$tag_data) {\n-                            echo(\" />\\n\");\n+                            echo \" />\\n\";\n                         } else {\n                             // If this tag has been highlighted as a CDATA tag, use CDATA\n                             if (in_array($tag, $this->_cdata_tags)) {\n-                                echo(\"><![CDATA[{$tag_data}]]></$tag>\\n\");\n+                                echo \"><![CDATA[{$tag_data}]]></$tag>\\n\";\n                             } else {  // Else, just use the value\n-                                echo('>' . htmlspecialchars($tag_data) . \"</$tag>\\n\");\n+                                echo '>' . htmlspecialchars($tag_data) . \"</$tag>\\n\";\n                             }\n                         }\n                     }\n                 }\n             }\n         }\n-        reset($data);\n \n         if ($level == 0) {\n             $str = &ob_get_contents();\n+\n             ob_end_clean();\n+\n             return $str;\n         }\n+    }\n \n-    }// ->generate_xml()\n+    // ->generate_xml()\n \n \n     /*\n@@ -218,7 +230,7 @@ function generate_xml(&$data, $level = 0, $prior_key = null)\n      * @param string $tag\n      * @param string $attributes\n      */\n-    function _tag_open(&$parser, $tag, $attributes)\n+    public function _tag_open($parser, $tag, $attributes)\n     {\n         $this->data = '';\n         $this->_last_opened_tag = $tag;\n@@ -230,7 +242,7 @@ function _tag_open(&$parser, $tag, $attributes)\n                 $key = $this->_count_numeric_items($this->_parent[$tag]);\n             } else {\n                 // Need to create the array of tags\n-                $arr = array(&$this->_parent[$tag]);\n+                $arr = [&$this->_parent[$tag]];\n                 $this->_parent[$tag] = &$arr;\n                 $key = 1;\n             }\n@@ -244,35 +256,41 @@ function _tag_open(&$parser, $tag, $attributes)\n \n         $this->_parent = &$this->_parent[$key];\n         $this->_stack[] = &$this->_parent;\n-    }// /->_tag_open()\n+    }\n \n     /**\n      * tag-data event handler\n      * @param string $parser\n      * @param string $data\n      */\n-    function _tag_data(&$parser, $data)\n+    public function _tag_data($parser, $data)\n     {\n         //you don't need to store whitespace in between tags\n-        if ($this->_last_opened_tag != NULL) {\n+        if ($this->_last_opened_tag != null) {\n             $this->data .= $data;\n         }\n-    }// /->_tag_data()\n+    }\n+\n+    // /->_tag_data()\n \n     /*\n     * tag-close event handler\n     * @param string $parser\n     * @param string $tag\n     */\n-    function _tag_close(&$parser, $tag)\n+    public function _tag_close($parser, $tag)\n     {\n         if ($this->_last_opened_tag == $tag) {\n             $this->_parent['_data'] = $this->data;\n-            $this->_last_opened_tag = NULL;\n+            $this->_last_opened_tag = null;\n         }\n         array_pop($this->_stack);\n-        if ($this->_stack) $this->_parent = &$this->_stack[count($this->_stack) - 1];\n-    }// /->_tag_close()\n+        if ($this->_stack) {\n+            $this->_parent = &$this->_stack[count($this->_stack) - 1];\n+        }\n+    }\n+\n+    // /->_tag_close()\n \n     /*\n     * --------------------------------------------------------------------------------\n@@ -285,14 +303,14 @@ function _tag_close(&$parser, $tag)\n      * @param array $array\n      * @return boolean\n      */\n-    function _count_numeric_items(&$array)\n+    public function _count_numeric_items(&$array)\n     {\n         return is_array($array) ? count(array_filter(array_keys($array), 'is_numeric')) : 0;\n-    }// /->_count_numeric_items()\n+    }\n \n-    /*\n-    */\n-    function _init()\n+    // /->_count_numeric_items()\n+    \n+    public function _init()\n     {\n         $this->xml_data = '';\n         $this->xml_array = null;\n@@ -301,9 +319,8 @@ function _init()\n         $this->_stack = null;\n         $this->_last_opened_tag = null;\n \n-        $this->_cdata_tags = array();\n-    }// /->_init()\n+        $this->_cdata_tags = [];\n+    }\n \n+    // /->_init()\n }// /class: XMLParser\n-\n-?>"
        },
        {
          "filename": "src/includes/classes/algorithms/Algorithm.php",
          "status": "modified",
          "additions": 514,
          "deletions": 480,
          "patch": "@@ -16,374 +16,411 @@\n use WebPA\\includes\\classes\\GroupHandler;\n use WebPA\\includes\\classes\\ResultHandler;\n \n-abstract class Algorithm {\n+abstract class Algorithm\n+{\n+    // Private Vars\n+    protected $_assessment;\n \n-  // Private Vars\n-  protected $_assessment;\n-  protected $_grade_ordinals = array();\n-  protected $_params;\n+    protected $_grade_ordinals = [];\n \n-  protected $_peeronly = false;\n+    protected $_params;\n \n-  protected $_group_grades;\n-  protected $_group_members;\n-  protected $_group_names;\n+    protected $_peeronly = false;\n \n-  protected $_form_type;\n-  protected $_questions;\n-  protected $_question_info;\n+    protected $_group_grades;\n \n-  protected $_responses;\n+    protected $_group_members;\n \n-  protected $_ordinal_scale;\n+    protected $_group_names;\n \n-  // These properties are used for checking what's actually happened in the assessment\n-  // Sub-classes should not use these for their calculations\n+    protected $_form_type;\n \n-  protected $_actual_responses = null;\n+    protected $_questions;\n \n-  protected $_actual_group_submitters = array();\n-  protected $_actual_submitters = array();\n+    protected $_question_info;\n \n-  protected $_actual_marks_awarded = null;\n-  protected $_actual_marks_received = null;\n+    protected $_responses;\n \n-  protected $_actual_marks_awarded_by_member_question = null;\n-  protected $_actual_marks_received_by_member_question = null;\n+    protected $_ordinal_scale;\n \n-  protected $_actual_total_marks_awarded = null;\n-  protected $_actual_total_marks_received = null;\n+    // These properties are used for checking what's actually happened in the assessment\n+    // Sub-classes should not use these for their calculations\n \n-  // These properties are used in the algorithm calculations\n-  // They can be manipulated to correct scoring problems (like peer-only and poor submissions)\n+    protected $_actual_responses;\n \n-  protected $_calc_responses = null;\n+    protected $_actual_group_submitters = [];\n \n-  protected $_calc_group_submitters = array();\n-  protected $_calc_submitters = array();\n+    protected $_actual_submitters = [];\n \n-  protected $_calc_marks_awarded = null;\n-  protected $_calc_marks_received = null;\n+    protected $_actual_marks_awarded;\n \n-  protected $_calc_marks_awarded_by_member_question = null;\n-  protected $_calc_marks_received_by_member_question = null;\n+    protected $_actual_marks_received;\n \n-  protected $_calc_total_marks_awarded = null;\n-  protected $_calc_total_marks_received = null;\n+    protected $_actual_marks_awarded_by_member_question;\n \n-  // These properties contain the final outputs from the algorithm\n+    protected $_actual_marks_received_by_member_question;\n \n-  protected $_webpa_scores = null;          // The mutiplication factor based on relative performance\n-  protected $_intermediate_grades = null;   // The intermediate grades (before penalties are applied)\n-  protected $_grades = null;                // The final grades\n-  protected $_penalties = null;             // Textual description of the penalties each member incurred\n+    protected $_actual_total_marks_awarded;\n \n+    protected $_actual_total_marks_received;\n \n+    // These properties are used in the algorithm calculations\n+    // They can be manipulated to correct scoring problems (like peer-only and poor submissions)\n \n-  /**\n-   * Constructor\n-   *\n-   * @return  Algorithm\n-   */\n-  public function __construct() {\n-  }// /->Algorithm()\n+    protected $_calc_responses;\n \n+    protected $_calc_group_submitters = [];\n \n+    protected $_calc_submitters = [];\n \n-/*\n-* ================================================================================\n-* Public Methods\n-* ================================================================================\n-*/\n+    protected $_calc_marks_awarded;\n \n+    protected $_calc_marks_received;\n \n+    protected $_calc_marks_awarded_by_member_question;\n \n-  /**\n-   * Calculate the student's final grades.\n-   *\n-   * As well as calculating grades, this method populates many of the properties\n-   * available via the get methods.\n-   *\n-   * @return  boolean  The operation was successful.\n-   */\n-  abstract public function calculate();\n+    protected $_calc_marks_received_by_member_question;\n \n+    protected $_calc_total_marks_awarded;\n \n+    protected $_calc_total_marks_received;\n \n-  /**\n-   * Get the final grades for every student.\n-   *\n-   * Output is of the form  array ( student_id => grade )\n-   * The type of grade (% or A-F) depends on the marking parameters supplied.\n-   *\n-   * @return  mixed  An assoc-array of grades. On fail, null.\n-   */\n-  public function get_grades() {\n-    return $this->_grades;\n-  }// /->get_grades()\n+    // These properties contain the final outputs from the algorithm\n \n+    protected $_webpa_scores;          // The mutiplication factor based on relative performance\n \n+    protected $_intermediate_grades;   // The intermediate grades (before penalties are applied)\n \n-  /**\n-   * Get the names of the groups involved in the assessment.\n-   *\n-   * Output is of the form array ( group_id => group_name )\n-   *\n-   * @return  mixed  An assoc-array of group names. On fail, null.\n-   */\n-  public function get_group_names() {\n-    return $this->_group_names;\n-  }// /->get_group_names()\n+    protected $_grades;                // The final grades\n \n+    protected $_penalties;             // Textual description of the penalties each member incurred\n \n+    /**\n+     * Constructor\n+     *\n+     * @return  Algorithm\n+     */\n+    public function __construct()\n+    {\n+    }\n \n-  /**\n-   * Get the names of the groups involved in the assessment.\n-   *\n-   * Output is of the form  array ( group_id => array ( member_id ) )\n-   *\n-   * @return  mixed  An assoc-array of members in each group. On fail, null.\n-   */\n-  public function get_group_members() {\n-    return $this->_group_members;\n-  }// /->get_group_members()\n+    // /->Algorithm()\n+\n+\n+\n+    /*\n+    * ================================================================================\n+    * Public Methods\n+    * ================================================================================\n+    */\n+\n+    /**\n+     * Calculate the student's final grades.\n+     *\n+     * As well as calculating grades, this method populates many of the properties\n+     * available via the get methods.\n+     *\n+     * @return  boolean  The operation was successful.\n+     */\n+    abstract public function calculate();\n+\n+    /**\n+     * Get the final grades for every student.\n+     *\n+     * Output is of the form  array ( student_id => grade )\n+     * The type of grade (% or A-F) depends on the marking parameters supplied.\n+     *\n+     * @return  mixed  An assoc-array of grades. On fail, null.\n+     */\n+    public function get_grades()\n+    {\n+        return $this->_grades;\n+    }\n \n+    // /->get_grades()\n+\n+    /**\n+     * Get the names of the groups involved in the assessment.\n+     *\n+     * Output is of the form array ( group_id => group_name )\n+     *\n+     * @return  mixed  An assoc-array of group names. On fail, null.\n+     */\n+    public function get_group_names()\n+    {\n+        return $this->_group_names;\n+    }\n \n+    // /->get_group_names()\n+\n+    /**\n+     * Get the names of the groups involved in the assessment.\n+     *\n+     * Output is of the form  array ( group_id => array ( member_id ) )\n+     *\n+     * @return  mixed  An assoc-array of members in each group. On fail, null.\n+     */\n+    public function get_group_members()\n+    {\n+        return $this->_group_members;\n+    }\n \n-  /**\n-   * Get the intermediate grades for every student.\n-   *\n-   * An intermediate grade is the grade a student receives before any penalties are applied.\n-   * Output is of the form  array ( person_id => intermediate_grade )\n-   * The type of grade (% or A-F) depends on the marking parameters supplied.\n-   *\n-   * @return  mixed  An assoc array of students and their grades. On fail, null.\n-   */\n-  public function get_intermediate_grades() {\n-    return $this->_intermediate_grades;\n-  }// /->get_intermediate_grades()\n+    // /->get_group_members()\n+\n+    /**\n+     * Get the intermediate grades for every student.\n+     *\n+     * An intermediate grade is the grade a student receives before any penalties are applied.\n+     * Output is of the form  array ( person_id => intermediate_grade )\n+     * The type of grade (% or A-F) depends on the marking parameters supplied.\n+     *\n+     * @return  mixed  An assoc array of students and their grades. On fail, null.\n+     */\n+    public function get_intermediate_grades()\n+    {\n+        return $this->_intermediate_grades;\n+    }\n \n+    // /->get_intermediate_grades()\n \n+    public function get_marks_awarded()\n+    {\n+        return $this->_actual_marks_awarded;\n+    }\n \n-  public function get_marks_awarded() {\n-    return $this->_actual_marks_awarded;\n-  }// /->get_marks_awarded()\n+    // /->get_marks_awarded()\n \n+    public function get_marks_received()\n+    {\n+        return $this->_actual_marks_received;\n+    }\n \n+    // /->get_marks_received()\n \n-  public function get_marks_received() {\n-    return $this->_actual_marks_received;\n-  }// /->get_marks_received()\n-\n-  public function get_total_marks_awarded() {\n-    return $this->_actual_total_marks_awarded;\n-  }// /->get_total_marks_awarded()\n-\n-  public function get_total_marks_received() {\n-    return $this->_actual_total_marks_received;\n-  }// /->get_total_marks_received()\n-\n-\n-  /**\n-   * Get the score given by one member of a group to another member for a particular question\n-   *\n-   * @param  integer  $group_id  The group to check.\n-   * @param  integer  $member_id  The member awarding the score.\n-   * @param  integer  $question_id  The question the score was for.\n-   * @param  integer  $target_member_id  The member receiving the score.\n-   *\n-   * @return  array  The score awarded. On fail, null.\n-   */\n-  function get_member_response($group_id, $member_id, $question_id, $target_member_id) {\n-    $score = null;\n-    if (array_key_exists($group_id, $this->_actual_responses)) {\n-      if (array_key_exists($question_id, $this->_actual_responses[$group_id])) {\n-        if (array_key_exists($member_id, $this->_actual_responses[$group_id][$question_id])) {\n-          if (array_key_exists($target_member_id, $this->_actual_responses[$group_id][$question_id][$member_id])) {\n-            $score = $this->_actual_responses[$group_id][$question_id][$member_id][$target_member_id];\n-          }\n-        }\n-      }\n+    public function get_total_marks_awarded()\n+    {\n+        return $this->_actual_total_marks_awarded;\n     }\n-    return $score;\n-  }// /->get_member_response()\n-\n-\n-\n-  /**\n-   * Get a list of penalised students, and the amount they were penalised.\n-   *\n-   * Output is of the form  array ( person_id => penalty )\n-   * Penalties are always numeric but may be 0.\n-   * Students without a penalty are not included in the list.\n-   *\n-   * @return  mixed  An assoc array of students and their penalties. On fail, null.\n-   */\n-  public function get_penalties() {\n-    return $this->_penalties;\n-  }// /->get_penalties()\n-\n-\n-\n-  /**\n-   * Get the questions used in the assessment.\n-   *\n-   * Output is of the form array ( group_id => group_name )\n-   *\n-   * @return  mixed  An assoc-array of question information. On fail, null.\n-   */\n-  public function get_questions() {\n-    return $this->_question_info;\n-  }// /->get_questions()\n-\n-\n-\n-  /**\n-   * Get a list of students who submitted.\n-   *\n-   * Output is of the form  array ( person_id )\n-   *\n-   * @return  mixed  An assoc array of students. On fail, null.\n-   */\n-  public function get_submitters() {\n-    return (!empty($this->_actual_submitters)) ? $this->_actual_submitters : null ;\n-  }// /->get_submitters()\n-\n-\n-\n-  /**\n-   * Get the WebPA scores for every student.\n-   *\n-   * Web-PA scores are the multiplication factors produced by analysings the scores received\n-   * in the peer assessment.  The average group score is 1.0.  Scores above 1 mean above average performance,\n-   * and vice-versa.\n-   * Output is of the form  array ( student_id => webpa socre )\n-   *\n-   * @return  mixed  An assoc-array of webpa scores. On fail, null.\n-   */\n-  public function get_webpa_scores() {\n-    return $this->_webpa_scores;\n-  }// /->get_webpa_scores()\n-\n-\n-\n-  /**\n-   * Set which assessment to use.\n-   *\n-   * @param  object  The assessment.\n-   *\n-   * @return  boolean  The operation was successful.\n-   */\n-  public function set_assessment($assessment) {\n-    $this->_assessment = $assessment;\n-\n-    $db = $this->_assessment->get_db();\n-\n-    // Set peer-only status\n-    $this->_peeronly = ($this->_assessment->assessment_type == 0);\n-\n-    // Get group overall grades information\n-    $this->_group_grades = $this->_assessment->get_group_marks();\n-\n-\n-    // Get a list of the members who took this assessment (grouped by 'group')\n-    $group_members = null;\n-    $group_names = null;\n-\n-    $group_handler = new GroupHandler();\n-    $collection = $group_handler->get_collection($this->_assessment->get_collection_id());\n-    $groups_iterator = $collection->get_groups_iterator();\n-    if ($groups_iterator->size()>0) {\n-      for($groups_iterator->reset(); $groups_iterator->is_valid(); $groups_iterator->next()) {\n-        $group =& $groups_iterator->current();\n-        $this->_group_names[\"{$group->id}\"] = $group->name;\n-        $this->_group_members[\"{$group->id}\"] = $group->get_member_ids();\n-      }\n+\n+    // /->get_total_marks_awarded()\n+\n+    public function get_total_marks_received()\n+    {\n+        return $this->_actual_total_marks_received;\n     }\n \n+    // /->get_total_marks_received()\n+\n+    /**\n+     * Get the score given by one member of a group to another member for a particular question\n+     *\n+     * @param  integer  $group_id  The group to check.\n+     * @param  integer  $member_id  The member awarding the score.\n+     * @param  integer  $question_id  The question the score was for.\n+     * @param  integer  $target_member_id  The member receiving the score.\n+     *\n+     * @return  array  The score awarded. On fail, null.\n+     */\n+    public function get_member_response($group_id, $member_id, $question_id, $target_member_id)\n+    {\n+        $score = null;\n+        if (array_key_exists($group_id, $this->_actual_responses)) {\n+            if (array_key_exists($question_id, $this->_actual_responses[$group_id])) {\n+                if (array_key_exists($member_id, $this->_actual_responses[$group_id][$question_id])) {\n+                    if (array_key_exists($target_member_id, $this->_actual_responses[$group_id][$question_id][$member_id])) {\n+                        $score = $this->_actual_responses[$group_id][$question_id][$member_id][$target_member_id];\n+                    }\n+                }\n+            }\n+        }\n+        return $score;\n+    }\n \n-    // Get the number of questions used in this assessment, and create an array of that size\n-    $form = $this->_assessment->get_form();\n+    // /->get_member_response()\n+\n+    /**\n+     * Get a list of penalised students, and the amount they were penalised.\n+     *\n+     * Output is of the form  array ( person_id => penalty )\n+     * Penalties are always numeric but may be 0.\n+     * Students without a penalty are not included in the list.\n+     *\n+     * @return  mixed  An assoc array of students and their penalties. On fail, null.\n+     */\n+    public function get_penalties()\n+    {\n+        return $this->_penalties;\n+    }\n \n-    $this->_form_type = ($form->type=='split100') ? 'split100' : 'likert' ;\n+    // /->get_penalties()\n+\n+    /**\n+     * Get the questions used in the assessment.\n+     *\n+     * Output is of the form array ( group_id => group_name )\n+     *\n+     * @return  mixed  An assoc-array of question information. On fail, null.\n+     */\n+    public function get_questions()\n+    {\n+        return $this->_question_info;\n+    }\n \n-    $question_count = (int) $form->get_question_count();\n+    // /->get_questions()\n+\n+    /**\n+     * Get a list of students who submitted.\n+     *\n+     * Output is of the form  array ( person_id )\n+     *\n+     * @return  mixed  An assoc array of students. On fail, null.\n+     */\n+    public function get_submitters()\n+    {\n+        return (!empty($this->_actual_submitters)) ? $this->_actual_submitters : null ;\n+    }\n \n-    $this->_questions = ($question_count>0) ? range(0, $question_count-1) : array();\n-    foreach($this->_questions as $i => $question_id) {\n-      $this->_question_info[$question_id] = $form->get_question($question_id);\n+    // /->get_submitters()\n+\n+    /**\n+     * Get the WebPA scores for every student.\n+     *\n+     * Web-PA scores are the multiplication factors produced by analysings the scores received\n+     * in the peer assessment.  The average group score is 1.0.  Scores above 1 mean above average performance,\n+     * and vice-versa.\n+     * Output is of the form  array ( student_id => webpa socre )\n+     *\n+     * @return  mixed  An assoc-array of webpa scores. On fail, null.\n+     */\n+    public function get_webpa_scores()\n+    {\n+        return $this->_webpa_scores;\n     }\n \n-    // Get the student submissions for this assessment\n-    $result_handler = new ResultHandler($db);\n-    $result_handler->set_assessment($this->_assessment);\n+    // /->get_webpa_scores()\n+\n+    /**\n+     * Set which assessment to use.\n+     *\n+     * @param  object  The assessment.\n+     *\n+     * @return  boolean  The operation was successful.\n+     */\n+    public function set_assessment($assessment)\n+    {\n+        $this->_assessment = $assessment;\n \n-    $this->_responses = $result_handler->get_responses();\n+        $db = $this->_assessment->get_db();\n \n-    return true;\n-  }// /->set_assessment()\n+        // Set peer-only status\n+        $this->_peeronly = ($this->_assessment->assessment_type == 0);\n \n+        // Get group overall grades information\n+        $this->_group_grades = $this->_assessment->get_group_marks();\n \n \n-  /**\n-   * Set grade letter ordinal scales.\n-   *\n-   * @param  array  $ordinal_scale.\n-   *\n-   * @return  boolean  The operation was successful.\n-   */\n-  public function set_grade_ordinals($ordinal_scale) {\n-    $this->_ordinal_scale = $ordinal_scale;\n-    return true;\n-  }// /->set_grade_ordinals()\n+        // Get a list of the members who took this assessment (grouped by 'group')\n+        $group_members = null;\n+        $group_names = null;\n \n+        $group_handler = new GroupHandler();\n+        $collection = $group_handler->get_collection($this->_assessment->get_collection_id());\n+        $groups_iterator = $collection->get_groups_iterator();\n+        if ($groups_iterator->size()>0) {\n+            for ($groups_iterator->reset(); $groups_iterator->is_valid(); $groups_iterator->next()) {\n+                $group =& $groups_iterator->current();\n+                $this->_group_names[\"{$group->id}\"] = $group->name;\n+                $this->_group_members[\"{$group->id}\"] = $group->get_member_ids();\n+            }\n+        }\n \n \n-  /**\n-   * Set marking parameters.\n-   *\n-   * @param  array  Assoc-array of marking parameters for this report.\n-   *\n-   * @return  boolean  The operation was successful.\n-   */\n-  public function set_marking_params($marking_params) {\n-    $this->_params = $marking_params;\n-    return true;\n-  }// /->set_marking_params()\n+        // Get the number of questions used in this assessment, and create an array of that size\n+        $form = $this->_assessment->get_form();\n \n+        $this->_form_type = ($form->type=='split100') ? 'split100' : 'likert' ;\n \n+        $question_count = (int) $form->get_question_count();\n \n-/*\n-* ================================================================================\n-* Private Methods\n-* ================================================================================\n-*/\n+        $this->_questions = ($question_count>0) ? range(0, $question_count-1) : [];\n+        foreach ($this->_questions as $i => $question_id) {\n+            $this->_question_info[$question_id] = $form->get_question($question_id);\n+        }\n \n+        // Get the student submissions for this assessment\n+        $result_handler = new ResultHandler($db);\n+        $result_handler->set_assessment($this->_assessment);\n \n+        $this->_responses = $result_handler->get_responses();\n \n-  /**\n-   * Apply any criterion weightings to the students' fractional marks.\n-   *\n-   * @return  boolean  The operation was successful.\n-   */\n-  protected function _applyCriterionWeightings() {\n+        return true;\n+    }\n \n-    // @todo : criterion weightings should make an appearnce in a future version.\n+    // /->set_assessment()\n+\n+    /**\n+     * Set grade letter ordinal scales.\n+     *\n+     * @param  array  $ordinal_scale.\n+     *\n+     * @return  boolean  The operation was successful.\n+     */\n+    public function set_grade_ordinals($ordinal_scale)\n+    {\n+        $this->_ordinal_scale = $ordinal_scale;\n+        return true;\n+    }\n+\n+    // /->set_grade_ordinals()\n+\n+    /**\n+     * Set marking parameters.\n+     *\n+     * @param  array  Assoc-array of marking parameters for this report.\n+     *\n+     * @return  boolean  The operation was successful.\n+     */\n+    public function set_marking_params($marking_params)\n+    {\n+        $this->_params = $marking_params;\n+        return true;\n+    }\n+\n+    // /->set_marking_params()\n \n-    return true;\n-  }// /->_applyCriterionWeightings()\n \n \n+    /*\n+    * ================================================================================\n+    * Private Methods\n+    * ================================================================================\n+    */\n \n-  /**\n-   * Convert the current grades to the required display format.\n-   *\n-   * @return  boolean  The operation was successful.\n-   */\n-  protected function _applyGradingStyle() {\n-    $grade_mode = ($this->_params['grading']=='grade_af') ? 'grade_af' : 'numeric' ;\n+    /**\n+     * Apply any criterion weightings to the students' fractional marks.\n+     *\n+     * @return  boolean  The operation was successful.\n+     */\n+    protected function _applyCriterionWeightings()\n+    {\n \n-    switch($grade_mode) {\n+    // @todo : criterion weightings should make an appearnce in a future version.\n+\n+        return true;\n+    }\n+\n+    // /->_applyCriterionWeightings()\n+\n+    /**\n+     * Convert the current grades to the required display format.\n+     *\n+     * @return  boolean  The operation was successful.\n+     */\n+    protected function _applyGradingStyle()\n+    {\n+        $grade_mode = ($this->_params['grading']=='grade_af') ? 'grade_af' : 'numeric' ;\n+\n+        switch ($grade_mode) {\n       // ----------------------------------------\n       // Grades should be Alphabetic (A-F and the rest)\n       case 'grade_af':\n@@ -392,267 +429,264 @@ protected function _applyGradingStyle() {\n         $top_grade = $grade_letters[0];\n \n         if ($this->_intermediate_grades) {\n-          foreach($this->_intermediate_grades as $id => $grade) {\n-            $grade_set = false;\n-            foreach($this->_ordinal_scale as $grade_letter => $grade_numeric) {\n-              if ($grade>$grade_numeric) {\n-                break;\n-              } else {\n-                $this->_intermediate_grades[$id] = $grade_letter;\n-                $grade_set = true;\n-              }\n+            foreach ($this->_intermediate_grades as $id => $grade) {\n+                $grade_set = false;\n+                foreach ($this->_ordinal_scale as $grade_letter => $grade_numeric) {\n+                    if ($grade>$grade_numeric) {\n+                        break;\n+                    }\n+                    $this->_intermediate_grades[$id] = $grade_letter;\n+                    $grade_set = true;\n+                }\n+\n+                // If we didn't set at least one grade-letter, then the student must have the top grade\n+                if (!$grade_set) {\n+                    $this->_intermediate_grades[$id] = $top_grade;\n+                }\n             }\n-\n-            // If we didn't set at least one grade-letter, then the student must have the top grade\n-            if (!$grade_set) { $this->_intermediate_grades[$id] = $top_grade; }\n-          }\n         }\n \n         if ($this->_grades) {\n-          foreach($this->_grades as $id => $grade) {\n-            $grade_set = false;\n-            foreach($this->_ordinal_scale as $grade_letter => $grade_numeric) {\n-              if ($grade>$grade_numeric) {\n-                break;\n-              } else {\n-                $this->_grades[$id] = $grade_letter;\n-                $grade_set = true;\n-              }\n+            foreach ($this->_grades as $id => $grade) {\n+                $grade_set = false;\n+                foreach ($this->_ordinal_scale as $grade_letter => $grade_numeric) {\n+                    if ($grade>$grade_numeric) {\n+                        break;\n+                    }\n+                    $this->_grades[$id] = $grade_letter;\n+                    $grade_set = true;\n+                }\n+\n+                // If we didn't set at least one grade-letter, then the student must have the top grade\n+                if (!$grade_set) {\n+                    $this->_grades[$id] = $top_grade;\n+                }\n             }\n-\n-            // If we didn't set at least one grade-letter, then the student must have the top grade\n-            if (!$grade_set) { $this->_grades[$id] = $top_grade; }\n-          }\n         }\n         break;\n       // ----------------------------------------\n       // Grades should be numeric (%)\n       case 'numeric':\n       default:\n         if ($this->_intermediate_grades) {\n-          foreach($this->_intermediate_grades as $id => $grade) {\n-            $this->_intermediate_grades[$id] = sprintf(APP__REPORT_DECIMALS, $grade) .'%';\n-          }\n+            foreach ($this->_intermediate_grades as $id => $grade) {\n+                $this->_intermediate_grades[$id] = sprintf(APP__REPORT_DECIMALS, $grade) .'%';\n+            }\n         }\n \n         if ($this->_grades) {\n-          foreach($this->_grades as $id => $grade) {\n-            $this->_grades[$id] = sprintf(APP__REPORT_DECIMALS, $grade) .'%';\n-          }\n+            foreach ($this->_grades as $id => $grade) {\n+                $this->_grades[$id] = sprintf(APP__REPORT_DECIMALS, $grade) .'%';\n+            }\n         }\n       break;\n     }// /switch()\n \n-    return true;\n-  }// /->__applyGradingStyle()\n-\n-\n-\n-  /**\n-   * Apply any applicable penalties to the final grades\n-   *\n-   * @return  boolean  The operation was successful.\n-   */\n-  protected function _applyPenalties() {\n-    if ($this->_grades) {\n+        return true;\n+    }\n \n-      if (is_null($this->_actual_submitters)) {\n-        $this->_actual_submitters = array();\n-      }\n+    // /->__applyGradingStyle()\n \n-      // If the penalty is a percentage..\n-      if ($this->_params['penalty_type']=='%') {\n+    /**\n+     * Apply any applicable penalties to the final grades\n+     *\n+     * @return  boolean  The operation was successful.\n+     */\n+    protected function _applyPenalties()\n+    {\n+        if ($this->_grades) {\n+            if (is_null($this->_actual_submitters)) {\n+                $this->_actual_submitters = [];\n+            }\n \n-        $penalty = ($this->_params['penalty']==0) ? 1 : 1-($this->_params['penalty']/100) ;\n+            // If the penalty is a percentage..\n+            if ($this->_params['penalty_type']=='%') {\n+                $penalty = ($this->_params['penalty']==0) ? 1 : 1-($this->_params['penalty']/100) ;\n \n-        foreach($this->_grades as $person_id => $grade) {\n-          // If the person did not submit, penalise them\n-          if (!in_array($person_id, $this->_actual_submitters)) {\n-            $this->_penalties[$person_id] = ($this->_params['penalty']==0) ? 'no penalty' : \"-{$this->_params['penalty']}%\" ;\n+                foreach ($this->_grades as $person_id => $grade) {\n+                    // If the person did not submit, penalise them\n+                    if (!in_array($person_id, $this->_actual_submitters)) {\n+                        $this->_penalties[$person_id] = ($this->_params['penalty']==0) ? 'no penalty' : \"-{$this->_params['penalty']}%\" ;\n \n-            // Multiply the grade by the penalty\n-            $final_grade = $grade * $penalty;\n+                        // Multiply the grade by the penalty\n+                        $final_grade = $grade * $penalty;\n \n-            if ($final_grade<0) { $final_grade = 0; }\n-            elseif ($final_grade>100) { $final_grade = 100; }\n+                        if ($final_grade<0) {\n+                            $final_grade = 0;\n+                        } elseif ($final_grade>100) {\n+                            $final_grade = 100;\n+                        }\n \n-            // Update the final grade\n-            $this->_grades[$person_id] = $final_grade;\n-          }\n-        }// /foreach(grade)\n-      } else {   // Else.. Penalty is percentage-points\n+                        // Update the final grade\n+                        $this->_grades[$person_id] = $final_grade;\n+                    }\n+                }// /foreach(grade)\n+            } else {   // Else.. Penalty is percentage-points\n \n         $penalty = $this->_params['penalty'];\n \n-        foreach($this->_grades as $person_id => $grade) {\n-          // If the person did not submit, penalise them\n-          if (!in_array($person_id, $this->_actual_submitters)) {\n+                foreach ($this->_grades as $person_id => $grade) {\n+                    // If the person did not submit, penalise them\n+                    if (!in_array($person_id, $this->_actual_submitters)) {\n+                        $this->_penalties[$person_id] = ($this->_params['penalty']==0) ? 'no penalty' : \"-{$this->_params['penalty']} pp\" ;\n \n-            $this->_penalties[$person_id] = ($this->_params['penalty']==0) ? 'no penalty' : \"-{$this->_params['penalty']} pp\" ;\n+                        // Subtract the penalty from the grade\n+                        $final_grade = $grade - $penalty;\n \n-            // Subtract the penalty from the grade\n-            $final_grade = $grade - $penalty;\n+                        if ($final_grade<0) {\n+                            $final_grade = 0;\n+                        } elseif ($final_grade>100) {\n+                            $final_grade = 100;\n+                        }\n \n-            if ($final_grade<0) { $final_grade = 0; }\n-            elseif ($final_grade>100) { $final_grade = 100; }\n+                        // Update the final grade\n+                        $this->_grades[$person_id] = $final_grade;\n+                    }\n+                }// /foreach(grade)\n+            }\n+        }// /if(grades)\n \n-            // Update the final grade\n-            $this->_grades[$person_id] = $final_grade;\n-          }\n-        }// /foreach(grade)\n-      }\n-    }// /if(grades)\n+        if (empty($this->_actual_submitters)) {\n+            $this->_actual_submitters = null;\n+        }\n \n-    if (empty($this->_actual_submitters)) {\n-      $this->_actual_submitters = null;\n+        return true;\n     }\n \n-    return true;\n-  }// /->_applyPenalties()\n-\n+    // /->_applyPenalties()\n \n-\n-  /**\n-   * Initialise some of the algorithm's properties based prior to calculating the grades.\n-   *\n-   * Places the real student response information in the ->_actual_?? properties.\n-   * Response information for the algorithm calculations is placed in the ->_calc_?? properties.\n-   * ->_calc_?? properties can/will be altered by specific algorithms to provide proper grading.\n-   * For example, see ->_preparePeerOnly()\n-   *\n-   * @return  boolean  The operation was successful.\n-   */\n-  protected function _initialise() {\n+    /**\n+     * Initialise some of the algorithm's properties based prior to calculating the grades.\n+     *\n+     * Places the real student response information in the ->_actual_?? properties.\n+     * Response information for the algorithm calculations is placed in the ->_calc_?? properties.\n+     * ->_calc_?? properties can/will be altered by specific algorithms to provide proper grading.\n+     * For example, see ->_preparePeerOnly()\n+     *\n+     * @return  boolean  The operation was successful.\n+     */\n+    protected function _initialise()\n+    {\n \n \n     // Initial marks for each question. Saves looping through questions every time when initialising scores.\n-    $initial_marks_per_question = null;\n-    foreach($this->_questions as $i => $question_id) {\n-      $initial_marks_per_question[$question_id] = null;   // A null means no score\n-    }\n+        $initial_marks_per_question = null;\n+        foreach ($this->_questions as $i => $question_id) {\n+            $initial_marks_per_question[$question_id] = null;   // A null means no score\n+        }\n \n \n-    $this->_actual_submitters = array();\n-    $this->_actual_group_submitters = array();\n+        $this->_actual_submitters = [];\n+        $this->_actual_group_submitters = [];\n \n-    $this->_calc_submitters = array();\n-    $this->_calc_group_submitters = array();\n+        $this->_calc_submitters = [];\n+        $this->_calc_group_submitters = [];\n \n \n-    // Initialise awarded/received scores\n-    foreach($this->_group_names as $group_id => $group_name) {\n+        // Initialise awarded/received scores\n+        foreach ($this->_group_names as $group_id => $group_name) {\n \n       // Initial marks from each student to each student.\n-      // This array is built in the following loop, so it is specific to each group.\n-      $initial_students_marks = array();\n+            // This array is built in the following loop, so it is specific to each group.\n+            $initial_students_marks = [];\n \n-      foreach($this->_group_members[$group_id] as $i => $member_id) {\n+            foreach ($this->_group_members[$group_id] as $i => $member_id) {\n+                $this->_actual_marks_awarded_by_member_question[$member_id] = $initial_marks_per_question;\n+                $this->_actual_marks_received_by_member_question[$member_id] = $initial_marks_per_question;\n \n-        $this->_actual_marks_awarded_by_member_question[$member_id] = $initial_marks_per_question;\n-        $this->_actual_marks_received_by_member_question[$member_id] = $initial_marks_per_question;\n+                $this->_calc_marks_awarded_by_member_question[$member_id] = $initial_marks_per_question;\n+                $this->_calc_marks_received_by_member_question[$member_id] = $initial_marks_per_question;\n \n-        $this->_calc_marks_awarded_by_member_question[$member_id] = $initial_marks_per_question;\n-        $this->_calc_marks_received_by_member_question[$member_id] = $initial_marks_per_question;\n \n+                foreach ($this->_group_members[$group_id] as $j => $marked_user_id) {\n+                    $initial_students_marks[$member_id][$marked_user_id] = null;\n \n-        foreach($this->_group_members[$group_id] as $j => $marked_user_id) {\n+                    $this->_actual_marks_awarded[$member_id][$marked_user_id] = 0;\n+                    $this->_actual_marks_received[$marked_user_id][$member_id] = 0;\n \n-          $initial_students_marks[$member_id][$marked_user_id] = null;\n+                    $this->_calc_marks_awarded[$member_id][$marked_user_id] = 0;\n+                    $this->_calc_marks_received[$marked_user_id][$member_id] = 0;\n+                }\n \n-          $this->_actual_marks_awarded[$member_id][$marked_user_id] = 0;\n-          $this->_actual_marks_received[$marked_user_id][$member_id] = 0;\n+                $this->_actual_total_marks_awarded[$member_id] = 0;\n+                $this->_actual_total_marks_received[$member_id] = 0;\n \n-          $this->_calc_marks_awarded[$member_id][$marked_user_id] = 0;\n-          $this->_calc_marks_received[$marked_user_id][$member_id] = 0;\n-        }\n+                $this->_calc_total_marks_awarded[$member_id] = 0;\n+                $this->_calc_total_marks_received[$member_id] = 0;\n+            }\n+\n+            // Set the initial marks for this group, for each question\n+            foreach ($this->_questions as $i => $question_id) {\n+                $this->_actual_responses[$group_id][$question_id] = $initial_students_marks;\n+            }\n+        }// /foreach(group)\n \n-        $this->_actual_total_marks_awarded[$member_id] = 0;\n-        $this->_actual_total_marks_received[$member_id] = 0;\n \n-        $this->_calc_total_marks_awarded[$member_id] = 0;\n-        $this->_calc_total_marks_received[$member_id] = 0;\n-      }\n \n-      // Set the initial marks for this group, for each question\n-      foreach($this->_questions as $i => $question_id) {\n-        $this->_actual_responses[$group_id][$question_id] = $initial_students_marks;\n-      }\n+        // Process all the student responses\n+        // Set the correct values for the actual marks awarded, received, etc\n+        if (!empty($this->_responses)) {\n+            foreach ($this->_responses as $i => $response) {\n+                $group_id = $response['group_id'];\n+                $member_id = $response['user_id'];\n+                $marked_user_id = $response['marked_user_id'];\n+                $question_id = $response['question_id'];\n+                $score = (float) $response['score'];\n \n-    }// /foreach(group)\n+                // Record the fact this member submitted\n+                if (!in_array($member_id, $this->_actual_submitters)) {\n+                    $this->_actual_submitters[] = $member_id;\n+                    $this->_actual_group_submitters[$group_id][] = $member_id;\n+                }\n \n+                // Re-factor the responses into more usable forms\n+                $this->_actual_responses[$group_id][$question_id][$member_id][$marked_user_id] = $score;\n \n+                // Keep a running total of the marks\n \n-    // Process all the student responses\n-    // Set the correct values for the actual marks awarded, received, etc\n-    if(!empty($this->_responses)){\n-      foreach($this->_responses as $i => $response) {\n+                $this->_actual_marks_awarded[$member_id][$marked_user_id] += $score;\n+                $this->_actual_marks_received[$marked_user_id][$member_id] += $score;\n \n-        $group_id = $response['group_id'];\n-        $member_id = $response['user_id'];\n-        $marked_user_id = $response['marked_user_id'];\n-        $question_id = $response['question_id'];\n-        $score = (float) $response['score'];\n+                $this->_actual_marks_awarded_by_member_question[$member_id][$question_id] += $score;\n+                $this->_actual_marks_received_by_member_question[$marked_user_id][$question_id] += $score;\n \n-        // Record the fact this member submitted\n-        if (!in_array($member_id, $this->_actual_submitters)) {\n-          $this->_actual_submitters[] = $member_id;\n-          $this->_actual_group_submitters[$group_id][] = $member_id;\n+                $this->_actual_total_marks_awarded[$member_id] += $score;\n+                $this->_actual_total_marks_received[$marked_user_id] += $score;\n+            }\n         }\n \n-        // Re-factor the responses into more usable forms\n-        $this->_actual_responses[$group_id][$question_id][$member_id][$marked_user_id] = $score;\n-\n-        // Keep a running total of the marks\n \n-        $this->_actual_marks_awarded[$member_id][$marked_user_id] += $score;\n-        $this->_actual_marks_received[$marked_user_id][$member_id] += $score;\n+        // Now the actual responses have been recorded, we can generate the appropriate ->_calc_?? properties\n \n-        $this->_actual_marks_awarded_by_member_question[$member_id][$question_id] += $score;\n-        $this->_actual_marks_received_by_member_question[$marked_user_id][$question_id] += $score;\n+        // Get the peer-only or self-&-peer marks ready for the algorithm\n \n-        $this->_actual_total_marks_awarded[$member_id] += $score;\n-        $this->_actual_total_marks_received[$marked_user_id] += $score;\n-      }\n-    }\n+        if ($this->_peeronly) {\n+            $this->_preparePeerOnly();\n+        } else {\n+            $this->_prepareSelfPeer();\n+        }\n \n \n-    // Now the actual responses have been recorded, we can generate the appropriate ->_calc_?? properties\n+        // Remove the original responses.\n+        $this->_responses = null;\n \n-    // Get the peer-only or self-&-peer marks ready for the algorithm\n \n-    if ($this->_peeronly) {\n-      $this->_preparePeerOnly();\n-    } else {\n-      $this->_prepareSelfPeer();\n+        return true;\n     }\n \n-\n-    // Remove the original responses.\n-    $this->_responses = null;\n-\n-\n-    return true;\n-  }// /->_initialise()\n-\n-\n-\n-  /**\n-   * Prepare the ->_calc_?? properties, ready for the algorithm to process a peer-only assessment.\n-   *\n-   * @return  boolean  The operation was successful.\n-   */\n-  abstract protected function _preparePeerOnly();\n-\n-\n-\n-  /**\n-   * Prepare the ->_calc_?? properties, ready for the algorithm to process a self-&-peer assessment.\n-   *\n-   * @return  boolean  The operation was successful.\n-   */\n-  abstract protected function _prepareSelfPeer();\n-\n-\n-\n+    // /->_initialise()\n+\n+    /**\n+     * Prepare the ->_calc_?? properties, ready for the algorithm to process a peer-only assessment.\n+     *\n+     * @return  boolean  The operation was successful.\n+     */\n+    abstract protected function _preparePeerOnly();\n+\n+    /**\n+     * Prepare the ->_calc_?? properties, ready for the algorithm to process a self-&-peer assessment.\n+     *\n+     * @return  boolean  The operation was successful.\n+     */\n+    abstract protected function _prepareSelfPeer();\n }// /class\n-?>"
        },
        {
          "filename": "src/includes/classes/algorithms/PetsAlgorithm.php",
          "status": "modified",
          "additions": 223,
          "deletions": 230,
          "patch": "@@ -16,325 +16,318 @@\n // Until we have conducted a full investigation and nailed down what's happening\n // this algorithm is disabled.\n \n-class PetsAlgorithm extends Algorithm {\n-\n-  // Public Properties\n-  protected $_group_split100 = null;\n-  protected $_group_average_per_question = null;\n-\n-  /**\n-   * Constructor\n-   *\n-   * @return  object  A new instance of this class.\n-   */\n-  public function __construct() {\n-  }// /->__construct()\n-\n-/*\n-* ================================================================================\n-* Public Methods\n-* ================================================================================\n-*/\n-\n-  /**\n-   * Calculate the student's final grades.\n-   *\n-   * As well as calculating grades, this method populates many of the properties\n-   * available via the get methods.\n-   *\n-   * @return  boolean  The operation was successful.\n-   */\n-  public function calculate() {\n+class PetsAlgorithm extends Algorithm\n+{\n+    // Public Properties\n+    protected $_group_split100;\n+\n+    protected $_group_average_per_question;\n+\n+    /**\n+     * Constructor\n+     *\n+     * @return  object  A new instance of this class.\n+     */\n+    public function __construct()\n+    {\n+    }\n+\n+    // /->__construct()\n+\n+    /*\n+    * ================================================================================\n+    * Public Methods\n+    * ================================================================================\n+    */\n+\n+    /**\n+     * Calculate the student's final grades.\n+     *\n+     * As well as calculating grades, this method populates many of the properties\n+     * available via the get methods.\n+     *\n+     * @return  boolean  The operation was successful.\n+     */\n+    public function calculate()\n+    {\n \n     /* The code below has been written to try to show the individual, algorithmic steps clearly.\n      * You could probably improve the efficiency by combining loops, etc, but then the steps\n      * are more difficult to follow.\n      */\n \n-    /* (1)\n-     * Initialise the algorithm data and pre-fill most of the properties of this class.\n-     * Gets the total number of marks each member awarded, and to whom, etc.\n-     */\n+        /* (1)\n+         * Initialise the algorithm data and pre-fill most of the properties of this class.\n+         * Gets the total number of marks each member awarded, and to whom, etc.\n+         */\n \n-    $this->_initialise();\n+        $this->_initialise();\n \n-    // Take each group in turn\n-    foreach($this->_group_grades as $group_id => $group_mark) {\n+        // Take each group in turn\n+        foreach ($this->_group_grades as $group_id => $group_mark) {\n \n       /* (2)\n        * Get the multiplication factor we need to calculate the WebPA scores\n        * factor = num-members-total / num-members-submitted\n        */\n \n-      $num_members = ( (is_array($this->_group_members)) && (array_key_exists($group_id, $this->_group_members)) ) ? count($this->_group_members[$group_id]) : 0 ;\n+            $num_members = ((is_array($this->_group_members)) && (array_key_exists($group_id, $this->_group_members))) ? count($this->_group_members[$group_id]) : 0 ;\n \n-      $num_submitted = ( (is_array($this->_calc_group_submitters)) && (array_key_exists($group_id, $this->_calc_group_submitters)) ) ? count($this->_calc_group_submitters[$group_id]) : 0 ;\n+            $num_submitted = ((is_array($this->_calc_group_submitters)) && (array_key_exists($group_id, $this->_calc_group_submitters))) ? count($this->_calc_group_submitters[$group_id]) : 0 ;\n \n-      $multi_factor = ($num_submitted>0) ? ($num_members / $num_submitted) : 1 ;\n+            $multi_factor = ($num_submitted>0) ? ($num_members / $num_submitted) : 1 ;\n \n-      $pa_group_mark = ($this->_params['weighting']/100) * $group_mark;\n-      $nonpa_group_mark = ( (100-$this->_params['weighting']) /100 ) * $group_mark;\n+            $pa_group_mark = ($this->_params['weighting']/100) * $group_mark;\n+            $nonpa_group_mark = ((100-$this->_params['weighting']) /100) * $group_mark;\n \n-      if (array_key_exists($group_id, $this->_group_members)) {\n-        $q_count = count($this->_questions);\n+            if (array_key_exists($group_id, $this->_group_members)) {\n+                $q_count = count($this->_questions);\n \n-        foreach($this->_group_members[$group_id] as $i => $member_id) {\n+                foreach ($this->_group_members[$group_id] as $i => $member_id) {\n+                    $total_score = $this->_calc_total_marks_received[$member_id];\n \n-          $total_score = $this->_calc_total_marks_received[$member_id];\n+                    /* (3)\n+                     * Get the WebPA score = (total received by a member / average total score if all students equal ) * multiplication-factor\n+                     */\n \n-          /* (3)\n-           * Get the WebPA score = (total received by a member / average total score if all students equal ) * multiplication-factor\n-           */\n+                    $avg_total = $this->_group_split100[$group_id] * $q_count;\n \n-          $avg_total = $this->_group_split100[$group_id] * $q_count;\n+                    $this->_webpa_scores[$member_id] = ($total_score / $avg_total) * $multi_factor;\n \n-          $this->_webpa_scores[$member_id] = ( $total_score / $avg_total) * $multi_factor;\n+                    /* (4)\n+                     * Get the member's intermediate grade = WebPA score * weighted-group-mark   (does not include penalties)\n+                     */\n \n-          /* (4)\n-           * Get the member's intermediate grade = WebPA score * weighted-group-mark   (does not include penalties)\n-           */\n+                    if (is_array($this->_calc_group_submitters[$group_id])) {\n+                        $intermediate_grade = (($this->_webpa_scores[$member_id] * $pa_group_mark) + $nonpa_group_mark);\n+                    } else {\n+                        $intermediate_grade = $pa_group_mark + $nonpa_group_mark;\n+                    }\n \n-          if (is_array($this->_calc_group_submitters[$group_id])) {\n-            $intermediate_grade = (($this->_webpa_scores[$member_id] * $pa_group_mark) + $nonpa_group_mark);\n-          } else {\n-            $intermediate_grade = $pa_group_mark + $nonpa_group_mark;\n-          }\n+                    if ($intermediate_grade<0) {\n+                        $intermediate_grade = 0;\n+                    } elseif ($intermediate_grade>100) {\n+                        $intermediate_grade = 100;\n+                    }\n \n-          if ($intermediate_grade<0) {\n-            $intermediate_grade = 0;\n-          } else if ($intermediate_grade>100) {\n-            $intermediate_grade = 100;\n-          }\n+                    // Intermediate grades are whatever the algorithm thought the grade should be (before penalties)\n+                    $this->_intermediate_grades[$member_id] = $intermediate_grade;\n \n-          // Intermediate grades are whatever the algorithm thought the grade should be (before penalties)\n-          $this->_intermediate_grades[$member_id] = $intermediate_grade;\n+                    /* (5)\n+                     * Get the member's actual grade\n+                     *\n+                     * At this point, final grades are the same as intermediate grades (penalties are applied at the end)\n+                     */\n \n-          /* (5)\n-           * Get the member's actual grade\n-           *\n-           * At this point, final grades are the same as intermediate grades (penalties are applied at the end)\n-           */\n+                    $this->_grades[$member_id] = $intermediate_grade;\n+                }// /foreach(member)\n+            }// /if(are members)\n+        }// /foreach(group)\n \n-          $this->_grades[$member_id] = $intermediate_grade;\n+        /* (6)\n+         * Apply any penalties\n+         */\n+        $this->_applyPenalties();\n \n-        }// /foreach(member)\n+        /*(9)\n+         * Make sure the grades conform to the requested grading style (% or A-F)\n+         */\n+        $this->_applyGradingStyle();\n \n-      }// /if(are members)\n+        return true;\n+    }\n \n-    }// /foreach(group)\n+    // /->calculate()\n \n-    /* (6)\n-     * Apply any penalties\n-     */\n-    $this->_applyPenalties();\n+    /*\n+    * ================================================================================\n+    * Private Methods\n+    * ================================================================================\n+    */\n \n-    /*(9)\n-     * Make sure the grades conform to the requested grading style (% or A-F)\n+    /**\n+     * Convert the responses from likert-scale types to split100 types.\n+     *\n+     * @return  boolean  The operation was successful.\n      */\n-    $this->_applyGradingStyle();\n-\n-    return true;\n-  }// /->calculate()\n-\n-/*\n-* ================================================================================\n-* Private Methods\n-* ================================================================================\n-*/\n-\n-  /**\n-   * Convert the responses from likert-scale types to split100 types.\n-   *\n-   * @return  boolean  The operation was successful.\n-   */\n-  protected function _convertFromLikert() {\n+    protected function _convertFromLikert()\n+    {\n \n     // If the form was using likert criteria questions, convert them to split100 style.\n-    // Convert the ->_calc_responses to a likert scale\n-    if ($this->_form_type=='likert') {\n+        // Convert the ->_calc_responses to a likert scale\n+        if ($this->_form_type=='likert') {\n \n       // The form-type was likert, and we need to convert the scores accordingly.\n-      // Each split100 score = (group-average-total / total-marks-awarded-for-question-by-student) * likert-score\n-\n-      foreach ($this->_responses as $i => $response) {\n-        $group_id = $response['group_id'];\n-        $member_id = $response['user_id'];\n-        $marked_user_id = $response['marked_user_id'];\n-        $question_id = $response['question_id'];\n-        $likert_score = (float) $response['score'];\n+            // Each split100 score = (group-average-total / total-marks-awarded-for-question-by-student) * likert-score\n \n-        // Calculate Split100 score from Likert score\n-        $total_awarded = $this->_actual_marks_awarded_by_member_question[$member_id][$question_id];\n+            foreach ($this->_responses as $i => $response) {\n+                $group_id = $response['group_id'];\n+                $member_id = $response['user_id'];\n+                $marked_user_id = $response['marked_user_id'];\n+                $question_id = $response['question_id'];\n+                $likert_score = (float) $response['score'];\n \n-        $proportional_score = ( $likert_score / $total_awarded );\n+                // Calculate Split100 score from Likert score\n+                $total_awarded = $this->_actual_marks_awarded_by_member_question[$member_id][$question_id];\n \n-        $score =  $proportional_score * $this->_group_split100[$group_id];\n+                $proportional_score = ($likert_score / $total_awarded);\n \n-        // Ensure future calculations use the converted score\n-        $this->_calc_responses[$group_id][$question_id][$member_id][$marked_user_id] = $score;\n+                $score =  $proportional_score * $this->_group_split100[$group_id];\n \n-      }// /foreach(response)\n+                // Ensure future calculations use the converted score\n+                $this->_calc_responses[$group_id][$question_id][$member_id][$marked_user_id] = $score;\n+            }// /foreach(response)\n+        }// /if(likert questions)\n \n-    }// /if(likert questions)\n+        return true;\n+    }\n \n-    return true;\n-  }// ->_convertFromLikert()\n+    // ->_convertFromLikert()\n \n-  /**\n-   * Prepare the ->_calc_?? properties, ready for the algorithm to process a peer-only assessment.\n-   *\n-   * @return  boolean  The operation was successful.\n-   */\n-  protected function _preparePeerOnly() {\n+    /**\n+     * Prepare the ->_calc_?? properties, ready for the algorithm to process a peer-only assessment.\n+     *\n+     * @return  boolean  The operation was successful.\n+     */\n+    protected function _preparePeerOnly()\n+    {\n \n     // Get the number of marks available in each question.\n-    foreach ($this->_group_names as $group_id => $group_name) {\n-      $member_count = count($this->_group_members[$group_id]) - 1;\n-      $this->_group_split100[$group_id] = (100-(100 % $member_count));\n-      $this->_group_average_per_question[$group_id] = $this->_group_split100[$group_id] / $member_count;\n-    }\n+        foreach ($this->_group_names as $group_id => $group_name) {\n+            $member_count = count($this->_group_members[$group_id]) - 1;\n+            $this->_group_split100[$group_id] = (100-(100 % $member_count));\n+            $this->_group_average_per_question[$group_id] = $this->_group_split100[$group_id] / $member_count;\n+        }\n \n-    // Convert likert marks to split100 marks (if required)\n-    $this->_convertFromLikert();\n+        // Convert likert marks to split100 marks (if required)\n+        $this->_convertFromLikert();\n \n-    // Process all the student responses\n-    // Set the correct values for the actual marks awarded, received, etc\n+        // Process all the student responses\n+        // Set the correct values for the actual marks awarded, received, etc\n \n-    foreach ($this->_group_grades as $group_id => $group_mark) {\n+        foreach ($this->_group_grades as $group_id => $group_mark) {\n \n       // The score every member receives if their performance is equal\n-      $avg_score = $this->_group_average_per_question[$group_id];\n+            $avg_score = $this->_group_average_per_question[$group_id];\n \n-      $num_members = count($this->_group_members[$group_id]);\n+            $num_members = count($this->_group_members[$group_id]);\n \n-      foreach ($this->_group_members[$group_id] as $i => $member_id) {\n+            foreach ($this->_group_members[$group_id] as $i => $member_id) {\n \n         // For the calculations, record everyone as submitting regardless of whether they did or not\n-        $this->_calc_submitters[] = $member_id;\n-        $this->_calc_group_submitters[$group_id][] = $member_id;\n-\n-        foreach ($this->_questions as $i => $question_id) {\n+                $this->_calc_submitters[] = $member_id;\n+                $this->_calc_group_submitters[$group_id][] = $member_id;\n \n-          foreach ($this->_group_members[$group_id] as $k => $marked_user_id) {\n-\n-            if ($member_id!=$marked_user_id) {\n+                foreach ($this->_questions as $i => $question_id) {\n+                    foreach ($this->_group_members[$group_id] as $k => $marked_user_id) {\n+                        if ($member_id!=$marked_user_id) {\n \n               // If the student did not submit..\n-              if (!in_array($member_id, $this->_actual_submitters)) {\n+                            if (!in_array($member_id, $this->_actual_submitters)) {\n \n                 // Fake the response using the avg score / question\n-                $score = $avg_score;\n-                $this->_calc_responses[$group_id][$question_id][$member_id][$marked_user_id] = $score;\n-\n-              } else {\n+                                $score = $avg_score;\n+                                $this->_calc_responses[$group_id][$question_id][$member_id][$marked_user_id] = $score;\n+                            } else {\n \n                 // Get the score the student submitted\n-                $selfpeer_score = $this->_calc_responses[$group_id][$question_id][$member_id][$marked_user_id];\n-\n-                // Get the total marks awarded per question\n-\n-                $total_awarded_peeronly = $this->_group_split100[$group_id];\n-\n-                // If there's a self mark, we need to subtract it to get the total peer-only marks awarded per question\n-                if (array_key_exists($member_id, $this->_calc_responses[$group_id][$question_id][$member_id])) {\n-                  $total_awarded_peeronly -= $this->_calc_responses[$group_id][$question_id][$member_id][$member_id];\n-                }\n-\n-                // Adjusted for peeronly score\n-                $score = $selfpeer_score / ( $total_awarded_peeronly / ( $num_members - 1) ) * $this->_group_average_per_question[$group_id];\n+                                $selfpeer_score = $this->_calc_responses[$group_id][$question_id][$member_id][$marked_user_id];\n \n-              }// /if-else(student did submit)\n+                                // Get the total marks awarded per question\n \n-              $this->_calc_marks_awarded[$member_id][$marked_user_id] += $score;\n-              $this->_calc_marks_received[$marked_user_id][$member_id] += $score;\n+                                $total_awarded_peeronly = $this->_group_split100[$group_id];\n \n-              $this->_calc_marks_awarded_by_member_question[$member_id][$question_id] += $score;\n-              $this->_calc_marks_received_by_member_question[$marked_user_id][$question_id] += $score;\n+                                // If there's a self mark, we need to subtract it to get the total peer-only marks awarded per question\n+                                if (array_key_exists($member_id, $this->_calc_responses[$group_id][$question_id][$member_id])) {\n+                                    $total_awarded_peeronly -= $this->_calc_responses[$group_id][$question_id][$member_id][$member_id];\n+                                }\n \n-              $this->_calc_total_marks_awarded[$member_id] += $score;\n-              $this->_calc_total_marks_received[$marked_user_id] += $score;\n+                                // Adjusted for peeronly score\n+                                $score = $selfpeer_score / ($total_awarded_peeronly / ($num_members - 1)) * $this->_group_average_per_question[$group_id];\n+                            }// /if-else(student did submit)\n \n-            }// /if(not awarded to self)\n+                            $this->_calc_marks_awarded[$member_id][$marked_user_id] += $score;\n+                            $this->_calc_marks_received[$marked_user_id][$member_id] += $score;\n \n-          }// /foreach(marked member)\n+                            $this->_calc_marks_awarded_by_member_question[$member_id][$question_id] += $score;\n+                            $this->_calc_marks_received_by_member_question[$marked_user_id][$question_id] += $score;\n \n-        }// /foreach(question)\n+                            $this->_calc_total_marks_awarded[$member_id] += $score;\n+                            $this->_calc_total_marks_received[$marked_user_id] += $score;\n+                        }// /if(not awarded to self)\n+                    }// /foreach(marked member)\n+                }// /foreach(question)\n+            }// /foreach(member)\n+        }// /foreach(group)\n \n-      }// /foreach(member)\n+        return true;\n \n-    }// /foreach(group)\n-\n-    return true;\n-\n-    // @todo: if there's a non-submission, fake the scores using avg / q\n+        // @todo: if there's a non-submission, fake the scores using avg / q\n     // score = ( old-score / (total_marks_awarded_in_peeronly / num_members - 1) ) * peer_only_avg_per_question\n+    }\n \n-  }// /->_preparePeerOnly()\n+    // /->_preparePeerOnly()\n \n-  /**\n-   * Prepare the ->_calc_?? properties, ready for the algorithm to process a self-&-peer assessment.\n-   *\n-   * @return  boolean  The operation was successful.\n-   */\n-  protected function _prepareSelfPeer() {\n+    /**\n+     * Prepare the ->_calc_?? properties, ready for the algorithm to process a self-&-peer assessment.\n+     *\n+     * @return  boolean  The operation was successful.\n+     */\n+    protected function _prepareSelfPeer()\n+    {\n \n     // Get the number of marks available in each question.\n-    foreach ($this->_group_names as $group_id => $group_name) {\n-      $member_count = count($this->_group_members[$group_id]);\n-      $this->_group_split100[$group_id] = (100-(100 % $member_count));\n-      $this->_group_average_per_question[$group_id] = $this->_group_split100[$group_id] / $member_count;\n-    }\n+        foreach ($this->_group_names as $group_id => $group_name) {\n+            $member_count = count($this->_group_members[$group_id]);\n+            $this->_group_split100[$group_id] = (100-(100 % $member_count));\n+            $this->_group_average_per_question[$group_id] = $this->_group_split100[$group_id] / $member_count;\n+        }\n \n-    // Convert likert marks to split100 marks (if required)\n-    $this->_convertFromLikert();\n+        // Convert likert marks to split100 marks (if required)\n+        $this->_convertFromLikert();\n \n-    // Process all the student responses\n-    // Set the correct values for the actual marks awarded, received, etc\n+        // Process all the student responses\n+        // Set the correct values for the actual marks awarded, received, etc\n \n-    foreach ($this->_group_grades as $group_id => $group_mark) {\n+        foreach ($this->_group_grades as $group_id => $group_mark) {\n \n       // The score every member receives if their performance is equal\n-      $avg_score = $this->_group_average_per_question[$group_id];\n+            $avg_score = $this->_group_average_per_question[$group_id];\n \n-      foreach ($this->_group_members[$group_id] as $i => $member_id) {\n+            foreach ($this->_group_members[$group_id] as $i => $member_id) {\n \n         // For the calculations, record everyone as submitting regardless of whether they did or not\n-        $this->_calc_submitters[] = $member_id;\n-        $this->_calc_group_submitters[$group_id][] = $member_id;\n+                $this->_calc_submitters[] = $member_id;\n+                $this->_calc_group_submitters[$group_id][] = $member_id;\n \n-        foreach ($this->_questions as $i => $question_id) {\n-\n-          foreach ($this->_group_members[$group_id] as $k => $marked_user_id) {\n+                foreach ($this->_questions as $i => $question_id) {\n+                    foreach ($this->_group_members[$group_id] as $k => $marked_user_id) {\n \n             // If the student did not submit..\n-            if (!in_array($member_id, $this->_actual_submitters)) {\n-              // Fake the response using the avg score / question\n-              $score = $avg_score;\n-              $this->_calc_responses[$group_id][$question_id][$member_id][$marked_user_id] = $score;\n-            } else {\n-              // Use the score the student submitted\n-              $score = $this->_calc_responses[$group_id][$question_id][$member_id][$marked_user_id];\n-            }\n-\n-            $this->_calc_marks_awarded[$member_id][$marked_user_id] += $score;\n-            $this->_calc_marks_received[$marked_user_id][$member_id] += $score;\n-\n-            $this->_calc_marks_awarded_by_member_question[$member_id][$question_id] += $score;\n-            $this->_calc_marks_received_by_member_question[$marked_user_id][$question_id] += $score;\n-\n-            $this->_calc_total_marks_awarded[$member_id] += $score;\n-            $this->_calc_total_marks_received[$marked_user_id] += $score;\n-\n-          }// /foreach(marked member)\n-\n-        }// /foreach(question)\n-\n-      }// /foreach(member)\n-\n-    }// /foreach(group)\n-\n-    return true;\n-  }// /->_prepareSelfPeer()\n+                        if (!in_array($member_id, $this->_actual_submitters)) {\n+                            // Fake the response using the avg score / question\n+                            $score = $avg_score;\n+                            $this->_calc_responses[$group_id][$question_id][$member_id][$marked_user_id] = $score;\n+                        } else {\n+                            // Use the score the student submitted\n+                            $score = $this->_calc_responses[$group_id][$question_id][$member_id][$marked_user_id];\n+                        }\n+\n+                        $this->_calc_marks_awarded[$member_id][$marked_user_id] += $score;\n+                        $this->_calc_marks_received[$marked_user_id][$member_id] += $score;\n+\n+                        $this->_calc_marks_awarded_by_member_question[$member_id][$question_id] += $score;\n+                        $this->_calc_marks_received_by_member_question[$marked_user_id][$question_id] += $score;\n+\n+                        $this->_calc_total_marks_awarded[$member_id] += $score;\n+                        $this->_calc_total_marks_received[$marked_user_id] += $score;\n+                    }// /foreach(marked member)\n+                }// /foreach(question)\n+            }// /foreach(member)\n+        }// /foreach(group)\n+\n+        return true;\n+    }\n \n+    // /->_prepareSelfPeer()\n }// /class\n-?>"
        },
        {
          "filename": "src/includes/classes/algorithms/WebPAAlgorithm.php",
          "status": "modified",
          "additions": 199,
          "deletions": 214,
          "patch": "@@ -12,37 +12,37 @@\n \n namespace WebPA\\includes\\classes\\algorithms;\n \n-class WebPAAlgorithm extends Algorithm {\n-\n-\n-\n-  /**\n-   * Constructor\n-   *\n-   * @return  object  A new instance of this class.\n-   */\n-  public function __construct() {\n-  }// /->__construct()\n-\n-\n+class WebPAAlgorithm extends Algorithm\n+{\n+    /**\n+     * Constructor\n+     *\n+     * @return  object  A new instance of this class.\n+     */\n+    public function __construct()\n+    {\n+    }\n \n-/*\n-* ================================================================================\n-* Public Methods\n-* ================================================================================\n-*/\n+    // /->__construct()\n \n \n \n-  /**\n-   * Calculate the student's final grades.\n-   *\n-   * As well as calculating grades, this method populates many of the properties\n-   * available via the get methods.\n-   *\n-   * @return  boolean  The operation was successful.\n-   */\n-  public function calculate() {\n+    /*\n+    * ================================================================================\n+    * Public Methods\n+    * ================================================================================\n+    */\n+\n+    /**\n+     * Calculate the student's final grades.\n+     *\n+     * As well as calculating grades, this method populates many of the properties\n+     * available via the get methods.\n+     *\n+     * @return  boolean  The operation was successful.\n+     */\n+    public function calculate()\n+    {\n \n \n     /*\n@@ -52,264 +52,249 @@ public function calculate() {\n      */\n \n \n-    /* (1)\n-     * Initialise the algorithm data and pre-fill most of the properties of this class.\n-     * Gets the total number of marks each member awarded, and to whom, etc.\n-     */\n-\n-    $this->_initialise();\n+        /* (1)\n+         * Initialise the algorithm data and pre-fill most of the properties of this class.\n+         * Gets the total number of marks each member awarded, and to whom, etc.\n+         */\n \n+        $this->_initialise();\n \n-    // Take each group in turn\n-    foreach($this->_group_grades as $group_id => $group_mark) {\n \n-      $group_member_frac_scores_awarded[$group_id] = array();\n-      $group_member_total_received[$group_id] =  array();\n+        // Take each group in turn\n+        foreach ($this->_group_grades as $group_id => $group_mark) {\n+            $group_member_frac_scores_awarded[$group_id] = [];\n+            $group_member_total_received[$group_id] =  [];\n \n-      // Take each member in turn\n-      foreach($this->_group_members[$group_id] as $i => $member_id) {\n+            // Take each member in turn\n+            foreach ($this->_group_members[$group_id] as $i => $member_id) {\n \n         // Initialise each member's total fractional score\n-        $group_member_total_received[$group_id][$member_id] = 0;\n+                $group_member_total_received[$group_id][$member_id] = 0;\n \n-        // If the member submitted a response, then we need to normalise the scores awarded\n-        if (in_array($member_id, $this->_calc_submitters)) {\n+                // If the member submitted a response, then we need to normalise the scores awarded\n+                if (in_array($member_id, $this->_calc_submitters)) {\n \n           /* (2)\n            * Get the normalised fraction awarded by each member to each member\n            * If member-A gave member-B 4 marks, then the fraction awarded = 4 / total-marks-member-A-awarded\n            */\n \n-          // If the member gave more than 0 marks in total, calculate the fraction awarded\n-          if ($this->_calc_total_marks_awarded[$member_id]>0) {\n-\n-            foreach($this->_questions as $i => $question_id) {\n-\n-              foreach($this->_calc_responses[$group_id][$question_id][$member_id] as $marked_user_id => $score) {\n-                $group_member_frac_scores_awarded[$group_id][$member_id][$question_id][$marked_user_id] = $score / $this->_calc_total_marks_awarded[$member_id];\n-              }// /foreach(member-response)\n-\n-            }// /foreach(question)\n+                    // If the member gave more than 0 marks in total, calculate the fraction awarded\n+                    if ($this->_calc_total_marks_awarded[$member_id]>0) {\n+                        foreach ($this->_questions as $i => $question_id) {\n+                            foreach ($this->_calc_responses[$group_id][$question_id][$member_id] as $marked_user_id => $score) {\n+                                $group_member_frac_scores_awarded[$group_id][$member_id][$question_id][$marked_user_id] = $score / $this->_calc_total_marks_awarded[$member_id];\n+                            }// /foreach(member-response)\n+                        }// /foreach(question)\n+                    }// /if(member-total-award==0)\n+                }// /if(member-submitted)\n+            }// /foreach(member)\n \n-          }// /if(member-total-award==0)\n \n-        }// /if(member-submitted)\n+            // All the scores are now normalised. Time to calculate the actual Web-PA scores\n \n-      }// /foreach(member)\n \n+            /* (3)\n+             * Get the multiplication factor we need to calculate the Web-PA scores\n+             * factor = num-members-total / num-members-submitted\n+             */\n \n-      // All the scores are now normalised. Time to calculate the actual Web-PA scores\n+            $num_members = ((is_array($this->_group_members)) && (array_key_exists($group_id, $this->_group_members))) ? count($this->_group_members[$group_id]) : 0 ;\n+            $num_submitted = (array_key_exists($group_id, $this->_calc_group_submitters)) ? count($this->_calc_group_submitters[$group_id]) : 0 ;\n \n+            $multi_factor = ($num_submitted>0) ? ($num_members / $num_submitted) : 1 ;\n \n-      /* (3)\n-       * Get the multiplication factor we need to calculate the Web-PA scores\n-       * factor = num-members-total / num-members-submitted\n-       */\n \n-      $num_members = ( (is_array($this->_group_members)) && (array_key_exists($group_id, $this->_group_members)) ) ? count($this->_group_members[$group_id]) : 0 ;\n-      $num_submitted = (array_key_exists($group_id, $this->_calc_group_submitters)) ? count($this->_calc_group_submitters[$group_id]) : 0 ;\n+            $pa_group_mark = ($this->_params['weighting']/100) * $group_mark;\n+            $nonpa_group_mark = ((100-$this->_params['weighting']) /100) * $group_mark;\n \n-      $multi_factor = ($num_submitted>0) ? ($num_members / $num_submitted) : 1 ;\n \n \n-      $pa_group_mark = ($this->_params['weighting']/100) * $group_mark;\n-      $nonpa_group_mark = ( (100-$this->_params['weighting']) /100 ) * $group_mark;\n+            // @todo : apply criterion weightings here (empty method at present)\n+            $this->_applyCriterionWeightings();\n \n \n \n-      // @todo : apply criterion weightings here (empty method at present)\n-      $this->_applyCriterionWeightings();\n-\n-\n-\n-      /* (4)\n-       * Get the total fractional score awarded to each member for each question\n-       */\n-\n-      foreach($group_member_frac_scores_awarded[$group_id] as $member_id => $q_array) {\n-        foreach($q_array as $question_id => $marked_array) {\n-          foreach($marked_array as $marked_user_id => $frac_score) {\n-            $group_member_total_received[$group_id][$marked_user_id] += $frac_score;\n-          }\n-        }\n-      }\n+            /* (4)\n+             * Get the total fractional score awarded to each member for each question\n+             */\n \n+            foreach ($group_member_frac_scores_awarded[$group_id] as $member_id => $q_array) {\n+                foreach ($q_array as $question_id => $marked_array) {\n+                    foreach ($marked_array as $marked_user_id => $frac_score) {\n+                        $group_member_total_received[$group_id][$marked_user_id] += $frac_score;\n+                    }\n+                }\n+            }\n \n-      if (array_key_exists($group_id, $group_member_total_received)) {\n \n-        foreach($group_member_total_received[$group_id] as $member_id => $total_frac_score) {\n+            if (array_key_exists($group_id, $group_member_total_received)) {\n+                foreach ($group_member_total_received[$group_id] as $member_id => $total_frac_score) {\n \n \n           /* (5)\n            * Get the Web-PA score = total fractional score awarded to a member * multiplication-factor\n            */\n-          $this->_webpa_scores[$member_id] = $total_frac_score * $multi_factor;\n-\n-\n-          /* (6)\n-           * Get the member's intermediate grade = Web-PA score * weighted-group-mark   (does not include penalties)\n-           */\n-          if (is_array($this->_calc_group_submitters[$group_id])) {\n-            $intermediate_grade = (($total_frac_score * $multi_factor * $pa_group_mark) + $nonpa_group_mark);\n-          } else {\n-            $intermediate_grade = $pa_group_mark + $nonpa_group_mark;\n-          }\n-\n-          if ($intermediate_grade<0) { $intermediate_grade = 0; }\n-          elseif ($intermediate_grade>100) { $intermediate_grade = 100; }\n-\n-          // Intermediate grades are whatever the algorithm thought the grade should be (before penalties)\n-          $this->_intermediate_grades[$member_id] = $intermediate_grade;\n-\n-          /* (7)\n-           * Get the member's actual grade\n-           *\n-           * At this point, final grades are the same as intermediate grades (penalties are applied at the end)\n-           */\n-\n-          $this->_grades[$member_id] = $intermediate_grade;\n-\n-        }\n-      }\n-    }// /foreach(group)\n-\n-\n-    /* (8)\n-     * Apply any penalties\n-     */\n-    $this->_applyPenalties();\n+                    $this->_webpa_scores[$member_id] = $total_frac_score * $multi_factor;\n+\n+\n+                    /* (6)\n+                     * Get the member's intermediate grade = Web-PA score * weighted-group-mark   (does not include penalties)\n+                     */\n+                    if (is_array($this->_calc_group_submitters) && array_key_exists($group_id, $this->_calc_group_submitters)) {\n+                        $intermediate_grade = (($total_frac_score * $multi_factor * $pa_group_mark) + $nonpa_group_mark);\n+                    } else {\n+                        $intermediate_grade = $pa_group_mark + $nonpa_group_mark;\n+                    }\n+\n+                    if ($intermediate_grade<0) {\n+                        $intermediate_grade = 0;\n+                    } elseif ($intermediate_grade>100) {\n+                        $intermediate_grade = 100;\n+                    }\n+\n+                    // Intermediate grades are whatever the algorithm thought the grade should be (before penalties)\n+                    $this->_intermediate_grades[$member_id] = $intermediate_grade;\n+\n+                    /* (7)\n+                     * Get the member's actual grade\n+                     *\n+                     * At this point, final grades are the same as intermediate grades (penalties are applied at the end)\n+                     */\n+\n+                    $this->_grades[$member_id] = $intermediate_grade;\n+                }\n+            }\n+        }// /foreach(group)\n \n \n-    /*(9)\n-     * Make sure the grades conform to the requested grading style (% or A-F)\n-     */\n-    $this->_applyGradingStyle();\n+        /* (8)\n+         * Apply any penalties\n+         */\n+        $this->_applyPenalties();\n \n \n-    return true;\n-  }// /->calculate()\n+        /*(9)\n+         * Make sure the grades conform to the requested grading style (% or A-F)\n+         */\n+        $this->_applyGradingStyle();\n \n \n+        return true;\n+    }\n \n-/*\n-* ================================================================================\n-* Private Methods\n-* ================================================================================\n-*/\n+    // /->calculate()\n \n \n \n-  /**\n-   * Prepare the ->_calc_?? properties, ready for the algorithm to process a peer-only assessment.\n-   *\n-   * @return  boolean  The operation was successful.\n-   */\n-  protected function _preparePeerOnly() {\n+    /*\n+    * ================================================================================\n+    * Private Methods\n+    * ================================================================================\n+    */\n+\n+    /**\n+     * Prepare the ->_calc_?? properties, ready for the algorithm to process a peer-only assessment.\n+     *\n+     * @return  boolean  The operation was successful.\n+     */\n+    protected function _preparePeerOnly()\n+    {\n \n     // Set the initial state of all the calc_?? properties\n-    $this->_calc_responses = $this->_actual_responses;\n-\n-    $this->_calc_group_submitters = $this->_actual_group_submitters;\n-    $this->_calc_submitters = $this->_actual_submitters;\n+        $this->_calc_responses = $this->_actual_responses;\n \n-    $this->_calc_marks_awarded = $this->_actual_marks_awarded;\n-    $this->_calc_marks_received = $this->_actual_marks_received;\n+        $this->_calc_group_submitters = $this->_actual_group_submitters;\n+        $this->_calc_submitters = $this->_actual_submitters;\n \n-    $this->_calc_marks_awarded_by_member_question = $this->_actual_marks_awarded_by_member_question;\n-    $this->_calc_marks_received_by_member_question = $this->_actual_marks_received_by_member_question;\n+        $this->_calc_marks_awarded = $this->_actual_marks_awarded;\n+        $this->_calc_marks_received = $this->_actual_marks_received;\n \n-    $this->_calc_total_marks_awarded = $this->_actual_total_marks_awarded;\n-    $this->_calc_total_marks_received = $this->_actual_total_marks_received;\n+        $this->_calc_marks_awarded_by_member_question = $this->_actual_marks_awarded_by_member_question;\n+        $this->_calc_marks_received_by_member_question = $this->_actual_marks_received_by_member_question;\n \n+        $this->_calc_total_marks_awarded = $this->_actual_total_marks_awarded;\n+        $this->_calc_total_marks_received = $this->_actual_total_marks_received;\n \n \n-    // This is the score each student will receive if someone in their group does not submit.\n-    // It must be greater than 0, but as everyone will receive the same score, the actual value doesn't matter.\n-    $score = 5;\n \n+        // This is the score each student will receive if someone in their group does not submit.\n+        // It must be greater than 0, but as everyone will receive the same score, the actual value doesn't matter.\n+        $score = 5;\n \n-    // Flag if we find anyone who has submitted self-assessment marks\n-    $self_assessment = false;\n \n+        // Flag if we find anyone who has submitted self-assessment marks\n+        $self_assessment = false;\n \n-    foreach($this->_group_names as $group_id => $group_name) {\n \n-      $num_members = count($this->_group_members[$group_id]);\n-      $num_submitted = (array_key_exists($group_id, $this->_calc_group_submitters)) ? count($this->_calc_group_submitters[$group_id]) : 0 ;\n+        foreach ($this->_group_names as $group_id => $group_name) {\n+            $num_members = count($this->_group_members[$group_id]);\n+            $num_submitted = (array_key_exists($group_id, $this->_calc_group_submitters)) ? count($this->_calc_group_submitters[$group_id]) : 0 ;\n \n-      // If someone didn't submit..\n-      if ($num_members>$num_submitted) {\n+            // If someone didn't submit..\n+            if ($num_members>$num_submitted) {\n \n         // We have a non-submission.  We need to fake the submission data to avoid penalising students who did submit.\n-        // Faking the submission in this way means the algorithm can run normally.\n-\n-        foreach($this->_group_members[$group_id] as $j => $member_id) {\n+                // Faking the submission in this way means the algorithm can run normally.\n \n-          if (!in_array($member_id, $this->_calc_submitters)) {\n-            $this->_calc_submitters[] = \"$member_id\";\n-            $this->_calc_group_submitters[$group_id][] = \"$member_id\";\n+                foreach ($this->_group_members[$group_id] as $j => $member_id) {\n+                    if (!in_array($member_id, $this->_calc_submitters)) {\n+                        $this->_calc_submitters[] = \"$member_id\";\n+                        $this->_calc_group_submitters[$group_id][] = \"$member_id\";\n \n-            foreach($this->_questions as $i => $question_id) {\n-\n-              foreach($this->_group_members[$group_id] as $k => $marked_user_id) {\n+                        foreach ($this->_questions as $i => $question_id) {\n+                            foreach ($this->_group_members[$group_id] as $k => $marked_user_id) {\n \n                 // If it's not a self-mark, add it to the list\n-                if ($member_id != $marked_user_id) {\n-                  $this->_calc_responses[$group_id][$question_id][$member_id][$marked_user_id] = $score;\n-\n-                  $this->_calc_marks_awarded[$member_id][$marked_user_id] += $score;\n-                  $this->_calc_marks_received[$marked_user_id][$member_id] += $score;\n-\n-                  $this->_calc_marks_awarded_by_member_question[$member_id][$question_id] += $score;\n-                  $this->_calc_marks_received_by_member_question[$marked_user_id][$question_id] += $score;\n-\n-                  $this->_calc_total_marks_awarded[$member_id] += $score;\n-                  $this->_calc_total_marks_received[$marked_user_id] += $score;\n-                }\n-\n-              }// /foreach(group member)\n-\n-            }// /foreach(question)\n-\n-          }// /if(non-submitter)\n-\n-        }// /foreach(group member)\n-\n-      }// /if(non-submissions)\n-\n-    }// /foreach(group)\n-\n-    return true;\n-  }// /->_preparePeerOnly()\n-\n-\n-\n-  /**\n-   * Prepare the ->_calc_?? properties, ready for the algorithm to process a self-&-peer assessment.\n-   *\n-   * @return  boolean  The operation was successful.\n-   */\n-  protected function _prepareSelfPeer() {\n+                                if ($member_id != $marked_user_id) {\n+                                    $this->_calc_responses[$group_id][$question_id][$member_id][$marked_user_id] = $score;\n+\n+                                    $this->_calc_marks_awarded[$member_id][$marked_user_id] += $score;\n+                                    $this->_calc_marks_received[$marked_user_id][$member_id] += $score;\n+\n+                                    $this->_calc_marks_awarded_by_member_question[$member_id][$question_id] += $score;\n+                                    $this->_calc_marks_received_by_member_question[$marked_user_id][$question_id] += $score;\n+\n+                                    $this->_calc_total_marks_awarded[$member_id] += $score;\n+                                    $this->_calc_total_marks_received[$marked_user_id] += $score;\n+                                }\n+                            }// /foreach(group member)\n+                        }// /foreach(question)\n+                    }// /if(non-submitter)\n+                }// /foreach(group member)\n+            }// /if(non-submissions)\n+        }// /foreach(group)\n+\n+        return true;\n+    }\n+\n+    // /->_preparePeerOnly()\n+\n+    /**\n+     * Prepare the ->_calc_?? properties, ready for the algorithm to process a self-&-peer assessment.\n+     *\n+     * @return  boolean  The operation was successful.\n+     */\n+    protected function _prepareSelfPeer()\n+    {\n \n     // Set the initial state of all the calc_?? properties\n-    $this->_calc_responses = $this->_actual_responses;\n-\n-    $this->_calc_group_submitters = $this->_actual_group_submitters;\n-    $this->_calc_submitters = $this->_actual_submitters;\n-\n-    $this->_calc_marks_awarded = $this->_actual_marks_awarded;\n-    $this->_calc_marks_received = $this->_actual_marks_received;\n+        $this->_calc_responses = $this->_actual_responses;\n \n-    $this->_calc_marks_awarded_by_member_question = $this->_actual_marks_awarded_by_member_question;\n-    $this->_calc_marks_received_by_member_question = $this->_actual_marks_received_by_member_question;\n+        $this->_calc_group_submitters = $this->_actual_group_submitters;\n+        $this->_calc_submitters = $this->_actual_submitters;\n \n-    $this->_calc_total_marks_awarded = $this->_actual_total_marks_awarded;\n-    $this->_calc_total_marks_received = $this->_actual_total_marks_received;\n+        $this->_calc_marks_awarded = $this->_actual_marks_awarded;\n+        $this->_calc_marks_received = $this->_actual_marks_received;\n \n-    return true;\n-  }// /->_prepareSelfPeer()\n+        $this->_calc_marks_awarded_by_member_question = $this->_actual_marks_awarded_by_member_question;\n+        $this->_calc_marks_received_by_member_question = $this->_actual_marks_received_by_member_question;\n \n+        $this->_calc_total_marks_awarded = $this->_actual_total_marks_awarded;\n+        $this->_calc_total_marks_received = $this->_actual_total_marks_received;\n \n+        return true;\n+    }\n \n+    // /->_prepareSelfPeer()\n }// /class\n-?>"
        },
        {
          "filename": "src/includes/functions/AcademicYear.php",
          "status": "modified",
          "additions": 30,
          "deletions": 29,
          "patch": "@@ -12,38 +12,39 @@\n \n class AcademicYear\n {\n-     /**\n-     *  Get the academic year for a given date\n-     *\n-     * @param int $date (optional) datetime to check. (default: current date/time)\n-     * @param int $start_month (optional) month-component of date the academic year starts in a year (default: 9)\n-     * @param int $start_day (optional) day-component of date the academic year starts in a year (default: 1)\n-     *\n-     * @return int academic year (format: YYYY)\n+    /**\n+    *  Get the academic year for a given date\n+    *\n+    * @param int $date (optional) datetime to check. (default: current date/time)\n+    * @param int $start_month (optional) month-component of date the academic year starts in a year (default: 9)\n+    * @param int $start_day (optional) day-component of date the academic year starts in a year (default: 1)\n+    *\n+    * @return int academic year (format: YYYY)\n     */\n-    public static function get_academic_year($date = null) {\n-      if (is_null($date)) {\n-        $date = time();\n-      }\n-      $year = (int) date('Y',$date);\n-      $month = (int) date('n',$date);\n-      if ($month < APP__ACADEMIC_YEAR_START_MONTH) {\n-        $year = $year - 1;\n-      }\n-\n-      return $year;\n-\n-    }// /get_academic_year()\n-\n-    public static function dateToYear($date) {\n+    public static function get_academic_year($date = null)\n+    {\n+        if (is_null($date)) {\n+            $date = time();\n+        }\n+        $year = (int) date('Y', $date);\n+        $month = (int) date('n', $date);\n+        if ($month < APP__ACADEMIC_YEAR_START_MONTH) {\n+            $year = $year - 1;\n+        }\n+\n+        return $year;\n+    }\n \n-      $year = (int) date('Y',$date);\n-      $month = (int) date('n',$date);\n-      if ($month < APP__ACADEMIC_YEAR_START_MONTH) {\n-        $year = $year - 1;\n-      }\n+    // /get_academic_year()\n \n-      return $year;\n+    public static function dateToYear($date)\n+    {\n+        $year = (int) date('Y', $date);\n+        $month = (int) date('n', $date);\n+        if ($month < APP__ACADEMIC_YEAR_START_MONTH) {\n+            $year = $year - 1;\n+        }\n \n+        return $year;\n     }\n }"
        },
        {
          "filename": "src/includes/functions/ArrayFunctions.php",
          "status": "modified",
          "additions": 34,
          "deletions": 28,
          "patch": "@@ -22,14 +22,15 @@ class ArrayFunctions\n      *\n      * @return ?? description\n      */\n-    public static function array_searchvalue($needle, $haystack, $search_index, $return_index = 0) {\n-      $arr_count = count($haystack);\n-      for ($i=0; $i<$arr_count; ++$i) {\n-        if ($haystack[$i][$search_index]==$needle) {\n-          return $haystack[$i][$return_index];\n-          break;\n+    public static function array_searchvalue($needle, $haystack, $search_index, $return_index = 0)\n+    {\n+        $arr_count = count($haystack);\n+        for ($i=0; $i<$arr_count; ++$i) {\n+            if ($haystack[$i][$search_index]==$needle) {\n+                return $haystack[$i][$return_index];\n+                break;\n+            }\n         }\n-      }\n     }\n \n     /**\n@@ -41,21 +42,23 @@ public static function array_searchvalue($needle, $haystack, $search_index, $ret\n      *\n      * @return array 1D array of items matching\n      */\n-    public static function array_extract_column(&$array, $column) {\n-      $extracted_columns = null;\n-      if (is_array($array)) {\n-        foreach($array as $i => $row) {\n-          if (isset($row[\"$column\"])) {\n-            $extracted_columns[] = $row[\"$column\"];\n-          } else {\n-            $extracted_columns[] = $i;\n-          }\n+    public static function array_extract_column(&$array, $column)\n+    {\n+        $extracted_columns = null;\n+        if (is_array($array)) {\n+            foreach ($array as $i => $row) {\n+                if (isset($row[\"$column\"])) {\n+                    $extracted_columns[] = $row[\"$column\"];\n+                } else {\n+                    $extracted_columns[] = $i;\n+                }\n+            }\n+            return $extracted_columns;\n         }\n-        return $extracted_columns;\n-      } else {\n         return null;\n-      }\n-    }// /array_extract_column()\n+    }\n+\n+    // /array_extract_column()\n \n     /**\n      *  Get an associative array, keyed using the given index\n@@ -67,14 +70,17 @@ public static function array_extract_column(&$array, $column) {\n      * @return array assoc array: array (key=>org_row, key=>org)\n      * _row, ...\n      */\n-    public static function array_get_assoc($array, $key_index) {\n-      $assoc_array = null;\n+    public static function array_get_assoc($array, $key_index)\n+    {\n+        $assoc_array = null;\n \n-      if ( (is_array($array)) ) {\n-        foreach($array as $i => $array_row) {\n-          $assoc_array[\"{$array_row[$key_index]}\"] = $array_row;\n+        if ((is_array($array))) {\n+            foreach ($array as $i => $array_row) {\n+                $assoc_array[\"{$array_row[$key_index]}\"] = $array_row;\n+            }\n         }\n-      }\n-      return $assoc_array;\n-    }// /array_get_assoc()\n+        return $assoc_array;\n+    }\n+\n+    // /array_get_assoc()\n }"
        },
        {
          "filename": "src/includes/functions/Common.php",
          "status": "modified",
          "additions": 66,
          "deletions": 49,
          "patch": "@@ -10,9 +10,10 @@\n \n namespace WebPA\\includes\\functions;\n \n+use Doctrine\\DBAL\\ParameterType;\n use WebPA\\includes\\classes\\DAO;\n \n-define('MYSQL_DATETIME_FORMAT','Y-m-d H:i:s');    // MYSQL datetime format (for update/insert/etc)\n+define('MYSQL_DATETIME_FORMAT', 'Y-m-d H:i:s');    // MYSQL datetime format (for update/insert/etc)\n \n class Common\n {\n@@ -24,8 +25,9 @@ class Common\n      *\n      * @return mixed\n      */\n-    public static function fetch_GET($key, $default_value = '') {\n-      return (isset($_GET[$key])) ? $_GET[$key] : $default_value;\n+    public static function fetch_GET($key, $default_value = '')\n+    {\n+        return (isset($_GET[$key])) ? $_GET[$key] : $default_value;\n     }\n \n     /**\n@@ -36,8 +38,9 @@ public static function fetch_GET($key, $default_value = '') {\n      *\n      * @return mixed\n      */\n-    public static function fetch_POST($key, $default_value = '') {\n-      return (isset($_POST[$key])) ? $_POST[$key] : $default_value;\n+    public static function fetch_POST($key, $default_value = '')\n+    {\n+        return (isset($_POST[$key])) ? $_POST[$key] : $default_value;\n     }\n \n     /**\n@@ -48,8 +51,9 @@ public static function fetch_POST($key, $default_value = '') {\n      *\n      * @return mixed\n      */\n-    public static function fetch_SERVER($key, $default_value = '') {\n-      return (isset($_SERVER[$key])) ? $_SERVER[$key] : $default_value;\n+    public static function fetch_SERVER($key, $default_value = '')\n+    {\n+        return (isset($_SERVER[$key])) ? $_SERVER[$key] : $default_value;\n     }\n \n     /**\n@@ -60,8 +64,9 @@ public static function fetch_SERVER($key, $default_value = '') {\n      *\n      * @return mixed\n      */\n-    public static function fetch_SESSION($key, $default_value = '') {\n-      return (isset($_SESSION[$key])) ? $_SESSION[$key] : $default_value;\n+    public static function fetch_SESSION($key, $default_value = '')\n+    {\n+        return (isset($_SESSION[$key])) ? $_SESSION[$key] : $default_value;\n     }\n \n     /**\n@@ -70,33 +75,45 @@ public static function fetch_SESSION($key, $default_value = '') {\n      *\n      * @return UUID\n      */\n-    public static function uuid_create() {\n-      // Get random 32-char 'UUID'\n-      $uuid_32 = strtoupper( md5( uniqid( rand(), true) ) );\n+    public static function uuid_create()\n+    {\n+        // Get random 32-char 'UUID'\n+        $uuid_32 = strtoupper(md5(uniqid(rand(), true)));\n \n-      // Convert to the correct 'dashed' format, and return the UUID\n-      return preg_replace('#([\\dA-F]{8})([\\dA-F]{4})([\\dA-F]{4})([\\dA-F]{4})([\\dA-F]{12})#', \"\\\\1-\\\\2-\\\\3-\\\\4-\\\\5\", $uuid_32);\n+        // Convert to the correct 'dashed' format, and return the UUID\n+        return preg_replace('#([\\dA-F]{8})([\\dA-F]{4})([\\dA-F]{4})([\\dA-F]{4})([\\dA-F]{12})#', '\\\\1-\\\\2-\\\\3-\\\\4-\\\\5', $uuid_32);\n     }\n \n     /**\n      * Add an entry to the tracking table\n      */\n-    public static function logEvent(DAO $db, $description, $module_id = NULL, $object_id = NULL) {\n-      $now = date(MYSQL_DATETIME_FORMAT);\n+    public static function logEvent(DAO $db, $description, $module_id = null, $object_id = null)\n+    {\n+        $dbConn = $db->getConnection();\n \n-      if (!empty($module_id)) {\n-        $module_id = (int) $module_id;\n-      }\n+        $now = date(MYSQL_DATETIME_FORMAT);\n \n-      $fields = array ('user_id' => (int) $_SESSION['_user_id'],\n-               'datetime'    => $now,\n-               'ip_address'  => $_SERVER['REMOTE_ADDR'],\n-               'description' => $description,\n-               'module_id'   => $module_id,\n-               'object_id'   => $object_id);\n+        if (!empty($module_id)) {\n+            $module_id = (int) $module_id;\n+        }\n+\n+        $query =\n+            'INSERT INTO ' . APP__DB_TABLE_PREFIX . 'user_tracking ' .\n+            '(user_id, datetime, ip_address, description, module_id, object_id) ' .\n+            'VALUES (?, ?, ?, ?, ?, ?) ' .\n+            'ON DUPLICATE KEY UPDATE user_id = ?';\n+\n+        $stmt = $dbConn->prepare($query);\n \n-      return $db->do_insert('INSERT INTO ' . APP__DB_TABLE_PREFIX . 'user_tracking ({fields}) VALUES ({values})', $fields);\n+        $stmt->bindValue(1, (int) $_SESSION['_user_id'], ParameterType::INTEGER);\n+        $stmt->bindValue(2, $now);\n+        $stmt->bindValue(3, $_SERVER['REMOTE_ADDR']);\n+        $stmt->bindValue(4, $description);\n+        $stmt->bindValue(5, $module_id, ParameterType::INTEGER);\n+        $stmt->bindValue(6, $object_id);\n+        $stmt->bindValue(7, (int) $_SESSION['_user_id'], ParameterType::INTEGER);\n \n+        $stmt->execute();\n     }\n \n     /**\n@@ -105,56 +122,56 @@ public static function logEvent(DAO $db, $description, $module_id = NULL, $objec\n     * @param string $_user\n     * @param string $user_type\n     */\n-    public static function check_user($_user, $user_type = NULL) {\n+    public static function check_user($_user, $user_type = null)\n+    {\n \n       // Is the user valid?\n-      if ($_user) {\n+        if ($_user) {\n \n         // if we're not checking the user type, or we are checking and it matches, return OK\n-        if (!$user_type || $_user->is_admin()) {\n-          return true;\n-        } else {\n-          switch ($user_type) {\n+            if (!$user_type || $_user->is_admin()) {\n+                return true;\n+            }\n+            switch ($user_type) {\n             case APP__USER_TYPE_ADMIN:\n               if ($_user->is_admin()) {\n-                return true;\n+                  return true;\n               }\n               break;\n             case APP__USER_TYPE_TUTOR:\n               if ($_user->is_tutor()) {\n-                return true;\n+                  return true;\n               }\n               break;\n             case APP__USER_TYPE_STUDENT:\n               if ($_user->is_student()) {\n-                return true;\n+                  return true;\n               }\n               break;\n           }\n-          return false;\n+            return false;\n         }\n-      } else {\n         return false;\n-      }\n+        \n \n \n-      // If we didn't call 'return' then the user is denied access\n+        // If we didn't call 'return' then the user is denied access\n \n-      // If they tried to access the main index page, assume they haven't logged in and go to the login page directly\n-      if ($_SERVER['PHP_SELF']=='/index.php') {\n-        header('Location: '. APP__WWW .'/login.php');\n-      } else {  // log them out and give the DENIED message\n-        header('Location:'. APP__WWW .'/logout.php?msg=denied');\n-      }\n-      exit;\n+        // If they tried to access the main index page, assume they haven't logged in and go to the login page directly\n+        if ($_SERVER['PHP_SELF']=='/index.php') {\n+            header('Location: '. APP__WWW .'/login.php');\n+        } else {  // log them out and give the DENIED message\n+            header('Location:'. APP__WWW .'/logout.php?msg=denied');\n+        }\n+        exit;\n     }\n \n     /**\n      * This function is a legacy function which appears to determine if a file is located in a particular directory.\n      *\n      */\n-    public static function & rel1($struc, &$file) {\n-      return file_exists( ( $file = ( dirname($struc).'/'.$file ) ) );\n+    public static function & rel1($struc, &$file)\n+    {\n+        return file_exists(($file = (dirname($struc).'/'.$file)));\n     }\n }\n-"
        },
        {
          "filename": "src/includes/functions/Form.php",
          "status": "modified",
          "additions": 65,
          "deletions": 47,
          "patch": "@@ -19,9 +19,12 @@ class Form\n      * @param string $email_address\n      * @return bool\n      */\n-    public static function is_email($email_address) {\n+    public static function is_email($email_address)\n+    {\n         return filter_var($email_address, FILTER_VALIDATE_EMAIL) === false ? false : true;\n-    }// /is_email()\n+    }\n+\n+    // /is_email()\n \n     /**\n      * Render an associative array as <option></option> tags\n@@ -30,29 +33,32 @@ public static function is_email($email_address) {\n      * @param string $selected Value that should be selected (have attribute: selected=\"selected\")\n      * @param datatype $switch_kv Use $v as the option value instead of $k\n      */\n-    public static function render_options($arr, $selected = null, $switch_kv = false) {\n+    public static function render_options($arr, $selected = null, $switch_kv = false)\n+    {\n         if (!$switch_kv) {\n             if (!is_null($selected)) {\n-                foreach($arr as $k => $v) {\n-                echo(\"<option value=\\\"$k\\\" \". ( ($k==$selected) ? 'selected=\"selected\"' : '' ) .\"> $v </option>\");\n-              }\n+                foreach ($arr as $k => $v) {\n+                    echo \"<option value=\\\"$k\\\" \". (($k==$selected) ? 'selected=\"selected\"' : '') .\"> $v </option>\";\n+                }\n             } else {\n-                foreach($arr as $k => $v) {\n-                echo(\"<option value=\\\"$k\\\"> $v </option>\");\n-              }\n+                foreach ($arr as $k => $v) {\n+                    echo \"<option value=\\\"$k\\\"> $v </option>\";\n+                }\n             }\n         } else {\n             if ($selected) {\n-                foreach($arr as $k => $v) {\n-                echo(\"<option value=\\\"$v\\\" \". ( ($v==$selected) ? 'selected=\"selected\"' : '' ) .\"> $v </option>\");\n-              }\n+                foreach ($arr as $k => $v) {\n+                    echo \"<option value=\\\"$v\\\" \". (($v==$selected) ? 'selected=\"selected\"' : '') .\"> $v </option>\";\n+                }\n             } else {\n-                foreach($arr as $k => $v) {\n-                echo(\"<option value=\\\"$v\\\"> $v </option>\");\n-              }\n+                foreach ($arr as $k => $v) {\n+                    echo \"<option value=\\\"$v\\\"> $v </option>\";\n+                }\n             }\n         }\n-    }// /render_options()\n+    }\n+\n+    // /render_options()\n \n     /**\n      * Render <option></option> tags for the given range of values\n@@ -62,12 +68,15 @@ public static function render_options($arr, $selected = null, $switch_kv = false\n      * @param null $selected\n      *\n      */\n-    public static function render_options_range($start, $end, $increment = 1, $selected = null) {\n+    public static function render_options_range($start, $end, $increment = 1, $selected = null)\n+    {\n         for ($i=$start; $i<=$end; $i += $increment) {\n             $selected_str = ($i==$selected) ? 'selected=\"selected\"' : '';\n-            echo(\"<option value=\\\"$i\\\" $selected_str> $i </option>\");\n+            echo \"<option value=\\\"$i\\\" $selected_str> $i </option>\";\n         }\n-    }// /render_options_range()\n+    }\n+\n+    // /render_options_range()\n \n     /**\n      * write to screen the check box grid\n@@ -78,9 +87,13 @@ public static function render_options_range($start, $end, $increment = 1, $selec\n      * @param bool $switch_value_label\n      * @param int $num_cols\n     */\n-    public static function render_checkbox_grid($arr, $input_name, $selected_arr, $switch_value_label = false, $num_cols = 1) {\n-        if (is_null($selected_arr)) { $selected_arr = array(); }\n-        else { $selected_arr = (array) $selected_arr; }\n+    public static function render_checkbox_grid($arr, $input_name, $selected_arr, $switch_value_label = false, $num_cols = 1)\n+    {\n+        if (is_null($selected_arr)) {\n+            $selected_arr = [];\n+        } else {\n+            $selected_arr = (array) $selected_arr;\n+        }\n \n         $arr_to_use = ($switch_value_label) ? array_flip($arr) : $arr;\n \n@@ -89,28 +102,32 @@ public static function render_checkbox_grid($arr, $input_name, $selected_arr, $s\n \n         // Calculate how many empty columns there must be\n         $mod = $count % $num_cols;\n-        $empty_cols = ($mod == 0) ? 0 : $num_cols - ($count % $num_cols);\n-        ?>\n+        $empty_cols = ($mod == 0) ? 0 : $num_cols - ($count % $num_cols); ?>\n         <table class=\"checkbox_grid\" cellpadding=\"0\" cellspacing=\"0\">\n         <?php\n-        foreach($arr_to_use as $value => $label) {\n+        foreach ($arr_to_use as $value => $label) {\n             if (($i % $num_cols)==0) {\n-                if ($i!=0) { echo('</tr>'); }\n-                if ($i!=$count-1) { echo('<tr>'); }\n+                if ($i!=0) {\n+                    echo '</tr>';\n+                }\n+                if ($i!=$count-1) {\n+                    echo '<tr>';\n+                }\n             }\n-            $id = $input_name .'_'. str_replace(' ','_', $value);\n-            $checked_str = (in_array($value,$selected_arr)) ? 'checked=\"checked\"' : '';\n+            $id = $input_name .'_'. str_replace(' ', '_', $value);\n+            $checked_str = (in_array($value, $selected_arr)) ? 'checked=\"checked\"' : '';\n \n-            echo(\"<td><input type=\\\"checkbox\\\" name=\\\"{$input_name}[]\\\" id=\\\"$id\\\" value=\\\"$value\\\" $checked_str /></td>\");\n-            echo(\"<th><label for=\\\"$id\\\">$label</label></th>\");\n+            echo \"<td><input type=\\\"checkbox\\\" name=\\\"{$input_name}[]\\\" id=\\\"$id\\\" value=\\\"$value\\\" $checked_str /></td>\";\n+            echo \"<th><label for=\\\"$id\\\">$label</label></th>\";\n             $i++;\n         }\n-        echo( str_repeat('<td>&nbsp;</td><td>&nbsp;</td>',$empty_cols) );\n-        echo('</tr>');\n-        ?>\n+        echo str_repeat('<td>&nbsp;</td><td>&nbsp;</td>', $empty_cols);\n+        echo '</tr>'; ?>\n         </table>\n         <?php\n-    }// /render_checkbox_grid()\n+    }\n+\n+    // /render_checkbox_grid()\n \n     /**\n      * Write to screen the radio buttons\n@@ -119,10 +136,9 @@ public static function render_checkbox_grid($arr, $input_name, $selected_arr, $s\n      * @param string $selected_str\n      * @param bool $switch_value_label\n     */\n-    public static function render_radio_boxes($arr, $input_name, $selected_str, $switch_value_label = false) {\n-        $arr_to_use = ($switch_value_label) ? array_flip($arr) : $arr;\n-\n-        ?>\n+    public static function render_radio_boxes($arr, $input_name, $selected_str, $switch_value_label = false)\n+    {\n+        $arr_to_use = ($switch_value_label) ? array_flip($arr) : $arr; ?>\n         <table class=\"radio_grid\" cellpadding=\"0\" cellspacing=\"0\">\n         <?php\n         /*\n@@ -137,17 +153,19 @@ public static function render_radio_boxes($arr, $input_name, $selected_str, $swi\n             }\n         } else {\n         */\n-            foreach($arr_to_use as $value => $label) {\n-                $id = $input_name .'_'. str_replace(' ','_', $value);\n+            foreach ($arr_to_use as $value => $label) {\n+                $id = $input_name .'_'. str_replace(' ', '_', $value);\n                 $checked_str = ($value==$selected_str) ? 'checked=\"checked\"' : '';\n-                echo('<tr>');\n-                echo(\"<td><input type=\\\"radio\\\" name=\\\"$input_name\\\" id=\\\"$id\\\" value=\\\"$value\\\" $checked_str /></td>\");\n-                echo(\"<th><label for=\\\"$id\\\">$label</label></th>\");\n-                echo('</tr>');\n+                echo '<tr>';\n+                echo \"<td><input type=\\\"radio\\\" name=\\\"$input_name\\\" id=\\\"$id\\\" value=\\\"$value\\\" $checked_str /></td>\";\n+                echo \"<th><label for=\\\"$id\\\">$label</label></th>\";\n+                echo '</tr>';\n             }\n-    //\t}\n+        //\t}\n         ?>\n         </table>\n         <?php\n-    }// /render_radio_boxes()\n+    }\n+\n+    // /render_radio_boxes()\n }"
        },
        {
          "filename": "src/includes/functions/StringFunctions.php",
          "status": "modified",
          "additions": 6,
          "deletions": 5,
          "patch": "@@ -10,9 +10,9 @@\n \n namespace WebPA\\includes\\functions;\n \n-DEFINE('STR_ALPHA_CHARS','ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz');\n-DEFINE('STR_ALPHANUM_CHARS','0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz');\n-DEFINE('STR_UUID_CHARS','0123456789ABCDEF-');\n+define('STR_ALPHA_CHARS', 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz');\n+define('STR_ALPHANUM_CHARS', '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz');\n+define('STR_UUID_CHARS', '0123456789ABCDEF-');\n \n class StringFunctions\n {\n@@ -24,13 +24,14 @@ class StringFunctions\n      *\n      * @return string\n     */\n-    public static function str_random ($length = 8, $valid_chars = null) {\n+    public static function str_random($length = 8, $valid_chars = null)\n+    {\n         if (is_null($valid_chars)) {\n             $valid_chars = STR_ALPHANUM_CHARS;\n         }\n \n         $str = '';\n-      while(strlen($str) < $length) {\n+        while (strlen($str) < $length) {\n             $str .= substr($valid_chars, mt_rand(0, strlen($valid_chars) -1), 1);\n         }\n         return $str;"
        },
        {
          "filename": "src/includes/functions/TimeDiff.php",
          "status": "modified",
          "additions": 10,
          "deletions": 6,
          "patch": "@@ -12,7 +12,7 @@\n \n class TimeDiff\n {\n-\t/**\n+    /**\n      * Get the difference between two datetimes as hours, minutes and seconds  (hh:mm:ss)\n      *\n      * If the time difference is less than 1 hour then only minutes and secconds will be shown\n@@ -23,7 +23,8 @@ class TimeDiff\n      *\n      * @return  string  String representation of the time difference\n      */\n-    public static function calculate($start_date, $end_date) {\n+    public static function calculate($start_date, $end_date)\n+    {\n         if ($end_date>$start_date) {\t// If the start after the end, the result will be a minus\n             $prefix = '';\n             $remainder = $end_date - $start_date;\n@@ -44,14 +45,17 @@ public static function calculate($start_date, $end_date) {\n         $seconds = $remainder;\n \n         // Put leading zeros on minutes and seconds (if required)\n-        if ($minutes<=9) { $minutes = '0' . $minutes; }\n-        if ($seconds<=9) { $seconds = '0' . $seconds; }\n+        if ($minutes<=9) {\n+            $minutes = '0' . $minutes;\n+        }\n+        if ($seconds<=9) {\n+            $seconds = '0' . $seconds;\n+        }\n \n         // Return difference\n         if ($hours>0) {\n             return \"$hours:$minutes:$seconds\";\n-        } else {\n-            return \"$minutes:$seconds\";\n         }\n+        return \"$minutes:$seconds\";\n     }\n }"
        },
        {
          "filename": "src/includes/functions/XML.php",
          "status": "modified",
          "additions": 10,
          "deletions": 11,
          "patch": "@@ -14,19 +14,18 @@\n \n class XML\n {\n-     public static function validate($xml, $xsd){\n-         libxml_use_internal_errors(true);\n+    public static function validate($xml, $xsd)\n+    {\n+        libxml_use_internal_errors(true);\n \n-         $objDom = new DOMDocument('1.0', 'utf-8');\n+        $objDom = new DOMDocument('1.0', 'utf-8');\n \n-         $objDom->loadXML($xml);\n+        $objDom->loadXML($xml);\n \n-         if (!$objDom->schemaValidate($xsd)) {\n-\n-    \t     libxml_get_errors();\n-             return false;\n-         } else {\n-            return true;\n-         }\n+        if (!$objDom->schemaValidate($xsd)) {\n+            libxml_get_errors();\n+            return false;\n+        }\n+        return true;\n     }\n }"
        },
        {
          "filename": "src/includes/inc_global.php",
          "status": "modified",
          "additions": 69,
          "deletions": 99,
          "patch": "@@ -11,50 +11,54 @@\n // Add composer's autoloader\n require __DIR__ . '/../../vendor/autoload.php';\n \n-use WebPA\\includes\\classes\\EngCIS;\n+use Doctrine\\DBAL\\ParameterType;\n use WebPA\\includes\\classes\\DAO;\n+use WebPA\\includes\\classes\\EngCIS;\n use WebPA\\includes\\classes\\UI;\n use WebPA\\includes\\classes\\User;\n use WebPA\\includes\\functions\\Common;\n \n+// load environment config\n+$dotenv = Dotenv\\Dotenv::createImmutable(__DIR__ . '/../..');\n+\n+$dotenv->load();\n+\n // Set the correct timezone for your server.\n date_default_timezone_set('Europe/London');\n \n-/*\n- * Configuration\n- */\n+// Configuration\n \n ////\n // User configuration section\n ////\n \n-define('APP__WWW', '');\n-define('DOC__ROOT', ''); //must include the trailing /\n-define('CUSTOM_CSS', '');  // Optional custom CSS file\n-define('SESSION_NAME', 'WEBPA');\n+define('APP__WWW', $_ENV['APP_WWW']);\n+define('DOC__ROOT', $_ENV['DOC_ROOT']); //must include the trailing /\n+define('CUSTOM_CSS', $_ENV['CUSTOM_CSS_PATH']);  // Optional custom CSS file\n+define('SESSION_NAME', $_ENV['SESSION_NAME']);\n ini_set('session.cookie_path', '/');\n \n // The month (1-12) in which the academic year is deemed to start (always on 1st of the month)\n-define('APP__ACADEMIC_YEAR_START_MONTH', 9);\n+define('APP__ACADEMIC_YEAR_START_MONTH', $_ENV['ACADEMIC_YEAR_START_MONTH']);\n \n //Database information\n-define('APP__DB_HOST', ''); // If on a non-standard port, use this format:  <server>:<port>\n-define('APP__DB_USERNAME', '');\n-define('APP__DB_PASSWORD', '');\n-define('APP__DB_DATABASE', '');\n-define('APP__DB_TABLE_PREFIX', 'pa2_');\n+define('APP__DB_HOST', $_ENV['DB_HOST']); // If on a non-standard port, use this format:  <server>:<port>\n+define('APP__DB_USERNAME', $_ENV['DB_USER']);\n+define('APP__DB_PASSWORD', $_ENV['DB_PASS']);\n+define('APP__DB_DATABASE', $_ENV['DB_NAME']);\n+define('APP__DB_TABLE_PREFIX', $_ENV['DB_PREFIX']);\n \n // Contact info\n-define('APP__EMAIL_HELP', 'someone@email.com');\n-define('APP__EMAIL_NO_REPLY', 'no-reply@email.com');\n+define('APP__EMAIL_HELP', $_ENV['HELP_EMAIL']);\n+define('APP__EMAIL_NO_REPLY', $_ENV['NO_REPLY_EMAIL']);\n \n // logo\n-define('APP__INST_LOGO', APP__WWW.'/images/logo.png');\n-define('APP__INST_LOGO_ALT','Your institution name');\n+define('APP__INST_LOGO', $_ENV['LOGO_PATH']);\n+define('APP__INST_LOGO_ALT', $_ENV['LOGO_ALT_TEXT']);\n \n //the following lines are to accomodate the image size within the css file to prevent the image from over flowing the area provided\n-define('APP__INST_HEIGHT', '25'); //image height in pixels\n-define('APP__INST_WIDTH', '102'); //image width in pixels\n+define('APP__INST_HEIGHT', $_ENV['LOGO_HEIGHT']); //image height in pixels\n+define('APP__INST_WIDTH', $_ENV['LOGO_WIDTH']); //image width in pixels\n \n //define whether the option to allow textual input is allowed\n /*NB. In the UK if requested any information about the student would need to be\n@@ -63,38 +67,23 @@\n * dependant on this act.\n *\n */\n-define('APP__ALLOW_TEXT_INPUT', TRUE);\n+define('APP__ALLOW_TEXT_INPUT', $_ENV['ALLOW_TEXT_INPUT'] === 'true');\n \n // enable delete options for users and modules\n-define('APP__ENABLE_USER_DELETE', FALSE);\n-define('APP__ENABLE_MODULE_DELETE', FALSE);\n+define('APP__ENABLE_USER_DELETE', $_ENV['ENABLE_USER_DELETE'] === 'true');\n+define('APP__ENABLE_MODULE_DELETE', $_ENV['ENABLE_MODULE_DELETE'] === 'true');\n \n // set the mail server variables if different mail server is to be used.\n-ini_set('SMTP','localhost');\n-ini_set('smtp_port','25');\n+ini_set('SMTP', $_ENV['SMTP_HOST']);\n+ini_set('smtp_port', $_ENV['SMTP_PORT']);\n // if using a windows structure you need to set the send mail from\n-ini_set('sendmail_from','someone@email.com');\n+ini_set('sendmail_from', $_ENV['EMAIL_ADDRESS']);\n \n //define the authentication to be used and in the order they are to be applied\n $LOGIN_AUTHENTICATORS[] = 'DB';\n-$LOGIN_AUTHENTICATORS[] = 'LDAP';\n-\n-// LDAP settings\n-define('LDAP__HOST', \"kdc.lboro.ac.uk\");\n-define('LDAP__PORT', 3268);\n-define('LDAP__USERNAME_EXT', '@lboro.ac.uk');\n-define('LDAP__BASE', 'dc=lboro, dc=ac, dc=uk');\n-define('LDAP__FILTER', 'name={username}*');\n-define('LDAP__BINDRDN', '');\n-define('LDAP__PASSWD', '');\n-$LDAP__INFO_REQUIRED = array('displayname','mail','sn');\n-// Name of attribute to use to check user type (via function below)\n-define('LDAP__USER_TYPE_ATTRIBUTE', 'description');\n-define('LDAP__DEBUG_LEVEL', 7);\n-define('LDAP__AUTO_CREATE_USER', TRUE);\n \n // define installed modules\n-$INSTALLED_MODS = array();\n+$INSTALLED_MODS = [];\n \n ////\n // System configuration section - do not change unless you know what you're doing!\n@@ -104,36 +93,30 @@\n define('APP__NAME', 'WebPA OS');\n define('APP__TITLE', 'WebPA OS : Online Peer Assessment System');\n define('APP__ID', 'webpa');\n-define('APP__VERSION', '3.1.1');\n-define('APP__DESCRIPTION','WebPA, an Open source, online peer assessment system.');\n-define('APP__KEYWORDS','peer assessment, online, peer, assessment, tools, open source');\n-\n-define('APP__DB_TYPE', 'MySQLDAO');\n-\n-define('APP__DB_PERSISTENT', FALSE);\n-define('APP__DB_CLIENT_FLAGS', 2);\n+define('APP__VERSION', '3.1.2');\n+define('APP__DESCRIPTION', 'WebPA, an Open source, online peer assessment system.');\n+define('APP__KEYWORDS', 'peer assessment, online, peer, assessment, tools, open source');\n \n // User types\n define('APP__USER_TYPE_ADMIN', 'A');\n define('APP__USER_TYPE_TUTOR', 'T');\n define('APP__USER_TYPE_STUDENT', 'S');\n \n //Moodle gradebook output allowed...\n-define('APP__MOODLE_GRADEBOOK', FALSE); // If the grade book xml for moodle can be output then set to true, else if not required set to false\n+define('APP__MOODLE_GRADEBOOK', $_ENV['ENABLE_MOODLE_GRADEBOOK'] === 'true'); // If the grade book xml for moodle can be output then set to true, else if not required set to false\n \n //Automatic emailing options.\n-//this is dependant on cron jobs being set for the following files;\n-//  /tutors/assessments/email/TriggerReminder.php\n-//  /tutors/assessments/email/ClosingReminber.php\n-define('APP__REMINDER_OPENING', FALSE);\n-define('APP__REMINDER_CLOSING', FALSE);\n+//this is dependant on a cron job being set to run against the following file:\n+//  /jobs/Email.php\n+define('APP__REMINDER_OPENING', $_ENV['SEND_OPENING_REMINDER'] === 'true');\n+define('APP__REMINDER_CLOSING', $_ENV['SEND_CLOSING_REMINDER'] === 'true');\n \n //set in individual pages to link to the most appropriate help sections.\n //this is not an option that can be changed in the configuration\n-define ('APP__HELP_LINK','http://www.webpaproject.com/');\n+define('APP__HELP_LINK', 'http://www.webpaproject.com/');\n \n //define the terminology presented to the student as mark, rating or score\n-define('APP__MARK_TEXT', 'Score(s)');\n+define('APP__MARK_TEXT', $_ENV['MARK_TERMINOLOGY']);\n \n // Collection owner types\n define('APP__COLLECTION_USER', 'user');\n@@ -142,7 +125,7 @@\n //ordinal scale\n //This scale is used in the reports as some institution and academic tutors prefer this scale.\n //However, it must be noted that the majority of universities in the UK are using arithmetic mean for classifications.\n-$ordinal_scale = array (\n+$ordinal_scale = [\n   'A+' => '78',\n   'A'  => '75',\n   'B+' => '68',\n@@ -159,22 +142,22 @@\n   'X'  => '25',\n   'X-' => '15',\n   'Z'  =>'0',\n-);\n+];\n \n // When reporting grades as decimals, define the precision, etc using this constant\n-define('APP__REPORT_DECIMALS', \"%01.2f\");\n+define('APP__REPORT_DECIMALS', '%01.2f');\n \n // File upload error messages\n-$FILE_ERRORS = array(\n+$FILE_ERRORS = [\n   UPLOAD_ERR_OK => 'There is no error, the file uploaded with success.',\n   UPLOAD_ERR_INI_SIZE => 'The uploaded file exceeds the upload_max_filesize directive in php.ini.',\n   UPLOAD_ERR_FORM_SIZE => 'The uploaded file exceeds the MAX_FILE_SIZE directive that was specified in the HTML form.',\n   UPLOAD_ERR_PARTIAL => 'The uploaded file was only partially uploaded.',\n   UPLOAD_ERR_NO_FILE => 'No file was uploaded.',\n   UPLOAD_ERR_NO_TMP_DIR => 'Missing a temporary folder.',\n   UPLOAD_ERR_CANT_WRITE => 'Failed to write file to disk.',\n-  UPLOAD_ERR_EXTENSION => 'A PHP extension stopped the file upload.'\n-  );\n+  UPLOAD_ERR_EXTENSION => 'A PHP extension stopped the file upload.',\n+  ];\n \n // Old config compatibility\n $_config['app_id'] = APP__ID;\n@@ -187,19 +170,18 @@\n \n // Initialise DB object\n \n-$DB = new DAO( APP__DB_HOST, APP__DB_USERNAME, APP__DB_PASSWORD, APP__DB_DATABASE);\n-$DB->set_debug(FALSE);\n+$DB = new DAO(APP__DB_HOST, APP__DB_USERNAME, APP__DB_PASSWORD, APP__DB_DATABASE);\n \n // Initialise User Object\n \n $_user = null;\n \n // Get info from the session\n-$_user_id = Common::fetch_SESSION('_user_id', NULL);\n-$_user_source_id = Common::fetch_SESSION('_user_source_id', NULL);\n-$_user_context_id = Common::fetch_SESSION('_user_context_id', NULL);\n+$_user_id = Common::fetch_SESSION('_user_id', null);\n+$_user_source_id = Common::fetch_SESSION('_user_source_id', null);\n+$_user_context_id = Common::fetch_SESSION('_user_context_id', null);\n $_source_id = Common::fetch_SESSION('_source_id', '');\n-$_module_id = Common::fetch_SESSION('_module_id', NULL);\n+$_module_id = Common::fetch_SESSION('_module_id', null);\n $BRANDING['logo'] = Common::fetch_SESSION('branding_logo', APP__INST_LOGO);\n $BRANDING['logo.width'] = Common::fetch_SESSION('branding_logo.width', APP__INST_WIDTH);\n $BRANDING['logo.height'] = Common::fetch_SESSION('branding_logo.height', APP__INST_HEIGHT);\n@@ -212,46 +194,34 @@\n $CIS = new EngCIS($_source_id, $_module_id);\n \n // If we found a user to load, load 'em!\n-if ($_user_id){\n-\n-  $_user_info = $CIS->get_user($_user_id);\n+if ($_user_id) {\n+    $_user_info = $CIS->get_user($_user_id);\n \n-  // Actually create the user object\n-  $_user = new User();\n-  $_user->load_from_row($_user_info);\n-  $_user_info = null;   // We're done with the data, so clear it\n+    // Actually create the user object\n+    $_user = new User();\n+    $_user->load_from_row($_user_info);\n+    $_user_info = null;   // We're done with the data, so clear it\n \n-  // save session data\n-  $_SESSION['_user_id'] = $_user->id;\n+    // save session data\n+    $_SESSION['_user_id'] = $_user->id;\n }\n \n if (!is_null($_user)) {\n     $CIS->setUser($_user);\n }\n \n-// If we found a module to load, load it!\n-if ($_module_id){\n-  $sql_module = 'SELECT module_id, module_code, module_title FROM ' . APP__DB_TABLE_PREFIX . \"module WHERE module_id = {$_SESSION['_module_id']}\";\n-  $_module = $DB->fetch_row($sql_module);\n-  $_module_code = $_module['module_code'];\n-\n-}\n-\n-$UI = new UI($INSTALLED_MODS, $_source_id, $BRANDING, $CIS, $_module, $_user);\n-\n-function get_LDAP_user_type($data) {\n+// initialise module\n+$_module = null;\n \n-    $description_str = $data[0];\n+// If we found a module to load, load it!\n+if ($_module_id) {\n+    $dbConn = $DB->getConnection();\n \n-    //check in the string for staff\n-    if(strripos ($description_str, 'staff') !== false) {\n-      $user_type = APP__USER_TYPE_TUTOR;\n-    } else {\n-      $user_type = APP__USER_TYPE_STUDENT;\n-    }\n+    $query = 'SELECT module_id, module_code, module_title FROM ' . APP__DB_TABLE_PREFIX . 'module WHERE module_id = ?';\n \n-  return $user_type;\n+    $_module = $dbConn->fetchAssociative($query, [$_SESSION['_module_id']], [ParameterType::INTEGER]);\n \n+    $_module_code = $_module['module_code'];\n }\n \n-?>\n+$UI = new UI($INSTALLED_MODS, $_source_id, $BRANDING, $CIS, $_module, $_user);"
        },
        {
          "filename": "src/index.php",
          "status": "modified",
          "additions": 18,
          "deletions": 20,
          "patch": "@@ -8,33 +8,31 @@\n  * @link https://github.com/webpa/webpa\n  */\n \n-require_once('includes/inc_global.php');\n+require_once 'includes/inc_global.php';\n \n $mod = '';\n if (isset($_SERVER['PATH_INFO']) && (strlen($_SERVER['PATH_INFO']) > 0)) {\n-  $mod = substr($_SERVER['PATH_INFO'], 1);\n-} else if (isset($_SERVER['QUERY_STRING'])) {\n-  $mod = $_SERVER['QUERY_STRING'];\n+    $mod = substr($_SERVER['PATH_INFO'], 1);\n+} elseif (isset($_SERVER['QUERY_STRING'])) {\n+    $mod = $_SERVER['QUERY_STRING'];\n }\n \n if ($mod && in_array($mod, $INSTALLED_MODS)) {\n-  if (strtoupper($_SERVER['REQUEST_METHOD']) == 'POST') {\n-    include_once(\"mod/{$mod}/index.php\");\n-  } else {\n-    header('Location: ' . APP__WWW . \"/mod/{$mod}/\");\n-  }\n-} else if ($_user) {\n-  if ($_user->is_admin()) {\n-    header('Location: ' . APP__WWW . '/admin/');\n-  } else if ($_user->is_tutor()) {\n-    header('Location: ' . APP__WWW . '/tutors/');\n-  } else {\n-    header('Location: ' . APP__WWW . '/students/');\n-  }\n+    if (strtoupper($_SERVER['REQUEST_METHOD']) == 'POST') {\n+        include_once \"mod/{$mod}/index.php\";\n+    } else {\n+        header('Location: ' . APP__WWW . \"/mod/{$mod}/\");\n+    }\n+} elseif ($_user) {\n+    if ($_user->is_admin()) {\n+        header('Location: ' . APP__WWW . '/admin/');\n+    } elseif ($_user->is_tutor()) {\n+        header('Location: ' . APP__WWW . '/tutors/');\n+    } else {\n+        header('Location: ' . APP__WWW . '/students/');\n+    }\n } else {\n-  header('Location: ' . APP__WWW . '/login.php');\n+    header('Location: ' . APP__WWW . '/login.php');\n }\n \n exit;\n-\n-?>"
        },
        {
          "filename": "src/install/install.txt",
          "status": "removed",
          "additions": 0,
          "deletions": 28,
          "patch": "@@ -1,28 +0,0 @@\n-WebPA 2.0.0.10\n-==============\n-\n-Installation Guide\n-------------------\n-\n-*  Edit the includes/inc_global.php file in the includes directory to configure the application; in particular:\n-     - APP__WWW: URL to the instance of WebPA (without a closing \"/\");\n-     - DOC__ROOT: directory path to the WebPA files (with a closing \"/\" or \"\\\\\");\n-     - database settings:\n-        - APP__DB_HOST: host name\n-        - APP__DB_USERNAME: username\n-        - APP__DB_PASSWORD: password\n-        - APP__DB_DATABASE: database name\n-        - APP__DB_TABLE_PREFIX: table prefix (default is \"pa2_\" which means that the new version can share the same database as the old version if required)\n-     - configure the LDAP settings if you wish to authenticate via LDAP.\n-     \n-*  Run the following scripts to initialise the database (edit the files to change the names and password as required):\n-     - install/webpa2_database.sql: create the database schema and user account;\n-     - install/webpa2_tables.sql: create the database tables;\n-     - install/webpa2_administrator.sql: create an administrator account and sample module.\n-     \n-*  Login to WebPA:\n-\t\t - navigate to root of WebPA application;\n-\t\t - enter a username of \"admin\" and a password of \"admin\"\n-\t\t - change the password to something more secure after logging in\n-\t\t \n-*  Delete the \"install\" folder when you're finished.\n\\ No newline at end of file"
        },
        {
          "filename": "src/install/upgrades/webpa_security_update.sql",
          "status": "added",
          "additions": 2,
          "deletions": 0,
          "patch": "@@ -0,0 +1,2 @@\n+ALTER TABLE pa2_user MODIFY COLUMN password VARCHAR(255);\n+ALTER TABLE pa2_user_reset_request MODIFY COLUMN hash VARCHAR(255);\n\\ No newline at end of file"
        },
        {
          "filename": "src/install/webpa2_tables.sql",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -77,7 +77,7 @@ CREATE TABLE pa2_user (\n   user_id int(10) unsigned NOT NULL AUTO_INCREMENT,\n   source_id varchar(255) NOT NULL DEFAULT '',\n   username varchar(255) NOT NULL,\n-  `password` varchar(45) NOT NULL,\n+  `password` varchar(255) NOT NULL,\n   id_number varchar(255) DEFAULT NULL,\n   department_id varchar(255) DEFAULT NULL,\n   forename varchar(255) NOT NULL,"
        },
        {
          "filename": "src/jobs/Email.php",
          "status": "added",
          "additions": 19,
          "deletions": 0,
          "patch": "@@ -0,0 +1,19 @@\n+<?php\n+\n+namespace WebPA\\jobs;\n+\n+use WebPA\\tutors\\assessments\\email\\ClosingReminder;\n+use WebPA\\tutors\\assessments\\email\\TriggerReminder;\n+\n+require __DIR__ . '/../includes/inc_global.php';\n+\n+// execute email closing reminders\n+$closingReminder = new ClosingReminder($DB);\n+\n+$closingReminder->send();\n+\n+// execute email trigger reminder\n+\n+$triggerReminder = new TriggerReminder($DB);\n+\n+$triggerReminder->send();"
        },
        {
          "filename": "src/keep_alive.php",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -1,5 +1,5 @@\n <?php\n-require_once(\"includes/inc_global.php\");\n+require_once 'includes/inc_global.php';\n ?>\n <!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\"\n  \"http://www.w3.org/TR/html4/loose.dtd\">\n@@ -23,7 +23,7 @@ function body_onload() {\n </head>\n <body onload=\"body_onload();\">\n \n-<?php echo( gmdate('H:i:s d-m-Y') ); ?>\n+<?php echo gmdate('H:i:s d-m-Y'); ?>\n \n </body>\n </html>\n\\ No newline at end of file"
        },
        {
          "filename": "src/lang/en/Generic.php",
          "status": "modified",
          "additions": 10,
          "deletions": 0,
          "patch": "@@ -17,28 +17,38 @@\n class Generic\n {\n     public const MY__FORMS = 'my forms';\n+\n     public const MY__GROUPS = 'my groups';\n+\n     public const MY__ASSESSMENTS = 'my assessments';\n \n     public const GROUPS = 'Groups';\n+\n     public const NO__GROUPS = 'Number of Groups';\n+\n     public const EDIT__GROUP = 'edit group';\n+\n     public const DELETE__GROUP = 'delete group';\n \n     public const EDIT_QUESTION = 'edit question';\n \n     public const PLEASE__NOTE = '<strong>Please Note:</strong>';\n \n     public const UNKNOWN__COLLECTION = 'Unknown Collection';\n+\n     public const EDDITING__UNKNOWN_GROUP = 'Editing: Unknown Group';\n+\n     public const EDDITING__GROUP = 'Editing Group';\n \n     public const BTN__LIST_GROUPS = 'List Groups';\n+\n     public const BTN__CREATE_GROUPS = 'Create Groups';\n+\n     public const BTN__CLONE_GROUPS = 'Clone Groups';\n \n     public const BTN__SAVE_CHANGES = 'save changes';\n \n     public const FOLLOWING__FOUND = 'The following errors were found';\n+\n     public const NO_CHANGES = 'No changes have been saved. Please check the details in the form, and try again.';\n }"
        },
        {
          "filename": "src/lang/en/tutors/Tutors.php",
          "status": "modified",
          "additions": 35,
          "deletions": 22,
          "patch": "@@ -16,32 +16,45 @@\n \n class Tutors\n {\n-   public const WELCOME = 'Welcome to WebPA, the easiest way for your students to carry out peer assessment reviews on the web. Using this system, students doing group work activities can mark each other\\'s contributions, providing each student with an overall score.';\n-   public const SECTIONS__INTRO = 'WebPA contains the following sections:';\n-   public const OPT__FORMS__DESC = 'Create peer assessment forms for your students to complete. You can re-use your forms with many different assessments.';\n-   public const OPT__GROUPS__DESC = 'Organise your students into groups. You can create new groups from scratch, or use existing groups that have been set up by other staff members.';\n-   public const OPT__ASSESSMENTS__DESC = 'Create, edit and schedule your peer assessments sessions so they only run how and when you want.';\n-   public const GETTING__STARTED__TITLE = 'Getting Started';\n-   public const GETTING__STARTED__DESC = 'The fastest way to get started is for you to choose <a href=\"forms/\">my forms</a> from the left-hand menu, there you can begin creating a peer assessment form that your students will use later to grade each other.';\n+    public const WELCOME = 'Welcome to WebPA, the easiest way for your students to carry out peer assessment reviews on the web. Using this system, students doing group work activities can mark each other\\'s contributions, providing each student with an overall score.';\n \n-   public const GROUPS__WELCOME = 'Here you can edit your groups, and organise how students are allocated to the individual groups.';\n-   public const GROUPS__TITLE = 'Existing Groups';\n-   public const NO__GROUPS__DESC = 'You have no groups. To add a collection use the <a href=\"create/\">create new groups wizard</a>.';\n-   public const GROUPS__INSTRUCT__1 = 'These are your groups. To view or edit a collection of groups, click on ';\n-   public const GROUPS__INSTRUCT__2 = 'in the list below.';\n+    public const SECTIONS__INTRO = 'WebPA contains the following sections:';\n \n-   public const GROUPS__NOTE ='Any changes you make to your groups here will <strong>not</strong> affect any assessments you may have created. If you want to change the groups in use with an assessment, you must edit the assessment and choose the option to select a new set of groups.';\n+    public const OPT__FORMS__DESC = 'Create peer assessment forms for your students to complete. You can re-use your forms with many different assessments.';\n \n-   public const GROUPS__EDIT__DESC =  'Here you can edit your collections of groups, and organise how students are allocated to the individual groups.';\n-   public const GROUPS__EDIT_TITLE = 'Group Collections';\n-   public const NO_COLLECTIONS ='You have no collections. To add a collection use the <a href=\"../create/\">create new groups wizard</a>.';\n-   public const GROUPS__EDIT__INST = 'These are your group collections. To view or edit a collection, click on its name in the list below:';\n+    public const OPT__GROUPS__DESC = 'Organise your students into groups. You can create new groups from scratch, or use existing groups that have been set up by other staff members.';\n \n-   public const GROUPS__EDIT_SAVE_ERR ='You must give this group a name.';\n+    public const OPT__ASSESSMENTS__DESC = 'Create, edit and schedule your peer assessments sessions so they only run how and when you want.';\n \n-   public const COLLECTION__LOCKED ='<p>This group belongs to a collection that has been locked, and cannot be edited. You can still view the details of this group, but not edit its name or members.</p>';\n+    public const GETTING__STARTED__TITLE = 'Getting Started';\n \n-   public const GROUPS__EDIT_INST =  '<p>On this page you can change the name of this group, and add/remove students from it.</p>';\n-   public const GROUP__SELECTED = '<p>The group you selected could not be loaded for some reason - please go back and try again.</p>';\n-}\n+    public const GETTING__STARTED__DESC = 'The fastest way to get started is for you to choose <a href=\"forms/\">my forms</a> from the left-hand menu, there you can begin creating a peer assessment form that your students will use later to grade each other.';\n+\n+    public const GROUPS__WELCOME = 'Here you can edit your groups, and organise how students are allocated to the individual groups.';\n+\n+    public const GROUPS__TITLE = 'Existing Groups';\n+\n+    public const NO__GROUPS__DESC = 'You have no groups. To add a collection use the <a href=\"create/\">create new groups wizard</a>.';\n+\n+    public const GROUPS__INSTRUCT__1 = 'These are your groups. To view or edit a collection of groups, click on ';\n+\n+    public const GROUPS__INSTRUCT__2 = 'in the list below.';\n+\n+    public const GROUPS__NOTE ='Any changes you make to your groups here will <strong>not</strong> affect any assessments you may have created. If you want to change the groups in use with an assessment, you must edit the assessment and choose the option to select a new set of groups.';\n+\n+    public const GROUPS__EDIT__DESC =  'Here you can edit your collections of groups, and organise how students are allocated to the individual groups.';\n \n+    public const GROUPS__EDIT_TITLE = 'Group Collections';\n+\n+    public const NO_COLLECTIONS ='You have no collections. To add a collection use the <a href=\"../create/\">create new groups wizard</a>.';\n+\n+    public const GROUPS__EDIT__INST = 'These are your group collections. To view or edit a collection, click on its name in the list below:';\n+\n+    public const GROUPS__EDIT_SAVE_ERR ='You must give this group a name.';\n+\n+    public const COLLECTION__LOCKED ='<p>This group belongs to a collection that has been locked, and cannot be edited. You can still view the details of this group, but not edit its name or members.</p>';\n+\n+    public const GROUPS__EDIT_INST =  '<p>On this page you can change the name of this group, and add/remove students from it.</p>';\n+\n+    public const GROUP__SELECTED = '<p>The group you selected could not be loaded for some reason - please go back and try again.</p>';\n+}"
        },
        {
          "filename": "src/login.php",
          "status": "modified",
          "additions": 12,
          "deletions": 12,
          "patch": "@@ -11,7 +11,7 @@\n  * @link https://github.com/webpa/webpa\n  */\n \n-require_once(\"includes/inc_global.php\");\n+require_once 'includes/inc_global.php';\n \n use WebPA\\includes\\functions\\Common;\n \n@@ -21,37 +21,37 @@\n $msg = Common::fetch_GET('msg', null);\n \n switch ($msg) {\n-  case 'connfailed' :\n+  case 'connfailed':\n         $message_class = 'warning';\n         $message = 'A connection to the authentication server could not be established.<br />Please try again later.';\n         break;\n   // --------------------\n-  case 'denied' :\n+  case 'denied':\n         $message_class = 'warning';\n         $message = 'You attempted to access a restricted page.<br />It may be that your session has timed out so please re-enter your details.';\n         break;\n   // --------------------\n-  case 'no access' :\n+  case 'no access':\n         $message_class = 'warning';\n         $message = 'Your account has been disabled.<br />Please contact support if you do not think this should be the case.';\n         break;\n   // --------------------\n-  case 'invalid' :\n+  case 'invalid':\n         $message_class = 'warning';\n         $message = 'Your username and password were rejected.<br />Please check your details and try again.';\n         break;\n   // --------------------\n-  case 'cookies' :\n+  case 'cookies':\n         $message_class = 'warning';\n         $message = 'Unable to connect to ' . APP__NAME . '; please ensure that your browser is not blocking third-party cookies';\n         break;\n   // --------------------\n-  case 'logout' :\n+  case 'logout':\n         $message_class = 'info';\n         $message = 'You have logged out.<br />If you wish to log back in, please re-enter your details.';\n         break;\n   // --------------------\n-  default :\n+  default:\n         $message_class = 'info';\n         $message = 'To start using ' . APP__NAME . ' you have to log in.';\n         break;\n@@ -63,9 +63,9 @@\n $UI->page_title = APP__NAME . ' Login';\n $UI->menu_selected = '';\n $UI->help_link = '?q=node/26';\n-$UI->breadcrumbs = array  (\n-  'login page'  => null ,\n-);\n+$UI->breadcrumbs = [\n+  'login page'  => null,\n+];\n \n \n $UI->head();\n@@ -96,7 +96,7 @@ function username_focus() {\n ?>\n \n \n-<?php echo(\"<p class=\\\"$message_class\\\">$message</p>\"); ?>\n+<?php echo \"<p class=\\\"$message_class\\\">$message</p>\"; ?>\n \n <div class=\"content_box\">\n "
        },
        {
          "filename": "src/login_check.php",
          "status": "modified",
          "additions": 42,
          "deletions": 66,
          "patch": "@@ -16,7 +16,7 @@\n \n namespace WebPA;\n \n-require_once(\"./includes/inc_global.php\");\n+require_once './includes/inc_global.php';\n \n use WebPA\\includes\\functions\\Common;\n \n@@ -26,86 +26,62 @@\n $username = (string) Common::fetch_POST('username');\n $password = (string) Common::fetch_POST('password');\n \n-// Sanitize the username/password data\n-$username = substr($username,0,255);\n-$password = substr($password,0,255);\n-\n-$DB->open();\n-$username = $DB->escape_str($username);\n-$password = $DB->escape_str($password);\n-\n $msg ='';\n \n // --------------------------------------------------------------------------------\n // Attempt Login\n \n $auth_success = false;\n \n-if ( ($username) && ($password) ) {\n-\n-  $authenticated = FALSE;\n+if (($username) && ($password)) {\n+    $authenticated = false;\n \n-  // Authenticate...\n-  for ($i = 0; $i < count($LOGIN_AUTHENTICATORS); $i++) {\n-    $classname = 'WebPA\\includes\\classes\\\\' . $LOGIN_AUTHENTICATORS[$i] . 'Authenticator';\n+    // Authenticate...\n+    for ($i = 0; $i < count($LOGIN_AUTHENTICATORS); $i++) {\n+        $classname = 'WebPA\\includes\\classes\\\\' . $LOGIN_AUTHENTICATORS[$i] . 'Authenticator';\n \n-    $_auth = new $classname($CIS, $username, $password);\n-\n-    if ($LOGIN_AUTHENTICATORS[$i] === 'LDAP') {\n-      $_auth->setRequiredInfo($LDAP__INFO_REQUIRED);\n-    }\n+        $_auth = new $classname($CIS, $username, $password);\n \n-    if ($_auth->authenticate()) {\n-      $authenticated = TRUE;\n-      break;\n+        if ($_auth->authenticate()) {\n+            $authenticated = true;\n+            break;\n+        }\n     }\n-  }\n \n-  if (!$authenticated) {\n-\n-    $msg = 'invalid';\n-\n-    //but just to be sure check for an authorisation failed message\n-    $auth_failed = $_auth->get_error();\n-\n-    if(strlen($auth_failed) > 0){\n-      $msg = $auth_failed;\n+    if (!$authenticated) {\n+        $msg = 'invalid';\n+\n+        //but just to be sure check for an authorisation failed message\n+        $auth_failed = $_auth->get_error();\n+\n+        if (strlen($auth_failed) > 0) {\n+            $msg = $auth_failed;\n+        }\n+    } elseif ($_auth->is_disabled()) {\n+        $msg = 'no access';\n+    } else {\n+        $_SESSION = [];\n+        session_destroy();\n+        session_name(SESSION_NAME);\n+        session_start();\n+\n+        // Save session data\n+        $_SESSION['_user_id'] = $_auth->user_id;\n+        $_SESSION['_user_source_id'] = $_auth->source_id;\n+        $_SESSION['_user_type'] = $_auth->user_type;\n+        $_SESSION['_source_id'] = $_auth->source_id;\n+        $_SESSION['_module_id'] = $_auth->module_id;\n+        $_SESSION['_user_context_id'] = $_auth->module_code;\n+\n+        Common::logEvent($DB, 'Login');\n+        Common::logEvent($DB, 'Enter module', $_auth->module_id);\n+\n+        header('Location: ' . APP__WWW . \"/index.php?id={$_user_id}\"); // This doesn't log them in, the user_id just shows as a debug check\n+        exit;\n     }\n-\n-  } else if ($_auth->is_disabled()) {\n-\n-    $msg = 'no access';\n-\n-  } else {\n-\n-    $_SESSION = array();\n-    session_destroy();\n-    session_name(SESSION_NAME);\n-    session_start();\n-\n-    // Save session data\n-    $_SESSION['_user_id'] = $_auth->user_id;\n-    $_SESSION['_user_source_id'] = $_auth->source_id;\n-    $_SESSION['_user_type'] = $_auth->user_type;\n-    $_SESSION['_source_id'] = $_auth->source_id;\n-    $_SESSION['_module_id'] = $_auth->module_id;\n-    $_SESSION['_user_context_id'] = $_auth->module_code;\n-\n-    Common::logEvent($DB, 'Login');\n-    Common::logEvent($DB, 'Enter module', $_auth->module_id);\n-\n-    header('Location: ' . APP__WWW . \"/index.php?id={$_user_id}\"); // This doesn't log them in, the user_id just shows as a debug check\n-    exit;\n-\n-  }\n-\n } else {\n-\n-  $msg = '';\n-\n+    $msg = '';\n }\n \n header('Location: ' . APP__WWW . \"/login.php?msg={$msg}\");\n exit;\n-\n-?>"
        },
        {
          "filename": "src/logout.php",
          "status": "modified",
          "additions": 41,
          "deletions": 38,
          "patch": "@@ -8,56 +8,59 @@\n  * @link https://github.com/webpa/webpa\n  */\n \n-require_once(\"includes/inc_global.php\");\n+require_once 'includes/inc_global.php';\n \n use WebPA\\includes\\functions\\Common;\n \n if (isset($_SESSION['_user_id'])) {\n-  Common::logEvent($DB, 'Logout');\n+    Common::logEvent($DB, 'Logout');\n }\n \n $old_session = $_SESSION;\n-$_SESSION = array();\n+$_SESSION = [];\n session_destroy();\n \n if (isset($old_session['logout_url'])) {\n-  $url = $old_session['logout_url'];\n-  if ($_SERVER['QUERY_STRING']) {\n-    if (strpos($url, '?') === FALSE) {\n-      $url .= '?';\n-    } else {\n-      $url .= '&';\n+    $url = $old_session['logout_url'];\n+    if ($_SERVER['QUERY_STRING']) {\n+        if (strpos($url, '?') === false) {\n+            $url .= '?';\n+        } else {\n+            $url .= '&';\n+        }\n+        $url .= $_SERVER['QUERY_STRING'];\n+    }\n+    if (ini_get('session.use_cookies')) {\n+        $params = session_get_cookie_params();\n+        setcookie(\n+            session_name(),\n+            '',\n+            time() - 42000,\n+            $params['path'],\n+            $params['domain'],\n+            $params['secure'],\n+            $params['httponly']\n+        );\n     }\n-    $url .= $_SERVER['QUERY_STRING'];\n-  }\n-  if (ini_get('session.use_cookies')) {\n-    $params = session_get_cookie_params();\n-    setcookie(session_name(), '', time() - 42000,\n-      $params[\"path\"], $params[\"domain\"],\n-      $params[\"secure\"], $params[\"httponly\"]);\n-  }\n } else {\n-  $msg = (Common::fetch_GET('msg',null)) ? Common::fetch_GET('msg',null) : 'logout' ;\n-  $url = \"login.php?msg=$msg\";\n-  session_start();\n-  if (isset($old_session['branding_logo'])) {\n-    $_SESSION['branding_logo'] = $old_session['branding_logo'];\n-  }\n-  if (isset($old_session['branding_logo.width'])) {\n-    $_SESSION['branding_logo.width'] = $old_session['branding_logo.width'];\n-  }\n-  if (isset($old_session['branding_logo.height'])) {\n-    $_SESSION['branding_logo.height'] = $old_session['branding_logo.height'];\n-  }\n-  if (isset($old_session['branding_name'])) {\n-    $_SESSION['branding_name'] = $old_session['branding_name'];\n-  }\n-  if (isset($old_session['branding_css'])) {\n-    $_SESSION['branding_css'] = $old_session['branding_css'];\n-  }\n-\n+    $msg = (Common::fetch_GET('msg', null)) ? Common::fetch_GET('msg', null) : 'logout' ;\n+    $url = \"login.php?msg=$msg\";\n+    session_start();\n+    if (isset($old_session['branding_logo'])) {\n+        $_SESSION['branding_logo'] = $old_session['branding_logo'];\n+    }\n+    if (isset($old_session['branding_logo.width'])) {\n+        $_SESSION['branding_logo.width'] = $old_session['branding_logo.width'];\n+    }\n+    if (isset($old_session['branding_logo.height'])) {\n+        $_SESSION['branding_logo.height'] = $old_session['branding_logo.height'];\n+    }\n+    if (isset($old_session['branding_name'])) {\n+        $_SESSION['branding_name'] = $old_session['branding_name'];\n+    }\n+    if (isset($old_session['branding_css'])) {\n+        $_SESSION['branding_css'] = $old_session['branding_css'];\n+    }\n }\n \n header(\"Location: $url\");\n-\n-?>"
        },
        {
          "filename": "src/module.php",
          "status": "modified",
          "additions": 42,
          "deletions": 30,
          "patch": "@@ -8,41 +8,53 @@\n  * @link https://github.com/webpa/webpa\n  */\n \n-require_once(\"includes/inc_global.php\");\n+require_once 'includes/inc_global.php';\n \n+use Doctrine\\DBAL\\ParameterType;\n use WebPA\\includes\\functions\\Common;\n \n if (($_source_id != '') && !$_user->is_admin()) {\n-  header('Location:'. APP__WWW .'/logout.php?msg=denied');\n-  exit;\n+    header('Location:'. APP__WWW .'/logout.php?msg=denied');\n+    exit;\n }\n \n $module_id = Common::fetch_POST('module_id');\n \n if ($module_id) {\n+    // Update last module\n+    $updateLastModuleQuery =\n+      'UPDATE ' . APP__DB_TABLE_PREFIX . 'user ' .\n+      'SET last_module_id = ? ' .\n+      'WHERE user_id = ?';\n \n-  // Update last module\n-  $sql_last_module = 'UPDATE ' . APP__DB_TABLE_PREFIX . \"user SET last_module_id = '{$module_id}' WHERE user_id = '{$_user_id}'\";\n-  $DB->execute($sql_last_module);\n+    $DB->getConnection()->executeQuery(\n+        $updateLastModuleQuery,\n+        [$module_id, $_user_id],\n+        [ParameterType::INTEGER, ParameterType::INTEGER]\n+    );\n \n-  // Update session\n-  $sql_module = 'SELECT module_code FROM ' . APP__DB_TABLE_PREFIX . \"module WHERE module_id = {$module_id}\";\n-  $module = $DB->fetch_row($sql_module);\n-  $_SESSION['_module_id'] = $module_id;\n-  $_SESSION['_user_context_id'] = $module['module_code'];\n+    // Update session\n+    $dbConn = $DB->getConnection();\n \n-  Common::logEvent($DB, 'Leave module', $_module_id);\n-  Common::logEvent($DB, 'Enter module', $module_id);\n+    $query = 'SELECT module_code FROM ' . APP__DB_TABLE_PREFIX . 'module WHERE module_id = ?';\n \n-  header('Location: ' . APP__WWW . \"/\");\n-  exit;\n+    $moduleCode = $dbConn->fetchOne($query, [$module_id], [ParameterType::INTEGER]);\n \n+    $_SESSION['_module_id'] = $module_id;\n+    $_SESSION['_user_context_id'] = $moduleCode;\n+\n+    Common::logEvent($DB, 'Leave module', $_module_id);\n+    Common::logEvent($DB, 'Enter module', $module_id);\n+\n+    header('Location: ' . APP__WWW . '/');\n+\n+    exit;\n }\n \n //set the page information\n $UI->page_title = 'Change Module';\n $UI->menu_selected = 'change module';\n-$UI->breadcrumbs = array ('home' => './', 'change source' => null);\n+$UI->breadcrumbs = ['home' => './', 'change source' => null];\n $UI->help_link = '?q=node/237';\n $UI->head();\n $UI->body();\n@@ -62,31 +74,31 @@\n <?php\n   //get the modules associated with the user being edited\n   if ($_user->is_admin()) {\n-    $modules = $CIS->get_user_modules(NULL, NULL, 'name');\n+      $modules = $CIS->get_user_modules(null, null, 'name');\n   } else {\n-    $modules = $CIS->get_user_modules($_user->id, NULL, 'name');\n+      $modules = $CIS->get_user_modules($_user->id, null, 'name');\n   }\n \n-    echo \"<table>\";\n+    echo '<table>';\n     if (count($modules) > 0) {\n-      foreach ($modules as $id => $module) {\n-        $checked_str = (isset($_module_id) && ($id == $_module_id)) ? ' checked=\"checked\"' : '' ;\n-        echo('<tr>');\n-        echo(\"  <td><input type=\\\"radio\\\" name=\\\"module_id\\\" id=\\\"module_{$id}\\\" value=\\\"{$id}\\\"{$checked_str} /></td>\");\n-        echo(\"  <td><label style=\\\"font-weight: normal;\\\" for=\\\"module_{$id}\\\">{$module['module_title']} [{$module['module_code']}]</label></td>\");\n-        echo('</tr>');\n-      }\n+        foreach ($modules as $id => $module) {\n+            $checked_str = (isset($_module_id) && ($id == $_module_id)) ? ' checked=\"checked\"' : '' ;\n+            echo '<tr>';\n+            echo \"  <td><input type=\\\"radio\\\" name=\\\"module_id\\\" id=\\\"module_{$id}\\\" value=\\\"{$id}\\\"{$checked_str} /></td>\";\n+            echo \"  <td><label style=\\\"font-weight: normal;\\\" for=\\\"module_{$id}\\\">{$module['module_title']} [{$module['module_code']}]</label></td>\";\n+            echo '</tr>';\n+        }\n     } else {\n-      echo('<tr>');\n-      echo('  <td colspan=\"2\">No modules</td>');\n-      echo('</tr>');\n+        echo '<tr>';\n+        echo '  <td colspan=\"2\">No modules</td>';\n+        echo '</tr>';\n     }\n ?>\n </table>\n </div>\n <?php\n   if (count($modules) > 0) {\n-?>\n+      ?>\n <p>\n <input type=\"submit\" value=\"Select module\" />\n </p>"
        },
        {
          "filename": "src/students/assessments/assessment_feedback.php",
          "status": "modified",
          "additions": 209,
          "deletions": 219,
          "patch": "@@ -8,16 +8,16 @@\n  * @link https://github.com/webpa/webpa\n  */\n \n-require_once(\"../../includes/inc_global.php\");\n+require_once '../../includes/inc_global.php';\n \n use WebPA\\includes\\classes\\AlgorithmFactory;\n use WebPA\\includes\\classes\\Assessment;\n use WebPA\\includes\\classes\\GroupHandler;\n use WebPA\\includes\\functions\\Common;\n \n-if (!Common::check_user($_user, APP__USER_TYPE_STUDENT)){\n-  header('Location:'. APP__WWW .'/logout.php?msg=denied');\n-  exit;\n+if (!Common::check_user($_user, APP__USER_TYPE_STUDENT)) {\n+    header('Location:'. APP__WWW .'/logout.php?msg=denied');\n+    exit;\n }\n \n // --------------------------------------------------------------------------------\n@@ -29,83 +29,83 @@\n \n // --------------------------------------------------------------------------------\n \n-function extract_max($input_array){\n-  return array_keys($input_array, max($input_array));\n-}\n+$extractMax = function ($input_array) {\n+    return array_keys($input_array, max($input_array));\n+};\n \n-function extract_min($input_array){\n-  return array_keys($input_array, min($input_array));\n-}\n+$extractMin = function ($input_array) {\n+    return array_keys($input_array, min($input_array));\n+};\n \n $assessment = new Assessment($DB);\n-if (!$assessment->load($assessment_id)) {\n-  $assessment = null;\n-  echo('Error: The requested assessment could not be loaded.');\n-  exit;\n-} else {\n-\n-  // ----------------------------------------\n-  // Get the marking parameters used for the marksheet this report will display\n-  // These are not used in this particular page anyway... we just need some dummy values\n \n-  $marking_params['weighting']= 100;\n-  $marking_params['penalty'] = 0;\n-  $marking_params['penalty_type'] = '%';\n-  $marking_params['tolerance'] = null;\n-  $marking_params['grading'] = 'numeric' ;\n-  $marking_params['algorithm'] = 'webpa';\n-\n-  // ----------------------------------------\n-  // Get a list of the groups, and their marks, used in this assessment\n-  $groups_and_marks = $assessment->get_group_marks();\n-\n-  // ----------------------------------------\n-  // Get the appropriate algorithm and calculate the grades\n-  $algorithm = AlgorithmFactory::get_algorithm($marking_params['algorithm']);\n-\n-  if (!$algorithm) {\n-    echo('Error: The requested algorithm could not be loaded.');\n+if (!$assessment->load($assessment_id)) {\n+    $assessment = null;\n+    echo 'Error: The requested assessment could not be loaded.';\n     exit;\n-  } else {\n-    $algorithm->set_grade_ordinals($ordinal_scale);\n-    $algorithm->set_assessment($assessment);\n-    $algorithm->set_marking_params($marking_params);\n-    $algorithm->calculate();\n-\n-    $submissions = $algorithm->get_submitters();\n-    $webpa_scores = $algorithm->get_webpa_scores();\n+}\n \n-    $intermediate_grades = $algorithm->get_intermediate_grades();\n-    $grades = $algorithm->get_grades();\n+  // ----------------------------------------\n+    // Get the marking parameters used for the marksheet this report will display\n+    // These are not used in this particular page anyway... we just need some dummy values\n+\n+    $marking_params['weighting']= 100;\n+    $marking_params['penalty'] = 0;\n+    $marking_params['penalty_type'] = '%';\n+    $marking_params['tolerance'] = null;\n+    $marking_params['grading'] = 'numeric' ;\n+    $marking_params['algorithm'] = 'webpa';\n+\n+    // ----------------------------------------\n+    // Get a list of the groups, and their marks, used in this assessment\n+    $groups_and_marks = $assessment->get_group_marks();\n+\n+    // ----------------------------------------\n+    // Get the appropriate algorithm and calculate the grades\n+    $algorithm = AlgorithmFactory::get_algorithm($marking_params['algorithm']);\n+\n+    if (!$algorithm) {\n+        echo 'Error: The requested algorithm could not be loaded.';\n+        exit;\n+    }\n+        $algorithm->set_grade_ordinals($ordinal_scale);\n+        $algorithm->set_assessment($assessment);\n+        $algorithm->set_marking_params($marking_params);\n+        $algorithm->calculate();\n \n-    $penalties = $algorithm->get_penalties();\n-    if (!$penalties) { $penalties = array(); }\n+        $submissions = $algorithm->get_submitters();\n+        $webpa_scores = $algorithm->get_webpa_scores();\n \n+        $intermediate_grades = $algorithm->get_intermediate_grades();\n+        $grades = $algorithm->get_grades();\n \n-    $questions = $algorithm->get_questions();\n+        $penalties = $algorithm->get_penalties();\n+        if (!$penalties) {\n+            $penalties = [];\n+        }\n \n-    $group_names = $algorithm->get_group_names();\n-    $group_members = $algorithm->get_group_members();\n-    $member_ids = array_keys($webpa_scores);\n+        $questions = $algorithm->get_questions();\n \n-    $member_names = array();\n+        $group_names = $algorithm->get_group_names();\n+        $group_members = $algorithm->get_group_members();\n+        $member_ids = array_keys($webpa_scores);\n \n-    for ($i =0; $i<count($group_members); $i++){\n-      $array_key = array_keys($group_members);\n-      $temp = $group_members[$array_key[$i]];\n-      for ($j=0; $j<count($temp);$j++){\n-        array_push($member_names, $CIS->get_user($temp[$j]));\n-      }\n-    }\n+        $member_names = [];\n \n-    $group_handler = new GroupHandler();\n-    $collection =& $group_handler->get_collection($assessment->get_collection_id());\n+        for ($i =0; $i<count($group_members); $i++) {\n+            $array_key = array_keys($group_members);\n+            $temp = $group_members[$array_key[$i]];\n+            for ($j=0; $j<count($temp);$j++) {\n+                array_push($member_names, $CIS->get_user($temp[$j]));\n+            }\n+        }\n \n-    $form = $assessment->get_form();\n+        $group_handler = new GroupHandler();\n+        $collection = $group_handler->get_collection($assessment->get_collection_id());\n \n-  }// /if-else(is algorithm)\n+        $form = $assessment->get_form();\n+    \n \n-}// /if-else(is assessment)\n \n \n $UI->page_title = APP__NAME . ' Feedback Report';\n@@ -127,184 +127,176 @@ function extract_min($input_array){\n \n \n \n-<h2><?php echo($assessment->name); ?></h2>\n+<h2><?php echo $assessment->name; ?></h2>\n <p style=\"margin-bottom: 2em;\">The following is based on your relative contribution in the group, measured from the self and peer assessment\n    <?php echo APP__MARK_TEXT; ?> only and does <b>not</b> take account of the overall group <?php echo APP__MARK_TEXT; ?> for the project.</p>\n </p>\n \n \n <?php\n-if ( (!$assessment) || (!$group_names) ) {\n-?>\n+if ((!$assessment) || (!$group_names)) {\n+    ?>\n   <div class=\"warning_box\">\n     <p style=\"font-weight: bold;\">WebPA could not generate feedback for your assessment.</p>\n     <p>There was a technical problem retrieving your information.</p>\n   </div>\n <?php\n } else {\n-  // ----------------------------------------\n-  // Get the group this user belongs to\n-  $group_id = null;\n-  if ($collection) {\n-    // Get the group this user belongs to\n-    $groups = $collection->get_member_groups($_user->id);\n-    if ($groups) {\n-      $group =& $groups[0];\n-      $group_id = $group->id;\n-    }\n-  }\n-\n-  $g_members = $group_members[$group_id];\n-  $member_count = count($group_members[$group_id]);\n-\n-  $question_count = count($questions);\n-\n-  $awarded_total = array();\n-\n-  foreach($questions as $question_id => $question ) {\n-\n-    $awarded_total[$question_id] = 0;\n-\n-    foreach($g_members as $i => $member_id) {\n-\n-      foreach($g_members as $j => $target_member_id) {\n-        //pull out the details for the one group member we are looking for\n-        if ($target_member_id == $_user->id){\n-          $awarded_marks[$question_id][$member_id]['mark_received'] = $algorithm->get_member_response($group_id, $member_id, $question_id, $target_member_id);\n-          $awarded_total[$question_id] +=  $algorithm->get_member_response($group_id, $member_id, $question_id, $target_member_id);\n+        // ----------------------------------------\n+        // Get the group this user belongs to\n+        $group_id = null;\n+        if ($collection) {\n+            // Get the group this user belongs to\n+            $groups = $collection->get_member_groups($_user->id);\n+            if ($groups) {\n+                $group =& $groups[0];\n+                $group_id = $group->id;\n+            }\n         }\n \n-      }\n+        $g_members = $group_members[$group_id];\n+        $member_count = count($group_members[$group_id]);\n \n-    }\n+        $question_count = count($questions);\n \n-  }\n+        $awarded_total = [];\n \n-  $match = 0;\n+        foreach ($questions as $question_id => $question) {\n+            $awarded_total[$question_id] = 0;\n \n-  for($q=0; $q<$question_count; $q++){\n-    if(!$q==0){\n-      if ($q == $question_count-1){\n-        if($awarded_marks[$q-1]== $awarded_marks[$q]){\n-          $match +=1;\n+            foreach ($g_members as $i => $member_id) {\n+                foreach ($g_members as $j => $target_member_id) {\n+                    //pull out the details for the one group member we are looking for\n+                    if ($target_member_id == $_user->id) {\n+                        $awarded_marks[$question_id][$member_id]['mark_received'] = $algorithm->get_member_response($group_id, $member_id, $question_id, $target_member_id);\n+                        $awarded_total[$question_id] +=  $algorithm->get_member_response($group_id, $member_id, $question_id, $target_member_id);\n+                    }\n+                }\n+            }\n         }\n-      }else{\n-        if($awarded_marks[$q]==$awarded_marks[$q+1]){\n-          $match +=1;\n-        }\n-      }\n-    }else{\n-      if($awarded_marks[$q]==$awarded_marks[$question_count-1]){\n-          $match +=1;\n-        }\n-    }\n-  }\n-\n-  for ($q=0; $q<$question_count; $q++){\n-    $min_score[$q] = min($awarded_marks[$q]);\n-    $max_score[$q] = max($awarded_marks[$q]);\n-\n-  }\n-\n-  //check to see if the answer are all the same for all questions\n-  if ($match==$question_count) {\n \n-    echo \"<p>Your group has <?php echo APP__MARK_TEXT; ?> everyone equally, hence we are unable to provide feedback on your relative performance for different assessment criteria.</p>\";\n-\n-  } else {\n-\n-    //get the fractional values and work out the greatest\n-    for ($question = 0; $question<$question_count; $question++){\n-      $max_score_per_question[$question] = ($max_score[$question]['mark_received'] / $awarded_total[$question])*4;\n-      $min_score_per_question[$question] = ($min_score[$question]['mark_received'] / $awarded_total[$question])*4;\n-    }\n-    //display best based on the normalised mark when there are more that 1-2 best criteria\n-    //extract_max which will return the array keys\n-    $returned_max = extract_max($max_score_per_question);\n-\n-    $msg_failure = '';\n-\n-    //check the returned is an array\n-    if (is_array($returned_max)) {\n-      $returned_max_count = count($returned_max);\n-\n-      if ($returned_max_count>1){\n-        //compare the two top marks\n-        if ($max_score[$returned_max[0]]['mark_received']==$max_score[$returned_max[1]]['mark_received']){\n-          //leave in incase we want to offer more than one result\n-          $element = $form->get_question($returned_max[0]);\n-          echo \"<h3>Your strongest contribution within this project was rated by your group as:</h3>\";\n-          echo \"<p><b>\" . $element['text']['_data'];\n-          echo \"</b><br/>\" . $element['desc']['_data'];\n-          echo \"</p>\";\n-        }else{\n-          $element = $form->get_question($returned_max[0]);\n-          echo \"<h3>Your strongest contribution within this project was rated by your group as:</h3>\";\n-          echo \"<p><b>\" . $element['text']['_data'];\n-          echo \"</b><br/>\" . $element['desc']['_data'];\n-          echo \"</p>\";\n+        $match = 0;\n+\n+        for ($q=0; $q<$question_count; $q++) {\n+            if (!$q==0) {\n+                if ($q == $question_count-1) {\n+                    if ($awarded_marks[$q-1]== $awarded_marks[$q]) {\n+                        $match +=1;\n+                    }\n+                } else {\n+                    if ($awarded_marks[$q]==$awarded_marks[$q+1]) {\n+                        $match +=1;\n+                    }\n+                }\n+            } else {\n+                if ($awarded_marks[$q]==$awarded_marks[$question_count-1]) {\n+                    $match +=1;\n+                }\n+            }\n         }\n-      }\n \n-    } else {\n-      $msg_failure = \"<p>WebPA has been unable to generate any feedback</p>\";\n-    }\n+        for ($q=0; $q<$question_count; $q++) {\n+            $min_score[$q] = min($awarded_marks[$q]);\n+            $max_score[$q] = max($awarded_marks[$q]);\n+        }\n \n-    echo \"<br/><br/>\";\n-\n-  //only display if the score is below the median and one mark below the others\n-  //No area for development should be identified if their lowest score is above the median AND\n-  //is greater than 80% of their highest score\n-\n-    $returned_min = extract_min($min_score_per_question);\n-    if (is_array($returned_min)) {\n-      $returned_min_count = count($returned_min);\n-\n-      if ($returned_min_count>1) {\n-        if ($min_score[$returned_min[0]]['mark_received']==$min_score[$returned_min[1]]['mark_received']) {\n-          $element = $form->get_question($returned_min[0]);\n-          $range = $element['range']['_data'];\n-          //split the string up\n-          $split_range = explode('-',$range);\n-          //calculate the median\n-          $median = round(($split_range[0]+$split_range[1])/2);\n-\n-          //compare to ensure that the lowest if below the median\n-          if ($min_score_per_question[$returned_min[0]]<$median) {\n-            echo \"<h3>An area you may wish to develop is your contribution to:</h3>\";\n-            echo \"<p><b>\" . $element['text']['_data'];\n-            echo \"</b><br/>\" . $element['desc']['_data'];\n-            echo \"</p>\";\n-          }\n+        //check to see if the answer are all the same for all questions\n+        if ($match==$question_count) {\n+            echo '<p>Your group has <?php echo APP__MARK_TEXT; ?> everyone equally, hence we are unable to provide feedback on your relative performance for different assessment criteria.</p>';\n         } else {\n-          $element = $form->get_question($returned_min[0]);\n-          echo \"<h3>An area you may wish to develop is your contribution to:</h3>\";\n-          echo \"<p><b>\" . $element['text']['_data'];\n-          echo \"</b><br/>\" . $element['desc']['_data'];\n-          echo \"</p>\";\n-        }\n-      } else {\n-        $element = $form->get_question($returned_min[0]);\n-        $range = $element['range']['_data'];\n-        //split the string up\n-        $split_range = explode('-',$range);\n-        //calculate the median\n-        $median = round(($split_range[0]+$split_range[1])/2);\n-\n-        //compare to ensure that the lowest if below the median\n-        if ($min_score_per_question[$returned_min[0]]<$median){\n-          echo \"<h3>An area you may wish to develop is your contribution to:</h3>\";\n-          echo \"<p><b>\" . $element['text']['_data'];\n-          echo \"</b><br/>\" . $element['desc']['_data'];\n-          echo \"</p>\";\n+\n+    //get the fractional values and work out the greatest\n+            for ($question = 0; $question<$question_count; $question++) {\n+                $max_score_per_question[$question] = ($max_score[$question]['mark_received'] / $awarded_total[$question])*4;\n+                $min_score_per_question[$question] = ($min_score[$question]['mark_received'] / $awarded_total[$question])*4;\n+            }\n+            //display best based on the normalised mark when there are more that 1-2 best criteria\n+            // extractMax which will return the array keys\n+            $returned_max = $extractMax($max_score_per_question);\n+\n+            $msg_failure = '';\n+\n+            //check the returned is an array\n+            if (is_array($returned_max)) {\n+                $returned_max_count = count($returned_max);\n+\n+                if ($returned_max_count>1) {\n+                    //compare the two top marks\n+                    if ($max_score[$returned_max[0]]['mark_received']==$max_score[$returned_max[1]]['mark_received']) {\n+                        //leave in incase we want to offer more than one result\n+                        $element = $form->get_question($returned_max[0]);\n+                        echo '<h3>Your strongest contribution within this project was rated by your group as:</h3>';\n+                        echo '<p><b>' . $element['text']['_data'];\n+                        echo '</b><br/>' . $element['desc']['_data'];\n+                        echo '</p>';\n+                    } else {\n+                        $element = $form->get_question($returned_max[0]);\n+                        echo '<h3>Your strongest contribution within this project was rated by your group as:</h3>';\n+                        echo '<p><b>' . $element['text']['_data'];\n+                        echo '</b><br/>' . $element['desc']['_data'];\n+                        echo '</p>';\n+                    }\n+                }\n+            } else {\n+                $msg_failure = '<p>WebPA has been unable to generate any feedback</p>';\n+            }\n+\n+            echo '<br/><br/>';\n+\n+            //only display if the score is below the median and one mark below the others\n+            //No area for development should be identified if their lowest score is above the median AND\n+            //is greater than 80% of their highest score\n+\n+            $returned_min = $extractMin($min_score_per_question);\n+\n+            if (is_array($returned_min)) {\n+                $returned_min_count = count($returned_min);\n+\n+                if ($returned_min_count>1) {\n+                    if ($min_score[$returned_min[0]]['mark_received']==$min_score[$returned_min[1]]['mark_received']) {\n+                        $element = $form->get_question($returned_min[0]);\n+                        $range = $element['range']['_data'];\n+                        //split the string up\n+                        $split_range = explode('-', $range);\n+                        //calculate the median\n+                        $median = round(($split_range[0]+$split_range[1])/2);\n+\n+                        //compare to ensure that the lowest if below the median\n+                        if ($min_score_per_question[$returned_min[0]]<$median) {\n+                            echo '<h3>An area you may wish to develop is your contribution to:</h3>';\n+                            echo '<p><b>' . $element['text']['_data'];\n+                            echo '</b><br/>' . $element['desc']['_data'];\n+                            echo '</p>';\n+                        }\n+                    } else {\n+                        $element = $form->get_question($returned_min[0]);\n+                        echo '<h3>An area you may wish to develop is your contribution to:</h3>';\n+                        echo '<p><b>' . $element['text']['_data'];\n+                        echo '</b><br/>' . $element['desc']['_data'];\n+                        echo '</p>';\n+                    }\n+                } else {\n+                    $element = $form->get_question($returned_min[0]);\n+                    $range = $element['range']['_data'];\n+                    //split the string up\n+                    $split_range = explode('-', $range);\n+                    //calculate the median\n+                    $median = round(($split_range[0]+$split_range[1])/2);\n+\n+                    //compare to ensure that the lowest if below the median\n+                    if ($min_score_per_question[$returned_min[0]]<$median) {\n+                        echo '<h3>An area you may wish to develop is your contribution to:</h3>';\n+                        echo '<p><b>' . $element['text']['_data'];\n+                        echo '</b><br/>' . $element['desc']['_data'];\n+                        echo '</p>';\n+                    }\n+                }\n+            } else {\n+                $msg_failure = '<p>WebPA has been unable to generate any feedback</p>';\n+            }\n         }\n-      }\n-    } else {\n-      $msg_failure = \"<p>WebPA has been unable to generate any feedback</p>\";\n+        echo \"  </div>\\n\";\n     }\n-  }\n-  echo \"  </div>\\n\";\n-}\n ?>\n <br />\n <form action=\"#\" method=\"post\" name=\"feedbackform\">\n@@ -317,5 +309,3 @@ function extract_min($input_array){\n <?php\n \n $UI->content_end(false, false, false);\n-\n-?>"
        },
        {
          "filename": "src/students/assessments/index.php",
          "status": "modified",
          "additions": 146,
          "deletions": 131,
          "patch": "@@ -8,17 +8,18 @@\n  * @link https://github.com/webpa/webpa\n  */\n \n-require_once(\"../../includes/inc_global.php\");\n+require_once '../../includes/inc_global.php';\n \n+use Doctrine\\DBAL\\ParameterType;\n use WebPA\\includes\\classes\\GroupHandler;\n use WebPA\\includes\\classes\\SimpleObjectIterator;\n use WebPA\\includes\\functions\\AcademicYear;\n use WebPA\\includes\\functions\\ArrayFunctions;\n use WebPA\\includes\\functions\\Common;\n \n-if (!Common::check_user($_user, APP__USER_TYPE_STUDENT)){\n-  header('Location:'. APP__WWW .'/logout.php?msg=denied');\n-  exit;\n+if (!Common::check_user($_user, APP__USER_TYPE_STUDENT)) {\n+    header('Location:'. APP__WWW .'/logout.php?msg=denied');\n+    exit;\n }\n \n // --------------------------------------------------------------------------------\n@@ -27,10 +28,9 @@\n \n // Get a list of collections that the user is a member of\n \n-$collections = $group_handler->get_member_collections($_user->id, APP__ID, 'assessment');\n+$collections = $group_handler->get_member_collections($_user->id, 'assessment');\n \n $collection_ids = ArrayFunctions::array_extract_column($collections, 'collection_id');\n-$collection_clause = $DB->build_set($collection_ids);\n \n // Get a list of assessments that match the user's collections (for this year)\n \n@@ -42,52 +42,69 @@\n $sql_start_date = date(MYSQL_DATETIME_FORMAT, $start_date);\n $sql_end_date = date(MYSQL_DATETIME_FORMAT, $end_date);\n \n-$assessments = $DB->fetch('SELECT a.* FROM ' . APP__DB_TABLE_PREFIX . 'assessment a ' .\n-                          \"WHERE (a.module_id = {$_module_id}) AND \" .\n-                                \"(a.collection_id IN $collection_clause) AND \" .\n-                                \"(a.open_date >= '{$sql_start_date}') AND \" .\n-                                \"(a.open_date < '{$sql_end_date}') \" .\n-                          'ORDER BY a.open_date, a.close_date, a.assessment_name');\n+$assessmentsQuery =\n+    'SELECT a.* FROM ' .\n+    APP__DB_TABLE_PREFIX . 'assessment a ' .\n+    'WHERE a.module_id = ? ' .\n+    'AND a.collection_id IN (?) ' .\n+    'AND a.open_date >= ? ' .\n+    'AND a.open_date < ? ' .\n+    'ORDER BY a.open_date, a.close_date, a.assessment_name';\n+\n+$assessments = $DB->getConnection()->fetchAllAssociative(\n+        $assessmentsQuery,\n+        [\n+            $_module_id,\n+            $collection_ids,\n+            $sql_start_date,\n+            $sql_end_date,\n+        ],\n+        [\n+            ParameterType::INTEGER,\n+            $DB->getConnection()::PARAM_STR_ARRAY,\n+            ParameterType::STRING,\n+            ParameterType::STRING,\n+        ]\n+);\n \n // Get a list of those assessments that the user has already taken\n \n-$assessment_ids = ArrayFunctions::array_extract_column($assessments, 'assessment_id');\n-$assessment_clause = $DB->build_set($assessment_ids);\n+$assessment_ids = array_column($assessments, 'assessment_id');\n \n-$assessments_with_response = $DB->fetch_col(\"\n-  SELECT DISTINCT assessment_id\n-  FROM \" . APP__DB_TABLE_PREFIX . \"user_mark\n-  WHERE (assessment_id IN {$assessment_clause})\n-    AND (user_id = {$_user->id})\n-  ORDER BY assessment_id\n-\");\n+$assessmentsWithResponseQuery =\n+    'SELECT DISTINCT assessment_id ' .\n+    'FROM ' . APP__DB_TABLE_PREFIX . 'user_mark ' .\n+    'WHERE assessment_id IN (?) ' .\n+    'AND user_id = ? ' .\n+    'ORDER BY assessment_id';\n+\n+$assessments_with_response = $DB->getConnection()->fetchFirstColumn($assessmentsWithResponseQuery, [$assessment_ids, $_user->id], [$DB->getConnection()::PARAM_INT_ARRAY, ParameterType::INTEGER]);\n \n // Split the assessments into pending, open and finished\n $pending_assessments = null;\n $open_assessments = null;\n $finished_assessments = null;\n \n if ($assessments) {\n-\n-  foreach($assessments as $i => $assessment) {\n-    if ( (is_array($assessments_with_response)) && (in_array($assessment['assessment_id'], $assessments_with_response)) ) {\n-      $finished_assessments[] = $assessment;\n-    } else {\n-      $now = time();\n-      $open_date = strtotime($assessment['open_date']);\n-      $close_date = strtotime($assessment['close_date']);\n-\n-      if ($close_date<=$now) {\n-        $finished_assessments[] = $assessment;\n-      } else {\n-        if ($open_date>$now) {\n-          $pending_assessments[] = $assessment;\n+    foreach ($assessments as $i => $assessment) {\n+        if ((is_array($assessments_with_response)) && (in_array($assessment['assessment_id'], $assessments_with_response))) {\n+            $finished_assessments[] = $assessment;\n         } else {\n-          $open_assessments[] = $assessment;\n+            $now = time();\n+            $open_date = strtotime($assessment['open_date']);\n+            $close_date = strtotime($assessment['close_date']);\n+\n+            if ($close_date<=$now) {\n+                $finished_assessments[] = $assessment;\n+            } else {\n+                if ($open_date>$now) {\n+                    $pending_assessments[] = $assessment;\n+                } else {\n+                    $open_assessments[] = $assessment;\n+                }\n+            }\n         }\n-      }\n     }\n-  }\n }\n \n // --------------------------------------------------------------------------------\n@@ -96,9 +113,9 @@\n $UI->page_title = APP__NAME . ' my assessments';\n $UI->menu_selected = 'my assessments';\n $UI->help_link = '?q=node/329';\n-$UI->breadcrumbs = array  (\n-                'my assessments'      => null ,\n-              );\n+$UI->breadcrumbs = [\n+                'my assessments'      => null,\n+              ];\n \n \n $UI->head();\n@@ -112,120 +129,118 @@\n <div class=\"content_box\">\n \n <?php\n-if ( (!$open_assessments) && (!$pending_assessments) && (!$finished_assessments) ) {\n-  echo('<p>You are not registered with any peer assessments in this module at the moment.</p>');\n+if ((!$open_assessments) && (!$pending_assessments) && (!$finished_assessments)) {\n+    echo '<p>You are not registered with any peer assessments in this module at the moment.</p>';\n } else {\n-  echo('<p>You are registered on the following peer assessments in this module:</p>');\n+    echo '<p>You are registered on the following peer assessments in this module:</p>';\n \n-  if ($open_assessments) {\n-?>\n+    if ($open_assessments) {\n+        ?>\n       <h2>Open Assessments</h2>\n       <p>These assessments are now open for you to take and record your group <?php echo APP__MARK_TEXT; ?>.</p>\n       <div class=\"form_section form_line\">\n <?php\n     $status = 'open';\n-    $status_capitalized = ucfirst($status);\n-\n-    $assessment_iterator = new SimpleObjectIterator($open_assessments,'Assessment', $DB);\n-    for ($assessment_iterator->reset(); $assessment_iterator->is_valid(); $assessment_iterator->next()) {\n-      $assessment =& $assessment_iterator->current();\n-      $take_url = \"take/index.php?a={$assessment->id}\";\n-\n-      echo(\"<div class=\\\"assessment_open\\\">\");\n-      echo('<table class=\"assessment_info\" cellpadding=\"0\" cellspacing=\"0\">');\n-      echo('<tr>');\n-      echo(\"  <td width=\\\"24\\\"><img src=\\\"../../images/icons/{$status}_icon.gif\\\" alt=\\\"$status_capitalized\\\" title=\\\"$status_capitalized\\\" height=\\\"24\\\" width=\\\"24\\\" /></td>\");\n-      echo('  <td valign=\"top\">');\n-      echo('    <div class=\"assessment_info\">');\n-      echo(\"      <div class=\\\"assessment_name\\\">{$assessment->name}</div>\");\n-      echo('      <div class=\"assessment_schedule\">scheduled: '. $assessment->get_date_string('open_date') .' &nbsp;-&nbsp; '. $assessment->get_date_string('close_date') . ' </div>');\n-      echo('    </div>');\n-      echo('  </td>');\n-      echo('  <td class=\"buttons\" style=\"line-height: 2em; text-align: right;\">');\n-      echo(\"    <a class=\\\"button\\\" href=\\\"$take_url\\\">Take Assessment</a>\");\n-      echo('  </td>');\n-      echo('</tr>');\n-      echo('</table>');\n-      echo('</div>');\n-    }\n-?>\n+        $status_capitalized = ucfirst($status);\n+\n+        $assessment_iterator = new SimpleObjectIterator($open_assessments, 'Assessment', $DB);\n+        for ($assessment_iterator->reset(); $assessment_iterator->is_valid(); $assessment_iterator->next()) {\n+            $assessment =& $assessment_iterator->current();\n+            $take_url = \"take/index.php?a={$assessment->id}\";\n+\n+            echo '<div class=\"assessment_open\">';\n+            echo '<table class=\"assessment_info\" cellpadding=\"0\" cellspacing=\"0\">';\n+            echo '<tr>';\n+            echo \"  <td width=\\\"24\\\"><img src=\\\"../../images/icons/{$status}_icon.gif\\\" alt=\\\"$status_capitalized\\\" title=\\\"$status_capitalized\\\" height=\\\"24\\\" width=\\\"24\\\" /></td>\";\n+            echo '  <td valign=\"top\">';\n+            echo '    <div class=\"assessment_info\">';\n+            echo \"      <div class=\\\"assessment_name\\\">{$assessment->name}</div>\";\n+            echo '      <div class=\"assessment_schedule\">scheduled: '. $assessment->get_date_string('open_date') .' &nbsp;-&nbsp; '. $assessment->get_date_string('close_date') . ' </div>';\n+            echo '    </div>';\n+            echo '  </td>';\n+            echo '  <td class=\"buttons\" style=\"line-height: 2em; text-align: right;\">';\n+            echo \"    <a class=\\\"button\\\" href=\\\"$take_url\\\">Take Assessment</a>\";\n+            echo '  </td>';\n+            echo '</tr>';\n+            echo '</table>';\n+            echo '</div>';\n+        } ?>\n       </div>\n <?php\n-  }\n-  if ($pending_assessments) {\n-?>\n+    }\n+    if ($pending_assessments) {\n+        ?>\n       <h2>Pending Assessments</h2>\n       <p>These assessments scheduled for some point in the future.</p>\n       <div class=\"form_section form_line\">\n <?php\n     $status = 'pending';\n-    $status_capitalized = ucfirst($status);\n-\n-    $assessment_iterator = new SimpleObjectIterator($pending_assessments,'Assessment', $DB);\n-    for ($assessment_iterator->reset(); $assessment_iterator->is_valid(); $assessment_iterator->next()) {\n-      $assessment =& $assessment_iterator->current();\n-      $take_url = \"take/index.php?a={$assessment->id}\";\n-\n-      echo(\"<div class=\\\"assessment\\\">\");\n-      echo('<table class=\"assessment_info\" cellpadding=\"0\" cellspacing=\"0\">');\n-      echo('<tr>');\n-      echo(\"  <td width=\\\"24\\\"><img src=\\\"../../images/icons/{$status}_icon.gif\\\" alt=\\\"$status_capitalized\\\" title=\\\"$status_capitalized\\\" height=\\\"24\\\" width=\\\"24\\\" /></td>\");\n-      echo('  <td valign=\"top\">');\n-      echo('    <div class=\"assessment_info\">');\n-      echo(\"      <div class=\\\"assessment_name\\\">{$assessment->name}</div>\");\n-      echo('      <div class=\"assessment_schedule\">scheduled: '. $assessment->get_date_string('open_date') .' &nbsp;-&nbsp; '. $assessment->get_date_string('close_date') . ' </div>');\n-      echo('    </div>');\n-      echo('  </td>');\n-      echo('</tr>');\n-      echo('</table>');\n-      echo('</div>');\n-    }\n-?>\n+        $status_capitalized = ucfirst($status);\n+\n+        $assessment_iterator = new SimpleObjectIterator($pending_assessments, 'Assessment', $DB);\n+        for ($assessment_iterator->reset(); $assessment_iterator->is_valid(); $assessment_iterator->next()) {\n+            $assessment =& $assessment_iterator->current();\n+            $take_url = \"take/index.php?a={$assessment->id}\";\n+\n+            echo '<div class=\"assessment\">';\n+            echo '<table class=\"assessment_info\" cellpadding=\"0\" cellspacing=\"0\">';\n+            echo '<tr>';\n+            echo \"  <td width=\\\"24\\\"><img src=\\\"../../images/icons/{$status}_icon.gif\\\" alt=\\\"$status_capitalized\\\" title=\\\"$status_capitalized\\\" height=\\\"24\\\" width=\\\"24\\\" /></td>\";\n+            echo '  <td valign=\"top\">';\n+            echo '    <div class=\"assessment_info\">';\n+            echo \"      <div class=\\\"assessment_name\\\">{$assessment->name}</div>\";\n+            echo '      <div class=\"assessment_schedule\">scheduled: '. $assessment->get_date_string('open_date') .' &nbsp;-&nbsp; '. $assessment->get_date_string('close_date') . ' </div>';\n+            echo '    </div>';\n+            echo '  </td>';\n+            echo '</tr>';\n+            echo '</table>';\n+            echo '</div>';\n+        } ?>\n       </div>\n <?php\n-  }\n+    }\n \n-  if ($finished_assessments) {\n-?>\n+    if ($finished_assessments) {\n+        ?>\n       <h2>Finished Assessments</h2>\n       <p>These assessments you have already taken, or which have passed their deadline for completion.</p>\n       <p>Some of your assessments may allow you to see feedback on your performance. Click <em>view feedback</em> (if available) for a particular assessment to see the feedback.</p>\n       <div class=\"form_section\">\n <?php\n     $status = 'finished';\n-    $status_capitalized = ucfirst($status);\n-\n-    $now = time();\n-\n-    $assessment_iterator = new SimpleObjectIterator($finished_assessments, 'Assessment', $DB);\n-    for ($assessment_iterator->reset(); $assessment_iterator->is_valid(); $assessment_iterator->next()) {\n-      $assessment =& $assessment_iterator->current();\n-      $take_url = \"take/index.php?a={$assessment->id}\";\n-\n-      $completed_msg = ( (is_array($assessments_with_response)) && (in_array($assessment->id, $assessments_with_response)) ) ? 'COMPLETED': 'DID NOT<br />SUBMIT';\n-\n-      echo(\"<div class=\\\"assessment_finished\\\">\");\n-      echo('<table class=\"assessment_info\" cellpadding=\"0\" cellspacing=\"0\">');\n-      echo('<tr>');\n-      echo(\"  <td width=\\\"24\\\"><img src=\\\"../../images/icons/{$status}_icon.gif\\\" alt=\\\"$status_capitalized\\\" title=\\\"$status_capitalized\\\" height=\\\"24\\\" width=\\\"24\\\" /></td>\");\n-      echo('  <td valign=\"top\">');\n-      echo('    <div class=\"assessment_info\">');\n-      echo(\"      <div class=\\\"assessment_name\\\">{$assessment->name}</div>\");\n-      echo('      <div class=\"assessment_schedule\">scheduled: '. $assessment->get_date_string('open_date') .' &nbsp;-&nbsp; '. $assessment->get_date_string('close_date') . ' </div>');\n-      echo('    </div>');\n-      echo('  </td>');\n-      echo('  <td style=\"font-weight: bold; text-align: center;\">');\n-      echo(\"    $completed_msg\");\n-      if ( ($assessment->allow_feedback) && ($assessment->close_date<$now) ) {\n-        echo(\"<div style=\\\"margin-top: 0.5em;\\\"><a href=\\\"assessment_feedback.php?a={$assessment->id}\\\" target=\\\"_blank\\\">view feedback</a></div>\");\n-      }\n-      echo('  </td>');\n-      echo('</tr>');\n-      echo('</table>');\n-      echo('</div>');\n+        $status_capitalized = ucfirst($status);\n+\n+        $now = time();\n+\n+        $assessment_iterator = new SimpleObjectIterator($finished_assessments, 'Assessment', $DB);\n+        for ($assessment_iterator->reset(); $assessment_iterator->is_valid(); $assessment_iterator->next()) {\n+            $assessment =& $assessment_iterator->current();\n+            $take_url = \"take/index.php?a={$assessment->id}\";\n+\n+            $completed_msg = ((is_array($assessments_with_response)) && (in_array($assessment->id, $assessments_with_response))) ? 'COMPLETED': 'DID NOT<br />SUBMIT';\n+\n+            echo '<div class=\"assessment_finished\">';\n+            echo '<table class=\"assessment_info\" cellpadding=\"0\" cellspacing=\"0\">';\n+            echo '<tr>';\n+            echo \"  <td width=\\\"24\\\"><img src=\\\"../../images/icons/{$status}_icon.gif\\\" alt=\\\"$status_capitalized\\\" title=\\\"$status_capitalized\\\" height=\\\"24\\\" width=\\\"24\\\" /></td>\";\n+            echo '  <td valign=\"top\">';\n+            echo '    <div class=\"assessment_info\">';\n+            echo \"      <div class=\\\"assessment_name\\\">{$assessment->name}</div>\";\n+            echo '      <div class=\"assessment_schedule\">scheduled: '. $assessment->get_date_string('open_date') .' &nbsp;-&nbsp; '. $assessment->get_date_string('close_date') . ' </div>';\n+            echo '    </div>';\n+            echo '  </td>';\n+            echo '  <td style=\"font-weight: bold; text-align: center;\">';\n+            echo \"    $completed_msg\";\n+            if (($assessment->allow_feedback) && ($assessment->close_date<$now)) {\n+                echo \"<div style=\\\"margin-top: 0.5em;\\\"><a href=\\\"assessment_feedback.php?a={$assessment->id}\\\" target=\\\"_blank\\\">view feedback</a></div>\";\n+            }\n+            echo '  </td>';\n+            echo '</tr>';\n+            echo '</table>';\n+            echo '</div>';\n+        }\n+        echo \"    </div>\\n\";\n     }\n-    echo(\"    </div>\\n\");\n-  }\n }\n ?>\n "
        },
        {
          "filename": "src/students/assessments/take/already_submitted.php",
          "status": "modified",
          "additions": 16,
          "deletions": 17,
          "patch": "@@ -8,14 +8,14 @@\n  * @link https://github.com/webpa/webpa\n  */\n \n-require_once(\"../../../includes/inc_global.php\");\n+require_once '../../../includes/inc_global.php';\n \n use WebPA\\includes\\classes\\Assessment;\n use WebPA\\includes\\functions\\Common;\n \n-if (!Common::check_user($_user, APP__USER_TYPE_STUDENT)){\n-  header('Location:'. APP__WWW .'/logout.php?msg=denied');\n-  exit;\n+if (!Common::check_user($_user, APP__USER_TYPE_STUDENT)) {\n+    header('Location:'. APP__WWW .'/logout.php?msg=denied');\n+    exit;\n }\n \n // --------------------------------------------------------------------------------\n@@ -29,22 +29,21 @@\n \n $assessment = new Assessment($DB);\n if ($assessment->load($assessment_id)) {\n-\n } else {\n-  $assessment = null;\n+    $assessment = null;\n }\n \n \n // --------------------------------------------------------------------------------\n // Begin Page\n \n-$UI->page_title = ($assessment) ? $assessment->name : \"already submitted\";\n+$UI->page_title = ($assessment) ? $assessment->name : 'already submitted';\n $UI->menu_selected = 'my assessments';\n $UI->help_link = '?q=node/329';\n \n-$UI->breadcrumbs = array  ('home'       => '/' ,\n-               $assessment->name  => null ,\n-              );\n+$UI->breadcrumbs = ['home'       => '/',\n+               $assessment->name  => null,\n+              ];\n $UI->head();\n $UI->content_start();\n ?>\n@@ -53,28 +52,28 @@\n \n <?php\n if (!$assessment) {\n-  ?>\n+    ?>\n   <div class=\"nav_button_bar\">\n-    <a href=\"<?php echo($list_url) ?>\"><img src=\"/images/buttons/arrow_green_left.gif\" alt=\"back -\"> back to assessments list</a>\n+    <a href=\"<?php echo $list_url ?>\"><img src=\"/images/buttons/arrow_green_left.gif\" alt=\"back -\"> back to assessments list</a>\n   </div>\n \n   <p>The assessment you selected could not be loaded for some reason - However, you have already submitted your <?php echo APP__MARK_TEXT; ?> for this assessment.</p>\n   <p>If the problem loading this assessment persists, please use the contact system to <a href=\"/students/support/contact/index.php?q=bug\">report the error</a>.</p>\n <?php\n } else {\n-?>\n+        ?>\n   <div class=\"nav_button_bar\">\n     <table cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">\n     <tr>\n-      <td><a href=\"<?php echo($list_url); ?>\"><img src=\"/images/buttons/arrow_green_left.gif\" alt=\"back -\"> back to assessments list</a></td>\n+      <td><a href=\"<?php echo $list_url; ?>\"><img src=\"/images/buttons/arrow_green_left.gif\" alt=\"back -\"> back to assessments list</a></td>\n     </tr>\n     </table>\n   </div>\n \n-  <p>You have already submitted your <?php echo APP__MARK_TEXT; ?> for this assessment: <?php echo($assessment->name); ?>.</p>\n-  <p>If you have another assessment to take, please select it from your <a href=\"<?php echo($list_url); ?>\">assessments list</a>.</p>\n+  <p>You have already submitted your <?php echo APP__MARK_TEXT; ?> for this assessment: <?php echo $assessment->name; ?>.</p>\n+  <p>If you have another assessment to take, please select it from your <a href=\"<?php echo $list_url; ?>\">assessments list</a>.</p>\n <?php\n-}\n+    }\n ?>\n </div>\n "
        },
        {
          "filename": "src/students/assessments/take/finished.php",
          "status": "modified",
          "additions": 15,
          "deletions": 16,
          "patch": "@@ -8,14 +8,14 @@\n  * @link https://github.com/webpa/webpa\n  */\n \n-require_once(\"../../../includes/inc_global.php\");\n+require_once '../../../includes/inc_global.php';\n \n use WebPA\\includes\\classes\\Assessment;\n use WebPA\\includes\\functions\\Common;\n \n-if (!Common::check_user($_user, APP__USER_TYPE_STUDENT)){\n-  header('Location:'. APP__WWW .'/logout.php?msg=denied');\n-  exit;\n+if (!Common::check_user($_user, APP__USER_TYPE_STUDENT)) {\n+    header('Location:'. APP__WWW .'/logout.php?msg=denied');\n+    exit;\n }\n \n // --------------------------------------------------------------------------------\n@@ -29,9 +29,8 @@\n \n $assessment = new Assessment($DB);\n if ($assessment->load($assessment_id)) {\n-\n } else {\n-  $assessment = null;\n+    $assessment = null;\n }\n \n // --------------------------------------------------------------------------------\n@@ -40,10 +39,10 @@\n $UI->page_title = APP__NAME . ' ' .  \"finished: $assessment->name\";\n $UI->menu_selected = 'my assessments';\n $UI->help_link = '?q=node/329';\n-$UI->breadcrumbs = array  (\n-  'home'             => '/' ,\n-  $assessment->name  => null ,\n-);\n+$UI->breadcrumbs = [\n+  'home'             => '/',\n+  $assessment->name  => null,\n+];\n \n $UI->head();\n $UI->content_start();\n@@ -53,28 +52,28 @@\n \n <?php\n if (!$assessment) {\n-?>\n+    ?>\n   <div class=\"nav_button_bar\">\n-    <a href=\"<?php echo($list_url) ?>\"><img src=\"../../../images/buttons/arrow_green_left.gif\" alt=\"back -\"> back to assessments list</a>\n+    <a href=\"<?php echo $list_url ?>\"><img src=\"../../../images/buttons/arrow_green_left.gif\" alt=\"back -\"> back to assessments list</a>\n   </div>\n \n   <p>The assessment you selected could not be loaded for some reason - Your <?php echo APP__MARK_TEXT; ?> for this assessment should have been saved so please check this from the <a href=\"../../\">my assessments</a> section.</p>\n   <p>If the problem persists, please use the contact system to <a href=\"../../support/contact/index.php?q=bug\">report the error</a>.</p>\n <?php\n } else {\n-?>\n+        ?>\n   <div class=\"nav_button_bar\">\n     <table cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">\n     <tr>\n-      <td><a href=\"<?php echo($list_url); ?>\"><img src=\"../../../images/buttons/arrow_green_left.gif\" alt=\"back -\"> back to assessments list</a></td>\n+      <td><a href=\"<?php echo $list_url; ?>\"><img src=\"../../../images/buttons/arrow_green_left.gif\" alt=\"back -\"> back to assessments list</a></td>\n     </tr>\n     </table>\n   </div>\n \n   <p>Thank you, your marks have now been saved.</p>\n-  <p>You can now check your <a href=\"../../\">assessments list</a> and take another assessment, or finish with WebPA and <a href=\"<?php echo APP__WWW;?>/logout.php\">logout</a>.</p>\n+  <p>You can now check your <a href=\"../../\">assessments list</a> and take another assessment, or finish with WebPA and <a href=\"<?php echo APP__WWW; ?>/logout.php\">logout</a>.</p>\n <?php\n-}\n+    }\n ?>\n </div>\n "
        },
        {
          "filename": "src/students/assessments/take/index.php",
          "status": "modified",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "src/students/assessments/take/not_open.php",
          "status": "modified",
          "additions": 15,
          "deletions": 16,
          "patch": null
        },
        {
          "filename": "src/students/groups/index.php",
          "status": "modified",
          "additions": 28,
          "deletions": 31,
          "patch": null
        },
        {
          "filename": "src/students/index.php",
          "status": "modified",
          "additions": 128,
          "deletions": 96,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/clone/index.php",
          "status": "modified",
          "additions": 7,
          "deletions": 7,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/create/class_wizardstep_1.php",
          "status": "modified",
          "additions": 107,
          "deletions": 104,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/create/class_wizardstep_2.php",
          "status": "modified",
          "additions": 50,
          "deletions": 45,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/create/class_wizardstep_3.php",
          "status": "modified",
          "additions": 27,
          "deletions": 31,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/create/class_wizardstep_4.php",
          "status": "modified",
          "additions": 35,
          "deletions": 28,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/create/class_wizardstep_5.php",
          "status": "modified",
          "additions": 100,
          "deletions": 98,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/create/class_wizardstep_6.php",
          "status": "modified",
          "additions": 23,
          "deletions": 23,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/create/index.php",
          "status": "modified",
          "additions": 19,
          "deletions": 19,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/delete_marks.php",
          "status": "modified",
          "additions": 68,
          "deletions": 53,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/edit/change_assessment_collection.php",
          "status": "modified",
          "additions": 74,
          "deletions": 76,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/edit/change_assessment_form.php",
          "status": "modified",
          "additions": 73,
          "deletions": 68,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/edit/edit_assessment.php",
          "status": "modified",
          "additions": 98,
          "deletions": 108,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/email/AssessmentNotificationTrait.php",
          "status": "modified",
          "additions": 4,
          "deletions": 8,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/email/ClosingReminder.php",
          "status": "modified",
          "additions": 18,
          "deletions": 14,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/email/TriggerReminder.php",
          "status": "modified",
          "additions": 17,
          "deletions": 14,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/email/class_wizardstep_1.php",
          "status": "modified",
          "additions": 41,
          "deletions": 31,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/email/class_wizardstep_2.php",
          "status": "modified",
          "additions": 105,
          "deletions": 98,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/email/class_wizardstep_3.php",
          "status": "modified",
          "additions": 58,
          "deletions": 51,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/email/class_wizardstep_4.php",
          "status": "modified",
          "additions": 79,
          "deletions": 68,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/email/index.php",
          "status": "modified",
          "additions": 34,
          "deletions": 34,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/inc_list_closed.php",
          "status": "modified",
          "additions": 57,
          "deletions": 38,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/inc_list_marked.php",
          "status": "modified",
          "additions": 93,
          "deletions": 75,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/inc_list_open.php",
          "status": "modified",
          "additions": 57,
          "deletions": 36,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/inc_list_pending.php",
          "status": "modified",
          "additions": 55,
          "deletions": 34,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/index.php",
          "status": "modified",
          "additions": 32,
          "deletions": 32,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/marks/mark_assessment.php",
          "status": "modified",
          "additions": 71,
          "deletions": 64,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/marks/set_group_marks.php",
          "status": "modified",
          "additions": 141,
          "deletions": 106,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/reports/index.php",
          "status": "modified",
          "additions": 110,
          "deletions": 110,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/reports/report_demo.php",
          "status": "modified",
          "additions": 148,
          "deletions": 150,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/reports/report_marks_awarded_byquestion_anonymous.php",
          "status": "modified",
          "additions": 198,
          "deletions": 189,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/reports/report_marks_awarded_byquestion_named.php",
          "status": "modified",
          "additions": 168,
          "deletions": 167,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/reports/report_student_feedback_bygroup.php",
          "status": "modified",
          "additions": 125,
          "deletions": 111,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/reports/report_student_grades.php",
          "status": "modified",
          "additions": 209,
          "deletions": 213,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/reports/report_student_grades_bygroup.php",
          "status": "modified",
          "additions": 221,
          "deletions": 232,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/reports/report_student_grades_comments.php",
          "status": "modified",
          "additions": 102,
          "deletions": 99,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/reports/report_student_response_info.php",
          "status": "modified",
          "additions": 178,
          "deletions": 179,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/reports/report_uea.php",
          "status": "modified",
          "additions": 171,
          "deletions": 183,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/reports/report_uea_anonymous.php",
          "status": "modified",
          "additions": 174,
          "deletions": 186,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/reports/students_who_responded.php",
          "status": "modified",
          "additions": 43,
          "deletions": 43,
          "patch": null
        },
        {
          "filename": "src/tutors/assessments/students_who_responded.php",
          "status": "modified",
          "additions": 42,
          "deletions": 42,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/clone/class_wizardstep_1.php",
          "status": "modified",
          "additions": 54,
          "deletions": 34,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/clone/class_wizardstep_2.php",
          "status": "modified",
          "additions": 44,
          "deletions": 34,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/clone/class_wizardstep_3.php",
          "status": "modified",
          "additions": 20,
          "deletions": 14,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/clone/clone_example.php",
          "status": "modified",
          "additions": 32,
          "deletions": 34,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/clone/index.php",
          "status": "modified",
          "additions": 15,
          "deletions": 15,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/create/class_wizardstep_1.php",
          "status": "modified",
          "additions": 21,
          "deletions": 16,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/create/class_wizardstep_2.php",
          "status": "modified",
          "additions": 57,
          "deletions": 48,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/create/index.php",
          "status": "modified",
          "additions": 15,
          "deletions": 15,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/edit/add_question/class_wizardstep_1.php",
          "status": "modified",
          "additions": 50,
          "deletions": 39,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/edit/add_question/class_wizardstep_2.php",
          "status": "modified",
          "additions": 57,
          "deletions": 47,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/edit/add_question/class_wizardstep_3.php",
          "status": "modified",
          "additions": 71,
          "deletions": 60,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/edit/add_question/index.php",
          "status": "modified",
          "additions": 41,
          "deletions": 41,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/edit/add_question/likert/class_wizardstep_1.php",
          "status": "modified",
          "additions": 51,
          "deletions": 36,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/edit/add_question/likert/class_wizardstep_2.php",
          "status": "modified",
          "additions": 57,
          "deletions": 47,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/edit/add_question/likert/class_wizardstep_3.php",
          "status": "modified",
          "additions": 71,
          "deletions": 60,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/edit/add_question/split100/class_wizardstep_1.php",
          "status": "modified",
          "additions": 47,
          "deletions": 32,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/edit/add_question/split100/class_wizardstep_2.php",
          "status": "modified",
          "additions": 59,
          "deletions": 50,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/edit/edit_form.php",
          "status": "modified",
          "additions": 60,
          "deletions": 81,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/edit/edit_question/class_wizardstep_1.php",
          "status": "modified",
          "additions": 69,
          "deletions": 51,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/edit/edit_question/class_wizardstep_2.php",
          "status": "modified",
          "additions": 65,
          "deletions": 56,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/edit/edit_question/class_wizardstep_3.php",
          "status": "modified",
          "additions": 60,
          "deletions": 48,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/edit/edit_question/index.php",
          "status": "modified",
          "additions": 36,
          "deletions": 36,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/edit/edit_question/likert/class_wizardstep_1.php",
          "status": "modified",
          "additions": 66,
          "deletions": 52,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/edit/edit_question/likert/class_wizardstep_2.php",
          "status": "modified",
          "additions": 65,
          "deletions": 62,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/edit/edit_question/likert/class_wizardstep_3.php",
          "status": "modified",
          "additions": 68,
          "deletions": 61,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/edit/edit_question/split100/class_wizardstep_1.php",
          "status": "modified",
          "additions": 49,
          "deletions": 43,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/edit/edit_question/split100/class_wizardstep_2.php",
          "status": "modified",
          "additions": 55,
          "deletions": 50,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/edit/preview_form.php",
          "status": "modified",
          "additions": 15,
          "deletions": 15,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/edit/question_action.php",
          "status": "modified",
          "additions": 19,
          "deletions": 20,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/export/export_form.php",
          "status": "modified",
          "additions": 11,
          "deletions": 8,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/import/import.php",
          "status": "modified",
          "additions": 93,
          "deletions": 61,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/import/index.php",
          "status": "modified",
          "additions": 7,
          "deletions": 7,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/import/xml_file.php",
          "status": "modified",
          "additions": 84,
          "deletions": 63,
          "patch": null
        },
        {
          "filename": "src/tutors/forms/index.php",
          "status": "modified",
          "additions": 47,
          "deletions": 36,
          "patch": null
        },
        {
          "filename": "src/tutors/groups/clone/class_wizardstep_1.php",
          "status": "modified",
          "additions": 65,
          "deletions": 56,
          "patch": null
        },
        {
          "filename": "src/tutors/groups/clone/class_wizardstep_2.php",
          "status": "modified",
          "additions": 51,
          "deletions": 40,
          "patch": null
        },
        {
          "filename": "src/tutors/groups/clone/class_wizardstep_3.php",
          "status": "modified",
          "additions": 68,
          "deletions": 58,
          "patch": null
        },
        {
          "filename": "src/tutors/groups/clone/index.php",
          "status": "modified",
          "additions": 14,
          "deletions": 14,
          "patch": null
        },
        {
          "filename": "src/tutors/groups/create/class_wizardstep_1.php",
          "status": "modified",
          "additions": 46,
          "deletions": 37,
          "patch": null
        },
        {
          "filename": "src/tutors/groups/create/class_wizardstep_2.php",
          "status": "modified",
          "additions": 35,
          "deletions": 31,
          "patch": null
        },
        {
          "filename": "src/tutors/groups/create/class_wizardstep_3.php",
          "status": "modified",
          "additions": 50,
          "deletions": 47,
          "patch": null
        },
        {
          "filename": "src/tutors/groups/create/class_wizardstep_4.php",
          "status": "modified",
          "additions": 32,
          "deletions": 29,
          "patch": null
        },
        {
          "filename": "src/tutors/groups/create/class_wizardstep_x.php",
          "status": "modified",
          "additions": 40,
          "deletions": 36,
          "patch": null
        },
        {
          "filename": "src/tutors/groups/create/index.php",
          "status": "modified",
          "additions": 16,
          "deletions": 16,
          "patch": null
        },
        {
          "filename": "src/tutors/groups/edit/edit_collection.php",
          "status": "modified",
          "additions": 49,
          "deletions": 53,
          "patch": null
        },
        {
          "filename": "src/tutors/groups/edit/edit_collection_groups.php",
          "status": "modified",
          "additions": 45,
          "deletions": 45,
          "patch": null
        },
        {
          "filename": "src/tutors/groups/edit/edit_collection_members.php",
          "status": "modified",
          "additions": 51,
          "deletions": 53,
          "patch": null
        },
        {
          "filename": "src/tutors/groups/edit/edit_group.php",
          "status": "modified",
          "additions": 116,
          "deletions": 120,
          "patch": null
        },
        {
          "filename": "src/tutors/groups/edit/index.php",
          "status": "modified",
          "additions": 23,
          "deletions": 23,
          "patch": null
        },
        {
          "filename": "src/tutors/groups/index.php",
          "status": "modified",
          "additions": 20,
          "deletions": 23,
          "patch": null
        },
        {
          "filename": "src/tutors/index.php",
          "status": "modified",
          "additions": 6,
          "deletions": 6,
          "patch": null
        }
      ],
      "file_patterns": {
        "security_files": 4,
        "config_files": 2,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 53,
        "max_directory_depth": 6
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "9d99f460ede7e82d80c3f1d39a64bdbaa023728f",
            "date": "2023-05-23T15:13:05Z",
            "author_login": "Sephster"
          },
          {
            "sha": "e5b7029610298bd911a6a3330e81c12ac907550a",
            "date": "2023-05-11T14:17:40Z",
            "author_login": "Sephster"
          },
          {
            "sha": "359caa7921a77c007a406ae254c2e6e1b73ffdb8",
            "date": "2023-04-05T11:22:51Z",
            "author_login": "Sephster"
          },
          {
            "sha": "d7f85b9cae7a74357a13ff8b6748b4e98ce83296",
            "date": "2023-04-05T11:01:01Z",
            "author_login": "Sephster"
          },
          {
            "sha": "aea03603841f6a60befc1b750e4b893b27913648",
            "date": "2023-04-05T08:58:36Z",
            "author_login": "Sephster"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 5.5,
    "cvss_vector": "CVSS:3.1/AV:A/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L",
    "cwe_id": "CWE-89",
    "description": "A vulnerability was found in WebPA up to 3.1.1. It has been rated as critical. This issue affects some unknown processing. The manipulation leads to sql injection. Upgrading to version 3.1.2 is able to address this issue. The identifier of the patch is 8836c4f549181e885a68e0e7ca561fdbcbd04bf0. It is recommended to upgrade the affected component. The identifier VDB-217637 was assigned to this vulnerability.",
    "attack_vector": "ADJACENT_NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-01-08T10:15:11.903",
    "last_modified": "2024-11-21T06:37:22.680",
    "fix_date": "2021-04-22T11:56:26Z"
  },
  "references": [
    {
      "url": "https://github.com/WebPA/WebPA/commit/8836c4f549181e885a68e0e7ca561fdbcbd04bf0",
      "source": "cna@vuldb.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/WebPA/WebPA/pull/87",
      "source": "cna@vuldb.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/WebPA/WebPA/releases/tag/v3.1.2",
      "source": "cna@vuldb.com",
      "tags": [
        "Release Notes"
      ]
    },
    {
      "url": "https://vuldb.com/?ctiid.217637",
      "source": "cna@vuldb.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://vuldb.com/?id.217637",
      "source": "cna@vuldb.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/WebPA/WebPA/commit/8836c4f549181e885a68e0e7ca561fdbcbd04bf0",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/WebPA/WebPA/pull/87",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/WebPA/WebPA/releases/tag/v3.1.2",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes"
      ]
    },
    {
      "url": "https://vuldb.com/?ctiid.217637",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://vuldb.com/?id.217637",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:04:43.530491",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "WebPA",
    "owner": "WebPA",
    "created_at": "2014-04-01T16:14:55Z",
    "updated_at": "2024-12-19T00:06:56Z",
    "pushed_at": "2023-06-30T15:03:55Z",
    "size": 1695,
    "stars": 35,
    "forks": 29,
    "open_issues": 54,
    "watchers": 35,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "PHP": 997835,
      "CSS": 32349
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "gpl-3.0"
    },
    "collected_at": "2025-01-14T16:56:32.124205"
  }
}