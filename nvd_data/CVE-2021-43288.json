{
  "cve_id": "CVE-2021-43288",
  "github_data": {
    "repository": "gocd/gocd",
    "fix_commit": "f5c1d2aa9ab302a97898a6e4b16218e64fe8e9e4",
    "related_commits": [
      "f5c1d2aa9ab302a97898a6e4b16218e64fe8e9e4",
      "f5c1d2aa9ab302a97898a6e4b16218e64fe8e9e4"
    ],
    "patch_url": "https://github.com/gocd/gocd/commit/f5c1d2aa9ab302a97898a6e4b16218e64fe8e9e4.patch",
    "fix_commit_details": {
      "sha": "f5c1d2aa9ab302a97898a6e4b16218e64fe8e9e4",
      "commit_date": "2021-10-19T09:23:51Z",
      "author": {
        "login": "arvindsv",
        "type": "User",
        "stats": {
          "total_commits": 968,
          "average_weekly_commits": 1.6689655172413793,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 200
        }
      },
      "commit_message": {
        "title": "#000 - Escape filenames in artifact tab",
        "length": 39,
        "has_description": false,
        "references_issue": true
      },
      "stats": {
        "total": 101,
        "additions": 95,
        "deletions": 6
      },
      "files": [
        {
          "filename": "common/build.gradle",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -26,6 +26,7 @@ dependencies {\n   api project.deps.dom4j\n   api project.deps.apacheHttpMime\n   api project.deps.commonsCollections4\n+  api project.deps.commonsText\n   api project.deps.springTx\n   implementation project.deps.jodaTime\n   annotationProcessor project.deps.lombok"
        },
        {
          "filename": "common/src/main/java/com/thoughtworks/go/domain/DirectoryEntries.java",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -33,7 +33,7 @@ public class DirectoryEntries extends ArrayList<DirectoryEntry> implements HtmlR\n     @Override\n     public void render(HtmlRenderer renderer) {\n         if (isArtifactsDeleted || isEmpty()) {\n-            HtmlElement element = p().content(\"Artifacts for this job instance are unavailable as they may have been <a href='\" +\n+            HtmlElement element = p().unsafecontent(\"Artifacts for this job instance are unavailable as they may have been <a href='\" +\n                     CurrentGoCDVersion.docsUrl(\"configuration/delete_artifacts.html\") +\n                     \"' target='blank'>purged by Go</a> or deleted externally. \"\n                     + \"Re-run the stage or job to generate them again.\");"
        },
        {
          "filename": "common/src/main/java/com/thoughtworks/go/domain/FileDirectoryEntry.java",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -30,7 +30,7 @@ protected HtmlRenderable htmlBody() {\n         return HtmlElement.li().content(\n             HtmlElement.span(HtmlAttribute.cssClass(\"artifact\")).content(\n                 HtmlElement.a(HtmlAttribute.href(getUrl()))\n-                        .content(getFileName())\n+                        .safecontent(getFileName())\n             )\n         );\n "
        },
        {
          "filename": "common/src/main/java/com/thoughtworks/go/domain/FolderDirectoryEntry.java",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -41,7 +41,7 @@ protected HtmlRenderable htmlBody() {\n                 HtmlElement.div(cssClass(\"dir-container\")).content(\n                     HtmlElement.span(cssClass(\"directory\")).content(\n                         HtmlElement.a(onclick(\"BuildDetail.tree_navigator(this)\"))\n-                                .content(getFileName())\n+                                .safecontent(getFileName())\n                     )\n                 ),\n                 HtmlElement.div(cssClass(\"subdir-container\"), style(\"display:none\"))"
        },
        {
          "filename": "common/src/main/java/com/thoughtworks/go/server/presentation/html/HtmlElement.java",
          "status": "modified",
          "additions": 6,
          "deletions": 2,
          "patch": "@@ -19,6 +19,7 @@\n import java.util.List;\n \n import com.thoughtworks.go.server.presentation.models.HtmlRenderer;\n+import org.apache.commons.text.StringEscapeUtils;\n \n public class HtmlElement implements HtmlRenderable {\n     public static HtmlElement div(HtmlAttribute... attributes) { return new HtmlElement(\"div\", attributes); }\n@@ -37,10 +38,14 @@ private HtmlElement(String elementName, HtmlAttribute... attributes) {\n         this.attributes = attributes;\n     }\n \n-    public HtmlElement content(String body) {\n+    public HtmlElement unsafecontent(String body) {\n         return content(new TextElement(body));\n     }\n \n+    public HtmlElement safecontent(String body) {\n+        return content(new TextElement(StringEscapeUtils.escapeHtml4(body)));\n+    }\n+\n     public HtmlElement content(HtmlRenderable... elements) {\n         for (HtmlRenderable element : elements) {\n             addToBody(element);\n@@ -80,5 +85,4 @@ public void render(HtmlRenderer renderer) {\n             renderer.append(\"</\" + elementName + \">\\n\");\n         }\n     }\n-\n }"
        },
        {
          "filename": "common/src/test/java/com/thoughtworks/go/domain/FileDirectoryEntryTest.java",
          "status": "added",
          "additions": 34,
          "deletions": 0,
          "patch": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2021 ThoughtWorks, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.thoughtworks.go.domain;\n+\n+import com.thoughtworks.go.server.presentation.models.HtmlRenderer;\n+import org.junit.jupiter.api.Test;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+class FileDirectoryEntryTest {\n+    @Test\n+    void shouldEscapeFilename() {\n+        FileDirectoryEntry entry = new FileDirectoryEntry(\"<div>Hello</div>\", \"https://www.example.com\");\n+        HtmlRenderer renderer = new HtmlRenderer(\"\");\n+        entry.htmlBody().render(renderer);\n+\n+        assertTrue(renderer.asString().contains(\"&lt;div&gt;Hello&lt;/div&gt;\"));\n+        assertFalse(renderer.asString().contains(\"<div>Hello</div>\"));\n+    }\n+}\n\\ No newline at end of file"
        },
        {
          "filename": "common/src/test/java/com/thoughtworks/go/domain/FolderDirectoryEntryTest.java",
          "status": "modified",
          "additions": 14,
          "deletions": 1,
          "patch": "@@ -15,10 +15,11 @@\n  */\n package com.thoughtworks.go.domain;\n \n+import com.thoughtworks.go.server.presentation.models.HtmlRenderer;\n import org.junit.jupiter.api.Test;\n \n-import static org.hamcrest.Matchers.hasItem;\n import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.*;\n \n public class FolderDirectoryEntryTest {\n     @Test\n@@ -28,4 +29,16 @@ public void shouldAddFile() throws Exception {\n         entry.addFile(\"file\", \"path\");\n         assertThat(subDirectory, hasItem(new FileDirectoryEntry(\"file\", \"path\")));\n     }\n+\n+    @Test\n+    public void shouldEscapeFolderName() throws Exception {\n+        DirectoryEntries subDirectory = new DirectoryEntries();\n+        FolderDirectoryEntry entry = new FolderDirectoryEntry(\"<div>Hello</div>\", \"url\", subDirectory);\n+\n+        HtmlRenderer renderer = new HtmlRenderer(\"\");\n+        entry.htmlBody().render(renderer);\n+\n+        assertThat(renderer.asString(), containsString(\"&lt;div&gt;Hello&lt;/div&gt;\"));\n+        assertThat(renderer.asString(), not(containsString(\"<div>Hello</div>\")));\n+    }\n }"
        },
        {
          "filename": "common/src/test/java/com/thoughtworks/go/server/presentation/html/HtmlElementTest.java",
          "status": "added",
          "additions": 34,
          "deletions": 0,
          "patch": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2021 ThoughtWorks, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.thoughtworks.go.server.presentation.html;\n+\n+import com.thoughtworks.go.server.presentation.models.HtmlRenderer;\n+import org.junit.jupiter.api.Test;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+class HtmlElementTest {\n+    @Test\n+    void shouldEscapeContent() {\n+        HtmlElement element = HtmlElement.span().safecontent(\"<div>Hello</div>\");\n+        HtmlRenderer renderer = new HtmlRenderer(\"\");\n+\n+        element.render(renderer);\n+\n+        assertEquals(\"<span>\\n&lt;div&gt;Hello&lt;/div&gt;\\n</span>\\n\", renderer.asString());\n+    }\n+}\n\\ No newline at end of file"
        },
        {
          "filename": "dependencies.gradle",
          "status": "modified",
          "additions": 2,
          "deletions": 0,
          "patch": "@@ -48,6 +48,7 @@ final Map<String, String> libraries = [\n   commonsLang         : 'commons-lang:commons-lang:2.6',\n   commonsLang3        : 'org.apache.commons:commons-lang3:3.12.0',\n   commonsPool         : 'org.apache.commons:commons-pool2:2.11.1',\n+  commonsText         : 'org.apache.commons:commons-text:1.8',\n   dbunit              : 'org.dbunit:dbunit:2.7.2',\n   dom4j               : 'dom4j:dom4j:1.6.1',\n   ehcache             : 'net.sf.ehcache:ehcache:2.10.9.2',\n@@ -131,6 +132,7 @@ final Map<String, String> v = [\n   commonsLang         : versionOf(libraries.commonsLang),\n   commonsLang3        : versionOf(libraries.commonsLang3),\n   commonsPool         : versionOf(libraries.commonsPool),\n+  commonsText         : versionOf(libraries.commonsText),\n   dom4j               : versionOf(libraries.dom4j),\n   ehcache             : versionOf(libraries.ehcache),\n   felix               : versionOf(libraries.felix),"
        },
        {
          "filename": "server/build.gradle",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -817,6 +817,7 @@ task verifyWar(type: VerifyJarTask) {\n         \"commons-io-${project.versions.commonsIO}.jar\",\n         \"commons-lang-${project.versions.commonsLang}.jar\",\n         \"commons-lang3-${project.versions.commonsLang3}.jar\",\n+        \"commons-text-${project.versions.commonsText}.jar\",\n         \"commons-pool2-${project.versions.commonsPool}.jar\",\n         \"config-api-${project.version}.jar\",\n         \"config-server-${project.version}.jar\","
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 3,
        "unique_directories": 7,
        "max_directory_depth": 10
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "745b8846335e2d352bd17223122b3585ba63bc18",
            "date": "2025-01-14T11:10:03Z",
            "author_login": "chadlwilson"
          },
          {
            "sha": "7e0e0c87401d8ce8d76c651194e9165523416037",
            "date": "2025-01-14T11:09:46Z",
            "author_login": "chadlwilson"
          },
          {
            "sha": "99aa6ecc886d9c30f79601e30c06224112da3045",
            "date": "2025-01-14T11:09:29Z",
            "author_login": "chadlwilson"
          },
          {
            "sha": "6e87477e6527985cddd634b48bd3505be1079d4d",
            "date": "2025-01-14T11:09:11Z",
            "author_login": "chadlwilson"
          },
          {
            "sha": "90fccf4ddc5b1641b3fcaadd6eaeff34501aefb6",
            "date": "2025-01-14T10:44:32Z",
            "author_login": "dependabot[bot]"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 5.4,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N",
    "cwe_id": "CWE-79",
    "description": "An issue was discovered in ThoughtWorks GoCD before 21.3.0. An attacker in control of a GoCD Agent can plant malicious JavaScript into a failed Job Report.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2022-04-14T13:15:11.460",
    "last_modified": "2024-11-21T06:29:00.610",
    "fix_date": "2021-10-19T09:23:51Z"
  },
  "references": [
    {
      "url": "https://blog.sonarsource.com/gocd-vulnerability-chain",
      "source": "cve@mitre.org",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/gocd/gocd/commit/f5c1d2aa9ab302a97898a6e4b16218e64fe8e9e4",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.gocd.org/releases/#21-3-0",
      "source": "cve@mitre.org",
      "tags": [
        "Issue Tracking",
        "Release Notes",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://blog.sonarsource.com/gocd-vulnerability-chain",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/gocd/gocd/commit/f5c1d2aa9ab302a97898a6e4b16218e64fe8e9e4",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.gocd.org/releases/#21-3-0",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Issue Tracking",
        "Release Notes",
        "Vendor Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:03:04.381804",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "gocd",
    "owner": "gocd",
    "created_at": "2013-12-13T05:26:16Z",
    "updated_at": "2025-01-14T12:47:48Z",
    "pushed_at": "2025-01-14T11:10:10Z",
    "size": 393992,
    "stars": 7159,
    "forks": 972,
    "open_issues": 82,
    "watchers": 7159,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "master"
    ],
    "languages": {
      "Java": 20251061,
      "TypeScript": 4424594,
      "Groovy": 2080119,
      "JavaScript": 753678,
      "SCSS": 564746,
      "Ruby": 364252,
      "HTML": 253777,
      "XSLT": 202698,
      "NSIS": 24216,
      "Shell": 15469,
      "FreeMarker": 13061,
      "EJS": 1626,
      "CSS": 1575,
      "Batchfile": 474
    },
    "commit_activity": {
      "total_commits_last_year": 1743,
      "avg_commits_per_week": 33.51923076923077,
      "days_active_last_year": 299
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "apache-2.0"
    },
    "collected_at": "2025-01-14T13:11:02.445502"
  }
}