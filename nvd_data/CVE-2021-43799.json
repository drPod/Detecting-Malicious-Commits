{
  "cve_id": "CVE-2021-43799",
  "github_data": {
    "repository": "zulip/zulip",
    "fix_commit": "a5496f4098e3998c9b84e8dc564aa983d6cdf6e8",
    "related_commits": [
      "a5496f4098e3998c9b84e8dc564aa983d6cdf6e8",
      "a5496f4098e3998c9b84e8dc564aa983d6cdf6e8"
    ],
    "patch_url": "https://github.com/zulip/zulip/commit/a5496f4098e3998c9b84e8dc564aa983d6cdf6e8.patch",
    "fix_commit_details": {
      "sha": "a5496f4098e3998c9b84e8dc564aa983d6cdf6e8",
      "commit_date": "2021-12-07T20:55:38Z",
      "author": {
        "login": "alexmv",
        "type": "User",
        "stats": {
          "total_commits": 2383,
          "average_weekly_commits": 3.6831530139103554,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 206
        }
      },
      "commit_message": {
        "title": "CVE-2021-43799: Set a secure Erlang cookie.",
        "length": 1288,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 64,
        "additions": 61,
        "deletions": 3
      },
      "files": [
        {
          "filename": "docs/overview/changelog.md",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -121,6 +121,7 @@ log][commit-log] for an up-to-date list of raw changes.\n \n ## Zulip 4.x series\n \n+- CVE-2021-43799: Remote execution of code involving RabbitMQ.\n - Closed access to RabbitMQ port 25672; initial installs tried to\n   close this port, but failed to restart RabbitMQ for the\n   configuration."
        },
        {
          "filename": "scripts/lib/upgrade-zulip-stage-2",
          "status": "modified",
          "additions": 29,
          "deletions": 3,
          "patch": "@@ -13,7 +13,7 @@ import re\n import subprocess\n import sys\n import time\n-from typing import TYPE_CHECKING\n+from typing import TYPE_CHECKING, Optional\n \n if TYPE_CHECKING:\n     from typing import NoReturn\n@@ -116,15 +116,31 @@ IS_SERVER_UP = True\n \n # Check if rabbitmq port 25672 is listening on anything except 127.0.0.1\n rabbitmq_dist_listen = listening_publicly(25672)\n+# Check the erlang magic cookie size\n+cookie_size: Optional[int] = None\n+if os.path.exists(\"/var/lib/rabbitmq/.erlang.cookie\"):\n+    with open(\"/var/lib/rabbitmq/.erlang.cookie\", \"r\") as cookie_fh:\n+        cookie_size = len(cookie_fh.readline())\n+else:\n+    logging.info(\"No RabbitMQ erlang cookie found, not auditing RabbitMQ security.\")\n if args.skip_puppet and rabbitmq_dist_listen:\n     logging.error(\n         \"RabbitMQ is publicly-accessible on %s; this is a security vulnerability!\",\n         \", \".join(rabbitmq_dist_listen),\n     )\n+    issue = \"issue\"\n+    if cookie_size is not None and cookie_size == 20:\n+        # See the below comment -- this is used as a lightweight\n+        # signal for a cookie made with Erlang's bad randomizer.\n+        logging.error(\n+            \"RabbitMQ erlang cookie is insecure; this is a critical security vulnerability!\"\n+        )\n+        issue = \"issues\"\n     logging.error(\n-        \"To fix the above security issue, re-run the upgrade without --skip-puppet \"\n+        \"To fix the above security %s, re-run the upgrade without --skip-puppet \"\n         \"(which may be set in /etc/zulip/zulip.conf), in order to restart the \"\n-        \"necessary services.  Running zulip-puppet-apply by itself is not sufficient.\"\n+        \"necessary services.  Running zulip-puppet-apply by itself is not sufficient.\",\n+        issue,\n     )\n     sys.exit(1)\n \n@@ -304,6 +320,16 @@ if rabbitmq_dist_listen:\n     logging.info(\"Shutting down rabbitmq to adjust its ports...\")\n     subprocess.check_call([\"/usr/sbin/service\", \"rabbitmq-server\", \"stop\"])\n \n+if cookie_size is not None and cookie_size == 20:\n+    # Checking for a 20-character cookie is used as a signal that it\n+    # was generated by Erlang's insecure randomizer, which only\n+    # provides between 20 and 36 bits of entropy; were it 20\n+    # characters long by a good randomizer, it would be 96 bits and\n+    # more than sufficient.  We generate, using good randomness, a\n+    # 255-character cookie, the max allowed length.\n+    logging.info(\"Generating a secure erlang cookie...\")\n+    subprocess.check_call([\"./scripts/setup/generate-rabbitmq-cookie\"])\n+\n # Adjust Puppet class names for the manifest renames in the 4.0 release\n class_renames = {\n     \"zulip::app_frontend\": \"zulip::profile::app_frontend\","
        },
        {
          "filename": "scripts/setup/configure-rabbitmq",
          "status": "modified",
          "additions": 4,
          "deletions": 0,
          "patch": "@@ -10,6 +10,10 @@ else\n     sudo=(sudo)\n fi\n \n+# If the RabbitMQ distribution cookie is insecure, reset it and\n+# restart RabbitMQ.\n+\"${sudo[@]}\" \"$(dirname \"$0\")/generate-rabbitmq-cookie\"\n+\n RABBITMQ_USERNAME=$(\"$(dirname \"$0\")/../get-django-setting\" RABBITMQ_USERNAME)\n RABBITMQ_PASSWORD=$(\"$(dirname \"$0\")/../get-django-setting\" RABBITMQ_PASSWORD)\n "
        },
        {
          "filename": "scripts/setup/generate-rabbitmq-cookie",
          "status": "added",
          "additions": 27,
          "deletions": 0,
          "patch": "@@ -0,0 +1,27 @@\n+#!/usr/bin/env bash\n+#\n+# rabbitmq sets an insecure \"magic cookie\" which is used for auth;\n+# reset it to be longer.\n+set -eu\n+\n+cookiefile=/var/lib/rabbitmq/.erlang.cookie\n+# If the RabbitMQ distribution cookie is insecure, reset it\n+if [ ! -f \"$cookiefile\" ] || ! size=\"$(wc -c \"$cookiefile\")\" || [ \"${size%% *}\" -le 20 ]; then\n+    running=0\n+    if service rabbitmq-server status >/dev/null; then\n+        running=1\n+        service rabbitmq-server stop\n+    fi\n+\n+    echo \"Setting a more secure RabbitMQ distribution magic cookie\"\n+    cookie=\"$(LC_ALL=C tr -dc '[:alnum:]' </dev/urandom | head -c255)\"\n+    [ \"${#cookie}\" -eq 255 ] # make sure tr wasn\u2019t OOM-killed\n+    tmpfile=\"$(mktemp \"$cookiefile.XXXXXXXXXX\")\"\n+    chown rabbitmq: \"$tmpfile\"\n+    printf '%s' \"$cookie\" >\"$tmpfile\"\n+    mv \"$tmpfile\" \"$cookiefile\"\n+\n+    if [ \"$running\" == \"1\" ]; then\n+        service rabbitmq-server start\n+    fi\n+fi"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 1,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 3,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "a6ac4ed6bf7a529b3b1e26128ad60aebc48eeca3",
            "date": "2025-01-13T16:37:44Z",
            "author_login": "prakhar1144"
          },
          {
            "sha": "25941c1d19283d29d8fa321e399c95f9a80d0c2c",
            "date": "2025-01-13T10:12:42Z",
            "author_login": "prakhar1144"
          },
          {
            "sha": "79da2e38c57c92c65a035feab88ead289efd4784",
            "date": "2025-01-13T07:15:09Z",
            "author_login": "prakhar1144"
          },
          {
            "sha": "6252e3b3cfcf0c377fa7678020a35c872e02b2cc",
            "date": "2025-01-13T06:30:39Z",
            "author_login": "prakhar1144"
          },
          {
            "sha": "fdd0a5ba2c19576c477d8fa6d4f1c0fd7f777d2a",
            "date": "2025-01-14T07:25:53Z",
            "author_login": "prakhar1144"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 8.6,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:N/A:N",
    "cwe_id": "CWE-338",
    "description": "Zulip is an open-source team collaboration tool. Zulip Server installs RabbitMQ for internal message passing. In versions of Zulip Server prior to 4.9, the initial installation (until first reboot, or restart of RabbitMQ) does not successfully limit the default ports which RabbitMQ opens; this includes port 25672, the RabbitMQ distribution port, which is used as a management port. RabbitMQ's default \"cookie\" which protects this port is generated using a weak PRNG, which limits the entropy of the password to at most 36 bits; in practicality, the seed for the randomizer is biased, resulting in approximately 20 bits of entropy. If other firewalls (at the OS or network level) do not protect port 25672, a remote attacker can brute-force the 20 bits of entropy in the \"cookie\" and leverage it for arbitrary execution of code as the rabbitmq user. They can also read all data which is sent through RabbitMQ, which includes all message traffic sent by users. Version 4.9 contains a patch for this vulnerability. As a workaround, ensure that firewalls prevent access to ports 5672 and 25672 from outside the Zulip server.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2022-01-25T21:15:07.853",
    "last_modified": "2024-11-21T06:29:48.893",
    "fix_date": "2021-12-07T20:55:38Z"
  },
  "references": [
    {
      "url": "https://github.com/gteissier/erl-matter",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/zulip/zulip/commit/a5496f4098e3998c9b84e8dc564aa983d6cdf6e8",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/zulip/zulip/releases/tag/4.9",
      "source": "security-advisories@github.com",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/zulip/zulip/security/advisories/GHSA-p663-wxvv-2fjp",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/gteissier/erl-matter",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/zulip/zulip/commit/a5496f4098e3998c9b84e8dc564aa983d6cdf6e8",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/zulip/zulip/releases/tag/4.9",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/zulip/zulip/security/advisories/GHSA-p663-wxvv-2fjp",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:57.073682",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "zulip",
    "owner": "zulip",
    "created_at": "2015-09-25T16:37:25Z",
    "updated_at": "2025-01-14T13:31:30Z",
    "pushed_at": "2025-01-14T02:34:21Z",
    "size": 495185,
    "stars": 21946,
    "forks": 8107,
    "open_issues": 2487,
    "watchers": 21946,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [
      "1.4.x",
      "1.5.x",
      "1.8.x",
      "1.9.x",
      "2.0.x",
      "2.1.x",
      "3.x",
      "3.1-with-bmemcached",
      "4.x",
      "4.0-rc1-branch",
      "5.x",
      "5.x-user-sharding",
      "5.0-rc1-branch",
      "5.0-rc2-branch",
      "6.x",
      "6.0-beta1-branch",
      "6.0-rc1-branch",
      "7.x",
      "7.0-beta1-branch",
      "7.0-beta2-branch",
      "8.x",
      "9.x",
      "buddy-list-prep",
      "chat.zulip.org",
      "dockertest",
      "main",
      "s3-compatible-uploads",
      "zulip-cloud-current"
    ],
    "languages": {
      "Python": 14193798,
      "TypeScript": 4055572,
      "JavaScript": 2278673,
      "HTML": 957053,
      "CSS": 942085,
      "Handlebars": 597145,
      "Shell": 161466,
      "Puppet": 137563,
      "Perl": 10353,
      "Dockerfile": 4219,
      "Ruby": 3794,
      "Emacs Lisp": 157
    },
    "commit_activity": {
      "total_commits_last_year": 6397,
      "avg_commits_per_week": 123.01923076923077,
      "days_active_last_year": 356
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "apache-2.0"
    },
    "collected_at": "2025-01-14T13:44:17.890508"
  }
}