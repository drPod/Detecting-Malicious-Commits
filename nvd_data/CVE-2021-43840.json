{
  "cve_id": "CVE-2021-43840",
  "github_data": {
    "repository": "discourse/message_bus",
    "fix_commit": "9b6deee01ed474c7e9b5ff65a06bb0447b4db2ba",
    "related_commits": [
      "9b6deee01ed474c7e9b5ff65a06bb0447b4db2ba",
      "9b6deee01ed474c7e9b5ff65a06bb0447b4db2ba"
    ],
    "patch_url": "https://github.com/discourse/message_bus/commit/9b6deee01ed474c7e9b5ff65a06bb0447b4db2ba.patch",
    "fix_commit_details": {
      "sha": "9b6deee01ed474c7e9b5ff65a06bb0447b4db2ba",
      "commit_date": "2021-12-15T04:03:03Z",
      "author": {
        "login": "tgxworld",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "SECURITY: Fix path traversal on diagnostics route.",
        "length": 50,
        "has_description": false,
        "references_issue": true
      },
      "stats": {
        "total": 51,
        "additions": 41,
        "deletions": 10
      },
      "files": [
        {
          "filename": "CHANGELOG",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -1,6 +1,7 @@\n Unreleased\n \n   - FIX: Prevent simple polling from clobbering the session\n+  - SECURITY: Fix path traversal on diagnostics route.\n \n 31-05-2021\n "
        },
        {
          "filename": "lib/message_bus/rack/diagnostics.rb",
          "status": "modified",
          "additions": 30,
          "deletions": 7,
          "patch": "@@ -13,6 +13,15 @@ def initialize(app, config = {})\n     @bus = config[:message_bus] || MessageBus\n   end\n \n+  JS_ASSETS = %w{\n+    jquery-1.8.2.js\n+    react.js\n+    react-dom.js\n+    babel.min.js\n+    message-bus.js\n+    application.jsx\n+  }\n+\n   # Process an HTTP request from a subscriber client\n   # @param [Rack::Request::Env] env the request environment\n   def call(env)\n@@ -39,7 +48,8 @@ def call(env)\n     end\n \n     asset = route.split('/assets/')[1]\n-    if asset && !asset !~ /\\//\n+\n+    if asset && JS_ASSETS.include?(asset)\n       content = asset_contents(asset)\n       return [200, { 'Content-Type' => 'application/javascript;charset=UTF-8' }, [content]]\n     end\n@@ -74,6 +84,23 @@ def asset_path(asset)\n     File.expand_path(\"../../../../assets/#{asset}\", __FILE__)\n   end\n \n+  def script_tags\n+    tags = []\n+\n+    JS_ASSETS.each do |asset|\n+      type =\n+        if asset.end_with?('.js')\n+          'text/javascript'\n+        elsif asset.end_with?('.jsx')\n+          'text/jsx'\n+        end\n+\n+      tags << js_asset(asset, type)\n+    end\n+\n+    tags.join(\"\\n\")\n+  end\n+\n   def index\n     html = <<~HTML\n       <!DOCTYPE html>\n@@ -82,12 +109,8 @@ def index\n         </head>\n         <body>\n           <div id=\"app\"></div>\n-          #{js_asset \"jquery-1.8.2.js\"}\n-          #{js_asset \"react.js\"}\n-          #{js_asset \"react-dom.js\"}\n-          #{js_asset \"babel.min.js\"}\n-          #{js_asset \"message-bus.js\"}\n-          #{js_asset \"application.jsx\", \"text/jsx\"}\n+\n+          #{script_tags}\n         </body>\n       </html>\n     HTML"
        },
        {
          "filename": "spec/lib/message_bus/rack/middleware_spec.rb",
          "status": "modified",
          "additions": 10,
          "deletions": 3,
          "patch": "@@ -142,13 +142,12 @@ module LongPolling\n   end\n \n   describe \"diagnostics\" do\n-    it \"should return a 403 if a user attempts to get at the _diagnostics path\" do\n+    it \"should return a 403 if an unauthorized user attempts to get at the _diagnostics path\" do\n       get \"/message-bus/_diagnostics\"\n       last_response.status.must_equal 403\n     end\n \n     it \"should get a 200 with html for an authorized user\" do\n-\n       def @bus.is_admin_lookup\n         proc { |_| true }\n       end\n@@ -171,7 +170,6 @@ def @bus.is_admin_lookup\n     end\n \n     it \"should get the script it asks for\" do\n-\n       def @bus.is_admin_lookup\n         proc { |_| true }\n       end\n@@ -180,6 +178,15 @@ def @bus.is_admin_lookup\n       last_response.status.must_equal 200\n       last_response.content_type.must_equal \"application/javascript;charset=UTF-8\"\n     end\n+\n+    it \"should return 404 for invalid assets path\" do\n+      def @bus.is_admin_lookup\n+        proc { |_| true }\n+      end\n+\n+      get \"/message-bus/_diagnostics/assets/../Gemfile\"\n+      last_response.status.must_equal 404\n+    end\n   end\n \n   describe \"polling\" do"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 3,
        "max_directory_depth": 4
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "d5ae3400cf1b3890843189333de60291c608ab9b",
            "date": "2024-10-21T12:03:50Z",
            "author_login": "dependabot[bot]"
          },
          {
            "sha": "a3bd57a9158fcdd666e234aff1786fd37d54b0a1",
            "date": "2024-09-18T09:07:56Z",
            "author_login": "dependabot[bot]"
          },
          {
            "sha": "9489a4555559c48aec12217d1a3a22a17395011e",
            "date": "2024-06-19T14:34:47Z",
            "author_login": "CvX"
          },
          {
            "sha": "a99dc5fd88f885435b8c3852f3e5ede7dce46845",
            "date": "2024-06-19T14:29:23Z",
            "author_login": "sobstel"
          },
          {
            "sha": "2f5386dd5859aca472eebd815220a5596c5f6789",
            "date": "2024-06-19T14:22:40Z",
            "author_login": "CvX"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 4.4,
    "cvss_vector": "CVSS:3.1/AV:N/AC:H/PR:H/UI:N/S:U/C:H/I:N/A:N",
    "cwe_id": "CWE-22",
    "description": "message_bus is a messaging bus for Ruby processes and web clients. In versions prior to 3.3.7 users who deployed message bus with diagnostics features enabled (default off) are vulnerable to a path traversal bug, which could lead to disclosure of secret information on a machine if an unintended user were to gain access to the diagnostic route. The impact is also greater if there is no proxy for your web application as the number of steps up the directories is not bounded. For deployments which uses a proxy, the impact varies. For example, If a request goes through a proxy like Nginx with `merge_slashes` enabled, the number of steps up the directories that can be read is limited to 3 levels. This issue has been patched in version 3.3.7. Users unable to upgrade should ensure that MessageBus::Diagnostics is disabled.",
    "attack_vector": "NETWORK",
    "attack_complexity": "HIGH"
  },
  "temporal_data": {
    "published_date": "2021-12-17T19:15:07.757",
    "last_modified": "2024-11-21T06:29:54.360",
    "fix_date": "2021-12-15T04:03:03Z"
  },
  "references": [
    {
      "url": "https://github.com/discourse/message_bus/commit/9b6deee01ed474c7e9b5ff65a06bb0447b4db2ba",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/discourse/message_bus/security/advisories/GHSA-xmgj-5fh3-xjmm",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/discourse/message_bus/commit/9b6deee01ed474c7e9b5ff65a06bb0447b4db2ba",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/discourse/message_bus/security/advisories/GHSA-xmgj-5fh3-xjmm",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:34.850841",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "message_bus",
    "owner": "discourse",
    "created_at": "2013-05-15T05:19:31Z",
    "updated_at": "2025-01-02T05:04:25Z",
    "pushed_at": "2024-10-21T12:03:52Z",
    "size": 1798,
    "stars": 1654,
    "forks": 134,
    "open_issues": 21,
    "watchers": 1654,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [
      "main"
    ],
    "languages": {
      "Ruby": 203070,
      "JavaScript": 28447,
      "Dockerfile": 450
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-14T16:07:11.967907"
  }
}