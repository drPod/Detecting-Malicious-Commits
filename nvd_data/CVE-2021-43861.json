{
  "cve_id": "CVE-2021-43861",
  "github_data": {
    "repository": "mermaid-js/mermaid",
    "fix_commit": "066b7a0d0bda274d94a2f2d21e4323dab5776d83",
    "related_commits": [
      "066b7a0d0bda274d94a2f2d21e4323dab5776d83",
      "066b7a0d0bda274d94a2f2d21e4323dab5776d83"
    ],
    "patch_url": "https://github.com/mermaid-js/mermaid/commit/066b7a0d0bda274d94a2f2d21e4323dab5776d83.patch",
    "fix_commit_details": {
      "sha": "066b7a0d0bda274d94a2f2d21e4323dab5776d83",
      "commit_date": "2021-12-29T10:29:46Z",
      "author": {
        "login": "knsv",
        "type": "User",
        "stats": {
          "total_commits": 2756,
          "average_weekly_commits": 5.170731707317073,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 322
        }
      },
      "commit_message": {
        "title": "Merge pull request from GHSA-p3rp-vmj9-gv6v",
        "length": 59,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 286,
        "additions": 272,
        "deletions": 14
      },
      "files": [
        {
          "filename": "cypress/platform/xss16.html",
          "status": "added",
          "additions": 106,
          "deletions": 0,
          "patch": "@@ -0,0 +1,106 @@\n+<html>\n+  <head>\n+    <link\n+      href=\"https://fonts.googleapis.com/css?family=Montserrat&display=swap\"\n+      rel=\"stylesheet\"\n+    />\n+    <link href=\"https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css\" rel=\"stylesheet\">\n+    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css\">\n+    <link href=\"https://fonts.googleapis.com/css?family=Noto+Sans+SC&display=swap\" rel=\"stylesheet\">\n+    <style>\n+      body {\n+        /* background: rgb(221, 208, 208); */\n+        /* background:#333; */\n+        font-family: 'Arial';\n+        /* font-size: 18px !important; */\n+        }\n+      h1 { color: grey;}\n+      .mermaid2 {\n+        display: none;\n+      }\n+      .mermaid svg {\n+        /* font-size: 18px !important; */\n+      }\n+      .malware {\n+        position: fixed;\n+        bottom:0;\n+        left:0;\n+        right:0;\n+        height: 150px;\n+        background: red;\n+        color: black;\n+        display: flex;\n+        display: flex;\n+        justify-content: center;\n+        align-items: center;\n+        font-family: monospace;\n+        font-size: 72px;\n+      }\n+    </style>\n+  </head>\n+  <body>\n+    <div>Security check</div>\n+    <div class=\"flex\">\n+      <div id=\"diagram\" class=\"mermaid\"></div>\n+      <div id=\"res\" class=\"\"></div>\n+  <script src=\"./mermaid.js\"></script>\n+    <script>\n+      mermaid.parseError = function (err, hash) {\n+        // console.error('Mermaid error: ', err);\n+      };\n+      mermaid.initialize({\n+        theme: 'forest',\n+        arrowMarkerAbsolute: true,\n+        // themeCSS: '.edgePath .path {stroke: red;} .arrowheadPath {fill: red;}',\n+        logLevel: 0,\n+        state: {\n+          defaultRenderer: 'dagre-d3',\n+        },\n+        flowchart: {\n+          // defaultRenderer: 'dagre-wrapper',\n+          nodeSpacing: 10,\n+    curve: 'cardinal',\n+    htmlLabels: true,\n+        },\n+        htmlLabels: true,\n+        // gantt: { axisFormat: '%m/%d/%Y' },\n+        sequence: { actorFontFamily: 'courier', actorMargin: 50, showSequenceNumbers: false },\n+        // sequenceDiagram: { actorMargin: 300 } // deprecated\n+        // fontFamily: '\"times\", sans-serif',\n+        // fontFamily: 'courier',\n+        fontSize: 18,\n+        curve: 'basis',\n+        securityLevel: 'loose',\n+        startOnLoad: false,\n+        secure: ['secure', 'securityLevel', 'startOnLoad', 'maxTextSize'],\n+        // themeVariables: {relationLabelColor: 'red'}\n+      });\n+      function callback() {\n+  alert('It worked');\n+}\n+      function xssAttack() {\n+        const div = document.createElement('div');\n+        div.id = 'the-malware';\n+        div.className = 'malware';\n+        div.innerHTML = 'XSS Succeeded';\n+        document.getElementsByTagName('body')[0].appendChild(div);\n+        throw new Error('XSS Succeded');\n+      }\n+\n+      var diagram = `sequenceDiagram\n+    participant Alice\n+    links Alice: { \"Click me!\" : \"javasjavascript:cript:alert('goose')\" }`;\n+\n+// //   var diagram = \"stateDiagram-v2\\n\";\n+// //  diagram += \"<img/src='1'/onerror\"\n+// diagram += '//via.placeholder.com/64\\' width=64 />\"]';\n+// console.log(diagram);\n+// document.querySelector('#diagram').innerHTML = diagram;\n+mermaid.render('diagram', diagram, (res) => {\n+  console.log(res);\n+  document.querySelector('#res').innerHTML = res;\n+});\n+    </script>\n+  </body>\n+</html>\n+"
        },
        {
          "filename": "cypress/platform/xss17.html",
          "status": "added",
          "additions": 106,
          "deletions": 0,
          "patch": "@@ -0,0 +1,106 @@\n+<html>\n+  <head>\n+    <link\n+      href=\"https://fonts.googleapis.com/css?family=Montserrat&display=swap\"\n+      rel=\"stylesheet\"\n+    />\n+    <link href=\"https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css\" rel=\"stylesheet\">\n+    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css\">\n+    <link href=\"https://fonts.googleapis.com/css?family=Noto+Sans+SC&display=swap\" rel=\"stylesheet\">\n+    <style>\n+      body {\n+        /* background: rgb(221, 208, 208); */\n+        /* background:#333; */\n+        font-family: 'Arial';\n+        /* font-size: 18px !important; */\n+        }\n+      h1 { color: grey;}\n+      .mermaid2 {\n+        display: none;\n+      }\n+      .mermaid svg {\n+        /* font-size: 18px !important; */\n+      }\n+      .malware {\n+        position: fixed;\n+        bottom:0;\n+        left:0;\n+        right:0;\n+        height: 150px;\n+        background: red;\n+        color: black;\n+        display: flex;\n+        display: flex;\n+        justify-content: center;\n+        align-items: center;\n+        font-family: monospace;\n+        font-size: 72px;\n+      }\n+    </style>\n+  </head>\n+  <body>\n+    <div>Security check</div>\n+    <div class=\"flex\">\n+      <div id=\"diagram\" class=\"mermaid\"></div>\n+      <div id=\"res\" class=\"\"></div>\n+  <script src=\"./mermaid.js\"></script>\n+    <script>\n+      mermaid.parseError = function (err, hash) {\n+        // console.error('Mermaid error: ', err);\n+      };\n+      mermaid.initialize({\n+        theme: 'forest',\n+        arrowMarkerAbsolute: true,\n+        // themeCSS: '.edgePath .path {stroke: red;} .arrowheadPath {fill: red;}',\n+        logLevel: 0,\n+        state: {\n+          defaultRenderer: 'dagre-d3',\n+        },\n+        flowchart: {\n+          // defaultRenderer: 'dagre-wrapper',\n+          nodeSpacing: 10,\n+    curve: 'cardinal',\n+    htmlLabels: true,\n+        },\n+        htmlLabels: true,\n+        // gantt: { axisFormat: '%m/%d/%Y' },\n+        sequence: { actorFontFamily: 'courier', actorMargin: 50, showSequenceNumbers: false },\n+        // sequenceDiagram: { actorMargin: 300 } // deprecated\n+        // fontFamily: '\"times\", sans-serif',\n+        // fontFamily: 'courier',\n+        fontSize: 18,\n+        curve: 'basis',\n+        securityLevel: 'loose',\n+        startOnLoad: false,\n+        secure: ['secure', 'securityLevel', 'startOnLoad', 'maxTextSize'],\n+        // themeVariables: {relationLabelColor: 'red'}\n+      });\n+      function callback() {\n+  alert('It worked');\n+}\n+      function xssAttack() {\n+        const div = document.createElement('div');\n+        div.id = 'the-malware';\n+        div.className = 'malware';\n+        div.innerHTML = 'XSS Succeeded';\n+        document.getElementsByTagName('body')[0].appendChild(div);\n+        throw new Error('XSS Succeded');\n+      }\n+\n+      var diagram = `sequenceDiagram\n+    participant Alice\n+    link Alice: Click Me!@javasjavascript:cript:alert(\"goose\")`;\n+\n+// //   var diagram = \"stateDiagram-v2\\n\";\n+// //  diagram += \"<img/src='1'/onerror\"\n+// diagram += '//via.placeholder.com/64\\' width=64 />\"]';\n+// console.log(diagram);\n+// document.querySelector('#diagram').innerHTML = diagram;\n+mermaid.render('diagram', diagram, (res) => {\n+  console.log(res);\n+  document.querySelector('#res').innerHTML = res;\n+});\n+    </script>\n+  </body>\n+</html>\n+"
        },
        {
          "filename": "docs/_sidebar.md",
          "status": "modified",
          "additions": 6,
          "deletions": 5,
          "patch": "@@ -1,10 +1,10 @@\n-- \ud83d\udcd4 Introduction  \n+- \ud83d\udcd4 Introduction\n \n   - [About Mermaid](README.md)\n   - [Deployment](n00b-gettingStarted.md)\n   - [Syntax and Configuration](n00b-syntaxReference.md)\n \n-- \ud83d\udcca Diagram Syntax \n+- \ud83d\udcca Diagram Syntax\n   - [Flowchart](flowchart.md)\n   - [Sequence diagram](sequenceDiagram.md)\n   - [Class Diagram](classDiagram.md)\n@@ -16,7 +16,7 @@\n   - [Requirement Diagram](requirementDiagram.md)\n   - [Other Examples](examples.md)\n \n-- \u2699\ufe0f Deployment and Configuration \n+- \u2699\ufe0f Deployment and Configuration\n \n   - [Tutorials](Tutorials.md)\n   - [API-Usage](usage.md)\n@@ -26,12 +26,13 @@\n   - [Mermaid CLI](mermaidCLI.md)\n   - [Advanced usage](n00b-advanced.md)\n \n-- \ud83d\udcda Misc \n+- \ud83d\udcda Misc\n   - [Use-Cases and Integrations](integrations.md)\n   - [FAQ](faq.md)\n \n-- \ud83d\ude4c Contributions and Community \n+- \ud83d\ude4c Contributions and Community\n   - [Overview for Beginners](n00b-overview.md)\n   - [Development and Contribution ](development.md)\n   - [Changelog](CHANGELOG.md)\n   - [Adding Diagrams ](newDiagram.md)\n+  - [Security ](security.md)"
        },
        {
          "filename": "docs/security.md",
          "status": "added",
          "additions": 17,
          "deletions": 0,
          "patch": "@@ -0,0 +1,17 @@\n+# Security\r\n+The Mermaid team takes the security of Mermaid and the applications that use Mermaid seriously. This page describes how to report any vulnerabilities you may find, and lists best practices to minimize the risk of introducing a vulnerability.\r\n+\r\n+## Reporting vulnerabilities\r\n+To report a vulnerability, please e-mail security@mermaid.live with a description of the issue, the steps you took to create the issue, affected versions, and if known, mitigations for the issue.\r\n+\r\n+We aim to reply within three working days, probably much sooner.\r\n+\r\n+You should expect a close collaboration as we work to resolve the issue you have reported. Please reach out to security@mermaid.live again if you do not receive prompt attention and regular updates.\r\n+\r\n+You may also reach out to the team via our public Slack chat channels; however, please make sure to e-mail security@mernaid.live when reporting an issue, and avoid revealing information about vulnerabilities in public as that could that could put users at risk.\r\n+\r\n+## Best practices\r\n+\r\n+Keep current with the latest Mermaid releases. We regularly update Mermaid, and these updates may fix security defects discovered in previous versions. Check the Mermaid release notes for security-related updates.\r\n+\r\n+Keep your application\u2019s dependencies up to date. Make sure you upgrade your package dependencies to keep the dependencies up to date. Avoid pinning to specific versions for your dependencies and, if you do, make sure you check periodically to see if your dependencies have had security updates, and update the pin accordingly.\r"
        },
        {
          "filename": "package.json",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -1,6 +1,6 @@\n {\n   \"name\": \"mermaid\",\n-  \"version\": \"8.13.6\",\n+  \"version\": \"8.13.8\",\n   \"description\": \"Markdownish syntax for generating flowcharts, sequence diagrams, class diagrams, gantt charts and git graphs.\",\n   \"main\": \"dist/mermaid.core.js\",\n   \"module\": \"dist/mermaid.esm.min.mjs\","
        },
        {
          "filename": "src/diagrams/common/common.spec.js",
          "status": "modified",
          "additions": 13,
          "deletions": 1,
          "patch": "@@ -1,4 +1,4 @@\n-import { removeScript, removeEscapes } from './common';\n+import { sanitizeText, removeScript, removeEscapes } from './common';\n \n describe('when securityLevel is antiscript, all script must be removed', function () {\n   it('should remove all script block, script inline.', function () {\n@@ -69,3 +69,15 @@ describe('remove escape code in text', function () {\n     expect(result).toEqual('script:');\n   });\n });\n+\n+describe('Sanitize text', function () {\n+  it('should remove script tag', function () {\n+    const maliciousStr = 'javajavascript:script:alert(1)';\n+    const result = sanitizeText(maliciousStr, {\n+      securityLevel: 'strict',\n+      flowchart: { htmlLabels: true },\n+    });\n+    console.log('result', result);\n+    expect(result).not.toContain('javascript:alert(1)');\n+  });\n+});"
        },
        {
          "filename": "src/diagrams/sequence/svgDraw.js",
          "status": "modified",
          "additions": 8,
          "deletions": 6,
          "patch": "@@ -1,5 +1,6 @@\n import common from '../common/common';\n import { addFunction } from '../../interactionDb';\n+import { sanitizeUrl } from '@braintree/sanitize-url';\n \n export const drawRect = function (elem, rectData) {\n   const rectElem = elem.append('rect');\n@@ -19,12 +20,12 @@ export const drawRect = function (elem, rectData) {\n   return rectElem;\n };\n \n-const sanitizeUrl = function (s) {\n-  return s\n-    .replace(/&/g, '&amp;')\n-    .replace(/</g, '&lt;')\n-    .replace(/javascript:/g, '');\n-};\n+// const sanitizeUrl = function (s) {\n+//   return s\n+//     .replace(/&/g, '&amp;')\n+//     .replace(/</g, '&lt;')\n+//     .replace(/javascript:/g, '');\n+// };\n \n const addPopupInteraction = (id, actorCnt) => {\n   addFunction(() => {\n@@ -1055,4 +1056,5 @@ export default {\n   popupMenu,\n   popdownMenu,\n   fixLifeLineHeights,\n+  sanitizeUrl,\n };"
        },
        {
          "filename": "src/diagrams/sequence/svgDraw.spec.js",
          "status": "modified",
          "additions": 15,
          "deletions": 1,
          "patch": "@@ -1,4 +1,4 @@\n-const svgDraw = require('./svgDraw');\n+const svgDraw = require('./svgDraw').default;\n const { MockD3 } = require('d3');\n \n describe('svgDraw', function () {\n@@ -124,4 +124,18 @@ describe('svgDraw', function () {\n       expect(rect.lower).toHaveBeenCalled();\n     });\n   });\n+  describe('sanitizeUrl', function () {\n+    it('it should sanitize malicious urls', function () {\n+      const maliciousStr = 'javascript:script:alert(1)';\n+      const result = svgDraw.sanitizeUrl(maliciousStr);\n+      console.log('result', result);\n+      expect(result).not.toContain('javascript:alert(1)');\n+    });\n+    it('it should not sanitize non dangerous urls', function () {\n+      const maliciousStr = 'javajavascript:script:alert(1)';\n+      const result = svgDraw.sanitizeUrl(maliciousStr);\n+      console.log('result', result);\n+      expect(result).not.toContain('javascript:alert(1)');\n+    });\n+  });\n });"
        }
      ],
      "file_patterns": {
        "security_files": 1,
        "config_files": 1,
        "dependency_files": 1,
        "test_files": 0,
        "unique_directories": 5,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "bc2cc61240987ac956c69e262c93971cd254f00a",
            "date": "2025-01-07T08:59:52Z",
            "author_login": "ashishjain0512"
          },
          {
            "sha": "ec0d9c389aa6018043187654044c1e0b5aa4f600",
            "date": "2024-12-18T10:59:39Z",
            "author_login": "knsv"
          },
          {
            "sha": "323b07a2e4255b8339a29a919634ce2e7b7322bf",
            "date": "2024-12-18T10:56:48Z",
            "author_login": "knsv"
          },
          {
            "sha": "c153d0455fdc89abd49f61d117a64aac1f3748b0",
            "date": "2024-12-17T15:28:38Z",
            "author_login": "knsv"
          },
          {
            "sha": "9b00f1f2fb6843a5ff94b13974bcb646640a3b4d",
            "date": "2024-12-17T13:56:18Z",
            "author_login": "knsv"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 7.2,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H",
    "cwe_id": "CWE-20",
    "description": "Mermaid is a Javascript based diagramming and charting tool that uses Markdown-inspired text definitions and a renderer to create and modify complex diagrams. Prior to version 8.13.8, malicious diagrams can run javascript code at diagram readers' machines. Users should upgrade to version 8.13.8 to receive a patch. There are no known workarounds aside from upgrading.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2021-12-30T14:15:07.547",
    "last_modified": "2024-11-21T06:29:57.890",
    "fix_date": "2021-12-29T10:29:46Z"
  },
  "references": [
    {
      "url": "https://github.com/mermaid-js/mermaid/commit/066b7a0d0bda274d94a2f2d21e4323dab5776d83",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/mermaid-js/mermaid/releases/tag/8.13.8",
      "source": "security-advisories@github.com",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/mermaid-js/mermaid/security/advisories/GHSA-p3rp-vmj9-gv6v",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/mermaid-js/mermaid/commit/066b7a0d0bda274d94a2f2d21e4323dab5776d83",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/mermaid-js/mermaid/releases/tag/8.13.8",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/mermaid-js/mermaid/security/advisories/GHSA-p3rp-vmj9-gv6v",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:37.035935",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "mermaid",
    "owner": "mermaid-js",
    "created_at": "2014-11-01T23:52:32Z",
    "updated_at": "2025-01-14T14:59:55Z",
    "pushed_at": "2025-01-14T13:33:51Z",
    "size": 239825,
    "stars": 74333,
    "forks": 6805,
    "open_issues": 1195,
    "watchers": 74333,
    "has_security_policy": false,
    "default_branch": "develop",
    "protected_branches": [],
    "languages": {
      "TypeScript": 1570997,
      "JavaScript": 1450624,
      "HTML": 342929,
      "Yacc": 155561,
      "Vue": 7243,
      "Shell": 3909,
      "CSS": 2374,
      "Dockerfile": 321
    },
    "commit_activity": {
      "total_commits_last_year": 2201,
      "avg_commits_per_week": 42.32692307692308,
      "days_active_last_year": 252
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-14T15:52:15.884866"
  }
}