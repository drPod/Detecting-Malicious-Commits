{
  "cve_id": "CVE-2021-44665",
  "github_data": {
    "repository": "thexerteproject/xerteonlinetoolkits",
    "fix_commit": "48a9880c6ac38f4d215f9143baf3d6e6062a1871",
    "related_commits": [
      "48a9880c6ac38f4d215f9143baf3d6e6062a1871",
      "48a9880c6ac38f4d215f9143baf3d6e6062a1871"
    ],
    "patch_url": "https://github.com/thexerteproject/xerteonlinetoolkits/commit/48a9880c6ac38f4d215f9143baf3d6e6062a1871.patch",
    "fix_commit_details": {
      "sha": "48a9880c6ac38f4d215f9143baf3d6e6062a1871",
      "commit_date": "2021-11-18T15:41:49Z",
      "author": {
        "login": "torinfo",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Fix vulnarebility",
        "length": 17,
        "has_description": false,
        "references_issue": true
      },
      "stats": {
        "total": 59,
        "additions": 33,
        "deletions": 26
      },
      "files": [
        {
          "filename": "getfile.php",
          "status": "modified",
          "additions": 33,
          "deletions": 26,
          "patch": "@@ -23,38 +23,45 @@\n require $xerte_toolkits_site->php_library_path . \"template_library.php\";\n require $xerte_toolkits_site->php_library_path . \"template_status.php\";\n \n-// be slightly paranoid over the path the user is requesting to download.\n+// be VERY paranoid over the path the user is requesting to download.\n+// Even if the file starts with a correct pattern (old implementation) the user could travers path\n+// like 542-tom-Notingham/../database.php or like 542-tom-Notingham/../../../../etc/passwd\n $unsafe_file_path = $_GET['file'];\n-if(!preg_match('/^([0-9]+)-([a-z0-9]+)-/', $unsafe_file_path, $matches)) {\n-    die(\"path must start with a number, and then a username - e.g. 20-foobar-\");\n-}\n+$full_unsafe_file_path = $xerte_toolkits_site->root_file_path . $xerte_toolkits_site->users_file_area_short . $unsafe_file_path;\n+// This gets the canonical file name, so in case of 542-tom-Notingham/../../../../etc/passwd -> /etc/passwd\n+$realpath = realpath($full_unsafe_file_path);\n+// Check that is start with root_path/USER-FILES\n+if ($realpath !== false && $realpath === $full_unsafe_file_path) {\n+    if (!preg_match('/^([0-9]+)-([a-z0-9]+)-/', $unsafe_file_path, $matches)) {\n+        die(\"path must start with a number, and then a username - e.g. 20-foobar-\");\n+    }\n \n-$template_id = $matches[1];\n-$username = $matches[2];\n+    $template_id = $matches[1];\n+    $username = $matches[2];\n \n-$has_perms = is_user_admin() || has_rights_to_this_template($template_id,$_SESSION['toolkits_logon_id']);\n+    $has_perms = is_user_admin() || has_rights_to_this_template($template_id, $_SESSION['toolkits_logon_id']);\n \n-if($has_perms) { \n-    if(is_user_an_editor($template_id,$_SESSION['toolkits_logon_id'])){\n-        if($username == $_SESSION['toolkits_logon_username']) { \n-            // they're logged in, and hopefully have access to the media contents.\n-            $file = dirname(__FILE__) . '/USER-FILES/' . $unsafe_file_path;\n-            if(!is_file($file)) { \n-                die(\"Fail: file not found on disk\"); \n-            }\n-            $filename = addslashes(basename($file));\n+    if ($has_perms) {\n+        if (is_user_an_editor($template_id, $_SESSION['toolkits_logon_id'])) {\n+            if ($username == $_SESSION['toolkits_logon_username']) {\n+                // they're logged in, and hopefully have access to the media contents.\n+                $file = dirname(__FILE__) . '/USER-FILES/' . $unsafe_file_path;\n+                if (!is_file($file)) {\n+                    die(\"Fail: file not found on disk\");\n+                }\n+                $filename = addslashes(basename($file));\n \n-            header(\"Cache-Control: public\");\n-            header(\"Content-Length: \" . filesize($file));\n-            header(\"Content-Description: File Transfer\");\n-            header(\"Content-Type: application/force-download\"); \n-            header(\"Content-Disposition: attachment; filename=\\\"$filename\\\"\");\n-            header(\"Content-Transfer-Encoding: binary\");\n-            flush();\n-            readfile($file);\n-            exit(0);\n+                header(\"Cache-Control: public\");\n+                header(\"Content-Length: \" . filesize($file));\n+                header(\"Content-Description: File Transfer\");\n+                header(\"Content-Type: application/force-download\");\n+                header(\"Content-Disposition: attachment; filename=\\\"$filename\\\"\");\n+                header(\"Content-Transfer-Encoding: binary\");\n+                flush();\n+                readfile($file);\n+                exit(0);\n+            }\n         }\n     }\n }\n-\n echo \"You do not appear to have permission to view this resource.\";"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 1,
        "max_directory_depth": 0
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "935155a7a002bf1b4638dca049ae24eb9be82837",
            "date": "2025-01-14T16:14:33Z",
            "author_login": "FayCross"
          },
          {
            "sha": "7591f1267b398c0f6fb1a394bc2feecac0e0b06b",
            "date": "2025-01-14T13:59:36Z",
            "author_login": "FayCross"
          },
          {
            "sha": "1b7a30390f890c3e549016af005053142886ab09",
            "date": "2025-01-14T13:43:43Z",
            "author_login": "FayCross"
          },
          {
            "sha": "1f84d4cab7437257c1cdcb0d30383e148bc91c20",
            "date": "2025-01-13T20:46:02Z",
            "author_login": "torinfo"
          },
          {
            "sha": "c6fecbce40bd45d6b8cd2e7fe98ef15f2c095e8a",
            "date": "2025-01-13T20:43:54Z",
            "author_login": "torinfo"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.5,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:N/A:N",
    "cwe_id": "CWE-22",
    "description": "A Directory Traversal vulnerability exists in the Xerte Project Xerte through 3.10.3 when downloading a project file via download.php.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2022-02-24T21:15:07.667",
    "last_modified": "2024-11-21T06:31:20.690",
    "fix_date": "2021-11-18T15:41:49Z"
  },
  "references": [
    {
      "url": "http://packetstormsecurity.com/files/166181/Xerte-3.10.3-Directory-Traversal.html",
      "source": "cve@mitre.org",
      "tags": [
        "Exploit",
        "Third Party Advisory",
        "VDB Entry"
      ]
    },
    {
      "url": "https://github.com/thexerteproject/xerteonlinetoolkits/commit/48a9880c6ac38f4d215f9143baf3d6e6062a1871",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://packetstormsecurity.com/files/166181/Xerte-3.10.3-Directory-Traversal.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Third Party Advisory",
        "VDB Entry"
      ]
    },
    {
      "url": "https://github.com/thexerteproject/xerteonlinetoolkits/commit/48a9880c6ac38f4d215f9143baf3d6e6062a1871",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:59.753794",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "xerteonlinetoolkits",
    "owner": "thexerteproject",
    "created_at": "2013-09-05T12:25:45Z",
    "updated_at": "2025-01-14T13:59:44Z",
    "pushed_at": "2025-01-14T13:59:41Z",
    "size": 304475,
    "stars": 64,
    "forks": 61,
    "open_issues": 181,
    "watchers": 64,
    "has_security_policy": false,
    "default_branch": "develop",
    "protected_branches": [],
    "languages": {
      "JavaScript": 10003942,
      "PHP": 2698781,
      "HTML": 2259593,
      "SCSS": 1666684,
      "CSS": 1565061,
      "Less": 899514,
      "Makefile": 11959,
      "Roff": 7682,
      "Hack": 5139,
      "PostScript": 3228,
      "Python": 1899,
      "Batchfile": 565,
      "Shell": 413
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "apache-2.0"
    },
    "collected_at": "2025-01-14T15:14:14.607754"
  }
}