{
  "cve_id": "CVE-2021-46252",
  "github_data": {
    "repository": "InternationalScratchWiki/scratch-confirmaccount-v3",
    "fix_commit": "5ed5479de0a279377aa9f64362481efb4e75d8f9",
    "related_commits": [
      "5ed5479de0a279377aa9f64362481efb4e75d8f9",
      "5ed5479de0a279377aa9f64362481efb4e75d8f9"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "5ed5479de0a279377aa9f64362481efb4e75d8f9",
      "commit_date": "2022-01-04T17:09:16Z",
      "author": {
        "login": "apple502j",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Fix CSRF when adding requirements bypass (#155)",
        "length": 47,
        "has_description": false,
        "references_issue": true
      },
      "stats": {
        "total": 33,
        "additions": 23,
        "deletions": 10
      },
      "files": [
        {
          "filename": "src/SpecialConfirmAccounts.php",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -362,7 +362,7 @@ function handleFormSubmission(&$request, &$output, &$session) {\n \t\t\t$this->handleUnblockFormSubmission($request, $output, $session);\n \t\t} else if ($request->getText('bypassAddUsername') || $request->getText('bypassRemoveUsername')) { //TODO: refactor to move all the subpages into their own files\n \t\t\t$bypassPage = new RequirementsBypassPage($this);\n-\t\t\t$bypassPage->handleFormSubmission();\n+\t\t\t$bypassPage->handleFormSubmission($session);\n \t\t}\n \t}\n \n@@ -445,7 +445,7 @@ function execute( $par ) {\n \t\t\treturn $this->blocksPage($par, $request, $output, $session);\n \t\t} else if (strpos($par, wfMessage('scratch-confirmaccount-requirements-bypasses-url')->text()) === 0) {\n \t\t\t$bypassPage = new RequirementsBypassPage($this);\n-\t\t\treturn $bypassPage->render();\n+\t\t\treturn $bypassPage->render($session);\n \t\t} else if ($request->getText('username')) {\n \t\t\treturn $this->searchByUsername($request->getText('username'), $request, $output);\n \t\t} else if (isset(statuses[$par])) {"
        },
        {
          "filename": "src/subpages/RequirementsBypassPage.php",
          "status": "modified",
          "additions": 21,
          "deletions": 8,
          "patch": "@@ -1,5 +1,8 @@\n <?php\r\n require_once __DIR__ . '/../database/DatabaseInteractions.php';\r\n+require_once __DIR__ . '/../common.php';\r\n+\r\n+use MediaWiki\\Session\\Session;\r\n \r\n class RequirementsBypassPage {\r\n     private $pageContext;\r\n@@ -14,8 +17,13 @@ function __construct(SpecialPage $pageContext) {\n         $this->pageContext = $pageContext;\r\n     }\r\n \r\n-    function handleFormSubmission() {\r\n-        $request = $request = $this->pageContext->getRequest();\r\n+    function handleFormSubmission(Session &$session) {\r\n+        $request = $this->pageContext->getRequest();\r\n+        \r\n+        if (isCSRF($session, $request->getText('csrftoken'))) {\r\n+    \t\t\t$this->pageContext->getOutput()->showErrorPage('error', 'scratch-confirmaccount-csrf');\r\n+    \t\t\treturn;\r\n+    \t\t}\r\n \r\n         $dbw = getTransactableDatabase('scratch-confirmaccount-bypasses');\r\n \r\n@@ -27,10 +35,10 @@ function handleFormSubmission() {\n \r\n         commitTransaction($dbw, 'scratch-confirmaccount-bypasses');\r\n \r\n-        $this->render();\r\n+        $this->render($session);\r\n     }\r\n \r\n-    function showAddBypassForm() {\r\n+    function showAddBypassForm(Session &$session) {\r\n         $output = $this->pageContext->getOutput();\r\n         $request = $this->pageContext->getRequest();\r\n         \r\n@@ -39,6 +47,10 @@ function showAddBypassForm() {\n                 'action' => SpecialPage::getTitleFor('ConfirmAccounts', wfMessage('scratch-confirmaccount-requirements-bypasses-url')->text())->getFullURL(),\r\n                 'method' => 'post',\r\n                 'items' => [\r\n+                    new OOUI\\HiddenInputWidget([\r\n+                        'name' => 'csrftoken',\r\n+                        'value' => setCSRFToken($session)\r\n+                    ]),\r\n                     new OOUI\\ActionFieldLayout(\r\n                         new OOUI\\TextInputWidget( [\r\n                             'name' => 'bypassAddUsername',\r\n@@ -56,7 +68,7 @@ function showAddBypassForm() {\n         );\r\n     }\r\n \r\n-    function showBypassesList() {\r\n+    function showBypassesList(Session &$session) {\r\n         $output = $this->pageContext->getOutput();\r\n \r\n         $dbr = getReadOnlyDatabase();\r\n@@ -77,6 +89,7 @@ function showBypassesList() {\n \r\n             $table .= Html::openElement('td');\r\n             $table .= Html::openElement('form', ['action' => SpecialPage::getTitleFor('ConfirmAccounts', wfMessage('scratch-confirmaccount-requirements-bypasses-url')->text())->getFullURL(), 'method' => 'post']);\r\n+            $table .= Html::element('input', ['type' => 'hidden', 'name' => 'csrftoken', 'value' => setCSRFToken($session)]);\r\n             $table .= Html::element('input', ['type' => 'hidden', 'name' => 'bypassRemoveUsername', 'value' => $username]);\r\n             $table .= Html::element('input', ['type' => 'submit', 'value' => wfMessage('scratch-confirmaccount-requirements-bypasses-remove')->text()]);\r\n             $table .= Html::closeElement('form');\r\n@@ -90,12 +103,12 @@ function showBypassesList() {\n         $output->addHTML($table);\r\n     }\r\n \r\n-    function render() {\r\n+    function render(Session &$session) {\r\n         $output = $this->pageContext->getOutput();\r\n \r\n         $output->enableOOUI();\r\n \r\n-        $this->showAddBypassForm();\r\n-        $this->showBypassesList();\r\n+        $this->showAddBypassForm($session);\r\n+        $this->showBypassesList($session);\r\n     }\r\n }\n\\ No newline at end of file"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 2,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "ac0cb3f9581998e961da10d7c9319755c47277f3",
            "date": "2024-08-29T15:41:05Z",
            "author_login": "mrsrec"
          },
          {
            "sha": "2af9502cdb786d12f91ad8248644f76ae6b468b0",
            "date": "2024-07-18T13:54:52Z",
            "author_login": "jacob-g"
          },
          {
            "sha": "0a1a2f77b66a898258cfd3602d260d5cc125e7a6",
            "date": "2024-07-18T00:17:23Z",
            "author_login": "jacob-g"
          },
          {
            "sha": "c7f995eae78391b4b58ebdbf587e09622ff0adf8",
            "date": "2024-03-14T15:25:18Z",
            "author_login": "mrsrec"
          },
          {
            "sha": "77a7cb51c660d1dee9b358776b136b3e7d0e813c",
            "date": "2023-10-12T19:31:13Z",
            "author_login": "mrsrec"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.5,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:N/I:H/A:N",
    "cwe_id": "CWE-352",
    "description": "A Cross-Site Request Forgery (CSRF) in RequirementsBypassPage.php of Scratch Wiki scratch-confirmaccount-v3 allows attackers to modify account request requirement bypasses.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2022-02-15T23:15:08.107",
    "last_modified": "2024-11-21T06:33:49.383",
    "fix_date": "2022-01-04T17:09:16Z"
  },
  "references": [
    {
      "url": "https://github.com/InternationalScratchWiki/scratch-confirmaccount-v3/commit/5ed5479de0a279377aa9f64362481efb4e75d8f9",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/InternationalScratchWiki/scratch-confirmaccount-v3/pull/155",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/InternationalScratchWiki/scratch-confirmaccount-v3/commit/5ed5479de0a279377aa9f64362481efb4e75d8f9",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/InternationalScratchWiki/scratch-confirmaccount-v3/pull/155",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:59.717270",
    "processing_status": "enhanced"
  }
}