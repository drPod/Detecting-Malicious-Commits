{
  "cve_id": "CVE-2022-0377",
  "github_data": {
    "repository": "LearnPress/learnpress",
    "fix_commit": "d1dc4af7ef2950f1000abc21bd9520fb3eb98faf",
    "related_commits": [
      "d1dc4af7ef2950f1000abc21bd9520fb3eb98faf",
      "d1dc4af7ef2950f1000abc21bd9520fb3eb98faf"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "d1dc4af7ef2950f1000abc21bd9520fb3eb98faf",
      "commit_date": "2022-01-14T02:56:52Z",
      "author": {
        "login": "tungnxt89",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "= 4.1.4.2 =",
        "length": 84,
        "has_description": true,
        "references_issue": false
      },
      "stats": {
        "total": 180,
        "additions": 127,
        "deletions": 53
      },
      "files": [
        {
          "filename": "assets/src/js/frontend/profile.js",
          "status": "modified",
          "additions": 15,
          "deletions": 5,
          "patch": "@@ -24,7 +24,8 @@\n \t\t\te.preventDefault();\n \t\t\tconst self = this;\n \t\t\t$.ajax( {\n-\t\t\t\turl: '?lp-ajax=save-uploaded-user-avatar',\n+\t\t\t\t//url: '?lp-ajax=save-uploaded-user-avatar',\n+\t\t\t\turl: ( typeof lpGlobalSettings !== 'undefined' ? lpGlobalSettings.ajax : '' ).addQueryVar( 'action', 'learnpress_save-uploaded-user-avatar' ),\n \t\t\t\tdata: this.$( '.lp-avatar-crop-image' ).serializeJSON(),\n \t\t\t\ttype: 'post',\n \t\t\t\tsuccess( response ) {\n@@ -53,11 +54,20 @@\n \t\t\t\treturn;\n \t\t\t}\n \n-\t\t\tthis.$().removeAttr( 'data-custom' );\n-\t\t\tthis.$( '.profile-picture' ).toggleClass( 'profile-avatar-current' );\n-\t\t\tthis.$( '#submit' ).prop( 'disabled', false );\n+\t\t\tconst el = this;\n \n-\t\t\t$( '.lp-user-profile-avatar' ).html( this.$( '.profile-avatar-current' ).find( 'img' ).clone() );\n+\t\t\t$.ajax( {\n+\t\t\t\turl: ( typeof lpGlobalSettings !== 'undefined' ? lpGlobalSettings.ajax : '' ).addQueryVar( 'action', 'learnpress_remove-avatar' ),\n+\t\t\t\tdata: {},\n+\t\t\t\ttype: 'post',\n+\t\t\t\tsuccess( response ) {\n+\t\t\t\t\tel.$().removeAttr( 'data-custom' );\n+\t\t\t\t\tel.$( '.profile-picture' ).toggleClass( 'profile-avatar-current' );\n+\t\t\t\t\tel.$( '#submit' ).prop( 'disabled', false );\n+\n+\t\t\t\t\t$( '.lp-user-profile-avatar' ).html( el.$( '.profile-avatar-current' ).find( 'img' ).clone() );\n+\t\t\t\t},\n+\t\t\t} );\n \t\t},\n \t\t_upload( e ) {\n \t\t\te.preventDefault();"
        },
        {
          "filename": "inc/admin/class-lp-admin-ajax.php",
          "status": "modified",
          "additions": 101,
          "deletions": 0,
          "patch": "@@ -1196,12 +1196,39 @@ public static function update_order_status() {\n \t\t\tdie();\n \t\t}*/\n \n+\t\t/**\n+\t\t * Upload avatar of user\n+\t\t *\n+\t\t * @editor tungnx\n+\t\t * @modify 4.1.4.2\n+\t\t */\n \t\tpublic static function upload_user_avatar() {\n+\t\t\t$user_id = get_current_user_id();\n+\n+\t\t\tif ( ! $user_id ) {\n+\t\t\t\treturn;\n+\t\t\t}\n+\n \t\t\t$file       = $_FILES['lp-upload-avatar'];\n \t\t\t$upload_dir = learn_press_user_profile_picture_upload_dir();\n \n \t\t\tadd_filter( 'upload_dir', array( __CLASS__, '_user_avatar_upload_dir' ), 10000 );\n \n+\t\t\t$file_info_arr        = explode( '.', $file['name'] );\n+\t\t\t$file_info_arr_length = count( $file_info_arr );\n+\t\t\t$file_ext_index       = $file_info_arr_length - 1;\n+\t\t\t$file_ext             = $file_info_arr[ $file_ext_index ];\n+\t\t\t$file['name']         = $user_id . '.' . $file_ext;\n+\n+\t\t\t// Delete old image if exists\n+\t\t\t$path_img = get_user_meta( $user_id, '_lp_profile_picture', true );\n+\t\t\tif ( $path_img ) {\n+\t\t\t\t$path = $upload_dir['basedir'] . '/' . $path_img;\n+\t\t\t\tif ( file_exists( $path ) ) {\n+\t\t\t\t\t@unlink( $path );\n+\t\t\t\t}\n+\t\t\t}\n+\n \t\t\t$result = wp_handle_upload(\n \t\t\t\t$file,\n \t\t\t\tarray(\n@@ -1212,6 +1239,7 @@ public static function upload_user_avatar() {\n \t\t\tremove_filter( 'upload_dir', array( __CLASS__, '_user_avatar_upload_dir' ), 10000 );\n \t\t\tif ( is_array( $result ) ) {\n \t\t\t\t$result['name'] = $upload_dir['subdir'] . '/' . basename( $result['file'] );\n+\t\t\t\tupdate_user_meta( $user_id, '_lp_profile_picture', $result['name'] );\n \t\t\t\tunset( $result['file'] );\n \t\t\t} else {\n \t\t\t\t$result = array(\n@@ -1221,6 +1249,77 @@ public static function upload_user_avatar() {\n \t\t\tlearn_press_send_json( $result );\n \t\t}\n \n+\t\t/**\n+\t\t * Crop avatar of user\n+\t\t *\n+\t\t * @editor tungnx\n+\t\t * @return void\n+\t\t */\n+\t\tpublic static function save_uploaded_user_avatar() {\n+\t\t\t$avatar_data = wp_parse_args(\n+\t\t\t\tLP_Request::get( 'lp-user-avatar-crop' ),\n+\t\t\t\tarray(\n+\t\t\t\t\t'name'   => '',\n+\t\t\t\t\t'width'  => '',\n+\t\t\t\t\t'height' => '',\n+\t\t\t\t\t'points' => '',\n+\t\t\t\t\t'nonce'  => '',\n+\t\t\t\t)\n+\t\t\t);\n+\n+\t\t\t$current_user_id = get_current_user_id();\n+\n+\t\t\tif ( ! wp_verify_nonce( $avatar_data['nonce'], 'save-uploaded-profile-' . $current_user_id ) ) {\n+\t\t\t\tdie( 'ERROR VERIFY NONCE!' );\n+\t\t\t}\n+\n+\t\t\t$url = learn_press_update_user_profile_avatar();\n+\t\t\tif ( $url ) {\n+\t\t\t\tlearn_press_send_json(\n+\t\t\t\t\tarray(\n+\t\t\t\t\t\t'success' => true,\n+\t\t\t\t\t\t'avatar'  => sprintf( '<img src=\"%s\" />', $url ),\n+\t\t\t\t\t)\n+\t\t\t\t);\n+\t\t\t};\n+\n+\t\t\twp_die();\n+\t\t}\n+\n+\t\t/**\n+\t\t * Remove avatar of user\n+\t\t *\n+\t\t * @author tungnx\n+\t\t * @since 4.1.4.2\n+\t\t * @version 1.0.0\n+\t\t * @return void\n+\t\t */\n+\t\tpublic static function remove_avatar() {\n+\t\t\t$response = new LP_REST_Response();\n+\n+\t\t\ttry {\n+\t\t\t\t$user_id = get_current_user_id();\n+\t\t\t\tif ( ! $user_id ) {\n+\t\t\t\t\tthrow new Exception( __( 'User is invalid', 'learnpress' ) );\n+\t\t\t\t}\n+\n+\t\t\t\t// Delete old image if exists\n+\t\t\t\t$path_img = get_user_meta( $user_id, '_lp_profile_picture', true );\n+\t\t\t\tif ( $path_img ) {\n+\t\t\t\t\t$upload_dir = learn_press_user_profile_picture_upload_dir();\n+\t\t\t\t\t$path       = $upload_dir['basedir'] . '/' . $path_img;\n+\t\t\t\t\tif ( file_exists( $path ) ) {\n+\t\t\t\t\t\tunlink( $path );\n+\t\t\t\t\t\t$response->status = 'success';\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t} catch ( Throwable $e ) {\n+\t\t\t\t$response->message = $e->getMessage();\n+\t\t\t}\n+\n+\t\t\twp_send_json( $response );\n+\t\t}\n+\n \t\tpublic static function _user_avatar_upload_dir( $dir ) {\n \t\t\t$dir = learn_press_user_profile_picture_upload_dir();\n \n@@ -1260,6 +1359,8 @@ public static function update_order_exports() {\n \n \tif ( defined( 'DOING_AJAX' ) ) {\n \t\tadd_action( 'wp_ajax_learnpress_upload-user-avatar', array( 'LP_Admin_Ajax', 'upload_user_avatar' ) );\n+\t\tadd_action( 'wp_ajax_learnpress_save-uploaded-user-avatar', array( 'LP_Admin_Ajax', 'save_uploaded_user_avatar' ) );\n+\t\tadd_action( 'wp_ajax_learnpress_remove-avatar', array( 'LP_Admin_Ajax', 'remove_avatar' ) );\n \t}\n \n \tadd_action( 'init', array( 'LP_Admin_Ajax', 'init' ) );"
        },
        {
          "filename": "inc/class-lp-ajax.php",
          "status": "modified",
          "additions": 5,
          "deletions": 38,
          "patch": "@@ -11,13 +11,13 @@ public static function init() {\n \t\t\t\t'checkout-user-email-exists:nopriv',\n \t\t\t\t'recover-order',\n \t\t\t\t'request-become-a-teacher:nonce',\n-\t\t\t\t'upload-user-avatar',\n+\t\t\t\t// 'upload-user-avatar',\n \t\t\t\t'checkout:nopriv',\n \t\t\t\t'complete-lesson',\n \t\t\t\t'finish-course', // finish_course.\n \t\t\t\t// 'retake-course', // retake_course.\n \t\t\t\t'external-link:nopriv',\n-\t\t\t\t'save-uploaded-user-avatar',\n+\t\t\t\t// 'save-uploaded-user-avatar',\n \t\t\t\t'load-more-courses',\n \t\t\t);\n \n@@ -40,7 +40,7 @@ public static function init() {\n \t\t\t\tLP_Request::register_ajax( $action, $callback );\n \t\t\t}\n \n-\t\t\tadd_action( 'wp_ajax_learnpress_upload-user-avatar', array( __CLASS__, 'upload_user_avatar' ) );\n+\t\t\t//add_action( 'wp_ajax_learnpress_upload-user-avatar', array( __CLASS__, 'upload_user_avatar' ) );\n \t\t}\n \n \t\tpublic static function load_more_courses() {\n@@ -171,7 +171,7 @@ public static function checkout_user_email_exists() {\n \t\t\tlearn_press_maybe_send_json( $response );\n \t\t}\n \n-\t\tpublic static function upload_user_avatar() {\n+\t\t/*public static function upload_user_avatar() {\n \t\t\t$file       = $_FILES['lp-upload-avatar'];\n \t\t\t$upload_dir = learn_press_user_profile_picture_upload_dir();\n \n@@ -196,40 +196,7 @@ public static function upload_user_avatar() {\n \t\t\t}\n \n \t\t\tlearn_press_send_json( $result );\n-\t\t}\n-\n-\t\tpublic static function save_uploaded_user_avatar() {\n-\t\t\t$avatar_data = wp_parse_args(\n-\t\t\t\tLP_Request::get( 'lp-user-avatar-crop' ),\n-\t\t\t\tarray(\n-\t\t\t\t\t'name'   => '',\n-\t\t\t\t\t'width'  => '',\n-\t\t\t\t\t'height' => '',\n-\t\t\t\t\t'points' => '',\n-\t\t\t\t\t'nonce'  => '',\n-\t\t\t\t)\n-\t\t\t);\n-\n-\t\t\t$current_user_id = get_current_user_id();\n-\n-\t\t\tif ( ! wp_verify_nonce( $avatar_data['nonce'], 'save-uploaded-profile-' . $current_user_id ) ) {\n-\t\t\t\tdie( 'ERROR VERIFY NONCE!' );\n-\t\t\t}\n-\n-\t\t\t$url = learn_press_update_user_profile_avatar();\n-\t\t\tif ( $url ) {\n-\t\t\t\t$user = learn_press_get_current_user();\n-\n-\t\t\t\tlearn_press_send_json(\n-\t\t\t\t\tarray(\n-\t\t\t\t\t\t'success' => true,\n-\t\t\t\t\t\t'avatar'  => sprintf( '<img src=\"%s\" />', $url ),\n-\t\t\t\t\t)\n-\t\t\t\t);\n-\t\t\t};\n-\n-\t\t\twp_die();\n-\t\t}\n+\t\t}*/\n \n \t\tpublic static function _user_avatar_upload_dir( $dir ) {\n \t\t\t$dir = learn_press_user_profile_picture_upload_dir();"
        },
        {
          "filename": "inc/user/lp-user-functions.php",
          "status": "modified",
          "additions": 6,
          "deletions": 10,
          "patch": "@@ -1079,6 +1079,7 @@ function learn_press_update_user_profile() {\n  */\n function learn_press_update_user_profile_avatar() {\n \t$user_id = get_current_user_id();\n+\t$data    = learn_press_get_request( 'lp-user-avatar-crop' );\n \n \tif ( ! $user_id ) {\n \t\treturn new WP_Error( 2, 'User is invalid!' );\n@@ -1092,9 +1093,11 @@ function learn_press_update_user_profile_avatar() {\n \t\treturn false;\n \t}\n \n-\t$data = learn_press_get_request( 'lp-user-avatar-crop' );\n+\t$path_img = get_user_meta( $user_id, '_lp_profile_picture', true );\n \n-\tif ( ! $data || ! ( $path = $upload_dir['basedir'] . $data['name'] ) && file_exists( $path ) ) {\n+\t$path = $upload_dir['basedir'] . $path_img;\n+\n+\tif ( ! file_exists( $path ) ) {\n \t\treturn false;\n \t}\n \n@@ -1144,15 +1147,8 @@ function learn_press_update_user_profile_avatar() {\n \t$new_avatar = false;\n \n \tif ( file_exists( $output ) ) {\n-\n-\t\t$old_avatar = get_user_meta( $user_id, '_lp_profile_picture', true );\n-\n-\t\tif ( file_exists( $upload_dir['basedir'] . '/' . $old_avatar ) ) {\n-\t\t\t@unlink( $upload_dir['basedir'] . '/' . $old_avatar );\n-\t\t}\n-\n \t\t$new_avatar = preg_replace( '!^/!', '', $upload_dir['subdir'] ) . '/' . $newname;\n-\t\tupdate_user_meta( $user_id, '_lp_profile_picture', $new_avatar );\n+\t\tupdate_user_meta( $user_id, '_lp_profile_picture', '/' . $new_avatar );\n \t\tupdate_user_meta( $user_id, '_lp_profile_picture_changed', 'yes' );\n \n \t\t$new_avatar = $upload_dir['baseurl'] . '/' . $new_avatar;"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 4,
        "max_directory_depth": 4
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "c0be6ecaf6829eb16950d9c00ac7d4c23fc4a898",
            "date": "2025-01-22T07:15:22Z",
            "author_login": "tungnxt89"
          },
          {
            "sha": "f6eed8f820ad460125f695e3d482642003de0af9",
            "date": "2025-01-22T04:21:17Z",
            "author_login": "tungnxt89"
          },
          {
            "sha": "7450b50032fd6c7152efe9b395889ebf55c3128a",
            "date": "2025-01-22T03:03:23Z",
            "author_login": "tungnxt89"
          },
          {
            "sha": "ee8c9c34b7533be23b82ca64e57a295c8a44d92b",
            "date": "2025-01-21T10:24:38Z",
            "author_login": "tungnxt89"
          },
          {
            "sha": "b809284102e10cd525af1da1b454a7ecefeafaf6",
            "date": "2025-01-21T01:49:00Z",
            "author_login": "tungnxt89"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 4.3,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N",
    "cwe_id": "CWE-327",
    "description": "Users of the LearnPress WordPress plugin before 4.1.5 can upload an image as a profile avatar after the registration.  After this process the user crops and saves the image. Then a \"POST\" request that contains user supplied name of the image is sent to the server for renaming and cropping of the image. As a result of this request, the name of the user-supplied image is changed with a MD5 value. This process can be conducted only when type of the image is JPG or PNG. An attacker can use this vulnerability in order to rename an arbitrary image file. By doing this, they could destroy the design of the web site.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2022-02-28T09:15:09.093",
    "last_modified": "2024-11-21T06:38:29.713",
    "fix_date": "2022-01-14T02:56:52Z"
  },
  "references": [
    {
      "url": "https://bozogullarindan.com/en/2022/01/wordpress-learnpress-plugin-4.1.4.1-arbitrary-image-renaming/",
      "source": "contact@wpscan.com",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/LearnPress/learnpress/commit/d1dc4af7ef2950f1000abc21bd9520fb3eb98faf",
      "source": "contact@wpscan.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://wpscan.com/vulnerability/0d95ada6-53e3-4a80-a395-eacd7b090f26",
      "source": "contact@wpscan.com",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://bozogullarindan.com/en/2022/01/wordpress-learnpress-plugin-4.1.4.1-arbitrary-image-renaming/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/LearnPress/learnpress/commit/d1dc4af7ef2950f1000abc21bd9520fb3eb98faf",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://wpscan.com/vulnerability/0d95ada6-53e3-4a80-a395-eacd7b090f26",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:59.758079",
    "processing_status": "enhanced"
  }
}