{
  "cve_id": "CVE-2022-1021",
  "github_data": {
    "repository": "chatwoot/chatwoot",
    "fix_commit": "24b20c10cebd25e61de8d4266c63fde94772e889",
    "related_commits": [
      "24b20c10cebd25e61de8d4266c63fde94772e889",
      "24b20c10cebd25e61de8d4266c63fde94772e889"
    ],
    "patch_url": "https://github.com/chatwoot/chatwoot/commit/24b20c10cebd25e61de8d4266c63fde94772e889.patch",
    "fix_commit_details": {
      "sha": "24b20c10cebd25e61de8d4266c63fde94772e889",
      "commit_date": "2022-03-30T09:06:22Z",
      "author": {
        "login": "muhsin-k",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "fix: Referer URL validation (#4309)",
        "length": 47,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 62,
        "additions": 52,
        "deletions": 10
      },
      "files": [
        {
          "filename": ".rubocop.yml",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -17,6 +17,7 @@ Metrics/ClassLength:\n     - 'app/builders/messages/facebook/message_builder.rb'\n     - 'app/controllers/api/v1/accounts/contacts_controller.rb'\n     - 'app/listeners/action_cable_listener.rb'\n+    - 'app/models/conversation.rb'\n RSpec/ExampleLength:\n   Max: 25\n Style/Documentation:"
        },
        {
          "filename": "app/models/campaign.rb",
          "status": "modified",
          "additions": 1,
          "deletions": 10,
          "patch": "@@ -33,8 +33,8 @@\n #  fk_rails_...  (account_id => accounts.id) ON DELETE => cascade\n #  fk_rails_...  (inbox_id => inboxes.id) ON DELETE => cascade\n #\n-require 'uri'\n class Campaign < ApplicationRecord\n+  include UrlHelper\n   validates :account_id, presence: true\n   validates :inbox_id, presence: true\n   validates :title, presence: true\n@@ -94,15 +94,6 @@ def validate_url\n     errors.add(:url, 'invalid') if inbox.inbox_type == 'Website' && !url_valid?(trigger_rules['url'])\n   end\n \n-  def url_valid?(url)\n-    url = begin\n-      URI.parse(url)\n-    rescue StandardError\n-      false\n-    end\n-    url.is_a?(URI::HTTP) || url.is_a?(URI::HTTPS)\n-  end\n-\n   def prevent_completed_campaign_from_update\n     errors.add :status, 'The campaign is already completed' if !campaign_status_changed? && completed?\n   end"
        },
        {
          "filename": "app/models/conversation.rb",
          "status": "modified",
          "additions": 8,
          "deletions": 0,
          "patch": "@@ -46,12 +46,14 @@ class Conversation < ApplicationRecord\n   include AssignmentHandler\n   include RoundRobinHandler\n   include ActivityMessageHandler\n+  include UrlHelper\n \n   validates :account_id, presence: true\n   validates :inbox_id, presence: true\n   before_validation :validate_additional_attributes\n   validates :additional_attributes, jsonb_attributes_length: true\n   validates :custom_attributes, jsonb_attributes_length: true\n+  validate :validate_referer_url\n \n   enum status: { open: 0, resolved: 1, pending: 2, snoozed: 3 }\n \n@@ -242,6 +244,12 @@ def mute_period\n     6.hours\n   end\n \n+  def validate_referer_url\n+    return unless additional_attributes['referer']\n+\n+    self['additional_attributes']['referer'] = nil unless url_valid?(additional_attributes['referer'])\n+  end\n+\n   # creating db triggers\n   trigger.before(:insert).for_each(:row) do\n     \"NEW.display_id := nextval('conv_dpid_seq_' || NEW.account_id);\""
        },
        {
          "filename": "lib/url_helper.rb",
          "status": "added",
          "additions": 11,
          "deletions": 0,
          "patch": "@@ -0,0 +1,11 @@\n+require 'uri'\n+module UrlHelper\n+  def url_valid?(url)\n+    url = begin\n+      URI.parse(url)\n+    rescue StandardError\n+      false\n+    end\n+    url.is_a?(URI::HTTP) || url.is_a?(URI::HTTPS)\n+  end\n+end"
        },
        {
          "filename": "spec/helpers/url_helper_spec.rb",
          "status": "added",
          "additions": 15,
          "deletions": 0,
          "patch": "@@ -0,0 +1,15 @@\n+require 'rails_helper'\n+\n+describe UrlHelper, type: :helper do\n+  describe '#url_valid' do\n+    context 'when url valid called' do\n+      it 'return if valid url passed' do\n+        expect(helper.url_valid?('https://app.chatwoot.com/')).to eq true\n+      end\n+\n+      it 'return false if invalid url passed' do\n+        expect(helper.url_valid?('javascript:alert(document.cookie)')).to eq false\n+      end\n+    end\n+  end\n+end"
        },
        {
          "filename": "spec/models/conversation_spec.rb",
          "status": "modified",
          "additions": 16,
          "deletions": 0,
          "patch": "@@ -525,4 +525,20 @@\n       expect { notification.reload }.to raise_error ActiveRecord::RecordNotFound\n     end\n   end\n+\n+  describe 'validate invalid referer url' do\n+    let(:conversation) { create(:conversation, additional_attributes: { referer: 'javascript' }) }\n+\n+    it 'returns nil' do\n+      expect(conversation['additional_attributes']['referer']).to eq(nil)\n+    end\n+  end\n+\n+  describe 'validate valid referer url' do\n+    let(:conversation) { create(:conversation, additional_attributes: { referer: 'https://www.chatwoot.com/' }) }\n+\n+    it 'returns nil' do\n+      expect(conversation['additional_attributes']['referer']).to eq('https://www.chatwoot.com/')\n+    end\n+  end\n end"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 1,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 5,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "91dd92e318fc3e5f4614fce66897a786cd972fe8",
            "date": "2025-01-14T14:15:42Z",
            "author_login": "vishnu-narayanan"
          },
          {
            "sha": "03a938eb6092c988a1fb4e90cb3bfcbc34a26a81",
            "date": "2025-01-14T14:13:56Z",
            "author_login": "vishnu-narayanan"
          },
          {
            "sha": "26187c3ebf399ccec2e041d80a908fa94d8672c1",
            "date": "2025-01-14T10:58:29Z",
            "author_login": "scmmishra"
          },
          {
            "sha": "bffc24d119ac133f937ddce76b14dfc43d6d5ebc",
            "date": "2025-01-14T07:18:30Z",
            "author_login": "iamsivin"
          },
          {
            "sha": "dbcc55665aba40b4cea6a61545adca3dd01d877f",
            "date": "2025-01-14T03:35:29Z",
            "author_login": "scmmishra"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 5.4,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N",
    "cwe_id": "CWE-922",
    "description": "Insecure Storage of Sensitive Information in GitHub repository chatwoot/chatwoot prior to 2.6.0.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2022-08-19T13:15:08.293",
    "last_modified": "2024-11-21T06:39:52.487",
    "fix_date": "2022-03-30T09:06:22Z"
  },
  "references": [
    {
      "url": "https://github.com/chatwoot/chatwoot/commit/24b20c10cebd25e61de8d4266c63fde94772e889",
      "source": "security@huntr.dev",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/a8187478-75e1-4d62-b894-651269401ca3",
      "source": "security@huntr.dev",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/chatwoot/chatwoot/commit/24b20c10cebd25e61de8d4266c63fde94772e889",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/a8187478-75e1-4d62-b894-651269401ca3",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:03:14.239256",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "chatwoot",
    "owner": "chatwoot",
    "created_at": "2019-08-14T06:50:51Z",
    "updated_at": "2025-01-14T12:56:36Z",
    "pushed_at": "2025-01-14T11:50:33Z",
    "size": 151937,
    "stars": 21934,
    "forks": 3740,
    "open_issues": 937,
    "watchers": 21934,
    "has_security_policy": false,
    "default_branch": "develop",
    "protected_branches": [
      "3.x"
    ],
    "languages": {
      "Ruby": 2998525,
      "Vue": 2505452,
      "JavaScript": 2090105,
      "HTML": 162143,
      "SCSS": 105806,
      "Shell": 37442,
      "Liquid": 11120,
      "TypeScript": 5496,
      "Dockerfile": 4503,
      "Makefile": 1114,
      "Procfile": 283
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T14:00:34.446910"
  }
}