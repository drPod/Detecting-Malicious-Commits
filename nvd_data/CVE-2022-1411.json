{
  "cve_id": "CVE-2022-1411",
  "github_data": {
    "repository": "yetiforcecompany/yetiforcecrm",
    "fix_commit": "bf69c427260011ffca42f7b6935bb54080c54124",
    "related_commits": [
      "bf69c427260011ffca42f7b6935bb54080c54124",
      "bf69c427260011ffca42f7b6935bb54080c54124"
    ],
    "patch_url": "https://github.com/yetiforcecompany/yetiforcecrm/commit/bf69c427260011ffca42f7b6935bb54080c54124.patch",
    "fix_commit_details": {
      "sha": "bf69c427260011ffca42f7b6935bb54080c54124",
      "commit_date": "2022-05-05T09:49:50Z",
      "author": {
        "login": "mariuszkrzaczkowski",
        "type": "User",
        "stats": {
          "total_commits": 13756,
          "average_weekly_commits": 26.053030303030305,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 433
        }
      },
      "commit_message": {
        "title": "Added validation to pasted files to the wysiwyg editor",
        "length": 54,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 661,
        "additions": 427,
        "deletions": 234
      },
      "files": [
        {
          "filename": "app/Fields/File.php",
          "status": "modified",
          "additions": 35,
          "deletions": 22,
          "patch": "@@ -166,6 +166,39 @@ public static function loadFromPath(string $path)\n \t\treturn $instance;\n \t}\n \n+\t/**\n+\t * Load file instance from base string.\n+\t *\n+\t * @param string $contents\n+\t * @param array  $param\n+\t *\n+\t * @return \\self|null\n+\t */\n+\tpublic static function loadFromBase(string $contents, array $param = []): ?self\n+\t{\n+\t\t$result = explode(',', $contents, 2);\n+\t\t$contentType = $isBase64 = false;\n+\t\tif (2 === \\count($result)) {\n+\t\t\t[$metadata, $data] = $result;\n+\t\t\tforeach (explode(';', $metadata) as $cur) {\n+\t\t\t\tif ('base64' === $cur) {\n+\t\t\t\t\t$isBase64 = true;\n+\t\t\t\t} elseif ('data:' === substr($cur, 0, 5)) {\n+\t\t\t\t\t$contentType = str_replace('data:', '', $cur);\n+\t\t\t\t}\n+\t\t\t}\n+\t\t} else {\n+\t\t\t$data = $result[0];\n+\t\t}\n+\t\t$data = rawurldecode($data);\n+\t\t$rawData = $isBase64 ? base64_decode($data) : $data;\n+\t\tif (\\strlen($rawData) < 12) {\n+\t\t\tLog::error('Incorrect content value: ' . $contents, __CLASS__);\n+\t\t\treturn null;\n+\t\t}\n+\t\treturn static::loadFromContent($rawData, false, array_merge($param, ['mimeType' => $contentType]));\n+\t}\n+\n \t/**\n \t * Load file instance from content.\n \t *\n@@ -881,27 +914,7 @@ public static function getMimeContentType($fileName)\n \t */\n \tpublic static function saveFromString(string $contents, array $param = [])\n \t{\n-\t\t$result = explode(',', $contents, 2);\n-\t\t$contentType = $isBase64 = false;\n-\t\tif (2 === \\count($result)) {\n-\t\t\t[$metadata, $data] = $result;\n-\t\t\tforeach (explode(';', $metadata) as $cur) {\n-\t\t\t\tif ('base64' === $cur) {\n-\t\t\t\t\t$isBase64 = true;\n-\t\t\t\t} elseif ('data:' === substr($cur, 0, 5)) {\n-\t\t\t\t\t$contentType = str_replace('data:', '', $cur);\n-\t\t\t\t}\n-\t\t\t}\n-\t\t} else {\n-\t\t\t$data = $result[0];\n-\t\t}\n-\t\t$data = rawurldecode($data);\n-\t\t$rawData = $isBase64 ? base64_decode($data) : $data;\n-\t\tif (\\strlen($rawData) < 12) {\n-\t\t\tLog::error('Incorrect content value: ' . $contents, __CLASS__);\n-\t\t\treturn false;\n-\t\t}\n-\t\t$fileInstance = static::loadFromContent($rawData, false, array_merge($param, ['mimeType' => $contentType]));\n+\t\t$fileInstance = static::loadFromBase($contents, $param);\n \t\tif ($fileInstance->validateAndSecure()) {\n \t\t\treturn $fileInstance;\n \t\t}\n@@ -1230,7 +1243,7 @@ public function insertTempFile(array $params): int\n \t\t\t'createdtime' => date('Y-m-d H:i:s'),\n \t\t\t'fieldname' => null,\n \t\t\t'key' => null,\n-\t\t\t'crmid' => 0\n+\t\t\t'crmid' => 0,\n \t\t];\n \t\tforeach ($data as $key => &$value) {\n \t\t\tif (isset($params[$key])) {"
        },
        {
          "filename": "app/Validator.php",
          "status": "modified",
          "additions": 16,
          "deletions": 0,
          "patch": "@@ -483,4 +483,20 @@ public static function path(string $input): bool\n \t\t\treturn !self::dirName($dir);\n \t\t});\n \t}\n+\n+\t/**\n+\t * Check base64.\n+\t *\n+\t * @param string $input\n+\t *\n+\t * @return bool\n+\t */\n+\tpublic static function base64(string $input): bool\n+\t{\n+\t\tif (empty($input)) {\n+\t\t\treturn false;\n+\t\t}\n+\t\t$explode = explode(',', $input);\n+\t\treturn 2 === \\count($explode) && 1 === preg_match('%^[a-zA-Z0-9/+]*={0,2}$%', $explode[1]);\n+\t}\n }"
        },
        {
          "filename": "config/version.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -1,7 +1,7 @@\n <?php\n \n return [\n-\t'appVersion' => '6.3.220',\n+\t'appVersion' => '6.3.221',\n \t'patchVersion' => '2022.05.05',\n \t'lib_roundcube' => '0.2.12',\n ];"
        },
        {
          "filename": "modules/Vtiger/actions/Fields.php",
          "status": "modified",
          "additions": 35,
          "deletions": 8,
          "patch": "@@ -59,6 +59,7 @@ public function __construct()\n \t\t$this->exposeMethod('validateByMode');\n \t\t$this->exposeMethod('verifyPhoneNumber');\n \t\t$this->exposeMethod('changeFavoriteOwner');\n+\t\t$this->exposeMethod('validateFile');\n \t}\n \n \t/**\n@@ -68,7 +69,7 @@ public function __construct()\n \t *\n \t * @throws \\App\\Exceptions\\NoPermitted\n \t */\n-\tpublic function getOwners(App\\Request $request)\n+\tpublic function getOwners(App\\Request $request): void\n \t{\n \t\tif (!App\\Config::performance('SEARCH_OWNERS_BY_AJAX')) {\n \t\t\tthrow new \\App\\Exceptions\\NoPermitted('LBL_PERMISSION_DENIED', 406);\n@@ -121,7 +122,7 @@ public function getOwners(App\\Request $request)\n \t *\n \t * @throws \\App\\Exceptions\\NoPermitted\n \t */\n-\tpublic function getUserRole(App\\Request $request)\n+\tpublic function getUserRole(App\\Request $request): void\n \t{\n \t\tif (!App\\Config::performance('SEARCH_ROLES_BY_AJAX')) {\n \t\t\tthrow new \\App\\Exceptions\\NoPermitted('LBL_PERMISSION_DENIED', 406);\n@@ -148,7 +149,7 @@ public function getUserRole(App\\Request $request)\n \t *\n \t * @throws \\App\\Exceptions\\NoPermitted\n \t */\n-\tpublic function getReference(App\\Request $request)\n+\tpublic function getReference(App\\Request $request): void\n \t{\n \t\tif ($request->has('fieldName')) {\n \t\t\t$fieldModel = Vtiger_Module_Model::getInstance($request->getModule())->getFieldByName($request->getByType('fieldName', 2));\n@@ -195,7 +196,7 @@ public function getReference(App\\Request $request)\n \t *\n \t * @throws \\App\\Exceptions\\NoPermitted\n \t */\n-\tpublic function verifyPhoneNumber(App\\Request $request)\n+\tpublic function verifyPhoneNumber(App\\Request $request): void\n \t{\n \t\tif ('phone' !== $this->fieldModel->getFieldDataType()) {\n \t\t\tthrow new \\App\\Exceptions\\NoPermitted('ERR_NO_PERMISSIONS_TO_FIELD');\n@@ -224,7 +225,7 @@ public function verifyPhoneNumber(App\\Request $request)\n \t *\n \t * @param \\App\\Request $request\n \t */\n-\tpublic function findAddress(App\\Request $request)\n+\tpublic function findAddress(App\\Request $request): void\n \t{\n \t\t$instance = \\App\\Map\\Address::getInstance($request->getByType('type'));\n \t\t$response = new Vtiger_Response();\n@@ -243,7 +244,7 @@ public function findAddress(App\\Request $request)\n \t * @throws \\App\\Exceptions\\NoPermitted\n \t * @throws \\yii\\db\\Exception\n \t */\n-\tpublic function changeFavoriteOwner(App\\Request $request)\n+\tpublic function changeFavoriteOwner(App\\Request $request): void\n \t{\n \t\tif (!App\\Config::module('Users', 'FAVORITE_OWNERS') || (\\App\\User::getCurrentUserRealId() !== \\App\\User::getCurrentUserId())) {\n \t\t\tthrow new \\App\\Exceptions\\NoPermitted('LBL_PERMISSION_DENIED', 406);\n@@ -265,7 +266,7 @@ public function changeFavoriteOwner(App\\Request $request)\n \t *\n \t * @throws \\App\\Exceptions\\NoPermitted\n \t */\n-\tpublic function validateForField(App\\Request $request)\n+\tpublic function validateForField(App\\Request $request): void\n \t{\n \t\t$fieldModel = Vtiger_Module_Model::getInstance($request->getModule())->getFieldByName($request->getByType('fieldName', 2));\n \t\tif (!$fieldModel || !$fieldModel->isActiveField() || !$fieldModel->isViewEnabled()) {\n@@ -288,7 +289,7 @@ public function validateForField(App\\Request $request)\n \t *\n \t * @throws \\App\\Exceptions\\NoPermitted\n \t */\n-\tpublic function validateByMode(App\\Request $request)\n+\tpublic function validateByMode(App\\Request $request): void\n \t{\n \t\tif ($request->isEmpty('purifyMode') || !$request->has('value')) {\n \t\t\tthrow new \\App\\Exceptions\\NoPermitted('ERR_ILLEGAL_VALUE', 406);\n@@ -299,4 +300,30 @@ public function validateByMode(App\\Request $request)\n \t\t]);\n \t\t$response->emit();\n \t}\n+\n+\t/**\n+\t * Validate file.\n+\t *\n+\t * @param App\\Request $request\n+\t *\n+\t * @return void\n+\t */\n+\tpublic function validateFile(App\\Request $request): void\n+\t{\n+\t\t$validate = false;\n+\t\tif ($request->has('base64')) {\n+\t\t\t$fileInstance = \\App\\Fields\\File::loadFromBase($request->getByType('base64', 'base64'), ['validateAllowedFormat' => 'image']);\n+\t\t\tif ($fileInstance && $fileInstance->validate()) {\n+\t\t\t\t$validate = true;\n+\t\t\t} else {\n+\t\t\t\t$validateError = $fileInstance->validateError;\n+\t\t\t}\n+\t\t}\n+\t\t$response = new Vtiger_Response();\n+\t\t$response->setResult([\n+\t\t\t'validate' => $validate,\n+\t\t\t'validateError' => $validateError ?? null,\n+\t\t]);\n+\t\t$response->emit();\n+\t}\n }"
        },
        {
          "filename": "public_html/layouts/resources/libraries/ckeditor/base64image/dialogs/dialog.js",
          "status": "modified",
          "additions": 225,
          "deletions": 134,
          "patch": "@@ -1,21 +1,24 @@\n-/* {[The file is published on the basis of YetiForce Public License 3.0 that can be found in the following directory: licenses/LicenseEN.txt or yetiforce.com]} */\n+/* {[The file is published on the basis of YetiForce Public License 5.0 that can be found in the following directory: licenses/LicenseEN.txt or yetiforce.com]} */\n+'use strict';\n \n CKEDITOR.dialog.add('base64image-dialog', function (editor) {\n-\tvar t = null,\n+\tlet self = null,\n \t\tselectedImg = null,\n \t\torgWidth = null,\n \t\torgHeight = null,\n \t\timgPreview = null,\n-\t\timgScal = 1,\n-\t\tlock = true;\n+\t\tsourceElements = [],\n+\t\timgScale = 1,\n+\t\tlock = true,\n+\t\tmaxUploadSize = CONFIG['maxUploadLimit'];\n \n \t/* Check File Reader Support */\n \tfunction fileSupport() {\n-\t\tvar r = false,\n+\t\tlet r = false,\n \t\t\tn = null;\n \t\ttry {\n \t\t\tif (FileReader) {\n-\t\t\t\tvar n = document.createElement('input');\n+\t\t\t\tlet n = document.createElement('input');\n \t\t\t\tif (n && 'files' in n) r = true;\n \t\t\t}\n \t\t} catch (e) {\n@@ -24,7 +27,7 @@ CKEDITOR.dialog.add('base64image-dialog', function (editor) {\n \t\tn = null;\n \t\treturn r;\n \t}\n-\tvar isFReaderSupported = fileSupport();\n+\tlet isFReaderSupported = fileSupport();\n \n \t/* Load preview image */\n \tfunction imagePreviewLoad(s) {\n@@ -35,10 +38,10 @@ CKEDITOR.dialog.add('base64image-dialog', function (editor) {\n \t\t}\n \n \t\t/* Create image */\n-\t\tvar i = new Image();\n+\t\tlet i = new Image();\n \n \t\t/* Display loading text in preview element */\n-\t\timgPreview.getElement().setHtml('Loading...');\n+\t\t$(imgPreview.getElement().$).progressIndicator({ position: 'html' });\n \n \t\t/* When image is loaded */\n \t\ti.onload = function () {\n@@ -47,11 +50,11 @@ CKEDITOR.dialog.add('base64image-dialog', function (editor) {\n \n \t\t\t/* Set attributes */\n \t\t\tif (orgWidth == null || orgHeight == null) {\n-\t\t\t\tt.setValueOf('tab-properties', 'width', this.width);\n-\t\t\t\tt.setValueOf('tab-properties', 'height', this.height);\n-\t\t\t\timgScal = 1;\n-\t\t\t\tif (this.height > 0 && this.width > 0) imgScal = this.width / this.height;\n-\t\t\t\tif (imgScal <= 0) imgScal = 1;\n+\t\t\t\tself.setValueOf('tab-properties', 'width', this.width);\n+\t\t\t\tself.setValueOf('tab-properties', 'height', this.height);\n+\t\t\t\timgScale = 1;\n+\t\t\t\tif (this.height > 0 && this.width > 0) imgScale = this.width / this.height;\n+\t\t\t\tif (imgScale <= 0) imgScale = 1;\n \t\t\t} else {\n \t\t\t\torgWidth = null;\n \t\t\t\torgHeight = null;\n@@ -62,7 +65,7 @@ CKEDITOR.dialog.add('base64image-dialog', function (editor) {\n \n \t\t\t/* Insert preview image */\n \t\t\ttry {\n-\t\t\t\tvar p = imgPreview.getElement().$;\n+\t\t\t\tlet p = imgPreview.getElement().$;\n \t\t\t\tif (p) p.appendChild(this);\n \t\t\t} catch (e) {}\n \t\t};\n@@ -82,39 +85,61 @@ CKEDITOR.dialog.add('base64image-dialog', function (editor) {\n \tfunction imagePreview(src) {\n \t\timgPreview.getElement().setHtml('');\n \t\tif (isFReaderSupported) {\n-\t\t\tvar fileI = t.getContentElement('tab-source', 'file');\n-\t\t\tvar n = null;\n-\t\t\ttry {\n-\t\t\t\tn = fileI.getInputElement().$;\n-\t\t\t} catch (e) {\n-\t\t\t\tn = null;\n-\t\t\t}\n-\t\t\tif (n && 'files' in n && n.files && n.files.length > 0 && n.files[0]) {\n-\t\t\t\tif ('type' in n.files[0] && !n.files[0].type.match('image.*')) return;\n-\t\t\t\tif (!FileReader) return;\n-\t\t\t\timgPreview.getElement().setHtml('Loading...');\n-\t\t\t\tvar fr = new FileReader();\n-\t\t\t\tfr.onload = (function (f) {\n-\t\t\t\t\treturn function (e) {\n-\t\t\t\t\t\timgPreview.getElement().setHtml('');\n-\t\t\t\t\t\timagePreviewLoad(e.target.result);\n-\t\t\t\t\t};\n-\t\t\t\t})(n.files[0]);\n-\t\t\t\tfr.onerror = function () {\n+\t\t\t$(imgPreview.getElement().$).progressIndicator({ position: 'html' });\n+\t\t\treadImageAsBase64()\n+\t\t\t\t.done(function (base) {\n \t\t\t\t\timgPreview.getElement().setHtml('');\n-\t\t\t\t};\n-\t\t\t\tfr.onabort = function () {\n+\t\t\t\t\timagePreviewLoad(base);\n+\t\t\t\t})\n+\t\t\t\t.fail(function () {\n \t\t\t\t\timgPreview.getElement().setHtml('');\n-\t\t\t\t};\n-\t\t\t\tfr.readAsDataURL(n.files[0]);\n+\t\t\t\t});\n+\t\t}\n+\t}\n+\n+\tfunction readImageAsBase64() {\n+\t\tconst aDeferred = jQuery.Deferred();\n+\t\tlet fileI = self.getContentElement('tab-source', 'file'),\n+\t\t\tn = null;\n+\t\ttry {\n+\t\t\tn = fileI.getInputElement().$;\n+\t\t} catch (e) {\n+\t\t\tn = null;\n+\t\t}\n+\t\tif (n && 'files' in n && n.files && n.files.length > 0 && n.files[0]) {\n+\t\t\tif (('type' in n.files[0] && !n.files[0].type.match('image.*')) || !FileReader) {\n+\t\t\t\taDeferred.reject();\n+\t\t\t\treturn aDeferred.promise();\n+\t\t\t}\n+\t\t\tif (n.files[0].size > maxUploadSize) {\n+\t\t\t\tapp.showNotify({\n+\t\t\t\t\ttext: app.vtranslate('JS_UPLOADED_FILE_SIZE_EXCEEDS'),\n+\t\t\t\t\ttype: 'error'\n+\t\t\t\t});\n+\t\t\t\taDeferred.reject();\n+\t\t\t\treturn aDeferred.promise();\n \t\t\t}\n+\t\t\tlet fr = new FileReader();\n+\t\t\tfr.onload = (function (f) {\n+\t\t\t\treturn function (e) {\n+\t\t\t\t\taDeferred.resolve(e.target.result);\n+\t\t\t\t};\n+\t\t\t})(n.files[0]);\n+\t\t\tfr.onerror = function () {\n+\t\t\t\taDeferred.reject();\n+\t\t\t};\n+\t\t\tfr.onabort = function () {\n+\t\t\t\taDeferred.reject();\n+\t\t\t};\n+\t\t\tfr.readAsDataURL(n.files[0]);\n \t\t}\n+\t\treturn aDeferred.promise();\n \t}\n \n \tfunction getImageDimensions() {\n-\t\tvar o = {\n-\t\t\tw: t.getContentElement('tab-properties', 'width').getValue(),\n-\t\t\th: t.getContentElement('tab-properties', 'height').getValue(),\n+\t\tlet o = {\n+\t\t\tw: self.getContentElement('tab-properties', 'width').getValue(),\n+\t\t\th: self.getContentElement('tab-properties', 'height').getValue(),\n \t\t\tuw: 'px',\n \t\t\tuh: 'px'\n \t\t};\n@@ -128,34 +153,81 @@ CKEDITOR.dialog.add('base64image-dialog', function (editor) {\n \t}\n \n \tfunction imageDimensions(src) {\n-\t\tvar o = getImageDimensions();\n-\t\tvar u = 'px';\n+\t\tlet o = getImageDimensions();\n+\t\tlet u = 'px';\n \t\tif (src == 'width') {\n \t\t\tif (o.uw == '%') u = '%';\n-\t\t\to.h = Math.round(o.w / imgScal);\n+\t\t\to.h = Math.round(o.w / imgScale);\n \t\t} else {\n \t\t\tif (o.uh == '%') u = '%';\n-\t\t\to.w = Math.round(o.h * imgScal);\n+\t\t\to.w = Math.round(o.h * imgScale);\n \t\t}\n \t\tif (u == '%') {\n \t\t\to.w += '%';\n \t\t\to.h += '%';\n \t\t}\n-\t\tt.getContentElement('tab-properties', 'width').setValue(o.w),\n-\t\t\tt.getContentElement('tab-properties', 'height').setValue(o.h);\n+\t\tself.getContentElement('tab-properties', 'width').setValue(o.w),\n+\t\t\tself.getContentElement('tab-properties', 'height').setValue(o.h);\n \t}\n \n \tfunction integerValue(elem) {\n-\t\tvar v = elem.getValue(),\n+\t\tlet v = elem.getValue(),\n \t\t\tu = '';\n \t\tif (v.indexOf('%') >= 0) u = '%';\n \t\tv = parseInt(v, 10);\n \t\tif (isNaN(v)) v = 0;\n \t\telem.setValue(v + u);\n \t}\n \n+\tfunction validateFile() {\n+\t\tconst fieldInfo = $(editor.element.$).data('fieldinfo');\n+\t\tlet length = editor.getData().length,\n+\t\t\tselectedImg = editor.getSelection();\n+\t\tif (selectedImg) selectedImg = selectedImg.getSelectedElement();\n+\t\tif (!selectedImg || selectedImg.getName() !== 'img') selectedImg = null;\n+\t\tif (selectedImg) {\n+\t\t\tlength = length - selectedImg.getOuterHtml().length;\n+\t\t}\n+\t\tconst aDeferred = jQuery.Deferred();\n+\t\treadImageAsBase64()\n+\t\t\t.done((base) => {\n+\t\t\t\tlength += base.length;\n+\t\t\t\tif (length > fieldInfo['maximumlength']) {\n+\t\t\t\t\tapp.showNotify({\n+\t\t\t\t\t\ttext: app.vtranslate('JS_MAXIMUM_TEXT_SIZE_IN_BYTES') + ' ' + fieldInfo['maximumlength'],\n+\t\t\t\t\t\ttype: 'error'\n+\t\t\t\t\t});\n+\t\t\t\t}\n+\t\t\t\tAppConnector.request({\n+\t\t\t\t\tmodule: app.getModuleName(),\n+\t\t\t\t\taction: 'Fields',\n+\t\t\t\t\tmode: 'validateFile',\n+\t\t\t\t\tfieldName: fieldInfo['name'],\n+\t\t\t\t\tbase64: base\n+\t\t\t\t})\n+\t\t\t\t\t.done((data) => {\n+\t\t\t\t\t\tif (data.result.validate) {\n+\t\t\t\t\t\t\taDeferred.resolve();\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tapp.showNotify({\n+\t\t\t\t\t\t\t\ttext: data.result.validateError,\n+\t\t\t\t\t\t\t\ttype: 'error'\n+\t\t\t\t\t\t\t});\n+\t\t\t\t\t\t\taDeferred.reject();\n+\t\t\t\t\t\t}\n+\t\t\t\t\t})\n+\t\t\t\t\t.fail(function () {\n+\t\t\t\t\t\taDeferred.resolve();\n+\t\t\t\t\t});\n+\t\t\t})\n+\t\t\t.fail(() => {\n+\t\t\t\taDeferred.reject();\n+\t\t\t});\n+\t\treturn aDeferred.promise();\n+\t}\n+\n \tif (isFReaderSupported) {\n-\t\tvar sourceElements = [\n+\t\tsourceElements = [\n \t\t\t{\n \t\t\t\ttype: 'hbox',\n \t\t\t\twidths: ['70px'],\n@@ -165,8 +237,16 @@ CKEDITOR.dialog.add('base64image-dialog', function (editor) {\n \t\t\t\t\t\ttype: 'file',\n \t\t\t\t\t\tid: 'file',\n \t\t\t\t\t\tlabel: '',\n-\t\t\t\t\t\tonChange: function () {\n-\t\t\t\t\t\t\timagePreview('file');\n+\t\t\t\t\t\tsize: maxUploadSize,\n+\t\t\t\t\t\tonChange: function (a) {\n+\t\t\t\t\t\t\tvalidateFile()\n+\t\t\t\t\t\t\t\t.done(() => {\n+\t\t\t\t\t\t\t\t\timagePreview('file');\n+\t\t\t\t\t\t\t\t})\n+\t\t\t\t\t\t\t\t.fail(function () {\n+\t\t\t\t\t\t\t\t\tself.getContentElement('tab-source', 'file').getInputElement().$.value = null;\n+\t\t\t\t\t\t\t\t\timgPreview.getElement().setHtml('');\n+\t\t\t\t\t\t\t\t});\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n \t\t\t\t]\n@@ -240,22 +320,25 @@ CKEDITOR.dialog.add('base64image-dialog', function (editor) {\n \t\t\t\t);\n \t\t},\n \t\tonShow: function () {\n+\t\t\tthis.getContentElement('tab-source', 'file')\n+\t\t\t\t.getInputElement()\n+\t\t\t\t.$.setAttribute('accept', 'image/jpeg, image/png, image/gif');\n \t\t\t/* Remove preview */\n \t\t\timgPreview.getElement().setHtml('');\n \n-\t\t\t(t = this), (orgWidth = null), (orgHeight = null), (imgScal = 1), (lock = true);\n+\t\t\t(self = this), (orgWidth = null), (orgHeight = null), (imgScale = 1), (lock = true);\n \n \t\t\t/* selected image or null */\n \t\t\tselectedImg = editor.getSelection();\n \t\t\tif (selectedImg) selectedImg = selectedImg.getSelectedElement();\n \t\t\tif (!selectedImg || selectedImg.getName() !== 'img') selectedImg = null;\n \n \t\t\t/* Set input values */\n-\t\t\tt.setValueOf('tab-properties', 'lock', lock);\n-\t\t\tt.setValueOf('tab-properties', 'vmargin', '0');\n-\t\t\tt.setValueOf('tab-properties', 'hmargin', '0');\n-\t\t\tt.setValueOf('tab-properties', 'border', '0');\n-\t\t\tt.setValueOf('tab-properties', 'align', 'none');\n+\t\t\tself.setValueOf('tab-properties', 'lock', lock);\n+\t\t\tself.setValueOf('tab-properties', 'vmargin', '0');\n+\t\t\tself.setValueOf('tab-properties', 'hmargin', '0');\n+\t\t\tself.setValueOf('tab-properties', 'border', '0');\n+\t\t\tself.setValueOf('tab-properties', 'align', 'none');\n \t\t\tif (selectedImg) {\n \t\t\t\t/* Set input values from selected image */\n \t\t\t\tif (typeof selectedImg.getAttribute('width') == 'string') orgWidth = selectedImg.getAttribute('width');\n@@ -265,13 +348,13 @@ CKEDITOR.dialog.add('base64image-dialog', function (editor) {\n \t\t\t\t\torgHeight = selectedImg.$.height;\n \t\t\t\t}\n \t\t\t\tif (orgWidth != null && orgHeight != null) {\n-\t\t\t\t\tt.setValueOf('tab-properties', 'width', orgWidth);\n-\t\t\t\t\tt.setValueOf('tab-properties', 'height', orgHeight);\n+\t\t\t\t\tself.setValueOf('tab-properties', 'width', orgWidth);\n+\t\t\t\t\tself.setValueOf('tab-properties', 'height', orgHeight);\n \t\t\t\t\torgWidth = parseInt(orgWidth, 10);\n \t\t\t\t\torgHeight = parseInt(orgHeight, 10);\n-\t\t\t\t\timgScal = 1;\n-\t\t\t\t\tif (!isNaN(orgWidth) && !isNaN(orgHeight) && orgHeight > 0 && orgWidth > 0) imgScal = orgWidth / orgHeight;\n-\t\t\t\t\tif (imgScal <= 0) imgScal = 1;\n+\t\t\t\t\timgScale = 1;\n+\t\t\t\t\tif (!isNaN(orgWidth) && !isNaN(orgHeight) && orgHeight > 0 && orgWidth > 0) imgScale = orgWidth / orgHeight;\n+\t\t\t\t\tif (imgScale <= 0) imgScale = 1;\n \t\t\t\t}\n \n \t\t\t\tif (typeof selectedImg.getAttribute('src') == 'string') {\n@@ -281,116 +364,124 @@ CKEDITOR.dialog.add('base64image-dialog', function (editor) {\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t\tif (typeof selectedImg.getAttribute('alt') == 'string')\n-\t\t\t\t\tt.setValueOf('tab-properties', 'alt', selectedImg.getAttribute('alt'));\n+\t\t\t\t\tself.setValueOf('tab-properties', 'alt', selectedImg.getAttribute('alt'));\n \t\t\t\tif (typeof selectedImg.getAttribute('hspace') == 'string')\n-\t\t\t\t\tt.setValueOf('tab-properties', 'hmargin', selectedImg.getAttribute('hspace'));\n+\t\t\t\t\tself.setValueOf('tab-properties', 'hmargin', selectedImg.getAttribute('hspace'));\n \t\t\t\tif (typeof selectedImg.getAttribute('vspace') == 'string')\n-\t\t\t\t\tt.setValueOf('tab-properties', 'vmargin', selectedImg.getAttribute('vspace'));\n+\t\t\t\t\tself.setValueOf('tab-properties', 'vmargin', selectedImg.getAttribute('vspace'));\n \t\t\t\tif (typeof selectedImg.getAttribute('border') == 'string')\n-\t\t\t\t\tt.setValueOf('tab-properties', 'border', selectedImg.getAttribute('border'));\n+\t\t\t\t\tself.setValueOf('tab-properties', 'border', selectedImg.getAttribute('border'));\n \t\t\t\tif (typeof selectedImg.getAttribute('align') == 'string') {\n \t\t\t\t\tswitch (selectedImg.getAttribute('align')) {\n \t\t\t\t\t\tcase 'top':\n \t\t\t\t\t\tcase 'text-top':\n-\t\t\t\t\t\t\tt.setValueOf('tab-properties', 'align', 'top');\n+\t\t\t\t\t\t\tself.setValueOf('tab-properties', 'align', 'top');\n \t\t\t\t\t\t\tbreak;\n \t\t\t\t\t\tcase 'baseline':\n \t\t\t\t\t\tcase 'bottom':\n \t\t\t\t\t\tcase 'text-bottom':\n-\t\t\t\t\t\t\tt.setValueOf('tab-properties', 'align', 'bottom');\n+\t\t\t\t\t\t\tself.setValueOf('tab-properties', 'align', 'bottom');\n \t\t\t\t\t\t\tbreak;\n \t\t\t\t\t\tcase 'left':\n-\t\t\t\t\t\t\tt.setValueOf('tab-properties', 'align', 'left');\n+\t\t\t\t\t\t\tself.setValueOf('tab-properties', 'align', 'left');\n \t\t\t\t\t\t\tbreak;\n \t\t\t\t\t\tcase 'right':\n-\t\t\t\t\t\t\tt.setValueOf('tab-properties', 'align', 'right');\n+\t\t\t\t\t\t\tself.setValueOf('tab-properties', 'align', 'right');\n \t\t\t\t\t\t\tbreak;\n \t\t\t\t\t}\n \t\t\t\t}\n-\t\t\t\tt.selectPage('tab-properties');\n+\t\t\t\tself.selectPage('tab-properties');\n \t\t\t}\n \t\t},\n \t\tonOk: function () {\n \t\t\t/* Get image source */\n-\t\t\tvar src = '';\n+\t\t\tlet src = '';\n \t\t\ttry {\n \t\t\t\tsrc = CKEDITOR.document.getById(editor.id + 'previewimage').$.src;\n \t\t\t} catch (e) {\n \t\t\t\tsrc = '';\n \t\t\t}\n \t\t\tif (typeof src != 'string' || src == null || src === '') return;\n \n-\t\t\t/* selected image or new image */\n-\t\t\tif (selectedImg) var newImg = selectedImg;\n-\t\t\telse var newImg = editor.document.createElement('img');\n-\t\t\tnewImg.setAttribute('src', src);\n-\t\t\tsrc = null;\n+\t\t\tvalidateFile().always(() => {\n+\t\t\t\t/* selected image or new image */\n+\t\t\t\tif (selectedImg) {\n+\t\t\t\t\tvar newImg = selectedImg;\n+\t\t\t\t} else {\n+\t\t\t\t\tvar newImg = editor.document.createElement('img');\n+\t\t\t\t}\n+\t\t\t\tnewImg.setAttribute('src', src);\n+\t\t\t\tsrc = null;\n \n-\t\t\t/* Set attributes */\n-\t\t\tnewImg.setAttribute('alt', t.getValueOf('tab-properties', 'alt').replace(/^\\s+/, '').replace(/\\s+$/, ''));\n-\t\t\tvar attr = {\n-\t\t\t\t\twidth: ['width', 'width:#;', 'integer', 1],\n-\t\t\t\t\theight: ['height', 'height:#;', 'integer', 1],\n-\t\t\t\t\tvmargin: ['vspace', 'margin-top:#;margin-bottom:#;', 'integer', 0],\n-\t\t\t\t\thmargin: ['hspace', 'margin-left:#;margin-right:#;', 'integer', 0],\n-\t\t\t\t\talign: ['align', ''],\n-\t\t\t\t\tborder: ['border', 'border:# solid black;', 'integer', 0]\n-\t\t\t\t},\n-\t\t\t\tcss = [],\n-\t\t\t\tvalue,\n-\t\t\t\tcssvalue,\n-\t\t\t\tattrvalue,\n-\t\t\t\tk;\n-\t\t\tfor (k in attr) {\n-\t\t\t\tvalue = t.getValueOf('tab-properties', k);\n-\t\t\t\tattrvalue = value;\n-\t\t\t\tcssvalue = value;\n-\t\t\t\tunit = 'px';\n-\n-\t\t\t\tif (k == 'align') {\n-\t\t\t\t\tswitch (value) {\n-\t\t\t\t\t\tcase 'top':\n-\t\t\t\t\t\tcase 'bottom':\n-\t\t\t\t\t\t\tattr[k][1] = 'vertical-align:#;';\n-\t\t\t\t\t\t\tbreak;\n-\t\t\t\t\t\tcase 'left':\n-\t\t\t\t\t\tcase 'right':\n-\t\t\t\t\t\t\tattr[k][1] = 'float:#;';\n-\t\t\t\t\t\t\tbreak;\n-\t\t\t\t\t\tdefault:\n-\t\t\t\t\t\t\tvalue = null;\n-\t\t\t\t\t\t\tbreak;\n+\t\t\t\t/* Set attributes */\n+\t\t\t\tnewImg.setAttribute('alt', self.getValueOf('tab-properties', 'alt').replace(/^\\s+/, '').replace(/\\s+$/, ''));\n+\t\t\t\tlet attr = {\n+\t\t\t\t\t\twidth: ['width', 'width:#;', 'integer', 1],\n+\t\t\t\t\t\theight: ['height', 'height:#;', 'integer', 1],\n+\t\t\t\t\t\tvmargin: ['vspace', 'margin-top:#;margin-bottom:#;', 'integer', 0],\n+\t\t\t\t\t\thmargin: ['hspace', 'margin-left:#;margin-right:#;', 'integer', 0],\n+\t\t\t\t\t\talign: ['align', ''],\n+\t\t\t\t\t\tborder: ['border', 'border:# solid black;', 'integer', 0]\n+\t\t\t\t\t},\n+\t\t\t\t\tcss = [],\n+\t\t\t\t\tvalue,\n+\t\t\t\t\tcssValue,\n+\t\t\t\t\tattrValue,\n+\t\t\t\t\tunit,\n+\t\t\t\t\tk;\n+\t\t\t\tfor (k in attr) {\n+\t\t\t\t\tvalue = self.getValueOf('tab-properties', k);\n+\t\t\t\t\tattrValue = value;\n+\t\t\t\t\tcssValue = value;\n+\t\t\t\t\tunit = 'px';\n+\n+\t\t\t\t\tif (k == 'align') {\n+\t\t\t\t\t\tswitch (value) {\n+\t\t\t\t\t\t\tcase 'top':\n+\t\t\t\t\t\t\tcase 'bottom':\n+\t\t\t\t\t\t\t\tattr[k][1] = 'vertical-align:#;';\n+\t\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\t\tcase 'left':\n+\t\t\t\t\t\t\tcase 'right':\n+\t\t\t\t\t\t\t\tattr[k][1] = 'float:#;';\n+\t\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\t\tdefault:\n+\t\t\t\t\t\t\t\tvalue = null;\n+\t\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\t}\n \t\t\t\t\t}\n-\t\t\t\t}\n \n-\t\t\t\tif (attr[k][2] == 'integer') {\n-\t\t\t\t\tif (value.indexOf('%') >= 0) unit = '%';\n-\t\t\t\t\tvalue = parseInt(value, 10);\n-\t\t\t\t\tif (isNaN(value)) value = null;\n-\t\t\t\t\telse if (value < attr[k][3]) value = null;\n-\t\t\t\t\tif (value != null) {\n-\t\t\t\t\t\tif (unit == '%') {\n-\t\t\t\t\t\t\tattrvalue = value + '%';\n-\t\t\t\t\t\t\tcssvalue = value + '%';\n-\t\t\t\t\t\t} else {\n-\t\t\t\t\t\t\tattrvalue = value;\n-\t\t\t\t\t\t\tcssvalue = value + 'px';\n+\t\t\t\t\tif (attr[k][2] == 'integer') {\n+\t\t\t\t\t\tif (value.indexOf('%') >= 0) unit = '%';\n+\t\t\t\t\t\tvalue = parseInt(value, 10);\n+\t\t\t\t\t\tif (isNaN(value)) value = null;\n+\t\t\t\t\t\telse if (value < attr[k][3]) value = null;\n+\t\t\t\t\t\tif (value != null) {\n+\t\t\t\t\t\t\tif (unit == '%') {\n+\t\t\t\t\t\t\t\tattrValue = value + '%';\n+\t\t\t\t\t\t\t\tcssValue = value + '%';\n+\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\tattrValue = value;\n+\t\t\t\t\t\t\t\tcssValue = value + 'px';\n+\t\t\t\t\t\t\t}\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n-\t\t\t\t}\n \n-\t\t\t\tif (value != null) {\n-\t\t\t\t\tnewImg.setAttribute(attr[k][0], attrvalue);\n-\t\t\t\t\tcss.push(attr[k][1].replace(/#/g, cssvalue));\n+\t\t\t\t\tif (value != null) {\n+\t\t\t\t\t\tnewImg.setAttribute(attr[k][0], attrValue);\n+\t\t\t\t\t\tcss.push(attr[k][1].replace(/#/g, cssValue));\n+\t\t\t\t\t}\n \t\t\t\t}\n-\t\t\t}\n-\t\t\tif (css.length > 0) newImg.setAttribute('style', css.join(''));\n+\t\t\t\tif (css.length > 0) newImg.setAttribute('style', css.join(''));\n+\n+\t\t\t\t/* Insert new image */\n+\t\t\t\tif (!selectedImg) editor.insertElement(newImg);\n \n-\t\t\t/* Insert new image */\n-\t\t\tif (!selectedImg) editor.insertElement(newImg);\n+\t\t\t\t/* Resize image */\n+\t\t\t\tif (editor.plugins.imageresize) editor.plugins.imageresize.resize(editor, newImg, 800, 800);\n \n-\t\t\t/* Resize image */\n-\t\t\tif (editor.plugins.imageresize) editor.plugins.imageresize.resize(editor, newImg, 800, 800);\n+\t\t\t\teditor.updateElement();\n+\t\t\t});\n \t\t},\n \n \t\t/* Dialog form */"
        },
        {
          "filename": "public_html/layouts/resources/libraries/ckeditor/base64image/plugin.js",
          "status": "modified",
          "additions": 115,
          "deletions": 69,
          "patch": "@@ -1,72 +1,28 @@\n-/* {[The file is published on the basis of YetiForce Public License 3.0 that can be found in the following directory: licenses/LicenseEN.txt or yetiforce.com]} */\n-\n-function initPasteEvent(editorInstance) {\n-\tif (editorInstance.addFeature) {\n-\t\teditorInstance.addFeature({\n-\t\t\tallowedContent: 'img[alt,id,!src]{width,height};'\n-\t\t});\n-\t}\n-\n-\teditorInstance.on('contentDom', function () {\n-\t\tvar editableElement = editorInstance.editable ? editorInstance.editable() : editorInstance.document;\n-\t\teditableElement.on('paste', onPaste, null, { editor: editorInstance });\n-\t});\n-}\n-function onPaste(event) {\n-\tvar editor = event.listenerData && event.listenerData.editor;\n-\tvar $event = event.data.$;\n-\tvar clipboardData = $event.clipboardData;\n-\tvar found = false;\n-\tvar imageType = /^image/;\n-\n-\tif (!clipboardData) {\n-\t\treturn;\n-\t}\n-\treturn Array.prototype.forEach.call(clipboardData.types, function (type, i) {\n-\t\tif (found) {\n-\t\t\treturn;\n-\t\t}\n-\t\tif (type.match(imageType) || clipboardData.items[i].type.match(imageType)) {\n-\t\t\treadImageAsBase64(clipboardData.items[i], editor);\n-\t\t\treturn (found = true);\n-\t\t}\n-\t});\n-}\n-\n-function readImageAsBase64(item, editor) {\n-\tif (!item || typeof item.getAsFile !== 'function') {\n-\t\treturn;\n-\t}\n-\tvar file = item.getAsFile();\n-\tvar reader = new FileReader();\n-\treader.onload = function (evt) {\n-\t\tvar element = editor.document.createElement('img', {\n-\t\t\tattributes: {\n-\t\t\t\tsrc: evt.target.result\n-\t\t\t}\n-\t\t});\n-\t\tsetTimeout(function () {\n-\t\t\teditor.insertElement(element);\n-\t\t}, 10);\n-\t};\n-\treader.readAsDataURL(file);\n-}\n+/* {[The file is published on the basis of YetiForce Public License 5.0 that can be found in the following directory: licenses/LicenseEN.txt or yetiforce.com]} */\n+'use strict';\n \n CKEDITOR.plugins.add('base64image', {\n \trequires: 'dialog',\n \ticons: 'base64image',\n \thidpi: true,\n-\tinit: function (editorInstance) {\n-\t\tinitPasteEvent(editorInstance);\n-\t\tvar pluginName = 'base64image-dialog';\n-\t\teditorInstance.ui.addToolbarGroup('base64image', 'insert');\n-\t\teditorInstance.ui.addButton('base64image', {\n-\t\t\tlabel: editorInstance.lang.common.image,\n+\tinit: function (editor) {\n+\t\tif (editor.addFeature) {\n+\t\t\teditor.addFeature({\n+\t\t\t\tallowedContent: 'img[alt,id,!src]{width,height};'\n+\t\t\t});\n+\t\t}\n+\t\teditor.on('paste', (event, a, b) => {\n+\t\t\tthis.onPaste(event);\n+\t\t});\n+\t\tconst pluginName = 'base64image-dialog';\n+\t\teditor.ui.addToolbarGroup('base64image', 'insert');\n+\t\teditor.ui.addButton('base64image', {\n+\t\t\tlabel: editor.lang.common.image,\n \t\t\tcommand: pluginName,\n \t\t\ttoolbar: 'insert'\n \t\t});\n \t\tCKEDITOR.dialog.add(pluginName, this.path + 'dialogs/dialog.js');\n-\t\teditorInstance.addCommand(\n+\t\teditor.addCommand(\n \t\t\tpluginName,\n \t\t\tnew CKEDITOR.dialogCommand(pluginName, {\n \t\t\t\tallowedContent:\n@@ -78,29 +34,119 @@ CKEDITOR.plugins.add('base64image', {\n \t\t\t\t]\n \t\t\t})\n \t\t);\n-\t\teditorInstance.on('doubleclick', function (evt) {\n+\t\teditor.on('doubleclick', function (evt) {\n \t\t\tif (evt.data.element && !evt.data.element.isReadOnly() && evt.data.element.getName() === 'img') {\n \t\t\t\tevt.data.dialog = pluginName;\n-\t\t\t\teditorInstance.getSelection().selectElement(evt.data.element);\n+\t\t\t\teditor.getSelection().selectElement(evt.data.element);\n \t\t\t}\n \t\t});\n-\t\tif (editorInstance.addMenuItem) {\n-\t\t\teditorInstance.addMenuGroup('imageToBase64Group');\n-\t\t\teditorInstance.addMenuItem('imageToBase64Item', {\n-\t\t\t\tlabel: editorInstance.lang.common.image,\n+\t\tif (editor.addMenuItem) {\n+\t\t\teditor.addMenuGroup('imageToBase64Group');\n+\t\t\teditor.addMenuItem('imageToBase64Item', {\n+\t\t\t\tlabel: editor.lang.common.image,\n \t\t\t\ticon: this.path + 'icons/base64image.png',\n \t\t\t\tcommand: pluginName,\n \t\t\t\tgroup: 'imageToBase64Group'\n \t\t\t});\n \t\t}\n-\t\tif (editorInstance.contextMenu) {\n-\t\t\teditorInstance.contextMenu.addListener(function (element, selection) {\n+\t\tif (editor.contextMenu) {\n+\t\t\teditor.contextMenu.addListener(function (element) {\n \t\t\t\tif (element && element.getName() === 'img') {\n-\t\t\t\t\teditorInstance.getSelection().selectElement(element);\n+\t\t\t\t\teditor.getSelection().selectElement(element);\n \t\t\t\t\treturn { imageToBase64Item: CKEDITOR.TRISTATE_ON };\n \t\t\t\t}\n \t\t\t\treturn null;\n \t\t\t});\n \t\t}\n+\t},\n+\tonPaste: function (event) {\n+\t\tconst self = this,\n+\t\t\tallowedTypes = 'image/jpeg|image/png|image/gif',\n+\t\t\tdataTransfer = event.data.dataTransfer,\n+\t\t\teditor = event.editor,\n+\t\t\tcount = dataTransfer.getFilesCount();\n+\t\tfor (let index = 0; index < count; index++) {\n+\t\t\tlet file = dataTransfer.getFile(index);\n+\t\t\tif (file.type.match(allowedTypes)) {\n+\t\t\t\tself\n+\t\t\t\t\t.validateFile(file, editor)\n+\t\t\t\t\t.done(function (base) {\n+\t\t\t\t\t\tlet image,\n+\t\t\t\t\t\t\tselectedImg = editor.getSelection();\n+\t\t\t\t\t\tif (selectedImg) selectedImg = selectedImg.getSelectedElement();\n+\t\t\t\t\t\tif (!selectedImg || selectedImg.getName() !== 'img') selectedImg = null;\n+\t\t\t\t\t\tif (selectedImg) {\n+\t\t\t\t\t\t\timage = selectedImg;\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\timage = editor.document.createElement('img');\n+\t\t\t\t\t\t}\n+\t\t\t\t\t\timage.setAttribute('src', base);\n+\t\t\t\t\t\tif (!selectedImg) editor.insertElement(image);\n+\t\t\t\t\t})\n+\t\t\t\t\t.fail(function (error) {\n+\t\t\t\t\t\teditor.showNotification(error, 'warning');\n+\t\t\t\t\t});\n+\t\t\t} else {\n+\t\t\t\teditor.showNotification(\n+\t\t\t\t\tapp.vtranslate('JS_INVALID_FILE_TYPE') +\n+\t\t\t\t\t\t'<br>' +\n+\t\t\t\t\t\tapp.vtranslate('JS_AVAILABLE_FILE_TYPES') +\n+\t\t\t\t\t\t': ' +\n+\t\t\t\t\t\tallowedTypes.replace(/\\|/g, ', '),\n+\t\t\t\t\t'warning'\n+\t\t\t\t);\n+\t\t\t}\n+\t\t}\n+\t},\n+\tvalidateFile: function (file, editor) {\n+\t\tconst aDeferred = jQuery.Deferred();\n+\t\tif (file.size > CONFIG['maxUploadLimit']) {\n+\t\t\taDeferred.reject(app.vtranslate('JS_UPLOADED_FILE_SIZE_EXCEEDS'));\n+\t\t}\n+\t\tthis.readAndValidate(file, editor)\n+\t\t\t.done(function (base) {\n+\t\t\t\taDeferred.resolve(base);\n+\t\t\t})\n+\t\t\t.fail(function (error) {\n+\t\t\t\taDeferred.reject(error);\n+\t\t\t});\n+\t\treturn aDeferred.promise();\n+\t},\n+\treadAndValidate: function (file, editor) {\n+\t\tconst aDeferred = jQuery.Deferred(),\n+\t\t\tfieldInfo = $(editor.element.$).data('fieldinfo');\n+\t\tlet length = editor.getData().length,\n+\t\t\tselectedImg = editor.getSelection();\n+\t\tif (selectedImg) selectedImg = selectedImg.getSelectedElement();\n+\t\tif (!selectedImg || selectedImg.getName() !== 'img') selectedImg = null;\n+\t\tif (selectedImg) {\n+\t\t\tlength = length - selectedImg.getOuterHtml().length;\n+\t\t}\n+\t\tconst fileReader = new FileReader();\n+\t\tfileReader.onload = function (evt) {\n+\t\t\tlength += evt.target.result.length;\n+\t\t\tif (length > fieldInfo['maximumlength']) {\n+\t\t\t\treturn aDeferred.reject(app.vtranslate('JS_MAXIMUM_TEXT_SIZE_IN_BYTES') + ' ' + fieldInfo['maximumlength']);\n+\t\t\t}\n+\t\t\tAppConnector.request({\n+\t\t\t\tmodule: app.getModuleName(),\n+\t\t\t\taction: 'Fields',\n+\t\t\t\tmode: 'validateFile',\n+\t\t\t\tfieldName: fieldInfo['name'],\n+\t\t\t\tbase64: evt.target.result\n+\t\t\t})\n+\t\t\t\t.done((data) => {\n+\t\t\t\t\tif (data.result.validate) {\n+\t\t\t\t\t\taDeferred.resolve(evt.target.result);\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\taDeferred.reject(data.result.validateError);\n+\t\t\t\t\t}\n+\t\t\t\t})\n+\t\t\t\t.fail(function () {\n+\t\t\t\t\taDeferred.reject();\n+\t\t\t\t});\n+\t\t};\n+\t\tfileReader.readAsDataURL(file);\n+\t\treturn aDeferred.promise();\n \t}\n });"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 1,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 6,
        "max_directory_depth": 7
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "de296d83c1d36bf0d92303efa9706ded67549aa8",
            "date": "2024-09-13T11:37:49Z",
            "author_login": "rskrzypczak"
          },
          {
            "sha": "4b5e4244b8338c837a8132ff12686f29f222d89b",
            "date": "2024-01-02T08:25:56Z",
            "author_login": "mariuszkrzaczkowski"
          },
          {
            "sha": "f1904a62fc5cd4d5bb3031b19bb2d090bce49ca6",
            "date": "2023-11-27T04:46:42Z",
            "author_login": "rskrzypczak"
          },
          {
            "sha": "711d9fe4c1caddec2dfef52f8ed06ddcebfd2dff",
            "date": "2023-11-08T05:36:13Z",
            "author_login": "rskrzypczak"
          },
          {
            "sha": "4e7ad0fbee5409248285b22fce0ea754d365add4",
            "date": "2023-11-07T16:50:11Z",
            "author_login": "rskrzypczak"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.1,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N",
    "cwe_id": "CWE-434",
    "description": "Unrestructed file upload in GitHub repository yetiforcecompany/yetiforcecrm prior to 6.4.0. Attacker can send malicious files to the victims is able to retrieve the stored data from the web application without that data being made safe to render in the browser and steals victim's cookie leads to account takeover.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2022-05-05T11:15:08.047",
    "last_modified": "2024-11-21T06:40:40.633",
    "fix_date": "2022-05-05T09:49:50Z"
  },
  "references": [
    {
      "url": "https://github.com/yetiforcecompany/yetiforcecrm/commit/bf69c427260011ffca42f7b6935bb54080c54124",
      "source": "security@huntr.dev",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/75c7cf09-d118-4f91-9686-22b142772529",
      "source": "security@huntr.dev",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/yetiforcecompany/yetiforcecrm/commit/bf69c427260011ffca42f7b6935bb54080c54124",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/75c7cf09-d118-4f91-9686-22b142772529",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:03:04.444446",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "YetiForceCRM",
    "owner": "yetiforcecompany",
    "created_at": "2014-12-15T22:55:47Z",
    "updated_at": "2025-01-14T02:56:49Z",
    "pushed_at": "2024-09-13T11:43:27Z",
    "size": 419522,
    "stars": 1745,
    "forks": 745,
    "open_issues": 83,
    "watchers": 1745,
    "has_security_policy": false,
    "default_branch": "developer",
    "protected_branches": [],
    "languages": {
      "PHP": 10752494,
      "Smarty": 2974130,
      "JavaScript": 2297348,
      "CSS": 632280,
      "SCSS": 191499,
      "Vue": 129717,
      "Less": 62688,
      "Stylus": 32572,
      "HTML": 7942,
      "Shell": 6065,
      "Dockerfile": 3767,
      "Batchfile": 1536
    },
    "commit_activity": {
      "total_commits_last_year": 1,
      "avg_commits_per_week": 0.019230769230769232,
      "days_active_last_year": 1
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T13:10:51.726622"
  }
}