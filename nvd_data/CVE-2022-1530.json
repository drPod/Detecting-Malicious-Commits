{
  "cve_id": "CVE-2022-1530",
  "github_data": {
    "repository": "livehelperchat/livehelperchat",
    "fix_commit": "edef7a8387be718d0de2dfd1e722789afb0461bc",
    "related_commits": [
      "edef7a8387be718d0de2dfd1e722789afb0461bc",
      "edef7a8387be718d0de2dfd1e722789afb0461bc"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "edef7a8387be718d0de2dfd1e722789afb0461bc",
      "commit_date": "2022-04-27T05:40:03Z",
      "author": {
        "login": "remdex",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "3.99v",
        "length": 5,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 754,
        "additions": 411,
        "deletions": 343
      },
      "files": [
        {
          "filename": "lhc_web/cli/lib/install.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -1947,7 +1947,7 @@ function step3() {\n             $db->query(\"CREATE TABLE `lh_webhook` ( `id` int(11) NOT NULL AUTO_INCREMENT, `event` varchar(50) NOT NULL, `bot_id_alt` int(11) NOT NULL DEFAULT '0', `trigger_id_alt` int(11) NOT NULL DEFAULT '0',`bot_id` int(11) NOT NULL, `trigger_id` int(11) NOT NULL, `disabled` tinyint(1) NOT NULL, `configuration` longtext NOT NULL, `type` tinyint(1) NOT NULL DEFAULT 0, PRIMARY KEY (`id`), KEY `event_disabled` (`event`,`disabled`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\");\n             $db->query(\"CREATE TABLE `lh_incoming_webhook` ( `id` int(11) NOT NULL AUTO_INCREMENT, `name` varchar(50) NOT NULL,`identifier` varchar(50) NOT NULL, `scope` varchar(50) NOT NULL, `dep_id` int(11) NOT NULL, `disabled` tinyint(1) NOT NULL, `configuration` longtext NOT NULL, PRIMARY KEY (`id`), KEY `identifier` (`identifier`)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\");\n             $db->query(\"CREATE TABLE `lh_chat_incoming` ( `id` bigint(20) NOT NULL AUTO_INCREMENT, `chat_id` bigint(20) NOT NULL, `utime` bigint(20) NOT NULL, `incoming_id` int(11) NOT NULL, `payload` longtext NOT NULL, `chat_external_id` varchar(50) NOT NULL, PRIMARY KEY (`id`), KEY `chat_id` (`chat_id`),  KEY `incoming_ext_id` (`incoming_id`,`chat_external_id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\");\n-            $db->query(\"CREATE TABLE `lh_abstract_chat_column` (`id` int(11) NOT NULL AUTO_INCREMENT,`column_name` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL,`variable` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL, `position` int(11) NOT NULL, `enabled` tinyint(1) NOT NULL, `online_enabled` tinyint(1) NOT NULL, `chat_enabled` tinyint(1) NOT NULL, `conditions` text COLLATE utf8mb4_unicode_ci NOT NULL,`column_icon` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL, `column_identifier` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL, PRIMARY KEY (`id`), KEY `enabled` (`enabled`), KEY `online_enabled` (`online_enabled`), KEY `chat_enabled` (`chat_enabled`)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\");\n+            $db->query(\"CREATE TABLE `lh_abstract_chat_column` (`id` int(11) NOT NULL AUTO_INCREMENT,`column_name` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL, `has_popup` tinyint(1) NOT NULL DEFAULT 0, `popup_content` longtext COLLATE utf8mb4_unicode_ci NOT NULL, `icon_mode` tinyint(1) NOT NULL DEFAULT 0, `variable` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL, `position` int(11) NOT NULL, `enabled` tinyint(1) NOT NULL, `online_enabled` tinyint(1) NOT NULL, `chat_enabled` tinyint(1) NOT NULL, `conditions` text COLLATE utf8mb4_unicode_ci NOT NULL,`column_icon` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL, `column_identifier` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL, PRIMARY KEY (`id`), KEY `enabled` (`enabled`), KEY `online_enabled` (`online_enabled`), KEY `chat_enabled` (`chat_enabled`)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\");\n             $db->query(\"CREATE TABLE `lh_abstract_chat_priority` (`id` int(11) NOT NULL AUTO_INCREMENT,`value` text COLLATE utf8mb4_unicode_ci NOT NULL,`dep_id` int(11) NOT NULL, `dest_dep_id` int(11) NOT NULL DEFAULT 0, `sort_priority` int(11) NOT NULL DEFAULT 0,`priority` int(11) NOT NULL, PRIMARY KEY (`id`), KEY `dep_id` (`dep_id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\");\n \n             $db->query(\"CREATE TABLE `lh_canned_msg_dep` ("
        },
        {
          "filename": "lhc_web/design/defaulttheme/js/js_static/a07851a85849880a5fd11dd78f238b28.js",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": null
        },
        {
          "filename": "lhc_web/design/defaulttheme/js/js_static/a07851a85849880a5fd11dd78f238b28.js.map",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": null
        },
        {
          "filename": "lhc_web/design/defaulttheme/js/react/build/all.js",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": null
        },
        {
          "filename": "lhc_web/design/defaulttheme/js/react/src/components/builder/NodeTriggerActionCommand.js",
          "status": "modified",
          "additions": 53,
          "deletions": 23,
          "patch": "@@ -214,38 +214,68 @@ class NodeTriggerActionCommand extends Component {\n                                     <input className=\"form-control form-control-sm\" type=\"text\" onChange={(e) => this.onchangeAttr({'path':['payload'],'value':e.target.value})} defaultValue={this.props.action.getIn(['content','payload'])} />\r\n                                 </div>\r\n                             </div>\r\n-                            <div className=\"col-6\">\r\n+\r\n+                            {this.props.action.getIn(['content','payload_arg_type']) != 'count_filter' && this.props.action.getIn(['content','payload_arg_type']) != 'count' && this.props.action.getIn(['content','payload_arg_type']) != 'ratio' && <div className=\"col-6\">\r\n                                 <div className=\"form-group\">\r\n-                                    <label>Chat variable value from group method</label>\r\n+                                    <label>Calculated value from group method</label>\r\n                                     <input className=\"form-control form-control-sm\" type=\"text\" onChange={(e) => this.onchangeAttr({'path':['payload_cond_field'],'value':e.target.value})} defaultValue={this.props.action.getIn(['content','payload_cond_field'])} />\r\n                                 </div>\r\n-                            </div>\r\n-                            <div className=\"col-4\">\r\n+                            </div>}\r\n+\r\n+                            <div className=\"col-12\">\r\n                                 <div className=\"form-group\">\r\n-                                    <label>Group field (sentiment)</label>\r\n-                                    <input className=\"form-control form-control-sm\" type=\"text\" onChange={(e) => this.onchangeAttr({'path':['payload_arg_field'],'value':e.target.value})} defaultValue={this.props.action.getIn(['content','payload_arg_field'])} />\r\n+                                    <label>Group method</label>\r\n+                                    <select className=\"form-control form-control-sm\" onChange={(e) => this.onchangeAttr({'path' : ['payload_arg_type'], 'value' : e.target.value})} defaultValue={this.props.action.getIn(['content','payload_arg_type'])}>\r\n+                                        <option value=\"\">Select group logic</option>\r\n+                                        <optgroup label=\"Grouping\">\r\n+                                            <option value=\"avg\">AVG</option>\r\n+                                            <option value=\"sum\">SUM</option>\r\n+                                            <option value=\"sum_avg\">SUM as comparator and AVG as value</option>\r\n+                                            <option value=\"max\">MAX</option>\r\n+                                            <option value=\"min\">MIN</option>\r\n+                                            <option value=\"count_max\">COUNT MAX (maximum number of grouped record)</option>\r\n+                                        </optgroup>\r\n+                                        <optgroup label=\"Counting\">\r\n+                                            <option value=\"count\">COUNT (total number of messages)</option>\r\n+                                            <option value=\"count_filter\">COUNT FILTER (filtered by group value field)</option>\r\n+                                            <option value=\"ratio\">RATIO in comparison with all messages</option>\r\n+                                        </optgroup>\r\n+                                    </select>\r\n                                 </div>\r\n                             </div>\r\n-                            <div className=\"col-4\">\r\n-                                <label>Group method</label>\r\n-                                <select className=\"form-control form-control-sm\" onChange={(e) => this.onchangeAttr({'path' : ['payload_arg_type'], 'value' : e.target.value})} defaultValue={this.props.action.getIn(['content','payload_arg_type'])}>\r\n-                                    <option value=\"\">Select group logic</option>\r\n-                                    <option value=\"count\">COUNT (total number of messages)</option>\r\n-                                    <option value=\"avg\">AVG</option>\r\n-                                    <option value=\"sum\">SUM</option>\r\n-                                    <option value=\"sum_avg\">SUM as comparator and AVG as value</option>\r\n-                                    <option value=\"max\">MAX</option>\r\n-                                    <option value=\"min\">MIN</option>\r\n-                                    <option value=\"count_max\">COUNT MAX (maximum number of grouped record)</option>\r\n-                                    <option value=\"count_filter\">COUNT FILTER (filtered by group value field)</option>\r\n-                                </select>\r\n-                            </div>\r\n-                            <div className=\"col-4\">\r\n+\r\n+                            {this.props.action.getIn(['content', 'payload_arg_type']) != 'count' &&\r\n+                                <div className=\"col-6\">\r\n+                                    <div className=\"form-group\">\r\n+                                        <label>Group field (sentiment)</label>\r\n+                                        <input className=\"form-control form-control-sm\" type=\"text\"\r\n+                                               onChange={(e) => this.onchangeAttr({\r\n+                                                   'path': ['payload_arg_field'],\r\n+                                                   'value': e.target.value\r\n+                                               })}\r\n+                                               defaultValue={this.props.action.getIn(['content', 'payload_arg_field'])}/>\r\n+                                    </div>\r\n+                                </div>\r\n+                            }\r\n+\r\n+                            {this.props.action.getIn(['content','payload_arg_type']) != 'count' &&\r\n+                            <div className=\"col-6\">\r\n                                 <div className=\"form-group\">\r\n-                                    <label>Group value field (sentiment_value)</label>\r\n+                                    {(this.props.action.getIn(['content','payload_arg_type']) == 'count_filter' || this.props.action.getIn(['content','payload_arg_type']) == 'ratio') && <label>Filter value</label>}\r\n+                                    {this.props.action.getIn(['content','payload_arg_type']) != 'count_filter' && this.props.action.getIn(['content','payload_arg_type']) != 'ratio' && <label>Group value field. Eg (score field of the sentiment)</label>}\r\n                                     <input className=\"form-control form-control-sm\" type=\"text\" onChange={(e) => this.onchangeAttr({'path':['payload_arg_val'],'value':e.target.value})} defaultValue={this.props.action.getIn(['content','payload_arg_val'])} />\r\n                                 </div>\r\n-                            </div>\r\n+                            </div>}\r\n+\r\n+                            {\r\n+                                ['ratio','avg','sum_avg','max','min','count_max'].indexOf(this.props.action.getIn(['content','payload_arg_type'])) !== -1  &&\r\n+                                <div className=\"col-12\">\r\n+                                    <div className=\"form-group\">\r\n+                                        <label>Use only if value is one of. If not defined all possible values will be used.</label>\r\n+                                        <input className=\"form-control form-control-sm\" placeholder=\"negative,positive\" type=\"text\" onChange={(e) => this.onchangeAttr({'path':['payload_arg_val_sum'],'value':e.target.value})} defaultValue={this.props.action.getIn(['content','payload_arg_val_sum'])} />\r\n+                                    </div>\r\n+                                </div>}\r\n+\r\n                             <div className=\"col-12\">\r\n                                 <label>Messages to include</label>\r\n                                 <div className=\"form-group\">\r"
        },
        {
          "filename": "lhc_web/design/defaulttheme/tpl/lhchat/chat_tabs/information_rows/chat.tpl.php",
          "status": "modified",
          "additions": 9,
          "deletions": 1,
          "patch": "@@ -1,7 +1,15 @@\n <?php if ( $chat->department !== false ) : ?>\n     <tr>\n         <td colspan=\"2\" >\n-            <h6 class=\"font-weight-bold\"><i class=\"material-icons\">chat</i>\n+            <h6 class=\"font-weight-bold\">\n+                <?php\n+                    $icons_additional = erLhAbstractModelChatColumn::getList(array('ignore_fields' => array('position','conditions','column_identifier','enabled'), 'sort' => false, 'filter' => array('icon_mode' => 1, 'enabled' => 1, 'chat_enabled' => 1)));\n+                    $chatItems = [$chat];\n+                    erLhcoreClassChat::prefillGetAttributes($chatItems, array(), array(), array('additional_columns' => $icons_additional, 'do_not_clean' => true));\n+                ?>\n+                <?php include(erLhcoreClassDesign::designtpl('lhchat/lists/icons_additional.tpl.php')); ?>\n+\n+                <i class=\"material-icons\">chat</i>\n                 <?php if ($chat->chat_initiator == erLhcoreClassModelChat::CHAT_INITIATOR_PROACTIVE) : ?>\n                     <?php echo erTranslationClassLhTranslation::getInstance()->getTranslation('chat/adminchat','Proactive chat')?>\n                 <?php else : ?>"
        },
        {
          "filename": "lhc_web/design/defaulttheme/tpl/lhchat/icondetailed.tpl.php",
          "status": "added",
          "additions": 4,
          "deletions": 0,
          "patch": "@@ -0,0 +1,4 @@\n+<?php $modalHeaderTitle = htmlspecialchars($column->column_name)?>\n+<?php include(erLhcoreClassDesign::designtpl('lhkernel/modal_header.tpl.php'));?>\n+<?php echo $column->popup_content?>\n+<?php include(erLhcoreClassDesign::designtpl('lhkernel/modal_footer.tpl.php'));?>"
        },
        {
          "filename": "lhc_web/design/defaulttheme/tpl/lhchat/lists.tpl.php",
          "status": "modified",
          "additions": 3,
          "deletions": 0,
          "patch": "@@ -30,6 +30,9 @@\n                             <?php include(erLhcoreClassDesign::designtpl('lhchat/lists/start_row.tpl.php')); ?>\n                         \t<td><?php if ($chat->can_edit_chat == true) : ?><input ng-checked=\"check_all_items\" class=\"mb-0\" type=\"checkbox\" name=\"ChatID[]\" value=\"<?php echo $chat->id?>\" /><?php endif;?></td>\n                             <td>\n+\n+                              <?php include(erLhcoreClassDesign::designtpl('lhchat/lists/icons_additional.tpl.php')); ?>\n+\n                               <?php foreach ($chat->aicons as $aicon) : ?>\n                               <i class=\"material-icons\" style=\"color: <?php isset($aicon['c']) ? print htmlspecialchars($aicon['c']) : print '#6c757d'?>\" title=\"<?php isset($aicon['t']) ? print htmlspecialchars($aicon['t']) : htmlspecialchars($aicon['i'])?> {{icon.t ? icon.t : icon.i}}\"><?php isset($aicon['i']) ? print htmlspecialchars($aicon['i']) : htmlspecialchars($aicon)?></i>\n                               <?php endforeach; ?>"
        },
        {
          "filename": "lhc_web/design/defaulttheme/tpl/lhchat/lists/additional_column_body.tpl.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -1,3 +1,3 @@\n-<td ng-repeat=\"column in lhc.additionalColumns\" ng-if=\"column.cenabl == true\">\n+<td ng-repeat=\"column in lhc.additionalColumns\" ng-if=\"column.cenabl == true && !column.iconm\">\n     <div class=\"abbr-list\" ng-repeat=\"val in column.items\">{{chat[val]}}&nbsp;</div>\n </td>\n\\ No newline at end of file"
        },
        {
          "filename": "lhc_web/design/defaulttheme/tpl/lhchat/lists/additional_column_body_online.tpl.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -1,3 +1,3 @@\n-<td ng-repeat=\"column in lhc.additionalColumns\" ng-if=\"column.oenabl == true\">\n+<td ng-repeat=\"column in lhc.additionalColumns\" ng-if=\"column.oenabl == true && !column.iconm\">\n     <span ng-repeat=\"val in column.items\">{{ou[val]}}&nbsp;</span>\n </td>\n\\ No newline at end of file"
        },
        {
          "filename": "lhc_web/design/defaulttheme/tpl/lhchat/lists/additional_column_header.tpl.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -1,3 +1,3 @@\n-<th width=\"20%\" ng-repeat=\"column in lhc.additionalColumns\" ng-if=\"column.cenabl == true\">\n+<th width=\"20%\" ng-repeat=\"column in lhc.additionalColumns\" ng-if=\"column.cenabl == true && !column.iconm\">\n     <i ng-if=\"column.icon !== ''\" class=\"material-icons\">{{column.icon}}</i>{{column.name}}\n </th>\n\\ No newline at end of file"
        },
        {
          "filename": "lhc_web/design/defaulttheme/tpl/lhchat/lists/icon.tpl.php",
          "status": "modified",
          "additions": 4,
          "deletions": 1,
          "patch": "@@ -1 +1,4 @@\n-<i ng-if=\"chat.aicons && (lhc.excludeIcons.length == 0 || lhc.excludeIcons.indexOf(icon.i) === -1)\" class=\"material-icons\" ng-style=\"{'color': icon.c ? icon.c : '#6c757d'}\" title=\"{{icon.t ? icon.t : icon.i}}\" ng-repeat=\"icon in chat.aicons track by $index\">{{icon.i || icon}}</i>\n\\ No newline at end of file\n+<i ng-if=\"chat.aicons && (lhc.excludeIcons.length == 0 || lhc.excludeIcons.indexOf(icon.i) === -1)\" class=\"material-icons\" ng-style=\"{'color': icon.c ? icon.c : '#6c757d'}\" title=\"{{icon.t ? icon.t : icon.i}}\" ng-repeat=\"icon in chat.aicons track by $index\">{{icon.i || icon}}</i>\n+<i ng-repeat=\"column in lhc.additionalColumns\" ng-if=\"column.cenabl == true && column.iconm == true\" >\n+    <span ng-if=\"chat[val]\" ng-click=\"column.iconp && lhc.openModal('chat/icondetailed/' + chat.id + '/' + column.id, $event)\" class=\"material-icons\" title=\"{{column.iconp == true ? 'Click for more information | ' : ''}}{{chat[val + '_tt'] ? chat[val + '_tt'] : chat[val]}}\" style=\"color: {{column.icon[chat[val]].color}}\" ng-repeat=\"val in column.items\">{{column.icon[chat[val]].icon}}</span>\n+</i>\n\\ No newline at end of file"
        },
        {
          "filename": "lhc_web/design/defaulttheme/tpl/lhchat/lists/icons_additional.tpl.php",
          "status": "added",
          "additions": 9,
          "deletions": 0,
          "patch": "@@ -0,0 +1,9 @@\n+<?php if (isset($icons_additional) && !empty($icons_additional)) : ?>\n+    <?php foreach ($icons_additional as $iconAdditional) : $columnIconData = json_decode($iconAdditional->column_icon,true); ?>\n+        <?php if (isset($chat->{'cc_' . $iconAdditional->id})) : ?>\n+        <span <?php if ($iconAdditional->has_popup) : ?>onclick=\"lhc.revealModal({'url':WWW_DIR_JAVASCRIPT + 'chat/icondetailed/' + <?php echo $chat->id?> + '/' + <?php echo $iconAdditional->id?>});\"<?php endif;?> class=\"material-icons<?php if ($iconAdditional->has_popup) : ?> action-image<?php endif; ?>\" title=\"<?php isset($chat->{'cc_' . $iconAdditional->id . '_tt'}) ? print htmlspecialchars($chat->{'cc_' . $iconAdditional->id . '_tt'}) : print htmlspecialchars(isset($chat->{'cc_' . $iconAdditional->id}) ? $chat->{'cc_' . $iconAdditional->id} : '')?>\" style=\"color: <?php echo isset($columnIconData[$chat->{'cc_' . $iconAdditional->id}]['color']) ? htmlspecialchars($columnIconData[$chat->{'cc_' . $iconAdditional->id}]['color']) : '#CECECE'?>\">\n+            <?php $iconAdditional->column_icon != \"\" && strpos($iconAdditional->column_icon,'\"') !== false ? print htmlspecialchars($columnIconData[$chat->{'cc_' . $iconAdditional->id}]['icon']) : print htmlspecialchars($iconAdditional->column_icon); ?>\n+        </span>\n+        <?php endif; ?>\n+    <?php endforeach; ?>\n+<?php endif; ?>\n\\ No newline at end of file"
        },
        {
          "filename": "lhc_web/design/defaulttheme/tpl/lhchatarchive/viewarchivedchat.tpl.php",
          "status": "modified",
          "additions": 12,
          "deletions": 1,
          "patch": "@@ -1,3 +1,9 @@\n+<div role=\"tabpanel\" id=\"tabs\">\r\n+    <ul class=\"nav nav-pills\" role=\"tablist\">\r\n+    </ul>\r\n+    <div class=\"tab-content pl-1\">\r\n+\r\n+        <div class=\"tab-pane active\">\r\n \r\n <div class=\"row\" ng-non-bindable>\r\n     <div class=\"col-sm-7 chat-main-left-column\" id=\"chat-main-column-<?php echo $chat->id;?>\">\r\n@@ -33,4 +39,9 @@\n         <?php include(erLhcoreClassDesign::designtpl('lhchat/chat_tabs/chat_tabs_container.tpl.php')); ?>\r\n     </div>\r\n </div>\r\n-<script>ee.emitEvent('adminArchiveChatLoaded', [<?php echo $archive->id?>,<?php echo $chat->id;?>]);</script>\n\\ No newline at end of file\n+<script>ee.emitEvent('adminArchiveChatLoaded', [<?php echo $archive->id?>,<?php echo $chat->id;?>]);</script>\r\n+\r\n+    </div>\r\n+\r\n+    </div>\r\n+</div>\n\\ No newline at end of file"
        },
        {
          "filename": "lhc_web/design/defaulttheme/tpl/lhsystem/languages.tpl.php",
          "status": "modified",
          "additions": 15,
          "deletions": 12,
          "patch": "@@ -28,12 +28,12 @@\n     \t\t\t\t\n     \t\t\t\t<div class=\"form-group\">\n         \t\t\t\t<label><?php echo erTranslationClassLhTranslation::getInstance()->getTranslation('system/languages','Language')?></label> \n-        \t\t\t\t<select name=\"language\" class=\"form-control\">\n+        \t\t\t\t<select name=\"language\" class=\"form-control form-control-sm\">\n         \t\t\t\t\t<?php\n                                 $userLanguage = erLhcoreClassModelUserSetting::getSetting('user_language', erLhcoreClassSystem::instance()->Language);\n                                 foreach (erLhcoreClassSiteaccessGenerator::getLanguages() as $language) :\n                             ?>\n-        \t\t\t\t\t\t<option value=\"<?php echo $language['locale']?>\" <?php $userLanguage == $language['locale'] ? print 'selected=\"selected\"' : ''?>><?php echo $language['locale']?></option>\n+        \t\t\t\t\t\t<option value=\"<?php echo htmlspecialchars($language['locale'])?>\" <?php $userLanguage == $language['locale'] ? print 'selected=\"selected\"' : ''?>><?php echo htmlspecialchars($language['locale'])?></option>\n         \t\t\t\t\t<?php endforeach;?>\n         \t\t\t\t</select> \n     \t\t\t\t</div>\n@@ -49,12 +49,13 @@\n \t  <?php if ($currentUser->hasAccessTo('lhsystem','configurelanguages')) : ?>\n \t       <div role=\"tabpanel\" class=\"tab-pane <?php if ($tab == 'generalsettings') : ?>active<?php endif;?>\" id=\"generalsettings\">\n \t\t\t<form action=\"<?php echo erLhcoreClassDesign::baseurl('system/languages')?>\" method=\"post\" name=\"siteaccess_change\">\n-\t\t\t\t<p><?php echo erTranslationClassLhTranslation::getInstance()->getTranslation('system/languages','Current site access')?> - <strong><?php echo $current_site_access ?></strong>\n+\t\t\t\t<p><?php echo erTranslationClassLhTranslation::getInstance()->getTranslation('system/languages','Current site access')?> - <strong><?php echo htmlspecialchars($current_site_access) ?></strong>\n \t\t\t\t</p>\n \n-\t\t\t\t<label><?php echo erTranslationClassLhTranslation::getInstance()->getTranslation('system/languages','Site access')?></label> <select id=\"LocaleID\" name=\"siteaccess\" onchange=\"document.siteaccess_change.submit()\" class=\"form-control\">\n+\t\t\t\t<label><?php echo erTranslationClassLhTranslation::getInstance()->getTranslation('system/languages','Site access')?></label>\n+                <select id=\"LocaleID\" name=\"siteaccess\" onchange=\"document.siteaccess_change.submit()\" class=\"form-control form-control-sm\">\n \t\t\t\t<?php foreach ($locales as $locale) : ?>\n-\t\t\t\t      <option value=\"<?php echo $locale?>\" <?php $input->siteaccess == $locale ? print 'selected=\"selected\"' : ''?>><?php echo $locale?></option>\n+\t\t\t\t      <option value=\"<?php echo htmlspecialchars($locale)?>\" <?php $input->siteaccess == $locale ? print 'selected=\"selected\"' : ''?>><?php echo htmlspecialchars($locale)?></option>\n \t\t\t\t<?php endforeach; ?>\n \t\t\t    </select>\n \n@@ -68,7 +69,7 @@\n \n \t\t      <?php include(erLhcoreClassDesign::designtpl('lhkernel/csfr_token.tpl.php'));?>\n \n-\t\t      <input type=\"hidden\" name=\"siteaccess\" value=\"<?php echo $input->siteaccess?>\" />\n+\t\t      <input type=\"hidden\" name=\"siteaccess\" value=\"<?php echo htmlspecialchars($input->siteaccess)?>\" />\n \n \t\t         <?php\n                     $siteAccessOptions = erConfigClassLhConfig::getInstance()->getSetting( 'site_access_options', $input->siteaccess );\n@@ -77,24 +78,26 @@\n \t\t\t\t\t\n \t\t\t\t\t<div class=\"form-group\">\n     \t\t\t\t\t<label><?php echo erTranslationClassLhTranslation::getInstance()->getTranslation('system/languages','Language')?></label> \n-    \t\t\t\t\t<select name=\"language\" class=\"form-control\">\n+    \t\t\t\t\t<select name=\"language\" class=\"form-control form-control-sm\">\n                 \t\t\t<?php foreach (erLhcoreClassSiteaccessGenerator::getLanguages() as $language) : ?>\n-                \t\t\t\t<option value=\"<?php echo $language['locale']?>\" <?php $siteAccessOptions['locale'] == $language['locale'] ? print 'selected=\"selected\"' : ''?>><?php echo $language['locale']?></option>\n+                \t\t\t\t<option value=\"<?php echo htmlspecialchars($language['locale'])?>\" <?php $siteAccessOptions['locale'] == $language['locale'] ? print 'selected=\"selected\"' : ''?>><?php echo htmlspecialchars($language['locale'])?></option>\n                 \t\t\t<?php endforeach;?>\n                 \t\t</select>\n                     </div>\n                     \n \t\t\t\t\t<div class=\"form-group\">\n \t\t\t\t\t\t<label><?php echo erTranslationClassLhTranslation::getInstance()->getTranslation('system/languages','Theme, separate themes by new line')?></label>\n-\t\t\t\t\t\t<textarea class=\"form-control\" name=\"theme\"><?php echo implode(\"\\n\", $siteAccessOptions['theme'])?></textarea>\n+\t\t\t\t\t\t<textarea class=\"form-control form-control-sm\" name=\"theme\"><?php echo htmlspecialchars(implode(\"\\n\", $siteAccessOptions['theme']))?></textarea>\n \t\t\t\t\t</div>\n \n \t\t\t\t\t<div class=\"row form-group\">\n \t\t\t\t\t\t<div class=\"col-md-3\">\n-\t\t\t\t\t\t\t<label><?php echo erTranslationClassLhTranslation::getInstance()->getTranslation('system/languages','Default module')?></label> <input type=\"text\" class=\"form-control\" name=\"module\" value=\"<?php echo $siteAccessOptions['default_url']['module']?>\" />\n+\t\t\t\t\t\t\t<label><?php echo erTranslationClassLhTranslation::getInstance()->getTranslation('system/languages','Default module')?></label>\n+                            <input type=\"text\" class=\"form-control form-control-sm\" name=\"module\" value=\"<?php echo htmlspecialchars($siteAccessOptions['default_url']['module'])?>\" />\n \t\t\t\t\t\t</div>\n \t\t\t\t\t\t<div class=\"col-md-3\">\n-\t\t\t\t\t\t\t<label><?php echo erTranslationClassLhTranslation::getInstance()->getTranslation('system/languages','Default view')?></label> <input type=\"text\" class=\"form-control\" name=\"view\" value=\"<?php echo $siteAccessOptions['default_url']['view']?>\" />\n+\t\t\t\t\t\t\t<label><?php echo erTranslationClassLhTranslation::getInstance()->getTranslation('system/languages','Default view')?></label>\n+                            <input type=\"text\" class=\"form-control form-control-sm\" name=\"view\" value=\"<?php echo htmlspecialchars($siteAccessOptions['default_url']['view'])?>\" />\n \t\t\t\t\t\t</div>\n \t\t\t\t\t</div>\n \t\t\t\t\n@@ -103,7 +106,7 @@\n \t\t\t</form>\n \n \t\t</div>\n-\t  <?php endif;?>\t  \n+\t  <?php endif;?>\n \t</div>\n \n </div>\n\\ No newline at end of file"
        },
        {
          "filename": "lhc_web/design/defaulttheme/tpl/lhviews/loadview.tpl.php",
          "status": "modified",
          "additions": 3,
          "deletions": 0,
          "patch": "@@ -27,6 +27,9 @@\n                         <?php foreach ($items as $chat) : ?>\n                             <?php include(erLhcoreClassDesign::designtpl('lhchat/lists/start_row.tpl.php')); ?>\n                             <td nowrap=\"\">\n+\n+                                <?php include(erLhcoreClassDesign::designtpl('lhchat/lists/icons_additional.tpl.php')); ?>\n+\n                                 <?php foreach ($chat->aicons as $aicon) : ?>\n                                     <i class=\"material-icons\" style=\"color: <?php isset($aicon['c']) ? print htmlspecialchars($aicon['c']) : print '#6c757d'?>\" title=\"<?php isset($aicon['t']) ? print htmlspecialchars($aicon['t']) : htmlspecialchars($aicon['i'])?> {{icon.t ? icon.t : icon.i}}\"><?php isset($aicon['i']) ? print htmlspecialchars($aicon['i']) : htmlspecialchars($aicon)?></i>\n                                 <?php endforeach; ?>"
        },
        {
          "filename": "lhc_web/doc/CHANGELOG.txt",
          "status": "modified",
          "additions": 8,
          "deletions": 0,
          "patch": "@@ -1,3 +1,11 @@\n+3.99v\n+\n+1. Message aggregation for sentiment analysis per message implementation.\n+2. Small security fix\n+3.\n+\n+execute doc/update_db/update_271.sql for update\n+\n 3.98v\n \n 1. Option to share your views with other operators."
        },
        {
          "filename": "lhc_web/doc/update_db/structure.json",
          "status": "modified",
          "additions": 25,
          "deletions": 0,
          "patch": "@@ -5540,6 +5540,31 @@\n         \"default\": null,\r\n         \"extra\": \"\"\r\n       },\r\n+      {\r\n+        \"field\": \"icon_mode\",\r\n+        \"type\": \"tinyint(1)\",\r\n+        \"null\": \"NO\",\r\n+        \"key\": \"\",\r\n+        \"default\": \"0\",\r\n+        \"extra\": \"\"\r\n+      },\r\n+      {\r\n+        \"field\": \"has_popup\",\r\n+        \"type\": \"tinyint(1)\",\r\n+        \"null\": \"NO\",\r\n+        \"key\": \"\",\r\n+        \"default\": \"0\",\r\n+        \"extra\": \"\"\r\n+      },\r\n+      {\r\n+        \"field\": \"popup_content\",\r\n+        \"type\": \"longtext\",\r\n+        \"null\": \"NO\",\r\n+        \"key\": \"\",\r\n+        \"default\": null,\r\n+        \"extra\": \"\",\r\n+        \"collation\": \"utf8mb4_unicode_ci\"\r\n+      },\r\n       {\r\n         \"field\": \"online_enabled\",\r\n         \"type\": \"tinyint(1)\",\r"
        },
        {
          "filename": "lhc_web/doc/update_db/update_271.sql",
          "status": "added",
          "additions": 3,
          "deletions": 0,
          "patch": "@@ -0,0 +1,3 @@\n+ALTER TABLE `lh_abstract_chat_column` ADD `icon_mode` tinyint(1) NOT NULL DEFAULT '0', COMMENT='';\n+ALTER TABLE `lh_abstract_chat_column` ADD `has_popup` tinyint(1) NOT NULL DEFAULT '0', COMMENT='';\n+ALTER TABLE `lh_abstract_chat_column` ADD `popup_content` longtext NOT NULL, COMMENT='';\n\\ No newline at end of file"
        },
        {
          "filename": "lhc_web/lib/core/lhabstract/fields/erlhabstractmodelchatcolumn.php",
          "status": "modified",
          "additions": 22,
          "deletions": 0,
          "patch": "@@ -40,6 +40,13 @@\n         'hide_optional' => true,\n         'validation_definition' => new ezcInputFormDefinitionElement(ezcInputFormDefinitionElement::OPTIONAL, 'boolean')\n     ),\n+    'icon_mode' => array(\n+        'type' => 'checkbox',\n+        'trans' => erTranslationClassLhTranslation::getInstance()->getTranslation('abstract/proactivechatinvitation', 'Icon mode'),\n+        'required' => false,\n+        'hide_optional' => true,\n+        'validation_definition' => new ezcInputFormDefinitionElement(ezcInputFormDefinitionElement::OPTIONAL, 'boolean')\n+    ),\n     'chat_enabled' => array(\n         'type' => 'checkbox',\n         'trans' => erTranslationClassLhTranslation::getInstance()->getTranslation('abstract/proactivechatinvitation', 'Visible in chat list'),\n@@ -48,6 +55,21 @@\n         'hide_optional' => true,\n         'validation_definition' => new ezcInputFormDefinitionElement(ezcInputFormDefinitionElement::OPTIONAL, 'boolean')\n     ),\n+    'has_popup' => array(\n+        'type' => 'checkbox',\n+        'trans' => erTranslationClassLhTranslation::getInstance()->getTranslation('abstract/proactivechatinvitation', 'Has popup information'),\n+        'hidden' => true,\n+        'required' => false,\n+        'hide_optional' => true,\n+        'validation_definition' => new ezcInputFormDefinitionElement(ezcInputFormDefinitionElement::OPTIONAL, 'boolean')\n+    ),\n+    'popup_content' => array(\n+        'type' => 'textarea',\n+        'trans' => erTranslationClassLhTranslation::getInstance()->getTranslation('abstract/email_template','Popup content, icon will have an option to show a modal window'),\n+        'required' => false,\n+        'validation_definition' => new ezcInputFormDefinitionElement(\n+            ezcInputFormDefinitionElement::OPTIONAL, 'unsafe_raw'\n+        )),\n     'online_enabled' => array(\n         'type' => 'checkbox',\n         'trans' => erTranslationClassLhTranslation::getInstance()->getTranslation('abstract/proactivechatinvitation', 'Visible in online visitors list'),"
        },
        {
          "filename": "lhc_web/lib/core/lhabstract/lhabstract.php",
          "status": "modified",
          "additions": 13,
          "deletions": 4,
          "patch": "@@ -48,7 +48,9 @@ public static function renderInput($name, $attr, $object, $defaultValue = '')\n                         $ngModel .= \" maxlength=\\\"{$attr['maxlength']}\\\" \";\r\n                     }\r\n \r\n-                    return '<input class=\"form-control form-control-sm' . (isset($attr['css_class']) ? ' ' . $attr['css_class'] : '') . '\" ' . $ngModel . ' name=\"AbstractInput_' . $name . '\" type=\"' . $attr['type'] . '\" value=\"' . htmlspecialchars($value) . '\" />';\r\n+                    $nameInputPrepend = (isset($attr['direct_name']) && $attr['direct_name'] == true) ? '' : 'AbstractInput_';\r\n+\r\n+                    return '<input class=\"form-control form-control-sm' . (isset($attr['css_class']) ? ' ' . $attr['css_class'] : '') . '\" ' . $ngModel . ' name=\"' . $nameInputPrepend . $name . '\" type=\"' . $attr['type'] . '\" value=\"' . htmlspecialchars($value) . '\" />';\r\n                 }\r\n                 break;\r\n \r\n@@ -153,13 +155,20 @@ public static function renderInput($name, $attr, $object, $defaultValue = '')\n             case 'combobox':\r\n \r\n                 $onchange = isset($attr['on_change']) ? $attr['on_change'] : '';\r\n-                $return = '<select ng-non-bindable class=\"form-control form-control-sm\" name=\"AbstractInput_' . $name . '\"' . $onchange . '>';\r\n+                $nameInputPrepend = (isset($attr['direct_name']) && $attr['direct_name'] == true) ? '' : 'AbstractInput_';\r\n+\r\n+                $return = '<select ng-non-bindable class=\"form-control form-control-sm\" name=\"' . $nameInputPrepend . $name . '\"' . $onchange . '>';\r\n \r\n                 if (!isset($attr['hide_optional']) || $attr['hide_optional'] == false) {\r\n-                    $return .= '<option value=\"0\">Choose option</option>';\r\n+                    $optionalValue = isset($attr['optional_value']) ? $attr['optional_value'] : 0;\r\n+                    $return .= '<option value=\"' . $optionalValue . '\">' . erTranslationClassLhTranslation::getInstance()->getTranslation('chat/lists/search_panel','Choose') . '</option>';\r\n                 }\r\n \r\n-                $items = call_user_func($attr['source'], $attr['params_call']);\r\n+                if ($attr['source'] instanceof Closure) {\r\n+                    $items = $attr['source']();\r\n+                } else {\r\n+                    $items = call_user_func($attr['source'], $attr['params_call']);\r\n+                }\r\n \r\n                 if (isset($attr['main_attr']) && !empty($attr['main_attr'])) {\r\n                     if (isset($object->{$attr['main_attr']}[$name])) {\r"
        },
        {
          "filename": "lhc_web/lib/core/lhchat/lhchat.php",
          "status": "modified",
          "additions": 7,
          "deletions": 1,
          "patch": "@@ -1593,7 +1593,14 @@ public static function prefillGetAttributes(& $objects, $attrs = array(),$attrRe\n    \t\t\t};\n \n             if (isset($params['additional_columns']) && is_array($params['additional_columns']) && !empty($params['additional_columns'])) {\n+\n                 foreach ($params['additional_columns'] as $column) {\n+\n+                    // Translatable title\n+                    if (strpos($column->column_name,'{args.') !== false) {\n+                        $object->{'cc_' . $column->id . '_tt'} = erLhcoreClassGenericBotWorkflow::translateMessage($column->column_name, array('chat' => $object, 'args' => ['chat' => $object]));\n+                    }\n+\n                     if (strpos($column->variable,'additional_data.') !== false) {\n                         $additionalDataArray = $object->additional_data_array;\n                         if (is_array($additionalDataArray)) {\n@@ -1633,7 +1640,6 @@ public static function prefillGetAttributes(& $objects, $attrs = array(),$attrRe\n                 }\n             }\n \n-\n    \t\t\tforeach ($attrRemove as $attr) {\n    \t\t\t\t$object->{$attr} = null;\n    \t\t\t\tif (isset($params['clean_ignore'])) {"
        },
        {
          "filename": "lhc_web/lib/core/lhcore/lhupdate.php",
          "status": "modified",
          "additions": 3,
          "deletions": 3,
          "patch": "@@ -2,8 +2,8 @@\n \r\n class erLhcoreClassUpdate\r\n {\r\n-\tconst DB_VERSION = 270;\r\n-\tconst LHC_RELEASE = 398;\r\n+\tconst DB_VERSION = 271;\r\n+\tconst LHC_RELEASE = 399;\r\n \r\n \tpublic static function doTablesUpdate($definition){\r\n \t\t$updateInformation = self::getTablesStatus($definition);\r\n@@ -12,7 +12,7 @@ public static function doTablesUpdate($definition){\n         $errorMessages = array();\r\n \r\n \t\ttry {\r\n-            $db->query('SET GLOBAL innodb_strict_mode = 0;');\r\n+            $db->query('SET GLOBAL innodb_strict_mode=0;');\r\n             $db->query('SET GLOBAL innodb_file_per_table=1;');\r\n             $db->query('SET GLOBAL innodb_large_prefix=1;');\r\n         } catch (Exception $e) {\r"
        },
        {
          "filename": "lhc_web/lib/core/lhgenericbot/actionTypes/lhgenericbotactioncommand.php",
          "status": "modified",
          "additions": 40,
          "deletions": 8,
          "patch": "@@ -288,9 +288,6 @@ public static function process($chat, $action, $trigger, $params)\n             if (\r\n                 !isset($messages) ||\r\n                 (!isset($action['content']['payload']) || empty($action['content']['payload'])) ||\r\n-                (!isset($action['content']['payload_cond_field']) || empty($action['content']['payload_cond_field'])) ||\r\n-                (!isset($action['content']['payload_arg_field']) || empty($action['content']['payload_arg_field'])) ||\r\n-                (!isset($action['content']['payload_arg_val']) || empty($action['content']['payload_arg_val'])) ||\r\n                 (!isset($action['content']['payload_arg_type']) || empty($action['content']['payload_arg_type']))\r\n             ) {\r\n                 return;\r\n@@ -314,16 +311,16 @@ public static function process($chat, $action, $trigger, $params)\n             $chatVariableName = $action['content']['payload'];\r\n \r\n             // Group value field (sentiment_value)\r\n-            $chatVariableValue = $action['content']['payload_cond_field'];\r\n+            $chatVariableValue = isset($action['content']['payload_cond_field']) ? $action['content']['payload_cond_field'] : '';\r\n \r\n             /*\r\n              * Messages attributes\r\n              * */\r\n             // Group field (sentiment)\r\n-            $messagesGroupField = $action['content']['payload_arg_field'];\r\n+            $messagesGroupField = isset($action['content']['payload_arg_field']) ? $action['content']['payload_arg_field'] : '';\r\n \r\n             // Group value field (sentiment_value)\r\n-            $messagesGroupFieldValue = $action['content']['payload_arg_val'];\r\n+            $messagesGroupFieldValue = isset($action['content']['payload_arg_val']) ? $action['content']['payload_arg_val'] : '';\r\n \r\n             // Group method\r\n             $groupMethod = $action['content']['payload_arg_type'];\r\n@@ -332,12 +329,41 @@ public static function process($chat, $action, $trigger, $params)\n \r\n             if ($groupMethod == 'count') {\r\n                 $variablesArray[$chatVariableName] = count($messages);\r\n+            } else if ($groupMethod == 'ratio') {\r\n+\r\n+                if (!isset($action['content']['payload_arg_val_sum'])){\r\n+                    return;\r\n+                }\r\n+\r\n+                $messagesGroupFieldAll = $action['content']['payload_arg_val_sum'];\r\n+\r\n+                $counterTotal = 0;\r\n+                $counterRequired = 0;\r\n+                foreach ($messages as $message) {\r\n+                    $messageVariables = $message->meta_msg_array;\r\n+\r\n+                    if (isset($messageVariables[$messagesGroupField]) &&  in_array($messageVariables[$messagesGroupField],explode(',',$messagesGroupFieldValue))) {\r\n+                        $counterRequired++;\r\n+                    }\r\n+\r\n+                    if (isset($messageVariables[$messagesGroupField]) &&  in_array($messageVariables[$messagesGroupField],explode(',',$messagesGroupFieldAll))) {\r\n+                        $counterTotal++;\r\n+                    }\r\n+                }\r\n+\r\n+                if ($counterTotal > 0) {\r\n+                    $variablesArray[$chatVariableName] = round($counterRequired/$counterTotal,4);\r\n+                    $chat->chat_variables = json_encode($variablesArray);\r\n+                    $chat->chat_variables_array = $variablesArray;\r\n+                    $chat->updateThis(['update' => ['chat_variables']]);\r\n+                }\r\n+\r\n             } else if ($groupMethod == 'count_filter') {\r\n \r\n                 $counter = 0;\r\n                 foreach ($messages as $message) {\r\n                     $messageVariables = $message->meta_msg_array;\r\n-                    if (isset($messageVariables[$messagesGroupField]) && $messageVariables[$messagesGroupField] == $messagesGroupFieldValue) {\r\n+                    if (isset($messageVariables[$messagesGroupField]) &&  in_array($messageVariables[$messagesGroupField],explode(',',$messagesGroupFieldValue))) {\r\n                         $counter++;\r\n                     }\r\n                 }\r\n@@ -351,13 +377,19 @@ public static function process($chat, $action, $trigger, $params)\n \r\n                 $groupedFields = [];\r\n \r\n+                $messagesGroupFieldAll = isset($action['content']['payload_arg_val_sum']) ? explode(',',$action['content']['payload_arg_val_sum']) : [];\r\n+\r\n                 foreach ($messages as $message) {\r\n                     $messageVariables = $message->meta_msg_array;\r\n                     if (isset($messageVariables[$messagesGroupField])) {\r\n-                        $groupedFields[$messageVariables[$messagesGroupField]][] = $messageVariables[$messagesGroupFieldValue];\r\n+                        if (empty($messagesGroupFieldAll) || in_array($messageVariables[$messagesGroupField],$messagesGroupFieldAll)){\r\n+                            $groupedFields[$messageVariables[$messagesGroupField]][] = $messageVariables[$messagesGroupFieldValue];\r\n+                        }\r\n                     }\r\n                 }\r\n \r\n+\r\n+\r\n                 $highestScore = 0;\r\n \r\n                 foreach ($groupedFields as $sentiment => $values) {\r"
        },
        {
          "filename": "lhc_web/lib/core/lhpermission/lhmodules.php",
          "status": "modified",
          "additions": 25,
          "deletions": 0,
          "patch": "@@ -45,6 +45,31 @@ public static function getModuleList()\n         return $ModuleList ;\n    }\n \n+   public static function getViewsByModule($ModulePath)\n+   {\n+       $ViewListProcessed = [];\n+       if (file_exists('modules/' . $ModulePath . '/module.php')) {\n+           include('modules/' . $ModulePath . '/module.php');\n+           if (isset($ViewList) && !empty($ViewList)) {\n+               $ViewListProcessed = array_merge($ViewListProcessed, array_keys($ViewList));\n+           }\n+       }\n+       $cfg = erConfigClassLhConfig::getInstance();\n+       // Append Override functions\n+       $extensions = $cfg->getSetting( 'site', 'extensions' );\n+       foreach ($extensions as $extension) {\n+           if (file_exists(\"extension/{$extension}/modules/{$ModulePath}/module.php\")) {\n+               $ViewList = [];\n+               include(\"extension/{$extension}/modules/{$ModulePath}/module.php\");\n+               if (isset($ViewList) && !empty($ViewList)) {\n+                   $ViewListProcessed = array_merge($ViewListProcessed, array_keys($ViewList));\n+               }\n+           }\n+       }\n+\n+       return $ViewListProcessed;\n+   }\n+\n    public static function getModuleFunctions($ModulePath, $params = array())\n    {\n    \t\t$FunctionListReturn = array();"
        },
        {
          "filename": "lhc_web/lib/models/lhabstract/erlhabstractmodelchatcolumn.php",
          "status": "modified",
          "additions": 6,
          "deletions": 10,
          "patch": "@@ -25,6 +25,9 @@ public function getState()\n             'column_identifier' => $this->column_identifier,\n             'chat_enabled' => $this->chat_enabled,\n             'online_enabled' => $this->online_enabled,\n+            'icon_mode' => $this->icon_mode,\n+            'has_popup' => $this->has_popup,\n+            'popup_content' => $this->popup_content,\n         );\n \n         return $stateArray;\n@@ -77,25 +80,18 @@ public function __get($var)\n     }\n \n     public $id = null;\n-\n     public $column_name = '';\n-\n     public $column_icon = '';\n-    \n     public $column_identifier = '';\n-\n     public $variable = '';\n-\n     public $position = '';\n-\n     public $enabled = 1;\n-\n     public $conditions = '';\n-\n+    public $popup_content = '';\n     public $chat_enabled = 1;\n-\n     public $online_enabled = 1;\n-\n+    public $icon_mode = 0;\n+    public $has_popup = 0;\n     public $hide_delete = false;\n }\n "
        },
        {
          "filename": "lhc_web/modules/lhchat/icondetailed.php",
          "status": "added",
          "additions": 20,
          "deletions": 0,
          "patch": "@@ -0,0 +1,20 @@\n+<?php\n+\n+$tpl = erLhcoreClassTemplate::getInstance('lhchat/icondetailed.tpl.php');\n+\n+$chat = erLhcoreClassModelChat::fetch($Params['user_parameters']['chat_id']);\n+$column = erLhAbstractModelChatColumn::fetch($Params['user_parameters']['column_id']);\n+\n+if ( erLhcoreClassChat::hasAccessToRead($chat) ) {\n+    $column->column_name = erLhcoreClassGenericBotWorkflow::translateMessage($column->column_name, array('chat' => $chat, 'args' => ['chat' => $chat]));\n+    $column->popup_content = erLhcoreClassGenericBotWorkflow::translateMessage($column->popup_content, array('chat' => $chat, 'args' => ['chat' => $chat]));\n+    $tpl->set('column',$column);\n+    $tpl->set('chat',$chat);\n+} else {\n+    $tpl->setFile( 'lhchat/errors/adminchatnopermission.tpl.php');\n+}\n+\n+echo $tpl->fetch();\n+exit;\n+\n+?>\n\\ No newline at end of file"
        },
        {
          "filename": "lhc_web/modules/lhchat/list.php",
          "status": "modified",
          "additions": 3,
          "deletions": 0,
          "patch": "@@ -165,6 +165,9 @@\n \n if ($pages->items_total > 0) {\n \t$items = erLhcoreClassModelChat::getList(array_merge($filterParams['filter'],array('limit' => $pages->items_per_page,'offset' => $pages->low)));\n+    $iconsAdditional = erLhAbstractModelChatColumn::getList(array('ignore_fields' => array('position','conditions','column_identifier','enabled'), 'sort' => false, 'filter' => array('icon_mode' => 1, 'enabled' => 1, 'chat_enabled' => 1)));\n+    erLhcoreClassChat::prefillGetAttributes($items, array(), array(), array('additional_columns' => $iconsAdditional, 'do_not_clean' => true));\n+    $tpl->set('icons_additional',$iconsAdditional);\n     erLhcoreClassChatEventDispatcher::getInstance()->dispatch('chat.list_items',array('filter' => & $items, 'uparams' => $Params['user_parameters_unordered']));\n \t$tpl->set('items',$items);\n }"
        },
        {
          "filename": "lhc_web/modules/lhchat/loadinitialdata.php",
          "status": "modified",
          "additions": 7,
          "deletions": 2,
          "patch": "@@ -153,15 +153,20 @@\n     }\n }\n \n-$columns = erLhAbstractModelChatColumn::getList(array('ignore_fields' => array('position','conditions','enabled','variable'), 'sort' => 'position ASC, id ASC','filter' => array('enabled' => 1)));\n+$columns = erLhAbstractModelChatColumn::getList(array('ignore_fields' => array('popup_content','position','conditions','enabled','variable'), 'sort' => 'position ASC, id ASC','filter' => array('enabled' => 1)));\n \n $columnsAdd = array();\n foreach ($columns as $column) {\n     $columnsAdd[$column->column_identifier]['items'][] = 'cc_' . $column->id;\n     $columnsAdd[$column->column_identifier]['name'] = $column->column_name;\n-    $columnsAdd[$column->column_identifier]['icon'] = $column->column_icon;\n+    $columnsAdd[$column->column_identifier]['icon'] = $column->column_icon != \"\" && strpos($column->column_icon,'\"') !== false ? json_decode($column->column_icon,true) : $column->column_icon;\n     $columnsAdd[$column->column_identifier]['cenabl'] = $column->chat_enabled == 1;\n     $columnsAdd[$column->column_identifier]['oenabl'] = $column->online_enabled == 1;\n+    $columnsAdd[$column->column_identifier]['iconm'] = $column->icon_mode == 1;\n+    $columnsAdd[$column->column_identifier]['iconp'] = $column->has_popup == 1;\n+    if ($columnsAdd[$column->column_identifier]['iconp'] === true) {\n+        $columnsAdd[$column->column_identifier]['id'] = $column->id;\n+    }\n }\n \n $groupListParams = erLhcoreClassGroupUser::getConditionalUserFilter(false, true);"
        },
        {
          "filename": "lhc_web/modules/lhchat/module.php",
          "status": "modified",
          "additions": 6,
          "deletions": 0,
          "patch": "@@ -17,6 +17,12 @@\n     'functions' => array( 'use' ),\n );\n \n+$ViewList['icondetailed'] = array(\n+    'params' => array('chat_id','column_id'),\n+    'uparams' => array(),\n+    'functions' => array( 'use' ),\n+);\n+\n $ViewList['chathistory'] = array(\n     'params' => array('chat_id'),\n     'uparams' => array(),"
        },
        {
          "filename": "lhc_web/modules/lhchat/syncadmininterface.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -31,7 +31,7 @@\n // We do not need a session anymore\n session_write_close();\n \n-$columnsAdditional = erLhAbstractModelChatColumn::getList(array('ignore_fields' => array('position','conditions','column_name','column_name','column_identifier','enabled'), 'sort' => false, 'filter' => array('enabled' => 1, 'chat_enabled' => 1)));\n+$columnsAdditional = erLhAbstractModelChatColumn::getList(array('ignore_fields' => array('position','conditions','column_identifier','enabled','popup_content','has_popup','icon_mode','online_enabled','column_icon'), 'sort' => false, 'filter' => array('enabled' => 1, 'chat_enabled' => 1)));\n \n // User has included custom column which we ignore by default\n foreach ($columnsAdditional as $columnAdditional) {"
        },
        {
          "filename": "lhc_web/modules/lhchatarchive/viewarchivedchat.php",
          "status": "modified",
          "additions": 2,
          "deletions": 0,
          "patch": "@@ -17,6 +17,7 @@\n }\r\n \r\n $Result['content'] = $tpl->fetch();\r\n+$Result['body_class'] = 'h-100 dashboard-height';\r\n \r\n $Result['path'] = array(\r\n \t\tarray('url' => erLhcoreClassDesign::baseurl('system/configuration'),'title' => erTranslationClassLhTranslation::getInstance()->getTranslation('department/departments','System configuration')),\r\n@@ -26,4 +27,5 @@\n $Result['path'][] = array('title' => erTranslationClassLhTranslation::getInstance()->getTranslation('chatarchive/viewarchivedchat','View archived chat'));\r\n \r\n \r\n+\r\n ?>\n\\ No newline at end of file"
        },
        {
          "filename": "lhc_web/modules/lhcron/test.php",
          "status": "modified",
          "additions": 3,
          "deletions": 0,
          "patch": "@@ -6,4 +6,7 @@\n  *\r\n  * */\r\n \r\n+$chat = erLhcoreClassModelChat::fetch(\t1647599587);\r\n+erLhcoreClassChatEventDispatcher::getInstance()->dispatch('chat.close',array('chat' => & $chat));\r\n+\r\n ?>\n\\ No newline at end of file"
        },
        {
          "filename": "lhc_web/modules/lhinstall/install.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -2103,7 +2103,7 @@\n                     $db->query(\"CREATE TABLE `lh_incoming_webhook` ( `id` int(11) NOT NULL AUTO_INCREMENT, `dep_id` int(11) NOT NULL, `name` varchar(50) NOT NULL,`identifier` varchar(50) NOT NULL, `scope` varchar(50) NOT NULL, `disabled` tinyint(1) NOT NULL, `configuration` longtext NOT NULL, PRIMARY KEY (`id`), KEY `identifier` (`identifier`)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\");\n                     $db->query(\"CREATE TABLE `lh_chat_incoming` ( `id` bigint(20) NOT NULL AUTO_INCREMENT, `chat_id` bigint(20) NOT NULL, `utime` bigint(20) NOT NULL, `incoming_id` int(11) NOT NULL,`payload` longtext NOT NULL, `chat_external_id` varchar(50) NOT NULL, PRIMARY KEY (`id`), KEY `chat_id` (`chat_id`),  KEY `incoming_ext_id` (`incoming_id`,`chat_external_id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\");\n \n-                    $db->query(\"CREATE TABLE `lh_abstract_chat_column` (`id` int(11) NOT NULL AUTO_INCREMENT,`column_name` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL,`variable` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL, `position` int(11) NOT NULL, `enabled` tinyint(1) NOT NULL, `online_enabled` tinyint(1) NOT NULL, `chat_enabled` tinyint(1) NOT NULL, `conditions` text COLLATE utf8mb4_unicode_ci NOT NULL,`column_icon` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL, `column_identifier` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL, PRIMARY KEY (`id`), KEY `enabled` (`enabled`), KEY `online_enabled` (`online_enabled`), KEY `chat_enabled` (`chat_enabled`)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\");\n+                    $db->query(\"CREATE TABLE `lh_abstract_chat_column` (`id` int(11) NOT NULL AUTO_INCREMENT,`column_name` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL, `has_popup` tinyint(1) NOT NULL DEFAULT 0, `popup_content` longtext COLLATE utf8mb4_unicode_ci NOT NULL, `variable` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL, `position` int(11) NOT NULL, `enabled` tinyint(1) NOT NULL, `online_enabled` tinyint(1) NOT NULL, `icon_mode` tinyint(1) NOT NULL DEFAULT 0, `chat_enabled` tinyint(1) NOT NULL, `conditions` text COLLATE utf8mb4_unicode_ci NOT NULL,`column_icon` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL, `column_identifier` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL, PRIMARY KEY (`id`), KEY `enabled` (`enabled`), KEY `online_enabled` (`online_enabled`), KEY `chat_enabled` (`chat_enabled`)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\");\n                     $db->query(\"CREATE TABLE `lh_abstract_chat_priority` (`id` int(11) NOT NULL AUTO_INCREMENT,`value` text COLLATE utf8mb4_unicode_ci NOT NULL,`dep_id` int(11) NOT NULL, `dest_dep_id` int(11) NOT NULL DEFAULT 0, `sort_priority` int(11) NOT NULL DEFAULT 0,`priority` int(11) NOT NULL, PRIMARY KEY (`id`), KEY `dep_id` (`dep_id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\");\n                     $db->query(\"CREATE TABLE `lh_canned_msg_use` (`id` bigint(20) unsigned NOT NULL AUTO_INCREMENT, `canned_id` int(11) unsigned NOT NULL, `chat_id` bigint(20) unsigned NOT NULL, `ctime` bigint(20) unsigned NOT NULL, `user_id` bigint(20) unsigned NOT NULL, PRIMARY KEY (`id`), KEY `ctime` (`ctime`), KEY `chat_id` (`chat_id`), KEY `canned_id` (`canned_id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\");\n "
        },
        {
          "filename": "lhc_web/modules/lhsystem/languages.php",
          "status": "modified",
          "additions": 31,
          "deletions": 9,
          "patch": "@@ -20,6 +20,14 @@\n     $tab = 'generalsettings';\n }\n \n+$cfgSite = erConfigClassLhConfig::getInstance();\n+$siteAccessAvailable = $cfgSite->getSetting( 'site', 'available_site_access' );\n+\n+if (!in_array($input->siteaccess, $siteAccessAvailable)) {\n+    erLhcoreClassModule::redirect('system/languages');\n+    exit;\n+}\n+\n if ( isset($_POST['StoreUserSettingsAction']) ) {\n \t$definition = array(\n \t\t\t'language' => new ezcInputFormDefinitionElement(\n@@ -37,7 +45,12 @@\n \t$form = new ezcInputForm( INPUT_POST, $definition );\n \t$Errors = array();\n \n-\tif ( $form->hasValidData( 'language' ) && !empty($form->language)) {\n+    $languagesValid = [];\n+    foreach (erLhcoreClassSiteaccessGenerator::getLanguages() as $language) {\n+        $languagesValid[] = $language['locale'];\n+    }\n+\n+\tif ( $form->hasValidData( 'language' ) && !empty($form->language) && in_array($form->language,$languagesValid)) {\n \t\terLhcoreClassModelUserSetting::setSetting('user_language',$form->language);\n \n \t\t// Redirect for change to take effect\n@@ -80,27 +93,36 @@\n \t\t$form = new ezcInputForm( INPUT_POST, $definition );\n \t\t$Errors = array();\n \n-\t\tif ( $form->hasValidData( 'siteaccess' )) {\n+\t\tif ($form->hasValidData( 'siteaccess' ) && in_array($input->siteaccess, $siteAccessAvailable)) {\n \t\t\t$input->siteaccess = $form->siteaccess;\n-\t\t}\n+\t\t} else {\n+            $Errors[] = erTranslationClassLhTranslation::getInstance()->getTranslation('system/languages','Please choose a valid siteaccess');\n+        }\n+\n+        $languagesValid = [];\n+        foreach (erLhcoreClassSiteaccessGenerator::getLanguages() as $language) {\n+            $languagesValid[] = $language['locale'];\n+        }\n \n-\t\tif ( $form->hasValidData( 'language' )) {\n+\t\tif ( $form->hasValidData( 'language' ) && in_array($form->language,$languagesValid)) {\n \t\t\t$input->language = $form->language;\n-\t\t}\n+\t\t} else {\n+            $Errors[] = erTranslationClassLhTranslation::getInstance()->getTranslation('system/languages','Please choose a language');\n+        }\n \n \t\tif ( $form->hasValidData( 'theme' ) && $form->theme != '') {\n \t\t\t$input->theme = $form->theme;\n \t\t} else {\n \t\t\t$Errors[] = erTranslationClassLhTranslation::getInstance()->getTranslation('system/languages','Please enter theme');\n \t\t}\n \n-\t\tif ( $form->hasValidData( 'module' ) && $form->module != '') {\n+\t\tif ( $form->hasValidData( 'module' ) && $form->module != '' && in_array('lh'.$form->module,array_keys(erLhcoreClassModules::getModuleList()))) {\n \t\t\t$input->module = $form->module;\n \t\t} else {\n \t\t\t$Errors[] = erTranslationClassLhTranslation::getInstance()->getTranslation('system/languages','Please enter module name');\n \t\t}\n \n-\t\tif ( $form->hasValidData( 'view' ) && $form->view != '') {\n+\t\tif (empty($Errors) && $form->hasValidData( 'view' ) && $form->view != '' && in_array($form->view,erLhcoreClassModules::getViewsByModule('lh'.$form->module))) {\n \t\t\t$input->view = $form->view;\n \t\t} else {\n \t\t\t$Errors[] = erTranslationClassLhTranslation::getInstance()->getTranslation('system/languages','Please enter view name');\n@@ -129,8 +151,8 @@\n \t}\n }\n \n-$cfgSite = erConfigClassLhConfig::getInstance();\n-$tpl->set('locales',$cfgSite->getSetting( 'site', 'available_site_access' ));\n+\n+$tpl->set('locales',$siteAccessAvailable);\n $tpl->set('current_site_access',erLhcoreClassSystem::instance()->SiteAccess);\n $tpl->set('input',$input);\n $tpl->set('currentUser',$currentUser);"
        },
        {
          "filename": "lhc_web/modules/lhviews/loadview.php",
          "status": "modified",
          "additions": 3,
          "deletions": 0,
          "patch": "@@ -33,6 +33,9 @@\n     $tpl->set('pages',$pages);\n     $filter = array_merge_recursive($filterSearch, array('limit' => $pages->items_per_page, 'offset' => $pages->low));\n     $items = erLhcoreClassModelChat::getList($filter);\n+    $iconsAdditional = erLhAbstractModelChatColumn::getList(array('ignore_fields' => array('position','conditions','column_identifier','enabled'), 'sort' => false, 'filter' => array('icon_mode' => 1, 'enabled' => 1, 'chat_enabled' => 1)));\n+    erLhcoreClassChat::prefillGetAttributes($items, array(), array(), array('additional_columns' => $iconsAdditional, 'do_not_clean' => true));\n+    $tpl->set('icons_additional',$iconsAdditional);\n     $tpl->set('items', $items);\n     $tpl->set('list_mode', $Params['user_parameters_unordered']['mode'] == 'list');\n "
        },
        {
          "filename": "lhc_web/pos/lhabstract/erlhabstractmodelautoresponder.php",
          "status": "modified",
          "additions": 31,
          "deletions": 182,
          "patch": "@@ -9,105 +9,29 @@\n $def->idProperty->propertyName = 'id';\r\n $def->idProperty->generator = new ezcPersistentGeneratorDefinition(  'ezcPersistentNativeGenerator' );\r\n \r\n-$def->properties['name'] = new ezcPersistentObjectProperty();\r\n-$def->properties['name']->columnName   = 'name';\r\n-$def->properties['name']->propertyName = 'name';\r\n-$def->properties['name']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\r\n-\r\n-$def->properties['operator'] = new ezcPersistentObjectProperty();\r\n-$def->properties['operator']->columnName   = 'operator';\r\n-$def->properties['operator']->propertyName = 'operator';\r\n-$def->properties['operator']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\r\n-\r\n-$def->properties['siteaccess'] = new ezcPersistentObjectProperty();\r\n-$def->properties['siteaccess']->columnName   = 'siteaccess';\r\n-$def->properties['siteaccess']->propertyName = 'siteaccess';\r\n-$def->properties['siteaccess']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\r\n-\r\n-$def->properties['languages'] = new ezcPersistentObjectProperty();\r\n-$def->properties['languages']->columnName   = 'languages';\r\n-$def->properties['languages']->propertyName = 'languages';\r\n-$def->properties['languages']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\r\n-\r\n-$def->properties['wait_message'] = new ezcPersistentObjectProperty();\r\n-$def->properties['wait_message']->columnName   = 'wait_message';\r\n-$def->properties['wait_message']->propertyName = 'wait_message';\r\n-$def->properties['wait_message']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\r\n-\r\n-// This applies only to proactive chats\r\n-$def->properties['only_proactive'] = new ezcPersistentObjectProperty();\r\n-$def->properties['only_proactive']->columnName   = 'only_proactive';\r\n-$def->properties['only_proactive']->propertyName = 'only_proactive';\r\n-$def->properties['only_proactive']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_INT;\r\n-\r\n-// Timeout in seconds.\r\n-$def->properties['wait_timeout'] = new ezcPersistentObjectProperty();\r\n-$def->properties['wait_timeout']->columnName   = 'wait_timeout';\r\n-$def->properties['wait_timeout']->propertyName = 'wait_timeout';\r\n-$def->properties['wait_timeout']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_INT;\r\n-\r\n-$def->properties['wait_timeout_2'] = new ezcPersistentObjectProperty();\r\n-$def->properties['wait_timeout_2']->columnName   = 'wait_timeout_2';\r\n-$def->properties['wait_timeout_2']->propertyName = 'wait_timeout_2';\r\n-$def->properties['wait_timeout_2']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_INT;\r\n-\r\n-$def->properties['wait_timeout_3'] = new ezcPersistentObjectProperty();\r\n-$def->properties['wait_timeout_3']->columnName   = 'wait_timeout_3';\r\n-$def->properties['wait_timeout_3']->propertyName = 'wait_timeout_3';\r\n-$def->properties['wait_timeout_3']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_INT;\r\n-\r\n-$def->properties['wait_timeout_4'] = new ezcPersistentObjectProperty();\r\n-$def->properties['wait_timeout_4']->columnName   = 'wait_timeout_4';\r\n-$def->properties['wait_timeout_4']->propertyName = 'wait_timeout_4';\r\n-$def->properties['wait_timeout_4']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_INT;\r\n-\r\n-$def->properties['wait_timeout_5'] = new ezcPersistentObjectProperty();\r\n-$def->properties['wait_timeout_5']->columnName   = 'wait_timeout_5';\r\n-$def->properties['wait_timeout_5']->propertyName = 'wait_timeout_5';\r\n-$def->properties['wait_timeout_5']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_INT;\r\n-\r\n-// Department ID\r\n-$def->properties['dep_id'] = new ezcPersistentObjectProperty();\r\n-$def->properties['dep_id']->columnName   = 'dep_id';\r\n-$def->properties['dep_id']->propertyName = 'dep_id';\r\n-$def->properties['dep_id']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_INT;\r\n-\r\n-// Position\r\n-$def->properties['position'] = new ezcPersistentObjectProperty();\r\n-$def->properties['position']->columnName   = 'position';\r\n-$def->properties['position']->propertyName = 'position';\r\n-$def->properties['position']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_INT;\r\n-\r\n-// Then timeout passes show visitor this message.\r\n-$def->properties['timeout_message'] = new ezcPersistentObjectProperty();\r\n-$def->properties['timeout_message']->columnName   = 'timeout_message';\r\n-$def->properties['timeout_message']->propertyName = 'timeout_message';\r\n-$def->properties['timeout_message']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\r\n-\r\n-$def->properties['timeout_message_2'] = new ezcPersistentObjectProperty();\r\n-$def->properties['timeout_message_2']->columnName   = 'timeout_message_2';\r\n-$def->properties['timeout_message_2']->propertyName = 'timeout_message_2';\r\n-$def->properties['timeout_message_2']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\r\n-\r\n-$def->properties['timeout_message_3'] = new ezcPersistentObjectProperty();\r\n-$def->properties['timeout_message_3']->columnName   = 'timeout_message_3';\r\n-$def->properties['timeout_message_3']->propertyName = 'timeout_message_3';\r\n-$def->properties['timeout_message_3']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\r\n-\r\n-$def->properties['timeout_message_4'] = new ezcPersistentObjectProperty();\r\n-$def->properties['timeout_message_4']->columnName   = 'timeout_message_4';\r\n-$def->properties['timeout_message_4']->propertyName = 'timeout_message_4';\r\n-$def->properties['timeout_message_4']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\r\n-\r\n-$def->properties['timeout_message_5'] = new ezcPersistentObjectProperty();\r\n-$def->properties['timeout_message_5']->columnName   = 'timeout_message_5';\r\n-$def->properties['timeout_message_5']->propertyName = 'timeout_message_5';\r\n-$def->properties['timeout_message_5']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\r\n+foreach (['name','operator','siteaccess','languages','wait_message','timeout_message','timeout_message_2','timeout_message_3','timeout_message_4','timeout_message_5','wait_timeout_hold','bot_configuration'] as $posAttr) {\r\n+    $def->properties[$posAttr] = new ezcPersistentObjectProperty();\r\n+    $def->properties[$posAttr]->columnName   = $posAttr;\r\n+    $def->properties[$posAttr]->propertyName = $posAttr;\r\n+    $def->properties[$posAttr]->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\r\n+}\r\n \r\n-$def->properties['wait_timeout_hold'] = new ezcPersistentObjectProperty();\r\n-$def->properties['wait_timeout_hold']->columnName   = 'wait_timeout_hold';\r\n-$def->properties['wait_timeout_hold']->propertyName = 'wait_timeout_hold';\r\n-$def->properties['wait_timeout_hold']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\r\n+// only_proactive - This applies only to proactive chats\r\n+// wait_timeout - Timeout in seconds.\r\n+// How many times repeat timeout message - repeat_number\r\n+// 0 - infinity times\r\n+// 1 - one time\r\n+// ignore_pa_chat - // Ignore pending and assigned chat.\r\n+// Pending messages won't be send if chat is assigned\r\n+foreach (['only_proactive','wait_timeout','wait_timeout_2','wait_timeout_3',\r\n+             'wait_timeout_4','wait_timeout_5',\r\n+             'dep_id','position','repeat_number','ignore_pa_chat',\r\n+             'survey_timeout','survey_id','user_id'] as $posAttr) {\r\n+    $def->properties[$posAttr] = new ezcPersistentObjectProperty();\r\n+    $def->properties[$posAttr]->columnName   = $posAttr;\r\n+    $def->properties[$posAttr]->propertyName = $posAttr;\r\n+    $def->properties[$posAttr]->propertyType = ezcPersistentObjectProperty::PHP_TYPE_INT;\r\n+}\r\n \r\n for ($i = 1; $i <= 5; $i++) {\r\n     $def->properties['wait_timeout_hold_' . $i] = new ezcPersistentObjectProperty();\r\n@@ -119,92 +43,17 @@\n     $def->properties['timeout_hold_message_' . $i]->columnName   = 'timeout_hold_message_' . $i;\r\n     $def->properties['timeout_hold_message_' . $i]->propertyName = 'timeout_hold_message_' . $i;\r\n     $def->properties['timeout_hold_message_' . $i]->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\r\n-}\r\n-\r\n-// How many times repeat timeout message\r\n-// 0 - infinity times\r\n-// 1 - one time\r\n-$def->properties['repeat_number'] = new ezcPersistentObjectProperty();\r\n-$def->properties['repeat_number']->columnName   = 'repeat_number';\r\n-$def->properties['repeat_number']->propertyName = 'repeat_number';\r\n-$def->properties['repeat_number']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_INT;\r\n-\r\n-$def->properties['wait_timeout_reply_1'] = new ezcPersistentObjectProperty();\r\n-$def->properties['wait_timeout_reply_1']->columnName   = 'wait_timeout_reply_1';\r\n-$def->properties['wait_timeout_reply_1']->propertyName = 'wait_timeout_reply_1';\r\n-$def->properties['wait_timeout_reply_1']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_INT;\r\n-\r\n-$def->properties['timeout_reply_message_1'] = new ezcPersistentObjectProperty();\r\n-$def->properties['timeout_reply_message_1']->columnName   = 'timeout_reply_message_1';\r\n-$def->properties['timeout_reply_message_1']->propertyName = 'timeout_reply_message_1';\r\n-$def->properties['timeout_reply_message_1']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\r\n-\r\n-$def->properties['wait_timeout_reply_2'] = new ezcPersistentObjectProperty();\r\n-$def->properties['wait_timeout_reply_2']->columnName   = 'wait_timeout_reply_2';\r\n-$def->properties['wait_timeout_reply_2']->propertyName = 'wait_timeout_reply_2';\r\n-$def->properties['wait_timeout_reply_2']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_INT;\r\n-\r\n-$def->properties['timeout_reply_message_2'] = new ezcPersistentObjectProperty();\r\n-$def->properties['timeout_reply_message_2']->columnName   = 'timeout_reply_message_2';\r\n-$def->properties['timeout_reply_message_2']->propertyName = 'timeout_reply_message_2';\r\n-$def->properties['timeout_reply_message_2']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\r\n-\r\n-$def->properties['wait_timeout_reply_3'] = new ezcPersistentObjectProperty();\r\n-$def->properties['wait_timeout_reply_3']->columnName   = 'wait_timeout_reply_3';\r\n-$def->properties['wait_timeout_reply_3']->propertyName = 'wait_timeout_reply_3';\r\n-$def->properties['wait_timeout_reply_3']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_INT;\r\n \r\n-$def->properties['timeout_reply_message_3'] = new ezcPersistentObjectProperty();\r\n-$def->properties['timeout_reply_message_3']->columnName   = 'timeout_reply_message_3';\r\n-$def->properties['timeout_reply_message_3']->propertyName = 'timeout_reply_message_3';\r\n-$def->properties['timeout_reply_message_3']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\r\n+    $def->properties['timeout_reply_message_' . $i] = new ezcPersistentObjectProperty();\r\n+    $def->properties['timeout_reply_message_' . $i]->columnName   = 'timeout_reply_message_' . $i;\r\n+    $def->properties['timeout_reply_message_' . $i]->propertyName = 'timeout_reply_message_' . $i;\r\n+    $def->properties['timeout_reply_message_' . $i]->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\r\n \r\n-$def->properties['wait_timeout_reply_4'] = new ezcPersistentObjectProperty();\r\n-$def->properties['wait_timeout_reply_4']->columnName   = 'wait_timeout_reply_4';\r\n-$def->properties['wait_timeout_reply_4']->propertyName = 'wait_timeout_reply_4';\r\n-$def->properties['wait_timeout_reply_4']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_INT;\r\n-\r\n-$def->properties['timeout_reply_message_4'] = new ezcPersistentObjectProperty();\r\n-$def->properties['timeout_reply_message_4']->columnName   = 'timeout_reply_message_4';\r\n-$def->properties['timeout_reply_message_4']->propertyName = 'timeout_reply_message_4';\r\n-$def->properties['timeout_reply_message_4']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\r\n-\r\n-$def->properties['wait_timeout_reply_5'] = new ezcPersistentObjectProperty();\r\n-$def->properties['wait_timeout_reply_5']->columnName   = 'wait_timeout_reply_5';\r\n-$def->properties['wait_timeout_reply_5']->propertyName = 'wait_timeout_reply_5';\r\n-$def->properties['wait_timeout_reply_5']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_INT;\r\n-\r\n-$def->properties['timeout_reply_message_5'] = new ezcPersistentObjectProperty();\r\n-$def->properties['timeout_reply_message_5']->columnName   = 'timeout_reply_message_5';\r\n-$def->properties['timeout_reply_message_5']->propertyName = 'timeout_reply_message_5';\r\n-$def->properties['timeout_reply_message_5']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\r\n-\r\n-$def->properties['bot_configuration'] = new ezcPersistentObjectProperty();\r\n-$def->properties['bot_configuration']->columnName   = 'bot_configuration';\r\n-$def->properties['bot_configuration']->propertyName = 'bot_configuration';\r\n-$def->properties['bot_configuration']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\r\n-\r\n-// Ignore pending and assigned chat.\r\n-// Pending messages won't be send if chat is assigned\r\n-$def->properties['ignore_pa_chat'] = new ezcPersistentObjectProperty();\r\n-$def->properties['ignore_pa_chat']->columnName   = 'ignore_pa_chat';\r\n-$def->properties['ignore_pa_chat']->propertyName = 'ignore_pa_chat';\r\n-$def->properties['ignore_pa_chat']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_INT;\r\n-\r\n-$def->properties['survey_timeout'] = new ezcPersistentObjectProperty();\r\n-$def->properties['survey_timeout']->columnName   = 'survey_timeout';\r\n-$def->properties['survey_timeout']->propertyName = 'survey_timeout';\r\n-$def->properties['survey_timeout']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_INT;\r\n-\r\n-$def->properties['survey_id'] = new ezcPersistentObjectProperty();\r\n-$def->properties['survey_id']->columnName   = 'survey_id';\r\n-$def->properties['survey_id']->propertyName = 'survey_id';\r\n-$def->properties['survey_id']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_INT;\r\n-\r\n-$def->properties['user_id'] = new ezcPersistentObjectProperty();\r\n-$def->properties['user_id']->columnName   = 'user_id';\r\n-$def->properties['user_id']->propertyName = 'user_id';\r\n-$def->properties['user_id']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_INT;\r\n+    $def->properties['wait_timeout_reply_' . $i] = new ezcPersistentObjectProperty();\r\n+    $def->properties['wait_timeout_reply_' . $i]->columnName   = 'wait_timeout_reply_' . $i;\r\n+    $def->properties['wait_timeout_reply_' . $i]->propertyName = 'wait_timeout_reply_' . $i;\r\n+    $def->properties['wait_timeout_reply_' . $i]->propertyType = ezcPersistentObjectProperty::PHP_TYPE_INT;\r\n+}\r\n \r\n return $def;\r\n \r"
        },
        {
          "filename": "lhc_web/pos/lhabstract/erlhabstractmodelchatalerticon.php",
          "status": "modified",
          "additions": 6,
          "deletions": 9,
          "patch": "@@ -9,15 +9,12 @@\n $def->idProperty->propertyName = 'id';\n $def->idProperty->generator = new ezcPersistentGeneratorDefinition(  'ezcPersistentNativeGenerator' );\n \n-$def->properties['name'] = new ezcPersistentObjectProperty();\n-$def->properties['name']->columnName   = 'name';\n-$def->properties['name']->propertyName = 'name';\n-$def->properties['name']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\n-\n-$def->properties['identifier'] = new ezcPersistentObjectProperty();\n-$def->properties['identifier']->columnName   = 'identifier';\n-$def->properties['identifier']->propertyName = 'identifier';\n-$def->properties['identifier']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\n+foreach (['name','identifier'] as $posAttr) {\n+    $def->properties[$posAttr] = new ezcPersistentObjectProperty();\n+    $def->properties[$posAttr]->columnName   = $posAttr;\n+    $def->properties[$posAttr]->propertyName = $posAttr;\n+    $def->properties[$posAttr]->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\n+}\n \n return $def;\n "
        },
        {
          "filename": "lhc_web/pos/lhabstract/erlhabstractmodelchatcolumn.php",
          "status": "modified",
          "additions": 13,
          "deletions": 44,
          "patch": "@@ -9,50 +9,19 @@\n $def->idProperty->propertyName = 'id';\n $def->idProperty->generator = new ezcPersistentGeneratorDefinition(  'ezcPersistentNativeGenerator' );\n \n-$def->properties['column_name'] = new ezcPersistentObjectProperty();\n-$def->properties['column_name']->columnName   = 'column_name';\n-$def->properties['column_name']->propertyName = 'column_name';\n-$def->properties['column_name']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\n-\n-$def->properties['column_icon'] = new ezcPersistentObjectProperty();\n-$def->properties['column_icon']->columnName   = 'column_icon';\n-$def->properties['column_icon']->propertyName = 'column_icon';\n-$def->properties['column_icon']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\n-\n-$def->properties['column_identifier'] = new ezcPersistentObjectProperty();\n-$def->properties['column_identifier']->columnName   = 'column_identifier';\n-$def->properties['column_identifier']->propertyName = 'column_identifier';\n-$def->properties['column_identifier']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\n-\n-$def->properties['variable'] = new ezcPersistentObjectProperty();\n-$def->properties['variable']->columnName   = 'variable';\n-$def->properties['variable']->propertyName = 'variable';\n-$def->properties['variable']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\n-\n-$def->properties['position'] = new ezcPersistentObjectProperty();\n-$def->properties['position']->columnName   = 'position';\n-$def->properties['position']->propertyName = 'position';\n-$def->properties['position']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_INT;\n-\n-$def->properties['enabled'] = new ezcPersistentObjectProperty();\n-$def->properties['enabled']->columnName   = 'enabled';\n-$def->properties['enabled']->propertyName = 'enabled';\n-$def->properties['enabled']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_INT;\n-\n-$def->properties['conditions'] = new ezcPersistentObjectProperty();\n-$def->properties['conditions']->columnName   = 'conditions';\n-$def->properties['conditions']->propertyName = 'conditions';\n-$def->properties['conditions']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\n-\n-$def->properties['chat_enabled'] = new ezcPersistentObjectProperty();\n-$def->properties['chat_enabled']->columnName   = 'chat_enabled';\n-$def->properties['chat_enabled']->propertyName = 'chat_enabled';\n-$def->properties['chat_enabled']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\n-\n-$def->properties['online_enabled'] = new ezcPersistentObjectProperty();\n-$def->properties['online_enabled']->columnName   = 'online_enabled';\n-$def->properties['online_enabled']->propertyName = 'online_enabled';\n-$def->properties['online_enabled']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\n+foreach (['column_name','column_icon','column_identifier','variable','conditions','popup_content'] as $posAttr) {\n+    $def->properties[$posAttr] = new ezcPersistentObjectProperty();\n+    $def->properties[$posAttr]->columnName   = $posAttr;\n+    $def->properties[$posAttr]->propertyName = $posAttr;\n+    $def->properties[$posAttr]->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\n+}\n+\n+foreach (['icon_mode','position','enabled','chat_enabled','online_enabled','has_popup'] as $posAttr) {\n+    $def->properties[$posAttr] = new ezcPersistentObjectProperty();\n+    $def->properties[$posAttr]->columnName   = $posAttr;\n+    $def->properties[$posAttr]->propertyName = $posAttr;\n+    $def->properties[$posAttr]->propertyType = ezcPersistentObjectProperty::PHP_TYPE_INT;\n+}\n \n return $def;\n "
        },
        {
          "filename": "lhc_web/pos/lhabstract/erlhabstractmodelchatpriority.php",
          "status": "modified",
          "additions": 13,
          "deletions": 24,
          "patch": "@@ -9,30 +9,19 @@\n $def->idProperty->propertyName = 'id';\n $def->idProperty->generator = new ezcPersistentGeneratorDefinition(  'ezcPersistentNativeGenerator' );\n \n-$def->properties['dep_id'] = new ezcPersistentObjectProperty();\n-$def->properties['dep_id']->columnName   = 'dep_id';\n-$def->properties['dep_id']->propertyName = 'dep_id';\n-$def->properties['dep_id']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_INT;\n-\n-$def->properties['value'] = new ezcPersistentObjectProperty();\n-$def->properties['value']->columnName   = 'value';\n-$def->properties['value']->propertyName = 'value';\n-$def->properties['value']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\n-\n-$def->properties['priority'] = new ezcPersistentObjectProperty();\n-$def->properties['priority']->columnName   = 'priority';\n-$def->properties['priority']->propertyName = 'priority';\n-$def->properties['priority']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_INT;\n-\n-$def->properties['sort_priority'] = new ezcPersistentObjectProperty();\n-$def->properties['sort_priority']->columnName   = 'sort_priority';\n-$def->properties['sort_priority']->propertyName = 'sort_priority';\n-$def->properties['sort_priority']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_INT;\n-\n-$def->properties['dest_dep_id'] = new ezcPersistentObjectProperty();\n-$def->properties['dest_dep_id']->columnName   = 'dest_dep_id';\n-$def->properties['dest_dep_id']->propertyName = 'dest_dep_id';\n-$def->properties['dest_dep_id']->propertyType = ezcPersistentObjectProperty::PHP_TYPE_INT;\n+foreach (['value'] as $posAttr) {\n+    $def->properties[$posAttr] = new ezcPersistentObjectProperty();\n+    $def->properties[$posAttr]->columnName   = $posAttr;\n+    $def->properties[$posAttr]->propertyName = $posAttr;\n+    $def->properties[$posAttr]->propertyType = ezcPersistentObjectProperty::PHP_TYPE_STRING;\n+}\n+\n+foreach (['dep_id','priority','sort_priority','dest_dep_id'] as $posAttr) {\n+    $def->properties[$posAttr] = new ezcPersistentObjectProperty();\n+    $def->properties[$posAttr]->columnName   = $posAttr;\n+    $def->properties[$posAttr]->propertyName = $posAttr;\n+    $def->properties[$posAttr]->propertyType = ezcPersistentObjectProperty::PHP_TYPE_INT;\n+}\n \n return $def;\n "
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 1,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 26,
        "max_directory_depth": 8
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "f4b81e738d82ce3271a7c02704591300c1cf4035",
            "date": "2025-01-24T11:48:32Z",
            "author_login": "remdex"
          },
          {
            "sha": "4312ae1c756aef3f8b709bddb16a77ef74dc0c18",
            "date": "2025-01-24T11:45:47Z",
            "author_login": "remdex"
          },
          {
            "sha": "19cb359f8f9dc8355b250be920419969bee62892",
            "date": "2025-01-23T13:00:37Z",
            "author_login": "remdex"
          },
          {
            "sha": "771ad4945cc8b2cbabaae39461764c0063d6f2af",
            "date": "2025-01-23T09:47:11Z",
            "author_login": "remdex"
          },
          {
            "sha": "a6c0e414f1e5b7520fb0de91b7b06c8a23693f72",
            "date": "2025-01-23T09:26:09Z",
            "author_login": "remdex"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.1,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N",
    "cwe_id": "CWE-79",
    "description": "Cross-site Scripting (XSS) in GitHub repository livehelperchat/livehelperchat prior to 3.99v. The attacker can execute malicious JavaScript on the application.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2022-04-29T09:15:08.797",
    "last_modified": "2024-11-21T06:40:54.750",
    "fix_date": "2022-04-27T05:40:03Z"
  },
  "references": [
    {
      "url": "https://github.com/livehelperchat/livehelperchat/commit/edef7a8387be718d0de2dfd1e722789afb0461bc",
      "source": "security@huntr.dev",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/8fd8de01-7e83-4324-9cc8-a97acb9b70d6",
      "source": "security@huntr.dev",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/livehelperchat/livehelperchat/commit/edef7a8387be718d0de2dfd1e722789afb0461bc",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/8fd8de01-7e83-4324-9cc8-a97acb9b70d6",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:03:04.425813",
    "processing_status": "enhanced"
  },
  "repository_context": {
    "name": "livehelperchat",
    "owner": "livehelperchat",
    "created_at": "2012-12-08T14:58:36Z",
    "updated_at": "2025-01-24T12:52:55Z",
    "pushed_at": "2025-01-24T11:48:42Z",
    "size": 350630,
    "stars": 2009,
    "forks": 699,
    "open_issues": 135,
    "watchers": 2009,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "PHP": 19860472,
      "JavaScript": 1913153,
      "Svelte": 230806,
      "CSS": 94511,
      "Hack": 9209,
      "Shell": 6965,
      "Dockerfile": 486,
      "HTML": 354,
      "Python": 202
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "apache-2.0"
    },
    "collected_at": "2025-01-26T07:44:38.068902"
  }
}