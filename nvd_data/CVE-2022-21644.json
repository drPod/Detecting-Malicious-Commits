{
  "cve_id": "CVE-2022-21644",
  "github_data": {
    "repository": "Aaron-Junker/USOC",
    "fix_commit": "06217c66c8f9b114726b21633eabcd88ac9034aa",
    "related_commits": [
      "06217c66c8f9b114726b21633eabcd88ac9034aa",
      "06217c66c8f9b114726b21633eabcd88ac9034aa"
    ],
    "patch_url": "https://github.com/Aaron-Junker/USOC/commit/06217c66c8f9b114726b21633eabcd88ac9034aa.patch",
    "fix_commit_details": {
      "sha": "06217c66c8f9b114726b21633eabcd88ac9034aa",
      "commit_date": "2022-01-03T16:02:38Z",
      "author": {
        "login": "Aaron-Junker",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Update usersearch.php",
        "length": 21,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 195,
        "additions": 112,
        "deletions": 83
      },
      "files": [
        {
          "filename": "admin/pages/usersearch.php",
          "status": "modified",
          "additions": 112,
          "deletions": 83,
          "patch": "@@ -1,89 +1,118 @@\n-<!DOCTYPE html>\n-<html lang=\"<?php echo $U->getSetting(\"site.lang\"); ?>\" dir=\"ltr\">\n-    <head>\n-        <style>\n-            tbody > tr > th {\n-                font-weight: normal;\n-            }\n-        </style>\n-        <meta charset=\"utf-8\">\n-        <title><?php echo $U->getLang(\"admin\") ?> - <?php echo $U->getLang(\"admin.user.search\"); ?></title>\n-    </head>\n-    <body>\n-        <a href=\"javascript:window.close()\"><?php echo $U->getLang(\"admin.exit\"); ?></a>\n-        <p><?php echo $U->getLang(\"admin.user.search.intro\"); ?></p>\n-        <form>\n-            <label for=\"Name\"><?php echo $U->getLang(\"admin.user.field.username\"); ?>:</label><br />\n-            <input type=\"text\" name=\"Name\" /><br />\n-            <label for=\"Mail\"><?php echo $U->getLang(\"admin.user.field.mail\"); ?>:</label><br />\n-            <input type=\"mail\" name=\"Mail\" /><br />\n-            <input type=\"hidden\" name=\"URL\" value=\"usersearch\" />\n-            <input type=\"submit\" value=\"<?php echo $U->getLang(\"admin.user.search.action\"); ?>\" />\n-        </form>\n-        <?php\n-            if(isset($_GET[\"Name\"])){\n-                if($_GET[\"Name\"] !== \"\"){\n-                    $sql = \"SELECT * FROM User WHERE Username='\".$_GET[\"Name\"].\"';\";\n-                    $db_erg = mysqli_query($U->db_link, $sql);\n+<?php\n+    if($U->userHasPermission(\"Backend\", \"User\",\"Search\")){\n+?>\n+    <!DOCTYPE html>\n+    <html lang=\"<?php echo $U->getSetting(\"site.lang\"); ?>\" dir=\"ltr\">\n+        <head>\n+            <style>\n+                tbody > tr > th {\n+                    font-weight: normal;\n                 }\n-            }\n-            if(isset($_GET[\"Mail\"])){\n-                if($_GET[\"Mail\"] !== \"\"){\n-                    $sql = \"SELECT * FROM User WHERE Mail='\".$_GET[\"Mail\"].\"';\";\n-                    $db_erg = mysqli_query($U->db_link, $sql);\n+            </style>\n+            <meta charset=\"utf-8\">\n+            <title><?php echo $U->getLang(\"admin\") ?> - <?php echo $U->getLang(\"admin.user.search\"); ?></title>\n+        </head>\n+        <body>\n+            <a href=\"javascript:window.close()\"><?php echo $U->getLang(\"admin.exit\"); ?></a>\n+            <p><?php echo $U->getLang(\"admin.user.search.intro\"); ?></p>\n+            <form>\n+                <label for=\"Name\"><?php echo $U->getLang(\"admin.user.field.username\"); ?>:</label><br />\n+                <input type=\"text\" name=\"Name\" /><br />\n+                <label for=\"Mail\"><?php echo $U->getLang(\"admin.user.field.mail\"); ?>:</label><br />\n+                <input type=\"mail\" name=\"Mail\" /><br />\n+                <input type=\"hidden\" name=\"URL\" value=\"usersearch\" />\n+                <input type=\"submit\" value=\"<?php echo $U->getLang(\"admin.user.search.action\"); ?>\" />\n+            </form>\n+            <?php\n+                if(isset($_GET[\"Name\"])){\n+                    if($_GET[\"Name\"] !== \"\"){\n+                        $sql = \"SELECT * FROM User WHERE Username='\".mysqli::real_escape_string($_GET[\"Name\"]).\"';\";\n+                        $dbRes = mysqli_query($U->db_link, $sql);\n+                    }\n                 }\n-            }\n-            if(isset($_GET[\"Mail\"]) || isset($_GET[\"Name\"])){\n-                $userhere = False;\n-                while($row = mysqli_fetch_array($db_erg, MYSQLI_ASSOC)){\n-                    $userhere = True;\n-        ?>\n-                    <h4><?php echo str_replace(\"%a\",$row[\"Username\"],$U->getLang(\"admin.user.search.title\")); ?></h4>\n-                    <table>\n-                        <tbody>\n-                            <tr>\n-                                <th>\n-                                    Id:\n-                                </th>\n-                                <th>\n-                                    <?php echo $row[\"Id\"]; ?>\n-                                </th>\n-                            </tr>\n-                            <tr>\n-                                <th>\n-                                    <?php echo $U->getLang(\"admin.user.field.mail\"); ?>:\n-                                </th>\n-                                <th>\n-                                    <?php echo $row[\"Mail\"]; ?>\n-                                </th>\n-                            </tr>\n-                            <tr>\n-                                <th>\n-                                    <?php echo $U->getLang(\"admin.user.field.admin\"); ?>\n-                                </th>\n-                                <th>\n-                                    <?php echo $row[\"Type\"]; ?>\n-                                </th>\n-                            </tr>\n-                            <tr>\n-                                <th>\n-                                    <?php echo $U->getLang(\"admin.user.field.blocked\"); ?>\n-                                </th>\n-                                <th>\n-                                    <?php echo $row[\"blocked\"]; ?>\n-                                </th>\n-                            </tr>\n-                        </tbody>\n-                    </table>\n-        <?php\n+                if(isset($_GET[\"Mail\"])){\n+                    if($_GET[\"Mail\"] !== \"\"){\n+                        $sql = \"SELECT * FROM User WHERE Mail='\".mysqli::real_escape_string($_GET[\"Mail\"]).\"';\";\n+                        $dbRes = mysqli_query($U->db_link, $sql);\n+                    }\n                 }\n-                if(!$userhere&&$_GET[\"Mail\"] !== \"\"){\n-                    echo str_replace(\"%a\", $U->getLang(\"admin.user.field.mail\"), str_replace(\"%b\", $_GET[\"Mail\"], $U->getLang(\"admin.user.notFound.property\")));\n+                if(isset($_GET[\"Id\"])){\n+                    if($_GET[\"Id\"] !== \"\"){\n+                        $sql = \"SELECT * FROM User WHERE Id='\".mysqli::real_escape_string($_GET[\"Id\"]).\"';\";\n+                        $dbRes = mysqli_query($U->db_link, $sql);\n+                    }\n                 }\n-                if(!$userhere&&$_GET[\"Name\"] !== \"\"){\n-                    echo str_replace(\"%a\", $U->getLang(\"admin.user.field.username\"), str_replace(\"%b\", $_GET[\"Name\"], $U->getLang(\"admin.user.notFound.property\")));\n+                if(isset($_GET[\"Mail\"]) || isset($_GET[\"Name\"]) || isset($_GET[\"Id\"])){\n+                    $userhere = False;\n+                    while($row = mysqli_fetch_array($dbRes, MYSQLI_ASSOC)){\n+                        $userhere = True;\n+            ?>\n+                        <h4><?php echo str_replace(\"%a\",$row[\"Username\"],$U->getLang(\"admin.user.search.title\")); ?></h4>\n+                        <table>\n+                            <tbody>\n+                                <tr>\n+                                    <th>\n+                                        Id:\n+                                    </th>\n+                                    <th>\n+                                        <?php echo $row[\"Id\"]; ?>\n+                                    </th>\n+                                </tr>\n+                                <tr>\n+                                    <th>\n+                                        <?php echo $U->getLang(\"admin.user.field.mail\"); ?>:\n+                                    </th>\n+                                    <th>\n+                                        <?php echo $row[\"Mail\"]; ?>\n+                                    </th>\n+                                </tr>\n+                                <tr>\n+                                    <th>\n+                                        <?php echo $U->getLang(\"admin.user.field.permissionlevel\"); ?>\n+                                    </th>\n+                                    <th>\n+                                        <?php echo $U->getPermissionName($row[\"Type\"]); ?>\n+                                    </th>\n+                                </tr>\n+                                <tr>\n+                                    <th>\n+                                        <?php echo $U->getLang(\"admin.user.field.blocked\"); ?>\n+                                    </th>\n+                                    <th>\n+                                        <?php echo $row[\"blocked\"]==0?$U->getLang(\"admin.no\"):$U->getLang(\"admin.yes\"); ?>\n+                                    </th>\n+                                </tr>\n+                            </tbody>\n+                        </table>\n+            <?php\n+                    }\n+                    if(!$userhere&&isset($_GET[\"Mail\"])&&$_GET[\"Mail\"]!==\"\"){\n+                        echo str_replace(\"%a\", $U->getLang(\"admin.user.field.mail\"), str_replace(\"%b\", $_GET[\"Mail\"], $U->getLang(\"admin.user.notFound.property\")));\n+                    }\n+                    if(!$userhere&&isset($_GET[\"Name\"])&&$_GET[\"Name\"]!==\"\"){\n+                        echo str_replace(\"%a\", $U->getLang(\"admin.user.field.username\"), str_replace(\"%b\", $_GET[\"Name\"], $U->getLang(\"admin.user.notFound.property\")));\n+                    }\n+                    if(!$userhere&&isset($_GET[\"Id\"])){\n+                        echo str_replace(\"%a\", $U->getLang(\"admin.user.field.id\"), str_replace(\"%b\", $_GET[\"Id\"], $U->getLang(\"admin.user.notFound.property\")));\n+                    }\n                 }\n-            }\n-        ?>\n+            ?>\n+        </body>\n+    </html>\n+<?php\n+  }else{\n+?>\n+  <!DOCTYPE html>\n+  <html lang=\"<?php echo $U->getSetting(\"site.lang\"); ?>\" dir=\"ltr\">\n+    <head>\n+      <meta charset=\"utf-8\">\n+      <title><?php echo $U->getLang(\"admin\") ?> - <?php echo $U->getLang(\"admin.settings\"); ?></title>\n+    </head>\n+    <body>\n+        <a href=\"javascript:window.close()\"><?php echo $U->getLang(\"admin.exit\"); ?></a>\n+      <p><?php echo $U->getLang(\"rights.error\"); ?></p>\n     </body>\n-</html>\n\\ No newline at end of file\n+  </html>\n+<?php\n+  }\n+?>"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 1,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "57c76f107ea67559b9d369fade6e75735fb8a1dc",
            "date": "2022-02-10T23:31:55Z",
            "author_login": "invalid-email-address"
          },
          {
            "sha": "582021e0e5c6b86730ff74bedcbf8a28eb109759",
            "date": "2022-02-10T23:31:19Z",
            "author_login": "Aaron-Junker"
          },
          {
            "sha": "b4c74f1c5dc80e62c9622a3ad3e49a788666dd97",
            "date": "2022-01-27T13:13:33Z",
            "author_login": "invalid-email-address"
          },
          {
            "sha": "c4f2d2f0062bdb13fabdcc4c7fc5627f3da97bde",
            "date": "2022-01-27T13:12:59Z",
            "author_login": "Aaron-Junker"
          },
          {
            "sha": "abee69b47e65481108216a01ce5ea729c9b39d14",
            "date": "2022-01-27T13:12:39Z",
            "author_login": "Aaron-Junker"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 9.1,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:C/C:H/I:H/A:H",
    "cwe_id": "CWE-89",
    "description": "USOC is an open source CMS with a focus on simplicity. In affected versions USOC allows for SQL injection via usersearch.php. In search terms provided by the user were not sanitized and were used directly to construct a sql statement. The only users permitted to search are site admins. Users are advised to upgrade as soon as possible. There are not workarounds for this issue.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2022-01-04T20:15:07.860",
    "last_modified": "2024-11-21T06:45:08.663",
    "fix_date": "2022-01-03T16:02:38Z"
  },
  "references": [
    {
      "url": "https://github.com/Aaron-Junker/USOC/commit/06217c66c8f9b114726b21633eabcd88ac9034aa",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/Aaron-Junker/USOC/security/advisories/GHSA-89jg-6fr3-9q4h",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/Aaron-Junker/USOC/commit/06217c66c8f9b114726b21633eabcd88ac9034aa",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/Aaron-Junker/USOC/security/advisories/GHSA-89jg-6fr3-9q4h",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:37.046588",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "USOC",
    "owner": "Aaron-Junker",
    "created_at": "2020-04-19T05:11:44Z",
    "updated_at": "2022-01-09T19:58:31Z",
    "pushed_at": "2024-09-03T22:10:13Z",
    "size": 40461,
    "stars": 5,
    "forks": 1,
    "open_issues": 6,
    "watchers": 5,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "master",
      "ver/Pb1.4",
      "ver/Pb1.5",
      "ver/Pb1.6",
      "ver/Pb1.7",
      "ver/Pb1.8",
      "ver/Pb2.0",
      "ver/Pb2.1",
      "ver/Pb2.2",
      "ver/Pb2.3",
      "ver/Pb2.4"
    ],
    "languages": {
      "PHP": 225117,
      "CSS": 124845,
      "JavaScript": 4519,
      "HTML": 2422,
      "Hack": 1030
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T14:02:51.008314"
  }
}