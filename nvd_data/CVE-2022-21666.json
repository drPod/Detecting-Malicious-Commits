{
  "cve_id": "CVE-2022-21666",
  "github_data": {
    "repository": "Aaron-Junker/USOC",
    "fix_commit": "c331d26aaab41a7e9e8c1c1a990132dca9d01e10",
    "related_commits": [
      "c331d26aaab41a7e9e8c1c1a990132dca9d01e10",
      "c331d26aaab41a7e9e8c1c1a990132dca9d01e10"
    ],
    "patch_url": "https://github.com/Aaron-Junker/USOC/commit/c331d26aaab41a7e9e8c1c1a990132dca9d01e10.patch",
    "fix_commit_details": {
      "sha": "c331d26aaab41a7e9e8c1c1a990132dca9d01e10",
      "commit_date": "2022-01-09T07:04:05Z",
      "author": {
        "login": "Aaron-Junker",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Update usersearch.php",
        "length": 21,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 224,
        "additions": 124,
        "deletions": 100
      },
      "files": [
        {
          "filename": "admin/pages/usersearch.php",
          "status": "modified",
          "additions": 124,
          "deletions": 100,
          "patch": "@@ -1,115 +1,139 @@\n <?php\n-    if($U->userHasPermission(\"Backend\", \"User\",\"Search\")){\n+  if($U->userHasPermission(\"Backend\", \"User\")){\n ?>\n-    <!DOCTYPE html>\n-    <html lang=\"<?php echo $U->getSetting(\"site.lang\"); ?>\" dir=\"ltr\">\n-        <head>\n-            <style>\n-                tbody > tr > th {\n-                    font-weight: normal;\n-                }\n-            </style>\n-            <meta charset=\"utf-8\">\n-            <title><?php echo $U->getLang(\"admin\") ?> - <?php echo $U->getLang(\"admin.user.search\"); ?></title>\n-        </head>\n-        <body>\n-            <a href=\"javascript:window.close()\"><?php echo $U->getLang(\"admin.exit\"); ?></a>\n-            <p><?php echo $U->getLang(\"admin.user.search.intro\"); ?></p>\n-            <form>\n-                <label for=\"Name\"><?php echo $U->getLang(\"admin.user.field.username\"); ?>:</label><br />\n-                <input type=\"text\" name=\"Name\" /><br />\n-                <label for=\"Mail\"><?php echo $U->getLang(\"admin.user.field.mail\"); ?>:</label><br />\n-                <input type=\"mail\" name=\"Mail\" /><br />\n-                <input type=\"hidden\" name=\"URL\" value=\"usersearch\" />\n-                <input type=\"submit\" value=\"<?php echo $U->getLang(\"admin.user.search.action\"); ?>\" />\n-            </form>\n-            <?php\n-                if(isset($_GET[\"Name\"])){\n-                    if($_GET[\"Name\"] !== \"\"){\n-                        $sql = \"SELECT * FROM User WHERE Username='\".mysqli::real_escape_string($_GET[\"Name\"]).\"';\";\n-                        $dbRes = mysqli_query($U->db_link, $sql);\n-                    }\n-                }\n-                if(isset($_GET[\"Mail\"])){\n-                    if($_GET[\"Mail\"] !== \"\"){\n-                        $sql = \"SELECT * FROM User WHERE Mail='\".mysqli::real_escape_string($_GET[\"Mail\"]).\"';\";\n-                        $dbRes = mysqli_query($U->db_link, $sql);\n-                    }\n-                }\n-                if(isset($_GET[\"Id\"])){\n-                    if($_GET[\"Id\"] !== \"\"){\n-                        $sql = \"SELECT * FROM User WHERE Id='\".mysqli::real_escape_string($_GET[\"Id\"]).\"';\";\n-                        $dbRes = mysqli_query($U->db_link, $sql);\n-                    }\n-                }\n-                if(isset($_GET[\"Mail\"]) || isset($_GET[\"Name\"]) || isset($_GET[\"Id\"])){\n-                    $userhere = False;\n-                    while($row = mysqli_fetch_array($dbRes, MYSQLI_ASSOC)){\n-                        $userhere = True;\n-            ?>\n-                        <h4><?php echo str_replace(\"%a\",$row[\"Username\"],$U->getLang(\"admin.user.search.title\")); ?></h4>\n-                        <table>\n-                            <tbody>\n-                                <tr>\n-                                    <th>\n-                                        Id:\n-                                    </th>\n-                                    <th>\n-                                        <?php echo $row[\"Id\"]; ?>\n-                                    </th>\n-                                </tr>\n-                                <tr>\n-                                    <th>\n-                                        <?php echo $U->getLang(\"admin.user.field.mail\"); ?>:\n-                                    </th>\n-                                    <th>\n-                                        <?php echo $row[\"Mail\"]; ?>\n-                                    </th>\n-                                </tr>\n-                                <tr>\n-                                    <th>\n-                                        <?php echo $U->getLang(\"admin.user.field.permissionlevel\"); ?>\n-                                    </th>\n-                                    <th>\n-                                        <?php echo $U->getPermissionName($row[\"Type\"]); ?>\n-                                    </th>\n-                                </tr>\n-                                <tr>\n-                                    <th>\n-                                        <?php echo $U->getLang(\"admin.user.field.blocked\"); ?>\n-                                    </th>\n-                                    <th>\n-                                        <?php echo $row[\"blocked\"]==0?$U->getLang(\"admin.no\"):$U->getLang(\"admin.yes\"); ?>\n-                                    </th>\n-                                </tr>\n-                            </tbody>\n-                        </table>\n-            <?php\n-                    }\n-                    if(!$userhere&&isset($_GET[\"Mail\"])&&$_GET[\"Mail\"]!==\"\"){\n-                        echo str_replace(\"%a\", $U->getLang(\"admin.user.field.mail\"), str_replace(\"%b\", $_GET[\"Mail\"], $U->getLang(\"admin.user.notFound.property\")));\n-                    }\n-                    if(!$userhere&&isset($_GET[\"Name\"])&&$_GET[\"Name\"]!==\"\"){\n-                        echo str_replace(\"%a\", $U->getLang(\"admin.user.field.username\"), str_replace(\"%b\", $_GET[\"Name\"], $U->getLang(\"admin.user.notFound.property\")));\n-                    }\n-                    if(!$userhere&&isset($_GET[\"Id\"])){\n-                        echo str_replace(\"%a\", $U->getLang(\"admin.user.field.id\"), str_replace(\"%b\", $_GET[\"Id\"], $U->getLang(\"admin.user.notFound.property\")));\n-                    }\n+  <!DOCTYPE html>\n+  <html lang=\"<?php echo $U->getSetting(\"site.lang\"); ?>\" dir=\"ltr\">\n+    <head>\n+      <meta charset=\"utf-8\">\n+      <title><?php echo $U->getLang(\"admin\") ?> - <?php echo $U->getLang(\"admin.user.edit\"); ?></title>\n+    </head>\n+    <body>\n+      <a href=\"<?php echo $_SERVER['PHP_SELF']; ?>?URL=mainpage\"><?php echo $U->getLang(\"admin.back\"); ?></a>\n+      <?php\n+        if(isset($_POST[\"N\"])&& !isset($_POST[\"Submit\"])){\n+          $sql = \"SELECT * FROM user WHERE id='\".mysqli::real_escape_string($_POST[\"N\"]).\"';\";\n+          $dbRes = mysqli_query($U->db_link, $sql);\n+          $userhere = False;\n+          while($row = mysqli_fetch_array($dbRes, MYSQLI_ASSOC)){\n+            $user_Type = $row[\"Type\"];\n+            $user_Blocked = $row[\"blocked\"];\n+            $userhere = True;\n+          }\n+          if($userhere){\n+            if($_SESSION[\"User_ID\"] !== md5($_POST[\"N\"])){\n+    ?>\n+              <form action=\"<?php echo $_SERVER['PHP_SELF']; ?>?URL=useredit\" method=\"post\">\n+                <?php\n+                  if($U->userHasPermission(\"Backend\", \"User\",\"Permission\")){\n+                ?>\n+                  <label for=\"A\"><?php echo $U->getLang(\"admin.user.permissionLevel\"); ?></label>\n+                  <select name=\"A\" type=\"checkbox\" value=\"<?php echo $user_Type; ?>\">\n+                    <?php\n+                      // Creates a select list with all permission levels\n+                      foreach($U->getPermissionName(-1) as $key => $value){\n+                        echo \"<option name='\".$key.\"'\".($key==$user_Type?\" selected\":\"\").\">\".$value.\"</option>\";\n+                      }\n+                    ?>\n+                  </select>\n+                  <br />\n+                <?php\n+                  }\n+                  if($U->userHasPermission(\"Backend\", \"User\",\"Block\")){\n+                ?>\n+                    <label for=\"G\"><?php echo $U->getLang(\"admin.user.block\"); ?></label>\n+                    <input name=\"G\" type=\"checkbox\" <?php echo $user_Blocked==\"1\"?\"checked\":\"\"; ?> /><br />\n+                <?php\n+                  }\n+                  if($U->userHasPermission(\"Backend\", \"User\",\"Permission\")||$U->userHasPermission(\"Backend\", \"User\",\"Block\")){\n+                ?>\n+                    <input type=\"submit\" name=\"Submit\"/>\n+                    <input type='hidden' name='N' value='<?php echo $_POST[\"N\"]; ?>' />\n+                <?php\n+                  }\n+                ?>\n+              </form>\n+              <?php\n+                if($U->userHasPermission(\"Backend\", \"User\",\"Search\")){\n+              ?>\n+                <!-- Link to user search page (Opens in a pop-up) --> \n+                <a href=\"javascript:window.open('index.php?URL=usersearch&Id=<?php echo $_POST[\"N\"]; ?>', 'Search user', 'width=500,height=500,status=no,titlebar=no,location=no,toolbar=no,left=300');\"><?php echo $U->getLang(\"admin.user.moreInformation\"); ?></a>\n+              <?php\n                 }\n-            ?>\n-        </body>\n-    </html>\n+              ?>\n+    <?php            \n+            }else{\n+              echo \"<br />\".$U->getLang(\"admin.user.yourself\");\n+            }\n+          }else{\n+            echo \"<br />\".str_replace(\"%a\", $_POST[\"N\"], $U->getLang(\"admin.user.notFound\"));\n+          }\n+        }elseif(isset($_POST[\"Submit\"])){\n+          if(isset($_POST[\"A\"])&&$U->userHasPermission(\"Backend\", \"User\",\"Permission\")){\n+            $permissionLevel = $_POST[\"A\"];\n+          }elseif(!$U->userHasPermission(\"Backend\", \"User\",\"Permission\")){\n+            $permissionLevel = false;\n+          }\n+          if(isset($_POST[\"G\"])&&$U->userHasPermission(\"Backend\", \"User\",\"Block\")){\n+            $b = 1;\n+          }elseif($U->userHasPermission(\"Backend\", \"User\",\"Block\")){\n+            $b = 0;\n+          }else{\n+            $b = false;\n+          }\n+          if($_SESSION[\"User_ID\"] !== md5($_POST[\"N\"])){\n+            $sql = \"UPDATE User \".($permissionLevel === false?\"\":\"SET Type='\".$permissionLevel.\"'\".($b==false?\"\":\", \")).($b==false?\"\":\"blocked ='\".$b.\"' \").\"WHERE Id='\".mysqli::real_escape_string($_POST[\"N\"]).\"';\";\n+            $dbRes = mysqli_query($U->db_link, $sql);\n+            echo \"<br />\".$U->getLang(\"admin.user.changed\");\n+          }else{\n+            // When the user tries to edit himself\n+            echo \"<br />\".$U->getLang(\"admin.user.yourself\");\n+          }\n+        }else{\n+          $sql = \"SELECT * FROM User;\";\n+          $dbRes = mysqli_query($U->db_link, $sql);\n+          // Allow only values in the range from the lowest Id to the highest id\n+          $highestId = 0;\n+          // BUG: #54 Lowest ID don't work if over 10000000000000000000000000 accounts are created\n+          $lowestId = 10000000000000000000000000;\n+          while($row = mysqli_fetch_array($dbRes, MYSQLI_ASSOC)){\n+            if($row[\"Id\"] > $highestId){\n+              $highestId = $row[\"Id\"];\n+            }\n+            if($row[\"Id\"] < $lowestId){\n+              $lowestId = $row[\"Id\"];\n+            }\n+          }\n+          $text = <<<'HEREDOC'\n+          <form action=\"$_SERVER[\"PHP_SELF\"]?URL=useredit\" method=\"post\">\n+            <label for=\"N\">ID:</label><input name=\"N\" type=\"number\" min=\"%b\" max=\"%a\" />\n+            <input type=\"submit\" />\n+          </form>\n+          HEREDOC;\n+          $text = str_replace('$_SERVER[\"PHP_SELF\"]', $_SERVER['PHP_SELF'], $text);\n+          $text = str_replace('%a', $highestId, $text);\n+          $text = str_replace('%b', $lowestId, $text);\n+          echo $text;\n+          if($U->userHasPermission(\"Backend\", \"User\",\"Search\")){\n+      ?>\n+            <!-- Link to user search page (Opens in a pop-up) -->\n+            <a href=\"javascript:window.open('index.php?URL=usersearch', 'Search user', 'width=500,height=500,status=no,titlebar=no,location=no,toolbar=no,left=300');\"><?php echo $U->getLang(\"admin.user.search\"); ?></a>\n+      <?php\n+          }\n+        }\n+      ?>\n+    </body>\n+  </html>\n <?php\n   }else{\n ?>\n   <!DOCTYPE html>\n   <html lang=\"<?php echo $U->getSetting(\"site.lang\"); ?>\" dir=\"ltr\">\n     <head>\n       <meta charset=\"utf-8\">\n-      <title><?php echo $U->getLang(\"admin\") ?> - <?php echo $U->getLang(\"admin.settings\"); ?></title>\n+      <title><?php echo $U->getLang(\"admin\") ?> - <?php echo $U->getLang(\"admin.user\"); ?></title>\n     </head>\n     <body>\n-        <a href=\"javascript:window.close()\"><?php echo $U->getLang(\"admin.exit\"); ?></a>\n+      <a href=\"<?php echo $_SERVER['PHP_SELF']; ?>?URL=mainpage\"><?php echo $U->getLang(\"admin.back\"); ?></a>\n       <p><?php echo $U->getLang(\"rights.error\"); ?></p>\n     </body>\n   </html>"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 1,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "57c76f107ea67559b9d369fade6e75735fb8a1dc",
            "date": "2022-02-10T23:31:55Z",
            "author_login": "invalid-email-address"
          },
          {
            "sha": "582021e0e5c6b86730ff74bedcbf8a28eb109759",
            "date": "2022-02-10T23:31:19Z",
            "author_login": "Aaron-Junker"
          },
          {
            "sha": "b4c74f1c5dc80e62c9622a3ad3e49a788666dd97",
            "date": "2022-01-27T13:13:33Z",
            "author_login": "invalid-email-address"
          },
          {
            "sha": "c4f2d2f0062bdb13fabdcc4c7fc5627f3da97bde",
            "date": "2022-01-27T13:12:59Z",
            "author_login": "Aaron-Junker"
          },
          {
            "sha": "abee69b47e65481108216a01ce5ea729c9b39d14",
            "date": "2022-01-27T13:12:39Z",
            "author_login": "Aaron-Junker"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 7.2,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H",
    "cwe_id": "CWE-89",
    "description": "Useful Simple Open-Source CMS (USOC) is a content management system (CMS) for programmers. Versions prior to Pb2.4Bfx3 allowed Sql injection in usersearch.php only for users with administrative privileges. Users should replace the file `admin/pages/useredit.php` with a newer version. USOC version Pb2.4Bfx3 contains a fixed version of `admin/pages/useredit.php`.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2022-01-10T20:15:08.247",
    "last_modified": "2024-11-21T06:45:11.337",
    "fix_date": "2022-01-09T07:04:05Z"
  },
  "references": [
    {
      "url": "https://github.com/Aaron-Junker/USOC/commit/c331d26aaab41a7e9e8c1c1a990132dca9d01e10",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/Aaron-Junker/USOC/releases/tag/Pb2.4Bfx3",
      "source": "security-advisories@github.com",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/Aaron-Junker/USOC/security/advisories/GHSA-557p-hhpc-4wrx",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/Aaron-Junker/USOC/commit/c331d26aaab41a7e9e8c1c1a990132dca9d01e10",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/Aaron-Junker/USOC/releases/tag/Pb2.4Bfx3",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/Aaron-Junker/USOC/security/advisories/GHSA-557p-hhpc-4wrx",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:37.065578",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "USOC",
    "owner": "Aaron-Junker",
    "created_at": "2020-04-19T05:11:44Z",
    "updated_at": "2022-01-09T19:58:31Z",
    "pushed_at": "2024-09-03T22:10:13Z",
    "size": 40461,
    "stars": 5,
    "forks": 1,
    "open_issues": 6,
    "watchers": 5,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "master",
      "ver/Pb1.4",
      "ver/Pb1.5",
      "ver/Pb1.6",
      "ver/Pb1.7",
      "ver/Pb1.8",
      "ver/Pb2.0",
      "ver/Pb2.1",
      "ver/Pb2.2",
      "ver/Pb2.3",
      "ver/Pb2.4"
    ],
    "languages": {
      "PHP": 225117,
      "CSS": 124845,
      "JavaScript": 4519,
      "HTML": 2422,
      "Hack": 1030
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T14:02:51.008314"
  }
}