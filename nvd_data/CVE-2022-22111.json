{
  "cve_id": "CVE-2022-22111",
  "github_data": {
    "repository": "Bottelet/DaybydayCRM",
    "fix_commit": "fe842ea5ede237443f1f45a99aeb839133115d8b",
    "related_commits": [
      "fe842ea5ede237443f1f45a99aeb839133115d8b",
      "fe842ea5ede237443f1f45a99aeb839133115d8b"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "fe842ea5ede237443f1f45a99aeb839133115d8b",
      "commit_date": "2021-06-25T18:38:06Z",
      "author": {
        "login": "Bottelet",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "ensure only admin and owner can change role, and password, unless it is yourself",
        "length": 80,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 33,
        "additions": 31,
        "deletions": 2
      },
      "files": [
        {
          "filename": "app/Http/Controllers/UsersController.php",
          "status": "modified",
          "additions": 13,
          "deletions": 1,
          "patch": "@@ -40,6 +40,10 @@ public function index()\n \n     public function calendarUsers()\n     {\n+        if (!auth()->user()->can('absence-view')) {\n+            session()->flash('flash_message_warning', __('You do not have permission to view this page'));\n+            return redirect()->back();\n+        }\n         return User::with(['department', 'absences' =>  function ($q) {\n             return $q->whereBetween('start_at', [today()->subWeeks(2)->startOfDay(), today()->addWeeks(4)->endOfDay()])\n                       ->orWhereBetween('end_at', [today()->subWeeks(2)->startOfDay(), today()->addWeeks(4)->endOfDay()]);\n@@ -244,6 +248,12 @@ public function update($external_id, UpdateUserRequest $request)\n         $password = bcrypt($request->password);\n         $role = $request->roles;\n         $department = $request->departments;\n+\n+        if( !auth()->user()->canChangePasswordOn($user) ) {\n+            unset($request['password']);\n+        }\n+\n+\n         if ($request->hasFile('image_path')) {\n             $companyname = Setting::first()->external_id;\n             $file =  $request->file('image_path');\n@@ -273,7 +283,9 @@ public function update($external_id, UpdateUserRequest $request)\n         if ($role && $role->name == Role::OWNER_ROLE && $owners->count() <= 1) {\n             Session()->flash('flash_message_warning', __('Not able to change owner role, please choose a new owner first'));\n         } else {\n-            $user->roles()->sync([$request->roles]);\n+            if(auth()->user()->canChangeRole() ) {\n+                $user->roles()->sync([$request->roles]);\n+            }\n         }\n         $user->department()->sync([$department]);\n "
        },
        {
          "filename": "app/Models/User.php",
          "status": "modified",
          "additions": 13,
          "deletions": 0,
          "patch": "@@ -98,6 +98,19 @@ public function tokens()\n         return $this->hasMany(Token::class, 'user_id', 'id');\n     }\n \n+    public function canChangePasswordOn(User $user)\n+    {\n+        if($this->id === $user->id || ( $this->roles->first()->name == Role::OWNER_ROLE || $this->roles->first()->name == Role::ADMIN_ROLE)) {\n+            return true;\n+        }\n+\n+        return false;\n+    }\n+\n+    public function canChangeRole()\n+    {\n+        return $this->roles->first()->name == Role::OWNER_ROLE || $this->roles->first()->name == Role::ADMIN_ROLE;\n+    }\n \n \n     public function isOnline()"
        },
        {
          "filename": "resources/views/users/form.blade.php",
          "status": "modified",
          "additions": 5,
          "deletions": 1,
          "patch": "@@ -61,10 +61,11 @@\n <div class=\"col-sm-12\">\n     <hr>\n </div>\n-\n+@if(isset($user) && auth()->user()->canChangePasswordOn($user))\n <div class=\"col-sm-3\">\n     <label for=\"name\" class=\"base-input-label\">@lang('Security')</label>\n </div>\n+\n <div class=\"col-sm-9\">\n     <div class=\"form-group col-sm-8\">\n         <label for=\"password\" class=\"control-label thin-weight\">@lang('Password')</label>\n@@ -75,13 +76,15 @@\n         <input type=\"password\" name=\"password_confirmation\" class=\"form-control\" value=\"\">\n     </div>\n </div>\n+@endif\n <div class=\"col-sm-12\">\n     <hr>\n </div>\n <div class=\"col-sm-3\">\n     <label for=\"name\" class=\"base-input-label\">@lang('Access')</label>\n </div>\n <div class=\"col-sm-9\">\n+@if(isset($user) && auth()->user()->canChangeRole())\n     <div class=\"form-group col-sm-8\">\n         <label for=\"roles\" class=\"control-label thin-weight\">@lang('Assign role')</label>\n         <select name=\"roles\" id=\"\" class=\"form-control\">\n@@ -90,6 +93,7 @@\n         @endforeach\n         </select>\n     </div>\n+@endif\n     <div class=\"form-group col-sm-8\">\n         <label for=\"departments\" class=\"control-label thin-weight\">@lang('Assign department')</label>\n         <select name=\"departments\" id=\"\" class=\"form-control\">"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 3,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "40d7f5d7553df038a8fe44803bfc110b0292141c",
            "date": "2024-11-05T11:14:22Z",
            "author_login": "nathanwritescode-uk"
          },
          {
            "sha": "ed9693d522402085c8023e577e1064f840979081",
            "date": "2022-02-17T19:04:33Z",
            "author_login": "Bottelet"
          },
          {
            "sha": "4e4401e678ffc949473680c0481b7fa8ed07fb7e",
            "date": "2022-02-17T18:55:04Z",
            "author_login": "shehrozafzal"
          },
          {
            "sha": "3c5ed12e217140859ff980161a742f8f58368151",
            "date": "2021-12-18T14:52:24Z",
            "author_login": "Bottelet"
          },
          {
            "sha": "ea21d692e55d3ab5c2a0b68ad159393b280681f0",
            "date": "2021-12-18T14:36:46Z",
            "author_login": "Bottelet"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 8.8,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H",
    "cwe_id": "CWE-862",
    "description": "In DayByDay CRM, version 2.2.0 is vulnerable to missing authorization. Any application user in the application who has update user permission enabled is able to change the password of other users, including the administrator\u2019s. This allows the attacker to gain access to the highest privileged user in the application.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2022-01-05T15:15:07.990",
    "last_modified": "2024-11-21T06:46:12.273",
    "fix_date": "2021-06-25T18:38:06Z"
  },
  "references": [
    {
      "url": "https://github.com/Bottelet/DaybydayCRM/commit/fe842ea5ede237443f1f45a99aeb839133115d8b",
      "source": "vulnerabilitylab@mend.io",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.whitesourcesoftware.com/vulnerability-database/CVE-2022-22111",
      "source": "vulnerabilitylab@mend.io",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/Bottelet/DaybydayCRM/commit/fe842ea5ede237443f1f45a99aeb839133115d8b",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.whitesourcesoftware.com/vulnerability-database/CVE-2022-22111",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:37.048078",
    "processing_status": "enhanced"
  }
}