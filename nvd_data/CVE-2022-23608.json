{
  "cve_id": "CVE-2022-23608",
  "github_data": {
    "repository": "pjsip/pjproject",
    "fix_commit": "db3235953baa56d2fb0e276ca510fefca751643f",
    "related_commits": [
      "db3235953baa56d2fb0e276ca510fefca751643f",
      "db3235953baa56d2fb0e276ca510fefca751643f"
    ],
    "patch_url": "https://github.com/pjsip/pjproject/commit/db3235953baa56d2fb0e276ca510fefca751643f.patch",
    "fix_commit_details": {
      "sha": "db3235953baa56d2fb0e276ca510fefca751643f",
      "commit_date": "2022-02-20T23:24:52Z",
      "author": {
        "login": "nanangizz",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Merge pull request from GHSA-ffff-m5fm-qm62",
        "length": 313,
        "has_description": true,
        "references_issue": false
      },
      "stats": {
        "total": 48,
        "additions": 42,
        "deletions": 6
      },
      "files": [
        {
          "filename": "pjsip/src/pjsip/sip_ua_layer.c",
          "status": "modified",
          "additions": 42,
          "deletions": 6,
          "patch": "@@ -65,6 +65,9 @@ struct dlg_set\n     /* This is the buffer to store this entry in the hash table. */\n     pj_hash_entry_buf ht_entry;\n \n+    /* Entry key in the hash table */\n+    pj_str_t ht_key;\n+\n     /* List of dialog in this dialog set. */\n     struct dlg_set_head  dlg_list;\n };\n@@ -327,15 +330,16 @@ PJ_DEF(pj_status_t) pjsip_ua_register_dlg( pjsip_user_agent *ua,\n \t     * Create the dialog set and add this dialog to it.\n \t     */\n \t    dlg_set = alloc_dlgset_node();\n+\t    dlg_set->ht_key = dlg->local.info->tag;\n \t    pj_list_init(&dlg_set->dlg_list);\n \t    pj_list_push_back(&dlg_set->dlg_list, dlg);\n \n \t    dlg->dlg_set = dlg_set;\n \n \t    /* Register the dialog set in the hash table. */\n \t    pj_hash_set_np_lower(mod_ua.dlg_table, \n-\t\t\t         dlg->local.info->tag.ptr,\n-                                 (unsigned)dlg->local.info->tag.slen,\n+\t\t\t         dlg_set->ht_key.ptr,\n+                                 (unsigned)dlg_set->ht_key.slen,\n \t\t\t         dlg->local.tag_hval, dlg_set->ht_entry,\n                                  dlg_set);\n \t}\n@@ -345,14 +349,15 @@ PJ_DEF(pj_status_t) pjsip_ua_register_dlg( pjsip_user_agent *ua,\n \tstruct dlg_set *dlg_set;\n \n \tdlg_set = alloc_dlgset_node();\n+\tdlg_set->ht_key = dlg->local.info->tag;\n \tpj_list_init(&dlg_set->dlg_list);\n \tpj_list_push_back(&dlg_set->dlg_list, dlg);\n \n \tdlg->dlg_set = dlg_set;\n \n \tpj_hash_set_np_lower(mod_ua.dlg_table, \n-\t\t             dlg->local.info->tag.ptr,\n-                             (unsigned)dlg->local.info->tag.slen,\n+\t\t             dlg_set->ht_key.ptr,\n+                             (unsigned)dlg_set->ht_key.slen,\n \t\t             dlg->local.tag_hval, dlg_set->ht_entry, dlg_set);\n     }\n \n@@ -397,12 +402,43 @@ PJ_DEF(pj_status_t) pjsip_ua_unregister_dlg( pjsip_user_agent *ua,\n \n     /* If dialog list is empty, remove the dialog set from the hash table. */\n     if (pj_list_empty(&dlg_set->dlg_list)) {\n-\tpj_hash_set_lower(NULL, mod_ua.dlg_table, dlg->local.info->tag.ptr,\n-\t\t          (unsigned)dlg->local.info->tag.slen, \n+\n+\t/* Verify that the dialog set is valid */\n+\tpj_assert(pj_hash_get_lower(mod_ua.dlg_table, dlg_set->ht_key.ptr,\n+\t\t\t\t    (unsigned)dlg_set->ht_key.slen,\n+\t\t\t\t    &dlg->local.tag_hval) == dlg_set);\n+\n+\tpj_hash_set_lower(NULL, mod_ua.dlg_table, dlg_set->ht_key.ptr,\n+\t\t          (unsigned)dlg_set->ht_key.slen,\n \t\t\t  dlg->local.tag_hval, NULL);\n \n \t/* Return dlg_set to free nodes. */\n \tpj_list_push_back(&mod_ua.free_dlgset_nodes, dlg_set);\n+    } else {\n+\t/* If the just unregistered dialog is being used as hash key,\n+\t * reset the dlg_set entry with a new key (i.e: from the first dialog\n+\t * in dlg_set).\n+\t */\n+\tif (dlg_set->ht_key.ptr  == dlg->local.info->tag.ptr &&\n+\t    dlg_set->ht_key.slen == dlg->local.info->tag.slen)\n+\t{\n+\t    pjsip_dialog* key_dlg = dlg_set->dlg_list.next;\n+\n+\t    /* Verify that the old & new keys share the hash value */\n+\t    pj_assert(key_dlg->local.tag_hval == dlg->local.tag_hval);\n+\n+\t    pj_hash_set_lower(NULL, mod_ua.dlg_table, dlg_set->ht_key.ptr,\n+\t\t\t      (unsigned)dlg_set->ht_key.slen,\n+\t\t\t      dlg->local.tag_hval, NULL);\n+\n+\t    dlg_set->ht_key = key_dlg->local.info->tag;\n+\n+\t    pj_hash_set_np_lower(mod_ua.dlg_table,\n+\t\t\t\t dlg_set->ht_key.ptr,\n+\t\t\t\t (unsigned)dlg_set->ht_key.slen,\n+\t\t\t\t key_dlg->local.tag_hval, dlg_set->ht_entry,\n+\t\t\t\t dlg_set);\n+\t}\n     }\n \n     /* Unlock user agent. */"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 1,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "d8795bab62d6f99303b587f9d21d7e53cf2e5b10",
            "date": "2025-01-14T02:17:11Z",
            "author_login": "sauwming"
          },
          {
            "sha": "90293ccc52ea16c5d0e2f5c81768a59b4fc10481",
            "date": "2025-01-13T13:47:33Z",
            "author_login": "sauwming"
          },
          {
            "sha": "b955e8f925c3a932d07fe6d21b23ef33703b0ab8",
            "date": "2025-01-13T08:00:34Z",
            "author_login": "sauwming"
          },
          {
            "sha": "2d4b94a74e2738a174aa7c4cc2fe022620b67132",
            "date": "2025-01-10T09:49:42Z",
            "author_login": "bennylp"
          },
          {
            "sha": "6853491ade9b816b948c09ffe87c9e3aad5a5719",
            "date": "2025-01-10T03:58:44Z",
            "author_login": "nanangizz"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 8.1,
    "cvss_vector": "CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:H",
    "cwe_id": "CWE-416",
    "description": "PJSIP is a free and open source multimedia communication library written in C language implementing standard based protocols such as SIP, SDP, RTP, STUN, TURN, and ICE. In versions up to and including 2.11.1 when in a dialog set (or forking) scenario, a hash key shared by multiple UAC dialogs can potentially be prematurely freed when one of the dialogs is destroyed . The issue may cause a dialog set to be registered in the hash table multiple times (with different hash keys) leading to undefined behavior such as dialog list collision which eventually leading to endless loop. A patch is available in commit db3235953baa56d2fb0e276ca510fefca751643f which will be included in the next release. There are no known workarounds for this issue.",
    "attack_vector": "NETWORK",
    "attack_complexity": "HIGH"
  },
  "temporal_data": {
    "published_date": "2022-02-22T20:15:07.693",
    "last_modified": "2024-11-21T06:48:55.363",
    "fix_date": "2022-02-20T23:24:52Z"
  },
  "references": [
    {
      "url": "http://packetstormsecurity.com/files/166226/Asterisk-Project-Security-Advisory-AST-2022-005.html",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory",
        "VDB Entry"
      ]
    },
    {
      "url": "http://seclists.org/fulldisclosure/2022/Mar/1",
      "source": "security-advisories@github.com",
      "tags": [
        "Mailing List",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/pjsip/pjproject/commit/db3235953baa56d2fb0e276ca510fefca751643f",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/pjsip/pjproject/security/advisories/GHSA-ffff-m5fm-qm62",
      "source": "security-advisories@github.com",
      "tags": [
        "Issue Tracking",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2022/03/msg00035.html",
      "source": "security-advisories@github.com",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2022/03/msg00040.html",
      "source": "security-advisories@github.com",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2022/11/msg00021.html",
      "source": "security-advisories@github.com",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2023/08/msg00038.html",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://security.gentoo.org/glsa/202210-37",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.debian.org/security/2022/dsa-5285",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://packetstormsecurity.com/files/166226/Asterisk-Project-Security-Advisory-AST-2022-005.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory",
        "VDB Entry"
      ]
    },
    {
      "url": "http://seclists.org/fulldisclosure/2022/Mar/1",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/pjsip/pjproject/commit/db3235953baa56d2fb0e276ca510fefca751643f",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/pjsip/pjproject/security/advisories/GHSA-ffff-m5fm-qm62",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Issue Tracking",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2022/03/msg00035.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2022/03/msg00040.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2022/11/msg00021.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2023/08/msg00038.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://security.gentoo.org/glsa/202210-37",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.debian.org/security/2022/dsa-5285",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:59.739455",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "pjproject",
    "owner": "pjsip",
    "created_at": "2016-01-24T05:00:33Z",
    "updated_at": "2025-01-14T02:17:17Z",
    "pushed_at": "2025-01-14T02:17:16Z",
    "size": 45263,
    "stars": 2158,
    "forks": 806,
    "open_issues": 9,
    "watchers": 2158,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "C": 15266807,
      "C++": 1658301,
      "Python": 553465,
      "Shell": 394887,
      "Objective-C": 326996,
      "C#": 141563,
      "Makefile": 115036,
      "Java": 114622,
      "Mathematica": 86105,
      "SWIG": 41289,
      "Swift": 38034,
      "CSS": 21213,
      "Kotlin": 17696,
      "Rust": 4860,
      "Objective-C++": 3801,
      "HTML": 3320,
      "QMake": 3180,
      "Batchfile": 1805,
      "QML": 1121,
      "Pan": 288,
      "Prolog": 25
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "gpl-2.0"
    },
    "collected_at": "2025-01-14T13:52:01.488842"
  }
}