{
  "cve_id": "CVE-2022-23614",
  "github_data": {
    "repository": "twigphp/Twig",
    "fix_commit": "22b9dc3c03ee66d7e21d9ed2ca76052b134cb9e9",
    "related_commits": [
      "22b9dc3c03ee66d7e21d9ed2ca76052b134cb9e9",
      "2eb33080558611201b55079d07ac88f207b466d5",
      "22b9dc3c03ee66d7e21d9ed2ca76052b134cb9e9",
      "2eb33080558611201b55079d07ac88f207b466d5"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "22b9dc3c03ee66d7e21d9ed2ca76052b134cb9e9",
      "commit_date": "2022-02-04T06:54:44Z",
      "author": {
        "login": "fabpot",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "bug #3641 Disallow non closures in `sort` filter when the sanbox mode is enabled (fabpot)",
        "length": 323,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 33,
        "additions": 18,
        "deletions": 15
      },
      "files": [
        {
          "filename": "CHANGELOG",
          "status": "modified",
          "additions": 3,
          "deletions": 3,
          "patch": "@@ -1,10 +1,10 @@\n-# 2.14.11 (2022-XX-XX)\n+# 2.14.11 (2022-02-04)\n \n-* n/a\n+ * Fix a security issue when in a sandbox: the `sort` filter must require a Closure for the `arrow` parameter\n \n # 2.14.10 (2022-01-03)\n \n-* Allow more null arguments when Twig expects a string (for better 8.1 support)\n+ * Allow more null arguments when Twig expects a string (for better 8.1 support)\n \n # 2.14.9 (2022-01-03)\n "
        },
        {
          "filename": "src/Extension/CoreExtension.php",
          "status": "modified",
          "additions": 14,
          "deletions": 11,
          "patch": "@@ -237,7 +237,7 @@ public function getFilters()\n             // array helpers\n             new TwigFilter('join', 'twig_join_filter'),\n             new TwigFilter('split', 'twig_split_filter', ['needs_environment' => true]),\n-            new TwigFilter('sort', 'twig_sort_filter'),\n+            new TwigFilter('sort', 'twig_sort_filter', ['needs_environment' => true]),\n             new TwigFilter('merge', 'twig_array_merge'),\n             new TwigFilter('batch', 'twig_array_batch'),\n             new TwigFilter('column', 'twig_array_column'),\n@@ -926,7 +926,7 @@ function twig_reverse_filter(Environment $env, $item, $preserveKeys = false)\n  *\n  * @return array\n  */\n-function twig_sort_filter($array, $arrow = null)\n+function twig_sort_filter(Environment $env, $array, $arrow = null)\n {\n     if ($array instanceof \\Traversable) {\n         $array = iterator_to_array($array);\n@@ -935,6 +935,8 @@ function twig_sort_filter($array, $arrow = null)\n     }\n \n     if (null !== $arrow) {\n+        twig_check_arrow_in_sandbox($env, $arrow, 'sort', 'filter');\n+\n         uasort($array, $arrow);\n     } else {\n         asort($array);\n@@ -1606,9 +1608,7 @@ function twig_array_filter(Environment $env, $array, $arrow)\n         throw new RuntimeError(sprintf('The \"filter\" filter expects an array or \"Traversable\", got \"%s\".', \\is_object($array) ? \\get_class($array) : \\gettype($array)));\n     }\n \n-    if (!$arrow instanceof Closure && $env->hasExtension('\\Twig\\Extension\\SandboxExtension') && $env->getExtension('\\Twig\\Extension\\SandboxExtension')->isSandboxed()) {\n-        throw new RuntimeError('The callable passed to \"filter\" filter must be a Closure in sandbox mode.');\n-    }\n+    twig_check_arrow_in_sandbox($env, $arrow, 'filter', 'filter');\n \n     if (\\is_array($array)) {\n         return array_filter($array, $arrow, \\ARRAY_FILTER_USE_BOTH);\n@@ -1620,9 +1620,7 @@ function twig_array_filter(Environment $env, $array, $arrow)\n \n function twig_array_map(Environment $env, $array, $arrow)\n {\n-    if (!$arrow instanceof Closure && $env->hasExtension('\\Twig\\Extension\\SandboxExtension') && $env->getExtension('\\Twig\\Extension\\SandboxExtension')->isSandboxed()) {\n-        throw new RuntimeError('The callable passed to the \"map\" filter must be a Closure in sandbox mode.');\n-    }\n+    twig_check_arrow_in_sandbox($env, $arrow, 'map', 'filter');\n \n     $r = [];\n     foreach ($array as $k => $v) {\n@@ -1634,9 +1632,7 @@ function twig_array_map(Environment $env, $array, $arrow)\n \n function twig_array_reduce(Environment $env, $array, $arrow, $initial = null)\n {\n-    if (!$arrow instanceof Closure && $env->hasExtension('\\Twig\\Extension\\SandboxExtension') && $env->getExtension('\\Twig\\Extension\\SandboxExtension')->isSandboxed()) {\n-        throw new RuntimeError('The callable passed to the \"reduce\" filter must be a Closure in sandbox mode.');\n-    }\n+    twig_check_arrow_in_sandbox($env, $arrow, 'reduce', 'filter');\n \n     if (!\\is_array($array)) {\n         if (!$array instanceof \\Traversable) {\n@@ -1648,4 +1644,11 @@ function twig_array_reduce(Environment $env, $array, $arrow, $initial = null)\n \n     return array_reduce($array, $arrow, $initial);\n }\n+\n+function twig_check_arrow_in_sandbox(Environment $env, $arrow, $thing, $type)\n+{\n+    if (!$arrow instanceof Closure && $env->hasExtension('\\Twig\\Extension\\SandboxExtension') && $env->getExtension('\\Twig\\Extension\\SandboxExtension')->isSandboxed()) {\n+        throw new RuntimeError(sprintf('The callable passed to the \"%s\" %s must be a Closure in sandbox mode.', $thing, $type));\n+    }\n+}\n }"
        },
        {
          "filename": "tests/Extension/SandboxTest.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -390,7 +390,7 @@ public function testSandboxDisabledAfterIncludeFunctionError()\n     public function testSandboxWithNoClosureFilter()\n     {\n         $this->expectException('\\Twig\\Error\\RuntimeError');\n-        $this->expectExceptionMessage('The callable passed to \"filter\" filter must be a Closure in sandbox mode in \"index\" at line 1.');\n+        $this->expectExceptionMessage('The callable passed to the \"filter\" filter must be a Closure in sandbox mode in \"index\" at line 1.');\n \n         $twig = $this->getEnvironment(true, ['autoescape' => 'html'], ['index' => <<<EOF\n {{ [\"foo\", \"bar\", \"\"]|filter(\"trim\")|join(\", \") }}"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 3,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "fcd0332dca2a88e69a988ab7e4c603acc910b5e8",
            "date": "2025-01-25T15:41:44Z",
            "author_login": "fabpot"
          },
          {
            "sha": "11535e9058b289d55e5057bf9e701ba64af97ac6",
            "date": "2025-01-25T15:41:07Z",
            "author_login": "fabpot"
          },
          {
            "sha": "b680354bbb639bdf8019e2c488648d5dbbc501ef",
            "date": "2025-01-24T20:37:36Z",
            "author_login": "fabpot"
          },
          {
            "sha": "d76d2d7d260eeb4df2f2d96199c969b8b436a212",
            "date": "2025-01-24T20:36:20Z",
            "author_login": "fabpot"
          },
          {
            "sha": "18007078ba96eb8d208dbc59ad9df94eb984e405",
            "date": "2025-01-24T20:10:08Z",
            "author_login": "xabbuh"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 8.8,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H",
    "cwe_id": "CWE-74",
    "description": "Twig is an open source template language for PHP. When in a sandbox mode, the `arrow` parameter of the `sort` filter must be a closure to avoid attackers being able to run arbitrary PHP functions. In affected versions this constraint was not properly enforced and could lead to code injection of arbitrary PHP code. Patched versions now disallow calling non Closure in the `sort` filter as is the case for some other filters. Users are advised to upgrade.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2022-02-04T23:15:15.727",
    "last_modified": "2024-11-21T06:48:56.180",
    "fix_date": "2022-02-04T06:54:44Z"
  },
  "references": [
    {
      "url": "https://github.com/twigphp/Twig/commit/22b9dc3c03ee66d7e21d9ed2ca76052b134cb9e9",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/twigphp/Twig/commit/2eb33080558611201b55079d07ac88f207b466d5",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/twigphp/Twig/security/advisories/GHSA-5mv2-rx3q-4w2v",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/I2PVV5DUTRUECTIHMTWRI5Z7DVNYQ2YO/",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/OTN4273U4RHVIXED64T7DSMJ3VYTPRE7/",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/PECHIY2XLWUH2WLCNPDGNFMPHPRPCEDZ/",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/SIGZCFSYLPP7UVJ4E4NLHSOQSKYNXSAD/",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://www.debian.org/security/2022/dsa-5107",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/twigphp/Twig/commit/22b9dc3c03ee66d7e21d9ed2ca76052b134cb9e9",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/twigphp/Twig/commit/2eb33080558611201b55079d07ac88f207b466d5",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/twigphp/Twig/security/advisories/GHSA-5mv2-rx3q-4w2v",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/I2PVV5DUTRUECTIHMTWRI5Z7DVNYQ2YO/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/OTN4273U4RHVIXED64T7DSMJ3VYTPRE7/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/PECHIY2XLWUH2WLCNPDGNFMPHPRPCEDZ/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/SIGZCFSYLPP7UVJ4E4NLHSOQSKYNXSAD/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://www.debian.org/security/2022/dsa-5107",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:57.144020",
    "processing_status": "enhanced"
  },
  "repository_context": {
    "name": "Twig",
    "owner": "twigphp",
    "created_at": "2009-10-07T21:23:38Z",
    "updated_at": "2025-01-14T10:54:36Z",
    "pushed_at": "2025-01-12T17:49:31Z",
    "size": 11930,
    "stars": 8222,
    "forks": 1259,
    "open_issues": 57,
    "watchers": 8222,
    "has_security_policy": false,
    "default_branch": "3.x",
    "protected_branches": [],
    "languages": {
      "PHP": 1085470,
      "Shell": 1690,
      "Twig": 641,
      "HTML": 286
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "bsd-3-clause"
    },
    "collected_at": "2025-01-14T16:15:22.367515"
  }
}