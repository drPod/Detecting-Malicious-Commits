{
  "cve_id": "CVE-2022-23652",
  "github_data": {
    "repository": "clastix/capsule-proxy",
    "fix_commit": "efe91f68ebf8a9e3d21491dc57da7b8a746415d8",
    "related_commits": [
      "efe91f68ebf8a9e3d21491dc57da7b8a746415d8",
      "efe91f68ebf8a9e3d21491dc57da7b8a746415d8"
    ],
    "patch_url": "https://github.com/clastix/capsule-proxy/commit/efe91f68ebf8a9e3d21491dc57da7b8a746415d8.patch",
    "fix_commit_details": {
      "sha": "efe91f68ebf8a9e3d21491dc57da7b8a746415d8",
      "commit_date": "2022-02-18T19:53:34Z",
      "author": {
        "login": "prometherion",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "bug: cve exploiting malicious connection header",
        "length": 47,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 31,
        "additions": 31,
        "deletions": 0
      },
      "files": [
        {
          "filename": "go.mod",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -11,6 +11,7 @@ require (\n \tgithub.com/pkg/errors v0.9.1\n \tgithub.com/spf13/pflag v1.0.5\n \tgo.uber.org/zap v1.18.1\n+\tgolang.org/x/net v0.0.0-20210520170846-37e1c6afe023\n \tk8s.io/api v0.22.0\n \tk8s.io/apimachinery v0.22.1\n \tk8s.io/apiserver v0.22.0"
        },
        {
          "filename": "internal/webserver/webserver.go",
          "status": "modified",
          "additions": 30,
          "deletions": 0,
          "patch": "@@ -10,6 +10,7 @@ import (\n \t\"fmt\"\n \t\"net/http\"\n \t\"net/http/httputil\"\n+\t\"net/textproto\"\n \t\"strings\"\n \t\"time\"\n \n@@ -18,6 +19,7 @@ import (\n \t\"github.com/gorilla/handlers\"\n \t\"github.com/gorilla/mux\"\n \t\"github.com/pkg/errors\"\n+\t\"golang.org/x/net/http/httpguts\"\n \t\"k8s.io/apimachinery/pkg/labels\"\n \t\"k8s.io/apimachinery/pkg/util/sets\"\n \t\"k8s.io/apiserver/pkg/authentication/serviceaccount\"\n@@ -178,6 +180,9 @@ func (n kubeFilter) impersonateHandler(writer http.ResponseWriter, request *http\n \tif len(n.bearerToken) > 0 {\n \t\trequest.Header.Set(\"Authorization\", fmt.Sprintf(\"Bearer %s\", n.bearerToken))\n \t}\n+\t// Dropping malicious header connection\n+\t// https://github.com/clastix/capsule-proxy/issues/188\n+\tn.removingHopByHopHeaders(request)\n \n \trequest.Header.Add(\"Impersonate-User\", username)\n \n@@ -355,3 +360,28 @@ func (n kubeFilter) getProxyTenantsForOwnerKind(ownerKind capsulev1beta1.OwnerKi\n \n \treturn\n }\n+\n+func (n *kubeFilter) removingHopByHopHeaders(request *http.Request) {\n+\tconnectionHeaderName, upgradeHeaderName, requestUpgradeType := \"connection\", \"upgrade\", \"\"\n+\n+\tif httpguts.HeaderValuesContainsToken(request.Header[connectionHeaderName], upgradeHeaderName) {\n+\t\trequestUpgradeType = request.Header.Get(upgradeHeaderName)\n+\t}\n+\t// Removing connection headers\n+\tfor _, f := range request.Header.Values(connectionHeaderName) {\n+\t\tfor _, sf := range strings.Split(f, \",\") {\n+\t\t\tif sf = textproto.TrimString(sf); sf != \"\" {\n+\t\t\t\trequest.Header.Del(sf)\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\tif requestUpgradeType != \"\" {\n+\t\trequest.Header.Set(connectionHeaderName, upgradeHeaderName)\n+\t\trequest.Header.Set(upgradeHeaderName, requestUpgradeType)\n+\n+\t\treturn\n+\t}\n+\n+\trequest.Header.Del(connectionHeaderName)\n+}"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 2,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "69d8dda9ef54edacfa54d901c81033432e1db2f6",
            "date": "2025-01-14T11:37:21Z",
            "author_login": "oliverbaehler"
          },
          {
            "sha": "c3384104be815887f6f8a3c0baed88920e7c5348",
            "date": "2025-01-10T19:33:23Z",
            "author_login": "oliverbaehler"
          },
          {
            "sha": "f2c393ea4b1e59617aa6317d2c24e90526f6a35b",
            "date": "2025-01-10T01:58:32Z",
            "author_login": "oliverbaehler"
          },
          {
            "sha": "e53fa53528cbe37d91031fed2e46a8811d8b1ff7",
            "date": "2025-01-09T10:17:47Z",
            "author_login": "dependabot[bot]"
          },
          {
            "sha": "346b7a8981e3a5cee3e44db44e4fed75bdd5d462",
            "date": "2025-01-09T10:17:11Z",
            "author_login": "dependabot[bot]"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 8.8,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H",
    "cwe_id": "CWE-287",
    "description": "capsule-proxy is a reverse proxy for Capsule Operator which provides multi-tenancy in Kubernetes. In versions prior to 0.2.1 an attacker with a proper authentication mechanism may use a malicious `Connection` header to start a privilege escalation attack towards the Kubernetes API Server. This vulnerability allows for an exploit of the `cluster-admin` Role bound to `capsule-proxy`. There are no known workarounds for this issue.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2022-02-22T20:15:07.763",
    "last_modified": "2024-11-21T06:49:01.510",
    "fix_date": "2022-02-18T19:53:34Z"
  },
  "references": [
    {
      "url": "https://github.com/clastix/capsule-proxy/commit/efe91f68ebf8a9e3d21491dc57da7b8a746415d8",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/clastix/capsule-proxy/issues/188",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/clastix/capsule-proxy/security/advisories/GHSA-9cwv-cppx-mqjm",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/clastix/capsule-proxy/commit/efe91f68ebf8a9e3d21491dc57da7b8a746415d8",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/clastix/capsule-proxy/issues/188",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/clastix/capsule-proxy/security/advisories/GHSA-9cwv-cppx-mqjm",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:02:59.739696",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "capsule-proxy",
    "owner": "clastix",
    "created_at": "2020-09-16T13:52:50Z",
    "updated_at": "2025-01-14T11:37:25Z",
    "pushed_at": "2025-01-14T11:37:21Z",
    "size": 1406,
    "stars": 45,
    "forks": 41,
    "open_issues": 14,
    "watchers": 45,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [
      "main"
    ],
    "languages": {
      "Go": 178919,
      "Shell": 120731,
      "Makefile": 13814,
      "Smarty": 13806,
      "Dockerfile": 793,
      "JavaScript": 608
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "apache-2.0"
    },
    "collected_at": "2025-01-14T15:25:02.847269"
  }
}