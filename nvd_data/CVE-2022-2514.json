{
  "cve_id": "CVE-2022-2514",
  "github_data": {
    "repository": "beancount/fava",
    "fix_commit": "ca9e3882c7b5fbf5273ba52340b9fea6a99f3711",
    "related_commits": [
      "ca9e3882c7b5fbf5273ba52340b9fea6a99f3711",
      "ca9e3882c7b5fbf5273ba52340b9fea6a99f3711"
    ],
    "patch_url": "https://github.com/beancount/fava/commit/ca9e3882c7b5fbf5273ba52340b9fea6a99f3711.patch",
    "fix_commit_details": {
      "sha": "ca9e3882c7b5fbf5273ba52340b9fea6a99f3711",
      "commit_date": "2022-06-30T15:43:08Z",
      "author": {
        "login": "yagebu",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "avoid use of |safe filter in templates",
        "length": 149,
        "has_description": true,
        "references_issue": false
      },
      "stats": {
        "total": 45,
        "additions": 27,
        "deletions": 18
      },
      "files": [
        {
          "filename": "src/fava/application.py",
          "status": "modified",
          "additions": 7,
          "deletions": 4,
          "patch": "@@ -35,6 +35,7 @@\n from flask.wrappers import Response\n from flask_babel import Babel  # type: ignore\n from flask_babel import get_translations\n+from markupsafe import Markup\n from werkzeug.utils import secure_filename\n \n from fava import __version__ as fava_version\n@@ -384,10 +385,12 @@ def help_page(page_slug: str) -> str:\n         \"_layout.html\",\n         active_page=\"help\",\n         page_slug=page_slug,\n-        help_html=render_template_string(\n-            html,\n-            beancount_version=beancount_version,\n-            fava_version=fava_version,\n+        help_html=Markup(\n+            render_template_string(\n+                html,\n+                beancount_version=beancount_version,\n+                fava_version=fava_version,\n+            )\n         ),\n         HELP_PAGES=HELP_PAGES,\n     )"
        },
        {
          "filename": "src/fava/core/file.py",
          "status": "modified",
          "additions": 11,
          "deletions": 6,
          "patch": "@@ -22,6 +22,7 @@\n from beancount.core.flags import FLAG_SUMMARIZE\n from beancount.core.flags import FLAG_TRANSFER\n from beancount.parser.printer import format_entry  # type: ignore\n+from markupsafe import Markup\n \n from fava.core._compat import FLAG_RETURNS\n from fava.core._compat import FLAG_UNREALIZED\n@@ -176,7 +177,9 @@ def insert_entries(self, entries: Entries) -> None:\n                 )\n                 self.ledger.extensions.after_insert_entry(entry)\n \n-    def render_entries(self, entries: Entries) -> Generator[str, None, None]:\n+    def render_entries(\n+        self, entries: Entries\n+    ) -> Generator[Markup, None, None]:\n         \"\"\"Return entries in Beancount format.\n \n         Only renders :class:`.Balance` and :class:`.Transaction`.\n@@ -193,12 +196,14 @@ def render_entries(self, entries: Entries) -> Generator[str, None, None]:\n                 if isinstance(entry, Transaction) and entry.flag in EXCL_FLAGS:\n                     continue\n                 try:\n-                    yield get_entry_slice(entry)[0] + \"\\n\"\n+                    yield Markup(get_entry_slice(entry)[0] + \"\\n\")\n                 except (KeyError, FileNotFoundError):\n-                    yield _format_entry(\n-                        entry,\n-                        self.ledger.fava_options.currency_column,\n-                        indent,\n+                    yield Markup(\n+                        _format_entry(\n+                            entry,\n+                            self.ledger.fava_options.currency_column,\n+                            indent,\n+                        )\n                     )\n \n "
        },
        {
          "filename": "src/fava/template_filters.py",
          "status": "modified",
          "additions": 6,
          "deletions": 5,
          "patch": "@@ -12,14 +12,15 @@\n from typing import MutableMapping\n from typing import TypeVar\n \n-import flask\n from beancount.core import compare\n from beancount.core import realization\n from beancount.core.account import ACCOUNT_RE\n from beancount.core.data import Directive\n from beancount.core.inventory import Inventory\n from beancount.core.number import Decimal\n from beancount.core.number import ZERO\n+from flask import url_for\n+from markupsafe import Markup\n \n from fava.context import g\n from fava.core.conversion import cost\n@@ -145,14 +146,14 @@ def basename(file_path: str) -> str:\n     return unicodedata.normalize(\"NFC\", os.path.basename(file_path))\n \n \n-def format_errormsg(message: str) -> str:\n+def format_errormsg(message: str) -> Markup:\n     \"\"\"Match account names in error messages and insert HTML links for them.\"\"\"\n     match = re.search(ACCOUNT_RE, message)\n     if not match:\n-        return message\n+        return Markup(message)\n     account = match.group()\n-    url = flask.url_for(\"account\", name=account)\n-    return (\n+    url = url_for(\"account\", name=account)\n+    return Markup(\n         message.replace(account, f'<a href=\"{url}\">{account}</a>')\n         .replace(\"for '\", \"for \")\n         .replace(\"': \", \": \")"
        },
        {
          "filename": "src/fava/templates/_layout.html",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -43,7 +43,7 @@ <h1>\n       <svelte-component type=\"charts\"></svelte-component>\n       {% block content %}\n       {% if content %}\n-      {{ content|safe }}\n+      {{ content }}\n       {% else %}\n       {% include active_page + '.html' %}\n       {% endif %}"
        },
        {
          "filename": "src/fava/templates/errors.html",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -13,7 +13,7 @@\n       {% with link=url_for_source(file_path=error.source['filename'], line=error.source['lineno']) %}\n       <td><a class=\"source\" href=\"{{ link }}\" title=\"{{ _('Show source %(file)s:%(lineno)s', file=error.source['filename'], lineno=error.source['lineno']) }}\">{{ error.source['filename'] }}</a></td>\n       <td class=\"num\"><a class=\"source\" href=\"{{ link }}\" title=\"{{ _('Show source %(file)s:%(lineno)s', file=error.source['filename'], lineno=error.source['lineno']) }}\">{{ error.source['lineno'] }}</a></td>\n-      <td class=\"pre\">{{ error.message|format_errormsg|safe }}</td>\n+      <td class=\"pre\">{{ error.message|format_errormsg }}</td>\n       {% endwith %}\n     </tr>\n     {% endfor %}"
        },
        {
          "filename": "src/fava/templates/help.html",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -12,6 +12,6 @@ <h3>{{ _('Help pages') }}</h3>\n     </ul>\n   </div>\n   <div class=\"help-text\">\n-    {{ help_html|safe }}\n+    {{ help_html }}\n   </div>\n </div>"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 3,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "e71d724a118d848c8136da521798d397b3c214f2",
            "date": "2025-01-06T14:00:15Z",
            "author_login": "yagebu"
          },
          {
            "sha": "3365454e00ce2a58b6a0a575d7ae0e7fea68ce15",
            "date": "2025-01-04T16:58:30Z",
            "author_login": "yagebu"
          },
          {
            "sha": "20621a8b152c82b479a6cff983de1e44521b2f67",
            "date": "2025-01-02T16:25:09Z",
            "author_login": "yagebu"
          },
          {
            "sha": "cde3f06c01bc072a46191ef177a77403b9392430",
            "date": "2025-01-02T15:10:38Z",
            "author_login": "yagebu"
          },
          {
            "sha": "a910c4561cf2bdfcdb3a4458758727dc00446bf1",
            "date": "2025-01-02T13:25:00Z",
            "author_login": "yagebu"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.1,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N",
    "cwe_id": "CWE-79",
    "description": "The time and filter parameters in Fava prior to v1.22 are vulnerable to reflected XSS due to the lack of escaping of error messages which contained the parameters in verbatim.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2022-07-25T14:15:10.873",
    "last_modified": "2024-11-21T07:01:09.150",
    "fix_date": "2022-06-30T15:43:08Z"
  },
  "references": [
    {
      "url": "https://github.com/beancount/fava/commit/ca9e3882c7b5fbf5273ba52340b9fea6a99f3711",
      "source": "security@huntr.dev",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/dbf77139-4384-4dc5-9994-45a5e0747429",
      "source": "security@huntr.dev",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/beancount/fava/commit/ca9e3882c7b5fbf5273ba52340b9fea6a99f3711",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/dbf77139-4384-4dc5-9994-45a5e0747429",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:03:11.516702",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "fava",
    "owner": "beancount",
    "created_at": "2015-12-04T15:12:55Z",
    "updated_at": "2025-01-14T06:40:56Z",
    "pushed_at": "2025-01-13T20:56:03Z",
    "size": 14960,
    "stars": 2025,
    "forks": 293,
    "open_issues": 93,
    "watchers": 2025,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [
      "main"
    ],
    "languages": {
      "Python": 488452,
      "TypeScript": 241454,
      "Svelte": 163446,
      "CSS": 28581,
      "HTML": 19984,
      "JavaScript": 5192,
      "Makefile": 3972,
      "Shell": 1383,
      "Dockerfile": 241
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-14T13:01:08.206188"
  }
}