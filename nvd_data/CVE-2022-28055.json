{
  "cve_id": "CVE-2022-28055",
  "github_data": {
    "repository": "fusionpbx/fusionpbx",
    "fix_commit": "4e260b170e17705c4c9ccf787be7711b63a40868",
    "related_commits": [
      "4e260b170e17705c4c9ccf787be7711b63a40868",
      "4e260b170e17705c4c9ccf787be7711b63a40868"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "4e260b170e17705c4c9ccf787be7711b63a40868",
      "commit_date": "2022-03-21T16:01:05Z",
      "author": {
        "login": "markjcrane",
        "type": "User",
        "stats": {
          "total_commits": 13715,
          "average_weekly_commits": 20.748865355521936,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 656
        }
      },
      "commit_message": {
        "title": "Remove email_logs download. (#6331)",
        "length": 188,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 141,
        "additions": 3,
        "deletions": 138
      },
      "files": [
        {
          "filename": "app/email_logs/email_logs.php",
          "status": "modified",
          "additions": 2,
          "deletions": 15,
          "patch": "@@ -44,13 +44,6 @@\n //process the http post data by action\n \tif ($action != '' && is_array($emails) && @sizeof($emails) != 0) {\n \t\tswitch ($action) {\n-\t\t\tcase 'download':\n-\t\t\t\tif (permission_exists('email_log_download')) {\n-\t\t\t\t\t$obj = new email_logs;\n-\t\t\t\t\t$obj->download($emails);\n-\t\t\t\t\tmessage::add($text['message-download_failed'],'negative',7000); //download failed, set message\n-\t\t\t\t}\n-\t\t\t\tbreak;\n \t\t\tcase 'resend':\n \t\t\t\tif (permission_exists('email_log_resend')) {\n \t\t\t\t\t$obj = new email_logs;\n@@ -214,9 +207,6 @@\n \tif (permission_exists('email_log_resend') && $result) {\n \t\techo button::create(['type'=>'button','label'=>$text['button-resend'],'icon'=>'paper-plane','onclick'=>\"modal_open('modal-resend','btn_resend');\"]);\n \t}\n-\tif (permission_exists('email_log_download') && $result) {\n-\t\techo button::create(['type'=>'button','label'=>$text['button-download'],'icon'=>$_SESSION['theme']['button_icon_download'],'onclick'=>\"list_action_set('download'); list_form_submit('form_list');\"]);\n-\t}\n \tif (permission_exists('email_log_delete') && $result) {\n \t\techo button::create(['type'=>'button','label'=>$text['button-delete'],'icon'=>$_SESSION['theme']['button_icon_delete'],'name'=>'btn_delete','onclick'=>\"modal_open('modal-delete','btn_delete');\"]);\n \t}\n@@ -286,7 +276,7 @@\n \n \techo \"<table class='list'>\\n\";\n \techo \"<tr class='list-header'>\\n\";\n-\tif (permission_exists('email_log_download') || permission_exists('email_log_resend') || permission_exists('email_log_delete')) {\n+\tif (permission_exists('email_log_resend') || permission_exists('email_log_delete')) {\n \t\techo \"\t<th class='checkbox'>\\n\";\n \t\techo \"\t\t<input type='checkbox' id='checkbox_all' name='checkbox_all' onclick='list_all_toggle();' \".($result ?: \"style='visibility: hidden;'\").\">\\n\";\n \t\techo \"\t</th>\\n\";\n@@ -309,7 +299,7 @@\n \t\tforeach($result as $row) {\n \t\t\t$list_row_url = \"email_log_view.php?id=\".urlencode($row['email_log_uuid']);\n \t\t\techo \"<tr class='list-row' href='\".$list_row_url.\"'>\\n\";\n-\t\t\tif (permission_exists('email_log_download') || permission_exists('email_log_resend') || permission_exists('email_log_delete')) {\n+\t\t\tif (permission_exists('email_log_resend') || permission_exists('email_log_delete')) {\n \t\t\t\techo \"\t<td class='checkbox'>\\n\";\n \t\t\t\techo \"\t\t<input type='checkbox' name='emails[$x][checked]' id='checkbox_\".$x.\"' value='true' onclick=\\\"if (!this.checked) { document.getElementById('checkbox_all').checked = false; }\\\">\\n\";\n \t\t\t\techo \"\t\t<input type='hidden' name='emails[$x][uuid]' value='\".escape($row['email_log_uuid']).\"' />\\n\";\n@@ -326,9 +316,6 @@\n \t\t\tif (permission_exists('email_log_resend')) {\n \t\t\t\techo button::create(['type'=>'button','title'=>$text['button-resend'],'icon'=>'paper-plane','onclick'=>\"list_self_check('checkbox_\".$x.\"'); list_action_set('resend'); list_form_submit('form_list')\"]);\n \t\t\t}\n-\t\t\tif (permission_exists('email_log_download')) {\n-\t\t\t\techo button::create(['type'=>'button','title'=>$text['button-download'],'icon'=>$_SESSION['theme']['button_icon_download'],'onclick'=>\"list_self_check('checkbox_\".$x.\"'); list_action_set('download'); list_form_submit('form_list')\"]);\n-\t\t\t}\n \t\t\techo \"\t</td>\\n\";\n \t\t\techo \"\t<td class='description overflow hide-sm-dn no-link'>\";\n \t\t\techo button::create(['type'=>'button','class'=>'link','label'=>$text['label-reference_cdr'],'link'=>PROJECT_PATH.'/app/xml_cdr/xml_cdr_details.php?id='.urlencode($row['call_uuid'])]);"
        },
        {
          "filename": "app/email_logs/resources/classes/email_logs.php",
          "status": "modified",
          "additions": 1,
          "deletions": 123,
          "patch": "@@ -198,129 +198,7 @@ public function resend($records) {\n \t\t\t}\n \t\t}\n \n-\t\t/**\n-\t\t * download records\n-\t\t */\n-\t\tpublic function download($records) {\n-\t\t\tif (permission_exists($this->permission_prefix.'download')) {\n-\n-\t\t\t\t//add multi-lingual support\n-\t\t\t\t\t$language = new text;\n-\t\t\t\t\t$text = $language->get();\n-\n-\t\t\t\t//validate the token\n-\t\t\t\t\t$token = new token;\n-\t\t\t\t\tif (!$token->validate('/app/email_logs/email_logs.php')) {\n-\t\t\t\t\t\tmessage::add($text['message-invalid_token'],'negative');\n-\t\t\t\t\t\theader('Location: '.$this->list_page);\n-\t\t\t\t\t\texit;\n-\t\t\t\t\t}\n-\n-\t\t\t\t//download multiple records (eventually zip individual emails together)\n-\t\t\t\t\tif (is_array($records) && @sizeof($records) != 0) {\n-\n-\t\t\t\t\t\t//retrieve checked records\n-\t\t\t\t\t\t\tforeach($records as $x => $record) {\n-\t\t\t\t\t\t\t\tif ($record['checked'] == 'true' && is_uuid($record['uuid'])) {\n-\t\t\t\t\t\t\t\t\t$uuids[] = $record['uuid'];\n-\t\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\t}\n-\n-\t\t\t\t\t\t//download emails\n-\t\t\t\t\t\t\tif (is_array($uuids) && @sizeof($uuids) != 0) {\n-\t\t\t\t\t\t\t\tforeach ($uuids as $x => $uuid) {\n-\n-\t\t\t\t\t\t\t\t\t//get email details\n-\t\t\t\t\t\t\t\t\t\t$sql = \"select call_uuid, sent_date, type, email from v_email_logs \";\n-\t\t\t\t\t\t\t\t\t\t$sql .= \"where email_log_uuid = :email_log_uuid \";\n-\t\t\t\t\t\t\t\t\t\t$parameters['email_log_uuid'] = $uuid;\n-\t\t\t\t\t\t\t\t\t\t$database = new database;\n-\t\t\t\t\t\t\t\t\t\t$row = $database->select($sql, $parameters, 'row');\n-\t\t\t\t\t\t\t\t\t\tif (is_array($row) && @sizeof($row) != 0 && is_uuid($row['call_uuid'])) {\n-\n-\t\t\t\t\t\t\t\t\t\t\t//santize filename components\n-\t\t\t\t\t\t\t\t\t\t\t\t$sent_date = str_replace('-','', $row['sent_date']);\n-\t\t\t\t\t\t\t\t\t\t\t\t$sent_date = str_replace(':','', $sent_date);\n-\t\t\t\t\t\t\t\t\t\t\t\t$sent_date = str_replace(' ','_', $sent_date);\n-\t\t\t\t\t\t\t\t\t\t\t\t$type = strtolower($row['type']);\n-\t\t\t\t\t\t\t\t\t\t\t\t$email_filename = $sent_date.'_'.$type.'_'.$row['call_uuid'].'.eml';\n-\n-\t\t\t\t\t\t\t\t\t\t\t//single email\n-\t\t\t\t\t\t\t\t\t\t\t\tif (@sizeof($uuids) == 1) {\n-\n-\t\t\t\t\t\t\t\t\t\t\t\t\t//set headers\n-\t\t\t\t\t\t\t\t\t\t\t\t\t\theader(\"Content-Type: message/rfc822\");\n-\t\t\t\t\t\t\t\t\t\t\t\t\t\theader('Content-Disposition: attachment; filename=\"'.$email_filename.'\"');\n-\t\t\t\t\t\t\t\t\t\t\t\t\t\theader(\"Cache-Control: no-cache, must-revalidate\"); // HTTP/1.1\n-\t\t\t\t\t\t\t\t\t\t\t\t\t\theader(\"Expires: Sat, 26 Jul 1997 05:00:00 GMT\"); // Date in the past\n-\t\t\t\t\t\t\t\t\t\t\t\t\t\theader(\"Content-Length: \".strlen($row['email']));\n-\n-\t\t\t\t\t\t\t\t\t\t\t\t\t//output content\n-\t\t\t\t\t\t\t\t\t\t\t\t\t\techo $row['email'];\n-\t\t\t\t\t\t\t\t\t\t\t\t\t\texit;\n-\t\t\t\t\t\t\t\t\t\t\t\t}\n-\n-\t\t\t\t\t\t\t\t\t\t\t//multiple emails\n-\t\t\t\t\t\t\t\t\t\t\t\telse {\n-\t\t\t\t\t\t\t\t\t\t\t\t\tif (is_dir($_SESSION['server']['temp']['dir'])) {\n-\n-\t\t\t\t\t\t\t\t\t\t\t\t\t\tif (file_put_contents($_SESSION['server']['temp']['dir'].'/'.$email_filename, $row['email'])) {\n-\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t$email_files[] = $_SESSION['server']['temp']['dir'].'/'.$email_filename;\n-\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\t\t\t\t\t\t}\n-\n-\t\t\t\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\t\t\t\tunset($sql, $parameters, $row);\n-\t\t\t\t\t\t\t\t}\n-\n-\t\t\t\t\t\t\t\t//download compressed file\n-\t\t\t\t\t\t\t\tif (@sizeof($email_files) != 0) {\n-\n-\t\t\t\t\t\t\t\t\t//define compressed file name\n-\t\t\t\t\t\t\t\t\t\t$compressed_filename = 'emails_'.date('Ymd_His').'.zip';\n-\n-\t\t\t\t\t\t\t\t\t//compress email files\n-\t\t\t\t\t\t\t\t\t\t$command = 'zip -mj '.$_SESSION['server']['temp']['dir'].'/'.$compressed_filename.' '.implode(' ', $email_files).' 2>&1';\n-\t\t\t\t\t\t\t\t\t\texec($command, $response, $restore_errlevel);\n-\t\t\t\t\t\t\t\t\t\tunset($command);\n-\n-\t\t\t\t\t\t\t\t\t//push download\n-\t\t\t\t\t\t\t\t\t\tif (file_exists($_SESSION['server']['temp']['dir'].'/'.$compressed_filename)) {\n-\n-\t\t\t\t\t\t\t\t\t\t\t//open file\n-\t\t\t\t\t\t\t\t\t\t\t\tsession_cache_limiter('public');\n-\t\t\t\t\t\t\t\t\t\t\t\t$fd = fopen($_SESSION['server']['temp']['dir'].'/'.$compressed_filename, 'rb');\n-\n-\t\t\t\t\t\t\t\t\t\t\t//set headers\n-\t\t\t\t\t\t\t\t\t\t\t\theader(\"Content-Type: application/zip\");\n-\t\t\t\t\t\t\t\t\t\t\t\theader('Content-Disposition: attachment; filename=\"'.$compressed_filename.'\"');\n-\t\t\t\t\t\t\t\t\t\t\t\theader(\"Cache-Control: no-cache, must-revalidate\"); // HTTP/1.1\n-\t\t\t\t\t\t\t\t\t\t\t\theader(\"Expires: Sat, 26 Jul 1997 05:00:00 GMT\"); // Date in the past\n-\t\t\t\t\t\t\t\t\t\t\t\theader(\"Content-Length: \".filesize($_SESSION['server']['temp']['dir'].'/'.$compressed_filename));\n-\n-\t\t\t\t\t\t\t\t\t\t\t//output file content\n-\t\t\t\t\t\t\t\t\t\t\t\tob_clean();\n-\t\t\t\t\t\t\t\t\t\t\t\tfpassthru($fd);\n-\t\t\t\t\t\t\t\t\t\t\t\tfclose($fd);\n-\n-\t\t\t\t\t\t\t\t\t\t\t//remove compressed file\n-\t\t\t\t\t\t\t\t\t\t\t\t@unlink($_SESSION['server']['temp']['dir'].'/'.$compressed_filename);\n-\t\t\t\t\t\t\t\t\t\t\t\texit;\n-\n-\t\t\t\t\t\t\t\t\t\t}\n-\n-\t\t\t\t\t\t\t\t}\n-\n-\t\t\t\t\t\t\t}\n-\n-\t\t\t\t\t}\n-\n-\t\t\t}\n-\n-\t\t} //method\n-\n \t} //class\n }\n \n-?>\n\\ No newline at end of file\n+?>"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 2,
        "max_directory_depth": 4
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "43612a5049f92e5104f0ffc1f21e46d84c0b5836",
            "date": "2025-01-26T02:32:25Z",
            "author_login": "rabbidiesel"
          },
          {
            "sha": "a87bdc997ef81aadd2dc163b8c39b2bba98d694d",
            "date": "2025-01-26T02:24:47Z",
            "author_login": "nktech1135"
          },
          {
            "sha": "da1da92d01cedfb2440c14097897e6bb333efcc8",
            "date": "2025-01-24T23:05:37Z",
            "author_login": "frytimo"
          },
          {
            "sha": "965b24579454666767653d6819a3c35a9d9e4ea4",
            "date": "2025-01-24T23:03:53Z",
            "author_login": "markjcrane"
          },
          {
            "sha": "d77b69b4d54c2388a2fc88384a01d0301299aa95",
            "date": "2025-01-24T17:15:36Z",
            "author_login": "frytimo"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 9.8,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
    "cwe_id": "CWE-78",
    "description": "Fusionpbx v4.4 and below contains a command injection vulnerability via the download email logs function.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2022-05-04T03:15:07.697",
    "last_modified": "2024-11-21T06:56:41.377",
    "fix_date": "2022-03-21T16:01:05Z"
  },
  "references": [
    {
      "url": "https://github.com/fusionpbx/fusionpbx/commit/4e260b170e17705c4c9ccf787be7711b63a40868",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/fusionpbx/fusionpbx/commit/4e260b170e17705c4c9ccf787be7711b63a40868",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:03:04.439111",
    "processing_status": "enhanced"
  }
}