{
  "cve_id": "CVE-2022-29221",
  "github_data": {
    "repository": "smarty-php/smarty",
    "fix_commit": "64ad6442ca1da31cefdab5c9874262b702cccddd",
    "related_commits": [
      "64ad6442ca1da31cefdab5c9874262b702cccddd",
      "64ad6442ca1da31cefdab5c9874262b702cccddd"
    ],
    "patch_url": "https://github.com/smarty-php/smarty/commit/64ad6442ca1da31cefdab5c9874262b702cccddd.patch",
    "fix_commit_details": {
      "sha": "64ad6442ca1da31cefdab5c9874262b702cccddd",
      "commit_date": "2022-05-17T12:55:47Z",
      "author": {
        "login": "wisskid",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Merge branch 'security/blockfunctioninjection'",
        "length": 46,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 44,
        "additions": 27,
        "deletions": 17
      },
      "files": [
        {
          "filename": "CHANGELOG.md",
          "status": "modified",
          "additions": 3,
          "deletions": 2,
          "patch": "@@ -6,10 +6,11 @@ and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0\n \n ## [Unreleased]\n \n-### Changed\n-- Exclude docs and demo from export and composer [#751](https://github.com/smarty-php/smarty/pull/751)\n+### Security\n+- Prevent PHP injection through malicious block name or include file name. This addresses CVE-2022-\n \n ### Fixed\n+- Exclude docs and demo from export and composer [#751](https://github.com/smarty-php/smarty/pull/751)\n - PHP 8.1 deprecation notices in demo/plugins/cacheresource.pdo.php [#706](https://github.com/smarty-php/smarty/issues/706)\n - PHP 8.1 deprecation notices in truncate modifier [#699](https://github.com/smarty-php/smarty/issues/699)\n - Math equation `max(x, y)` didn't work anymore [#721](https://github.com/smarty-php/smarty/issues/721)"
        },
        {
          "filename": "libs/sysplugins/smarty_internal_compile_block.php",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -125,7 +125,7 @@ public function compile($args, Smarty_Internal_TemplateCompilerBase $compiler, $\n         // setup buffer for template function code\n         $compiler->parser->current_buffer = new Smarty_Internal_ParseTree_Template();\n         $output = \"<?php\\n\";\n-        $output .= \"/* {block {$_name}} */\\n\";\n+        $output .= $compiler->cStyleComment(\" {block {$_name}} \") . \"\\n\";\n         $output .= \"class {$_className} extends Smarty_Internal_Block\\n\";\n         $output .= \"{\\n\";\n         foreach ($_block as $property => $value) {\n@@ -155,7 +155,7 @@ public function compile($args, Smarty_Internal_TemplateCompilerBase $compiler, $\n         }\n         $output .= \"}\\n\";\n         $output .= \"}\\n\";\n-        $output .= \"/* {/block {$_name}} */\\n\\n\";\n+        $output .= $compiler->cStyleComment(\" {/block {$_name}} \") . \"\\n\\n\";\n         $output .= \"?>\\n\";\n         $compiler->parser->current_buffer->append_subtree(\n             $compiler->parser,"
        },
        {
          "filename": "libs/sysplugins/smarty_internal_compile_function.php",
          "status": "modified",
          "additions": 4,
          "deletions": 4,
          "patch": "@@ -134,7 +134,7 @@ public function compile($args, Smarty_Internal_TemplateCompilerBase $compiler)\n         if ($compiler->template->compiled->has_nocache_code) {\n             $compiler->parent_compiler->tpl_function[ $_name ][ 'call_name_caching' ] = $_funcNameCaching;\n             $output = \"<?php\\n\";\n-            $output .= \"/* {$_funcNameCaching} */\\n\";\n+            $output .= $compiler->cStyleComment(\" {$_funcNameCaching} \") . \"\\n\";\n             $output .= \"if (!function_exists('{$_funcNameCaching}')) {\\n\";\n             $output .= \"function {$_funcNameCaching} (Smarty_Internal_Template \\$_smarty_tpl,\\$params) {\\n\";\n             $output .= \"ob_start();\\n\";\n@@ -159,7 +159,7 @@ public function compile($args, Smarty_Internal_TemplateCompilerBase $compiler)\n             $output .= \"/*/%%SmartyNocache:{$compiler->template->compiled->nocache_hash}%%*/\\\";\\n?>\";\n             $output .= \"<?php echo str_replace('{$compiler->template->compiled->nocache_hash}', \\$_smarty_tpl->compiled->nocache_hash ?? '', ob_get_clean());\\n\";\n             $output .= \"}\\n}\\n\";\n-            $output .= \"/*/ {$_funcName}_nocache */\\n\\n\";\n+            $output .= $compiler->cStyleComment(\"/ {$_funcName}_nocache \") . \"\\n\\n\";\n             $output .= \"?>\\n\";\n             $compiler->parser->current_buffer->append_subtree(\n                 $compiler->parser,\n@@ -179,7 +179,7 @@ public function compile($args, Smarty_Internal_TemplateCompilerBase $compiler)\n         }\n         $compiler->parent_compiler->tpl_function[ $_name ][ 'call_name' ] = $_funcName;\n         $output = \"<?php\\n\";\n-        $output .= \"/* {$_funcName} */\\n\";\n+        $output .= $compiler->cStyleComment(\" {$_funcName} \") . \"\\n\";\n         $output .= \"if (!function_exists('{$_funcName}')) {\\n\";\n         $output .= \"function {$_funcName}(Smarty_Internal_Template \\$_smarty_tpl,\\$params) {\\n\";\n         $output .= $_paramsCode;\n@@ -196,7 +196,7 @@ public function compile($args, Smarty_Internal_TemplateCompilerBase $compiler)\n         );\n         $compiler->parser->current_buffer->append_subtree($compiler->parser, $_functionCode);\n         $output = \"<?php\\n}}\\n\";\n-        $output .= \"/*/ {$_funcName} */\\n\\n\";\n+        $output .= $compiler->cStyleComment(\"/ {$_funcName} \") . \"\\n\\n\";\n         $output .= \"?>\\n\";\n         $compiler->parser->current_buffer->append_subtree(\n             $compiler->parser,"
        },
        {
          "filename": "libs/sysplugins/smarty_internal_compile_include.php",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -318,14 +318,14 @@ public function compileInlineTemplate(\n             }\n             // get compiled code\n             $compiled_code = \"<?php\\n\\n\";\n-            $compiled_code .= \"/* Start inline template \\\"{$sourceInfo}\\\" =============================*/\\n\";\n+            $compiled_code .= $compiler->cStyleComment(\" Start inline template \\\"{$sourceInfo}\\\" =============================\") . \"\\n\";\n             $compiled_code .= \"function {$tpl->compiled->unifunc} (Smarty_Internal_Template \\$_smarty_tpl) {\\n\";\n             $compiled_code .= \"?>\\n\" . $tpl->compiler->compileTemplateSource($tpl, null, $compiler->parent_compiler);\n             $compiled_code .= \"<?php\\n\";\n             $compiled_code .= \"}\\n?>\\n\";\n             $compiled_code .= $tpl->compiler->postFilter($tpl->compiler->blockOrFunctionCode);\n             $compiled_code .= \"<?php\\n\\n\";\n-            $compiled_code .= \"/* End inline template \\\"{$sourceInfo}\\\" =============================*/\\n\";\n+            $compiled_code .= $compiler->cStyleComment(\" End inline template \\\"{$sourceInfo}\\\" =============================\") . \"\\n\";\n             $compiled_code .= '?>';\n             unset($tpl->compiler);\n             if ($tpl->compiled->has_nocache_code) {"
        },
        {
          "filename": "libs/sysplugins/smarty_internal_config_file_compiler.php",
          "status": "modified",
          "additions": 6,
          "deletions": 4,
          "patch": "@@ -157,10 +157,12 @@ public function compileTemplate(Smarty_Internal_Template $template)\n             $this->smarty->_debug->end_compile($this->template);\n         }\n         // template header code\n-        $template_header =\n-            \"<?php /* Smarty version \" . Smarty::SMARTY_VERSION . \", created on \" . date(\"Y-m-d H:i:s\") .\n-            \"\\n\";\n-        $template_header .= \"         compiled from '{$this->template->source->filepath}' */ ?>\\n\";\n+        $template_header = sprintf(\n+            \"<?php /* Smarty version %s, created on %s\\n         compiled from '%s' */ ?>\\n\",\n+            Smarty::SMARTY_VERSION,\n+            date(\"Y-m-d H:i:s\"),\n+            str_replace('*/', '* /' , $this->template->source->filepath)\n+        );\n         $code = '<?php $_smarty_tpl->smarty->ext->configLoad->_loadConfigVars($_smarty_tpl, ' .\n                 var_export($this->config_data, true) . '); ?>';\n         return $template_header . $this->template->smarty->ext->_codeFrame->create($this->template, $code);"
        },
        {
          "filename": "libs/sysplugins/smarty_internal_runtime_codeframe.php",
          "status": "modified",
          "additions": 6,
          "deletions": 3,
          "patch": "@@ -44,9 +44,12 @@ public function create(\n             $properties[ 'file_dependency' ] = $_template->cached->file_dependency;\n             $properties[ 'cache_lifetime' ] = $_template->cache_lifetime;\n         }\n-        $output = \"<?php\\n\";\n-        $output .= \"/* Smarty version {$properties[ 'version' ]}, created on \" . date(\"Y-m-d H:i:s\") .\n-                   \"\\n  from '\" . str_replace('*/', '* /', $_template->source->filepath) . \"' */\\n\\n\";\n+        $output = sprintf(\n+\t\t\t\"<?php\\n/* Smarty version %s, created on %s\\n  from '%s' */\\n\\n\",\n+            $properties[ 'version' ],\n+\t        date(\"Y-m-d H:i:s\"),\n+\t        str_replace('*/', '* /', $_template->source->filepath)\n+        );\n         $output .= \"/* @var Smarty_Internal_Template \\$_smarty_tpl */\\n\";\n         $dec = \"\\$_smarty_tpl->_decodeProperties(\\$_smarty_tpl, \" . var_export($properties, true) . ',' .\n                ($cache ? 'true' : 'false') . ')';"
        },
        {
          "filename": "libs/sysplugins/smarty_internal_templatecompilerbase.php",
          "status": "modified",
          "additions": 4,
          "deletions": 0,
          "patch": "@@ -1439,6 +1439,10 @@ public function compileCheckPlugins($requiredPlugins)\n      */\n     abstract protected function doCompile($_content, $isTemplateSource = false);\n \n+    public function cStyleComment($string) {\n+        return '/*' . str_replace('*/', '* /' , $string) . '*/';\n+    }\n+\n     /**\n      * Compile Tag\n      *"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 1,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 2,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "5d1ea5806a10071fdb6af0fa945c8e3f58e033c4",
            "date": "2024-12-28T16:40:25Z",
            "author_login": "wisskid"
          },
          {
            "sha": "ab247c723b58743f3ba9fe95dc13e91e11d9fc97",
            "date": "2024-12-27T22:37:21Z",
            "author_login": "wisskid"
          },
          {
            "sha": "fb997111f46c069ee140829a220bb3b69b34969b",
            "date": "2024-12-27T22:08:17Z",
            "author_login": "wisskid"
          },
          {
            "sha": "c6bff5795081ca5e60aabda59fb87daa511acd1e",
            "date": "2024-12-23T00:38:44Z",
            "author_login": "wisskid"
          },
          {
            "sha": "07faafe4da4b71489e0f9472242f0cc01e09250a",
            "date": "2024-12-23T00:38:41Z",
            "author_login": "wisskid"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 8.8,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H",
    "cwe_id": "CWE-94",
    "description": "Smarty is a template engine for PHP, facilitating the separation of presentation (HTML/CSS) from application logic. Prior to versions 3.1.45 and 4.1.1, template authors could inject php code by choosing a malicious {block} name or {include} file name. Sites that cannot fully trust template authors should upgrade to versions 3.1.45 or 4.1.1 to receive a patch for this issue. There are currently no known workarounds.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2022-05-24T15:15:07.917",
    "last_modified": "2024-11-21T06:58:44.963",
    "fix_date": "2022-05-17T12:55:47Z"
  },
  "references": [
    {
      "url": "https://github.com/smarty-php/smarty/commit/64ad6442ca1da31cefdab5c9874262b702cccddd",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/smarty-php/smarty/releases/tag/v3.1.45",
      "source": "security-advisories@github.com",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/smarty-php/smarty/releases/tag/v4.1.1",
      "source": "security-advisories@github.com",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/smarty-php/smarty/security/advisories/GHSA-634x-pc3q-cf4c",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2022/05/msg00044.html",
      "source": "security-advisories@github.com",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/BRAJVDRGCIY5UZ2PQHKDTT7RMKG6WJQQ/",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/L777JIBIWJV34HS7LXPIDWASG7TT4LNI/",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://security.gentoo.org/glsa/202209-09",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.debian.org/security/2022/dsa-5151",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/smarty-php/smarty/commit/64ad6442ca1da31cefdab5c9874262b702cccddd",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/smarty-php/smarty/releases/tag/v3.1.45",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/smarty-php/smarty/releases/tag/v4.1.1",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/smarty-php/smarty/security/advisories/GHSA-634x-pc3q-cf4c",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2022/05/msg00044.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/BRAJVDRGCIY5UZ2PQHKDTT7RMKG6WJQQ/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/L777JIBIWJV34HS7LXPIDWASG7TT4LNI/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://security.gentoo.org/glsa/202209-09",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.debian.org/security/2022/dsa-5151",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:03:07.156189",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "smarty",
    "owner": "smarty-php",
    "created_at": "2014-10-30T20:15:10Z",
    "updated_at": "2025-01-13T22:33:50Z",
    "pushed_at": "2025-01-08T11:27:01Z",
    "size": 23593,
    "stars": 2281,
    "forks": 715,
    "open_issues": 81,
    "watchers": 2281,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "PHP": 1613277,
      "Smarty": 109878,
      "Yacc": 42889,
      "Dockerfile": 2385,
      "Shell": 2006,
      "Makefile": 906
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T16:19:38.611302"
  }
}