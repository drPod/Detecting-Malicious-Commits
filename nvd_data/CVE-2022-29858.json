{
  "cve_id": "CVE-2022-29858",
  "github_data": {
    "repository": "silverstripe/silverstripe-assets",
    "fix_commit": "5f6a73b010c01587ffbfb954441f6b7cbb54e767",
    "related_commits": [
      "5f6a73b010c01587ffbfb954441f6b7cbb54e767",
      "5f6a73b010c01587ffbfb954441f6b7cbb54e767"
    ],
    "patch_url": "https://github.com/silverstripe/silverstripe-assets/commit/5f6a73b010c01587ffbfb954441f6b7cbb54e767.patch",
    "fix_commit_details": {
      "sha": "5f6a73b010c01587ffbfb954441f6b7cbb54e767",
      "commit_date": "2022-04-27T00:12:37Z",
      "author": {
        "login": "emteknetnz",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "[CVE-2022-29858] Read grant config for regenerate_shortcode",
        "length": 59,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 45,
        "additions": 44,
        "deletions": 1
      },
      "files": [
        {
          "filename": "src/Shortcodes/ImageShortcodeProvider.php",
          "status": "modified",
          "additions": 3,
          "deletions": 1,
          "patch": "@@ -136,10 +136,12 @@ public static function handle_shortcode($args, $content, $parser, $shortcode, $e\n      */\n     public static function regenerate_shortcode($args, $content, $parser, $shortcode, $extra = [])\n     {\n+        $allowSessionGrant = static::config()->allow_session_grant;\n+\n         // Check if there is a suitable record\n         $record = static::find_shortcode_record($args);\n         if ($record) {\n-            $args['src'] = $record->getURL();\n+            $args['src'] = $record->getURL($allowSessionGrant);\n         }\n \n         // Rebuild shortcode"
        },
        {
          "filename": "tests/php/Shortcodes/ImageShortcodeProviderTest.php",
          "status": "modified",
          "additions": 41,
          "deletions": 0,
          "patch": "@@ -4,11 +4,17 @@\n \n use SilverStripe\\Assets\\File;\n use Silverstripe\\Assets\\Dev\\TestAssetStore;\n+use SilverStripe\\Assets\\FilenameParsing\\ParsedFileID;\n+use SilverStripe\\Assets\\Storage\\AssetStore;\n use SilverStripe\\Core\\Config\\Config;\n use SilverStripe\\Dev\\SapphireTest;\n use SilverStripe\\View\\Parsers\\ShortcodeParser;\n use SilverStripe\\Assets\\Image;\n use SilverStripe\\Assets\\Shortcodes\\ImageShortcodeProvider;\n+use SilverStripe\\Assets\\Shortcodes\\FileShortcodeProvider;\n+use SilverStripe\\Core\\Injector\\Injector;\n+use SilverStripe\\Security\\InheritedPermissions;\n+use SilverStripe\\Security\\Member;\n \n /**\n  * @skipUpgrade\n@@ -187,4 +193,39 @@ public function testLazyLoading()\n             $this->assertStringNotContainsString('loading=\"lazy\"', $parser->parse($shortcode));\n         });\n     }\n+\n+    public function testRegenerateShortcode()\n+    {\n+        $assetStore = Injector::inst()->get(AssetStore::class);\n+        $member = Member::create();\n+        $member->write();\n+        // Logout first to throw away the existing session which may have image grants.\n+        $this->logOut();\n+        $this->logInAs($member);\n+        // image is in protected asset store\n+        $image = $this->objFromFixture(Image::class, 'imageWithTitle');\n+        $image->CanViewType = InheritedPermissions::ONLY_THESE_USERS;\n+        $image->write();\n+        $url = $image->getUrl(false);\n+        $args = [\n+            'id' => $image->ID,\n+            'src' => $url,\n+            'width' => '550',\n+            'height' => '366',\n+            'class' => 'leftAlone ss-htmleditorfield-file image',\n+        ];\n+        $shortHash = substr($image->getHash(), 0, 10);\n+        $expected = implode(' ', [\n+            '[image id=\"' . $image->ID . '\" src=\"/assets/folder/' . $shortHash . '/test-image.png\" width=\"550\"',\n+            'height=\"366\" class=\"leftAlone ss-htmleditorfield-file image\"]'\n+        ]);\n+        $parsedFileID = new ParsedFileID($image->getFilename(), $image->getHash());\n+        $html = ImageShortcodeProvider::regenerate_shortcode($args, '', '', 'image');\n+        $this->assertSame($expected, $html);\n+        $this->assertFalse($assetStore->isGranted($parsedFileID));\n+        Config::modify()->set(FileShortcodeProvider::class, 'allow_session_grant', true);\n+        $html = ImageShortcodeProvider::regenerate_shortcode($args, '', '', 'image');\n+        $this->assertSame($expected, $html);\n+        $this->assertTrue($assetStore->isGranted($parsedFileID));\n+    }\n }"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 2,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "7dfc2eff3179c3d508e82a84d2e1771bd5613fdb",
            "date": "2025-01-12T05:30:39Z",
            "author_login": "github-actions[bot]"
          },
          {
            "sha": "c6bbd8814a054f76f312b52c4a9fe598a4458de7",
            "date": "2025-01-06T03:53:05Z",
            "author_login": "GuySartorelli"
          },
          {
            "sha": "627d272f8c57ef486989f20c38bcca3ef050140d",
            "date": "2025-01-06T01:36:47Z",
            "author_login": "GuySartorelli"
          },
          {
            "sha": "1a4fffeb64117739962e5e63b813e7660af2ee87",
            "date": "2024-11-27T21:09:16Z",
            "author_login": "GuySartorelli"
          },
          {
            "sha": "f1ec760ba41202cfd32d7b00ad75bab00afa80bc",
            "date": "2024-11-27T04:28:55Z",
            "author_login": "emteknetnz"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 4.3,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N",
    "cwe_id": "CWE-287",
    "description": "Silverstripe silverstripe/assets through 1.10 is vulnerable to improper access control that allows protected images to be published by changing an existing image short code on website content.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2022-06-28T22:15:07.997",
    "last_modified": "2024-11-21T06:59:50.297",
    "fix_date": "2022-04-27T00:12:37Z"
  },
  "references": [
    {
      "url": "https://forum.silverstripe.org/c/releases",
      "source": "cve@mitre.org",
      "tags": [
        "Release Notes",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/silverstripe/silverstripe-assets/commit/5f6a73b010c01587ffbfb954441f6b7cbb54e767",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/90e17d95-9f2f-44eb-9f26-49fa13a41d5a/",
      "source": "cve@mitre.org",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.silverstripe.org/blog/tag/release",
      "source": "cve@mitre.org",
      "tags": [
        "Release Notes",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://www.silverstripe.org/download/security-releases/",
      "source": "cve@mitre.org",
      "tags": [
        "Not Applicable",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://www.silverstripe.org/download/security-releases/cve-2022-29858",
      "source": "cve@mitre.org",
      "tags": [
        "Release Notes",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://forum.silverstripe.org/c/releases",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/silverstripe/silverstripe-assets/commit/5f6a73b010c01587ffbfb954441f6b7cbb54e767",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/90e17d95-9f2f-44eb-9f26-49fa13a41d5a/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.silverstripe.org/blog/tag/release",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://www.silverstripe.org/download/security-releases/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Not Applicable",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://www.silverstripe.org/download/security-releases/cve-2022-29858",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes",
        "Vendor Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:03:09.496418",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "silverstripe-assets",
    "owner": "silverstripe",
    "created_at": "2017-03-16T03:26:23Z",
    "updated_at": "2025-01-12T05:30:43Z",
    "pushed_at": "2025-01-14T04:21:36Z",
    "size": 1750,
    "stars": 10,
    "forks": 68,
    "open_issues": 91,
    "watchers": 10,
    "has_security_policy": false,
    "default_branch": "2",
    "protected_branches": [
      "1",
      "1.2",
      "1.3",
      "1.4",
      "1.5",
      "1.6",
      "1.7",
      "1.8",
      "1.9",
      "1.10",
      "1.11",
      "1.12",
      "1.13",
      "2",
      "2.0",
      "2.1",
      "2.2",
      "2.3",
      "3",
      "3.0"
    ],
    "languages": {
      "PHP": 809062,
      "Scheme": 3180
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "bsd-3-clause"
    },
    "collected_at": "2025-01-14T12:56:28.606153"
  }
}