{
  "cve_id": "CVE-2022-31093",
  "github_data": {
    "repository": "nextauthjs/next-auth",
    "fix_commit": "25517b73153332d948114bacdff3b5908de91d85",
    "related_commits": [
      "25517b73153332d948114bacdff3b5908de91d85",
      "e498483b23273d1bfc81be68339607f88d411bd6",
      "25517b73153332d948114bacdff3b5908de91d85",
      "e498483b23273d1bfc81be68339607f88d411bd6"
    ],
    "patch_url": "https://github.com/nextauthjs/next-auth/commit/25517b73153332d948114bacdff3b5908de91d85.patch",
    "fix_commit_details": {
      "sha": "25517b73153332d948114bacdff3b5908de91d85",
      "commit_date": "2022-06-10T11:52:00Z",
      "author": {
        "login": "balazsorban44",
        "type": "User",
        "stats": {
          "total_commits": 1438,
          "average_weekly_commits": 3.9397260273972603,
          "total_additions": 494013,
          "total_deletions": 498688,
          "weeks_active": 178
        }
      },
      "commit_message": {
        "title": "fix: handle invalid `callbackUrl`",
        "length": 33,
        "has_description": false,
        "references_issue": true
      },
      "stats": {
        "total": 52,
        "additions": 48,
        "deletions": 4
      },
      "files": [
        {
          "filename": "docs/docs/errors.md",
          "status": "modified",
          "additions": 7,
          "deletions": 3,
          "patch": "@@ -99,7 +99,7 @@ This is required to store the verification token. Please see the [email provider\n \n The Credentials Provider can only be used if JSON Web Tokens are used for sessions.\n \n-JSON Web Tokens are used for Sessions by default if you have not specified a database. However, if you are using a database, then Database Sessions are enabled by default and you need to [explicitly enable JWT Sessions](https://next-auth.js.org/configuration/options#session) to use the Credentials Provider.\n+JSON Web Tokens are used for Sessions by default if you have not specified a database. However, if you are using a database, then Database Sessions are enabled by default and you need to [explicitly enable JWT Sessions](/configuration/options#session) to use the Credentials Provider.\n \n If you are using a Credentials Provider, NextAuth.js will not persist users or sessions in a database - user accounts used with the Credentials Provider must be created and managed outside of NextAuth.js.\n \n@@ -119,13 +119,17 @@ The default `code_challenge_method` is `\"S256\"`. This is currently not configura\n > If the client is capable of using \"S256\", it MUST use \"S256\", as\n   S256\" is Mandatory To Implement (MTI) on the server.\n \n+#### INVALID_CALLBACK_URL_ERROR\n+\n+The `callbackUrl` provided was either invalid or not defined. See [specifying a `callbackUrl`](/getting-started/client#specifying-a-callbackurl) for more information.\n+\n ---\n \n ### Session Handling\n \n #### JWT_SESSION_ERROR\n \n-https://next-auth.js.org/errors#jwt_session_error JWKKeySupport: the key does not support HS512 verify algorithm\n+JWKKeySupport: the key does not support HS512 verify algorithm\n \n The algorithm used for generating your key isn't listed as supported. You can generate a HS512 key using\n \n@@ -161,7 +165,7 @@ Make sure the file is there and the filename is written correctly.\n \n #### NO_SECRET\n \n-In production, we expect you to define a `secret` property in your configuration. In development, this is shown as a warning for convenience. [Read more](https://next-auth.js.org/configuration/options#secret)\n+In production, we expect you to define a `secret` property in your configuration. In development, this is shown as a warning for convenience. [Read more](/configuration/options#secret)\n \n #### oauth_callback_error expected 200 OK with body but no body was returned\n "
        },
        {
          "filename": "packages/next-auth/src/core/errors.ts",
          "status": "modified",
          "additions": 5,
          "deletions": 0,
          "patch": "@@ -63,6 +63,11 @@ export class UnsupportedStrategy extends UnknownError {\n   code = \"CALLBACK_CREDENTIALS_JWT_ERROR\"\n }\n \n+export class InvalidCallbackUrl extends UnknownError {\n+  name = \"InvalidCallbackUrl\"\n+  code = \"INVALID_CALLBACK_URL_ERROR\"\n+}\n+\n type Method = (...args: any[]) => Promise<any>\n \n export function upperSnake(s: string) {"
        },
        {
          "filename": "packages/next-auth/src/core/index.ts",
          "status": "modified",
          "additions": 2,
          "deletions": 1,
          "patch": "@@ -108,7 +108,8 @@ export async function NextAuthHandler<\n           let signinUrl = `${pages.signIn}${\n             pages.signIn.includes(\"?\") ? \"&\" : \"?\"\n           }callbackUrl=${encodeURIComponent(options.callbackUrl)}`\n-          if (error) signinUrl = `${signinUrl}&error=${encodeURIComponent(error)}`\n+          if (error)\n+            signinUrl = `${signinUrl}&error=${encodeURIComponent(error)}`\n           return { redirect: signinUrl, cookies }\n         }\n "
        },
        {
          "filename": "packages/next-auth/src/core/lib/assert.ts",
          "status": "modified",
          "additions": 33,
          "deletions": 0,
          "patch": "@@ -4,7 +4,10 @@ import {\n   MissingAuthorize,\n   MissingSecret,\n   UnsupportedStrategy,\n+  InvalidCallbackUrl,\n } from \"../errors\"\n+import parseUrl from \"../../lib/parse-url\"\n+import { defaultCookies } from \"./cookie\"\n \n import type { NextAuthHandlerParams } from \"..\"\n import type { WarningCode } from \"../../lib/logger\"\n@@ -18,6 +21,14 @@ type ConfigError =\n \n let twitterWarned = false\n \n+function isValidHttpUrl(url: string) {\n+  try {\n+    return /^https?:/.test(new URL(url).protocol)\n+  } catch {\n+    return false\n+  }\n+}\n+\n /**\n  * Verify that the user configured `next-auth` correctly.\n  * Good place to mention deprecations as well.\n@@ -44,8 +55,30 @@ export function assertConfig(\n     }\n   }\n \n+  const callbackUrlParam = req.query?.callbackUrl as string | undefined\n+\n+  if (callbackUrlParam && !isValidHttpUrl(callbackUrlParam)) {\n+    return new InvalidCallbackUrl(\n+      `Invalid callback URL. Received: ${callbackUrlParam}`\n+    )\n+  }\n+\n   if (!req.host) return \"NEXTAUTH_URL\"\n \n+  const url = parseUrl(req.host)\n+\n+  const { callbackUrl: defaultCallbackUrl } = defaultCookies(\n+    options.useSecureCookies ?? url.base.startsWith(\"https://\")\n+  )\n+  const callbackUrlCookie =\n+    req.cookies?.[options.cookies?.callbackUrl?.name ?? defaultCallbackUrl.name]\n+\n+  if (callbackUrlCookie && !isValidHttpUrl(callbackUrlCookie)) {\n+    return new InvalidCallbackUrl(\n+      `Invalid callback URL. Received: ${callbackUrlCookie}`\n+    )\n+  }\n+\n   let hasCredentials, hasEmail\n   let hasTwitterOAuth2\n "
        },
        {
          "filename": "packages/next-auth/src/core/lib/cookie.ts",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -68,6 +68,7 @@ export function defaultCookies(useSecureCookies: boolean): CookiesOptions {\n     callbackUrl: {\n       name: `${cookiePrefix}next-auth.callback-url`,\n       options: {\n+        httpOnly: true,\n         sameSite: \"lax\",\n         path: \"/\",\n         secure: useSecureCookies,"
        }
      ],
      "file_patterns": {
        "security_files": 4,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 3,
        "max_directory_depth": 5
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "9d704a00206c25f96adfb1e0d4a74e7c272811f9",
            "date": "2025-01-09T23:23:30Z",
            "author_login": "giedrius-jankauskas"
          },
          {
            "sha": "e62a6347572a2769bdd7a328c435d61ec631d3fe",
            "date": "2025-01-08T23:36:43Z",
            "author_login": "Ersch"
          },
          {
            "sha": "c10f2f91647b0f194e9b87792c2c4cba61fede14",
            "date": "2025-01-07T16:43:51Z",
            "author_login": "halvaradop"
          },
          {
            "sha": "80a2c147f9dff7a67e311dffceabc38da146a7b8",
            "date": "2025-01-07T16:41:48Z",
            "author_login": "KostyaTretyak"
          },
          {
            "sha": "7f2c94f08ee3d8c37f63e18151b3c6501cb25a83",
            "date": "2025-01-07T16:38:21Z",
            "author_login": "rishi-raj-jain"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 7.5,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H",
    "cwe_id": "CWE-754",
    "description": "NextAuth.js is a complete open source authentication solution for Next.js applications. In affected versions an attacker can send a request to an app using NextAuth.js with an invalid `callbackUrl` query parameter, which internally is converted to a `URL` object. The URL instantiation would fail due to a malformed URL being passed into the constructor, causing it to throw an unhandled error which led to the **API route handler timing out and logging in to fail**. This has been remedied in versions 3.29.5 and 4.5.0. If for some reason you cannot upgrade, the workaround requires you to rely on Advanced Initialization. Please see the documentation for more.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2022-06-27T22:15:09.047",
    "last_modified": "2024-11-21T07:03:52.837",
    "fix_date": "2022-06-10T11:52:00Z"
  },
  "references": [
    {
      "url": "https://github.com/nextauthjs/next-auth/commit/25517b73153332d948114bacdff3b5908de91d85",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/nextauthjs/next-auth/commit/e498483b23273d1bfc81be68339607f88d411bd6",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/nextauthjs/next-auth/security/advisories/GHSA-g5fm-jp9v-2432",
      "source": "security-advisories@github.com",
      "tags": [
        "Mitigation",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://next-auth.js.org/configuration/initialization#advanced-initialization",
      "source": "security-advisories@github.com",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/nextauthjs/next-auth/commit/25517b73153332d948114bacdff3b5908de91d85",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/nextauthjs/next-auth/commit/e498483b23273d1bfc81be68339607f88d411bd6",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/nextauthjs/next-auth/security/advisories/GHSA-g5fm-jp9v-2432",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mitigation",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://next-auth.js.org/configuration/initialization#advanced-initialization",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Vendor Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:03:09.489816",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "next-auth",
    "owner": "nextauthjs",
    "created_at": "2018-01-27T12:28:16Z",
    "updated_at": "2025-01-14T10:48:28Z",
    "pushed_at": "2025-01-09T23:23:30Z",
    "size": 68610,
    "stars": 25574,
    "forks": 3634,
    "open_issues": 405,
    "watchers": 25574,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [],
    "languages": {
      "TypeScript": 1444478,
      "JavaScript": 42514,
      "CSS": 20770,
      "Shell": 15579,
      "Svelte": 14754,
      "PLpgSQL": 3973,
      "Pug": 3791,
      "Dockerfile": 1787,
      "HTML": 564
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "isc"
    },
    "collected_at": "2025-01-14T13:09:36.526109"
  }
}