{
  "cve_id": "CVE-2022-36073",
  "github_data": {
    "repository": "rubygems/rubygems.org",
    "fix_commit": "90c9e6aac2d91518b479c51d48275c57de492d4d",
    "related_commits": [
      "90c9e6aac2d91518b479c51d48275c57de492d4d",
      "90c9e6aac2d91518b479c51d48275c57de492d4d"
    ],
    "patch_url": "https://github.com/rubygems/rubygems.org/commit/90c9e6aac2d91518b479c51d48275c57de492d4d.patch",
    "fix_commit_details": {
      "sha": "90c9e6aac2d91518b479c51d48275c57de492d4d",
      "commit_date": "2022-09-01T03:59:52Z",
      "author": {
        "login": "segiddins",
        "type": "User",
        "stats": {
          "total_commits": 439,
          "average_weekly_commits": 0.5353658536585366,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 92
        }
      },
      "commit_message": {
        "title": "Merge pull request from GHSA-8qpf-wf2p-25vg",
        "length": 119,
        "has_description": true,
        "references_issue": false
      },
      "stats": {
        "total": 47,
        "additions": 42,
        "deletions": 5
      },
      "files": [
        {
          "filename": "app/controllers/email_confirmations_controller.rb",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -31,15 +31,15 @@ def create\n     user = find_user_for_create\n \n     if user\n-      user.generate_confirmation_token\n+      user.generate_confirmation_token(reset_unconfirmed_email: false)\n       Delayed::Job.enqueue(EmailConfirmationMailer.new(user.id)) if user.save\n     end\n     redirect_to root_path, notice: t(\".promise_resend\")\n   end\n \n   # used to resend confirmation mail for unconfirmed_email validation\n   def unconfirmed\n-    if current_user.generate_confirmation_token && current_user.save\n+    if current_user.generate_confirmation_token(reset_unconfirmed_email: false) && current_user.save\n       Delayed::Job.enqueue EmailResetMailer.new(current_user.id)\n       flash[:notice] = t(\"profiles.update.confirmation_mail_sent\")\n     else"
        },
        {
          "filename": "app/models/user.rb",
          "status": "modified",
          "additions": 8,
          "deletions": 3,
          "patch": "@@ -15,8 +15,8 @@ class User < ApplicationRecord\n     twitter_username\n   ].freeze\n \n-  before_save :generate_confirmation_token, if: :will_save_change_to_unconfirmed_email?\n-  before_create :generate_confirmation_token\n+  before_save :_generate_confirmation_token_no_reset_unconfirmed_email, if: :will_save_change_to_unconfirmed_email?\n+  before_create :_generate_confirmation_token_no_reset_unconfirmed_email\n   before_destroy :yank_gems\n \n   has_many :ownerships, -> { confirmed }, dependent: :destroy, inverse_of: :user\n@@ -171,11 +171,16 @@ def valid_confirmation_token?\n     token_expires_at > Time.zone.now\n   end\n \n-  def generate_confirmation_token\n+  def generate_confirmation_token(reset_unconfirmed_email: true)\n+    self.unconfirmed_email = nil if reset_unconfirmed_email\n     self.confirmation_token = Clearance::Token.new\n     self.token_expires_at = Time.zone.now + Gemcutter::EMAIL_TOKEN_EXPRIES_AFTER\n   end\n \n+  def _generate_confirmation_token_no_reset_unconfirmed_email\n+    generate_confirmation_token(reset_unconfirmed_email: false)\n+  end\n+\n   def unconfirmed?\n     !email_confirmed\n   end"
        },
        {
          "filename": "test/integration/password_reset_test.rb",
          "status": "modified",
          "additions": 32,
          "deletions": 0,
          "patch": "@@ -96,4 +96,36 @@ def forgot_password_with(email)\n \n     assert page.has_content?(\"Sign out\")\n   end\n+\n+  test \"resetting password with pending email change\" do\n+    visit sign_in_path\n+\n+    email = @user.email\n+    new_email = \"hijack@example.com\"\n+\n+    fill_in \"Email or Username\", with: email\n+    fill_in \"Password\", with: @user.password\n+    click_button \"Sign in\"\n+\n+    visit edit_profile_path\n+\n+    fill_in \"Username\", with: \"username\"\n+    fill_in \"Email address\", with: new_email\n+    fill_in \"Password\", with: @user.password\n+    perform_enqueued_jobs { click_button \"Update\" }\n+\n+    assert_equal new_email, @user.reload.unconfirmed_email\n+\n+    click_link \"Sign out\"\n+\n+    forgot_password_with email\n+\n+    assert_nil @user.reload.unconfirmed_email\n+\n+    token = /edit\\?token=(.+)$/.match(password_reset_link)[1]\n+    visit update_email_confirmations_path(token: token)\n+\n+    assert @user.reload.authenticated? PasswordHelpers::SECURE_TEST_PASSWORD\n+    assert_equal email, @user.email\n+  end\n end"
        }
      ],
      "file_patterns": {
        "security_files": 1,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 3,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "cecf79be46b0dbe869c319e97ad2ae58014d923a",
            "date": "2025-01-13T20:07:24Z",
            "author_login": "dependabot[bot]"
          },
          {
            "sha": "6b7f0bce877715f11ee257e296353b290a57a829",
            "date": "2025-01-13T09:15:41Z",
            "author_login": "dependabot[bot]"
          },
          {
            "sha": "11527528f5da67cc2cb2c20062c9180d54509109",
            "date": "2025-01-12T05:20:21Z",
            "author_login": "segiddins"
          },
          {
            "sha": "b093b955a2e6d2e1002a9d65585d1e03a2654512",
            "date": "2025-01-11T18:53:50Z",
            "author_login": "martinemde"
          },
          {
            "sha": "160db8eadf3519c19a385f6b6a96658619fd5480",
            "date": "2025-01-11T17:58:49Z",
            "author_login": "martinemde"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 8.3,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:L",
    "cwe_id": "CWE-287",
    "description": "RubyGems.org is the Ruby community gem host. A bug in password & email change confirmation code allowed an attacker to change their RubyGems.org account's email to an unowned email address. Having access to an account whose email has been changed could enable an attacker to save API keys for that account, and when a legitimate user attempts to create an account with their email (and has to reset password to gain access) and is granted access to other gems, the attacker would then be able to publish and yank versions of those gems. Commit number 90c9e6aac2d91518b479c51d48275c57de492d4d contains a patch for this issue.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2022-09-07T20:15:11.223",
    "last_modified": "2024-11-21T07:12:19.327",
    "fix_date": "2022-09-01T03:59:52Z"
  },
  "references": [
    {
      "url": "https://github.com/rubygems/rubygems.org/commit/90c9e6aac2d91518b479c51d48275c57de492d4d",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/rubygems/rubygems.org/security/advisories/GHSA-8qpf-wf2p-25vg",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/rubygems/rubygems.org/commit/90c9e6aac2d91518b479c51d48275c57de492d4d",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/rubygems/rubygems.org/security/advisories/GHSA-8qpf-wf2p-25vg",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:03:39.088431",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "rubygems.org",
    "owner": "rubygems",
    "created_at": "2009-01-29T22:30:46Z",
    "updated_at": "2025-01-13T20:07:30Z",
    "pushed_at": "2025-01-14T07:51:29Z",
    "size": 24489,
    "stars": 2342,
    "forks": 934,
    "open_issues": 91,
    "watchers": 2342,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "Ruby": 2182589,
      "HTML": 342202,
      "CSS": 77662,
      "JavaScript": 33997,
      "Shell": 7867,
      "Dockerfile": 4095
    },
    "commit_activity": {
      "total_commits_last_year": 1068,
      "avg_commits_per_week": 20.53846153846154,
      "days_active_last_year": 269
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-14T13:25:16.767892"
  }
}