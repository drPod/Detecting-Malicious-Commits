{
  "cve_id": "CVE-2022-39207",
  "github_data": {
    "repository": "theonedev/onedev",
    "fix_commit": "adb6e31476621f824fc3227a695232df830d83ab",
    "related_commits": [
      "adb6e31476621f824fc3227a695232df830d83ab",
      "adb6e31476621f824fc3227a695232df830d83ab"
    ],
    "patch_url": "https://github.com/theonedev/onedev/commit/adb6e31476621f824fc3227a695232df830d83ab.patch",
    "fix_commit_details": {
      "sha": "adb6e31476621f824fc3227a695232df830d83ab",
      "commit_date": "2022-05-31T03:27:47Z",
      "author": {
        "login": "robinshine",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Fix XSS attach for published artifacts",
        "length": 38,
        "has_description": false,
        "references_issue": true
      },
      "stats": {
        "total": 12,
        "additions": 3,
        "deletions": 9
      },
      "files": [
        {
          "filename": "server-core/src/main/java/io/onedev/server/web/resource/ArtifactResource.java",
          "status": "modified",
          "additions": 3,
          "deletions": 9,
          "patch": "@@ -1,6 +1,5 @@\n package io.onedev.server.web.resource;\n \n-import java.io.BufferedInputStream;\n import java.io.File;\n import java.io.FileInputStream;\n import java.io.IOException;\n@@ -16,6 +15,7 @@\n \n import org.apache.shiro.authz.UnauthorizedException;\n import org.apache.tika.io.IOUtils;\n+import org.apache.tika.mime.MimeTypes;\n import org.apache.wicket.request.mapper.parameter.PageParameters;\n import org.apache.wicket.request.resource.AbstractResource;\n \n@@ -30,7 +30,6 @@\n import io.onedev.server.model.Build;\n import io.onedev.server.model.Project;\n import io.onedev.server.security.SecurityUtils;\n-import io.onedev.server.util.ContentDetector;\n \n public class ArtifactResource extends AbstractResource {\n \n@@ -85,20 +84,15 @@ protected ResourceResponse newResourceResponse(Attributes attributes) {\n \t\t}\n \t\t\t\n \t\tResourceResponse response = new ResourceResponse();\n-\t\ttry (InputStream is = new BufferedInputStream(new FileInputStream(artifactFile))) {\n-\t\t\tresponse.setContentType(ContentDetector.detectMediaType(is, artifactPath).toString());\n-\t\t} catch (Exception e) {\n-\t\t\tthrow new RuntimeException(e);\n-\t\t}\n-\t\t\n+\t\tresponse.getHeaders().addHeader(\"X-Content-Type-Options\", \"nosniff\");\n+\t\tresponse.setContentType(MimeTypes.OCTET_STREAM);\n \t\tresponse.disableCaching();\n \t\t\n \t\ttry {\n \t\t\tresponse.setFileName(URLEncoder.encode(artifactFile.getName(), StandardCharsets.UTF_8.name()));\n \t\t} catch (UnsupportedEncodingException e) {\n \t\t\tthrow new RuntimeException(e);\n \t\t}\n-\t\t\n \t\tresponse.setContentLength(artifactFile.length());\n \t\t\n \t\tresponse.setWriteCallback(new WriteCallback() {"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 1,
        "max_directory_depth": 9
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "10e2c31d03935064a014dfb1464fa7bc146be9e0",
            "date": "2025-01-11T23:54:45Z",
            "author_login": "robinshine"
          },
          {
            "sha": "715386eb735489c08616f9e1c3dc56f58a5457c3",
            "date": "2025-01-11T01:12:03Z",
            "author_login": "robinshine"
          },
          {
            "sha": "be37d8fc32b9c3c4d7b11d3af8051be8911ee390",
            "date": "2025-01-09T14:35:55Z",
            "author_login": "robinshine"
          },
          {
            "sha": "f61d99124dd571668a8836354672903717ced5ca",
            "date": "2025-01-06T03:25:54Z",
            "author_login": "sususweet"
          },
          {
            "sha": "4c37f0dd4e0336e64f22fa04929d67188ee70bd4",
            "date": "2025-01-06T02:48:57Z",
            "author_login": "sususweet"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 5.4,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N",
    "cwe_id": "CWE-79",
    "description": "Onedev is an open source, self-hosted Git Server with CI/CD and Kanban. During CI/CD builds, it is possible to save build artifacts for later retrieval. They can be accessed through OneDev's web UI after the successful run of a build. These artifact files are served by the webserver in the same context as the UI without any further restrictions. This leads to Cross-Site Scripting (XSS) when a user creates a build artifact that contains HTML. When accessing the artifact, the content is rendered by the browser, including any JavaScript that it contains. Since all cookies (except for the rememberMe one) do not set the HttpOnly flag, an attacker could steal the session of a victim and use it to impersonate them. To exploit this issue, attackers need to be able to modify the content of artifacts, which usually means they need to be able to modify a project's build spec. The exploitation requires the victim to click on an attacker's link. It can be used to elevate privileges by targeting admins of a OneDev instance. In the worst case, this can lead to arbitrary code execution on the server, because admins can create Server Shell Executors and use them to run any command on the server. This issue has been patched in version 7.3.0. Users are advised to upgrade. There are no known workarounds for this issue.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2022-09-13T19:15:13.223",
    "last_modified": "2024-11-21T07:17:47.227",
    "fix_date": "2022-05-31T03:27:47Z"
  },
  "references": [
    {
      "url": "https://blog.sonarsource.com/onedev-remote-code-execution/",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/theonedev/onedev/commit/adb6e31476621f824fc3227a695232df830d83ab",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/theonedev/onedev/security/advisories/GHSA-27fw-gv88-qrpg",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://blog.sonarsource.com/onedev-remote-code-execution/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/theonedev/onedev/commit/adb6e31476621f824fc3227a695232df830d83ab",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/theonedev/onedev/security/advisories/GHSA-27fw-gv88-qrpg",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:03:39.109857",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "onedev",
    "owner": "theonedev",
    "created_at": "2018-11-06T02:57:01Z",
    "updated_at": "2025-01-14T10:30:38Z",
    "pushed_at": "2025-01-11T23:54:59Z",
    "size": 226316,
    "stars": 13579,
    "forks": 872,
    "open_issues": 0,
    "watchers": 13579,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [],
    "languages": {
      "Java": 11067283,
      "JavaScript": 730260,
      "HTML": 381307,
      "CSS": 180682,
      "Shell": 116784,
      "ANTLR": 46591,
      "Smarty": 17174,
      "Python": 5761,
      "Mustache": 3983,
      "Dockerfile": 125
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-14T13:48:17.966345"
  }
}