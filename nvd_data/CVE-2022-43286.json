{
  "cve_id": "CVE-2022-43286",
  "github_data": {
    "repository": "nginx/njs",
    "fix_commit": "2ad0ea24a58d570634e09c2e58c3b314505eaa6a",
    "related_commits": [
      "2ad0ea24a58d570634e09c2e58c3b314505eaa6a",
      "2ad0ea24a58d570634e09c2e58c3b314505eaa6a"
    ],
    "patch_url": "https://github.com/nginx/njs/commit/2ad0ea24a58d570634e09c2e58c3b314505eaa6a.patch",
    "fix_commit_details": {
      "sha": "2ad0ea24a58d570634e09c2e58c3b314505eaa6a",
      "commit_date": "2022-05-04T23:44:48Z",
      "author": {
        "login": "xeioex",
        "type": "User",
        "stats": {
          "total_commits": 1592,
          "average_weekly_commits": 3.268993839835729,
          "total_additions": 278945,
          "total_deletions": 181190,
          "weeks_active": 310
        }
      },
      "commit_message": {
        "title": "Fixed JSON.parse() when reviver function is provided.",
        "length": 88,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 292,
        "additions": 115,
        "deletions": 177
      },
      "files": [
        {
          "filename": "src/njs_json.c",
          "status": "modified",
          "additions": 80,
          "deletions": 177,
          "patch": "@@ -28,27 +28,17 @@ typedef struct {\n     int64_t                    length;\n     njs_array_t                *keys;\n     njs_value_t                *key;\n-    njs_object_prop_t          *prop;\n+    njs_value_t                prop;\n } njs_json_state_t;\n \n \n-typedef struct {\n-    njs_value_t                retval;\n-\n-    njs_uint_t                 depth;\n-#define NJS_JSON_MAX_DEPTH     32\n-    njs_json_state_t           states[NJS_JSON_MAX_DEPTH];\n-\n-    njs_function_t             *function;\n-} njs_json_parse_t;\n-\n-\n typedef struct {\n     njs_value_t                retval;\n \n     njs_vm_t                   *vm;\n \n     njs_uint_t                 depth;\n+#define NJS_JSON_MAX_DEPTH     32\n     njs_json_state_t           states[NJS_JSON_MAX_DEPTH];\n \n     njs_value_t                replacer;\n@@ -72,10 +62,9 @@ njs_inline uint32_t njs_json_unicode(const u_char *p);\n static const u_char *njs_json_skip_space(const u_char *start,\n     const u_char *end);\n \n-static njs_int_t njs_json_parse_iterator(njs_vm_t *vm, njs_json_parse_t *parse,\n-    njs_value_t *value);\n-static njs_int_t njs_json_parse_iterator_call(njs_vm_t *vm,\n-    njs_json_parse_t *parse, njs_json_state_t *state);\n+static njs_int_t njs_json_internalize_property(njs_vm_t *vm,\n+    njs_function_t *reviver, njs_value_t *holder, njs_value_t *name,\n+    njs_int_t depth, njs_value_t *retval);\n static void njs_json_parse_exception(njs_json_parse_ctx_t *ctx,\n     const char *msg, const u_char *pos);\n \n@@ -108,15 +97,13 @@ njs_json_parse(njs_vm_t *vm, njs_value_t *args, njs_uint_t nargs,\n     njs_index_t unused)\n {\n     njs_int_t             ret;\n-    njs_value_t           *text, value, lvalue;\n+    njs_value_t           *text, value, lvalue, wrapper;\n+    njs_object_t          *obj;\n     const u_char          *p, *end;\n-    njs_json_parse_t      *parse, json_parse;\n     const njs_value_t     *reviver;\n     njs_string_prop_t     string;\n     njs_json_parse_ctx_t  ctx;\n \n-    parse = &json_parse;\n-\n     text = njs_lvalue_arg(&lvalue, args, nargs, 1);\n \n     if (njs_slow_path(!njs_is_string(text))) {\n@@ -156,11 +143,16 @@ njs_json_parse(njs_vm_t *vm, njs_value_t *args, njs_uint_t nargs,\n \n     reviver = njs_arg(args, nargs, 2);\n \n-    if (njs_slow_path(njs_is_function(reviver) && njs_is_object(&value))) {\n-        parse->function = njs_function(reviver);\n-        parse->depth = 0;\n+    if (njs_slow_path(njs_is_function(reviver))) {\n+        obj = njs_json_wrap_value(vm, &wrapper, &value);\n+        if (njs_slow_path(obj == NULL)) {\n+            return NJS_ERROR;\n+        }\n \n-        return njs_json_parse_iterator(vm, parse, &value);\n+        return njs_json_internalize_property(vm, njs_function(reviver),\n+                                             &wrapper,\n+                                             njs_value_arg(&njs_string_empty),\n+                                             0, &vm->retval);\n     }\n \n     vm->retval = value;\n@@ -851,195 +843,106 @@ njs_json_skip_space(const u_char *start, const u_char *end)\n }\n \n \n-static njs_json_state_t *\n-njs_json_push_parse_state(njs_vm_t *vm, njs_json_parse_t *parse,\n-    njs_value_t *value)\n-{\n-    njs_json_state_t  *state;\n-\n-    if (njs_slow_path(parse->depth >= NJS_JSON_MAX_DEPTH)) {\n-        njs_type_error(vm, \"Nested too deep or a cyclic structure\");\n-        return NULL;\n-    }\n-\n-    state = &parse->states[parse->depth++];\n-    state->value = *value;\n-    state->index = 0;\n-    state->prop = NULL;\n-    state->keys = njs_value_own_enumerate(vm, value, NJS_ENUM_KEYS,\n-                                          NJS_ENUM_STRING, 0);\n-    if (state->keys == NULL) {\n-        return NULL;\n-    }\n-\n-    return state;\n-}\n-\n-\n-njs_inline njs_json_state_t *\n-njs_json_pop_parse_state(njs_vm_t *vm, njs_json_parse_t *parse)\n-{\n-    njs_json_state_t  *state;\n-\n-    state = &parse->states[parse->depth - 1];\n-    njs_array_destroy(vm, state->keys);\n-    state->keys = NULL;\n-\n-    if (parse->depth > 1) {\n-        parse->depth--;\n-        return &parse->states[parse->depth - 1];\n-    }\n-\n-    return NULL;\n-}\n-\n-\n static njs_int_t\n-njs_json_parse_iterator(njs_vm_t *vm, njs_json_parse_t *parse,\n-    njs_value_t *object)\n+njs_json_internalize_property(njs_vm_t *vm, njs_function_t *reviver,\n+    njs_value_t *holder, njs_value_t *name, njs_int_t depth,\n+    njs_value_t *retval)\n {\n-    njs_int_t             ret;\n-    njs_value_t           *key, wrapper;\n-    njs_object_t          *obj;\n-    njs_json_state_t      *state;\n-    njs_object_prop_t     *prop;\n-    njs_property_query_t  pq;\n+    int64_t       k, length;\n+    njs_int_t     ret;\n+    njs_value_t   val, new_elem, index;\n+    njs_value_t   arguments[3];\n+    njs_array_t   *keys;\n \n-    obj = njs_json_wrap_value(vm, &wrapper, object);\n-    if (njs_slow_path(obj == NULL)) {\n+    if (njs_slow_path(depth++ >= NJS_JSON_MAX_DEPTH)) {\n+        njs_type_error(vm, \"Nested too deep or a cyclic structure\");\n         return NJS_ERROR;\n     }\n \n-    state = njs_json_push_parse_state(vm, parse, &wrapper);\n-    if (njs_slow_path(state == NULL)) {\n+    ret = njs_value_property(vm, holder, name, &val);\n+    if (njs_slow_path(ret == NJS_ERROR)) {\n         return NJS_ERROR;\n     }\n \n-    for ( ;; ) {\n-        if (state->index < state->keys->length) {\n-            njs_property_query_init(&pq, NJS_PROPERTY_QUERY_SET, 0);\n-\n-            key = &state->keys->start[state->index];\n-\n-            ret = njs_property_query(vm, &pq, &state->value, key);\n-            if (njs_slow_path(ret != NJS_OK)) {\n-                if (ret == NJS_DECLINED) {\n-                    state->index++;\n-                    continue;\n-                }\n+    keys = NULL;\n \n+    if (njs_is_object(&val)) {\n+        if (!njs_is_array(&val)) {\n+            keys = njs_array_keys(vm, &val, 0);\n+            if (njs_slow_path(keys == NULL)) {\n                 return NJS_ERROR;\n             }\n \n-            prop = pq.lhq.value;\n-\n-            if (prop->type == NJS_WHITEOUT) {\n-                state->index++;\n-                continue;\n-            }\n-\n-            state->prop = prop;\n+            for (k = 0; k < keys->length; k++) {\n+                ret = njs_json_internalize_property(vm, reviver, &val,\n+                                                    &keys->start[k], depth,\n+                                                    &new_elem);\n \n-            if (prop->type == NJS_PROPERTY && njs_is_object(&prop->value)) {\n-                state = njs_json_push_parse_state(vm, parse, &prop->value);\n-                if (state == NULL) {\n-                    return NJS_ERROR;\n+                if (njs_slow_path(ret != NJS_OK)) {\n+                    goto done;\n                 }\n \n-                continue;\n-            }\n+                if (njs_is_undefined(&new_elem)) {\n+                    ret = njs_value_property_delete(vm, &val, &keys->start[k],\n+                                                    NULL, 0);\n \n-            if (prop->type == NJS_PROPERTY_REF\n-                && njs_is_object(prop->value.data.u.value))\n-            {\n-                state = njs_json_push_parse_state(vm, parse,\n-                                                  prop->value.data.u.value);\n-                if (state == NULL) {\n-                    return NJS_ERROR;\n+                } else {\n+                    ret = njs_value_property_set(vm, &val, &keys->start[k],\n+                                                 &new_elem);\n                 }\n \n-                continue;\n+                if (njs_slow_path(ret == NJS_ERROR)) {\n+                    goto done;\n+                }\n             }\n \n         } else {\n-            state = njs_json_pop_parse_state(vm, parse);\n-            if (state == NULL) {\n-                vm->retval = parse->retval;\n-                return NJS_OK;\n-            }\n-        }\n-\n-        ret = njs_json_parse_iterator_call(vm, parse, state);\n-        if (njs_slow_path(ret != NJS_OK)) {\n-            return ret;\n-        }\n-    }\n-}\n-\n \n-static njs_int_t\n-njs_json_parse_iterator_call(njs_vm_t *vm, njs_json_parse_t *parse,\n-    njs_json_state_t *state)\n-{\n-    njs_int_t          ret;\n-    njs_value_t        arguments[3], *value;\n-    njs_object_prop_t  *prop;\n-\n-    prop = state->prop;\n-\n-    arguments[0] = state->value;\n-    arguments[1] = state->keys->start[state->index++];\n-\n-    switch (prop->type) {\n-    case NJS_PROPERTY:\n-        arguments[2] = prop->value;\n+            ret = njs_object_length(vm, &val, &length);\n+            if (njs_slow_path(ret == NJS_ERROR)) {\n+                return NJS_ERROR;\n+            }\n \n-        ret = njs_function_apply(vm, parse->function, arguments, 3,\n-                                 &parse->retval);\n-        if (njs_slow_path(ret != NJS_OK)) {\n-            return ret;\n-        }\n+            for (k = 0; k < length; k++) {\n+                ret = njs_int64_to_string(vm, &index, k);\n+                if (njs_slow_path(ret != NJS_OK)) {\n+                    return NJS_ERROR;\n+                }\n \n-        if (njs_is_undefined(&parse->retval)) {\n-            prop->type = NJS_WHITEOUT;\n+                ret = njs_json_internalize_property(vm, reviver, &val, &index,\n+                                                    depth, &new_elem);\n \n-        } else {\n-            prop->value = parse->retval;\n-        }\n+                if (njs_slow_path(ret != NJS_OK)) {\n+                    return NJS_ERROR;\n+                }\n \n-        break;\n+                if (njs_is_undefined(&new_elem)) {\n+                    ret = njs_value_property_delete(vm, &val, &index, NULL, 0);\n \n-    case NJS_PROPERTY_REF:\n-        value = prop->value.data.u.value;\n-        arguments[2] = *value;\n+                } else {\n+                    ret = njs_value_property_set(vm, &val, &index, &new_elem);\n+                }\n \n-        ret = njs_function_apply(vm, parse->function, arguments, 3,\n-                                 &parse->retval);\n-        if (njs_slow_path(ret != NJS_OK)) {\n-            return ret;\n+                if (njs_slow_path(ret == NJS_ERROR)) {\n+                    return NJS_ERROR;\n+                }\n+            }\n         }\n+    }\n \n-        if (njs_is_undefined(&parse->retval)) {\n-            ret = njs_value_property_i64_delete(vm, &state->value,\n-                                                state->index - 1, NULL);\n-\n-        } else {\n-            ret = njs_value_property_i64_set(vm, &state->value,\n-                                             state->index - 1, &parse->retval);\n-        }\n+    njs_value_assign(&arguments[0], holder);\n+    njs_value_assign(&arguments[1], name);\n+    njs_value_assign(&arguments[2], &val);\n \n-        if (njs_slow_path(ret == NJS_ERROR)) {\n-            return NJS_ERROR;\n-        }\n+    ret = njs_function_apply(vm, reviver, arguments, 3, retval);\n \n-        break;\n+done:\n \n-    default:\n-        njs_internal_error(vm, \"njs_json_parse_iterator_call() unexpected \"\n-                         \"property type:%s\", njs_prop_type_string(prop->type));\n+    if (keys != NULL) {\n+        njs_array_destroy(vm, keys);\n     }\n \n-    return NJS_OK;\n+    return ret;\n }\n \n "
        },
        {
          "filename": "src/test/njs_benchmark.c",
          "status": "modified",
          "additions": 10,
          "deletions": 0,
          "patch": "@@ -208,6 +208,16 @@ static njs_benchmark_test_t  njs_test[] =\n       njs_str(\"123\"),\n       1000000 },\n \n+    { \"JSON.parse large\",\n+      njs_str(\"JSON.parse(JSON.stringify([Array(2**16)]))[0].length\"),\n+      njs_str(\"65536\"),\n+      10 },\n+\n+    { \"JSON.parse reviver large\",\n+      njs_str(\"JSON.parse(JSON.stringify([Array(2**16)]), v=>v)\"),\n+      njs_str(\"\"),\n+      10 },\n+\n     { \"for loop 100M\",\n       njs_str(\"var i; for (i = 0; i < 100000000; i++); i\"),\n       njs_str(\"100000000\"),"
        },
        {
          "filename": "src/test/njs_unit_test.c",
          "status": "modified",
          "additions": 25,
          "deletions": 0,
          "patch": "@@ -17203,6 +17203,31 @@ static njs_unit_test_t  njs_test[] =\n               \"JSON.parse('[1]', func);\"),\n       njs_str(\"\") },\n \n+    { njs_str(\"JSON.parse(JSON.stringify([Array(2**16)]), v => v)\"),\n+      njs_str(\"\") },\n+\n+    { njs_str(\"var order = []; function reviver(k, v) { order.push(k); };\"\n+              \"JSON.parse('{\\\"p1\\\":0,\\\"p2\\\":0,\\\"p1\\\":0,\\\"2\\\":0,\\\"1\\\":0}', reviver);\"\n+              \"order\"),\n+      njs_str(\"1,2,p1,p2,\") },\n+\n+    { njs_str(\"function reviver(k, v) {\"\n+              \"    if (k == '0') Object.defineProperty(this, '1', {configurable: false});\"\n+              \"    if (k == '1') return;\"\n+              \"    return v;\"\n+              \" };\"\n+              \"JSON.parse('[1, 2]', reviver)\"),\n+      njs_str(\"1,2\") },\n+\n+    { njs_str(\"JSON.parse('0', (k, v) => {throw 'Oops'})\"),\n+      njs_str(\"Oops\") },\n+\n+    { njs_str(\"JSON.parse('{\\\"a\\\":1}', (k, v) => {if (k == 'a') {throw 'Oops'}; return v;})\"),\n+      njs_str(\"Oops\") },\n+\n+    { njs_str(\"JSON.parse('[2,3,43]', (k, v) => {if (v == 43) {throw 'Oops'}; return v;})\"),\n+      njs_str(\"Oops\") },\n+\n     /* JSON.stringify() */\n \n     { njs_str(\"JSON.stringify()\"),"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 2,
        "unique_directories": 2,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "b87ad67adb2c557bd96e52a3221748a7ba028858",
            "date": "2025-01-13T22:56:10Z",
            "author_login": "xeioex"
          },
          {
            "sha": "17676e5c9a9f5bdd63509632c31a9019686b171e",
            "date": "2025-01-13T22:58:28Z",
            "author_login": "xeioex"
          },
          {
            "sha": "855aa4c9fac01bd9fbdb1602b523edc00117ff09",
            "date": "2025-01-04T06:25:15Z",
            "author_login": "xeioex"
          },
          {
            "sha": "4fb1c0ca6c950dc0460eaeec1ba3e96a53070878",
            "date": "2025-01-06T17:09:43Z",
            "author_login": "xeioex"
          },
          {
            "sha": "1f8f9992d03e2865f354da3415f8a49931cf2fe8",
            "date": "2024-12-05T01:31:23Z",
            "author_login": "xeioex"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 9.8,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
    "cwe_id": "CWE-416",
    "description": "Nginx NJS v0.7.2 was discovered to contain a heap-use-after-free bug caused by illegal memory copy in the function njs_json_parse_iterator_call at njs_json.c.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2022-10-28T21:15:10.213",
    "last_modified": "2024-11-21T07:26:12.583",
    "fix_date": "2022-05-04T23:44:48Z"
  },
  "references": [
    {
      "url": "https://github.com/nginx/njs/commit/2ad0ea24a58d570634e09c2e58c3b314505eaa6a",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/nginx/njs/issues/480",
      "source": "cve@mitre.org",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/nginx/njs/commit/2ad0ea24a58d570634e09c2e58c3b314505eaa6a",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/nginx/njs/issues/480",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:04:00.969645",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "njs",
    "owner": "nginx",
    "created_at": "2015-09-24T02:03:58Z",
    "updated_at": "2025-01-14T02:29:02Z",
    "pushed_at": "2025-01-13T23:32:16Z",
    "size": 21568,
    "stars": 1317,
    "forks": 165,
    "open_issues": 62,
    "watchers": 1317,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "master"
    ],
    "languages": {
      "C": 3674164,
      "Perl": 287098,
      "JavaScript": 248345,
      "TypeScript": 9351,
      "Shell": 5785,
      "Python": 5759,
      "Standard ML": 1129,
      "Makefile": 602
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "bsd-2-clause"
    },
    "collected_at": "2025-01-14T13:42:29.484634"
  }
}