{
  "cve_id": "CVE-2022-4397",
  "github_data": {
    "repository": "morontt/zend-blog-number-2",
    "fix_commit": "36b2d4abe20a6245e4f8df7a4b14e130b24d429d",
    "related_commits": [
      "36b2d4abe20a6245e4f8df7a4b14e130b24d429d",
      "36b2d4abe20a6245e4f8df7a4b14e130b24d429d"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "36b2d4abe20a6245e4f8df7a4b14e130b24d429d",
      "commit_date": "2022-06-23T17:26:53Z",
      "author": {
        "login": "morontt",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Add CSRF-token for comments",
        "length": 27,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 36,
        "additions": 35,
        "deletions": 1
      },
      "files": [
        {
          "filename": "application/controllers/IndexController.php",
          "status": "modified",
          "additions": 30,
          "deletions": 1,
          "patch": "@@ -154,6 +154,7 @@ public function topicAction()\n \n         $form = new Application_Form_Comment();\n         $form->topicId->setValue($post->id);\n+        $form->getElement('csrfToken')->setValue($this->generateCommentToken());\n \n         $this->view->form = $form;\n \n@@ -234,7 +235,10 @@ public function ajaxaddcommentAction()\n             if ($form->isValid($this->getRequest()->getPost())) {\n                 $formData = $form->getValues();\n \n-                $this->saveComment($topicId, $url, $formData);\n+                if ($this->validCommentToken($formData['csrfToken'])) {\n+                    $this->saveComment($topicId, $url, $formData);\n+                }\n+\n                 $result['valid'] = true;\n             } else {\n                 $formView = new Zend_View;\n@@ -413,4 +417,29 @@ protected function isCDN()\n             && (stripos($_SERVER['HTTP_VIA'], 'BunnyCDN') !== false\n                 || strpos($_SERVER['HTTP_VIA'], 'cdn77') !== false);\n     }\n+\n+    private function generateCommentToken($time = null): string\n+    {\n+        $time = $time ?? time();\n+        $userAgent = $_SERVER['HTTP_USER_AGENT'] ?? '';\n+\n+        return base64_encode($time . ':' . hash('md5', 'MD5_' . $userAgent . $time, true));\n+    }\n+\n+    private function validCommentToken($token): bool\n+    {\n+        $raw = base64_decode($token, true);\n+        if ($raw === false) {\n+            return false;\n+        }\n+\n+        $position = strpos($raw, ':');\n+        if ($position === false) {\n+            return false;\n+        }\n+\n+        $time = substr($raw, 0, $position);\n+\n+        return hash_equals($this->generateCommentToken($time), $token);\n+    }\n }"
        },
        {
          "filename": "application/forms/Comment.php",
          "status": "modified",
          "additions": 4,
          "deletions": 0,
          "patch": "@@ -85,6 +85,10 @@ public function init()\n             $this->checkCookie();\n         }\n \n+        $csrfToken = new Zend_Form_Element_Hidden('csrfToken');\n+        $csrfToken->addValidator('NotEmpty');\n+        $this->addElement($csrfToken);\n+\n         $this->setElementDecorators($this->elementDecorators);\n     }\n "
        },
        {
          "filename": "application/views/scripts/index/formcomment.phtml",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -17,6 +17,7 @@\n         <?php echo $this->form->topicId; ?>\n         <?php echo $this->form->parentId; ?>\n         <?php echo $this->form->cookie; ?>\n+        <?php echo $this->form->csrfToken; ?>\n     </div>\n     <div class=\"ym-fbox-button\">\n         <button type=\"submit\" class=\"ym-button ym-add\" id=\"submit\" name=\"submit\">\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u043a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0439</button>"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 3,
        "max_directory_depth": 4
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "3a44be7c075654a9a8e0817ca25c3c137949a4b7",
            "date": "2023-06-02T13:08:20Z",
            "author_login": "morontt"
          },
          {
            "sha": "b7f2e9b44d37a5dcf0f0cc52de758ceb393bdd03",
            "date": "2023-05-28T07:21:58Z",
            "author_login": "morontt"
          },
          {
            "sha": "f78ac6fdd6d7021e3bcb4fd4433a18de3f49b0a2",
            "date": "2023-05-24T06:21:58Z",
            "author_login": "morontt"
          },
          {
            "sha": "6704fafcd63efa9ba2568c22dc8bf041c47c1119",
            "date": "2023-05-22T07:25:40Z",
            "author_login": "morontt"
          },
          {
            "sha": "a78926abbafc40e97735713d92eade300ba23460",
            "date": "2023-05-22T07:01:54Z",
            "author_login": "morontt"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 4.3,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:N/I:L/A:N",
    "cwe_id": "CWE-863",
    "description": "A vulnerability was found in morontt zend-blog-number-2. It has been classified as problematic. Affected is an unknown function of the file application/forms/Comment.php of the component Comment Handler. The manipulation leads to cross-site request forgery. It is possible to launch the attack remotely. The name of the patch is 36b2d4abe20a6245e4f8df7a4b14e130b24d429d. It is recommended to apply a patch to fix this issue. VDB-215250 is the identifier assigned to this vulnerability.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2022-12-10T19:15:10.223",
    "last_modified": "2024-11-21T07:35:11.703",
    "fix_date": "2022-06-23T17:26:53Z"
  },
  "references": [
    {
      "url": "https://github.com/morontt/zend-blog-number-2/commit/36b2d4abe20a6245e4f8df7a4b14e130b24d429d",
      "source": "cna@vuldb.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://vuldb.com/?id.215250",
      "source": "cna@vuldb.com",
      "tags": [
        "Permissions Required",
        "Third Party Advisory",
        "VDB Entry"
      ]
    },
    {
      "url": "https://github.com/morontt/zend-blog-number-2/commit/36b2d4abe20a6245e4f8df7a4b14e130b24d429d",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://vuldb.com/?id.215250",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Permissions Required",
        "Third Party Advisory",
        "VDB Entry"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:04:21.220564",
    "processing_status": "enhanced"
  }
}