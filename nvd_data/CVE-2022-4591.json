{
  "cve_id": "CVE-2022-4591",
  "github_data": {
    "repository": "mschaef/toto",
    "fix_commit": "1f27f37c1a06f54a76971f70eaa6139dc139bdf9",
    "related_commits": [
      "1f27f37c1a06f54a76971f70eaa6139dc139bdf9",
      "1f27f37c1a06f54a76971f70eaa6139dc139bdf9"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "1f27f37c1a06f54a76971f70eaa6139dc139bdf9",
      "commit_date": "2022-10-25T10:10:22Z",
      "author": {
        "login": "mschaef",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Ensure e-mail parameters are escaped to avoid XSS attacks.",
        "length": 58,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 53,
        "additions": 32,
        "deletions": 21
      },
      "files": [
        {
          "filename": "src/toto/core/mail.clj",
          "status": "modified",
          "additions": 21,
          "deletions": 13,
          "patch": "@@ -19,29 +19,37 @@\n ;;\n ;; You must not remove this notice, or any other, from this software.\n \n-\n (ns toto.core.mail\n-  (:use hiccup.core)\n+  (:use toto.core.util)\n   (:require [clojure.tools.logging :as log]\n-            [postal.core :as postal]))\n+            [postal.core :as postal]\n+            [hiccup.core :as hiccup]\n+            [hiccup.util :as hiccup-util]))\n+\n+(defn- escape-email-params [ params ]\n+  (map-values #(if (string? %)\n+                 (hiccup-util/escape-html %)\n+                 \"\")\n+              params))\n \n (defn send-email [config message-info]\n   (let [smtp (:smtp config)\n-        {to :to subject :subject content :content params :params} message-info\n-        html-content (html [:html (if (fn? content)\n-                                    (content (merge config (or params {})))\n-                                    content)])]\n+        {:keys [ to subject content params ]} message-info\n+        html-content (hiccup/html\n+                      [:html\n+                       (content (escape-email-params\n+                                 (merge {:base-url (:base-url config)}\n+                                        (or params {}))))])]\n+\n     (log/info \"Sending mail to \" to \" with subject: \" subject)\n     (cond\n       (not (:enabled smtp))\n-      (do\n-        (log/warn \"E-mail disabled. Message not sent. Message text: \")\n-        (log/warn html-content))\n+      (log/warn \"E-mail disabled. Message not sent. Message text: \"\n+                html-content)\n \n       (or (nil? to) (= (count to) 0))\n-      (do\n-        (log/warn \"No destination e-mail address. Message not send. Message text: \")\n-        (log/warn html-content))\n+      (log/warn \"No destination e-mail address. Message not send. Message text: \"\n+                html-content)\n \n       :else\n       (postal/send-message {:host (:host smtp)"
        },
        {
          "filename": "src/toto/core/util.clj",
          "status": "modified",
          "additions": 4,
          "deletions": 0,
          "patch": "@@ -155,3 +155,7 @@\n \n (defmacro with-thread-name [ thread-name & body ]\n   `(call-with-thread-name (fn [] ~@body) ~thread-name))\n+\n+(defn map-values [f m]\n+  (->> (map (fn [[k v]] [k (f v)]) m)\n+       (into {})))"
        },
        {
          "filename": "src/toto/site/user.clj",
          "status": "modified",
          "additions": 3,
          "deletions": 3,
          "patch": "@@ -178,7 +178,7 @@\n    [:h1\n     \"Verification E-mail\"]\n    [:p\n-    \"Thank you for registering with \" [:a {:href (:base-url (:config params))} \"Toto\"]\n+    \"Thank you for registering with \" [:a {:href (:base-url params)} \"Toto\"]\n     \", the family to-do list manager. You can verify your e-mail address by clicking\"\n     [:a {:href (:verify-link-url params)} \" here\"] \".\"]\n    [:p\n@@ -200,7 +200,7 @@\n     \"Unlock Password\"]\n    [:p\n     \"Click \" [:a {:href (:verify-link-url params)} \"here\"] \" to unlock your \"\n-    \"account at \" [:a {:href (:base-url (:config params))} \"Toto\"] \", the family \"\n+    \"account at \" [:a {:href (:base-url params)} \"Toto\"] \", the family \"\n     \"to-do list manager.\"]])\n \n (defn- send-unlock-link [ config user-id ]\n@@ -218,7 +218,7 @@\n     \"Reset Password\"]\n    [:p\n     \"Click \" [:a {:href (:verify-link-url params)} \"here\"]\n-    \" to reset your password at \" [:a {:href (:base-url (:config params))} \"Toto\"]\n+    \" to reset your password at \" [:a {:href (:base-url params)} \"Toto\"]\n     \", the family to-do list manager.\"]])\n \n (defn- send-reset-link [ config user-id ]"
        },
        {
          "filename": "src/toto/view/auth.clj",
          "status": "modified",
          "additions": 4,
          "deletions": 5,
          "patch": "@@ -102,15 +102,14 @@\n (defn current-roles []\n   (:roles (friend/current-authentication)))\n \n-\n-(defn password-change-message [ config ]\n-  (let [from-mail (get-in config [:smtp :from])]\n+(defn password-change-message [ params ]\n+  (let [ { :keys [ from-mail ]} params ]\n     [:body\n      [:h1\n       \"Password Changed\"]\n      [:p\n       \"This mail confirms that you have changed the password for your \"\n-      \"account at \" [:a {:href (:base-url config)} \"Toto\"]\n+      \"account at \" [:a {:href (:base-url params)} \"Toto\"]\n       \", the family to-do list manager.\"]\n      [:p\n       \"If this isn't something you've requested, please contact us\"\n@@ -121,7 +120,7 @@\n                    {:to [ username ]\n                     :subject \"Todo - Password Changed\"\n                     :content password-change-message\n-                    :params config}))\n+                    :params { :from-mail (get-in config [:smtp :from]) }}))\n \n (defn set-user-password [ config username password ]\n   (log/info \"Changing password for user:\" username)"
        }
      ],
      "file_patterns": {
        "security_files": 1,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 3,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "fa8a1f8133fa876cc72c1596f3f8f8112b8432d2",
            "date": "2023-04-05T01:09:58Z",
            "author_login": "mschaef"
          },
          {
            "sha": "2e2dbce1c676baff56d986d7664ae382bbafb863",
            "date": "2023-04-03T11:12:59Z",
            "author_login": "mschaef"
          },
          {
            "sha": "9531c162f8d944663f9cc39c5cffdb6e849fdc6a",
            "date": "2023-04-03T11:11:35Z",
            "author_login": "mschaef"
          },
          {
            "sha": "3657d01ca02db09e8a4184433a2d14d9e27dbf1d",
            "date": "2023-03-12T01:20:42Z",
            "author_login": "mschaef"
          },
          {
            "sha": "125f8d2e6fff37ad5d891cb3bc5747e89854f9d0",
            "date": "2023-03-12T01:20:33Z",
            "author_login": "mschaef"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 3.5,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:U/C:N/I:L/A:N",
    "cwe_id": "CWE-707",
    "description": "A vulnerability was found in mschaef toto up to 1.4.20. It has been declared as problematic. This vulnerability affects unknown code of the component Email Parameter Handler. The manipulation leads to cross site scripting. The attack can be initiated remotely. Upgrading to version 1.4.21 is able to address this issue. The name of the patch is 1f27f37c1a06f54a76971f70eaa6139dc139bdf9. It is recommended to upgrade the affected component. VDB-216178 is the identifier assigned to this vulnerability.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2022-12-17T19:15:09.093",
    "last_modified": "2024-11-21T07:35:33.323",
    "fix_date": "2022-10-25T10:10:22Z"
  },
  "references": [
    {
      "url": "https://github.com/mschaef/toto/commit/1f27f37c1a06f54a76971f70eaa6139dc139bdf9",
      "source": "cna@vuldb.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/mschaef/toto/releases/tag/1.4.21",
      "source": "cna@vuldb.com",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://vuldb.com/?id.216178",
      "source": "cna@vuldb.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/mschaef/toto/commit/1f27f37c1a06f54a76971f70eaa6139dc139bdf9",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/mschaef/toto/releases/tag/1.4.21",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://vuldb.com/?id.216178",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:04:23.176987",
    "processing_status": "enhanced"
  }
}