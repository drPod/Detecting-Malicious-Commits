{
  "cve_id": "CVE-2022-4607",
  "github_data": {
    "repository": "3dcitydb/web-feature-service",
    "fix_commit": "246f4e2a97ad81491c00a7ed72ce5e7c7f75050a",
    "related_commits": [
      "246f4e2a97ad81491c00a7ed72ce5e7c7f75050a",
      "246f4e2a97ad81491c00a7ed72ce5e7c7f75050a"
    ],
    "patch_url": "https://github.com/3dcitydb/web-feature-service/commit/246f4e2a97ad81491c00a7ed72ce5e7c7f75050a.patch",
    "fix_commit_details": {
      "sha": "246f4e2a97ad81491c00a7ed72ce5e7c7f75050a",
      "commit_date": "2022-06-21T05:08:09Z",
      "author": {
        "login": "clausnagel",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Merge pull request #12 from 3dcitydb/hotfix-prevent-xxe-vulnerabilities",
        "length": 100,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 52,
        "additions": 37,
        "deletions": 15
      },
      "files": [
        {
          "filename": "CHANGES.md",
          "status": "modified",
          "additions": 5,
          "deletions": 0,
          "patch": "@@ -1,6 +1,11 @@\n Change Log\n ==========\n \n+### 5.2.1 - tba\n+\n+#### Fixes\n+*  Fixed XXE vulnerabilities when parsing XML files. [#12](https://github.com/3dcitydb/web-feature-service/pull/12/files)\n+\n ### 5.2.0 - 2022-05-23\n \n This release is based on the Importer/Exporter version 5.2.0 libraries, and thus incorporates all bug fixes and updates"
        },
        {
          "filename": "build.gradle",
          "status": "modified",
          "additions": 4,
          "deletions": 1,
          "patch": "@@ -39,11 +39,14 @@ repositories {\n     maven {\n         url 'https://citydb.jfrog.io/artifactory/maven'\n     }\n+    maven {\n+        url 'https://oss.sonatype.org/content/repositories/snapshots/'\n+    }\n     mavenCentral()\n }\n \n dependencies {\n-    implementation 'org.citydb:impexp-core:5.2.0'\n+    implementation 'org.citydb:impexp-core:5.2.1-SNAPSHOT'\n     implementation 'com.github.seancfoley:ipaddress:5.3.4'\n     implementation 'org.glassfish.jersey.containers:jersey-container-servlet:2.35'\n     implementation 'org.glassfish.jersey.inject:jersey-hk2:2.35'"
        },
        {
          "filename": "src/main/java/vcs/citydb/wfs/WFSService.java",
          "status": "modified",
          "additions": 11,
          "deletions": 2,
          "patch": "@@ -7,6 +7,7 @@\n import org.citydb.core.util.Util;\n import org.citydb.util.concurrent.SingleWorkerPool;\n import org.citydb.util.log.Logger;\n+import org.citydb.util.xml.SecureXMLProcessors;\n import org.citygml4j.builder.jaxb.CityGMLBuilder;\n import org.citygml4j.xml.schema.SchemaHandler;\n import org.xml.sax.InputSource;\n@@ -90,8 +91,16 @@ public void init() throws ServletException {\n \t\twfsConfig = registry.lookup(WFSConfig.class);\n \n \t\texceptionReportHandler = new WFSExceptionReportHandler(cityGMLBuilder);\n-\t\tsaxParserFactory = SAXParserFactory.newInstance();\n-\t\tsaxParserFactory.setNamespaceAware(true);\n+\n+\t\ttry {\n+\t\t\tsaxParserFactory = SecureXMLProcessors.newSAXParserFactory();\n+\t\t\tsaxParserFactory.setNamespaceAware(true);\n+\t\t} catch (Throwable e) {\n+\t\t\tString message = \"Failed to enable secure processing of XML queries.\";\n+\t\t\tlog.error(message);\n+\t\t\tlog.error(e.getMessage());\n+\t\t\tthrow new ServletException(message, e);\n+\t\t}\n \n \t\ttry {\n \t\t\tStoredQueryManager storedQueryManager = new StoredQueryManager(cityGMLBuilder, saxParserFactory, getServletContext().getRealPath(Constants.STORED_QUERIES_PATH), wfsConfig);"
        },
        {
          "filename": "src/main/java/vcs/citydb/wfs/config/WFSConfigSchemaWriter.java",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -1,6 +1,6 @@\n package vcs.citydb.wfs.config;\n \n-import org.citydb.config.ConfigUtil;\n+import org.citydb.config.util.ConfigConstants;\n \n import javax.xml.bind.JAXBContext;\n import javax.xml.bind.SchemaOutputResolver;\n@@ -21,7 +21,7 @@ public static void main(String[] args) throws Exception {\n \t\t\tpublic Result createOutput(String namespaceUri, String suggestedFileName) throws IOException {\n \t\t\t\tFile file;\n \n-\t\t\t\tif (namespaceUri.equals(ConfigUtil.CITYDB_CONFIG_NAMESPACE_URI))\n+\t\t\t\tif (namespaceUri.equals(ConfigConstants.CITYDB_CONFIG_NAMESPACE_URI))\n \t\t\t\t\tfile = new File(Constants.CONFIG_SCHEMA_FILE);\n \t\t\t\telse\n \t\t\t\t\tfile = new File(Constants.CONFIG_SCHEMA_PATH + \"/ows/\" + suggestedFileName);"
        },
        {
          "filename": "src/main/java/vcs/citydb/wfs/operation/getfeature/citygml/CityGMLWriterBuilder.java",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -10,6 +10,7 @@\n import org.citydb.core.operation.exporter.util.InternalConfig;\n import org.citydb.core.operation.exporter.writer.FeatureWriteException;\n import org.citydb.util.log.Logger;\n+import org.citydb.util.xml.SecureXMLProcessors;\n import org.citygml4j.model.module.Module;\n import org.citygml4j.model.module.ModuleContext;\n import org.citygml4j.model.module.Modules;\n@@ -29,7 +30,6 @@\n import javax.xml.datatype.DatatypeConfigurationException;\n import javax.xml.transform.Templates;\n import javax.xml.transform.TransformerConfigurationException;\n-import javax.xml.transform.TransformerFactory;\n import javax.xml.transform.sax.SAXTransformerFactory;\n import javax.xml.transform.stream.StreamSource;\n import java.io.File;\n@@ -140,7 +140,7 @@ public void initializeContext(\n \t\t\t\t\t&& wfsConfig.getPostProcessing().getXSLTransformation().isSetStylesheets()) {\n \t\t\t\ttry {\n \t\t\t\t\tList<String> stylesheets = wfsConfig.getPostProcessing().getXSLTransformation().getStylesheets();\n-\t\t\t\t\tSAXTransformerFactory factory = (SAXTransformerFactory) TransformerFactory.newInstance();\n+\t\t\t\t\tSAXTransformerFactory factory = (SAXTransformerFactory) SecureXMLProcessors.newTransformerFactory();\n \t\t\t\t\tTemplates[] templates = new Templates[stylesheets.size()];\n \n \t\t\t\t\tfor (int i = 0; i < stylesheets.size(); i++) {"
        },
        {
          "filename": "src/main/java/vcs/citydb/wfs/operation/getpropertyvalue/GetPropertyValueResponseBuilder.java",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -8,6 +8,7 @@\n import org.citydb.core.database.schema.mapping.FeatureType;\n import org.citydb.core.operation.exporter.writer.FeatureWriteException;\n import org.citydb.util.log.Logger;\n+import org.citydb.util.xml.SecureXMLProcessors;\n import org.citygml4j.model.module.Module;\n import org.citygml4j.model.module.ModuleContext;\n import org.citygml4j.model.module.Modules;\n@@ -25,7 +26,6 @@\n import javax.xml.datatype.DatatypeConfigurationException;\n import javax.xml.transform.Templates;\n import javax.xml.transform.TransformerConfigurationException;\n-import javax.xml.transform.TransformerFactory;\n import javax.xml.transform.sax.SAXTransformerFactory;\n import javax.xml.transform.stream.StreamSource;\n import java.io.File;\n@@ -124,7 +124,7 @@ public void initializeContext(GetPropertyValueType wfsRequest,\n \t\t\t\t\t&& wfsConfig.getPostProcessing().getXSLTransformation().isSetStylesheets()) {\n \t\t\t\ttry {\n \t\t\t\t\tList<String> stylesheets = wfsConfig.getPostProcessing().getXSLTransformation().getStylesheets();\n-\t\t\t\t\tSAXTransformerFactory factory = (SAXTransformerFactory) TransformerFactory.newInstance();\n+\t\t\t\t\tSAXTransformerFactory factory = (SAXTransformerFactory) SecureXMLProcessors.newTransformerFactory();\n \t\t\t\t\tTemplates[] templates = new Templates[stylesheets.size()];\n \n \t\t\t\t\tfor (int i = 0; i < stylesheets.size(); i++) {"
        },
        {
          "filename": "src/main/java/vcs/citydb/wfs/operation/storedquery/StoredQueryManager.java",
          "status": "modified",
          "additions": 11,
          "deletions": 6,
          "patch": "@@ -4,6 +4,7 @@\n import net.opengis.fes._2.FilterType;\n import net.opengis.fes._2.ResourceIdType;\n import net.opengis.wfs._2.*;\n+import org.citydb.util.xml.SecureXMLProcessors;\n import org.citygml4j.builder.jaxb.CityGMLBuilder;\n import org.citygml4j.model.module.citygml.CityGMLModule;\n import org.citygml4j.model.module.citygml.CityGMLModuleType;\n@@ -27,6 +28,7 @@\n import javax.xml.parsers.SAXParser;\n import javax.xml.parsers.SAXParserFactory;\n import javax.xml.stream.XMLOutputFactory;\n+import javax.xml.transform.TransformerConfigurationException;\n import javax.xml.transform.TransformerFactory;\n import javax.xml.xpath.XPathConstants;\n import javax.xml.xpath.XPathExpression;\n@@ -35,6 +37,7 @@\n import java.io.BufferedReader;\n import java.io.FileReader;\n import java.io.IOException;\n+import java.nio.file.DirectoryStream;\n import java.nio.file.Files;\n import java.nio.file.Path;\n import java.nio.file.Paths;\n@@ -58,16 +61,16 @@ public class StoredQueryManager {\n \tprivate final WFSConfig wfsConfig;\n \tprivate final MessageDigest md5;\n \n-\tpublic StoredQueryManager(CityGMLBuilder cityGMLBuilder, SAXParserFactory saxParserFactory, String path, WFSConfig wfsConfig) throws ParserConfigurationException, SAXException, NoSuchAlgorithmException, IOException {\n+\tpublic StoredQueryManager(CityGMLBuilder cityGMLBuilder, SAXParserFactory saxParserFactory, String path, WFSConfig wfsConfig) throws ParserConfigurationException, SAXException, NoSuchAlgorithmException, IOException, TransformerConfigurationException {\n \t\tthis.cityGMLBuilder = cityGMLBuilder;\n \t\tthis.saxParserFactory = saxParserFactory;\n \t\tthis.wfsConfig = wfsConfig;\n \n \t\tmd5 = MessageDigest.getInstance(\"MD5\");\n \t\twfsFactory = new ObjectFactory();\n-\t\ttransformerFactory = TransformerFactory.newInstance();\n+\t\ttransformerFactory = SecureXMLProcessors.newTransformerFactory();\n \t\txmlOutputFactory = XMLOutputFactory.newInstance();\n-\t\tdocumentBuilderFactory = DocumentBuilderFactory.newInstance();\n+\t\tdocumentBuilderFactory = SecureXMLProcessors.newDocumentBuilderFactory();\n \t\tdocumentBuilderFactory.setNamespaceAware(true);\n \n \t\tstoredQueriesPath = Paths.get(path);\n@@ -83,9 +86,11 @@ public List<StoredQueryAdapter> listStoredQueries(String handle) throws WFSExcep\n \t\tstoredQueries.add(new StoredQueryAdapter(DEFAULT_QUERY.getId()));\n \n \t\ttry {\n-\t\t\tfor (Path file : Files.newDirectoryStream(storedQueriesPath)) {\n-\t\t\t\tif (Files.isRegularFile(file))\n-\t\t\t\t\tstoredQueries.add(new StoredQueryAdapter(file));\n+\t\t\ttry (DirectoryStream<Path> stream = Files.newDirectoryStream(storedQueriesPath)) {\n+\t\t\t\tfor (Path file : stream) {\n+\t\t\t\t\tif (Files.isRegularFile(file))\n+\t\t\t\t\t\tstoredQueries.add(new StoredQueryAdapter(file));\n+\t\t\t\t}\n \t\t\t}\n \t\t} catch (IOException e) {\n \t\t\tthrow new WFSException(WFSExceptionCode.OPERATION_PROCESSING_FAILED, \"Failed to list stored queries.\", handle, e);"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 1,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 6,
        "max_directory_depth": 9
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "4d1bcff5d1f538769e1b3fb9ab56975fdc5d8f4a",
            "date": "2024-09-21T11:44:06Z",
            "author_login": "clausnagel"
          },
          {
            "sha": "a96092d5badae9c453b1d3f21323aaaf9e8abf9b",
            "date": "2024-09-19T13:12:22Z",
            "author_login": "clausnagel"
          },
          {
            "sha": "cd40c5dbd9ccdf2de63a766c2e77cff1acb5a8cf",
            "date": "2024-09-19T13:08:18Z",
            "author_login": "clausnagel"
          },
          {
            "sha": "35ee0308fc81e9f35fa3da638c367f5cf6483345",
            "date": "2024-09-14T13:03:47Z",
            "author_login": "clausnagel"
          },
          {
            "sha": "5fb50dc5e5dbb51939c4438ab182c138b5f409f7",
            "date": "2024-09-13T11:32:13Z",
            "author_login": "clausnagel"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 5.5,
    "cvss_vector": "CVSS:3.1/AV:A/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L",
    "cwe_id": "CWE-611",
    "description": "A vulnerability was found in 3D City Database OGC Web Feature Service up to 5.2.0. It has been rated as problematic. This issue affects some unknown processing. The manipulation leads to xml external entity reference. Upgrading to version 5.2.1 is able to address this issue. The name of the patch is 246f4e2a97ad81491c00a7ed72ce5e7c7f75050a. It is recommended to upgrade the affected component. The associated identifier of this vulnerability is VDB-216215.",
    "attack_vector": "ADJACENT_NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2022-12-18T22:15:10.723",
    "last_modified": "2024-11-21T07:35:35.267",
    "fix_date": "2022-06-21T05:08:09Z"
  },
  "references": [
    {
      "url": "https://github.com/3dcitydb/web-feature-service/commit/246f4e2a97ad81491c00a7ed72ce5e7c7f75050a",
      "source": "cna@vuldb.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/3dcitydb/web-feature-service/pull/12",
      "source": "cna@vuldb.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/3dcitydb/web-feature-service/releases/tag/v5.2.1",
      "source": "cna@vuldb.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://vuldb.com/?id.216215",
      "source": "cna@vuldb.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/3dcitydb/web-feature-service/commit/246f4e2a97ad81491c00a7ed72ce5e7c7f75050a",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/3dcitydb/web-feature-service/pull/12",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/3dcitydb/web-feature-service/releases/tag/v5.2.1",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://vuldb.com/?id.216215",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:04:23.182081",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "web-feature-service",
    "owner": "3dcitydb",
    "created_at": "2014-04-07T12:19:05Z",
    "updated_at": "2024-09-21T11:46:11Z",
    "pushed_at": "2024-09-21T11:46:53Z",
    "size": 126097,
    "stars": 30,
    "forks": 13,
    "open_issues": 0,
    "watchers": 30,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "Java": 1419368,
      "JavaScript": 428938,
      "CSS": 11156,
      "HTML": 3403,
      "Dockerfile": 1995,
      "Shell": 738
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "apache-2.0"
    },
    "collected_at": "2025-01-14T13:24:43.007033"
  }
}