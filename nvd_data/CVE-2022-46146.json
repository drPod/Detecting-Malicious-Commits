{
  "cve_id": "CVE-2022-46146",
  "github_data": {
    "repository": "prometheus/exporter-toolkit",
    "fix_commit": "5b1eab34484ddd353986bce736cd119d863e4ff5",
    "related_commits": [
      "5b1eab34484ddd353986bce736cd119d863e4ff5",
      "5b1eab34484ddd353986bce736cd119d863e4ff5"
    ],
    "patch_url": "https://github.com/prometheus/exporter-toolkit/commit/5b1eab34484ddd353986bce736cd119d863e4ff5.patch",
    "fix_commit_details": {
      "sha": "5b1eab34484ddd353986bce736cd119d863e4ff5",
      "commit_date": "2022-11-29T09:22:49Z",
      "author": {
        "login": "roidelapluie",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Merge pull request from GHSA-7rg2-cxvp-9p7p",
        "length": 298,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 58,
        "additions": 56,
        "deletions": 2
      },
      "files": [
        {
          "filename": "web/handler.go",
          "status": "modified",
          "additions": 8,
          "deletions": 2,
          "patch": "@@ -19,6 +19,7 @@ import (\n \t\"encoding/hex\"\n \t\"fmt\"\n \t\"net/http\"\n+\t\"strings\"\n \t\"sync\"\n \n \t\"github.com/go-kit/log\"\n@@ -113,7 +114,12 @@ func (u *webHandler) ServeHTTP(w http.ResponseWriter, r *http.Request) {\n \t\t\thashedPassword = \"$2y$10$QOauhQNbBCuQDKes6eFzPeMqBSjb7Mr5DUmpZ/VcEd00UAV/LDeSi\"\n \t\t}\n \n-\t\tcacheKey := hex.EncodeToString(append(append([]byte(user), []byte(hashedPassword)...), []byte(pass)...))\n+\t\tcacheKey := strings.Join(\n+\t\t\t[]string{\n+\t\t\t\thex.EncodeToString([]byte(user)),\n+\t\t\t\thex.EncodeToString([]byte(hashedPassword)),\n+\t\t\t\thex.EncodeToString([]byte(pass)),\n+\t\t\t}, \":\")\n \t\tauthOk, ok := u.cache.get(cacheKey)\n \n \t\tif !ok {\n@@ -122,7 +128,7 @@ func (u *webHandler) ServeHTTP(w http.ResponseWriter, r *http.Request) {\n \t\t\terr := bcrypt.CompareHashAndPassword([]byte(hashedPassword), []byte(pass))\n \t\t\tu.bcryptMtx.Unlock()\n \n-\t\t\tauthOk = err == nil\n+\t\t\tauthOk = validUser && err == nil\n \t\t\tu.cache.set(cacheKey, authOk)\n \t\t}\n "
        },
        {
          "filename": "web/handler_test.go",
          "status": "modified",
          "additions": 48,
          "deletions": 0,
          "patch": "@@ -137,6 +137,54 @@ func TestBasicAuthWithFakepassword(t *testing.T) {\n \tlogin()\n }\n \n+// TestByPassBasicAuthVuln tests for CVE-2022-46146.\n+func TestByPassBasicAuthVuln(t *testing.T) {\n+\tserver := &http.Server{\n+\t\tHandler: http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n+\t\t\tw.Write([]byte(\"Hello World!\"))\n+\t\t}),\n+\t}\n+\n+\tdone := make(chan struct{})\n+\tt.Cleanup(func() {\n+\t\tif err := server.Shutdown(context.Background()); err != nil {\n+\t\t\tt.Fatal(err)\n+\t\t}\n+\t\t<-done\n+\t})\n+\n+\tgo func() {\n+\t\tflags := FlagConfig{\n+\t\t\tWebListenAddresses: &([]string{port}),\n+\t\t\tWebSystemdSocket:   OfBool(false),\n+\t\t\tWebConfigFile:      OfString(\"testdata/web_config_users_noTLS.good.yml\"),\n+\t\t}\n+\t\tListenAndServe(server, &flags, testlogger)\n+\t\tclose(done)\n+\t}()\n+\n+\tlogin := func(username, password string) {\n+\t\tclient := &http.Client{}\n+\t\treq, err := http.NewRequest(\"GET\", \"http://localhost\"+port, nil)\n+\t\tif err != nil {\n+\t\t\tt.Fatal(err)\n+\t\t}\n+\t\treq.SetBasicAuth(username, password)\n+\t\tr, err := client.Do(req)\n+\t\tif err != nil {\n+\t\t\tt.Fatal(err)\n+\t\t}\n+\t\tif r.StatusCode != 401 {\n+\t\t\tt.Fatalf(\"bad return code, expected %d, got %d\", 401, r.StatusCode)\n+\t\t}\n+\t}\n+\n+\t// Poison the cache.\n+\tlogin(\"alice$2y$12$1DpfPeqF9HzHJt.EWswy1exHluGfbhnn3yXhR7Xes6m3WJqFg0Wby\", \"fakepassword\")\n+\t// Login with a wrong password.\n+\tlogin(\"alice\", \"$2y$10$QOauhQNbBCuQDKes6eFzPeMqBSjb7Mr5DUmpZ/VcEd00UAV/LDeSifakepassword\")\n+}\n+\n // TestHTTPHeaders validates that HTTP headers are added correctly.\n func TestHTTPHeaders(t *testing.T) {\n \tserver := &http.Server{"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 1,
        "max_directory_depth": 1
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "8ecbde9bf1b750ec977c4398c625307c4adf6a64",
            "date": "2024-12-29T18:17:41Z",
            "author_login": "prombot"
          },
          {
            "sha": "d0c382afefc845399dcba39a1dfe68ac59778d3c",
            "date": "2024-12-13T08:46:59Z",
            "author_login": "dependabot[bot]"
          },
          {
            "sha": "6a80b508872abbba4b42dd8c56eb2142759aeb39",
            "date": "2024-12-13T08:43:41Z",
            "author_login": "dependabot[bot]"
          },
          {
            "sha": "ba7d5a4cd0da0974266d39bbd5b2809a6e36f944",
            "date": "2024-12-13T08:40:51Z",
            "author_login": "prombot"
          },
          {
            "sha": "5d3d452956580a0d2c9fcdd75c9221a5f927155a",
            "date": "2024-12-13T08:40:36Z",
            "author_login": "dependabot[bot]"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.2,
    "cvss_vector": "CVSS:3.1/AV:L/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N",
    "cwe_id": "CWE-287",
    "description": "Prometheus Exporter Toolkit is a utility package to build exporters. Prior to versions 0.7.2 and 0.8.2, if someone has access to a Prometheus web.yml file and users' bcrypted passwords, they can bypass security by poisoning the built-in authentication cache. Versions 0.7.2 and 0.8.2 contain a fix for the issue. There is no workaround, but attacker must have access to the hashed password to use this functionality.",
    "attack_vector": "LOCAL",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2022-11-29T14:15:13.283",
    "last_modified": "2024-11-21T07:30:11.987",
    "fix_date": "2022-11-29T09:22:49Z"
  },
  "references": [
    {
      "url": "http://www.openwall.com/lists/oss-security/2022/11/29/1",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2022/11/29/2",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Mailing List",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2022/11/29/4",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Mailing List",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/prometheus/exporter-toolkit/commit/5b1eab34484ddd353986bce736cd119d863e4ff5",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/prometheus/exporter-toolkit/security/advisories/GHSA-7rg2-cxvp-9p7p",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/JRSHISR64L6QGSMDFZDNPHHIXSCAKK26/",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/UH24VXIB25OGHF4VGY4PLZMTGTI3BHCA/",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/ULVDTAI76VATRAHTKCE2SUJ4NC3PQZ6Y/",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://security.gentoo.org/glsa/202401-15",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2022/11/29/1",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Mailing List",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2022/11/29/2",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Mailing List",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "http://www.openwall.com/lists/oss-security/2022/11/29/4",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Mailing List",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/prometheus/exporter-toolkit/commit/5b1eab34484ddd353986bce736cd119d863e4ff5",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/prometheus/exporter-toolkit/security/advisories/GHSA-7rg2-cxvp-9p7p",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/JRSHISR64L6QGSMDFZDNPHHIXSCAKK26/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/UH24VXIB25OGHF4VGY4PLZMTGTI3BHCA/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/ULVDTAI76VATRAHTKCE2SUJ4NC3PQZ6Y/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://security.gentoo.org/glsa/202401-15",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:04:21.175321",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "exporter-toolkit",
    "owner": "prometheus",
    "created_at": "2020-06-03T19:35:39Z",
    "updated_at": "2025-01-10T10:14:21Z",
    "pushed_at": "2024-12-29T18:17:43Z",
    "size": 398,
    "stars": 273,
    "forks": 84,
    "open_issues": 33,
    "watchers": 273,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "master"
    ],
    "languages": {
      "Go": 58507,
      "HTML": 1408,
      "Makefile": 664,
      "CSS": 491
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "apache-2.0"
    },
    "collected_at": "2025-01-14T20:27:14.844630"
  }
}