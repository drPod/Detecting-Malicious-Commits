{
  "cve_id": "CVE-2022-4615",
  "github_data": {
    "repository": "openemr/openemr",
    "fix_commit": "d5eb41697f7f1bc2c7ee5bc9bbf58684e1c8cc14",
    "related_commits": [
      "d5eb41697f7f1bc2c7ee5bc9bbf58684e1c8cc14",
      "d5eb41697f7f1bc2c7ee5bc9bbf58684e1c8cc14"
    ],
    "patch_url": "https://github.com/openemr/openemr/commit/d5eb41697f7f1bc2c7ee5bc9bbf58684e1c8cc14.patch",
    "fix_commit_details": {
      "sha": "d5eb41697f7f1bc2c7ee5bc9bbf58684e1c8cc14",
      "commit_date": "2022-10-27T01:40:16Z",
      "author": {
        "login": "stephenwaite",
        "type": "User",
        "stats": {
          "total_commits": 638,
          "average_weekly_commits": 0.843915343915344,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 290
        }
      },
      "commit_message": {
        "title": "commits for Rel 700 p2 (#5808)",
        "length": 1883,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 1001,
        "additions": 609,
        "deletions": 392
      },
      "files": [
        {
          "filename": "contrib/icd10/2022-Code Descriptions.zip",
          "status": "removed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "contrib/icd10/2023 Code Descriptions in Tabular Order.zip",
          "status": "added",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "contrib/icd10/Zip File 3 2022 ICD-10-PCS Codes File.zip",
          "status": "removed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "contrib/icd10/Zip File 3 2023 ICD-10-PCS Codes File.zip",
          "status": "added",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "interface/billing/edit_payment.php",
          "status": "modified",
          "additions": 16,
          "deletions": 17,
          "patch": "@@ -141,7 +141,7 @@\n                     \"'\";\n \n                 $where = \"$where1 AND pay_amount > 0\";\n-                if (isset($_POST[\"Payment$CountRow\"]) && $_POST[\"Payment$CountRow\"] * 1 > 0) {\n+                if (!empty($_POST[\"Payment$CountRow\"])) {\n                     if (trim($_POST['type_name']) == 'insurance') {\n                         if (trim($_POST[\"HiddenIns$CountRow\"]) == 1) {\n                             $AccountCode = \"IPP\";\n@@ -227,7 +227,7 @@\n                 //==============================================================================================================================\n \n                 $where = \"$where1 AND (memo LIKE 'Deductable%' OR memo LIKE 'Deductible%')\";\n-                if (isset($_POST[\"Deductible$CountRow\"]) && $_POST[\"Deductible$CountRow\"] * 1 > 0) {\n+                if (!empty($_POST[\"Deductible$CountRow\"])) {\n                     $resPayment = sqlStatement(\"SELECT  * from ar_activity $where\");\n                     if (sqlNumRows($resPayment) > 0) {\n                         sqlStatement(\"update ar_activity set deleted = NOW() $where\");\n@@ -259,7 +259,7 @@\n                 //==============================================================================================================================\n \n                 $where = \"$where1 AND pay_amount < 0\";\n-                if (isset($_POST[\"Takeback$CountRow\"]) && $_POST[\"Takeback$CountRow\"] * 1 > 0) {\n+                if (!empty($_POST[\"Takeback$CountRow\"])) {\n                     $resPayment = sqlStatement(\"SELECT  * from ar_activity $where\");\n                     if (sqlNumRows($resPayment) > 0) {\n                         sqlStatement(\"update ar_activity set deleted = NOW() $where\");\n@@ -337,7 +337,10 @@\n         }\n \n         if ($_REQUEST['global_amount'] == 'yes') {\n-            sqlStatement(\"update ar_session set global_amount=? where session_id =?\", [(isset($_POST[\"HidUnappliedAmount\"]) ? trim($_POST[\"HidUnappliedAmount\"]) * 1 : ''), $payment_id]);\n+            sqlStatement(\n+                \"update ar_session set global_amount=? where session_id =?\",\n+                [(isset($_POST[\"HidUnappliedAmount\"]) ? floatval($_POST[\"HidUnappliedAmount\"]) : 0), $payment_id]\n+            );\n         } elseif ($_REQUEST['global_reset'] == '-0.00') {\n             sqlStatement(\"update ar_session set global_amount=? where session_id =?\", [0, $payment_id]);\n         }\n@@ -354,7 +357,7 @@\n //==============================================================================\n //Search Code\n //===============================================================================\n-$payment_id = ($payment_id ?? null) * 1 > 0 ? $payment_id : $_REQUEST['payment_id'];\n+$payment_id = !empty($payment_id) ? (int) $payment_id : (int) $_REQUEST['payment_id'];\n $ResultSearchSub = sqlStatement(\n     \"SELECT DISTINCT encounter, code_type, code, modifier, pid \" .\n     \"FROM ar_activity WHERE deleted IS NULL AND session_id = ? \" .\n@@ -625,22 +628,22 @@ function DeletePaymentDistribution(DeleteId) {//Confirms deletion of payment dis\n         }\n         ?>\n         <?php\n-        if ($payment_id * 1 == 0) {\n+        if (empty($payment_id)) {\n             $onclick = \"top.restoreSession();return SavePayment();\";\n         } else {\n             $onclick = \"return false;\";\n         }\n         ?>\n         <form class=\"form\" name='new_payment' method='post' action=\"edit_payment.php\" onsubmit='<?php echo $onclick; ?>'>\n             <?php\n-            if ($payment_id * 1 > 0) { ?>\n+            if (!empty($payment_id)) { ?>\n             <fieldset>\n                 <?php\n                 require_once(\"payment_master.inc.php\");  //Check/cash details are entered here.\n                 ?>\n                 <?php }//End of if($payment_id*1>0) ?>\n                 <?php\n-                if ($payment_id * 1 > 0) {//Distribution rows already in the database are displayed.\n+                if (!empty($payment_id)) {//Distribution rows already in the database are displayed.\n                     ?>\n                     <?php //\n                     $resCount = sqlStatement(\n@@ -884,8 +887,7 @@ function DeletePaymentDistribution(DeleteId) {//Confirms deletion of payment dis\n                                         [$payment_id, $PId, $Encounter, $Codetype, $Code, $Modifier]\n                                     );\n                                     $rowPayment = sqlFetchArray($resPayment);\n-                                    $PaymentDB = $rowPayment['pay_amount'] ?? null * 1;\n-                                    $PaymentDB = $PaymentDB == 0 ? '' : $PaymentDB;\n+                                    $PaymentDB = floatval($rowPayment['pay_amount'] ?? null);\n \n                                     $resPayment = sqlStatement(\n                                         \"SELECT pay_amount FROM ar_activity WHERE \" .\n@@ -894,8 +896,7 @@ function DeletePaymentDistribution(DeleteId) {//Confirms deletion of payment dis\n                                         [$payment_id, $PId, $Encounter, $Codetype, $Code, $Modifier]\n                                     );\n                                     $rowPayment = sqlFetchArray($resPayment);\n-                                    $TakebackDB = ($rowPayment['pay_amount'] ?? null) * -1;\n-                                    $TakebackDB = $TakebackDB == 0 ? '' : $TakebackDB;\n+                                    $TakebackDB = floatval($rowPayment['pay_amount'] ?? null);\n \n                                     $resPayment = sqlStatement(\n                                         \"SELECT adj_amount FROM ar_activity WHERE \" .\n@@ -904,8 +905,7 @@ function DeletePaymentDistribution(DeleteId) {//Confirms deletion of payment dis\n                                         [$payment_id, $PId, $Encounter, $Codetype, $Code, $Modifier]\n                                     );\n                                     $rowPayment = sqlFetchArray($resPayment);\n-                                    $AdjAmountDB = $rowPayment['adj_amount'] * 1;\n-                                    $AdjAmountDB = $AdjAmountDB == 0 ? '' : $AdjAmountDB;\n+                                    $AdjAmountDB = floatval($rowPayment['adj_amount'] ?? null);\n \n                                     $resPayment = sqlStatement(\n                                         \"SELECT memo FROM ar_activity WHERE \" .\n@@ -943,7 +943,6 @@ function DeletePaymentDistribution(DeleteId) {//Confirms deletion of payment dis\n                                     } else {\n                                         $AllowedDB = 0;\n                                     }\n-                                    $AllowedDB = $AllowedDB === 0 ? '' : $AllowedDB;\n \n                                     if ($Ins == 1) {\n                                         $bgcolor = '#ddddff';\n@@ -1072,8 +1071,8 @@ function DeletePaymentDistribution(DeleteId) {//Confirms deletion of payment dis\n                     <input type='hidden' name='global_amount' id='global_amount' value='' />\n                     <input type='hidden' name='DeletePaymentDistributionId' id='DeletePaymentDistributionId' value='' />\n                     <input type=\"hidden\" name=\"ActionStatus\" id=\"ActionStatus\" value=\"<?php echo attr($Message ?? ''); ?>\" />\n-                    <input type='hidden' name='CountIndexAbove' id='CountIndexAbove' value='<?php echo attr($CountIndexAbove * 1); ?>' />\n-                    <input type='hidden' name='CountIndexBelow' id='CountIndexBelow' value='<?php echo attr($CountIndexBelow * 1); ?>' />\n+                    <input type='hidden' name='CountIndexAbove' id='CountIndexAbove' value='<?php echo (int) attr($CountIndexAbove); ?>' />\n+                    <input type='hidden' name='CountIndexBelow' id='CountIndexBelow' value='<?php echo (int) attr($CountIndexBelow); ?>' />\n                     <input type=\"hidden\" name=\"ParentPage\" id=\"ParentPage\" value=\"<?php echo attr($_REQUEST['ParentPage'] ?? ''); ?>\" />\n                 </div>\n         </form>"
        },
        {
          "filename": "interface/billing/payment_pat_sel.inc.php",
          "status": "modified",
          "additions": 4,
          "deletions": 4,
          "patch": "@@ -25,7 +25,7 @@\n //===============================================================================\n if (isset($_POST[\"mode\"])) {\n     if (\n-           ($_POST[\"mode\"] == \"search\") || ($_POST[\"default_search_patient\"] == \"default_search_patient\") &&\n+           ($_POST[\"mode\"] == \"search\") || (($_POST[\"default_search_patient\"] ?? null) == \"default_search_patient\") &&\n            isset($_REQUEST['hidden_patient_code']) &&\n            (int)$_REQUEST['hidden_patient_code'] > 0\n     ) {\n@@ -46,9 +46,9 @@\n         $res = sqlStatement(\"SELECT fname,lname,mname FROM patient_data\n                          where pid =?\", array($hidden_patient_code));\n         $row = sqlFetchArray($res);\n-        $fname = $row['fname'];\n-        $lname = $row['lname'];\n-        $mname = $row['mname'];\n+        $fname = $row['fname'] ?? '';\n+        $lname = $row['lname'] ?? '';\n+        $mname = $row['mname'] ?? '';\n         $NameNew = $lname . ' ' . $fname . ' ' . $mname;\n     }\n }"
        },
        {
          "filename": "interface/billing/search_payments.php",
          "status": "modified",
          "additions": 1,
          "deletions": 6,
          "patch": "@@ -533,7 +533,7 @@ function SearchPayingEntityAction() {\n                                             </td>\n                                             <td>\n                                                 <!--<a class='iframe medium_modal' href=\"edit_payment.php?payment_id=<?php echo htmlspecialchars($RowSearch['session_id']); ?>\"><?php echo $Payer == '' ? '&nbsp;' : htmlspecialchars($Payer); ?></a>-->\n-                                                <a class=\"medium_modal\" data-target=\"#myModal1\" data-toggle=\"modal\" onclick=\"loadiframe('edit_payment.php?payment_id=<?php echo attr_url($RowSearch['session_id']); ?>\"><?php echo $Payer == '' ? '&nbsp;' : text($Payer); ?></a><!--link to iframe-->\n+                                                <a class=\"medium_modal\" href='edit_payment.php?payment_id=<?php echo attr_url($RowSearch['session_id']); ?>')\"><?php echo $Payer == '' ? '&nbsp;' : text($Payer); ?></a><!--link to iframe-->\n                                             </td>\n                                             <td>\n                                                 <a class=\"medium_modal\" href='edit_payment.php?payment_id=<?php echo attr_url($RowSearch['session_id']); ?>'><?php echo $RowSearch['payer_id'] * 1 > 0 ? text($RowSearch['payer_id']) : '&nbsp;'; ?></a>\n@@ -608,10 +608,5 @@ function SearchPayingEntityAction() {\n         </div>\n     </div><!--end of container div-->\n <?php $oemr_ui->oeBelowContainerDiv(); ?>\n-<script>\n-function loadiframe(htmlHref) { //load iframe\n-    document.getElementById('targetiframe1').src = htmlHref;\n-}\n-</script>\n </body>\n </html>"
        },
        {
          "filename": "interface/billing/sl_eob_invoice.php",
          "status": "modified",
          "additions": 12,
          "deletions": 6,
          "patch": "@@ -69,10 +69,10 @@ function setins(istr) {\n             return true;\n         }\n \n-        function goEncounterSummary(pid) {\n+        function goEncounterSummary(e, pid) {\n             if(pid) {\n                 if(typeof opener.toEncSummary  === 'function') {\n-                    opener.toEncSummary(pid);\n+                    opener.toEncSummary(e, pid);\n                 }\n             }\n             doClose();\n@@ -295,7 +295,7 @@ function updateFields(payField, adjField, balField, coPayField, isFirstProcCode)\n     $payer_type = $matches[1];\n }\n \n-if (!empty($_POST['form_save']) || !empty($_POST['form_cancel']) || !empty($_POST['isLastClosed'])) {\n+if (!empty($_POST['form_save']) || !empty($_POST['form_cancel']) || !empty($_POST['isLastClosed']) || !empty($_POST['billing_note'])) {\n     if (!empty($_POST['form_save'])) {\n         if (!CsrfUtils::verifyCsrfToken($_POST[\"csrf_token_form\"])) {\n             CsrfUtils::csrfNotVerified();\n@@ -426,7 +426,7 @@ function updateFields(payField, adjField, balField, coPayField, isFirstProcCode)\n     if (!$debug && !$save_stay && !$_POST['isLastClosed']) {\n         echo \"doClose();\\n\";\n     }\n-    if (!$debug && ($save_stay || $_POST['isLastClosed'])) {\n+    if (!$debug && ($save_stay || $_POST['isLastClosed'] || $_POST['billing_note'])) {\n         if ($_POST['isLastClosed']) {\n             // save last closed level\n             $form_done = 0 + $_POST['form_done'];\n@@ -438,6 +438,12 @@ function updateFields(payField, adjField, balField, coPayField, isFirstProcCode)\n                 SLEOB::arSetupSecondary($patient_id, $encounter_id, $debug);\n             }\n         }\n+\n+        if ($_POST['billing_note']) {\n+            // save last closed level\n+            sqlStatement(\"UPDATE form_encounter SET billing_note = ? WHERE pid = ? AND encounter = ?\", array($_POST['billing_note'], $patient_id, $encounter_id));\n+        }\n+\n         // will reload page w/o reposting\n         echo \"location.replace(location)\\n\";\n     }\n@@ -513,7 +519,7 @@ function updateFields(payField, adjField, balField, coPayField, isFirstProcCode)\n                 <div class=\"form-row\">\n                     <div class=\"form-group col-lg\">\n                         <label class=\"col-form-label\" for=\"billing_note\"><?php echo xlt('Billing Note'); ?>:</label>\n-                        <textarea name=\"billing_note\" id=\"billing_note\" class=\"form-control\" cols=\"5\" rows=\"2\" readonly><?php echo text(($pdrow['billing_note'] ?? '')) . \"\\n\" . text(($bnrow['billing_note'] ?? '')); ?></textarea>\n+                        <textarea name=\"billing_note\" id=\"billing_note\" class=\"form-control\" cols=\"5\" rows=\"2\"><?php echo text(($pdrow['billing_note'] ?? '')) . \"\\n\" . text(($bnrow['billing_note'] ?? '')); ?></textarea>\n                     </div>\n                 </div>\n                 <div class=\"form-row\">\n@@ -767,7 +773,7 @@ class=\"form-control\"\n                     </div>\n                     <?php if ($from_posting) { ?>\n                         <button type='button' class=\"btn btn-secondary btn-view float-right\" name='form_goto' id=\"btn-goto\"\n-                            onclick=\"goEncounterSummary(<?php echo attr_js($patient_id) ?>)\"><?php echo xlt(\"Past Encounters\"); ?></button>\n+                            onclick=\"goEncounterSummary(event, <?php echo attr_js($patient_id) ?>)\"><?php echo xlt(\"Past Encounters\"); ?></button>\n                     <?php } ?>\n                 </div>\n             </div>"
        },
        {
          "filename": "interface/forms/LBF/printable.php",
          "status": "modified",
          "additions": 6,
          "deletions": 14,
          "patch": "@@ -108,15 +108,6 @@\n         'keep_table_proportions' => true\n     );\n     $pdf = new mPDF($config_mpdf);\n-    $pdf->SetHTMLHeader('\n-\t\t<div style=\"text-align: right; font-weight: bold;\">\n-\t\t\t' . $patientname . ' DOB: ' . oeFormatShortDate($patientdob[\"DOB\"]) . ' DOS: ' . oeFormatShortDate($dateofservice) . '\n-\t\t</div>');\n-    $pdf->SetHTMLFooter('\n-\t\t\t<div style=\"float: right; width:33% text-align: left;\">' . oeFormatDateTime(date(\"Y-m-d H:i:s\")) . '</div>\n-\t\t\t<div style=\"float: right; width:33%; text-align: center; \">{PAGENO}/{nbpg}</div>\n-\t\t\t<div style=\"float: right; width:33%; text-align: right; \">' . $patientname . '</div>\n-\t\t\t');\n     $pdf->SetDisplayMode('real');\n     if ($_SESSION['language_direction'] == 'rtl') {\n         $pdf->SetDirectionality('rtl');\n@@ -280,13 +271,14 @@\n $logo = '';\n $ma_logo_path = \"sites/\" . $_SESSION['site_id'] . \"/images/ma_logo.png\";\n if (is_file(\"$webserver_root/$ma_logo_path\")) {\n-    // Would use max-height here but html2pdf does not support it.\n-    // TODO - now use mPDF, so should test if still need this fix\n-    $logo = \"<img src='$web_root/$ma_logo_path' style='height:\" . attr(round($FONTSIZE * 5.14)) . \"pt' />\";\n-} else {\n-    $logo = \"<!-- '$ma_logo_path' does not exist. -->\";\n+    $logo = \"$web_root/$ma_logo_path\";\n }\n+\n echo genFacilityTitle($formtitle, -1, $logo);\n+\n+if ($PDF_OUTPUT) {\n+    echo genPatientHeaderFooter($pid, $DOS = $dateofservice);\n+}\n ?>\n \n <?php if ($isblankform) { ?>"
        },
        {
          "filename": "interface/forms/fee_sheet/new.php",
          "status": "modified",
          "additions": 10,
          "deletions": 1,
          "patch": "@@ -512,7 +512,16 @@ function echoProductLines()\n     if ($_POST['form_checksum'] != $current_checksum) {\n         $alertmsg = xl('Someone else has just changed this visit. Please cancel this page and try again.');\n         $comment = \"CHECKSUM ERROR, expecting '{$_POST['form_checksum']}'\";\n-        EventAuditLogger::instance()->newEvent(\"checksum\", $_SESSION['authUser'], $_SESSION['authProvider'], 1, $comment, $pid);\n+        EventAuditLogger::instance()->newEvent(\n+            \"checksum\",\n+            $_SESSION['authUser'],\n+            $_SESSION['authProvider'],\n+            1,\n+            $comment,\n+            $pid,\n+            'open-emr',\n+            'fee sheet'\n+        );\n     }\n }\n "
        },
        {
          "filename": "interface/forms/fee_sheet/review/fee_sheet_ajax.php",
          "status": "modified",
          "additions": 17,
          "deletions": 3,
          "patch": "@@ -14,13 +14,18 @@\n require_once(\"fee_sheet_queries.php\");\n \n use OpenEMR\\Common\\Acl\\AclMain;\n+use OpenEMR\\Common\\Csrf\\CsrfUtils;\n \n if (!AclMain::aclCheckCore('acct', 'bill')) {\n     header(\"HTTP/1.0 403 Forbidden\");\n     echo \"Not authorized for billing\";\n     return false;\n }\n \n+if (!CsrfUtils::verifyCsrfToken($_REQUEST[\"csrf_token_form\"])) {\n+    CsrfUtils::csrfNotVerified();\n+}\n+\n if (isset($_REQUEST['pid'])) {\n     $req_pid = $_REQUEST['pid'];\n }\n@@ -62,7 +67,7 @@\n     }\n \n     $retval['issues'] = $issues;\n-    echo json_encode($retval);\n+    echo text(json_encode($retval));\n     return;\n }\n \n@@ -73,7 +78,7 @@\n \n     $diags = array();\n     foreach ($json_diags as $diag) {\n-        $diags[] = new code_info($diag->{'code'}, $diag->{'code_type'}, $diag->{'description'});\n+        $diags[] = new code_info($diag->code, $diag->code_type, $diag->description);\n     }\n \n     $procs = array();\n@@ -82,7 +87,16 @@\n     }\n \n     foreach ($json_procs as $proc) {\n-        $procs[] = new procedure($proc->{'code'}, $proc->{'code_type'}, $proc->{'description'}, $proc->{'fee'}, $proc->{'justify'}, $proc->{'modifiers'}, $proc->{'units'}, 0);\n+        $procs[] = new procedure(\n+            $proc->code,\n+            $proc->code_type,\n+            $proc->description,\n+            $proc->fee,\n+            $proc->justify,\n+            $proc->modifiers,\n+            $proc->units,\n+            0\n+        );\n     }\n \n     $database->StartTrans();"
        },
        {
          "filename": "interface/forms/fee_sheet/review/fee_sheet_review_view_model.js",
          "status": "modified",
          "additions": 4,
          "deletions": 2,
          "patch": "@@ -111,7 +111,8 @@ function request_encounter_data(model_data, mode, prev_encounter) {\n         pid: pid,\n         encounter: enc,\n         mode: mode,\n-        task: \"retrieve\"\n+        task: \"retrieve\",\n+        csrf_token_form: csrf_token_js\n     };\n     if (prev_encounter != null) {\n         request.prev_encounter = prev_encounter;\n@@ -205,7 +206,8 @@ function add_review(data, event) {\n             encounter: enc,\n             task: 'add_diags',\n             diags: JSON.stringify(diag_list),\n-            procs: JSON.stringify(proc_list)\n+            procs: JSON.stringify(proc_list),\n+            csrf_token_form: csrf_token_js\n         },\n         function (data) {\n             refresh_codes();"
        },
        {
          "filename": "interface/forms/fee_sheet/review/initialize_review.php",
          "status": "modified",
          "additions": 6,
          "deletions": 1,
          "patch": "@@ -12,6 +12,8 @@\n  * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n  */\n \n+use OpenEMR\\Common\\Csrf\\CsrfUtils;\n+\n if (!$isBilled) {\n     require_once(\"code_check.php\");\n     ?>\n@@ -22,8 +24,11 @@\n     var review_tag = <?php echo xlj('Review'); ?>;\n     var justify_click_title = <?php echo xlj('Click to choose diagnoses to justify.'); ?>;\n     var fee_sheet_options = [];\n-    var diag_code_types = <?php echo diag_code_types('json');?>;  // This is a list of diagnosis code types to present for as options in the justify dialog, for now, only \"internal codes\" included.\n+    // This is a list of diagnosis code types to present for as options in the justify dialog,\n+    // for now, only \"internal codes\" included.\n+    var diag_code_types = <?php echo diag_code_types('json');?>;\n     var ippf_specific = <?php echo $GLOBALS['ippf_specific'] ? 'true' : 'false'; ?>;\n+    var csrf_token_js = <?php echo js_escape(CsrfUtils::collectCsrfToken()); ?>;\n </script>\n <script>\n     function fee_sheet_option(code,code_type,description,fee)"
        },
        {
          "filename": "interface/forms/track_anything/create.php",
          "status": "modified",
          "additions": 5,
          "deletions": 5,
          "patch": "@@ -132,11 +132,11 @@\n // user clicked some buttons...\n $the_item = isset($_POST['typeid']) ? trim($_POST['typeid']) : '';\n if ($the_item) {\n-    $add        = $_POST['add'];\n-    $edit       = $_POST['edit'];\n-    $delete     = $_POST['delete'];\n-    $deactivate = $_POST['deact'];\n-    $activate   = $_POST['act'];\n+    $add        = $_POST['add'] ?? null;\n+    $edit       = $_POST['edit'] ?? null;\n+    $delete     = $_POST['delete'] ?? null;\n+    $deactivate = $_POST['deact'] ?? null;\n+    $activate   = $_POST['act'] ?? null;\n \n     // add a new item to track\n     //------------------------"
        },
        {
          "filename": "interface/forms/track_anything/history.php",
          "status": "modified",
          "additions": 18,
          "deletions": 6,
          "patch": "@@ -19,22 +19,22 @@\n use OpenEMR\\Core\\Header;\n \n $returnurl = 'encounter_top.php';\n-if (!$formid) {\n-    $formid = $_POST['formid']; // call from track_anything encounter\n+if (empty($formid)) {\n+    $formid = $_POST['formid'] ?? null; // call from track_anything encounter\n     $fromencounter = 1;\n     if (!$formid) {\n         $formid = $_GET['formid']; // call from demographic-widget \"track_anything_fragement.php\"\n         $fromencounter = 0;\n     }\n }\n \n-if ($_POST['fromencounter'] != '') {\n+if (!empty($_POST['fromencounter'])) {\n     $fromencounter = $_POST['fromencounter'];\n }\n \n // get $_POSTed vars\n //----------------------\n-$ASC_DESC = $_POST['ASC_DESC'];\n+$ASC_DESC = $_POST['ASC_DESC'] ?? null;\n \n if (!$ASC_DESC) {\n     $ASC_DESC = \"DESC\"; # order DESC by default\n@@ -71,6 +71,9 @@\n \n <?php Header::setupHeader('dygraphs'); ?>\n \n+<title><?php echo xlt('Tracker')?></title>\n+\n+\n <link rel=\"stylesheet\" href=\"style.css\">\n \n <script>\n@@ -305,8 +308,17 @@ function plot_graph(checkedBoxes, theitems, thetrack, thedates, thevalues, track\n         echo \"<td class='check'>\";\n         for ($row_b = 0; $row_b < $row_lc; $row_b++) {\n             if (is_numeric($value_local[$col_i][$row_b])) {\n-                $localplot_c[$col_i]++; // count more than 1 to show graph-button\n-                $globalplot_c[$col_i]++;\n+                if (empty($localplot_c[$col_i])) {\n+                    $localplot_c[$col_i] = 1;\n+                } else {\n+                    $localplot_c[$col_i]++; // count more than 1 to show graph-button\n+                }\n+\n+                if (empty($globalplot_c[$col_i])) {\n+                    $globalplot_c[$col_i] = 1;\n+                } else {\n+                    $globalplot_c[$col_i]++;\n+                }\n             }\n         }\n "
        },
        {
          "filename": "interface/forms/track_anything/new.php",
          "status": "modified",
          "additions": 9,
          "deletions": 9,
          "patch": "@@ -26,14 +26,14 @@\n }\n \n // get vars posted by FORMs\n-if (!$formid) {\n-    $formid = $_GET['id'];\n+if (empty($formid)) {\n+    $formid = $_GET['id'] ?? null;\n     if (!$formid) {\n-        $formid = $_POST['formid'];\n+        $formid = $_POST['formid'] ?? null;\n     }\n }\n \n-$myprocedureid =  $_POST['procedure2track'];\n+$myprocedureid =  $_POST['procedure2track'] ?? null;\n \n echo \"<html><head>\";\n ?>\n@@ -60,7 +60,7 @@\n     // this is a new Track\n \n     // check if procedure is selcted\n-    if ($_POST['bn_select']) {\n+    if ($_POST['bn_select'] ?? null) {\n         // \"save\"-Button was clicked, saving Form into db\n \n         // save inbto db\n@@ -119,7 +119,7 @@\n     // this is an existing Track\n     //----------------------------------------------------\n     // get submitted item-Ids\n-    $mylist = $_POST['liste'];\n+    $mylist = $_POST['liste'] ?? null;\n     #echo $mylist;\n     $length = count($mylist ?? []);\n     $thedate = $_POST['datetime'] ?? null;\n@@ -156,9 +156,9 @@\n     // ---------------------------\n \n     // getting old entries from <form>\n-    $old_id     = $_POST['old_id'];\n-    $old_time   = $_POST['old_time'];\n-    $old_value  = $_POST['old_value'];\n+    $old_id     = $_POST['old_id'] ?? null;\n+    $old_time   = $_POST['old_time'] ?? null;\n+    $old_value  = $_POST['old_value'] ?? null;\n \n     $how_many = count($old_time ?? []);\n     // do this for each data row"
        },
        {
          "filename": "interface/forms/vitals/C_FormVitals.class.php",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -295,7 +295,7 @@ public function default_action()\n             $vitalsHistoryLookback = array_slice($results, 0, $maxHistoryCols);\n             $hasMoreVitals = true;\n         } else {\n-            $vitalsHistoryLookback = $results;\n+            $vitalsHistoryLookback = $results ?? null;\n         }\n \n         $data = [\n@@ -450,7 +450,7 @@ public function populate_object(&$obj)\n \n                 if (empty($value)) {\n                     $details->clear_interpretation();\n-                } else if (isset($interpretationList[$value])) {\n+                } elseif (isset($interpretationList[$value])) {\n                     $interpretation = $interpretationList[$value];\n \n                     // we save off both the code and the text value here which duplicates the data.  However, since"
        },
        {
          "filename": "interface/forms/vitals/growthchart/chart.php",
          "status": "modified",
          "additions": 192,
          "deletions": 188,
          "patch": "@@ -403,7 +403,7 @@ function convertpoint($coord)\n }\n \n \n-if ($_GET['html'] == 1) {\n+if ($_GET['html'] ?? null == 1) {\n     //build the html css page if selected\n     cssHeader();\n     cssPage($chartCss1, $chartCss2);\n@@ -419,6 +419,163 @@ function convertpoint($coord)\n \n     // plot the data points\n     foreach ($datapoints as $data) {\n+        if (!empty($data)) {\n+            list($date, $height, $weight, $head_circ) = explode('-', $data);\n+            if ($date == \"\") {\n+                continue;\n+            }\n+\n+            // only plot if we have both weight and heights. Skip if either is 0.\n+            // Rational is only well visit will need both, sick visit only needs weight\n+            // for some clinic.\n+            if ($weight == 0 || $height == 0) {\n+                continue;\n+            }\n+\n+            // get age of patient at this data-point\n+            // to get data from function getPatientAgeYMD including $age,$age_in_months, $ageinYMD\n+            extract(getPatientAgeYMD($dob, $date));\n+            if ($charttype == 'birth') {\n+                // for birth style chart, we use the age in months\n+                $age = $age_in_months;\n+            }\n+\n+            // exclude data points that do not belong on this chart\n+            // for example, a data point for a 18 month old can be excluded\n+            // from that patient's 2-20 yr chart\n+            $daysold = getPatientAgeInDays($dob, $date);\n+            if ($daysold >= (365 * 2) && $charttype == \"birth\") {\n+                continue;\n+            }\n+\n+            if ($daysold <= (365 * 2) && $charttype == \"2-20\") {\n+                continue;\n+            }\n+\n+            // calculate the x-axis (Age) value\n+            $x = $dot_x + $delta_x * ($age - $ageOffset);\n+\n+            // Draw Height dot\n+            $y1 = $dot_y1 - $delta_y1 * ((int) $height - $heightOffset);\n+            $point = convertpoint(array($x,$y1));\n+            echo(\"<div id='\" . attr($point[2]) . \"' class='graphic' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'><img src='reddot.gif' /></div>\\n\");\n+\n+            // Draw Weight bullseye\n+            $y2 = $dot_y2 - $delta_y2 * ((int) $weight - $weightOffset);\n+            $point = convertpoint(array($x,$y2));\n+            echo(\"<div id='\" . attr($point[2]) . \"' class='graphic' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'><img src='redbox.gif' /></div>\\n\");\n+\n+            if ($charttype == \"birth\") {\n+                // Draw Head circumference\n+                $HC_x = $HC_dot_x + $HC_delta_x * $age;\n+                $HC_y = $HC_dot_y - $HC_delta_y * ((int) $head_circ - 11);\n+                $point = convertpoint(array($HC_x,$HC_y));\n+                echo(\"<div id='\" . attr($point[2]) . \"' class='graphic' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'><img src='bluedot.gif' /></div>\\n\");\n+                // Draw Wt and Ht graph at the bottom half\n+                $WT = $WT_y - $WT_delta_y * ((int) $weight - $WToffset);\n+                $HT = $HT_x + $HT_delta_x * ((int) $height - $HToffset);\n+                $point = convertpoint(array($HT,$WT));\n+                echo(\"<div id='\" . attr($point[2]) . \"' class='graphic' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'><img src='reddot.gif' /></div>\\n\");\n+            } elseif ($charttype == \"2-20\") {\n+                // Draw BMI\n+                $bmi = $weight / $height / $height * 703;\n+                $bmi_x = $bmi_dot_x + $bmi_delta_x * ($age - 2);\n+                $bmi_y = $bmi_dot_y - $bmi_delta_y * ($bmi - 10);\n+                $point = convertpoint(array($bmi_x,$bmi_y));\n+                echo(\"<div id='\" . attr($point[2]) . \"' class='graphic' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'><img src='bluedot.gif' /></div>\\n\");\n+            }\n+\n+            // fill in data tables\n+\n+            $datestr = substr($date, 0, 4) . \"/\" . substr($date, 4, 2) . \"/\" . substr($date, 6, 2);\n+\n+            //birth to 24 mos chart has 8 rows to fill.\n+            if ($count < 8 && $charttype == \"birth\") {\n+                $point = convertpoint(array($datatable_x,$datatable_y));\n+                echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text($datestr) . \"</div>\\n\");\n+                $point = convertpoint(array($datatable_x + $datatable_age_offset,$datatable_y));\n+                echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text($ageinYMD) . \"</div>\\n\");\n+                $point = convertpoint(array($datatable_x + $datatable_weight_offset,$datatable_y));\n+                echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text(unitsWt($weight)) . \"</div>\\n\");\n+                $point = convertpoint(array($datatable_x + $datatable_height_offset,$datatable_y));\n+                echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text(unitsDist($height)) . \"</div>\\n\");\n+                $point = convertpoint(array($datatable_x + $datatable_hc_offset,$datatable_y));\n+                echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text(unitsDist($head_circ)) . \"</div>\\n\");\n+                $datatable_y = $datatable_y + $datatable_y_increment; // increment the datatable \"row pointer\"\n+            }\n+\n+            // 2 to 20 year-old chart has 7 rows to fill.\n+            if ($count < 7  && $charttype == \"2-20\") {\n+                $point = convertpoint(array($datatable_x,$datatable_y));\n+                echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text($datestr) . \"</div>\\n\");\n+                $point = convertpoint(array($datatable_x + $datatable_age_offset,$datatable_y));\n+                echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text($ageinYMD) . \"</div>\\n\");\n+                $point = convertpoint(array($datatable_x + $datatable_weight_offset,$datatable_y));\n+                echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text(unitsWt($weight)) . \"</div>\\n\");\n+                $point = convertpoint(array($datatable_x + $datatable_height_offset,$datatable_y));\n+                echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text(unitsDist($height)) . \"</div>\\n\");\n+                $point = convertpoint(array($datatable_x + $datatable_bmi_offset,$datatable_y));\n+                echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text(substr($bmi, 0, 5)) . \"</div>\\n\");\n+                $datatable_y = $datatable_y + $datatable_y_increment; // increment the datatable \"row pointer\"\n+            }\n+\n+            // Head Circumference chart has 5 rows to fill in\n+            if ($count < 5 && $charttype == \"birth\") {\n+                $point = convertpoint(array($datatable2_x,$datatable2_y));\n+                echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text($datestr) . \"</div>\\n\");\n+                $point = convertpoint(array($datatable2_x + $datatable2_age_offset,$datatable2_y));\n+                echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text($ageinYMD) . \"</div>\\n\");\n+                $point = convertpoint(array($datatable2_x + $datatable2_weight_offset,$datatable2_y));\n+                echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text(unitsWt($weight)) . \"</div>\\n\");\n+                $point = convertpoint(array($datatable2_x + $datatable2_height_offset,$datatable2_y));\n+                echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text(unitsDist($height)) . \"</div>\\n\");\n+                $point = convertpoint(array($datatable2_x + $datatable2_hc_offset,$datatable2_y));\n+                echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text(unitsDist($head_circ)) . \"</div>\\n\");\n+                $datatable2_y = $datatable2_y + $datatable2_y_increment; // increment the datatable2 \"row pointer\"\n+            }\n+\n+            // BMI chart has 14 rows to fill in.\n+            if ($count < 14 && $charttype == \"2-20\") {\n+                $point = convertpoint(array($datatable2_x,$datatable2_y));\n+                echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text($datestr) . \"</div>\\n\");\n+                $point = convertpoint(array($datatable2_x + $datatable2_age_offset,$datatable2_y));\n+                echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text($ageinYMD) . \"</div>\\n\");\n+                $point = convertpoint(array($datatable2_x + $datatable2_weight_offset,$datatable2_y));\n+                echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text(unitsWt($weight)) . \"</div>\\n\");\n+                $point = convertpoint(array($datatable2_x + $datatable2_height_offset,$datatable2_y));\n+                echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text(unitsDist($height)) . \"</div>\\n\");\n+                $point = convertpoint(array($datatable2_x + $datatable2_bmi_offset,$datatable2_y));\n+                echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text(substr($bmi, 0, 5)) . \"</div>\\n\");\n+                $datatable2_y = $datatable2_y + $datatable2_y_increment; // increment the datatable2 \"row pointer\"\n+            }\n+\n+            $count++;\n+        }\n+    }\n+\n+    cssFooter();\n+    exit;\n+}\n+\n+// Done creating CSS HTML output\n+/******************************/\n+\n+\n+// create the graph\n+$im     = imagecreatefrompng($chartpath . $chart);\n+$color1 = imagecolorallocate($im, 0, 0, 255); //blue - color scheme imagecolorallocate($im, Red, Green, Blue)\n+$color  = imagecolorallocate($im, 255, 51, 51); //red\n+\n+// draw the patient's name\n+imagestring($im, 12, $name_x, $name_y, $name, $color);\n+imagestring($im, 12, $name_x1, $name_y1, $name, $color);\n+\n+// counter to limit the number of data points plotted\n+$count = 0;\n+\n+// plot the data points\n+foreach ($datapoints as $data) {\n+    if (!empty($data)) {\n         list($date, $height, $weight, $head_circ) = explode('-', $data);\n         if ($date == \"\") {\n             continue;\n@@ -432,7 +589,7 @@ function convertpoint($coord)\n         }\n \n         // get age of patient at this data-point\n-        // to get data from function getPatientAgeYMD including $age,$age_in_months, $ageinYMD\n+        // to get data from function getPatientAgeYMD including $age, $ageinYMD, $age_in_months\n         extract(getPatientAgeYMD($dob, $date));\n         if ($charttype == 'birth') {\n             // for birth style chart, we use the age in months\n@@ -443,45 +600,41 @@ function convertpoint($coord)\n         // for example, a data point for a 18 month old can be excluded\n         // from that patient's 2-20 yr chart\n         $daysold = getPatientAgeInDays($dob, $date);\n-        if ($daysold >= (365 * 2) && $charttype == \"birth\") {\n+        if ($daysold > (365 * 2) && $charttype == \"birth\") {\n             continue;\n         }\n \n-        if ($daysold <= (365 * 2) && $charttype == \"2-20\") {\n+        if ($daysold < (365 * 2) && $charttype == \"2-20\") {\n             continue;\n         }\n \n         // calculate the x-axis (Age) value\n         $x = $dot_x + $delta_x * ($age - $ageOffset);\n \n         // Draw Height dot\n-        $y1 = $dot_y1 - $delta_y1 * ($height - $heightOffset);\n-        $point = convertpoint(array($x,$y1));\n-        echo(\"<div id='\" . attr($point[2]) . \"' class='graphic' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'><img src='reddot.gif' /></div>\\n\");\n+        $y1 = $dot_y1 - $delta_y1 * ((int) $height - $heightOffset);\n+        imagefilledellipse($im, (int) $x, (int) $y1, 10, 10, $color);\n \n         // Draw Weight bullseye\n-        $y2 = $dot_y2 - $delta_y2 * ($weight - $weightOffset);\n-        $point = convertpoint(array($x,$y2));\n-        echo(\"<div id='\" . attr($point[2]) . \"' class='graphic' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'><img src='redbox.gif' /></div>\\n\");\n+        $y2 = $dot_y2 - $delta_y2 * ((int) $weight - $weightOffset);\n+        imageellipse($im, (int) $x, (int) $y2, 12, 12, $color); // outter ring\n+        imagefilledellipse($im, (int) $x, (int) $y2, 5, 5, $color); //center dot\n \n         if ($charttype == \"birth\") {\n             // Draw Head circumference\n             $HC_x = $HC_dot_x + $HC_delta_x * $age;\n-            $HC_y = $HC_dot_y - $HC_delta_y * ($head_circ - 11);\n-            $point = convertpoint(array($HC_x,$HC_y));\n-            echo(\"<div id='\" . attr($point[2]) . \"' class='graphic' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'><img src='bluedot.gif' /></div>\\n\");\n+            $HC_y = $HC_dot_y - $HC_delta_y * ((int) $head_circ - 11);\n+            imagefilledellipse($im, $HC_x, $HC_y, 10, 10, $color1);\n             // Draw Wt and Ht graph at the bottom half\n-            $WT = $WT_y - $WT_delta_y * ($weight - $WToffset);\n-            $HT = $HT_x + $HT_delta_x * ($height - $HToffset);\n-            $point = convertpoint(array($HT,$WT));\n-            echo(\"<div id='\" . attr($point[2]) . \"' class='graphic' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'><img src='reddot.gif' /></div>\\n\");\n+            $WT = $WT_y - $WT_delta_y * ((int) $weight - $WToffset);\n+            $HT = $HT_x + $HT_delta_x * ((int) $height - $HToffset);\n+            imagefilledellipse($im, $HT, $WT, 10, 10, $color);\n         } elseif ($charttype == \"2-20\") {\n             // Draw BMI\n             $bmi = $weight / $height / $height * 703;\n             $bmi_x = $bmi_dot_x + $bmi_delta_x * ($age - 2);\n             $bmi_y = $bmi_dot_y - $bmi_delta_y * ($bmi - 10);\n-            $point = convertpoint(array($bmi_x,$bmi_y));\n-            echo(\"<div id='\" . attr($point[2]) . \"' class='graphic' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'><img src='bluedot.gif' /></div>\\n\");\n+            imagefilledellipse($im, (int) $bmi_x, (int) $bmi_y, 10, 10, $color1);\n         }\n \n         // fill in data tables\n@@ -490,195 +643,46 @@ function convertpoint($coord)\n \n         //birth to 24 mos chart has 8 rows to fill.\n         if ($count < 8 && $charttype == \"birth\") {\n-            $point = convertpoint(array($datatable_x,$datatable_y));\n-            echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text($datestr) . \"</div>\\n\");\n-            $point = convertpoint(array($datatable_x + $datatable_age_offset,$datatable_y));\n-            echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text($ageinYMD) . \"</div>\\n\");\n-            $point = convertpoint(array($datatable_x + $datatable_weight_offset,$datatable_y));\n-            echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text(unitsWt($weight)) . \"</div>\\n\");\n-            $point = convertpoint(array($datatable_x + $datatable_height_offset,$datatable_y));\n-            echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text(unitsDist($height)) . \"</div>\\n\");\n-            $point = convertpoint(array($datatable_x + $datatable_hc_offset,$datatable_y));\n-            echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text(unitsDist($head_circ)) . \"</div>\\n\");\n+            imagestring($im, 2, $datatable_x, $datatable_y, $datestr, $color);\n+            imagestring($im, 2, ($datatable_x + $datatable_age_offset), $datatable_y, $ageinYMD, $color);\n+            imagestring($im, 2, ($datatable_x + $datatable_weight_offset), $datatable_y, unitsWt($weight), $color);\n+            imagestring($im, 2, ($datatable_x + $datatable_height_offset), $datatable_y, unitsDist($height), $color);\n+            imagestring($im, 2, ($datatable_x + $datatable_hc_offset), $datatable_y, unitsDist($head_circ), $color);\n             $datatable_y = $datatable_y + $datatable_y_increment; // increment the datatable \"row pointer\"\n         }\n \n         // 2 to 20 year-old chart has 7 rows to fill.\n         if ($count < 7  && $charttype == \"2-20\") {\n-            $point = convertpoint(array($datatable_x,$datatable_y));\n-            echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text($datestr) . \"</div>\\n\");\n-            $point = convertpoint(array($datatable_x + $datatable_age_offset,$datatable_y));\n-            echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text($ageinYMD) . \"</div>\\n\");\n-            $point = convertpoint(array($datatable_x + $datatable_weight_offset,$datatable_y));\n-            echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text(unitsWt($weight)) . \"</div>\\n\");\n-            $point = convertpoint(array($datatable_x + $datatable_height_offset,$datatable_y));\n-            echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text(unitsDist($height)) . \"</div>\\n\");\n-            $point = convertpoint(array($datatable_x + $datatable_bmi_offset,$datatable_y));\n-            echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text(substr($bmi, 0, 5)) . \"</div>\\n\");\n+            imagestring($im, 2, $datatable_x, $datatable_y, $datestr, $color);\n+            imagestring($im, 2, ($datatable_x + $datatable_age_offset), $datatable_y, $ageinYMD, $color);\n+            imagestring($im, 2, ($datatable_x + $datatable_weight_offset), $datatable_y, unitsWt($weight), $color);\n+            imagestring($im, 2, ($datatable_x + $datatable_height_offset), $datatable_y, unitsDist($height), $color);\n+            imagestring($im, 2, ($datatable_x + $datatable_bmi_offset), $datatable_y, substr($bmi, 0, 5), $color);\n             $datatable_y = $datatable_y + $datatable_y_increment; // increment the datatable \"row pointer\"\n         }\n \n         // Head Circumference chart has 5 rows to fill in\n         if ($count < 5 && $charttype == \"birth\") {\n-            $point = convertpoint(array($datatable2_x,$datatable2_y));\n-            echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text($datestr) . \"</div>\\n\");\n-            $point = convertpoint(array($datatable2_x + $datatable2_age_offset,$datatable2_y));\n-            echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text($ageinYMD) . \"</div>\\n\");\n-            $point = convertpoint(array($datatable2_x + $datatable2_weight_offset,$datatable2_y));\n-            echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text(unitsWt($weight)) . \"</div>\\n\");\n-            $point = convertpoint(array($datatable2_x + $datatable2_height_offset,$datatable2_y));\n-            echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text(unitsDist($height)) . \"</div>\\n\");\n-            $point = convertpoint(array($datatable2_x + $datatable2_hc_offset,$datatable2_y));\n-            echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text(unitsDist($head_circ)) . \"</div>\\n\");\n+            imagestring($im, 2, $datatable2_x, $datatable2_y, $datestr, $color);\n+            imagestring($im, 2, ($datatable2_x + $datatable2_age_offset), $datatable2_y, $ageinYMD, $color);\n+            imagestring($im, 2, ($datatable2_x + $datatable2_weight_offset), $datatable2_y, unitsWt($weight), $color);\n+            imagestring($im, 2, ($datatable2_x + $datatable2_height_offset), $datatable2_y, unitsDist($height), $color);\n+            imagestring($im, 2, ($datatable2_x + $datatable2_hc_offset), $datatable2_y, unitsDist($head_circ), $color);\n             $datatable2_y = $datatable2_y + $datatable2_y_increment; // increment the datatable2 \"row pointer\"\n         }\n \n         // BMI chart has 14 rows to fill in.\n         if ($count < 14 && $charttype == \"2-20\") {\n-            $point = convertpoint(array($datatable2_x,$datatable2_y));\n-            echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text($datestr) . \"</div>\\n\");\n-            $point = convertpoint(array($datatable2_x + $datatable2_age_offset,$datatable2_y));\n-            echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text($ageinYMD) . \"</div>\\n\");\n-            $point = convertpoint(array($datatable2_x + $datatable2_weight_offset,$datatable2_y));\n-            echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text(unitsWt($weight)) . \"</div>\\n\");\n-            $point = convertpoint(array($datatable2_x + $datatable2_height_offset,$datatable2_y));\n-            echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text(unitsDist($height)) . \"</div>\\n\");\n-            $point = convertpoint(array($datatable2_x + $datatable2_bmi_offset,$datatable2_y));\n-            echo(\"<div id='\" . attr($point[2]) . \"' class='label_custom' style='position: absolute; top: \" . attr($point[1]) . \"pt; left: \" . attr($point[0]) . \"pt;'>\" . text(substr($bmi, 0, 5)) . \"</div>\\n\");\n+            imagestring($im, 2, $datatable2_x, $datatable2_y, $datestr, $color);\n+            imagestring($im, 2, ($datatable2_x + $datatable2_age_offset), $datatable2_y, $ageinYMD, $color);\n+            imagestring($im, 2, ($datatable2_x + $datatable2_weight_offset), $datatable2_y, unitsWt($weight), $color);\n+            imagestring($im, 2, ($datatable2_x + $datatable2_height_offset), $datatable2_y, unitsDist($height), $color);\n+            imagestring($im, 2, ($datatable2_x + $datatable2_bmi_offset), $datatable2_y, substr($bmi, 0, 5), $color);\n             $datatable2_y = $datatable2_y + $datatable2_y_increment; // increment the datatable2 \"row pointer\"\n         }\n \n         $count++;\n     }\n-\n-    cssFooter();\n-    exit;\n-}\n-\n-// Done creating CSS HTML output\n-/******************************/\n-\n-\n-// create the graph\n-$im     = imagecreatefrompng($chartpath . $chart);\n-$color1 = imagecolorallocate($im, 0, 0, 255); //blue - color scheme imagecolorallocate($im, Red, Green, Blue)\n-$color  = imagecolorallocate($im, 255, 51, 51); //red\n-\n-// draw the patient's name\n-imagestring($im, 12, $name_x, $name_y, $name, $color);\n-imagestring($im, 12, $name_x1, $name_y1, $name, $color);\n-\n-// counter to limit the number of data points plotted\n-$count = 0;\n-\n-// plot the data points\n-foreach ($datapoints as $data) {\n-    list($date, $height, $weight, $head_circ) = explode('-', $data);\n-    if ($date == \"\") {\n-        continue;\n-    }\n-\n-    // only plot if we have both weight and heights. Skip if either is 0.\n-    // Rational is only well visit will need both, sick visit only needs weight\n-    // for some clinic.\n-    if ($weight == 0 || $height == 0) {\n-        continue;\n-    }\n-\n-    // get age of patient at this data-point\n-    // to get data from function getPatientAgeYMD including $age, $ageinYMD, $age_in_months\n-    extract(getPatientAgeYMD($dob, $date));\n-    if ($charttype == 'birth') {\n-        // for birth style chart, we use the age in months\n-        $age = $age_in_months;\n-    }\n-\n-    // exclude data points that do not belong on this chart\n-    // for example, a data point for a 18 month old can be excluded\n-    // from that patient's 2-20 yr chart\n-    $daysold = getPatientAgeInDays($dob, $date);\n-    if ($daysold > (365 * 2) && $charttype == \"birth\") {\n-        continue;\n-    }\n-\n-    if ($daysold < (365 * 2) && $charttype == \"2-20\") {\n-        continue;\n-    }\n-\n-    // calculate the x-axis (Age) value\n-    $x = $dot_x + $delta_x * ($age - $ageOffset);\n-\n-    // Draw Height dot\n-    $y1 = $dot_y1 - $delta_y1 * ($height - $heightOffset);\n-    imagefilledellipse($im, $x, $y1, 10, 10, $color);\n-\n-    // Draw Weight bullseye\n-    $y2 = $dot_y2 - $delta_y2 * ($weight - $weightOffset);\n-    imageellipse($im, $x, $y2, 12, 12, $color); // outter ring\n-    imagefilledellipse($im, $x, $y2, 5, 5, $color); //center dot\n-\n-    if ($charttype == \"birth\") {\n-        // Draw Head circumference\n-        $HC_x = $HC_dot_x + $HC_delta_x * $age;\n-        $HC_y = $HC_dot_y - $HC_delta_y * ($head_circ - 11);\n-        imagefilledellipse($im, $HC_x, $HC_y, 10, 10, $color1);\n-        // Draw Wt and Ht graph at the bottom half\n-        $WT = $WT_y - $WT_delta_y * ($weight - $WToffset);\n-        $HT = $HT_x + $HT_delta_x * ($height - $HToffset);\n-        imagefilledellipse($im, $HT, $WT, 10, 10, $color);\n-    } elseif ($charttype == \"2-20\") {\n-        // Draw BMI\n-        $bmi = $weight / $height / $height * 703;\n-        $bmi_x = $bmi_dot_x + $bmi_delta_x * ($age - 2);\n-        $bmi_y = $bmi_dot_y - $bmi_delta_y * ($bmi - 10);\n-        imagefilledellipse($im, $bmi_x, $bmi_y, 10, 10, $color1);\n-    }\n-\n-    // fill in data tables\n-\n-    $datestr = substr($date, 0, 4) . \"/\" . substr($date, 4, 2) . \"/\" . substr($date, 6, 2);\n-\n-    //birth to 24 mos chart has 8 rows to fill.\n-    if ($count < 8 && $charttype == \"birth\") {\n-        imagestring($im, 2, $datatable_x, $datatable_y, $datestr, $color);\n-        imagestring($im, 2, ($datatable_x + $datatable_age_offset), $datatable_y, $ageinYMD, $color);\n-        imagestring($im, 2, ($datatable_x + $datatable_weight_offset), $datatable_y, unitsWt($weight), $color);\n-        imagestring($im, 2, ($datatable_x + $datatable_height_offset), $datatable_y, unitsDist($height), $color);\n-        imagestring($im, 2, ($datatable_x + $datatable_hc_offset), $datatable_y, unitsDist($head_circ), $color);\n-        $datatable_y = $datatable_y + $datatable_y_increment; // increment the datatable \"row pointer\"\n-    }\n-\n-    // 2 to 20 year-old chart has 7 rows to fill.\n-    if ($count < 7  && $charttype == \"2-20\") {\n-        imagestring($im, 2, $datatable_x, $datatable_y, $datestr, $color);\n-        imagestring($im, 2, ($datatable_x + $datatable_age_offset), $datatable_y, $ageinYMD, $color);\n-        imagestring($im, 2, ($datatable_x + $datatable_weight_offset), $datatable_y, unitsWt($weight), $color);\n-        imagestring($im, 2, ($datatable_x + $datatable_height_offset), $datatable_y, unitsDist($height), $color);\n-        imagestring($im, 2, ($datatable_x + $datatable_bmi_offset), $datatable_y, substr($bmi, 0, 5), $color);\n-        $datatable_y = $datatable_y + $datatable_y_increment; // increment the datatable \"row pointer\"\n-    }\n-\n-    // Head Circumference chart has 5 rows to fill in\n-    if ($count < 5 && $charttype == \"birth\") {\n-        imagestring($im, 2, $datatable2_x, $datatable2_y, $datestr, $color);\n-        imagestring($im, 2, ($datatable2_x + $datatable2_age_offset), $datatable2_y, $ageinYMD, $color);\n-        imagestring($im, 2, ($datatable2_x + $datatable2_weight_offset), $datatable2_y, unitsWt($weight), $color);\n-        imagestring($im, 2, ($datatable2_x + $datatable2_height_offset), $datatable2_y, unitsDist($height), $color);\n-        imagestring($im, 2, ($datatable2_x + $datatable2_hc_offset), $datatable2_y, unitsDist($head_circ), $color);\n-        $datatable2_y = $datatable2_y + $datatable2_y_increment; // increment the datatable2 \"row pointer\"\n-    }\n-\n-    // BMI chart has 14 rows to fill in.\n-    if ($count < 14 && $charttype == \"2-20\") {\n-        imagestring($im, 2, $datatable2_x, $datatable2_y, $datestr, $color);\n-        imagestring($im, 2, ($datatable2_x + $datatable2_age_offset), $datatable2_y, $ageinYMD, $color);\n-        imagestring($im, 2, ($datatable2_x + $datatable2_weight_offset), $datatable2_y, unitsWt($weight), $color);\n-        imagestring($im, 2, ($datatable2_x + $datatable2_height_offset), $datatable2_y, unitsDist($height), $color);\n-        imagestring($im, 2, ($datatable2_x + $datatable2_bmi_offset), $datatable2_y, substr($bmi, 0, 5), $color);\n-        $datatable2_y = $datatable2_y + $datatable2_y_increment; // increment the datatable2 \"row pointer\"\n-    }\n-\n-    $count++;\n }\n \n if ($_GET['pdf'] == 1) {"
        },
        {
          "filename": "interface/forms/vitals/templates/vitals/vitals.html.twig",
          "status": "modified",
          "additions": 9,
          "deletions": 3,
          "patch": "@@ -52,6 +52,14 @@\n         <div class=\"col-sm-12\">\n             <form id=\"vitalsForm\" name=\"vitals\" method=\"post\" action=\"{{ FORM_ACTION|attr }}/interface/forms/vitals/save.php\">\n                 <input type=\"hidden\" name=\"csrf_token_form\" value=\"{{ CSRF_TOKEN_FORM|attr }}\" />\n+                <div class=\"row\">\n+                    <div class=\"col-md-auto p-3 font-weight-bold text-right\">\n+                        <label for=\"date\">{{ \"Date\"|xlt }}</label>\n+                    </div>\n+                    <div class=\"col-md-auto p-2\">\n+                        <input title=\"{{ 'Date and time of this observation'|xla }}\" type='text' size='14' class='form-control datetimepicker oe-patient-background' name='date' id='date' value='{{ vitals.get_date|dateToTime|date(\"Y-m-d H:i\")|attr }}' />\n+                    </div>\n+                </div>\n                 <div id=\"chart\" class=\"chart-dygraphs\" style=\"margin-left: -15px\"></div>\n                     <div class=\"table-responsive\">\n \n@@ -61,9 +69,7 @@\n                                 <tr>\n                                     <th class=\"text-left\"><span class=\"vitals-title\">{{ \"Name\"|xlt }}</span></th>\n                                     <th class=\"text-left\">{{ \"Unit\"|xlt }}</th>\n-                                    <th class='currentvalues p-2' title=\"{{ 'Date and time of this observation'|xla }}\">\n-                                        <input type='text' size='14' class='form-control datetimepicker oe-patient-background' name='date' id='date' value='{{ vitals.get_date|dateToTime|date(\"Y-m-d H:i\")|attr }}' />\n-                                    </th>\n+                                    <th class=\"editonly\">{{ \"Value\"|xlt }}</th>\n                                     <th class=\"editonly\">{{ \"Abn\"|xlt }}</th>\n                                     <th class=\"editonly\">{{ \"Actions\"|xlt }}</th>\n                                     {% for result in vitalsHistoryLookback %}"
        },
        {
          "filename": "interface/patient_file/printed_fee_sheet.php",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -356,9 +356,9 @@ function printlog_before_print() {\n $logo = '';\n $ma_logo_path = \"sites/\" . $_SESSION['site_id'] . \"/images/ma_logo.png\";\n if (is_file(\"$webserver_root/$ma_logo_path\")) {\n-    $logo = \"<img src='$web_root/$ma_logo_path' style='height:\" . round(9 * 5.14) . \"pt' />\";\n+    $logo = \"$web_root/$ma_logo_path\";\n } else {\n-    $logo = \"<!-- '$ma_logo_path' does not exist. -->\";\n+    $logo = \"\";\n }\n \n // Loop on array of PIDS"
        },
        {
          "filename": "interface/patient_file/report/custom_report.php",
          "status": "modified",
          "additions": 11,
          "deletions": 22,
          "patch": "@@ -63,10 +63,10 @@\n         'default_font' => 'dejavusans',\n         'margin_left' => $GLOBALS['pdf_left_margin'],\n         'margin_right' => $GLOBALS['pdf_right_margin'],\n-        'margin_top' => $GLOBALS['pdf_top_margin'],\n-        'margin_bottom' => $GLOBALS['pdf_bottom_margin'],\n-        'margin_header' => '',\n-        'margin_footer' => '',\n+        'margin_top' => $GLOBALS['pdf_top_margin'] * 1.5,\n+        'margin_bottom' => $GLOBALS['pdf_bottom_margin'] * 1.5,\n+        'margin_header' => $GLOBALS['pdf_top_margin'],\n+        'margin_footer' => $GLOBALS['pdf_bottom_margin'],\n         'orientation' => $GLOBALS['pdf_layout'],\n         'shrink_tables_to_fit' => 1,\n         'use_kwt' => true,\n@@ -235,10 +235,8 @@ function zip_content($source, $destination, $content = '', $create = true)\n \n             if ($printable) {\n                 /*******************************************************************\n-                 * $titleres = getPatientData($pid, \"fname,lname,providerID\");\n                  * $sql = \"SELECT * FROM facility ORDER BY billing_location DESC LIMIT 1\";\n                  *******************************************************************/\n-                $titleres = getPatientData($pid, \"fname,lname,providerID,DATE_FORMAT(DOB,'%m/%d/%Y') as DOB_TS\");\n                 $facility = null;\n                 if ($_SESSION['pc_facility']) {\n                     $facility = $facilityService->getById($_SESSION['pc_facility']);\n@@ -248,9 +246,9 @@ function zip_content($source, $destination, $content = '', $create = true)\n \n                 /******************************************************************/\n                 // Setup Headers and Footers for mPDF only Download\n-                // in HTML view it's just one line at the top of page 1\n-                echo '<page_header class=\"custom-tag text-right\"> ' . xlt(\"PATIENT\") . ':' . text($titleres['lname']) . ', ' . text($titleres['fname']) . ' - ' . text($titleres['DOB_TS']) . '</page_header>    ';\n-                echo '<page_footer class=\"custom-tag text-right\">' . xlt('Generated on') . ' ' . text(oeFormatShortDate()) . ' - ' . text($facility['name']) . ' ' . text($facility['phone']) . '</page_footer>';\n+                if ($PDF_OUTPUT) {\n+                    echo genPatientHeaderFooter($pid);\n+                }\n \n                 // Use logo if it exists as 'practice_logo.gif' in the site dir\n                 // old code used the global custom dir which is no longer a valid\n@@ -262,21 +260,12 @@ function zip_content($source, $destination, $content = '', $create = true)\n                     $practice_logo = $plogo[$k];\n                 }\n \n-                echo \"<div class='table-responsive'><table class='table'><tbody><tr><td>\";\n+                $logo = \"\";\n                 if (file_exists($practice_logo)) {\n-                    $logo_path = $GLOBALS['OE_SITE_WEBROOT'] . \"/images/\" . basename($practice_logo);\n-                    echo \"<img class='h-auto' style='max-width:250px;' src='$logo_path'>\"; // keep size within reason\n-                    echo \"</td><td>\";\n+                    $logo = $GLOBALS['OE_SITE_WEBROOT'] . \"/images/\" . basename($practice_logo);\n                 }\n-                ?>\n-                <h5><?php echo text($facility['name']); ?></h5>\n-                <?php echo text($facility['street']); ?><br />\n-                <?php echo text($facility['city']); ?>, <?php echo text($facility['state']); ?><?php echo text($facility['postal_code']); ?><br clear='all'>\n-                <?php echo text($facility['phone']); ?><br />\n-\n-                <a href=\"javascript:window.close();\"><span class='title'><?php echo xlt('Patient') . \": \" . text($titleres['fname']) . \" \" . text($titleres['lname']); ?></span></a><br />\n-                <span class='text'><?php echo xlt('Generated on'); ?>: <?php echo text(oeFormatShortDate()); ?></span>\n-                <?php echo \"</td></tr></tbody></table></div>\"; ?>\n+\n+                echo genFacilityTitle(getPatientName($pid), $_SESSION['pc_facility'], $logo);?>\n \n             <?php } else { // not printable\n                 ?>"
        },
        {
          "filename": "interface/patient_file/summary/create_portallogin.php",
          "status": "modified",
          "additions": 32,
          "deletions": 8,
          "patch": "@@ -10,19 +10,28 @@\n  * @author    Paul Simon <paul@zhservices.com>\n  * @author    Brady Miller <brady.g.miller@gmail.com>\n  * @author    Tyler Wrenn <tyler@tylerwrenn.com>\n+ * @author    Stephen Nielson <snielson@discoverandchange.com>\n+ * @author    Stephen Waite <stephen.waite@open-emr.org\n  * @copyright Copyright (c) 2011 Z&H Consultancy Services Private Limited <sam@zhservices.com>\n  * @copyright Copyright (c) 2018-2019 Brady Miller <brady.g.miller@gmail.com>\n  * @copyright Copyright (c) 2020 Tyler Wrenn <tyler@tylerwrenn.com>\n+ * @copyright Copyright (c) 2022 Discover and Change, Inc <snielson@discoverandchange.com>\n+ * @copyright Copyright (c) 2022 Stephen Waite <stephen.waite@open-emr.org\n  * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n  */\n \n require_once(\"../../globals.php\");\n require_once('../../../library/amc.php');\n \n-use OpenEMR\\Common\\Auth\\AuthHash;\n-use OpenEMR\\Common\\Csrf\\CsrfUtils;\n-use OpenEMR\\Common\\Twig\\TwigContainer;\n-use OpenEMR\\Common\\Utils\\RandomGenUtils;\n+use OpenEMR\\Common\\ {\n+    Auth\\AuthHash,\n+    Csrf\\CsrfUtils,\n+    Logging\\EventAuditLogger,\n+    Twig\\TwigContainer,\n+    Utils\\RandomGenUtils,\n+};\n+use OpenEMR\\Events\\Patient\\Summary\\PortalCredentialsTemplateDataFilterEvent;\n+use OpenEMR\\Events\\Patient\\Summary\\PortalCredentialsUpdatedEvent;\n use OpenEMR\\FHIR\\Config\\ServerConfig;\n use Twig\\Environment;\n \n@@ -122,13 +131,22 @@ function displayLogin($patient_id, $message, $emailFlag)\n         error_log('OpenEMR Error : OpenEMR is not working because unable to create a hash.');\n         die(\"OpenEMR Error : OpenEMR is not working because unable to create a hash.\");\n     }\n-    array_push($query_parameters, $hash);\n \n+    array_push($query_parameters, $hash);\n     array_push($query_parameters, $pid);\n+\n+    EventAuditLogger::instance()->newEvent(\n+        \"patient-access\",\n+        $_SESSION['authUser'],\n+        $_SESSION['authProvider'],\n+        1,\n+        \"updated credentials\",\n+        $pid,\n+        'open-emr',\n+        'dashboard'\n+    );\n     if (sqlNumRows($res)) {\n-        // TODO: @adunsulag is there a reason why we don't audit the fact that the patient credentials were created and updated?\n-        // That seems like a pretty important security event we want to be aware of.\n-        sqlStatementNoLog(\"UPDATE patient_access_onsite SET portal_username=?,portal_login_username=?,portal_pwd=?,portal_pwd_status=0 WHERE pid=?\", $query_parameters);\n+        sqlStatementNoLog(\"UPDATE patient_access_onsite SET portal_username=?, portal_login_username=?, portal_pwd=?, portal_pwd_status=0 WHERE pid=?\", $query_parameters);\n     } else {\n         sqlStatementNoLog(\"INSERT INTO patient_access_onsite SET portal_username=?,portal_login_username=?,portal_pwd=?,portal_pwd_status=0,pid=?\", $query_parameters);\n     }\n@@ -160,6 +178,12 @@ function displayLogin($patient_id, $message, $emailFlag)\n     // need to track that credentials were created\n } else {\n     $credMessage = '';\n+    if (\n+        empty($GLOBALS['enforce_signin_email'])\n+        && empty($row['portal_username'])\n+    ) {\n+        $trustedUserName = $row['fname'] . $row['id'];\n+    }\n }\n \n echo $twig->render('patient/portal_login/print.html.twig', ["
        },
        {
          "filename": "interface/patient_file/summary/demographics.php",
          "status": "modified",
          "additions": 73,
          "deletions": 28,
          "patch": "@@ -158,39 +158,85 @@ function get_document_by_catg($pid, $doc_catg)\n     return ($result['id'] ?? false);\n }\n \n-function portalAuthorized($pid)\n+function isPortalEnabled(): bool\n {\n-    if (!$GLOBALS['portal_onsite_two_enable'] && !$GLOBALS['portal_onsite_two_address']) {\n+    if (\n+        !$GLOBALS['portal_onsite_two_enable']\n+    ) {\n         return false;\n     }\n \n-    $return = [\n-        'isAllowed' => false\n-        ,'allowed' => [\n-                'api' => false\n-                ,'portal' => false\n-        ],\n-        'credentials' => [\n-                'created' => false\n-                ,'date' => null\n-        ]\n-    ];\n-\n-    $portalStatus = sqlQuery(\"SELECT allow_patient_portal,prevent_portal_apps FROM patient_data WHERE pid = ?\", [$pid]);\n-    $return['allowed']['portal'] = $portalStatus['allow_patient_portal'] == 'YES';\n-    $return['allowed']['api'] = strtoupper($portalStatus['prevent_portal_apps']) != 'YES';\n-    if ($return['allowed']['portal'] || $return['allowed']['api']) {\n-        $return['isAllowed'] = true;\n-        $portalLogin = sqlQuery(\"SELECT pid,date_created FROM `patient_access_onsite` WHERE `pid`=?\", [$pid]);\n-        if ($portalLogin) {\n-            $return['credentials']['date'] = $portalLogin['date_created'];\n-            $return['credentials']['created'] = true;\n-        }\n-        return $return;\n+    return true;\n+}\n+\n+function isPortalSiteAddressValid(): bool\n+{\n+    if (\n+        // maybe can use filter_var() someday but the default value in GLOBALS\n+        // fails with FILTER_VALIDATE_URL\n+        !isset($GLOBALS['portal_onsite_two_address'])\n+    ) {\n+        return false;\n+    }\n+\n+    return true;\n+}\n+\n+function isPortalAllowed($pid): bool\n+{\n+    $return = false;\n+\n+    $portalStatus = sqlQuery(\"SELECT allow_patient_portal FROM patient_data WHERE pid = ?\", [$pid]);\n+    if ($portalStatus['allow_patient_portal'] == 'YES') {\n+        $return = true;\n     }\n     return $return;\n }\n \n+function isApiAllowed($pid): bool\n+{\n+    $return = false;\n+\n+    $apiStatus = sqlQuery(\"SELECT prevent_portal_apps FROM patient_data WHERE pid = ?\", [$pid]);\n+    if (strtoupper($apiStatus['prevent_portal_apps'] ?? '') != 'YES') {\n+        $return = true;\n+    }\n+    return $return;\n+}\n+\n+function areCredentialsCreated($pid): bool\n+{\n+    $return = false;\n+    $credentialsCreated = sqlQuery(\"SELECT date_created FROM `patient_access_onsite` WHERE `pid`=?\", [$pid]);\n+    if ($credentialsCreated['date_created'] ?? null) {\n+        $return = true;\n+    }\n+\n+    return $return;\n+}\n+\n+function isContactEmail($pid): bool\n+{\n+    $return = false;\n+\n+    $email = sqlQuery(\"SELECT email, email_direct FROM patient_data WHERE pid = ?\", [$pid]);\n+    if (!empty($email['email']) || !empty($email['email_direct'])) {\n+        $return = true;\n+    }\n+    return $return;\n+}\n+\n+function isEnforceSigninEmailPortal(): bool\n+{\n+    if (\n+        $GLOBALS['enforce_signin_email']\n+    ) {\n+        return true;\n+    }\n+\n+    return false;\n+}\n+\n function deceasedDays($days_deceased)\n {\n     $deceased_days = intval($days_deceased['days_deceased'] ?? '');\n@@ -1325,9 +1371,8 @@ function setMyPatient() {\n                 <div class=\"col-md-4\">\n                     <!-- start right column div -->\n                     <?php\n-                    if ($GLOBALS['portal_onsite_two_enable']) :\n-                        $portalCard = new PortalCard($GLOBALS);\n-                    endif;\n+                    // it's important enough to always show it\n+                    $portalCard = new PortalCard($GLOBALS);\n \n                     $sectionRenderEvents = $ed->dispatch(SectionEvent::EVENT_HANDLE, new SectionEvent('secondary'));\n                     $sectionCards = $sectionRenderEvents->getCards();"
        },
        {
          "filename": "interface/patient_file/summary/demographics_print.php",
          "status": "modified",
          "additions": 2,
          "deletions": 3,
          "patch": "@@ -208,10 +208,9 @@\n $logo = '';\n $ma_logo_path = \"sites/\" . $_SESSION['site_id'] . \"/images/ma_logo.png\";\n if (is_file(\"$webserver_root/$ma_logo_path\")) {\n-    $logo = \"<img src='$web_root/$ma_logo_path' style='height:\" . round(9 * 5.14) . \"pt' />\";\n-} else {\n-    $logo = \"<!-- '$ma_logo_path' does not exist. -->\";\n+    $logo = \"$web_root/$ma_logo_path\";\n }\n+\n echo genFacilityTitle(xl('Registration Form'), -1, $logo);\n \n function end_cell()"
        },
        {
          "filename": "interface/patient_file/summary/track_anything_fragment.php",
          "status": "modified",
          "additions": 2,
          "deletions": 4,
          "patch": "@@ -32,8 +32,8 @@\n             \"AND formdir = ? \" .\n             \"GROUP BY form_name \" .\n             \"ORDER BY maxdate DESC \";\n-$result = sqlQuery($spell, array($pid, 'track_anything'));\n-if (!$result) { //If there are no disclosures recorded\n+$result = sqlStatement($spell, array($pid, 'track_anything'));\n+if (!sqlNumRows($result)) { //If there are no disclosures recorded\n     ?>\n   <span class='text'> <?php echo xlt(\"No tracks have been documented.\");\n     ?>\n@@ -42,9 +42,7 @@\n } else {  // We have some tracks here...\n     echo \"<span class='text'>\";\n     echo xlt('Available Tracks') . \":\";\n-    echo text($result);\n     echo \"<ul>\";\n-    $result = sqlStatement($spell, array($pid, 'track_anything'));\n     while ($myrow = sqlFetchArray($result)) {\n         $formname = $myrow['form_name'];\n         $thedate = $myrow['maxdate'];"
        },
        {
          "filename": "interface/patient_file/transaction/print_referral.php",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -151,10 +151,10 @@\n }\n \n // Generate link to MA logo if it exists.\n-$logo = \"<!-- '\" . ($ma_logo_path ?? '') . \"' does not exist. -->\";\n+$logo = \"\";\n $ma_logo_path = \"sites/\" . $_SESSION['site_id'] . \"/images/ma_logo.png\";\n if (is_file(\"$webserver_root/$ma_logo_path\")) {\n-    $logo = \"<img src='$web_root/$ma_logo_path' style='height:\" . round(9 * 5.14) . \"pt' />\";\n+    $logo = \"$web_root/$ma_logo_path\";\n }\n \n $s = '';"
        },
        {
          "filename": "interface/usergroup/facility_admin.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -237,7 +237,7 @@ function displayAlert() {\n                             <?php\n                                 $disabled = '';\n                                 $resPBE = $facilityService->getPrimaryBusinessEntity(array(\"excludedId\" => $my_fid));\n-                            if ($resPBE) {\n+                            if ($resPBE && ($GLOBALS['erx_enable'] ?? null)) {\n                                 $disabled = 'disabled';\n                             }\n                             ?>"
        },
        {
          "filename": "library/classes/X12Partner.class.php",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -237,7 +237,7 @@ function get_x12_isa02()\n \n     function set_x12_isa02($string)\n     {\n-            $this->x12_isa02 = $string;\n+            $this->x12_isa02 = str_pad($string, 10);\n     }\n \n     function get_x12_isa03()\n@@ -257,7 +257,7 @@ function get_x12_isa04()\n \n     function set_x12_isa04($string)\n     {\n-            $this->x12_isa04 = $string;\n+            $this->x12_isa04 = str_pad($string, 10);\n     }\n \n     function get_x12_isa05()"
        },
        {
          "filename": "library/clinical_rules.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -1192,7 +1192,7 @@ function test_rules_clinic($provider = '', $type = '', $dateTarget = '', $mode =\n                             // increment pass target counter\n                             $pass_target++;\n                             // If report itemization is turned on, then record the \"passed\" item and set the flag\n-                            if ($GLOBALS['report_itemizing_temp_flag_and_id']) {\n+                            if ($GLOBALS['report_itemizing_temp_flag_and_id'] ?? null) {\n                                 insertItemReportTracker($GLOBALS['report_itemizing_temp_flag_and_id'], $GLOBALS['report_itemized_test_id_iterator'], 1, $rowPatient['pid']);\n                                 $temp_track_pass = 1;\n                             }"
        },
        {
          "filename": "library/options.inc.php",
          "status": "modified",
          "additions": 3,
          "deletions": 0,
          "patch": "@@ -2427,6 +2427,9 @@ function generate_display_field($frow, $currvalue)\n     $field_id   = isset($frow['field_id'])  ? $frow['field_id'] : null;\n     $list_id    = $frow['list_id'];\n     $backup_list = isset($frow['list_backup_id']) ? $frow['list_backup_id'] : null;\n+    $show_unchecked_arr = array();\n+    getLayoutProperties($frow['form_id'] ?? null, $show_unchecked_arr, 'grp_unchecked', \"1\");\n+    $show_unchecked = strval($show_unchecked_arr['']['grp_unchecked'] ?? null) == \"0\" ? false : true;\n \n     $s = '';\n "
        },
        {
          "filename": "library/patient.inc",
          "status": "modified",
          "additions": 39,
          "deletions": 8,
          "patch": "@@ -194,18 +194,18 @@ function getFacility($facid = 0)\n // Generate a report title including report name and facility name, address\n // and phone.\n //\n-function genFacilityTitle($repname = '', $facid = 0, $logo = '')\n+function genFacilityTitle($repname = '', $facid = 0, $logo = \"\")\n {\n     $s = '';\n-    $s .= \"<table class='ftitletable'>\\n\";\n+    $s .= \"<table class='ftitletable' width='100%'>\\n\";\n     $s .= \" <tr>\\n\";\n     if (empty($logo)) {\n-        $s .= \"  <td class='ftitlecell1'>\" . text($repname) . \"</td>\\n\";\n+        $s .= \"  <td align='left' class='ftitlecell1'>\" . text($repname) . \"</td>\\n\";\n     } else {\n-        $s .= \"  <td class='ftitlecell1'>\" . $logo . \"</td>\\n\";\n-        $s .= \"  <td class='ftitlecellm'>\" . text($repname) . \"</td>\\n\";\n+        $s .= \"  <td align='left' class='ftitlecell1'><img class='h-auto' style='max-height:8%;' src='\" . attr($logo) . \"' /></td>\\n\";\n+        $s .= \"  <td align='left' class='ftitlecellm'><h2>\" . text($repname) . \"</h2></td>\\n\";\n     }\n-    $s .= \"  <td class='ftitlecell2'>\\n\";\n+    $s .= \"  <td align='right' class='ftitlecell2'>\\n\";\n     $r = getFacility($facid);\n     if (!empty($r)) {\n         $s .= \"<b>\" . text($r['name'] ?? '') . \"</b>\\n\";\n@@ -409,6 +409,34 @@ function getEmployerData($pid, $given = \"*\")\n     return sqlQuery($sql, array($pid));\n }\n \n+// Generate a consistent header and footer, used for printed patient reports\n+function genPatientHeaderFooter($pid, $DOS = null)\n+{\n+    $patient_dob = getPatientData($pid, \"DATE_FORMAT(DOB,'%m/%d/%Y') as DOB_TS\");\n+    $patient_name = getPatientName($pid);\n+\n+    // Header\n+    $s = '<htmlpageheader name=\"PageHeader1\"><div style=\"text-align: right; font-weight: bold;\">';\n+    $s .= text($patient_name) . '&emsp;DOB: ' . text($patient_dob['DOB_TS']);\n+    if ($DOS) {\n+        $s .= '&emsp;DOS: ' . text($DOS);\n+    }\n+    $s .= '</div></htmlpageheader>';\n+\n+    // Footer\n+    $s .= '<htmlpagefooter name=\"PageFooter1\"><div style=\"text-align: right; font-weight: bold;\">';\n+    $s .= '<div style=\"float: right; width:33%; text-align: left;\">' . oeFormatDateTime(date(\"Y-m-d H:i:s\")) . '</div>';\n+    $s .= '<div style=\"float: right; width:33%; text-align: center;\">{PAGENO}/{nbpg}</div>';\n+    $s .= '<div style=\"float: right; width:33%; text-align: right;\">' . text($patient_name) . '</div>';\n+    $s .= '</div></htmlpagefooter>';\n+\n+    // Set the header and footer in the current document\n+    $s .= '<sethtmlpageheader name=\"PageHeader1\" page=\"ALL\" value=\"ON\" show-this-page=\"1\" />';\n+    $s .= '<sethtmlpagefooter name=\"PageFooter1\" page=\"ALL\" value=\"ON\" />';\n+\n+    return $s;\n+}\n+\n function _set_patient_inc_count($limit, $count, $where, $whereBindArray = array())\n {\n   // When the limit is exceeded, find out what the unlimited count would be.\n@@ -757,7 +785,7 @@ function getPatientPID($args)\n     return $returnval;\n }\n \n-/* return a patient's name in the format LAST, FIRST */\n+/* return a patient's name in the format LAST [SUFFIX], FIRST [MIDDLE] */\n function getPatientName($pid)\n {\n     if (empty($pid)) {\n@@ -769,7 +797,10 @@ function getPatientName($pid)\n         return \"\";\n     }\n \n-    $patientName =  $patientData[0]['lname'] . \", \" . $patientData[0]['fname'];\n+    $patientName = $patientData[0]['lname'];\n+    $patientName .= $patientData[0]['suffix'] ? \" \" . $patientData[0]['suffix'] . \", \" : \", \";\n+    $patientName .= $patientData[0]['fname'];\n+    $patientName .= empty($patientData[0]['mname']) ? \"\" : \" \" . $patientData[0]['mname'];\n     return $patientName;\n }\n "
        },
        {
          "filename": "portal/get_patient_info.php",
          "status": "modified",
          "additions": 12,
          "deletions": 2,
          "patch": "@@ -63,6 +63,16 @@\n \n // Authentication\n require_once('../interface/globals.php');\n+\n+if (\n+    $GLOBALS['enforce_signin_email']\n+    && (!isset($_POST['passaddon']) || empty($_POST['passaddon']))\n+) {\n+    OpenEMR\\Common\\Session\\SessionUtil::portalSessionCookieDestroy();\n+    header('Location: ' . $landingpage . '&w&c');\n+    exit();\n+}\n+\n require_once(dirname(__FILE__) . \"/lib/appsql.class.php\");\n require_once(\"$srcdir/user.inc\");\n \n@@ -245,8 +255,8 @@\n         $_SESSION['patient_portal_onsite_two'] = 1;\n \n         $tmp = getUserIDInfo($userData['providerID']);\n-        $_SESSION['providerName'] = $tmp['fname'] . ' ' . $tmp['lname'];\n-        $_SESSION['providerUName'] = $tmp['username'];\n+        $_SESSION['providerName'] = ($tmp['fname'] ?? '') . ' ' . ($tmp['lname'] ?? '');\n+        $_SESSION['providerUName'] = $tmp['username'] ?? null;\n         $_SESSION['sessionUser'] = '-patient-'; // $_POST['uname'];\n         $_SESSION['providerId'] = $userData['providerID'] ? $userData['providerID'] : 'undefined';\n         $_SESSION['ptName'] = $userData['fname'] . ' ' . $userData['lname'];"
        },
        {
          "filename": "portal/import_template.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -56,7 +56,7 @@\n     die(xlt('Invalid File'));\n }\n \n-if ($_POST['mode'] === 'get') {\n+if ($_POST['mode'] ?? null === 'get') {\n     if ($_REQUEST['docid']) {\n         $template = $templateService->fetchTemplate($_POST['docid']);\n         echo $template['template_content'];"
        },
        {
          "filename": "portal/import_template_ui.php",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -828,7 +828,7 @@ function createBlankTemplate() {\n                                 $template_id = $file['id'];\n                                 $audit_status = array(\n                                     'pid' => '',\n-                                    'create_date' => ($file['profile_date'] ?: $file['modified_date']) ?? '',\n+                                    'create_date' => (($file['profile_date'] ?? null) ?: $file['modified_date']) ?? '',\n                                     'doc_type' => '',\n                                     'patient_signed_time' => '',\n                                     'authorize_signed_time' => '',\n@@ -850,7 +850,7 @@ function createBlankTemplate() {\n                                         $audit_status['denial_reason'] = xl('Scheduled');\n                                     }\n                                     $next_due = date('m/d/Y', $next_due);\n-                                } elseif ($next_due === 1 || ($next_due === true && $file['recurring'] ?? 0)) {\n+                                } elseif ($next_due === 1 || ($next_due === true && ($file['recurring'] ?? 0))) {\n                                     $audit_status['denial_reason'] = xl('Recurring');\n                                     $next_due = xl('Active');\n                                 } elseif ($next_due === 0) {"
        },
        {
          "filename": "portal/index.php",
          "status": "modified",
          "additions": 5,
          "deletions": 5,
          "patch": "@@ -139,7 +139,7 @@\n         header('Location: ' . $landingpage . '&w&u');\n         exit();\n     }\n-} else if (isset($_GET['forward'])) {\n+} elseif (isset($_GET['forward'])) {\n     if ((empty($GLOBALS['portal_two_pass_reset']) && empty($GLOBALS['portal_onsite_two_register'])) || empty($GLOBALS['google_recaptcha_site_key']) || empty($GLOBALS['google_recaptcha_secret_key'])) {\n         (new SystemLogger())->debug(\"reset password and registration not supported, so stopped attempt to use forward token\");\n         OpenEMR\\Common\\Session\\SessionUtil::portalSessionCookieDestroy();\n@@ -357,14 +357,14 @@ function enableVerifyBtn(){\n                     </div>\n                 </div>\n                 <div class=\"form-row my-3\">\n-                    <label class=\"col-md-2 col-form-label\" for=\"pass\"><?php echo !$_SESSION['onetime'] ? xlt('Current Password') : ''; ?></label>\n+                    <label class=\"col-md-2 col-form-label\" for=\"pass\"><?php echo empty($_SESSION['onetime'] ?? null) ? xlt('Current Password') : ''; ?></label>\n                     <div class=\"col-md\">\n-                        <input class=\"form-control\" name=\"pass\" id=\"pass\" <?php echo $_SESSION['onetime'] ? 'type=\"hidden\" ' : 'type=\"password\" '; ?> autocomplete=\"none\" value=\"<?php echo attr($_SESSION['onetime']);\n-                        $_SESSION['password_update'] = $_SESSION['onetime'] ? 2 : 1;\n+                        <input class=\"form-control\" name=\"pass\" id=\"pass\" <?php echo ($_SESSION['onetime'] ?? null) ? 'type=\"hidden\" ' : 'type=\"password\" '; ?> autocomplete=\"none\" value=\"<?php echo attr($_SESSION['onetime'] ?? '');\n+                        $_SESSION['password_update'] = ($_SESSION['onetime'] ?? null) ? 2 : 1;\n                         unset($_SESSION['onetime']); ?>\" required />\n                     </div>\n                 </div>\n-                <?php if ($_SESSION['pin']) { ?>\n+                <?php if ($_SESSION['pin'] ?? null) { ?>\n                     <div class=\"form-row my-3\">\n                         <label class=\"col-md-2 col-form-label\" for=\"token_pin\"><?php echo xlt('One Time PIN'); ?></label>\n                         <div class=\"col-md\">"
        },
        {
          "filename": "portal/lib/appsql.class.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -199,7 +199,7 @@ public function portalAudit(string $type = null, string $rec = null, array $audi\n     public function portalLog($event = '', $patient_id = null, $comments = \"\", $binds = '', $success = '1', $user_notes = '', $ccda_doc_id = 0)\n     {\n         $groupname = isset($GLOBALS['groupname']) ? $GLOBALS['groupname'] : 'none';\n-        $user = isset($_SESSION['portal_username']) ? $_SESSION['portal_username'] : $_SESSION['authUser'];\n+        $user = isset($_SESSION['portal_username']) ? $_SESSION['portal_username'] : $_SESSION['authUser'] ?? null;\n         $log_from = isset($_SESSION['portal_username']) ? 'onsite-portal' : 'portal-dashboard';\n         if (!isset($_SESSION['portal_username']) && !isset($_SESSION['authUser'])) {\n             $log_from = 'portal-login';"
        },
        {
          "filename": "sql/database.sql",
          "status": "modified",
          "additions": 8,
          "deletions": 6,
          "patch": "@@ -8730,6 +8730,14 @@ INSERT INTO `supported_external_dataloads` (`load_type`, `load_source`, `load_re\n ('CQM_VALUESET', 'NIH_VSAC', '2020-05-07', 'ep_ec_only_cms_20200507.xml.zip', '02dc0b497da979e336c24b0b5c6e1ccb');\n INSERT INTO `supported_external_dataloads` (`load_type`, `load_source`, `load_release_date`, `load_filename`, `load_checksum`) VALUES\n ( 'CQM_VALUESET', 'NIH_VSAC', '2021-05-06', 'ep_ec_eh_cms_20210506.xml.zip', '6455da86e269edb6d33288e72b467373');\n+INSERT INTO `supported_external_dataloads` (`load_type`, `load_source`, `load_release_date`, `load_filename`, `load_checksum`) VALUES\n+('ICD10', 'CMS', '2021-10-01', '2022-Code Descriptions.zip', '11d1d725c84e55d52ef6633da88aa137');\n+INSERT INTO `supported_external_dataloads` (`load_type`, `load_source`, `load_release_date`, `load_filename`, `load_checksum`) VALUES\n+('ICD10', 'CMS', '2021-10-01', 'Zip File 3 2022 ICD-10-PCS Codes File.zip', 'a432177acbdaf9908aa528078ae72176');\n+INSERT INTO `supported_external_dataloads` (`load_type`, `load_source`, `load_release_date`, `load_filename`, `load_checksum`) VALUES\n+('ICD10', 'CMS', '2022-10-01', '2023 Code Descriptions in Tabular Order.zip', 'a2bd2e87d6fac3f861b03dba9ca87cbc');\n+INSERT INTO `supported_external_dataloads` (`load_type`, `load_source`, `load_release_date`, `load_filename`, `load_checksum`) VALUES\n+('ICD10', 'CMS', '2022-10-01', 'Zip File 3 2023 ICD-10-PCS Codes File.zip', 'a4c0e6026557d770dc3d994718acaa21');\n -- --------------------------------------------------------\n \n --\n@@ -13133,12 +13141,6 @@ INSERT INTO `document_templates` (`id`, `pid`, `provider`, `encounter`, `modifie\n INSERT INTO `document_templates` (`id`, `pid`, `provider`, `encounter`, `modified_date`, `profile`, `category`, `location`, `template_name`, `status`, `send_date`, `end_date`, `size`, `template_content`, `mime`) VALUES(9, 0, 18, NULL, '2021-11-21 15:51:42', '', '', NULL, 'Privacy Document', 'New', '0000-00-00 00:00:00', '0000-00-00 00:00:00', 2536, 0x3c703e4e4f54494345204f462050524956414359205052414354494345532050415449454e542041434b4e4f574c454447454d454e5420414e4420434f4e53454e5420544f204d45444943414c2054524541544d454e540d0a50617469656e74204e616d653a203c656d3e7b50617469656e744e616d657d3c2f656d3e0d0a44617465206f662042697274683a207b50617469656e74444f427d0d0a0d0a49206861766520726563656976656420616e6420756e6465727374616e6420746869732070726163746963652773204e6f74696365206f66205072697661637920507261637469636573207772697474656e20696e20706c61696e20456e676c6973682e20546865206e6f746963652070726f766964657320696e2064657461696c20746865207573657320616e6420646973636c6f7375726573206f66206d792070726f746563746564206865616c746820696e666f726d6174696f6e2074686174206d6179206265206d61646520627920746869732070726163746963652c206d7920696e646976696475616c207269676874732c20686f772049206d61792065786572636973652074686f7365207269676874732c20616e642074686520707261637469636573206c6567616c206475746965732077697468207265737065637420746f206d7920696e666f726d6174696f6e2e0d0a0d0a4920756e6465727374616e642074686174207468652070726163746963652072657365727665732074686520726967687420746f206368616e676520746865207465726d73206f66207468652050726976616379205072616374696365732c20616e6420746f206d616b65206368616e67657320726567617264696e6720616c6c2070726f746563746564206865616c746820696e666f726d6174696f6e2e204966206368616e676573206f63637572207468656e207468652070726163746963652077696c6c2070726f76696465206d6520776974682061207265766973656420636f70792075706f6e20726571756573742e0d0a0d0a4920766f6c756e746172696c7920636f6e73656e7420746f20636172652c20696e636c7564696e672070687973696369616e206578616d696e6174696f6e20616e64207465737473207375636820617320782d7261792c206c61626f7261746f727920746573747320616e6420746f206d65646963616c2074726561746d656e74206279206d792070687973696369616e206f72206869732f68657220617373697374616e7473206f722064657369676e6565732c206173206d6179206265206e656365737361727920696e20746865206a7564676d656e74206f66206d792070687973696369616e2e204e6f2067756172616e746565732068617665206265656e206d61646520746f206d652061732074686520726573756c74206f662074726561746d656e74206f72206578616d696e6174696f6e2e0d0a0d0a417574686f72697a6174696f6e20666f723a0d0a496e20636f6e73696465726174696f6e20666f72207365727669636573207265636569766564206279203c656d3e7b526566657272696e67444f437d3c2f656d3e204920616772656520746f2070617920616e7920616e6420616c6c20636861726765732061732062696c6c65642e204920616c736f2072657175657374207468617420646972656374207061796d656e7473206265206d61646520746f203c656d3e7b526566657272696e67444f437d3c2f656d3e206f6e206d7920626568616c6620627920696e73757265727320616e64206167656e6369657320696e2074686520736574746c656d656e74206f6620616e79206f66206d7920636c61696d732e204920756e6465727374616e642074686174206d792070726f746563746564206865616c746820696e666f726d6174696f6e206d6179206e65656420746f2062652072656c656173656420666f722074686520707572706f7365206f662074726561746d656e742c207061796d656e74206f72206865616c74682063617265206f7065726174696f6e732e0d0a0d0a4d656469636172652050617469656e74733a0d0a49206365727469667920746861742074686520696e666f726d6174696f6e20676976656e206279206d6520666f72206170706c69636174696f6e20666f72207061796d656e7420756e646572207469746c65205856494949206f662074686520536f6369616c2053656375726974792041637420697320636f72726563742e204920617574686f72697a6520616e7920686f6c646572206f66206d65646963616c206f72206f746865722072656c6576616e7420696e666f726d6174696f6e2061626f7574206d652062652072656c656173656420746f2074686520536f6369616c2053656375726974792041646d696e697374726174696f6e206f72206974277320696e7465726d6564696172696573206f6620636172726965727320616e64207375636820696e666f726d6174696f6e206e656564656420746f20737570706f7274206170706c69636174696f6e20666f72207061796d656e742e20496e636c7564696e67207265636f726473207065727461696e696e6720746f2048495620737461747573206f722074726561746d656e74202841494453207265636f726473292c206472756720616e6420616c636f686f6c2074726561746d656e742c20616e64206f722070737963686961747269632074726561746d656e742e20492061737369676e20616e6420617574686f72697a65207061796d656e74206469726563746c7920746f203c656d3e7b526566657272696e67444f437d3c2f656d3e20666f722074686520756e70616964206368617267657320666f72207468652070687973696369616e27732073657276696365732e204920756e6465727374616e642074686174204920616d20726573706f6e7369626c6520666f7220616c6c20696e737572616e63652064656475637469626c657320616e6420636f696e737572616e63652e0d0a436f6d6d656e74733a207b54657874496e7075747d0d0a5369676e61747572653a207b50617469656e745369676e61747572657d0d0a446f20796f7520617574686f72697a6520656c656374726f6e6963207369676e6174757265207b436865636b4d61726b7d200d0a52656c6174696f6e7368697020746f2070617469656e7420286966207369676e6564206279206120706572736f6e616c20726570726573656e746174697665293a207b54657874496e7075747d0d0a41726520796f75205072696d61727920436172652047697665723a7b796e526164696f47726f75707d0d0a446174653a207b444f537d0d0a3c2f703e3c703e436c696e696320526570726573656e746174697665205369676e6174757265266e6273703b7b526566657272696e67444f437d205369676e65643a207b41646d696e5369676e61747572657d203c2f703e3c703e3c6272202f3e3c2f703e, 'text/plain');\n INSERT INTO `document_templates` (`id`, `pid`, `provider`, `encounter`, `modified_date`, `profile`, `category`, `location`, `template_name`, `status`, `send_date`, `end_date`, `size`, `template_content`, `mime`) VALUES(10, -1, 1, NULL, '2021-11-30 16:02:52', '', '', NULL, 'Privacy Document', 'New', '0000-00-00 00:00:00', '0000-00-00 00:00:00', 2536, 0x3c703e4e4f54494345204f462050524956414359205052414354494345532050415449454e542041434b4e4f574c454447454d454e5420414e4420434f4e53454e5420544f204d45444943414c2054524541544d454e540d0a50617469656e74204e616d653a203c656d3e7b50617469656e744e616d657d3c2f656d3e0d0a44617465206f662042697274683a207b50617469656e74444f427d0d0a0d0a49206861766520726563656976656420616e6420756e6465727374616e6420746869732070726163746963652773204e6f74696365206f66205072697661637920507261637469636573207772697474656e20696e20706c61696e20456e676c6973682e20546865206e6f746963652070726f766964657320696e2064657461696c20746865207573657320616e6420646973636c6f7375726573206f66206d792070726f746563746564206865616c746820696e666f726d6174696f6e2074686174206d6179206265206d61646520627920746869732070726163746963652c206d7920696e646976696475616c207269676874732c20686f772049206d61792065786572636973652074686f7365207269676874732c20616e642074686520707261637469636573206c6567616c206475746965732077697468207265737065637420746f206d7920696e666f726d6174696f6e2e0d0a0d0a4920756e6465727374616e642074686174207468652070726163746963652072657365727665732074686520726967687420746f206368616e676520746865207465726d73206f66207468652050726976616379205072616374696365732c20616e6420746f206d616b65206368616e67657320726567617264696e6720616c6c2070726f746563746564206865616c746820696e666f726d6174696f6e2e204966206368616e676573206f63637572207468656e207468652070726163746963652077696c6c2070726f76696465206d6520776974682061207265766973656420636f70792075706f6e20726571756573742e0d0a0d0a4920766f6c756e746172696c7920636f6e73656e7420746f20636172652c20696e636c7564696e672070687973696369616e206578616d696e6174696f6e20616e64207465737473207375636820617320782d7261792c206c61626f7261746f727920746573747320616e6420746f206d65646963616c2074726561746d656e74206279206d792070687973696369616e206f72206869732f68657220617373697374616e7473206f722064657369676e6565732c206173206d6179206265206e656365737361727920696e20746865206a7564676d656e74206f66206d792070687973696369616e2e204e6f2067756172616e746565732068617665206265656e206d61646520746f206d652061732074686520726573756c74206f662074726561746d656e74206f72206578616d696e6174696f6e2e0d0a0d0a417574686f72697a6174696f6e20666f723a0d0a496e20636f6e73696465726174696f6e20666f72207365727669636573207265636569766564206279203c656d3e7b526566657272696e67444f437d3c2f656d3e204920616772656520746f2070617920616e7920616e6420616c6c20636861726765732061732062696c6c65642e204920616c736f2072657175657374207468617420646972656374207061796d656e7473206265206d61646520746f203c656d3e7b526566657272696e67444f437d3c2f656d3e206f6e206d7920626568616c6620627920696e73757265727320616e64206167656e6369657320696e2074686520736574746c656d656e74206f6620616e79206f66206d7920636c61696d732e204920756e6465727374616e642074686174206d792070726f746563746564206865616c746820696e666f726d6174696f6e206d6179206e65656420746f2062652072656c656173656420666f722074686520707572706f7365206f662074726561746d656e742c207061796d656e74206f72206865616c74682063617265206f7065726174696f6e732e0d0a0d0a4d656469636172652050617469656e74733a0d0a49206365727469667920746861742074686520696e666f726d6174696f6e20676976656e206279206d6520666f72206170706c69636174696f6e20666f72207061796d656e7420756e646572207469746c65205856494949206f662074686520536f6369616c2053656375726974792041637420697320636f72726563742e204920617574686f72697a6520616e7920686f6c646572206f66206d65646963616c206f72206f746865722072656c6576616e7420696e666f726d6174696f6e2061626f7574206d652062652072656c656173656420746f2074686520536f6369616c2053656375726974792041646d696e697374726174696f6e206f72206974277320696e7465726d6564696172696573206f6620636172726965727320616e64207375636820696e666f726d6174696f6e206e656564656420746f20737570706f7274206170706c69636174696f6e20666f72207061796d656e742e20496e636c7564696e67207265636f726473207065727461696e696e6720746f2048495620737461747573206f722074726561746d656e74202841494453207265636f726473292c206472756720616e6420616c636f686f6c2074726561746d656e742c20616e64206f722070737963686961747269632074726561746d656e742e20492061737369676e20616e6420617574686f72697a65207061796d656e74206469726563746c7920746f203c656d3e7b526566657272696e67444f437d3c2f656d3e20666f722074686520756e70616964206368617267657320666f72207468652070687973696369616e27732073657276696365732e204920756e6465727374616e642074686174204920616d20726573706f6e7369626c6520666f7220616c6c20696e737572616e63652064656475637469626c657320616e6420636f696e737572616e63652e0d0a436f6d6d656e74733a207b54657874496e7075747d0d0a5369676e61747572653a207b50617469656e745369676e61747572657d0d0a446f20796f7520617574686f72697a6520656c656374726f6e6963207369676e6174757265207b436865636b4d61726b7d200d0a52656c6174696f6e7368697020746f2070617469656e7420286966207369676e6564206279206120706572736f6e616c20726570726573656e746174697665293a207b54657874496e7075747d0d0a41726520796f75205072696d61727920436172652047697665723a7b796e526164696f47726f75707d0d0a446174653a207b444f537d0d0a3c2f703e3c703e436c696e696320526570726573656e746174697665205369676e6174757265266e6273703b7b526566657272696e67444f437d205369676e65643a207b41646d696e5369676e61747572657d203c2f703e3c703e3c6272202f3e3c2f703e, 'text/plain');\n \n-INSERT INTO `supported_external_dataloads` (`load_type`, `load_source`, `load_release_date`, `load_filename`, `load_checksum`) VALUES\n-('ICD10', 'CMS', '2021-10-01', '2022-Code Descriptions.zip', '11d1d725c84e55d52ef6633da88aa137');\n-\n-INSERT INTO `supported_external_dataloads` (`load_type`, `load_source`, `load_release_date`, `load_filename`, `load_checksum`) VALUES\n-('ICD10', 'CMS', '2021-10-01', 'Zip File 3 2022 ICD-10-PCS Codes File.zip', 'a432177acbdaf9908aa528078ae72176');\n-\n DROP TABLE IF EXISTS `valueset_oid`;\n CREATE TABLE `valueset_oid` (\n   `nqf_code` varchar(255) NOT NULL DEFAULT '',"
        },
        {
          "filename": "sql/patch.sql",
          "status": "modified",
          "additions": 9,
          "deletions": 0,
          "patch": "@@ -52,6 +52,15 @@\n ALTER TABLE `prescriptions` CHANGE `route` `route` VARCHAR(100) NULL DEFAULT NULL Comment 'Max size 100 characters is same max as immunizations';\n #EndIf\n \n+#IfNotRow4D supported_external_dataloads load_type ICD10 load_source CMS load_release_date 2022-10-01 load_filename 2023 Code Descriptions in Tabular Order.zip\n+INSERT INTO `supported_external_dataloads` (`load_type`, `load_source`, `load_release_date`, `load_filename`, `load_checksum`) VALUES\n+('ICD10', 'CMS', '2022-10-01', '2023 Code Descriptions in Tabular Order.zip', 'a2bd2e87d6fac3f861b03dba9ca87cbc');\n+#EndIf\n+\n+#IfNotRow4D supported_external_dataloads load_type ICD10 load_source CMS load_release_date 2022-10-01 load_filename Zip File 3 2023 ICD-10-PCS Codes File.zip\n+INSERT INTO `supported_external_dataloads` (`load_type`, `load_source`, `load_release_date`, `load_filename`, `load_checksum`) VALUES\n+('ICD10', 'CMS', '2022-10-01', 'Zip File 3 2023 ICD-10-PCS Codes File.zip', 'a4c0e6026557d770dc3d994718acaa21');\n+#EndIf\n #IfNotRow2D list_options list_id drug_route option_id bymouth\n INSERT INTO `list_options` (`list_id`, `option_id`, `title`, `seq`, `is_default`, `notes`, `codes`) VALUES ('drug_route', 'bymouth', 'By Mouth', 1, 0, 'PO', 'NCI-CONCEPT-ID:C38288');\n #EndIf"
        },
        {
          "filename": "src/Billing/Hcfa1500.php",
          "status": "modified",
          "additions": 3,
          "deletions": 1,
          "patch": "@@ -417,7 +417,9 @@ private function genHcfa1500Page($pid, $encounter, &$log, $claim)\n         // Note: Date does not apply unless the person physically signs the form.\n \n         // Box 13. Insured's or Authorized Person's Signature\n-        $this->putHcfa(29, 55, 17, 'Signature on File');\n+        if ($claim->billingFacilityAssignment()) {\n+            $this->putHcfa(29, 55, 17, 'Signature on File');\n+        }\n \n         // Box 14. Date of Current Illness/Injury/Pregnancy\n         // this will cause onsetDate in Encounter summary to override misc billing so not perfect yet but fine for now"
        },
        {
          "filename": "src/Billing/X125010837P.php",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -626,7 +626,7 @@ public static function genX12837P($pid, $encounter, &$log, $encounter_claim = fa\n         \"*\" .\n         \"*\" . sprintf('%02d', $claim->facilityPOS()) . \":\" . \"B\" . \":\" . $claim->frequencyTypeCode() .\n         \"*\" . \"Y\" .\n-        \"*\" . \"A\" .\n+        \"*\" . ($claim->billingFacilityAssignment() ? 'A' : 'C') .\n         \"*\" . ($claim->billingFacilityAssignment() ? 'Y' : 'N') .\n         \"*\" . \"Y\" .\n         \"~\\n\";\n@@ -2158,7 +2158,7 @@ public static function gen_x12_837_tr3(\n             \"*\" .\n             \"*\" . sprintf('%02d', $claim->facilityPOS()) . \":\" . \"B\" . \":\" . $claim->frequencyTypeCode() .\n             \"*\" . \"Y\" .\n-            \"*\" . \"A\" .\n+            \"*\" . ($claim->billingFacilityAssignment() ? 'A' : 'C') .\n             \"*\" . ($claim->billingFacilityAssignment() ? 'Y' : 'N') .\n             \"*\" . \"Y\" .\n             \"~\\n\";"
        },
        {
          "filename": "src/Common/Logging/EventAuditLogger.php",
          "status": "modified",
          "additions": 11,
          "deletions": 2,
          "patch": "@@ -155,8 +155,17 @@ class EventAuditLogger\n      * @param string    $menu_item\n      * @param int       $ccda_doc_id\n      */\n-    public function newEvent($event, $user, $groupname, $success, $comments = \"\", $patient_id = null, $log_from = 'open-emr', $menu_item = 'dashboard', $ccda_doc_id = 0)\n-    {\n+    public function newEvent(\n+        $event,\n+        $user,\n+        $groupname,\n+        $success,\n+        $comments = \"\",\n+        $patient_id = null,\n+        $log_from = 'open-emr',\n+        $menu_item = 'dashboard',\n+        $ccda_doc_id = 0\n+    ) {\n         $category = $event;\n         // Special case delete for lists table\n         if ($event == 'delete') {"
        },
        {
          "filename": "src/Patient/Cards/PortalCard.php",
          "status": "modified",
          "additions": 11,
          "deletions": 5,
          "patch": "@@ -21,9 +21,9 @@\n \n class PortalCard extends CardModel\n {\n-    const TEMPLATE_FILE = 'patient/partials/portal.html.twig';\n+    private const TEMPLATE_FILE = 'patient/partials/portal.html.twig';\n \n-    const CARD_ID = 'patient_portal';\n+    private const CARD_ID = 'patient_portal';\n \n     private $opts = [];\n \n@@ -70,16 +70,22 @@ private function setOpts()\n         global $pid;\n         $this->opts = [\n             'acl' => ['patients', 'dem'],\n-            'initiallyCollapsed' => (getUserSetting(self::CARD_ID) == 0) ? false : true,\n-            'add' => true,\n+            'initiallyCollapsed' => (getUserSetting(self::CARD_ID . '_expand') == 0),\n+            'add' => false,\n             'edit' => false,\n             'collapse' => true,\n             'templateFile' => self::TEMPLATE_FILE,\n             'identifier' => self::CARD_ID,\n             'title' => xl('Patient Portal') . ' / ' . xl('API Access'),\n             'templateVariables' => [\n-                'portalAuthorized' => portalAuthorized($pid),\n+                'isPortalEnabled' => isPortalEnabled(),\n+                'isPortalSiteAddressValid' => isPortalSiteAddressValid(),\n+                'isPortalAllowed' => isPortalAllowed($pid),\n                 'portalLoginHref' => $GLOBALS['webroot'] . \"/interface/patient_file/summary/create_portallogin.php\",\n+                'isApiAllowed' => isApiAllowed($pid),\n+                'areCredentialsCreated' => areCredentialsCreated($pid),\n+                'isContactEmail' => isContactEmail($pid),\n+                'isEnforceSigninEmailPortal' => isEnforceSigninEmailPortal($pid)\n             ],\n         ];\n     }"
        },
        {
          "filename": "templates/patient/partials/portal.html.twig",
          "status": "modified",
          "additions": 63,
          "deletions": 17,
          "patch": "@@ -14,30 +14,76 @@ The Patient Portal card for the Medical Record Dashboard\n     {% set append = cardMacros.injectedContent(appendedInjection) %}\n {% endif %}\n \n-\n {% block content %}\n-<div class=\"text d-flex pl-1\">\n-    {% if portalAuthorized.isAllowed == false %}\n-        <div>\n-        {% if portalAuthorized.authorized.api == false %}\n-            <p>{{ \"API Access Not Authorized\"|xlt }}</p>\n-        {% endif %}\n-        {% if portalAuthorized.authorized.api == false %}\n-            <p>{{ \"Patient Portal Not Authorized\"|xlt }}</p>\n-        {% endif %}\n+<div class=\"text pl-1\">\n+    {% if isPortalEnabled == false %}\n+    <div class=\"alert alert-warning\" role=\"alert\">\n+            <p class=\"font-weight-bold\">{{  \"Portal Status\"|xlt }}</p>\n+            <p> {{ \"Patient Portal Not Enabled. Admin Can Enable Patient Portal.\"|xlt }} </p>\n+        </div>\n+    {% endif %} \n+\n+    {% if isPortalSiteAddressValid == false %}\n+    <div class=\"alert alert-warning\" role=\"alert\">\n+            <p class=\"font-weight-bold\">{{  \"Portal Status\"|xlt }}</p>\n+            <p> {{ \"Patient Portal Site Address Not Set Properly. Admin Can Correct in Config.\"|xlt }} </p>\n+        </div>\n+    {% endif %}\n+\n+    {% if isPortalAllowed == false %}\n+        <div class=\"alert alert-warning\" role=\"alert\">\n+            <p class=\"font-weight-bold\">{{  \"Portal Access\"|xlt }}</p>\n+            <p> {{ \"Allow Patient Portal in Demographics Choices.\"|xlt }} </p>\n         </div>\n-    {% else %}\n-        {{ prepend }}\n-        {% if portalAuthorized.credentials.created == true %}\n+    {% elseif isContactEmail == false and isEnforceSigninEmailPortal == true %}\n+            <div class=\"alert alert-warning\" role=\"alert\">\n+                <p class=\"font-weight-bold\">{{  \"Email Address\"|xlt }}</p>\n+                <p> {{ \"Email is Enforced. Enter an Email in Demographics Contact.\"|xlt }} </p>\n+            </div>\n+    {% elseif isContactEmail == false and isEnforceSigninEmailPortal == false %}\n+            <div class=\"alert alert-warning\" role=\"alert\">\n+                <p class=\"font-weight-bold\">{{  \"Email Address\"|xlt }}</p>\n+                <p> {{ \"Enter an Email in Demographics Contact for Sending Credentials.\"|xlt }} </p>\n+            </div>        \n+    {% elseif isPortalEnabled and isPortalSiteAddressValid %}\n+    <div class=\"alert alert-info\" role=\"alert\">\n+        <p class=\"font-weight-bold\">{{ \"Documents\"|xlt }}</p>\n+         <button type=\"button\" class=\"btn btn-link btn-sm w-50\" onclick='top.assignPatientDocuments({{pid|attr_js}})'><i class=\"fa fa-file-signature\"></i>&nbsp;{{ \"Assign\"|xlt }}</button>\n+        </div>           \n+    {% endif %}\n+\n+\n+    {% if isApiAllowed == false %}\n+        <div class=\"alert alert-warning\" role=\"alert\">\n+            <p class=\"font-weight-bold\">{{  \"API Access\"|xlt }}</p>\n+            <p> {{ \"Prevent API Access can be disabled in Demographics Choices.\"|xlt }} </p>\n+        </div>\n+    {% endif %}     \n+\n+    {% if (\n+        isPortalAllowed\n+        and isPortalEnabled\n+        and isPortalSiteAddressValid\n+        and (\n+            isEnforceSigninEmailPortal == false\n+            or (\n+                isEnforceSigninEmailPortal\n+                and isContactEmail\n+               )\n+            ) \n+        or isApiAllowed == true\n+        ) %}\n+        <div class=\"alert alert-info\" role=\"alert\">\n+        <p class=\"font-weight-bold\">{{ \"Credentials\"|xlt }}</p>\n+        {% if areCredentialsCreated == true %}\n             {% set class = \"fa-key\" %}\n-            {% set text = \"Reset Credentials\"|xlt %}\n+            {% set text = \"Reset\"|xlt %}\n         {% else %}\n             {% set class = \"fa-user-plus\" %}\n-            {% set text = \"Create Credentials\"|xlt %}\n+            {% set text = \"Create\"|xlt %}\n         {% endif %}\n         <a href=\"{{ portalLoginHref|attr }}?patient={{ pid|attr_url }}\" class=\"btn btn-link btn-sm w-50 small_modal\"><i class=\"fa {{ class|attr }}\"></i>&nbsp;{{ text|text }}</a>\n-        <button type=\"button\" class=\"btn btn-link btn-sm w-50\" onclick='top.assignPatientDocuments({{pid|attr_js}})'><i class=\"fa fa-file-signature\"></i>&nbsp;{{ \"Assign Documents\"|xlt }}</button>\n-        {{ append }}\n+        </div>\n     {% endif %}\n </div>\n {% endblock %}"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 23,
        "max_directory_depth": 5
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "5a6ce59033e28da4977509da60f4fc0cbf084b43",
            "date": "2025-01-12T07:59:34Z",
            "author_login": "bradymiller"
          },
          {
            "sha": "48858bcad419eb537a0879d8261845df39d793f2",
            "date": "2025-01-10T22:28:46Z",
            "author_login": "stephenwaite"
          },
          {
            "sha": "ee3beb58f73619e04004e526c56423a14d6689fd",
            "date": "2025-01-09T07:11:34Z",
            "author_login": "bradymiller"
          },
          {
            "sha": "1480ee627b317622a122abb293b74be50ad86795",
            "date": "2025-01-08T17:44:10Z",
            "author_login": "sjpadgett"
          },
          {
            "sha": "6a444b1c9ac5773008ab7a6c8fb81a4e9a365e6b",
            "date": "2025-01-06T12:49:47Z",
            "author_login": "NileshHake"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.1,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N",
    "cwe_id": "CWE-79",
    "description": "Cross-site Scripting (XSS) - Reflected in GitHub repository openemr/openemr prior to 7.0.0.2.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2022-12-19T20:15:13.720",
    "last_modified": "2024-11-21T07:35:36.253",
    "fix_date": "2022-10-27T01:40:16Z"
  },
  "references": [
    {
      "url": "https://github.com/openemr/openemr/commit/d5eb41697f7f1bc2c7ee5bc9bbf58684e1c8cc14",
      "source": "security@huntr.dev",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/9c66ece4-bcaa-417d-8b98-e8daff8a728b",
      "source": "security@huntr.dev",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/openemr/openemr/commit/d5eb41697f7f1bc2c7ee5bc9bbf58684e1c8cc14",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/9c66ece4-bcaa-417d-8b98-e8daff8a728b",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:04:23.184561",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "openemr",
    "owner": "openemr",
    "created_at": "2010-05-21T19:54:08Z",
    "updated_at": "2025-01-12T07:59:39Z",
    "pushed_at": "2025-01-12T07:59:34Z",
    "size": 613406,
    "stars": 3249,
    "forks": 2204,
    "open_issues": 360,
    "watchers": 3249,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "master",
      "rel-320",
      "rel-400",
      "rel-410",
      "rel-411",
      "rel-412",
      "rel-413",
      "rel-420",
      "rel-421"
    ],
    "languages": {
      "PHP": 38302611,
      "JavaScript": 2254920,
      "XSLT": 1868397,
      "HTML": 1450911,
      "Twig": 590132,
      "CSS": 530442,
      "SCSS": 189517,
      "Mustache": 127165,
      "Perl": 114453,
      "Shell": 79764,
      "Smarty": 70819,
      "Dockerfile": 57349,
      "Makefile": 1915,
      "Roff": 911
    },
    "commit_activity": {
      "total_commits_last_year": 325,
      "avg_commits_per_week": 6.25,
      "days_active_last_year": 161
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "gpl-3.0"
    },
    "collected_at": "2025-01-14T13:15:48.369791"
  }
}