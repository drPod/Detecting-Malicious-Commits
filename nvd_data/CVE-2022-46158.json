{
  "cve_id": "CVE-2022-46158",
  "github_data": {
    "repository": "PrestaShop/PrestaShop",
    "fix_commit": "8684d429fb7c3bb51efb098e8b92a1fd2958f8cf",
    "related_commits": [
      "8684d429fb7c3bb51efb098e8b92a1fd2958f8cf",
      "8684d429fb7c3bb51efb098e8b92a1fd2958f8cf"
    ],
    "patch_url": "https://github.com/PrestaShop/PrestaShop/commit/8684d429fb7c3bb51efb098e8b92a1fd2958f8cf.patch",
    "fix_commit_details": {
      "sha": "8684d429fb7c3bb51efb098e8b92a1fd2958f8cf",
      "commit_date": "2022-12-06T14:40:19Z",
      "author": {
        "login": "atomiix",
        "type": "User",
        "stats": {
          "total_commits": 846,
          "average_weekly_commits": 1.17663421418637,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 146
        }
      },
      "commit_message": {
        "title": "Merge pull request from GHSA-9qgp-9wwc-v29r",
        "length": 96,
        "has_description": true,
        "references_issue": false
      },
      "stats": {
        "total": 517,
        "additions": 332,
        "deletions": 185
      },
      "files": [
        {
          "filename": "admin-dev/themes/default/template/controllers/customer_threads/helpers/view/message.tpl",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -53,7 +53,7 @@\n \t\t\t</h4>\n \t\t{/if}\n \t\t<span class=\"message-date\">&nbsp;<i class=\"icon-calendar\"></i> - {dateFormat date=$message.date_add full=0} - <i class=\"icon-time\"></i> {$message.date_add|substr:11:5}</span>\n-\t\t{if isset($message.file_name)} <span class=\"message-product\">&nbsp;<i class=\"icon-link\"></i> <a href=\"{$message.file_name|escape:'html':'UTF-8'}\" target=\"_blank\" rel=\"noopener noreferrer nofollow\">{l s=\"Attachment\" d='Admin.Catalog.Feature'}</a></span>{/if}\n+\t\t{if isset($message.file_name)} <span class=\"message-product\">&nbsp;<i class=\"icon-link\"></i> <a href=\"{$message.file_link|escape:'html':'UTF-8'}\" target=\"_blank\" rel=\"noopener noreferrer nofollow\">{l s=\"Attachment\" d='Admin.Catalog.Feature'}</a></span>{/if}\n \t\t{if isset($message.product_name)} <span class=\"message-attachment\">&nbsp;<i class=\"icon-book\"></i> <a href=\"{$message.product_link|escape:'html':'UTF-8'}\" target=\"_blank\" rel=\"noopener noreferrer nofollow\">{l s=\"Product\" d='Admin.Global'} {$message.product_name|escape:'html':'UTF-8'} </a></span>{/if}\n \t\t<p class=\"message-item-text\">{$message.message|escape:'html':'UTF-8'|nl2br}</p>\n \t</div>"
        },
        {
          "filename": "classes/Dispatcher.php",
          "status": "modified",
          "additions": 13,
          "deletions": 5,
          "patch": "@@ -53,6 +53,13 @@ class DispatcherCore\n      * @var array List of default routes\n      */\n     public $default_routes = [\n+        'upload' => [\n+            'controller' => 'upload',\n+            'rule' => 'upload/{file}',\n+            'keywords' => [\n+                'file' => ['regexp' => '.+', 'param' => 'file'],\n+            ],\n+        ],\n         'category_rule' => [\n             'controller' => 'category',\n             'rule' => '{id}-{rewrite}',\n@@ -1029,12 +1036,13 @@ public function getController($id_shop = null)\n             $controller = $this->controller_not_found;\n             $test_request_uri = preg_replace('/(=http:\\/\\/)/', '=', $this->request_uri);\n \n-            // If the request_uri matches a static file, then there is no need to check the routes, we keep\n+            // If the request_uri matches a static file, unless it's in the upload folder,\n+            // then there is no need to check the routes, we keep\n             // \"controller_not_found\" (a static file should not go through the dispatcher)\n-            if (!preg_match(\n-                '/\\.(gif|jpe?g|png|css|js|ico)$/i',\n-                parse_url($test_request_uri, PHP_URL_PATH)\n-            )) {\n+            if (\n+                !preg_match('/\\.(gif|jpe?g|png|css|js|ico)$/i', parse_url($test_request_uri, PHP_URL_PATH))\n+                || preg_match('/^\\/upload/', parse_url($test_request_uri, PHP_URL_PATH)))\n+            {\n                 // Add empty route as last route to prevent this greedy regexp to match request uri before right time\n                 if ($this->empty_route) {\n                     $this->addRoute("
        },
        {
          "filename": "classes/Tools.php",
          "status": "modified",
          "additions": 3,
          "deletions": 1,
          "patch": "@@ -2632,7 +2632,9 @@ public static function generateHtaccess($path = null, $rewrite_settings = null,\n                 fwrite($write_fd, 'RewriteRule . - [E=REWRITEBASE:' . $uri['physical'] . ']' . PHP_EOL);\n \n                 // Webservice\n-                fwrite($write_fd, 'RewriteRule ^api(?:/(.*))?$ %{ENV:REWRITEBASE}webservice/dispatcher.php?url=$1 [QSA,L]' . \"\\n\\n\");\n+                fwrite($write_fd, 'RewriteRule ^api(?:/(.*))?$ %{ENV:REWRITEBASE}webservice/dispatcher.php?url=$1 [QSA,L]' . PHP_EOL);\n+                // upload folder\n+                fwrite($write_fd, 'RewriteRule ^upload/.+$ %{ENV:REWRITEBASE}index.php [QSA,L]' . \"\\n\\n\");\n \n                 if (!$rewrite_settings) {\n                     $rewrite_settings = (int) Configuration::get('PS_REWRITING_SETTINGS', null, null, (int) $uri['id_shop']);"
        },
        {
          "filename": "controllers/admin/AdminCustomerThreadsController.php",
          "status": "modified",
          "additions": 23,
          "deletions": 7,
          "patch": "@@ -512,14 +512,18 @@ public function postProcess()\n \n     public function initContent()\n     {\n-        if (isset($_GET['filename']) && file_exists(_PS_UPLOAD_DIR_ . $_GET['filename']) && Validate::isFileName($_GET['filename'])) {\n-            AdminCustomerThreadsController::openUploadedFile();\n+        if (isset($_GET['filename'])) {\n+            if (file_exists(_PS_UPLOAD_DIR_ . $_GET['filename']) && Validate::isFileName($_GET['filename'])) {\n+                $this->openUploadedFile(!Tools::getValue('show'));\n+            } else {\n+                Tools::redirect('404');\n+            }\n         }\n \n         return parent::initContent();\n     }\n \n-    protected function openUploadedFile()\n+    protected function openUploadedFile(bool $forceDownload = true)\n     {\n         $filename = $_GET['filename'];\n \n@@ -553,7 +557,9 @@ protected function openUploadedFile()\n             ob_end_clean();\n         }\n         header('Content-Type: ' . $extension);\n-        header('Content-Disposition:attachment;filename=\"' . $filename . '\"');\n+        if ($forceDownload) {\n+            header('Content-Disposition:attachment;filename=\"' . $filename . '\"');\n+        }\n         readfile(_PS_UPLOAD_DIR_ . $filename);\n         die;\n     }\n@@ -631,10 +637,20 @@ public function renderView()\n                 $employee = new Employee($mess['id_employee']);\n                 $messages[$key]['employee_image'] = $employee->getImage();\n             }\n-            if (isset($mess['file_name']) && $mess['file_name'] != '') {\n-                $messages[$key]['file_name'] = _THEME_PROD_PIC_DIR_ . $mess['file_name'];\n-            } else {\n+            if (empty($mess['file_name'])) {\n                 unset($messages[$key]['file_name']);\n+            } else {\n+                $messages[$key]['file_link'] = $this->context->link->getAdminLink(\n+                    'AdminCustomerThreads',\n+                    true,\n+                    [],\n+                    [\n+                        'id_customer_thread' => $id_customer_thread,\n+                        'viewcustomer_thread' => '',\n+                        'filename' => $mess['file_name'],\n+                        'show' => true,\n+                    ]\n+                );\n             }\n \n             if ($mess['id_product']) {"
        },
        {
          "filename": "controllers/front/GetFileController.php",
          "status": "modified",
          "additions": 164,
          "deletions": 158,
          "patch": "@@ -25,6 +25,137 @@\n  */\n class GetFileControllerCore extends FrontController\n {\n+    protected const MIME_TYPES = [\n+        'ez' => 'application/andrew-inset',\n+        'hqx' => 'application/mac-binhex40',\n+        'cpt' => 'application/mac-compactpro',\n+        'doc' => 'application/msword',\n+        'oda' => 'application/oda',\n+        'pdf' => 'application/pdf',\n+        'ai' => 'application/postscript',\n+        'eps' => 'application/postscript',\n+        'ps' => 'application/postscript',\n+        'smi' => 'application/smil',\n+        'smil' => 'application/smil',\n+        'wbxml' => 'application/vnd.wap.wbxml',\n+        'wmlc' => 'application/vnd.wap.wmlc',\n+        'wmlsc' => 'application/vnd.wap.wmlscriptc',\n+        'bcpio' => 'application/x-bcpio',\n+        'vcd' => 'application/x-cdlink',\n+        'pgn' => 'application/x-chess-pgn',\n+        'cpio' => 'application/x-cpio',\n+        'csh' => 'application/x-csh',\n+        'dcr' => 'application/x-director',\n+        'dir' => 'application/x-director',\n+        'dxr' => 'application/x-director',\n+        'dvi' => 'application/x-dvi',\n+        'spl' => 'application/x-futuresplash',\n+        'gtar' => 'application/x-gtar',\n+        'hdf' => 'application/x-hdf',\n+        'js' => 'application/x-javascript',\n+        'skp' => 'application/x-koan',\n+        'skd' => 'application/x-koan',\n+        'skt' => 'application/x-koan',\n+        'skm' => 'application/x-koan',\n+        'latex' => 'application/x-latex',\n+        'nc' => 'application/x-netcdf',\n+        'cdf' => 'application/x-netcdf',\n+        'sh' => 'application/x-sh',\n+        'shar' => 'application/x-shar',\n+        'swf' => 'application/x-shockwave-flash',\n+        'sit' => 'application/x-stuffit',\n+        'sv4cpio' => 'application/x-sv4cpio',\n+        'sv4crc' => 'application/x-sv4crc',\n+        'tar' => 'application/x-tar',\n+        'tcl' => 'application/x-tcl',\n+        'tex' => 'application/x-tex',\n+        'texinfo' => 'application/x-texinfo',\n+        'texi' => 'application/x-texinfo',\n+        't' => 'application/x-troff',\n+        'tr' => 'application/x-troff',\n+        'roff' => 'application/x-troff',\n+        'man' => 'application/x-troff-man',\n+        'me' => 'application/x-troff-me',\n+        'ms' => 'application/x-troff-ms',\n+        'ustar' => 'application/x-ustar',\n+        'src' => 'application/x-wais-source',\n+        'xhtml' => 'application/xhtml+xml',\n+        'xht' => 'application/xhtml+xml',\n+        'zip' => 'application/zip',\n+        'au' => 'audio/basic',\n+        'snd' => 'audio/basic',\n+        'mid' => 'audio/midi',\n+        'midi' => 'audio/midi',\n+        'kar' => 'audio/midi',\n+        'mpga' => 'audio/mpeg',\n+        'mp2' => 'audio/mpeg',\n+        'mp3' => 'audio/mpeg',\n+        'aif' => 'audio/x-aiff',\n+        'aiff' => 'audio/x-aiff',\n+        'aifc' => 'audio/x-aiff',\n+        'm3u' => 'audio/x-mpegurl',\n+        'ram' => 'audio/x-pn-realaudio',\n+        'rm' => 'audio/x-pn-realaudio',\n+        'rpm' => 'audio/x-pn-realaudio-plugin',\n+        'ra' => 'audio/x-realaudio',\n+        'wav' => 'audio/x-wav',\n+        'pdb' => 'chemical/x-pdb',\n+        'xyz' => 'chemical/x-xyz',\n+        'bmp' => 'image/bmp',\n+        'gif' => 'image/gif',\n+        'ief' => 'image/ief',\n+        'jpeg' => 'image/jpeg',\n+        'jpg' => 'image/jpeg',\n+        'jpe' => 'image/jpeg',\n+        'png' => 'image/png',\n+        'tiff' => 'image/tiff',\n+        'tif' => 'image/tif',\n+        'djvu' => 'image/vnd.djvu',\n+        'djv' => 'image/vnd.djvu',\n+        'wbmp' => 'image/vnd.wap.wbmp',\n+        'ras' => 'image/x-cmu-raster',\n+        'pnm' => 'image/x-portable-anymap',\n+        'pbm' => 'image/x-portable-bitmap',\n+        'pgm' => 'image/x-portable-graymap',\n+        'ppm' => 'image/x-portable-pixmap',\n+        'rgb' => 'image/x-rgb',\n+        'xbm' => 'image/x-xbitmap',\n+        'xpm' => 'image/x-xpixmap',\n+        'xwd' => 'image/x-windowdump',\n+        'igs' => 'model/iges',\n+        'iges' => 'model/iges',\n+        'msh' => 'model/mesh',\n+        'mesh' => 'model/mesh',\n+        'silo' => 'model/mesh',\n+        'wrl' => 'model/vrml',\n+        'vrml' => 'model/vrml',\n+        'css' => 'text/css',\n+        'html' => 'text/html',\n+        'htm' => 'text/html',\n+        'asc' => 'text/plain',\n+        'txt' => 'text/plain',\n+        'rtx' => 'text/richtext',\n+        'rtf' => 'text/rtf',\n+        'sgml' => 'text/sgml',\n+        'sgm' => 'text/sgml',\n+        'tsv' => 'text/tab-seperated-values',\n+        'wml' => 'text/vnd.wap.wml',\n+        'wmls' => 'text/vnd.wap.wmlscript',\n+        'etx' => 'text/x-setext',\n+        'xml' => 'text/xml',\n+        'xsl' => 'text/xml',\n+        'mpeg' => 'video/mpeg',\n+        'mpg' => 'video/mpeg',\n+        'mpe' => 'video/mpeg',\n+        'qt' => 'video/quicktime',\n+        'mov' => 'video/quicktime',\n+        'mxu' => 'video/vnd.mpegurl',\n+        'avi' => 'video/x-msvideo',\n+        'movie' => 'video/x-sgi-movie',\n+        'ice' => 'x-conference-xcooltalk',\n+    ];\n+\n+    /** @var bool */\n     protected $display_header = false;\n     protected $display_footer = false;\n \n@@ -78,7 +209,6 @@ public function init()\n                 $this->displayCustomError('Invalid key.');\n             }\n \n-            $filename = $tmp[0];\n             $hash = $tmp[1];\n \n             if (!($info = OrderDetail::getDownloadFromHash($hash))) {\n@@ -136,8 +266,37 @@ public function init()\n             $filename = $info['display_filename'];\n         }\n \n-        /* Detect mime content type */\n-        $mimeType = false;\n+        $this->sendFile($file, $filename);\n+    }\n+\n+    protected function sendFile(string $file, string $filename, bool $forceDownload = true): void\n+    {\n+        if (ob_get_level() && ob_get_length() > 0) {\n+            ob_end_clean();\n+        }\n+\n+        /* Set headers for download */\n+        header('Content-Transfer-Encoding: binary');\n+        header('Content-Type: ' . $this->getMimeType($file, $filename));\n+        header('Content-Length: ' . filesize($file));\n+        if ($forceDownload) {\n+            header('Content-Disposition: attachment; filename=\"' . $filename . '\"');\n+        }\n+        //prevents max execution timeout, when reading large files\n+        @set_time_limit(0);\n+        $fp = fopen($file, 'rb');\n+\n+        if ($fp && is_resource($fp)) {\n+            while (!feof($fp)) {\n+                echo fgets($fp, 16384);\n+            }\n+        }\n+\n+        exit;\n+    }\n+\n+    private function getMimeType(string $file, string $filename): string\n+    {\n         if (function_exists('finfo_open')) {\n             $finfo = @finfo_open(FILEINFO_MIME);\n             $mimeType = @finfo_file($finfo, $file);\n@@ -159,163 +318,10 @@ public function init()\n             $bName = explode('.', $bName);\n             $bName = strtolower($bName[count($bName) - 1]);\n \n-            $mimeTypes = [\n-                'ez' => 'application/andrew-inset',\n-                'hqx' => 'application/mac-binhex40',\n-                'cpt' => 'application/mac-compactpro',\n-                'doc' => 'application/msword',\n-                'oda' => 'application/oda',\n-                'pdf' => 'application/pdf',\n-                'ai' => 'application/postscript',\n-                'eps' => 'application/postscript',\n-                'ps' => 'application/postscript',\n-                'smi' => 'application/smil',\n-                'smil' => 'application/smil',\n-                'wbxml' => 'application/vnd.wap.wbxml',\n-                'wmlc' => 'application/vnd.wap.wmlc',\n-                'wmlsc' => 'application/vnd.wap.wmlscriptc',\n-                'bcpio' => 'application/x-bcpio',\n-                'vcd' => 'application/x-cdlink',\n-                'pgn' => 'application/x-chess-pgn',\n-                'cpio' => 'application/x-cpio',\n-                'csh' => 'application/x-csh',\n-                'dcr' => 'application/x-director',\n-                'dir' => 'application/x-director',\n-                'dxr' => 'application/x-director',\n-                'dvi' => 'application/x-dvi',\n-                'spl' => 'application/x-futuresplash',\n-                'gtar' => 'application/x-gtar',\n-                'hdf' => 'application/x-hdf',\n-                'js' => 'application/x-javascript',\n-                'skp' => 'application/x-koan',\n-                'skd' => 'application/x-koan',\n-                'skt' => 'application/x-koan',\n-                'skm' => 'application/x-koan',\n-                'latex' => 'application/x-latex',\n-                'nc' => 'application/x-netcdf',\n-                'cdf' => 'application/x-netcdf',\n-                'sh' => 'application/x-sh',\n-                'shar' => 'application/x-shar',\n-                'swf' => 'application/x-shockwave-flash',\n-                'sit' => 'application/x-stuffit',\n-                'sv4cpio' => 'application/x-sv4cpio',\n-                'sv4crc' => 'application/x-sv4crc',\n-                'tar' => 'application/x-tar',\n-                'tcl' => 'application/x-tcl',\n-                'tex' => 'application/x-tex',\n-                'texinfo' => 'application/x-texinfo',\n-                'texi' => 'application/x-texinfo',\n-                't' => 'application/x-troff',\n-                'tr' => 'application/x-troff',\n-                'roff' => 'application/x-troff',\n-                'man' => 'application/x-troff-man',\n-                'me' => 'application/x-troff-me',\n-                'ms' => 'application/x-troff-ms',\n-                'ustar' => 'application/x-ustar',\n-                'src' => 'application/x-wais-source',\n-                'xhtml' => 'application/xhtml+xml',\n-                'xht' => 'application/xhtml+xml',\n-                'zip' => 'application/zip',\n-                'au' => 'audio/basic',\n-                'snd' => 'audio/basic',\n-                'mid' => 'audio/midi',\n-                'midi' => 'audio/midi',\n-                'kar' => 'audio/midi',\n-                'mpga' => 'audio/mpeg',\n-                'mp2' => 'audio/mpeg',\n-                'mp3' => 'audio/mpeg',\n-                'aif' => 'audio/x-aiff',\n-                'aiff' => 'audio/x-aiff',\n-                'aifc' => 'audio/x-aiff',\n-                'm3u' => 'audio/x-mpegurl',\n-                'ram' => 'audio/x-pn-realaudio',\n-                'rm' => 'audio/x-pn-realaudio',\n-                'rpm' => 'audio/x-pn-realaudio-plugin',\n-                'ra' => 'audio/x-realaudio',\n-                'wav' => 'audio/x-wav',\n-                'pdb' => 'chemical/x-pdb',\n-                'xyz' => 'chemical/x-xyz',\n-                'bmp' => 'image/bmp',\n-                'gif' => 'image/gif',\n-                'ief' => 'image/ief',\n-                'jpeg' => 'image/jpeg',\n-                'jpg' => 'image/jpeg',\n-                'jpe' => 'image/jpeg',\n-                'png' => 'image/png',\n-                'tiff' => 'image/tiff',\n-                'tif' => 'image/tif',\n-                'djvu' => 'image/vnd.djvu',\n-                'djv' => 'image/vnd.djvu',\n-                'wbmp' => 'image/vnd.wap.wbmp',\n-                'ras' => 'image/x-cmu-raster',\n-                'pnm' => 'image/x-portable-anymap',\n-                'pbm' => 'image/x-portable-bitmap',\n-                'pgm' => 'image/x-portable-graymap',\n-                'ppm' => 'image/x-portable-pixmap',\n-                'rgb' => 'image/x-rgb',\n-                'xbm' => 'image/x-xbitmap',\n-                'xpm' => 'image/x-xpixmap',\n-                'xwd' => 'image/x-windowdump',\n-                'igs' => 'model/iges',\n-                'iges' => 'model/iges',\n-                'msh' => 'model/mesh',\n-                'mesh' => 'model/mesh',\n-                'silo' => 'model/mesh',\n-                'wrl' => 'model/vrml',\n-                'vrml' => 'model/vrml',\n-                'css' => 'text/css',\n-                'html' => 'text/html',\n-                'htm' => 'text/html',\n-                'asc' => 'text/plain',\n-                'txt' => 'text/plain',\n-                'rtx' => 'text/richtext',\n-                'rtf' => 'text/rtf',\n-                'sgml' => 'text/sgml',\n-                'sgm' => 'text/sgml',\n-                'tsv' => 'text/tab-seperated-values',\n-                'wml' => 'text/vnd.wap.wml',\n-                'wmls' => 'text/vnd.wap.wmlscript',\n-                'etx' => 'text/x-setext',\n-                'xml' => 'text/xml',\n-                'xsl' => 'text/xml',\n-                'mpeg' => 'video/mpeg',\n-                'mpg' => 'video/mpeg',\n-                'mpe' => 'video/mpeg',\n-                'qt' => 'video/quicktime',\n-                'mov' => 'video/quicktime',\n-                'mxu' => 'video/vnd.mpegurl',\n-                'avi' => 'video/x-msvideo',\n-                'movie' => 'video/x-sgi-movie',\n-                'ice' => 'x-conference-xcooltalk',\n-            ];\n-\n-            if (isset($mimeTypes[$bName])) {\n-                $mimeType = $mimeTypes[$bName];\n-            } else {\n-                $mimeType = 'application/octet-stream';\n-            }\n-        }\n-\n-        if (ob_get_level() && ob_get_length() > 0) {\n-            ob_end_clean();\n+            $mimeType = static::MIME_TYPES[$bName] ?? 'application/octet-stream';\n         }\n \n-        /* Set headers for download */\n-        header('Content-Transfer-Encoding: binary');\n-        header('Content-Type: ' . $mimeType);\n-        header('Content-Length: ' . filesize($file));\n-        header('Content-Disposition: attachment; filename=\"' . $filename . '\"');\n-        //prevents max execution timeout, when reading large files\n-        @set_time_limit(0);\n-        $fp = fopen($file, 'rb');\n-\n-        if ($fp && is_resource($fp)) {\n-            while (!feof($fp)) {\n-                echo fgets($fp, 16384);\n-            }\n-        }\n-\n-        exit;\n+        return $mimeType;\n     }\n \n     /**"
        },
        {
          "filename": "controllers/front/UploadController.php",
          "status": "added",
          "additions": 80,
          "deletions": 0,
          "patch": "@@ -0,0 +1,80 @@\n+<?php\n+/**\n+ * Copyright since 2007 PrestaShop SA and Contributors\n+ * PrestaShop is an International Registered Trademark & Property of PrestaShop SA\n+ *\n+ * NOTICE OF LICENSE\n+ *\n+ * This source file is subject to the Open Software License (OSL 3.0)\n+ * that is bundled with this package in the file LICENSE.md.\n+ * It is also available through the world-wide-web at this URL:\n+ * https://opensource.org/licenses/OSL-3.0\n+ * If you did not receive a copy of the license and are unable to\n+ * obtain it through the world-wide-web, please send an email\n+ * to license@prestashop.com so we can send you a copy immediately.\n+ *\n+ * DISCLAIMER\n+ *\n+ * Do not edit or add to this file if you wish to upgrade PrestaShop to newer\n+ * versions in the future. If you wish to customize PrestaShop for your\n+ * needs please refer to https://devdocs.prestashop.com/ for more information.\n+ *\n+ * @author    PrestaShop SA and Contributors <contact@prestashop.com>\n+ * @copyright Since 2007 PrestaShop SA and Contributors\n+ * @license   https://opensource.org/licenses/OSL-3.0 Open Software License (OSL 3.0)\n+ */\n+\n+declare(strict_types=1);\n+\n+class UploadControllerCore extends GetFileController\n+{\n+    private $filename;\n+\n+    public function init()\n+    {\n+        FrontController::init();\n+        if (Tools::getValue('file') !== null) {\n+            $this->filename = pSQL(Tools::getValue('file'));\n+        }\n+\n+        if (!file_exists($this->getPath()) || (!$this->isCustomization() && !$this->isEmployee())) {\n+            $this->redirect_after = '404';\n+            $this->redirect();\n+        }\n+    }\n+\n+    private function isEmployee(): bool\n+    {\n+        return !empty((new Cookie('psAdmin'))->id_employee);\n+    }\n+\n+    private function isCustomization(): bool\n+    {\n+        if ($this->filename === null || !($this->context->cart instanceof Cart)) {\n+            return false;\n+        }\n+\n+        $isCustomization = Db::getInstance()->getValue('SELECT 1\n+            FROM ' . _DB_PREFIX_ . 'cart c\n+            INNER JOIN ' . _DB_PREFIX_ . 'customization cu ON c.id_cart = cu.id_cart\n+            INNER JOIN ' . _DB_PREFIX_ . 'customized_data cd ON cd.id_customization = cu.id_customization\n+            LEFT JOIN ' . _DB_PREFIX_ . 'orders o ON c.id_cart = o.id_cart\n+            WHERE (c.id_customer = ' . (int) $this->context->cart->id_customer . '\n+            AND c.id_guest = ' . (int) $this->context->cart->id_guest . '\n+            OR o.reference = \"' . pSQL(Tools::getValue('reference')) . '\")\n+            AND cd.type = ' . Product::CUSTOMIZE_FILE . '\n+            AND (cd.value = \"' . $this->filename . '\" OR CONCAT(cd.value, \"_small\") = \"' . $this->filename . '\")');\n+\n+        return (bool) $isCustomization;\n+    }\n+\n+    public function postProcess()\n+    {\n+        $this->sendFile($this->getPath(), $this->filename, false);\n+    }\n+\n+    private function getPath(): string\n+    {\n+        return _PS_UPLOAD_DIR_ . $this->filename;\n+    }\n+}"
        },
        {
          "filename": "src/Adapter/Image/ImageRetriever.php",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -243,8 +243,8 @@ public function getImage($object, $id_image)\n      */\n     public function getCustomizationImage($imageHash)\n     {\n-        $large_image_url = rtrim($this->link->getBaseLink(), '/') . '/upload/' . $imageHash;\n-        $small_image_url = $large_image_url . '_small';\n+        $large_image_url = $this->link->getPageLink('upload', null, null, ['file' => $imageHash]);\n+        $small_image_url = $this->link->getPageLink('upload', null, null, ['file' => $imageHash . '_small']);\n \n         $small = [\n             'url' => $small_image_url,"
        },
        {
          "filename": "src/Adapter/Presenter/Order/OrderLazyArray.php",
          "status": "modified",
          "additions": 36,
          "deletions": 1,
          "patch": "@@ -221,7 +221,7 @@ public function getProducts()\n \n         $orderProducts = $this->cartPresenter->addCustomizedData($orderProducts, $cart);\n \n-        return $orderProducts;\n+        return $this->addOrderReferenceToCustomizationFileUrls($orderProducts);\n     }\n \n     /**\n@@ -465,4 +465,39 @@ private function getDefaultHistory()\n             'contrast' => '',\n         ];\n     }\n+\n+    private function addOrderReferenceToCustomizationFileUrls(array $products): array\n+    {\n+        /**\n+         * @param array|string $url\n+         *\n+         * @return array|string\n+         */\n+        $addReferenceFunction = function ($imageUrl) use (&$addReferenceFunction) {\n+            if (is_array($imageUrl)) {\n+                foreach ($imageUrl as $key => $url) {\n+                    $imageUrl[$key] = $addReferenceFunction($url);\n+                }\n+            } else {\n+                // deconstruct the url and rebuild it with the reference query added\n+                $parsedUrl = parse_url($imageUrl);\n+                parse_str($parsedUrl['query'] ?? '', $parsedQuery);\n+                $newQuery = http_build_query(array_merge($parsedQuery, ['reference' => $this->order->reference]));\n+                $imageUrl = http_build_url(array_merge($parsedUrl, ['query' => $newQuery]));\n+            }\n+\n+            return $imageUrl;\n+        };\n+        foreach ($products as &$product) {\n+            foreach ($product['customizations'] as &$customization) {\n+                foreach ($customization['fields'] as &$field) {\n+                    if ($field['type'] === 'image') {\n+                        $field['image'] = $addReferenceFunction($field['image']);\n+                    }\n+                }\n+            }\n+        }\n+\n+        return $products;\n+    }\n }"
        },
        {
          "filename": "upload/.htaccess",
          "status": "modified",
          "additions": 10,
          "deletions": 10,
          "patch": "@@ -1,12 +1,12 @@\n-<IfModule mod_mime.c>\n-    RemoveHandler .php .phtml .php3 .php4 .php5\n-    RemoveType .php .phtml .php3 .php4 .php5\n-</IfModule>\n-<IfModule mod_php5.c>\n-    php_flag engine off\n-</IfModule>\n+<IfModule !mod_rewrite.c>\n+  # Apache 2.2\n+  <IfModule !mod_authz_core.c>\n+      Order deny,allow\n+      Deny from all\n+  </IfModule>\n \n-<IfModule mod_headers.c>\n-  Header set Content-Disposition \"Attachment\"\n-  Header set X-Content-Type-Options \"nosniff\"\n+  # Apache 2.4\n+  <IfModule mod_authz_core.c>\n+      Require all denied\n+  </IfModule>\n </IfModule>"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 7,
        "max_directory_depth": 8
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "ec433fcf5603cc11c33b8ce76940ffca39dfa7ab",
            "date": "2025-01-14T08:52:42Z",
            "author_login": "Progi1984"
          },
          {
            "sha": "2efb789589029b6a04a5a629ba45b71b8f37fd6c",
            "date": "2025-01-13T16:37:17Z",
            "author_login": "dependabot[bot]"
          },
          {
            "sha": "18e642c26a83c05e0a67b05c86385afd070b68fb",
            "date": "2025-01-13T16:11:19Z",
            "author_login": "Progi1984"
          },
          {
            "sha": "9641d8eca066dce510c61ff7298ee98a77f8bf3d",
            "date": "2025-01-13T16:08:47Z",
            "author_login": "Progi1984"
          },
          {
            "sha": "aca73a664e3f3b5873379124794b41d49741ab2e",
            "date": "2025-01-13T06:36:38Z",
            "author_login": "dependabot[bot]"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 5.3,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:N",
    "cwe_id": "CWE-200",
    "description": "PrestaShop is an open-source e-commerce solution. Versions prior to 1.7.8.8 did not properly restrict host filesystem access for users. Users may have been able to view the contents of the upload directory without appropriate permissions. This issue has been addressed and users are advised to upgrade to version 1.7.8.8. There are no known workarounds for this issue.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2022-12-08T22:15:10.640",
    "last_modified": "2024-11-21T07:30:13.590",
    "fix_date": "2022-12-06T14:40:19Z"
  },
  "references": [
    {
      "url": "https://github.com/PrestaShop/PrestaShop/commit/8684d429fb7c3bb51efb098e8b92a1fd2958f8cf",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/PrestaShop/PrestaShop/security/advisories/GHSA-9qgp-9wwc-v29r",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/PrestaShop/PrestaShop/commit/8684d429fb7c3bb51efb098e8b92a1fd2958f8cf",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/PrestaShop/PrestaShop/security/advisories/GHSA-9qgp-9wwc-v29r",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:04:21.217072",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "PrestaShop",
    "owner": "PrestaShop",
    "created_at": "2012-11-19T16:41:31Z",
    "updated_at": "2025-01-14T08:52:52Z",
    "pushed_at": "2025-01-14T09:09:53Z",
    "size": 763335,
    "stars": 8320,
    "forks": 4829,
    "open_issues": 2738,
    "watchers": 8320,
    "has_security_policy": false,
    "default_branch": "develop",
    "protected_branches": [
      "1.7.7.x",
      "1.7.8.x",
      "8.0.x",
      "8.1.x",
      "8.2.x",
      "9.0.x",
      "develop"
    ],
    "languages": {
      "PHP": 29053069,
      "TypeScript": 9773631,
      "Gherkin": 2649810,
      "Twig": 2491625,
      "HTML": 1695839,
      "JavaScript": 1449413,
      "Smarty": 993383,
      "SCSS": 499157,
      "Vue": 331001,
      "CSS": 163083,
      "Less": 19680,
      "Shell": 15677,
      "Makefile": 1814,
      "Dockerfile": 1141
    },
    "commit_activity": {
      "total_commits_last_year": 3038,
      "avg_commits_per_week": 58.42307692307692,
      "days_active_last_year": 281
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T13:11:29.329599"
  }
}