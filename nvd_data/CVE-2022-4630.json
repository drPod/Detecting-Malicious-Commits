{
  "cve_id": "CVE-2022-4630",
  "github_data": {
    "repository": "lirantal/daloradius",
    "fix_commit": "6878619dc661b3009429777a1aeeb383ddc0166b",
    "related_commits": [
      "6878619dc661b3009429777a1aeeb383ddc0166b",
      "6878619dc661b3009429777a1aeeb383ddc0166b"
    ],
    "patch_url": "https://github.com/lirantal/daloradius/commit/6878619dc661b3009429777a1aeeb383ddc0166b.patch",
    "fix_commit_details": {
      "sha": "6878619dc661b3009429777a1aeeb383ddc0166b",
      "commit_date": "2022-12-16T13:45:00Z",
      "author": {
        "login": "filippolauria",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Improved attribute dictionaries management feature (#316)",
        "length": 99,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 3723,
        "additions": 1679,
        "deletions": 2044
      },
      "files": [
        {
          "filename": "acct-active.php",
          "status": "modified",
          "additions": 2,
          "deletions": 5,
          "patch": "@@ -27,8 +27,9 @@\n     include('library/check_operator_perm.php');\n     include_once('library/config_read.php');\n \n-    // include validation utils\n+    include_once(\"lang/main.php\");\n     include(\"library/validation.php\");\n+    include(\"library/layout.php\");\n \n     // validate this parameter before including menu\n     $username = (array_key_exists('username', $_GET) && isset($_GET['username']))\n@@ -55,10 +56,6 @@\n     $logQuery = \"performed query for user [$username] and start date [$startdate] and end date [$enddate] on page: \";\n     $logDebugSQL = \"\";\n     \n-    include_once(\"lang/main.php\");\n-    \n-    include(\"library/layout.php\");\n-\n     // print HTML prologue\n     $title = t('Intro','acctactive.php');\n     $help = t('helpPage','acctactive');"
        },
        {
          "filename": "acct-all.php",
          "status": "modified",
          "additions": 3,
          "deletions": 6,
          "patch": "@@ -27,18 +27,15 @@\n     include('library/check_operator_perm.php');\n     include_once('library/config_read.php');\n     \n+    include_once(\"lang/main.php\");\n+    include(\"library/validation.php\");\n+    include(\"library/layout.php\");\n \n     // init logging variables\n     $log = \"visited page: \";\n     $logQuery = \"performed query for all accounting records on page: \";\n     $logDebugSQL = \"\";\n \n-    include(\"library/validation.php\");\n-\n-    include_once(\"lang/main.php\");\n-    \n-    include(\"library/layout.php\");\n-\n     // print HTML prologue\n     $title = t('Intro','acctall.php');\n     $help = t('helpPage','acctall');"
        },
        {
          "filename": "acct-custom-query.php",
          "status": "modified",
          "additions": 9,
          "deletions": 9,
          "patch": "@@ -25,6 +25,11 @@\n     $operator = $_SESSION['operator_user'];\n \n     include('library/check_operator_perm.php');\n+    include_once('library/config_read.php');\n+\n+    include_once(\"lang/main.php\");\n+    include(\"library/validation.php\");\n+    include(\"library/layout.php\");\n \n     // init logging variables\n     $log = \"visited page: \";\n@@ -34,10 +39,6 @@\n     // set session's page variable\n     $_SESSION['PREV_LIST_PAGE'] = $_SERVER['REQUEST_URI'];\n \n-    include_once('library/config_read.php');\n-    \n-    include(\"library/validation.php\");\n-    \n     $sqlfields = (array_key_exists('sqlfields', $_GET) && !empty($_GET['sqlfields']) && is_array($_GET['sqlfields']) &&\n                   array_intersect($_GET['sqlfields'], $acct_custom_query_options_all) == $_GET['sqlfields'])\n                ? $_GET['sqlfields'] : $acct_custom_query_options_default;\n@@ -86,9 +87,6 @@\n     $accounting_custom_enddate = $enddate;\n     $accounting_custom_value = $where_value_enc;\n \n-    include_once(\"lang/main.php\");\n-    \n-    include(\"library/layout.php\");\n \n     // print HTML prologue\n     $extra_js = array(\n@@ -203,12 +201,14 @@\n            . '<tbody>';\n \n         // inserting the values of each field from the database to the table\n+        $count = 0;\n         while($row = $res->fetchRow(DB_FETCHMODE_ASSOC)) {\n-            echo \"<tr>\";\n+            printf('<tr id=\"row-%d\">', $count);\n             foreach ($sqlfields as $field) {\n                 printf(\"<td>%s</td>\", htmlspecialchars($row[$field], ENT_QUOTES, 'UTF-8'));\n             }\n-            echo \"</tr>\";\n+            echo '</tr>';\n+            $count++;\n         }\n \n         echo '</tbody>';"
        },
        {
          "filename": "acct-custom.php",
          "status": "modified",
          "additions": 1,
          "deletions": 3,
          "patch": "@@ -27,10 +27,8 @@\n     include_once('library/config_read.php');\n     $log = \"visited page: \";\n \n-    include(\"library/validation.php\");\n-\n     include_once(\"lang/main.php\");\n-    \n+    include(\"library/validation.php\");\n     include(\"library/layout.php\");\n \n     // print HTML prologue"
        },
        {
          "filename": "acct-date.php",
          "status": "modified",
          "additions": 2,
          "deletions": 4,
          "patch": "@@ -27,8 +27,9 @@\n     include('library/check_operator_perm.php');\n     include_once('library/config_read.php');\n \n-    // include validation utils\n+    include_once(\"lang/main.php\");\n     include(\"library/validation.php\");\n+    include(\"library/layout.php\");\n     \n     // validate this parameter before including menu\n     $username = (array_key_exists('username', $_GET) && isset($_GET['username']))\n@@ -55,9 +56,6 @@\n     $logQuery = \"performed query for user [$username] and start date [$startdate] and end date [$enddate] on page: \";\n     $logDebugSQL = \"\";\n \n-    include_once(\"lang/main.php\");\n-    \n-    include(\"library/layout.php\");\n \n     // print HTML prologue\n     $title = t('Intro','acctdate.php');"
        },
        {
          "filename": "acct-ipaddress.php",
          "status": "modified",
          "additions": 3,
          "deletions": 3,
          "patch": "@@ -27,7 +27,9 @@\n     include('library/check_operator_perm.php');\n     include_once('library/config_read.php');\n \n+    include_once(\"lang/main.php\");\n     include(\"library/validation.php\");\n+    include(\"library/layout.php\");\n     \n     // validate this parameter before including menu\n     $ipaddress = (array_key_exists('ipaddress', $_GET) && isset($_GET['ipaddress']) &&\n@@ -43,10 +45,8 @@\n                         ((!empty($ipaddress)) ? \"IP address [$ipaddress]\" : \"all IP addresses\"));\n     $logDebugSQL = \"\";\n     \n-    include_once(\"lang/main.php\");\n-    \n-    include(\"library/layout.php\");\n     \n+    // print HTML prologue\n     $title = t('Intro','acctipaddress.php');\n     $help = t('helpPage','acctipaddress');\n     "
        },
        {
          "filename": "acct-main.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -44,4 +44,5 @@\n     \n     include('include/config/logging.php');\n     print_footer_and_html_epilogue();\n+\n ?>"
        },
        {
          "filename": "acct-nasipaddress.php",
          "status": "modified",
          "additions": 3,
          "deletions": 4,
          "patch": "@@ -27,7 +27,9 @@\n     include('library/check_operator_perm.php');\n     include_once('library/config_read.php');\n \n+    include_once(\"lang/main.php\");\n     include(\"library/validation.php\");\n+    include(\"library/layout.php\");\n \n     // validate this parameter before including menu\n     $onlyactive = (array_key_exists('only-active', $_GET) && isset($_GET['only-active']));\n@@ -46,10 +48,7 @@\n                         ((!empty($nasipaddress)) ? \"NAS IP address [$nasipaddress]\" : \"all NAS IP addresses\"));\n     $logDebugSQL = \"\";\n     \n-    include_once(\"lang/main.php\");\n-    \n-    include(\"library/layout.php\");\n-    \n+    // print HTML prologue\n     $title = t('Intro','acctnasipaddress.php');\n     $help = t('helpPage','acctnasipaddress');\n     "
        },
        {
          "filename": "acct-username.php",
          "status": "modified",
          "additions": 6,
          "deletions": 7,
          "patch": "@@ -27,9 +27,13 @@\n     include('library/check_operator_perm.php');\n     include_once('library/config_read.php');\n \n+    include_once(\"lang/main.php\");\n+    include(\"library/validation.php\");\n+    include(\"library/layout.php\");\n+\n     // validate this parameter before including menu\n-    $username = (array_key_exists('username', $_GET) && isset($_GET['username']))\n-                    ? str_replace(\"%\", \"\", $_GET['username']) : \"\";\n+    $username = (array_key_exists('username', $_GET) && !empty(str_replace(\"%\", \"\", trim($_GET['username']))))\n+              ? str_replace(\"%\", \"\", trim($_GET['username'])) : \"\";\n     $username_enc = (!empty($username)) ? htmlspecialchars($username, ENT_QUOTES, 'UTF-8') : \"\";\n \n     // init logging variables\n@@ -44,11 +48,6 @@\n     //feed the sidebar variables\n     $accounting_username = $username_enc;\n     \n-    include(\"library/validation.php\");\n-\n-    include_once(\"lang/main.php\");\n-    \n-    include(\"library/layout.php\");\n \n     // print HTML prologue\n     $title = t('Intro','acctusername.php');"
        },
        {
          "filename": "bill-history-query.php",
          "status": "modified",
          "additions": 185,
          "deletions": 258,
          "patch": "@@ -1,4 +1,4 @@\n-<?php\n+<?php \n /*\n  *********************************************************************************************************\n  * daloRADIUS - RADIUS Web Platform\n@@ -15,271 +15,198 @@\n  *\n  *********************************************************************************************************\n  *\n- * Authors:\tLiran Tal <liran@enginx.com>\n+ * Authors:    Liran Tal <liran@enginx.com>\n+ *             Filippo Lauria <filippo.lauria@iit.cnr.it>\n  *\n  *********************************************************************************************************\n  */\n \n-    include (\"library/checklogin.php\");\n+    include(\"library/checklogin.php\");\n     $operator = $_SESSION['operator_user'];\n \n-\tinclude('library/check_operator_perm.php');\n-\t\n-\t//setting values for the order by and order type variables\n-\tisset($_GET['orderBy']) ? $orderBy = $_GET['orderBy'] : $orderBy = \"radacctid\";\n-\tisset($_GET['orderType']) ? $orderType = $_GET['orderType'] : $orderType = \"asc\";\n+    include('library/check_operator_perm.php');\n+    include_once('library/config_read.php');\n \n+    include_once(\"lang/main.php\");\n+    include(\"library/validation.php\");\n+    include(\"library/layout.php\");\n \n-\tisset($_GET['username']) ? $username = trim($_GET['username']) : $username = \"%\";\n-\tisset($_GET['billaction']) ? $billaction = trim($_GET['billaction']) : $billaction = \"\";\n-\tisset($_GET['sqlfields']) ? $sqlfields = $_GET['sqlfields'] : $sqlfields = \"\";\n-\tisset($_GET['startdate']) ? $startdate = $_GET['startdate'] : $startdate = \"\";\n-\tisset($_GET['enddate']) ? $enddate = $_GET['enddate'] : $enddate = \"\";\n-\n-\n-\t$username = str_replace('*', '%', $username);\n-\n-\t//feed the sidebar variables\n-\t$billing_date_startdate = $startdate;\n-\t$billing_date_enddate = $enddate;\n-\t$billing_history_username = $username;\n-\t$billing_history_billaction = $billaction;\n-\n-\n-\tinclude_once('library/config_read.php');\n+    // init loggin variables\n     $log = \"visited page: \";\n-    $logQuery = \"performed query for all accounting records on page: \";\n-\n-?>\n-\n-<?php\n-\tinclude(\"menu-bill-history.php\");\n-?>\n-\n-\t\t<div id=\"contentnorightbar\">\n-\t\t\n-\t\t<h2 id=\"Intro\"><a href=\"#\" onclick=\"javascript:toggleShowDiv('helpPage')\"><?php echo t('Intro','billhistoryquery.php')?>\n-\t\t<h144>&#x2754;</h144></a></h2>\n-\t\t\t\t\n-\t\t<div id=\"helpPage\" style=\"display:none;visibility:visible\" >\n-\t\t\t<?php echo t('helpPage','billhistoryquery') ?>\n-\t\t\t<br/>\n-\t\t</div>\n-\t\t<br/>\n-\n-\n-\n-<?php\n-\n-\t\tinclude 'library/opendb.php';\n-\t\tinclude 'include/management/pages_common.php';\t\n-\t\tinclude 'include/management/pages_numbering.php';\t\t// must be included after opendb because it needs to read the CONFIG_IFACE_TABLES_LISTING variable from the config file\n-\n-\t\t// let's sanitize the values passed to us:\n-\t\t$username = $dbSocket->escapeSimple($username);\n-\t\t$billaction = $dbSocket->escapeSimple($billaction);\n-\t\t$startdate = $dbSocket->escapeSimple($startdate);\n-\t\t$enddate = $dbSocket->escapeSimple($enddate);\n-\n-//\t        include_once('include/management/userBilling.php');\n-//\t        userBillingPayPalSummary($startdate, $enddate, $payer_email, $payment_address_status, $payer_status, $payment_status, 1);\n-\t\t\t\t\t\t\t\t\t                         // draw the billing rates summary table\n-\n-\n-\t        include 'library/opendb.php';\n-\t\t// since we need to span through pages, which we do using GET queries I can't rely on this page\n-\t\t// to be processed through POST but rather using GET only (with the current design anyway).\n-\t\t// For this reason, I need to build the GET query which I will later use in the page number's links\n-\n-\t\t$getFields = \"\";\n-\t\t$counter = 0;\n-\t\tforeach ($sqlfields as $elements) {\n-\t\t\t$getFields .= \"&sqlfields[$counter]=$elements\";\n-\t\t\t$counter++;\n-\t\t}\n-\n-\t\t// we should also sanitize the array that we will be passing to this page in the next query\n-\t\t$getFields = $dbSocket->escapeSimple($getFields);\n-\n-\n-\t\t$getQuery = \"\";\n-\t\t$getQuery .= \"&username=$username\";\n-\t\t$getQuery .= \"&billAction=$billaction\";\n-\t\t$getQuery .= \"&startdate=$startdate&enddate=$enddate\";\n-\n-\n-\t\t$select = implode(\",\", $sqlfields);\n-\t\t// sanitizing the array passed to us in the get request\n-\t\t$select = $dbSocket->escapeSimple($select);\n-\n-\n-\t\t$sql = \"SELECT $select FROM \".$configValues['CONFIG_DB_TBL_DALOBILLINGHISTORY'].\" WHERE \".\n-\t\t\t\" (username LIKE '$username') AND \".\n-\t\t\t\" (billAction LIKE '$billaction') \";\n-\t\t$res = $dbSocket->query($sql);\n-\t\t$numrows = $res->numRows();\n-\n-\n-\t\t$sql = \"SELECT $select FROM \".$configValues['CONFIG_DB_TBL_DALOBILLINGHISTORY'].\" WHERE \".\n-\t\t\t\" (username LIKE '$username') AND \".\n-\t\t\t\" (billAction LIKE '$billaction') \".\n-\t\t\t\" ORDER BY $orderBy $orderType LIMIT $offset, $rowsPerPage;\";\n-\t\t$res = $dbSocket->query($sql);\n-\t\t$logDebugSQL = \"\";\n-\t\t$logDebugSQL .= $sql . \"\\n\";\n-\n-\n-\t/* START - Related to pages_numbering.php */\n-\t$maxPage = ceil($numrows/$rowsPerPage);\n-\t/* END */\n-\n-\n-\techo \"<table border='0' class='table1'>\\n\";\n-\techo \"\n-\t\t\t\t\t<thead>\n-\t\t\t\t\t\t\t<tr>\n-\t\t\t\t\t\t\t<th colspan='25'>\".t('all','Records').\"</th>\n-\t\t\t\t\t\t\t</tr>\n-\n-                                                        <tr>\n-                                                        <th colspan='25' align='left'>\n-                <br/>\n-        \";\n-\n-        if ($configValues['CONFIG_IFACE_TABLES_LISTING_NUM'] == \"yes\")\n-                setupNumbering($numrows, $rowsPerPage, $pageNum, $orderBy, $orderType, $getFields, $getQuery);\n-\n-        echo \" </th></tr>\n-                                        </thead>\n-\n-                        \";\n-\n-\n-\t// building the dybamic table list fields\n-\techo \"<thread> <tr>\";\n-\tforeach ($sqlfields as $value) {\n-\t\tswitch($value) {\n-\n-\t\tcase \"id\":\n-\t\t\t$title = t('all','ID');\n-\t\t\tbreak;\n-\t\tcase \"username\":\n-\t\t\t$title = t('all','Username');\n-\t\t\tbreak;\n-\t\tcase \"planId\":\n-\t\t\t$title = t('all','PlanId');\n-\t\t\tbreak;\n-\t\tcase \"billAmount\":\n-\t\t\t$title = t('all','BillAmount');\n-\t\t\tbreak;\n-\t\tcase \"billAction\":\n-\t\t\t$title = t('all','BillAction');\n-\t\t\tbreak;\n-\t\tcase \"billPerformer\":\n-\t\t\t$title = t('all','BillPerformer');\n-\t\t\tbreak;\n-\t\tcase \"billReason\":\n-\t\t\t$title = t('all','BillReason');\n-\t\t\tbreak;\n-\t\tcase \"paymentmethod\":\n-\t\t\t$title = t('ContactInfo','PaymentMethod');\n-\t\t\tbreak;\n-\t\tcase \"cash\":\n-\t\t\t$title = t('ContactInfo','Cash');\n-\t\t\tbreak;\n-\t\tcase \"creditcardname\":\n-\t\t\t$title = t('ContactInfo','CreditCardName');\n-\t\t\tbreak;\n-\t\tcase \"creditcardnumber\":\n-\t\t\t$title = t('ContactInfo','CreditCardNumber');\n-\t\t\tbreak;\n-\t\tcase \"creditcardverification\":\n-\t\t\t$title = t('ContactInfo','CreditCardVerificationNumber');\n-\t\t\tbreak;\n-\t\tcase \"creditcardtype\":\n-\t\t\t$title = t('ContactInfo','CreditCardType');\n-\t\t\tbreak;\n-\t\tcase \"creditcardexp\":\n-\t\t\t$title = t('ContactInfo','CreditCardExpiration');\n-\t\t\tbreak;\n-\t\tcase \"coupon\":\n-\t\t\t$title = t('all','Coupon');\n-\t\t\tbreak;\n-\t\tcase \"discount\":\n-\t\t\t$title = t('all','Discount');\n-\t\t\tbreak;\n-\t\tcase \"notes\":\n-\t\t\t$title = t('ContactInfo','Notes');\n-\t\t\tbreak;\n-\t\tcase \"creationdate\":\n-\t\t\t$title = t('all','CreationDate');\n-\t\t\tbreak;\n-\t\tcase \"creationby\":\n-\t\t\t$title = t('all','CreationBy');\n-\t\t\tbreak;\n-\t\tcase \"updatedate\":\n-\t\t\t$title = t('all','UpdateDate');\n-\t\t\tbreak;\n-\t\tcase \"updateby\":\n-\t\t\t$title = t('all','UpdateBy');\n-\t\t\tbreak;\n-\t\tdefault:\n-\t\t\t$title = $value;\n-\t\t\tbreak;\n-\t\t}\n-\n-\t\techo \"<th scope='col'> $title   </th>\";\n-\t} //foreach $sqlfields\n-\techo \"</tr> </thread>\";\n-\n-\n-\t// inserting the values of each field from the database to the table\n-\twhile($row = $res->fetchRow(DB_FETCHMODE_ASSOC)) {\n-\t\techo \"<tr>\";\n-\t\tforeach ($sqlfields as $value) {\n-\t\t\techo \"<td> \" . $row[$value] . \"</td>\";\n-\t\t}\n-\t\techo \"</tr>\";\n-\t}\n-\n-        echo \"\n-                                        <tfoot>\n-                                                        <tr>\n-                                                        <th colspan='25' align='left'>\n-        \";\n-        setupLinks($pageNum, $maxPage, $orderBy, $orderType, $getFields, $getQuery);\n-        echo \"\n-                                                        </th>\n-                                                        </tr>\n-                                        </tfoot>\n-                \";\n-\n-\techo \"</table>\";\n-\n-\tinclude 'library/closedb.php';\n+    $logQuery = \"performed query for listing of records on page: \";\n+    $logDebugSQL = \"\";\n+\n+    // set session's page variable\n+    $_SESSION['PREV_LIST_PAGE'] = $_SERVER['REQUEST_URI'];\n+\n+    $sqlfields = (array_key_exists('sqlfields', $_GET) && !empty($_GET['sqlfields']) && is_array($_GET['sqlfields']) &&\n+                  array_intersect($_GET['sqlfields'], array_keys($bill_history_query_options_all)) == $_GET['sqlfields'])\n+               ? $_GET['sqlfields'] : $bill_history_query_options_default;\n+    \n+    $cols = array();\n+    foreach ($sqlfields as $sqlfield) {\n+        $cols[$sqlfield] = $bill_history_query_options_all[$sqlfield];\n+    }\n+    $colspan = count($cols);\n+    $half_colspan = intdiv($colspan, 2);\n+    \n+    $orderBy = (array_key_exists('orderBy', $_GET) && isset($_GET['orderBy']) &&\n+                in_array($_GET['orderBy'], array_keys($bill_history_query_options_all)))\n+             ? $_GET['orderBy'] : array_keys($bill_history_query_options_all)[0];\n+\n+    $orderType = (array_key_exists('orderType', $_GET) && isset($_GET['orderType']) &&\n+                  preg_match(ORDER_TYPE_REGEX, $_GET['orderType']) !== false)\n+               ? strtolower($_GET['orderType']) : \"asc\";\n+    \n+    //~ $startdate = (array_key_exists('startdate', $_GET) && isset($_GET['startdate']) &&\n+                  //~ preg_match(DATE_REGEX, $_GET['startdate'], $m) !== false &&\n+                  //~ checkdate($m[2], $m[3], $m[1]))\n+               //~ ? $_GET['startdate'] : \"\";\n+\n+    //~ $enddate = (array_key_exists('enddate', $_GET) && isset($_GET['enddate']) &&\n+                //~ preg_match(DATE_REGEX, $_GET['enddate'], $m) !== false &&\n+                //~ checkdate($m[2], $m[3], $m[1]))\n+             //~ ? $_GET['enddate'] : \"\";\n+\n+    $username = (array_key_exists('username', $_GET) && !empty(str_replace(\"%\", \"\", trim($_GET['username']))))\n+              ? str_replace(\"%\", \"\", trim($_GET['username'])) : \"\";\n+    $username_enc = (!empty($username)) ? htmlspecialchars($username, ENT_QUOTES, 'UTF-8') : \"\";\n+    \n+    $billaction = (array_key_exists('billaction', $_GET) && isset($_GET['billaction']) &&\n+                   in_array($_GET['billaction'], array_slice($valid_billactions,\u00a01))) // avoid inserting \"Any\" in the SQL query\n+                ? $_GET['billaction'] : \"\";\n+    $billaction_enc = (!empty($billaction)) ? htmlspecialchars($billaction, ENT_QUOTES, 'UTF-8') : \"\";\n+    \n+    // print HTML prologue\n+    $title = t('Intro','billhistoryquery.php');\n+    $help = t('helpPage','billhistoryquery');\n+    \n+    print_html_prologue($title, $langCode);\n+    \n+\n+    //feed the sidebar variables\n+    $billing_date_startdate = $startdate;\n+    $billing_date_enddate = $enddate;\n+    $billing_history_username = $username;\n+    $billing_history_billaction = $billaction;\n+\n+    include(\"menu-bill-history.php\");\n+    \n+    echo '<div id=\"contentnorightbar\">';\n+    print_title_and_help($title, $help);\n+    \n+    include('library/opendb.php');\n+    include('include/management/pages_common.php');\n+    \n+    // preparing the custom query\n+    \n+    $sql_WHERE = array();\n+    $partial_query_string_pieces = array();\n+    \n+    foreach ($sqlfields as $sqlfield) {\n+        $partial_query_string_pieces[] = sprintf(\"sqlfields[]=%s\", $sqlfield);\n+    }\n+    \n+    //~ if (!empty($startdate)) {\n+        //~ $sql_WHERE[] = sprintf(\"AcctStartTime > '%s'\", $dbSocket->escapeSimple($startdate));\n+        //~ $partial_query_string_pieces[] = sprintf(\"startdate=%s\", $startdate);\n+    //~ }\n+    \n+    //~ if (!empty($startdate)) {\n+        //~ $sql_WHERE[] = sprintf(\"AcctStartTime < '%s'\", $dbSocket->escapeSimple($enddate));\n+        //~ $partial_query_string_pieces[] = sprintf(\"enddate=%s\", $enddate);\n+    //~ }\n+    \n+    if (!empty($username)) {\n+        $sql_WHERE[] = sprintf(\"username LIKE '%s%%'\", $dbSocket->escapeSimple($username));\n+        $partial_query_string_pieces[] = sprintf(\"username=%s\", $username_enc);\n+    }\n+    \n+    if (!empty($billaction)) {\n+        $sql_WHERE[] = sprintf(\"billaction LIKE '%s%%'\", $dbSocket->escapeSimple($billaction));\n+        $partial_query_string_pieces[] = sprintf(\"billaction=%s\", $billaction_enc);\n+    }\n+    \n+    // executing the custom query\n+\n+    $sql = sprintf(\"SELECT %s FROM %s\", implode(\", \", $sqlfields), $configValues['CONFIG_DB_TBL_DALOBILLINGHISTORY']);\n+    \n+    if (count($sql_WHERE) > 0) {\n+        $sql .= \" WHERE \" . implode(\" AND \", $sql_WHERE);\n+    }\n+\n+    $res = $dbSocket->query($sql);\n+    $logDebugSQL .= \"$sql;\\n\";\n+    \n+    $numrows = $res->numRows();\n+    \n+    if ($numrows > 0) {\n+        /* START - Related to pages_numbering.php */\n+        \n+        // when $numrows is set, $maxPage is calculated inside this include file\n+        include('include/management/pages_numbering.php');    // must be included after opendb because it needs to read\n+                                                              // the CONFIG_IFACE_TABLES_LISTING variable from the config file\n+        \n+        // here we decide if page numbers should be shown\n+        $drawNumberLinks = strtolower($configValues['CONFIG_IFACE_TABLES_LISTING_NUM']) == \"yes\" && $maxPage > 1;\n+        \n+        $sql .= sprintf(\" ORDER BY %s %s LIMIT %s, %s\", $orderBy, $orderType, $offset, $rowsPerPage);\n+        $res = $dbSocket->query($sql);\n+        $logDebugSQL .= \"$sql;\\n\";\n+        \n+        $per_page_numrows = $res->numRows();\n+        \n+        // the partial query is built starting from user input\n+        // and for being passed to setupNumbering and setupLinks functions\n+        $partial_query_string = (count($partial_query_string_pieces) > 0)\n+                              ? \"&\" . implode(\"&\", $partial_query_string_pieces) : \"\";\n+        \n+        echo '<table border=\"0\" class=\"table1\">'\n+           . '<thead>';\n+            \n+        // page numbers are shown only if there is more than one page\n+        if ($drawNumberLinks) {\n+            echo '<tr style=\"background-color: white\">';\n+            printf('<td style=\"text-align: left\" colspan=\"%s\">go to page: ', $colspan);\n+            setupNumbering($numrows, $rowsPerPage, $pageNum, $orderBy, $orderType, $partial_query_string);\n+            echo '</td>' . '</tr>';\n+        }\n+\n+        // second line of table header\n+        echo \"<tr>\";\n+        printTableHead($cols, $orderBy, $orderType, $partial_query_string);\n+        echo \"</tr>\";\n+        \n+        echo '</thead>'\n+           . '<tbody>';\n+\n+        // inserting the values of each field from the database to the table\n+        $count = 0;\n+        while($row = $res->fetchRow(DB_FETCHMODE_ASSOC)) {\n+            printf('<tr id=\"row-%d\">', $count);\n+            foreach ($sqlfields as $field) {\n+                printf(\"<td>%s</td>\", htmlspecialchars($row[$field], ENT_QUOTES, 'UTF-8'));\n+            }\n+            echo '</tr>';\n+            $count++;\n+        }\n+\n+        echo '</tbody>';\n+\n+        // tfoot\n+        $links = setupLinks_str($pageNum, $maxPage, $orderBy, $orderType, $partial_query_string);\n+        printTableFoot($per_page_numrows, $numrows, $colspan, $drawNumberLinks, $links);\n+\n+        echo '</table>';\n+    \n+    } else {\n+        $failureMsg = \"Nothing to display\";\n+        include_once(\"include/management/actionMessages.php\");\n+    }\n+        \n+    include('library/closedb.php');    \n+\n+    include('include/config/logging.php');\n+    print_footer_and_html_epilogue();\n \n ?>\n-\n-\n-\n-<?php\n-\tinclude('include/config/logging.php');\n-?>\n-\n-\t\t</div>\n-\t\t\n-\t\t<div id=\"footer\">\n-\t\t\n-\t\t\t\t\t\t\t\t<?php\n-        include 'page-footer.php';\n-?>\n-\n-\t\t\n-\t\t</div>\n-\t\t\n-</div>\n-</div>\n-\n-\n-</body>\n-</html>"
        },
        {
          "filename": "bill-history.php",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -28,12 +28,12 @@\n     $log = \"visited page: \";\n \n     include_once(\"lang/main.php\");\n-    \n+    include(\"library/validation.php\");\n     include(\"library/layout.php\");\n \n     // print HTML prologue\n     $title = t('Intro','billhistorymain.php');\n-    $help = t('helpPage','billhistorymain');\n+    $help = \"\";\n     \n     print_html_prologue($title, $langCode);\n "
        },
        {
          "filename": "bill-main.php",
          "status": "modified",
          "additions": 1,
          "deletions": 11,
          "patch": "@@ -41,18 +41,8 @@\n     \n     echo '<div id=\"contentnorightbar\">';\n     print_title_and_help($title, $help);\n-    echo '</div><!-- #contentnorightbar -->'\n-       . '<div id=\"footer\">';\n \n     include('include/config/logging.php');\n-    include('page-footer.php');\n-    \n-    echo '</div><!-- #footer -->';\n+    print_footer_and_html_epilogue();\n \n ?>\n-\n-        </div>\n-    </div>\n-\n-</body>\n-</html>"
        },
        {
          "filename": "bill-merchant-transactions.php",
          "status": "modified",
          "additions": 198,
          "deletions": 292,
          "patch": "@@ -24,306 +24,212 @@\n     $operator = $_SESSION['operator_user'];\n \n \tinclude('library/check_operator_perm.php');\n-\t\n-\t//setting values for the order by and order type variables\n-\tisset($_GET['orderBy']) ? $orderBy = $_GET['orderBy'] : $orderBy = \"radacctid\";\n-\tisset($_GET['orderType']) ? $orderType = $_GET['orderType'] : $orderType = \"asc\";\n-\n-\n-\tisset($_GET['payer_email']) ? $payer_email = $_GET['payer_email'] : $payer_email = \"%\";\n-\tisset($_GET['payment_address_status']) ? $payment_address_status = $_GET['payment_address_status'] : $payment_address_status = \"%\";\n-\tisset($_GET['payer_status']) ? $payer_status = $_GET['payer_status'] : $payer_status = \"%\";\n-\tisset($_GET['payment_status']) ? $payment_status = $_GET['payment_status'] : $payment_status = \"%\";\n-\tisset($_GET['vendor_type']) ? $vendor_type = $_GET['vendor_type'] : $vendor_type = \"%\";\n-\tisset($_GET['sqlfields']) ? $sqlfields = $_GET['sqlfields'] : $sqlfields = \"\";\n-\tisset($_GET['startdate']) ? $startdate = $_GET['startdate'] : $startdate = \"\";\n-\tisset($_GET['enddate']) ? $enddate = $_GET['enddate'] : $enddate = \"\";\n-\n-\n-\t$payer_email = str_replace('*', '%', $payer_email);\n+\tinclude_once('library/config_read.php');\n+    \n+    include_once(\"lang/main.php\");\n+    include(\"library/validation.php\");\n+    include(\"library/layout.php\");\n \n-\t//feed the sidebar variables\n+    // init loggin variables\n+    $log = \"visited page: \";\n+    $logQuery = \"performed query for listing of records on page: \";\n+    $logDebugSQL = \"\";\n+\n+    // set session's page variable\n+    $_SESSION['PREV_LIST_PAGE'] = $_SERVER['REQUEST_URI'];\n+\n+    $sqlfields = (array_key_exists('sqlfields', $_GET) && !empty($_GET['sqlfields']) && is_array($_GET['sqlfields']) &&\n+                  array_intersect($_GET['sqlfields'], array_keys($bill_merchant_transactions_options_all)) == $_GET['sqlfields'])\n+               ? $_GET['sqlfields'] : $bill_merchant_transactions_options_default;\n+    \n+    $cols = array();\n+    foreach ($sqlfields as $sqlfield) {\n+        $cols[$sqlfield] = $bill_merchant_transactions_options_all[$sqlfield];\n+    }\n+    $colspan = count($cols);\n+    $half_colspan = intdiv($colspan, 2);\n+    \n+    $orderBy = (array_key_exists('orderBy', $_GET) && isset($_GET['orderBy']) &&\n+                in_array($_GET['orderBy'], array_keys($bill_merchant_transactions_options_all)))\n+             ? $_GET['orderBy'] : array_keys($bill_merchant_transactions_options_all)[0];\n+\n+    $orderType = (array_key_exists('orderType', $_GET) && isset($_GET['orderType']) &&\n+                  preg_match(ORDER_TYPE_REGEX, $_GET['orderType']) !== false)\n+               ? strtolower($_GET['orderType']) : \"asc\";\n+    \n+    $startdate = (array_key_exists('startdate', $_GET) && !empty($_GET['startdate']) &&\n+                  preg_match(DATE_REGEX, $_GET['startdate'], $m) !== false &&\n+                  checkdate($m[2], $m[3], $m[1]))\n+               ? $_GET['startdate'] : \"\";\n+\n+    $enddate = (array_key_exists('enddate', $_GET) && !empty($_GET['enddate']) &&\n+                preg_match(DATE_REGEX, $_GET['enddate'], $m) !== false &&\n+                checkdate($m[2], $m[3], $m[1]))\n+             ? $_GET['enddate'] : \"\";\n+             \n+    $vendor_type = (array_key_exists('vendor_type', $_GET) && isset($_GET['vendor_type']) &&\n+                    in_array($_GET['vendor_type'], array_slice($valid_vendorTypes, 1))) // avoid inserting \"Any\" in the SQL query\n+                 ? $_GET['vendor_type'] : \"\";\n+\n+    $payer_email = (array_key_exists('payer_email', $_GET) && !empty(str_replace(\"%\", \"\", trim($_GET['payer_email']))))\n+                 ? str_replace(\"%\", \"\", trim($_GET['payer_email'])) : \"\";\n+    $payer_email_enc = (!empty($payer_email)) ? htmlspecialchars($payer_email, ENT_QUOTES, 'UTF-8') : \"\";\n+\n+\t$payment_status = (array_key_exists('payment_status', $_GET) && isset($_GET['payment_status']) &&\n+                       in_array($_GET['payment_status'], array_slice($valid_paymentStatus, 1))) // avoid inserting \"Any\" in the SQL query\n+                    ? $_GET['payment_status'] : \"\";\n+    \n+    // FIX THIS: they aren't passed\n+    $payment_address_status = (array_key_exists('payment_address_status', $_GET) &&\n+                               !empty(str_replace(\"%\", \"\", trim($_GET['payment_address_status']))))\n+                            ? str_replace(\"%\", \"\", trim($_GET['payment_address_status'])) : \"\";\n+    $payer_status = (array_key_exists('payer_status', $_GET) && !empty(str_replace(\"%\", \"\", trim($_GET['payer_status']))))\n+                  ? str_replace(\"%\", \"\", trim($_GET['payer_status'])) : \"\";\n+\t\n+    //feed the sidebar variables\n \t$billing_date_startdate = $startdate;\n \t$billing_date_enddate = $enddate;\n-\t//$billing_paypal_firstname = $value;\n-\t$billing_paypal_payeremail = $payer_email;\n-\t$billing_paypal_paymentaddressstatus = $payment_address_status;\n-\t$billing_paypal_payerstatus = $payer_status;\n+\t$billing_paypal_payeremail = $payer_email_enc;\n \t$billing_paypal_paymentstatus = $payment_status;\n \t$billing_paypal_vendor_type = $vendor_type;\n \n-\n-\tinclude_once('library/config_read.php');\n-    $log = \"visited page: \";\n-    $logQuery = \"performed query for all accounting records on page: \";\n-\n-?>\n-\n-<?php\n+    //~ $billing_paypal_paymentaddressstatus = $payment_address_status;\n+\t//~ $billing_paypal_payerstatus = $payer_status;\n \t\n+    // print HTML prologue\n+    $title = t('Intro','billpaypaltransactions.php');\n+    $help = t('helpPage','billpaypaltransactions');\n+    \n+    print_html_prologue($title, $langCode);\n+    \n \tinclude(\"menu-bill-merchant.php\");\n \t\n-?>\n-\n-\t\t<div id=\"contentnorightbar\">\n-\t\t\n-\t\t<h2 id=\"Intro\"><a href=\"#\" onclick=\"javascript:toggleShowDiv('helpPage')\"><?php echo t('Intro','billpaypaltransactions.php')?>\n-\t\t<h144>&#x2754;</h144></a></h2>\n-\t\t\t\t\n-\t\t<div id=\"helpPage\" style=\"display:none;visibility:visible\" >\n-\t\t\t<?php echo t('helpPage','billpaypaltransactions') ?>\n-\t\t\t<br/>\n-\t\t</div>\n-\t\t<br/>\n-\n-\n-\n-<?php\n-\n-\t\tinclude 'library/opendb.php';\n-\t\tinclude 'include/management/pages_common.php';\t\n-\t\tinclude 'include/management/pages_numbering.php';\t\t// must be included after opendb because it needs to read the CONFIG_IFACE_TABLES_LISTING variable from the config file\n-\n-\t\t// let's sanitize the values passed to us:\n-\t\t$payer_email = $dbSocket->escapeSimple($payer_email);\n-\t\t$payment_address_status = $dbSocket->escapeSimple($payment_address_status);\n-\t\t$payer_status = $dbSocket->escapeSimple($payer_status);\n-\t\t$payment_status = $dbSocket->escapeSimple($payment_status);\n-\t\t$vendor_type = $dbSocket->escapeSimple($vendor_type);\n-\t\t$startdate = $dbSocket->escapeSimple($startdate);\n-\t\t$enddate = $dbSocket->escapeSimple($enddate);\n-\n-\t        include_once('include/management/userBilling.php');\n-\t        userBillingPayPalSummary($startdate, $enddate, $payer_email, $payment_address_status, $payer_status, $payment_status, $vendor_type, 1);\n-\t\t\t\t\t\t\t\t\t                         // draw the billing rates summary table\n-\n-\n-\t        include 'library/opendb.php';\n-\t\t// since we need to span through pages, which we do using GET queries I can't rely on this page\n-\t\t// to be processed through POST but rather using GET only (with the current design anyway).\n-\t\t// For this reason, I need to build the GET query which I will later use in the page number's links\n-\n-\t\t$getFields = \"\";\n-\t\t$counter = 0;\n-\t\tforeach ($sqlfields as $elements) {\n-\t\t\t$getFields .= \"&sqlfields[$counter]=$elements\";\n-\t\t\t$counter++;\n-\t\t}\n-\n-\t\t// we should also sanitize the array that we will be passing to this page in the next query\n-\t\t$getFields = $dbSocket->escapeSimple($getFields);\n-\n-\n-\t\t$getQuery = \"\";\n-\t\t$getQuery .= \"&payer_email=$payer_email\";\n-\t\t$getQuery .= \"&payment_address_status=$payment_address_status\";\n-\t\t$getQuery .= \"&payer_status=$payer_status\";\n-\t\t$getQuery .= \"&payment_status=$payment_status\";\n-\t\t$getQuery .= \"&vendor_type=$vendor_type\";\n-\t\t$getQuery .= \"&startdate=$startdate&enddate=$enddate\";\n-\n-\n-\t\t$select = implode(\",\", $sqlfields);\n-\t\t// sanitizing the array passed to us in the get request\n-\t\t$select = $dbSocket->escapeSimple($select);\n-\n-\n-\t\t$sql = \"SELECT $select FROM \".$configValues['CONFIG_DB_TBL_DALOBILLINGMERCHANT'].\" WHERE \".\n-\t\t\t\" (payer_email LIKE '$payer_email') AND \".\n-\t\t\t\" (payment_address_status LIKE '$payment_address_status') AND \".\n-\t\t\t\" (payer_status LIKE '$payer_status') AND \".\n-\t\t\t\" (payment_status LIKE '$payment_status') AND \".\n-\t\t\t\" (vendor_type LIKE '$vendor_type') AND \".\n-\t\t\t\" (payment_date>'$startdate' AND payment_date<'$enddate')\";\n-\t\t$res = $dbSocket->query($sql);\n-\t\t$numrows = $res->numRows();\n-\n-\n-\t\t$sql = \"SELECT $select FROM \".$configValues['CONFIG_DB_TBL_DALOBILLINGMERCHANT'].\" WHERE \".\n-\t\t\t\" (payer_email LIKE '$payer_email') AND \".\n-\t\t\t\" (payment_address_status LIKE '$payment_address_status') AND \".\n-\t\t\t\" (payer_status LIKE '$payer_status') AND \".\n-\t\t\t\" (payment_status LIKE '$payment_status') AND \".\n-\t\t\t\" (vendor_type LIKE '$vendor_type') AND \".\n-\t\t\t\" (payment_date>'$startdate' AND payment_date<'$enddate') \".\n-\t\t\t\" ORDER BY $orderBy $orderType LIMIT $offset, $rowsPerPage;\";\n-\t\t$res = $dbSocket->query($sql);\n-\t\t$logDebugSQL = \"\";\n-\t\t$logDebugSQL .= $sql . \"\\n\";\n-\n-\n-\t/* START - Related to pages_numbering.php */\n-\t$maxPage = ceil($numrows/$rowsPerPage);\n-\t/* END */\n-\n-\n-\techo \"<table border='0' class='table1'>\\n\";\n-\techo \"\n-\t\t\t\t\t<thead>\n-\t\t\t\t\t\t\t<tr>\n-\t\t\t\t\t\t\t<th colspan='25'>\".t('all','Records').\"</th>\n-\t\t\t\t\t\t\t</tr>\n-\n-                                                        <tr>\n-                                                        <th colspan='25' align='left'>\n-                <br/>\n-        \";\n-\n-        if ($configValues['CONFIG_IFACE_TABLES_LISTING_NUM'] == \"yes\")\n-                setupNumbering($numrows, $rowsPerPage, $pageNum, $orderBy, $orderType, $getFields, $getQuery);\n-\n-        echo \" </th></tr>\n-                                        </thead>\n-\n-                        \";\n-\n-\n-\t// building the dybamic table list fields\n-\techo \"<thread> <tr>\";\n-\tforeach ($sqlfields as $value) {\n-\t\tswitch($value) {\n-\n-\t\tcase \"id\":\n-\t\t\t$title = t('all','ID');\n-\t\t\tbreak;\n-\t\tcase \"username\":\n-\t\t\t$title = t('all','Username');\n-\t\t\tbreak;\n-\t\tcase \"password\":\n-\t\t\t$title = t('all','Password');\n-\t\t\tbreak;\n-\t\tcase \"txnId\":\n-\t\t\t$title = t('all','TxnId');\n-\t\t\tbreak;\n-\t\tcase \"planId\":\n-\t\t\t$title = t('all','PlanId');\n-\t\t\tbreak;\n-\t\tcase \"quantity\":\n-\t\t\t$title = t('all','Quantity');\n-\t\t\tbreak;\n-\t\tcase \"business_email\":\n-\t\t\t$title = t('all','ReceiverEmail');\n-\t\t\tbreak;\n-\t\tcase \"business_id\":\n-\t\t\t$title = t('all','Business');\n-\t\t\tbreak;\n-\t\tcase \"payment_tax\":\n-\t\t\t$title = t('all','Tax');\n-\t\t\tbreak;\n-\t\tcase \"payment_cost\":\n-\t\t\t$title = t('all','Cost');\n-\t\t\tbreak;\n-\t\tcase \"payment_fee\":\n-\t\t\t$title = t('all','TransactionFee');\n-\t\t\tbreak;\n-\t\tcase \"payment_total\":\n-\t\t\t$title = t('all','TotalCost');\n-\t\t\tbreak;\n-\t\tcase \"payment_currency\":\n-\t\t\t$title = t('all','PaymentCurrency');\n-\t\t\tbreak;\n-\t\tcase \"first_name\":\n-\t\t\t$title = t('all','FirstName');\n-\t\t\tbreak;\n-\t\tcase \"last_name\":\n-\t\t\t$title = t('all','LastName');\n-\t\t\tbreak;\n-\t\tcase \"payer_email\":\n-\t\t\t$title = t('all','PayerEmail');\n-\t\t\tbreak;\n-\t\tcase \"payer_address_name\":\n-\t\t\t$title = t('all','AddressRecipient');\n-\t\t\tbreak;\n-\t\tcase \"payer_address_street\":\n-\t\t\t$title = t('all','Street');\n-\t\t\tbreak;\n-\t\tcase \"payer_address_country\":\n-\t\t\t$title = t('all','Country');\n-\t\t\tbreak;\n-\t\tcase \"payer_address_country_code\":\n-\t\t\t$title = t('all','CountryCode');\n-\t\t\tbreak;\n-\t\tcase \"payer_address_city\":\n-\t\t\t$title = t('all','City');\n-\t\t\tbreak;\n-\t\tcase \"payer_address_state\":\n-\t\t\t$title = t('all','State');\n-\t\t\tbreak;\n-\t\tcase \"payer_address_zip\":\n-\t\t\t$title = t('all','Zip');\n-\t\t\tbreak;\n-\t\tcase \"payment_date\":\n-\t\t\t$title = t('all','PaymentDate');\n-\t\t\tbreak;\n-\t\tcase \"payment_status\":\n-\t\t\t$title = t('all','PaymentStatus');\n-\t\t\tbreak;\n-\t\tcase \"payer_status\":\n-\t\t\t$title = t('all','PayerStatus');\n-\t\t\tbreak;\n-\t\tcase \"vendor_type\":\n-\t\t\t$title = t('all','VendorType');\n-\t\t\tbreak;\n-\t\tcase \"payment_address_status\":\n-\t\t\t$title = t('all','PaymentAddressStatus');\n-\t\t\tbreak;\n-\t\tdefault:\n-\t\t\t$title = $value;\n-\t\t\tbreak;\n-\t\t}\n-\n-\t\techo \"<th scope='col'> $title   </th>\";\n-\t} //foreach $sqlfields\n-\techo \"</tr> </thread>\";\n-\n-\n-\t// inserting the values of each field from the database to the table\n-\twhile($row = $res->fetchRow(DB_FETCHMODE_ASSOC)) {\n-\t\techo \"<tr>\";\n-\t\tforeach ($sqlfields as $value) {\n-\t\t\techo \"<td> \" . $row[$value] . \"</td>\";\n-\t\t}\n-\t\techo \"</tr>\";\n-\t}\n-\n-        echo \"\n-                                        <tfoot>\n-                                                        <tr>\n-                                                        <th colspan='25' align='left'>\n-        \";\n-        setupLinks($pageNum, $maxPage, $orderBy, $orderType, $getFields, $getQuery);\n-        echo \"\n-                                                        </th>\n-                                                        </tr>\n-                                        </tfoot>\n-                \";\n-\n-\techo \"</table>\";\n-\n-\tinclude 'library/closedb.php';\n+    echo '<div id=\"contentnorightbar\">';\n+    print_title_and_help($title, $help);\n+\n+    // draw the billing rates summary table\n+    include_once('include/management/userBilling.php');\n+    userBillingPayPalSummary($startdate, $enddate, $payer_email, $payment_address_status, $payer_status, $payment_status, $vendor_type, 1);\n+\t\t\t\t\t\t\t\t\t                         \n+\n+    include('library/opendb.php');\n+    include_once('include/management/pages_common.php');\n+    \n+    // preparing the custom query\n+    \n+    $sql_WHERE = array();\n+    $partial_query_string_pieces = array();\n+    \n+    foreach ($sqlfields as $sqlfield) {\n+        $partial_query_string_pieces[] = sprintf(\"sqlfields[]=%s\", $sqlfield);\n+    }\n+    \n+    if (!empty($startdate)) {\n+        $sql_WHERE[] = sprintf(\"payment_date > '%s'\", $dbSocket->escapeSimple($startdate));\n+        $partial_query_string_pieces[] = sprintf(\"startdate=%s\", $startdate);\n+    }\n+    \n+    if (!empty($startdate)) {\n+        $sql_WHERE[] = sprintf(\"payment_date < '%s'\", $dbSocket->escapeSimple($enddate));\n+        $partial_query_string_pieces[] = sprintf(\"enddate=%s\", $enddate);\n+    }\n+    \n+    if (!empty($payer_email)) {\n+        $sql_WHERE[] = sprintf(\"payer_email LIKE '%s%%'\", $dbSocket->escapeSimple($payer_email));\n+        $partial_query_string_pieces[] = sprintf(\"payer_email=%s\", $payer_email);\n+    }\n+    \n+    if (!empty($payment_status)) {\n+        $sql_WHERE[] = sprintf(\"payment_status='%s'\", $dbSocket->escapeSimple($payment_status));\n+        $partial_query_string_pieces[] = sprintf(\"payment_status=%s\", $payment_status);\n+    }\n+    \n+    if (!empty($vendor_type)) {\n+        $sql_WHERE[] = sprintf(\"vendor_type='%s'\", $dbSocket->escapeSimple($vendor_type));\n+        $partial_query_string_pieces[] = sprintf(\"vendor_type=%s\", $vendor_type);\n+    }\n+    \n+    // executing the custom query\n+\n+    $sql = sprintf(\"SELECT %s FROM %s\", implode(\", \", $sqlfields), $configValues['CONFIG_DB_TBL_DALOBILLINGMERCHANT']);\n+    \n+    if (count($sql_WHERE) > 0) {\n+        $sql .= \" WHERE \" . implode(\" AND \", $sql_WHERE);\n+    }\n+\n+    $res = $dbSocket->query($sql);\n+    $logDebugSQL .= \"$sql;\\n\";\n+    \n+    $numrows = $res->numRows();\n+\t\t\t\n+    if ($numrows > 0) {\n+        /* START - Related to pages_numbering.php */\n+        \n+        // when $numrows is set, $maxPage is calculated inside this include file\n+        include('include/management/pages_numbering.php');    // must be included after opendb because it needs to read\n+                                                              // the CONFIG_IFACE_TABLES_LISTING variable from the config file\n+        \n+        // here we decide if page numbers should be shown\n+        $drawNumberLinks = strtolower($configValues['CONFIG_IFACE_TABLES_LISTING_NUM']) == \"yes\" && $maxPage > 1;\n+        \n+        $sql .= sprintf(\" ORDER BY %s %s LIMIT %s, %s\", $orderBy, $orderType, $offset, $rowsPerPage);\n+        $res = $dbSocket->query($sql);\n+        $logDebugSQL .= \"$sql;\\n\";\n+        \n+        $per_page_numrows = $res->numRows();\n+        \n+        // the partial query is built starting from user input\n+        // and for being passed to setupNumbering and setupLinks functions\n+        $partial_query_string = (count($partial_query_string_pieces) > 0)\n+                              ? \"&\" . implode(\"&\", $partial_query_string_pieces) : \"\";\n+\n+        echo '<table border=\"0\" class=\"table1\">'\n+           . '<thead>';\n+\n+        // page numbers are shown only if there is more than one page\n+        if ($drawNumberLinks) {\n+            echo '<tr style=\"background-color: white\">';\n+            printf('<td style=\"text-align: left\" colspan=\"%s\">go to page: ', $colspan);\n+            setupNumbering($numrows, $rowsPerPage, $pageNum, $orderBy, $orderType, $partial_query_string);\n+            echo '</td>' . '</tr>';\n+        }\n+\n+        // second line of table header\n+        echo \"<tr>\";\n+        printTableHead($cols, $orderBy, $orderType, $partial_query_string);\n+        echo \"</tr>\";\n+\n+            \n+        echo '</thead>'\n+           . '<tbody>';\n+        \n+        // inserting the values of each field from the database to the table\n+        $count = 0;\n+        while($row = $res->fetchRow(DB_FETCHMODE_ASSOC)) {\n+            printf('<tr id=\"row-%d\">', $count);\n+            foreach ($sqlfields as $field) {\n+                printf(\"<td>%s</td>\", htmlspecialchars($row[$field], ENT_QUOTES, 'UTF-8'));\n+            }\n+            echo '</tr>';\n+            $count++;\n+        }\n+\n+        echo '</tbody>';\n+        \n+        // tfoot\n+        $links = setupLinks_str($pageNum, $maxPage, $orderBy, $orderType, $partial_query_string);\n+        printTableFoot($per_page_numrows, $numrows, $colspan, $drawNumberLinks, $links);\n+\n+        echo '</table>';\n+\n+    } else {\n+        $failureMsg = \"Nothing to display\";\n+        include_once(\"include/management/actionMessages.php\");\n+    }\n+        \n+    include('library/closedb.php');    \n+\n+    include('include/config/logging.php');\n+    print_footer_and_html_epilogue();\n \n ?>\n-\n-\n-\n-<?php\n-\tinclude('include/config/logging.php');\n-?>\n-\n-\t\t</div>\n-\t\t\n-\t\t<div id=\"footer\">\n-\t\t\n-\t\t\t\t\t\t\t\t<?php\n-        include 'page-footer.php';\n-?>\n-\n-\t\t\n-\t\t</div>\n-\t\t\n-</div>\n-</div>\n-\n-\n-</body>\n-</html>"
        },
        {
          "filename": "bill-merchant.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -28,7 +28,7 @@\n     $log = \"visited page: \";\n \n     include_once(\"lang/main.php\");\n-    \n+    include(\"library/validation.php\");\n     include(\"library/layout.php\");\n \n     // print HTML prologue"
        },
        {
          "filename": "bill-pos-edit.php",
          "status": "modified",
          "additions": 6,
          "deletions": 16,
          "patch": "@@ -25,17 +25,17 @@\n     $operator = $_SESSION['operator_user'];\n \n     include('library/check_operator_perm.php');\n+    include_once('library/config_read.php');\n \n+    include_once(\"lang/main.php\");\n+    include_once(\"library/validation.php\");\n+    include(\"library/layout.php\");\n+    \n     // init logging variables\n     $log = \"visited page: \";\n     $logAction = \"\";\n     $logDebugSQL = \"\";\n     \n-    include_once('library/config_read.php');\n-    \n-    // we import validation facilities\n-    include_once(\"library/validation.php\");\n-    \n     // required later\n     $currDate = date('Y-m-d H:i:s');\n     $currBy = $operator;\n@@ -385,10 +385,6 @@ function addUserProfiles($dbSocket, $username, $planName, $oldplanName, $groups,\n     $hiddenPassword = (strtolower($configValues['CONFIG_IFACE_PASSWORD_HIDDEN']) == \"yes\")\n                     ? 'password' : 'text';\n     \n-    include_once(\"lang/main.php\");\n-    \n-    include(\"library/layout.php\");\n-\n     // print HTML prologue\n     $extra_css = array(\n         // css tabs stuff\n@@ -677,13 +673,7 @@ function refillSessionTraffic() {\n <?php\n     }\n     \n-    if (array_key_exists('PREV_LIST_PAGE', $_SESSION) && !empty(trim($_SESSION['PREV_LIST_PAGE']))) {\n-        echo '<div style=\"float: right; text-align: right; margin: 0; font-size: small\">';\n-        printf('<a href=\"%s\" title=\"Back to Previous Page\">Back to Previous Page</a>', trim($_SESSION['PREV_LIST_PAGE']));\n-        echo '</div>';\n-        \n-        unset($_SESSION['PREV_LIST_PAGE']);\n-    }\n+    print_back_to_previous_page();\n     \n     include('include/config/logging.php');\n     print_footer_and_html_epilogue();"
        },
        {
          "filename": "bill-pos-new.php",
          "status": "modified",
          "additions": 4,
          "deletions": 6,
          "patch": "@@ -27,16 +27,17 @@\n     include('library/check_operator_perm.php');\n     include_once('library/config_read.php');\n \n+    include_once(\"lang/main.php\");\n+    include_once(\"library/validation.php\");\n+    include(\"library/layout.php\");\n+\n     // init logging variables\n     $log = \"visited page: \";\n     $logAction = \"\";\n     $logDebugSQL = \"\";\n \n     include('include/management/pages_common.php');\n \n-    // we import validation facilities\n-    include_once(\"library/validation.php\");\n-\n     // if cleartext passwords are not allowed, \n     // we remove Cleartext-Password from the $valid_passwordTypes array\n     if (isset($configValues['CONFIG_DB_PASSWORD_ENCRYPTION']) &&\n@@ -455,9 +456,6 @@ function addUserBillInfo($dbSocket, $username) {\n     $hiddenPassword = (strtolower($configValues['CONFIG_IFACE_PASSWORD_HIDDEN']) == \"yes\")\n                     ? 'password' : 'text';\n     \n-    include_once(\"lang/main.php\");\n-    \n-    include(\"library/layout.php\");\n \n     // print HTML prologue\n     $extra_css = array("
        },
        {
          "filename": "bill-rates-date.php",
          "status": "modified",
          "additions": 7,
          "deletions": 8,
          "patch": "@@ -27,7 +27,14 @@\n     include('library/check_operator_perm.php');\n     include_once('library/config_read.php');\n \n+    // init loggin variables\n+    $log = \"visited page: \";\n+    $logQuery = \"performed query for listing of records on page: \";\n+    $logDebugSQL = \"\";\n+\n+    include_once(\"lang/main.php\");\n     include(\"library/validation.php\");\n+    include(\"library/layout.php\");\n \n     //setting values for the order by and order type variables\n     // and in other cases we partially strip some character,\n@@ -57,15 +64,7 @@\n     $billing_date_startdate = $startdate;\n     $billing_date_enddate = $enddate;\n \n-    // init loggin variables\n-    $log = \"visited page: \";\n-    $logQuery = \"performed query for listing of records on page: \";\n-    $logDebugSQL = \"\";\n-\n-    include_once(\"lang/main.php\");\n     \n-    include(\"library/layout.php\");\n-\n     // print HTML prologue\n     $extra_css = array();\n     "
        },
        {
          "filename": "config-db.php",
          "status": "modified",
          "additions": 3,
          "deletions": 5,
          "patch": "@@ -25,13 +25,13 @@\n     $operator = $_SESSION['operator_user'];\n \n     include('library/check_operator_perm.php');\n-\n     include_once('library/config_read.php');\n-    $log = \"visited page: \";\n     \n     include_once(\"lang/main.php\");\n-    \n     include(\"library/validation.php\");\n+    include(\"library/layout.php\");\n+    \n+    $log = \"visited page: \";\n     \n     $db_tbl_param_label = array(\n                                     'CONFIG_DB_TBL_RADCHECK' => t('all','radcheck'), \n@@ -113,8 +113,6 @@\n     }\n     \n     \n-    include(\"library/layout.php\");\n-\n     // print HTML prologue\n     $extra_css = array(\n         // css tabs stuff"
        },
        {
          "filename": "config-lang.php",
          "status": "modified",
          "additions": 4,
          "deletions": 5,
          "patch": "@@ -25,11 +25,13 @@\n     $operator = $_SESSION['operator_user'];\n \n     include('library/check_operator_perm.php');\n-\n     include_once('library/config_read.php');\n-    $log = \"visited page: \";\n \n+    include_once(\"lang/main.php\");\n     include(\"library/validation.php\");\n+    include(\"library/layout.php\");\n+    \n+    $log = \"visited page: \";\n \n     if ($_SERVER['REQUEST_METHOD'] === 'POST') {\n         if (array_key_exists('csrf_token', $_POST) && isset($_POST['csrf_token']) && dalo_check_csrf_token($_POST['csrf_token'])) {\n@@ -48,10 +50,7 @@\n         }\n     }\n \n-    include_once(\"lang/main.php\");\n     \n-    include(\"library/layout.php\");\n-\n     // print HTML prologue\n     $title = t('Intro','configlang.php');\n     $help = t('helpPage','configlang');"
        },
        {
          "filename": "config-reports.php",
          "status": "modified",
          "additions": 10,
          "deletions": 26,
          "patch": "@@ -1,4 +1,4 @@\n-<?php\n+<?php \n /*\n  *********************************************************************************************************\n  * daloRADIUS - RADIUS Web Platform\n@@ -20,13 +20,13 @@\n  *\n  *********************************************************************************************************\n  */\n- \n-    include(\"library/checklogin.php\");\n+\n+    include (\"library/checklogin.php\");\n     $operator = $_SESSION['operator_user'];\n \n     include_once('library/config_read.php');\n-    \n-    \n+    $log = \"visited page: \";\n+\n     include_once(\"lang/main.php\");\n     \n     include(\"library/layout.php\");\n@@ -38,27 +38,11 @@\n     print_html_prologue($title, $langCode);\n \n     include(\"menu-config-reports.php\");\n-\n-?>\n-                \n-        <div id=\"contentnorightbar\">\n-\n-<?php\n+    \n+    echo '<div id=\"contentnorightbar\">';\n     print_title_and_help($title, $help);\n-?>\n-\n-        </div><!-- #contentnorightbar -->\n-        \n-        <div id=\"footer\">\n-<?php\n-    $log = \"visited page: \";\n-\n+    \n     include('include/config/logging.php');\n-    include('page-footer.php');\n-?>\n-        </div><!-- #footer -->\n-    </div>\n-</div>\n+    print_footer_and_html_epilogue();\n \n-</body>\n-</html>\n+?>"
        },
        {
          "filename": "gis-main.php",
          "status": "modified",
          "additions": 3,
          "deletions": 13,
          "patch": "@@ -74,18 +74,8 @@\n     print_title_and_help($title, $help);\n     \n     include_once('include/management/actionMessages.php');\n-?>\n-\n-        </div><!-- #contentnorightbar -->\n-        \n-        <div id=\"footer\">\n-<?php\n+    \n     include('include/config/logging.php');\n-    include('page-footer.php');\n-?>\n-        </div><!-- #footer -->\n-    </div>\n-</div>\n+    print_footer_and_html_epilogue();\n \n-</body>\n-</html>\n+?>"
        },
        {
          "filename": "graph-main.php",
          "status": "modified",
          "additions": 8,
          "deletions": 20,
          "patch": "@@ -1,4 +1,4 @@\n-<?php\n+<?php \n /*\n  *********************************************************************************************************\n  * daloRADIUS - RADIUS Web Platform\n@@ -21,9 +21,9 @@\n  *********************************************************************************************************\n  */\n \n-    include(\"library/checklogin.php\");\n+    include (\"library/checklogin.php\");\n     $operator = $_SESSION['operator_user'];\n-        \n+\n     include_once('library/config_read.php');\n     $log = \"visited page: \";\n \n@@ -38,23 +38,11 @@\n     print_html_prologue($title, $langCode);\n \n     include(\"menu-graphs.php\");\n-\n-?>\n-        <div id=\"contentnorightbar\">\n-<?php\n+    \n+    echo '<div id=\"contentnorightbar\">';\n     print_title_and_help($title, $help);\n-?>\n-\n-        </div><!-- #contentnorightbar -->\n-        \n-        <div id=\"footer\">\n-<?php\n+    \n     include('include/config/logging.php');\n-    include('page-footer.php');\n-?>\n-        </div><!-- #footer -->\n-    </div>\n-</div>\n+    print_footer_and_html_epilogue();\n \n-</body>\n-</html>\n+?>"
        },
        {
          "filename": "help-main.php",
          "status": "modified",
          "additions": 1,
          "deletions": 21,
          "patch": "@@ -61,29 +61,9 @@\n                 <b>daloRADIUS IRC</b>: you can find us at #daloradius on irc.freenode.net\n             </p>\n \n-        </div><!-- #contentnorightbar -->\n-        \n-        <div id=\"footer\">\n-<?php\n-    include('include/config/logging.php');\n-    include('page-footer.php');\n-?>\n-        </div><!-- #footer -->\n-    </div>\n-</div>\n-\n-</body>\n-</html>\n-\n-\n <?php\n \n-    include (\"library/checklogin.php\");\n-    $operator = $_SESSION['operator_user'];\n-        \n-\tinclude_once('library/config_read.php');\n-    $log = \"visited page: \";\n     include('include/config/logging.php');\n+    print_footer_and_html_epilogue();\n \n ?>\n-"
        },
        {
          "filename": "include/management/userBilling.php",
          "status": "modified",
          "additions": 299,
          "deletions": 364,
          "patch": "@@ -14,131 +14,132 @@\n  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.\n  *\n  *********************************************************************************************************\n- * Description:\n- *              returns user billing information (rates, plans, etc)\n+ * \n+ * Description:    returns user billing information (rates, plans, etc)\n  *\n- * Authors:     Liran Tal <liran@enginx.com>\n+ * Authors:        Liran Tal <liran@enginx.com>\n+ *                 Filippo Lauria <filippo.lauria@iit.cnr.it>\n  *\n  *********************************************************************************************************\n  */\n \n-\n-\n+// prevent this file to be directly accessed\n+if (strpos($_SERVER['PHP_SELF'], '/include/management/userBilling.php') !== false) {\n+    header(\"Location: ../../index.php\");\n+    exit;\n+}\n \n \n /*\n  *********************************************************************************************************\n  * userInvoiceAdd\n  * general billing function to add invoices to the user based on the user_id\n  *\n- * $userId \t\t\t\t   the userbillinfo user id or the username (autodetects)\n+ * $userId                    the userbillinfo user id or the username (autodetects)\n  * $invoiceInfo            array holding the invoice information\n  * $invoiceItems           array holding the invoice items information\n  *\n  *********************************************************************************************************\n  */\n function userInvoiceAdd($userId, $invoiceInfo = array(), $invoiceItems = array()) {\n \n-\tinclude(dirname(__FILE__).'/../../library/opendb.php');\n-\n-\t$user_id = false;\n-\n-\t// if provided a numeric user id then this is the user_id that we need\n-\tif (is_numeric($userId)) {\n-\t\t$user_id = $dbSocket->escapeSimple($userId);\t\t\t// sanitize variable for sql statement\n-\t} else {\n-\t\t// otherwise this is the username and we need to look up the user id from the userbillinfo table\n-\n-\t\t$username = $dbSocket->escapeSimple($userId);\n-\t\t$sql = 'SELECT id FROM '.$configValues['CONFIG_DB_TBL_DALOUSERBILLINFO'].\n-\t\t\t\t' WHERE username=\"'.$username.'\"';\n-\t\t$res = $dbSocket->query($sql);\n-\t\t$logDebugSQL .= $sql . \"\\n\";\n-\n-\t\t$row = $res->fetchRow();\n-\t\t$user_id = $row[0];\n-\n-\t}\n-\n-\t// if something is not right with the user id (set to null, false, whatever) we abort\n-\tif (!$user_id)\n-\t\treturn false;\n+    include(dirname(__FILE__).'/../../library/opendb.php');\n \n+    $user_id = false;\n \n-\t$currDate = date('Y-m-d H:i:s');\n-\t$currBy = $_SESSION['operator_user'];\n+    // if provided a numeric user id then this is the user_id that we need\n+    if (is_numeric($userId)) {\n+        $user_id = $dbSocket->escapeSimple($userId);            // sanitize variable for sql statement\n+    } else {\n+        // otherwise this is the username and we need to look up the user id from the userbillinfo table\n \n-\tif (!$invoiceInfo)\n-\t\t$invoiceInfo = array();\n+        $username = $dbSocket->escapeSimple($userId);\n+        $sql = 'SELECT id FROM '.$configValues['CONFIG_DB_TBL_DALOUSERBILLINFO'].\n+                ' WHERE username=\"'.$username.'\"';\n+        $res = $dbSocket->query($sql);\n+        $logDebugSQL .= $sql . \"\\n\";\n \n-\t// create default invoice information if nothing was provided\n-\t$myinvoiceInfo['date'] = $currDate;\n-\t$myinvoiceInfo['status_id'] = 1;\t\t\t // defaults to invoice status of 'open'\n-\t$myinvoiceInfo['type_id'] = 1;\t\t\t // defaults to invoice type of 'Plans'\n-\t$myinvoiceInfo['notes'] = 'provisioned new user from daloRADIUS platform';\n-\t$invoiceInfo = array_merge($myinvoiceInfo, $invoiceInfo);\n+        $row = $res->fetchRow();\n+        $user_id = $row[0];\n \n+    }\n \n-\t$sql = \"INSERT INTO \".$configValues['CONFIG_DB_TBL_DALOBILLINGINVOICE'].\n-\t\t\t\" (id, user_id, date, status_id, type_id, notes, creationdate, creationby, updatedate, updateby) \".\n-\t\t\t\" VALUES (0, '\".$user_id.\"', '\".\n-\t\t\t$dbSocket->escapeSimple($invoiceInfo['date']).\"', '\".\n-\t\t\t$dbSocket->escapeSimple($invoiceInfo['status_id']).\"', '\".\n-\t\t\t$dbSocket->escapeSimple($invoiceInfo['type_id']).\"', '\".\n-\t\t\t$dbSocket->escapeSimple($invoiceInfo['notes']).\"', \".\n-\t\t\t\" '$currDate', '$currBy', NULL, NULL)\";\n-\t$res = $dbSocket->query($sql);\n-\t$logDebugSQL .= $sql . \"\\n\";\n+    // if something is not right with the user id (set to null, false, whatever) we abort\n+    if (!$user_id)\n+        return false;\n \n-\t// if there hasn't been any errors with inserting the invoice record\n-\tif (!PEAR::isError($res)) {\n \n-\t\t// get the added invoice id from the database\n-\t\t$invoice_id = $dbSocket->getOne( \"SELECT LAST_INSERT_ID() FROM `\".$configValues['CONFIG_DB_TBL_DALOBILLINGINVOICE'].\"`\" );\n+    $currDate = date('Y-m-d H:i:s');\n+    $currBy = $_SESSION['operator_user'];\n \n-\t\tif (!$invoice_id)\n-\t\t\treturn false;\n+    if (!$invoiceInfo)\n+        $invoiceInfo = array();\n \n-\t\tforeach($invoiceItems as $invoiceItem) {\n-\t\t\t// set default information for the invoice items\n-\t\t\t/*\n-\t\t\t$myinvoiceItems['plan_id'] = '' ;\n-\t\t\t$myinvoiceItems['amount'] = '' ;\n-\t\t\t$myinvoiceItems['tax'] = '' ;\n-\t\t\t$myinvoiceItems['notes'] = '' ;\n-\t\t\t$invoiceItems = array_merge($myinvoiceItems, $invoiceItems);\n-\t\t\t*/\n+    // create default invoice information if nothing was provided\n+    $myinvoiceInfo['date'] = $currDate;\n+    $myinvoiceInfo['status_id'] = 1;             // defaults to invoice status of 'open'\n+    $myinvoiceInfo['type_id'] = 1;             // defaults to invoice type of 'Plans'\n+    $myinvoiceInfo['notes'] = 'provisioned new user from daloRADIUS platform';\n+    $invoiceInfo = array_merge($myinvoiceInfo, $invoiceInfo);\n \n-\t\t\t// now add an invoice item\n-\t\t\t$sql = \"INSERT INTO \".$configValues['CONFIG_DB_TBL_DALOBILLINGINVOICEITEMS'].\n-\t\t\t\t\" (id, invoice_id, plan_id, amount, tax_amount, notes, \".\n-\t\t\t\t\" creationdate, creationby, updatedate, updateby) \".\n-\t\t\t\t\" VALUES (0, '\".$invoice_id.\"', '\".\n-\t\t\t\t$dbSocket->escapeSimple($invoiceItem['plan_id']).\"', '\".\n-\t\t\t\t$dbSocket->escapeSimple($invoiceItem['amount']).\"', '\".\n-\t\t\t\t$dbSocket->escapeSimple($invoiceItem['tax']).\"', '\".\n-\t\t\t\t$dbSocket->escapeSimple($invoiceItem['notes']).\"', \".\n-\t\t\t\t\" '$currDate', '$currBy', NULL, NULL)\";\n \n-\t\t\t$res = $dbSocket->query($sql);\n-\t\t\t$logDebugSQL .= $sql . \"\\n\";\n+    $sql = \"INSERT INTO \".$configValues['CONFIG_DB_TBL_DALOBILLINGINVOICE'].\n+            \" (id, user_id, date, status_id, type_id, notes, creationdate, creationby, updatedate, updateby) \".\n+            \" VALUES (0, '\".$user_id.\"', '\".\n+            $dbSocket->escapeSimple($invoiceInfo['date']).\"', '\".\n+            $dbSocket->escapeSimple($invoiceInfo['status_id']).\"', '\".\n+            $dbSocket->escapeSimple($invoiceInfo['type_id']).\"', '\".\n+            $dbSocket->escapeSimple($invoiceInfo['notes']).\"', \".\n+            \" '$currDate', '$currBy', NULL, NULL)\";\n+    $res = $dbSocket->query($sql);\n+    $logDebugSQL .= $sql . \"\\n\";\n+\n+    // if there hasn't been any errors with inserting the invoice record\n+    if (!PEAR::isError($res)) {\n+\n+        // get the added invoice id from the database\n+        $invoice_id = $dbSocket->getOne( \"SELECT LAST_INSERT_ID() FROM `\".$configValues['CONFIG_DB_TBL_DALOBILLINGINVOICE'].\"`\" );\n+\n+        if (!$invoice_id)\n+            return false;\n+\n+        foreach($invoiceItems as $invoiceItem) {\n+            // set default information for the invoice items\n+            /*\n+            $myinvoiceItems['plan_id'] = '' ;\n+            $myinvoiceItems['amount'] = '' ;\n+            $myinvoiceItems['tax'] = '' ;\n+            $myinvoiceItems['notes'] = '' ;\n+            $invoiceItems = array_merge($myinvoiceItems, $invoiceItems);\n+            */\n+\n+            // now add an invoice item\n+            $sql = \"INSERT INTO \".$configValues['CONFIG_DB_TBL_DALOBILLINGINVOICEITEMS'].\n+                \" (id, invoice_id, plan_id, amount, tax_amount, notes, \".\n+                \" creationdate, creationby, updatedate, updateby) \".\n+                \" VALUES (0, '\".$invoice_id.\"', '\".\n+                $dbSocket->escapeSimple($invoiceItem['plan_id']).\"', '\".\n+                $dbSocket->escapeSimple($invoiceItem['amount']).\"', '\".\n+                $dbSocket->escapeSimple($invoiceItem['tax']).\"', '\".\n+                $dbSocket->escapeSimple($invoiceItem['notes']).\"', \".\n+                \" '$currDate', '$currBy', NULL, NULL)\";\n+\n+            $res = $dbSocket->query($sql);\n+            $logDebugSQL .= $sql . \"\\n\";\n \n-\t\t}\n+        }\n \n-\t}\n+    }\n \n \n \n-\tinclude(dirname(__FILE__).'/../../library/closedb.php');\n+    include(dirname(__FILE__).'/../../library/closedb.php');\n \n-\treturn true;\n+    return true;\n \n }\n \n \n-\n-\n-\n /*\n  *********************************************************************************************************\n  * userInvoicesStatus\n@@ -151,126 +152,108 @@ function userInvoiceAdd($userId, $invoiceInfo = array(), $invoiceItems = array()\n  */\n function userInvoicesStatus($user_id, $drawTable) {\n \n-\tinclude_once('include/management/pages_common.php');\n-\tinclude 'library/opendb.php';\n-\n-\t$user_id = $dbSocket->escapeSimple($user_id);\t\t\t// sanitize variable for sql statement\n-\n-\t$sql = \"SELECT COUNT(distinct(a.id)) AS TotalInvoices, a.id, a.date, a.status_id, a.type_id, b.contactperson, b.username, \".\n-\t\t\t\" c.value AS status, COALESCE(SUM(e2.totalpayed), 0) as totalpayed, COALESCE(SUM(d2.totalbilled), 0) as totalbilled, \".\n-\t\t\t\" SUM(a.status_id = 1) as openInvoices \".\n-\t\t\t\" FROM \".$configValues['CONFIG_DB_TBL_DALOBILLINGINVOICE'].\" AS a\".\n-\t\t\t\" INNER JOIN \".$configValues['CONFIG_DB_TBL_DALOUSERBILLINFO'].\" AS b ON (a.user_id = b.id) \".\n-\t\t\t\" INNER JOIN \".$configValues['CONFIG_DB_TBL_DALOBILLINGINVOICESTATUS'].\" AS c ON (a.status_id = c.id) \".\n-\t\t\t\" LEFT JOIN (SELECT SUM(d.amount + d.tax_amount) \".\n-\t\t\t\t\t\" as totalbilled, invoice_id FROM \".$configValues['CONFIG_DB_TBL_DALOBILLINGINVOICEITEMS'].\" AS d \".\n-\t\t\t\" GROUP BY d.invoice_id) AS d2 ON (d2.invoice_id = a.id) \".\n-\t\t\t\" LEFT JOIN (SELECT SUM(e.amount) as totalpayed, invoice_id FROM \".\n-\t\t\t$configValues['CONFIG_DB_TBL_DALOPAYMENTS'].\" AS e GROUP BY e.invoice_id) AS e2 ON (e2.invoice_id = a.id) \".\n-\t\t\t\" WHERE (a.user_id = $user_id)\".\n-\t\t\t\" GROUP BY b.id \";\n+    include_once('include/management/pages_common.php');\n+    include 'library/opendb.php';\n+\n+    $user_id = $dbSocket->escapeSimple($user_id);            // sanitize variable for sql statement\n+\n+    $sql = \"SELECT COUNT(distinct(a.id)) AS TotalInvoices, a.id, a.date, a.status_id, a.type_id, b.contactperson, b.username, \".\n+            \" c.value AS status, COALESCE(SUM(e2.totalpayed), 0) as totalpayed, COALESCE(SUM(d2.totalbilled), 0) as totalbilled, \".\n+            \" SUM(a.status_id = 1) as openInvoices \".\n+            \" FROM \".$configValues['CONFIG_DB_TBL_DALOBILLINGINVOICE'].\" AS a\".\n+            \" INNER JOIN \".$configValues['CONFIG_DB_TBL_DALOUSERBILLINFO'].\" AS b ON (a.user_id = b.id) \".\n+            \" INNER JOIN \".$configValues['CONFIG_DB_TBL_DALOBILLINGINVOICESTATUS'].\" AS c ON (a.status_id = c.id) \".\n+            \" LEFT JOIN (SELECT SUM(d.amount + d.tax_amount) \".\n+                    \" as totalbilled, invoice_id FROM \".$configValues['CONFIG_DB_TBL_DALOBILLINGINVOICEITEMS'].\" AS d \".\n+            \" GROUP BY d.invoice_id) AS d2 ON (d2.invoice_id = a.id) \".\n+            \" LEFT JOIN (SELECT SUM(e.amount) as totalpayed, invoice_id FROM \".\n+            $configValues['CONFIG_DB_TBL_DALOPAYMENTS'].\" AS e GROUP BY e.invoice_id) AS e2 ON (e2.invoice_id = a.id) \".\n+            \" WHERE (a.user_id = $user_id)\".\n+            \" GROUP BY b.id \";\n \n-\t$res = $dbSocket->query($sql);\n-\t$row = $res->fetchRow(DB_FETCHMODE_ASSOC);\n+    $res = $dbSocket->query($sql);\n+    $row = $res->fetchRow(DB_FETCHMODE_ASSOC);\n \n-\t$totalInvoices = $row['TotalInvoices'];\n-\t$totalBilled = $row['totalbilled'];\n-\t$totalPayed = $row['totalpayed'];\n-\t$openInvoices = $row['openInvoices'];\n+    $totalInvoices = $row['TotalInvoices'];\n+    $totalBilled = $row['totalbilled'];\n+    $totalPayed = $row['totalpayed'];\n+    $openInvoices = $row['openInvoices'];\n \n-\tinclude 'library/closedb.php';\n+    include 'library/closedb.php';\n \n-\tif ($drawTable == 1) {\n-\t\techo '\n-\t\t\t\t<fieldset>\n+    if ($drawTable == 1) {\n+        echo '\n+                <fieldset>\n \n                 <h302> User Invoices </h302>\n-\t\t\t\t<br/>\n+                <br/>\n \n-\t\t\t\t<ul>\n+                <ul>\n \n-\t\t\t\t\t<input class=\"button\" type=\"button\" value=\"New Invoice\"\n-\t\t\t\t\t\tonClick=\"javascript:window.location = \\'bill-invoice-new.php?user_id='.$user_id.'\\';\" />\n+                    <input class=\"button\" type=\"button\" value=\"New Invoice\"\n+                        onClick=\"javascript:window.location = \\'bill-invoice-new.php?user_id='.$user_id.'\\';\" />\n \n-\t\t\t\t\t<input class=\"button\" type=\"button\" value=\"Show Invoices\"\n-\t\t\t\t\t\tonClick=\"javascript:window.location = \\'bill-invoice-list.php?user_id='.$user_id.'\\';\" />\n+                    <input class=\"button\" type=\"button\" value=\"Show Invoices\"\n+                        onClick=\"javascript:window.location = \\'bill-invoice-list.php?user_id='.$user_id.'\\';\" />\n \n-\t\t\t\t\t<input class=\"button\" type=\"button\" value=\"Show Payments\"\n-\t\t\t\t\t\tonClick=\"javascript:window.location = \\'bill-payments-list.php?user_id='.$user_id.'\\';\" />\n+                    <input class=\"button\" type=\"button\" value=\"Show Payments\"\n+                        onClick=\"javascript:window.location = \\'bill-payments-list.php?user_id='.$user_id.'\\';\" />\n \n-\t\t\t\t\t<br/><br/>\n+                    <br/><br/>\n \n-\t\t\t\t\t<li class=\"fieldset\">\n-\t\t\t\t\t\t<label for=\"totalInvoices\" class=\"form\">Total Invoices</label>\n-\t\t\t\t\t\t<input type=\"text\" value=\"'.$totalInvoices.'\" disabled />\n-\t\t\t\t\t</li>\n+                    <li class=\"fieldset\">\n+                        <label for=\"totalInvoices\" class=\"form\">Total Invoices</label>\n+                        <input type=\"text\" value=\"'.$totalInvoices.'\" disabled />\n+                    </li>\n \n-\t\t\t\t\t<li class=\"fieldset\">\n-\t\t\t\t\t\t<label for=\"totalbilled\" class=\"form\">Open Invoices</label>\n-\t\t\t\t\t\t<input type=\"text\" value=\"'.$openInvoices.'\" disabled />\n-\t\t\t\t\t</li>\n+                    <li class=\"fieldset\">\n+                        <label for=\"totalbilled\" class=\"form\">Open Invoices</label>\n+                        <input type=\"text\" value=\"'.$openInvoices.'\" disabled />\n+                    </li>\n \n-\t\t\t\t\t<br/>\n+                    <br/>\n \n-\t\t\t\t\t<li class=\"fieldset\">\n-\t\t\t\t\t\t<label for=\"totalbilled\" class=\"form\">Total Billed</label>\n-\t\t\t\t\t\t<input type=\"text\" value=\"'.$totalBilled.'\" disabled />\n-\t\t\t\t\t</li>\n+                    <li class=\"fieldset\">\n+                        <label for=\"totalbilled\" class=\"form\">Total Billed</label>\n+                        <input type=\"text\" value=\"'.$totalBilled.'\" disabled />\n+                    </li>\n \n-\t\t\t\t\t<li class=\"fieldset\">\n-\t\t\t\t\t\t<label for=\"totalbilled\" class=\"form\">Total Payed</label>\n-\t\t\t\t\t\t<input type=\"text\" value=\"'.$totalPayed.'\" disabled />\n-\t\t\t\t\t</li>\n+                    <li class=\"fieldset\">\n+                        <label for=\"totalbilled\" class=\"form\">Total Payed</label>\n+                        <input type=\"text\" value=\"'.$totalPayed.'\" disabled />\n+                    </li>\n \n-\t\t\t\t\t<li class=\"fieldset\">\n-\t\t\t\t\t\t<label for=\"totalbilled\" class=\"form\">Balance</label>\n-\t\t\t\t\t\t<input type=\"text\" value=\"'.($totalPayed - $totalBilled).'\" disabled />\n-\t\t\t\t\t</li>\n+                    <li class=\"fieldset\">\n+                        <label for=\"totalbilled\" class=\"form\">Balance</label>\n+                        <input type=\"text\" value=\"'.($totalPayed - $totalBilled).'\" disabled />\n+                    </li>\n \n \n-\t\t\t\t\t<li class=\"fieldset\">\n-\t\t\t\t\t<br/>\n-\t\t\t\t\t<hr><br/>\n-\t\t\t\t\t<input type=\"submit\" name=\"submit\" value=\"Apply\" tabindex=10000 class=\"button\" />\n-\t\t\t\t\t</li>\n+                    <li class=\"fieldset\">\n+                    <br/>\n+                    <hr><br/>\n+                    <input type=\"submit\" name=\"submit\" value=\"Apply\" tabindex=10000 class=\"button\" />\n+                    </li>\n \n-\t\t\t</ul>\n+            </ul>\n \n-\t\t\t</fieldset>\n+            </fieldset>\n \n-\t\t\t';\n+            ';\n \n-\t}\n+    }\n \n \n }\n \n \n-\n-\n-\n-\n-\n-\n-\n-\n-\n-\n-\n-\n-\n-\n-\n-\n-\n-\n /*\n  *********************************************************************************************************\n  * userBillingRatesSummary\n  * $username            username to provide information of\n- * $startdate\t\tstarting date, first accounting session\n- * $enddate\t\tending date, last accounting session\n- * $ratename\t\tthe rate to use for calculations\n+ * $startdate        starting date, first accounting session\n+ * $enddate        ending date, last accounting session\n+ * $ratename        the rate to use for calculations\n  * $drawTable           if set to 1 (enabled) a toggled on/off table will be drawn\n  *\n  * returns user connection information: uploads, download, session time, total billed, etc...\n@@ -279,10 +262,10 @@ function userInvoicesStatus($user_id, $drawTable) {\n  */\n function userBillingRatesSummary($username, $startdate, $enddate, $ratename, $drawTable) {\n \n-\tinclude_once('include/management/pages_common.php');\n-\tinclude 'library/opendb.php';\n+    include_once('include/management/pages_common.php');\n+    include 'library/opendb.php';\n \n-\t$username = $dbSocket->escapeSimple($username);\t\t\t// sanitize variable for sql statement\n+    $username = $dbSocket->escapeSimple($username);            // sanitize variable for sql statement\n     $startdate = $dbSocket->escapeSimple($startdate);\n     $enddate = $dbSocket->escapeSimple($enddate);\n     $ratename = $dbSocket->escapeSimple($ratename);\n@@ -291,8 +274,8 @@ function userBillingRatesSummary($username, $startdate, $enddate, $ratename, $dr\n     $sql = \"SELECT rateType FROM \".$configValues['CONFIG_DB_TBL_DALOBILLINGRATES'].\" WHERE \".$configValues['CONFIG_DB_TBL_DALOBILLINGRATES'].\".rateName = '$ratename'\";\n     $res = $dbSocket->query($sql);\n \n-\tif ($res->numRows() == 0)\n-\t\treturn;\n+    if ($res->numRows() == 0)\n+        return;\n \n         $row = $res->fetchRow();\n         list($ratetypenum, $ratetypetime) = explode(\"/\",$row[0]);\n@@ -327,39 +310,39 @@ function userBillingRatesSummary($username, $startdate, $enddate, $ratename, $dr\n         $sql = \"SELECT distinct(\".$configValues['CONFIG_DB_TBL_RADACCT'].\".username), \".$configValues['CONFIG_DB_TBL_RADACCT'].\".NASIPAddress, \".\n                 $configValues['CONFIG_DB_TBL_RADACCT'].\".AcctStartTime, SUM(\".$configValues['CONFIG_DB_TBL_RADACCT'].\".AcctSessionTime) AS AcctSessionTime, \".\n                 $configValues['CONFIG_DB_TBL_DALOBILLINGRATES'].\".rateCost, SUM(\".$configValues['CONFIG_DB_TBL_RADACCT'].\".AcctInputOctets) AS AcctInputOctets, \".\n-\t\t\" SUM(\".$configValues['CONFIG_DB_TBL_RADACCT'].\".AcctOutputOctets) AS AcctOutputOctets \".\n+        \" SUM(\".$configValues['CONFIG_DB_TBL_RADACCT'].\".AcctOutputOctets) AS AcctOutputOctets \".\n                 \" FROM \".$configValues['CONFIG_DB_TBL_RADACCT'].\", \".$configValues['CONFIG_DB_TBL_DALOBILLINGRATES'].\" WHERE (AcctStartTime >= '$startdate') and (AcctStartTime <= '$enddate') and (UserName = '$username') and (\".$configValues['CONFIG_DB_TBL_DALOBILLINGRATES'].\".rateName = '$ratename') GROUP BY UserName\";\n-\t$res = $dbSocket->query($sql);\n-\t$row = $res->fetchRow(DB_FETCHMODE_ASSOC);\n+    $res = $dbSocket->query($sql);\n+    $row = $res->fetchRow(DB_FETCHMODE_ASSOC);\n \n-\t$rateCost = $row['rateCost'];\n-\t$userUpload = toxbyte($row['AcctInputOctets']);\n-\t$userDownload = toxbyte($row['AcctOutputOctets']);\n-\t$userOnlineTime = time2str($row['AcctSessionTime']);\n-\t$sessionTime = $row['AcctSessionTime'];\n+    $rateCost = $row['rateCost'];\n+    $userUpload = toxbyte($row['AcctInputOctets']);\n+    $userDownload = toxbyte($row['AcctOutputOctets']);\n+    $userOnlineTime = time2str($row['AcctSessionTime']);\n+    $sessionTime = $row['AcctSessionTime'];\n \n-\t$sumBilled = (($sessionTime/$rateDivisor)*$rateCost);\n+    $sumBilled = (($sessionTime/$rateDivisor)*$rateCost);\n \n         include 'library/closedb.php';\n \n         if ($drawTable == 1) {\n \n                 echo \"<table border='0' class='table1'>\";\n                 echo \"\n-        \t\t<thead>\n-        \t\t\t<tr>\n-        \t                <th colspan='10' align='left'>\n-        \t\t\t\t<a class=\\\"table\\\" href=\\\"javascript:toggleShowDiv('divBillingRatesSummary')\\\">Billing Summary</a>\n-        \t                </th>\n-        \t                </tr>\n-        \t\t</thead>\n-        \t\t</table>\n-        \t\";\n+                <thead>\n+                    <tr>\n+                            <th colspan='10' align='left'>\n+                        <a class=\\\"table\\\" href=\\\"javascript:toggleShowDiv('divBillingRatesSummary')\\\">Billing Summary</a>\n+                            </th>\n+                            </tr>\n+                </thead>\n+                </table>\n+            \";\n \n                 echo \"\n                         <div id='divBillingRatesSummary' style='display:none;visibility:visible'>\n-               \t\t<table border='0' class='table1'>\n-        \t\t<thread>\n+                       <table border='0' class='table1'>\n+                <thread>\n \n                         <tr>\n                         <th scope='col' align='right'>\n@@ -436,189 +419,141 @@ function userBillingRatesSummary($username, $startdate, $enddate, $ratename, $dr\n \n                         </table>\n \n-        \t\t</div>\n-        \t\";\n+                </div>\n+            \";\n \n-\t}\n+    }\n \n \n }\n \n \n-\n /*\n  *********************************************************************************************************\n  * userBillingPayPalSummary\n- * $startdate\t\tstarting date, first accounting session\n- * $enddate\t\tending date, last accounting session\n+ * $startdate        starting date, first accounting session\n+ * $enddate        ending date, last accounting session\n  * $drawTable           if set to 1 (enabled) a toggled on/off table will be drawn\n  *\n  * returns user connection information: uploads, download, session time, total billed, etc...\n  *\n  *********************************************************************************************************\n  */\n-function userBillingPayPalSummary($startdate, $enddate, $payer_email, $payment_address_status, $payer_status, $payment_status, $vendor_type, $drawTable) {\n-\n-\tinclude_once('include/management/pages_common.php');\n-\tinclude 'library/opendb.php';\n-\n-        $startdate = $dbSocket->escapeSimple($startdate);\n-        $enddate = $dbSocket->escapeSimple($enddate);\n-        $payer_email = $dbSocket->escapeSimple($payer_email);\n-        $payment_address_status = $dbSocket->escapeSimple($payment_address_status);\n-        $payer_status = $dbSocket->escapeSimple($payer_status);\n-        $payment_status = $dbSocket->escapeSimple($payment_status);\n-\n-        $sql = \"SELECT \".$configValues['CONFIG_DB_TBL_DALOBILLINGMERCHANT'].\".Username AS Username, business_email, \".\n-        $configValues['CONFIG_DB_TBL_DALOBILLINGPLANS'].\".planName, \".$configValues['CONFIG_DB_TBL_DALOBILLINGMERCHANT'].\".planId, SUM(payment_total) AS total, SUM(payment_fee) \".\n-\t\t\" AS fee, SUM(payment_tax) AS tax, payment_currency, SUM(AcctSessionTime) AS AcctSessionTime, SUM(AcctInputOctets) AS AcctInputOctets, \".\n-\t\t\" SUM(AcctOutputOctets) AS AcctOutputOctets \".\n-\t\t\" FROM \".$configValues['CONFIG_DB_TBL_DALOBILLINGMERCHANT'].\n-\t\t\" LEFT JOIN \".$configValues['CONFIG_DB_TBL_RADACCT'].\" ON \".\n-\t\t$configValues['CONFIG_DB_TBL_DALOBILLINGMERCHANT'].\".Username=\".$configValues['CONFIG_DB_TBL_RADACCT'].\".Username \".\n-\t\t\" LEFT JOIN \".$configValues['CONFIG_DB_TBL_DALOBILLINGPLANS'].\" ON \".\n-\t\t$configValues['CONFIG_DB_TBL_DALOBILLINGMERCHANT'].\".planId=\".$configValues['CONFIG_DB_TBL_DALOBILLINGPLANS'].\".id \".\n-\t\t\" WHERE \".\n-\t        \" (business_email LIKE '$payer_email') AND \".\n-                \" (payment_address_status LIKE '$payment_address_status') AND \".\n-                \" (payer_status LIKE '$payer_status') AND \".\n-                \" (payment_status LIKE '$payment_status') AND \".\n-                \" (vendor_type LIKE '$vendor_type') AND \".\n-                \" (payment_date>'$startdate' AND payment_date<'$enddate')\".\n-\t\t\" GROUP BY Username\";\n-        $res = $dbSocket->query($sql);\n-\n-\tif ($res->numRows() == 0)\n-\t\treturn;\n-\n-\t$row = $res->fetchRow(DB_FETCHMODE_ASSOC);\n-\n-\t$planTotalCost = $row['total'];\n-\t$planTotalTax = $row['tax'];\n-\t$planTotalFee = $row['fee'];\n-\t$userUpload = toxbyte($row['AcctInputOctets']);\n-\t$userDownload = toxbyte($row['AcctOutputOctets']);\n-\t$userOnlineTime = time2str($row['AcctSessionTime']);\n-\t$sessionTime = $row['AcctSessionTime'];\n-\t$planCurrency = $row['payment_currency'];\n-\t$planName = $row['planName'];\n-\t$planId = $row['planId'];\n-\t$payer_email = $row['business_email'];\n-\t$username = $row['Username'];\n-\n-\t$grossGain = ($planTotalCost-($planTotalTax+$planTotalFee));\n-\n-        include 'library/closedb.php';\n-\n-        if ($drawTable == 1) {\n-\n-                echo \"<table border='0' class='table1'>\";\n-                echo \"\n-        \t\t<thead>\n-        \t\t\t<tr>\n-        \t                <th colspan='10' align='left'>\n-        \t\t\t\t<a class=\\\"table\\\" href=\\\"javascript:toggleShowDiv('divBillingPayPalSummary')\\\">Billing Summary</a>\n-        \t                </th>\n-        \t                </tr>\n-        \t\t</thead>\n-        \t\t</table>\n-        \t\";\n-\n-                echo \"\n-                        <div id='divBillingPayPalSummary' style='display:none;visibility:visible'>\n-               \t\t<table border='0' class='table1'>\n-        \t\t<thread>\n-\n-                        <tr>\n-                        <th scope='col' align='right'>\n-                        Username\n-                        </th>\n-\n-                        <th scope='col' align='left'>\n-                        $username (email: $payer_email)\n-                        </th>\n-                        </tr>\n-\n-                        <tr>\n-                        <th scope='col' align='right'>\n-                        Billing for period of\n-                        </th>\n-\n-                        <th scope='col' align='left'>\n-                        $startdate until $enddate (inclusive)\n-                        </th>\n-                        </tr>\n-\n-                        <tr>\n-                        <th scope='col' align='right'>\n-                        Online Time\n-                        </th>\n-\n-                        <th scope='col' align='left'>\n-                        $userOnlineTime\n-                        </th>\n-                        </tr>\n-\n-                        <tr>\n-                        <th scope='col' align='right'>\n-                        User Upload\n-                        </th>\n-\n-                        <th scope='col' align='left'>\n-                        $userUpload\n-                        </th>\n-                        </tr>\n-\n-\n-                        <tr>\n-                        <th scope='col' align='right'>\n-                        User Download\n-                        </th>\n-\n-                        <th scope='col' align='left'>\n-                        $userDownload\n-                        </th>\n-                        </tr>\n-\n-\n-                        <tr>\n-                        <th scope='col' align='right'>\n-                        Plan name\n-                        </th>\n-\n-                        <th scope='col' align='left'>\n-                        $planName (planId: $planId)\n-                        </th>\n-                        </tr>\n-\n-\n-                        <tr>\n-                        <th scope='col' align='right'>\n-                        Total Plans Cost <br/> Total Transaction Fees <br/> Total Transaction Taxs\n-                        </th>\n-\n-                        <th scope='col' align='left'>\n-                        $planTotalCost <br/> $planTotalFee <br/> $planTotalTax\n-                        </th>\n-                        </tr>\n-\n-\n-                        <tr>\n-                        <th scope='col' align='right'>\n-                        Gross Gain\n-                        </th>\n-\n-                        <th scope='col' align='left'>\n-                        $grossGain $planCurrency\n-                        </th>\n-                        </tr>\n-\n-                        </table>\n-\n-        \t\t</div>\n-        \t\";\n+function userBillingPayPalSummary($startdate, $enddate, $payer_email, $payment_address_status,\n+                                  $payer_status, $payment_status, $vendor_type, $drawTable) {\n+    global $logDebugSQL;\n+    \n+    include('library/opendb.php');\n+\n+    $sql_WHERE = array();\n+    \n+    if (!empty($startdate)) {\n+        $sql_WHERE[] = sprintf(\"payment_date > '%s'\", $dbSocket->escapeSimple($startdate));\n+    }\n+    \n+    if (!empty($startdate)) {\n+        $sql_WHERE[] = sprintf(\"payment_date < '%s'\", $dbSocket->escapeSimple($enddate));\n+    }\n+    \n+    if (!empty($payer_email)) {\n+        $sql_WHERE[] = sprintf(\"payer_email LIKE '%s%%'\", $dbSocket->escapeSimple($payer_email));\n+    }\n+    \n+    if (!empty($payment_status)) {\n+        $sql_WHERE[] = sprintf(\"payment_status='%s'\", $dbSocket->escapeSimple($payment_status));\n+    }\n+    \n+    if (!empty($vendor_type)) {\n+        $sql_WHERE[] = sprintf(\"vendor_type='%s'\", $dbSocket->escapeSimple($vendor_type));\n+    }\n+    \n+    if (!empty($payment_address_status)) {\n+        $sql_WHERE[] = sprintf(\"payment_address_status='%s'\", $dbSocket->escapeSimple($payment_address_status));\n+    }\n+    \n+    if (!empty($payer_status)) {\n+        $sql_WHERE[] = sprintf(\"payer_status='%s'\", $dbSocket->escapeSimple($payer_status));\n+    }\n+\n+    $sql = sprintf(\"SELECT dbm.Username AS Username, business_email, dbp.planName, dbm.planId, SUM(payment_total) AS total,\n+                           SUM(payment_fee) AS fee, SUM(payment_tax) AS tax, payment_currency,\n+                           SUM(AcctSessionTime) AS AcctSessionTime, SUM(AcctInputOctets) AS AcctInputOctets,\n+                           SUM(AcctOutputOctets) AS AcctOutputOctets\n+                      FROM %s AS dbm LEFT JOIN %s AS ra ON dbm.Username = ra.Username\n+                                     LEFT JOIN %s AS dbp ON dbm.planId = dbp.id\", $configValues['CONFIG_DB_TBL_DALOBILLINGMERCHANT'],\n+                                                                                  $configValues['CONFIG_DB_TBL_RADACCT'],\n+                                                                                  $configValues['CONFIG_DB_TBL_DALOBILLINGPLANS']);\n+    if (count($sql_WHERE) > 0) {\n+        $sql .= \" WHERE \" . implode(\" AND \", $sql_WHERE);\n+        \n+    }\n+    \n+    $sql .= \" GROUP BY Username\";\n+    $logDebugSQL .= \"$sql;\\n\";\n+    $res = $dbSocket->query($sql);\n \n-\t}\n+    if ($res->numRows() > 0 && $drawTable == 1) {\n+        \n+        include_once('include/management/pages_common.php');\n+        \n+        $row = $res->fetchRow();\n+        \n+        for ($i=0; $i < count($row); $i++) {\n+            $row[$i] = htmlspecialchars($row[$i], ENT_QUOTES, 'UTF-8');\n+        }\n+        \n+        list( $username, $payer_email, $planName, $planId, $planTotalCost, $planTotalFee, $planTotalTax,\n+              $planCurrency, $sessionTime, $userUpload, $userDownload ) = $row;\n+        \n+        $grossGain = $planTotalCost - ($planTotalTax + $planTotalFee);\n+        \n+        $userUpload = toxbyte($userUpload);\n+        $userDownload = toxbyte($userDownload);\n+        $userOnlineTime = time2str($sessionTime);\n+\n+    \n+        $table = array(\n+                        array( \"Username\", \"$username (email: $payer_email)\" ),\n+                        array( \"Billing for period of\", \"$startdate until $enddate (inclusive)\" ),\n+                        array( \"Online Time\", $userOnlineTime ),\n+                        array( \"User Upload\", $userUpload ),\n+                        array( \"User Download\", $userDownload ),\n+                        array( \"Plan name\", \"$planName (planId: $planId)\" ),\n+                        array( \"Total Plans Cost <br/> Total Transaction Fees <br/> Total Transaction Taxs\",\n+                               \"$planTotalCost <br/> $planTotalFee <br/> $planTotalTax\" ),\n+                        array( \"Gross Gain\", \"$grossGain $planCurrency\" )\n+                      );\n+\n+        echo '<table style=\"border: 0\" class=\"table1\">'\n+           . '<thead>'\n+           . '<tr>'\n+           . '<th colspan=\"10\" align=\"left\">';\n+        \n+        printf('<a class=\"table\" href=\"%s\">Billing Summary</a>', \"toggleShowDiv('divBillingPayPalSummary')\");\n+        \n+        echo '</th>'\n+           . '</tr>'\n+           . '</thead>'\n+           . '</table>';\n+\n+\n+        echo '<div id=\"divBillingPayPalSummary\" style=\"display:none; visibility:visible\">'\n+           . '<table style=\"border:0\" class=\"table1\">';\n+        \n+        foreach ($table as $tr) {\n+            list($td1, $td2) = $tr;\n+            \n+            echo \"<tr>\";\n+            printf('<th scope=\"col\" align=\"right\">%s</th>', $td1);\n+            printf('<th scope=\"col\" align=\"left\">%s</th>', $td2);\n+            echo \"</tr>\";\n+        }\n+        \n+        echo '</table>'\n+           . '</div>';\n \n+    }\n+    \n+    include('library/closedb.php');\n \n }"
        },
        {
          "filename": "library/validation.php",
          "status": "modified",
          "additions": 114,
          "deletions": 1,
          "patch": "@@ -65,6 +65,22 @@\n                     \">=\", \"<\", \"<=\", \"=~\", \"!~\", \"=*\", \"!*\"\n                   );\n \n+$valid_recommendedHelpers = array(\n+                                    \"date\", \"datetime\", \"authtype\", \"framedprotocol\", \"servicetype\",\n+                                    \"kbitspersecond\", \"bitspersecond\", \"volumebytes\", \"mikrotikRateLimit\",\n+                                 );\n+\n+$valid_attributeTypes = array(\n+                                \"string\",\n+                                \"integer\",\n+                                \"ipaddr\",\n+                                \"date\",\n+                                \"octets\",\n+                                \"ipv6addr\",\n+                                \"ifid\",\n+                                \"abinary\",\n+                             );\n+\n $valid_db_engines = array(\n                             \"mysql\" => \"MySQL\",\n                             \"pgsql\" => \"PostgreSQL\",\n@@ -86,6 +102,7 @@\n                          \"netserver\", \"pathras\", \"patton\", \"portslave\", \"tc\", \"usrhiper\"\n                        );\n \n+// accounting custom-query options list\n $acct_custom_query_options_all = array(\n                                         \"RadAcctId\",\n                                         \"AcctSessionId\",\n@@ -112,14 +129,110 @@\n                                         \"AcctStartDelay\",\n                                         \"AcctStopDelay\"\n                                     );\n-                                    \n+\n+// accounting custom-query options selected by default\n $acct_custom_query_options_default = array(\n                                             \"UserName\", \"Realm\", \"NASIPAddress\", \"AcctStartTime\", \"AcctStopTime\",\n                                             \"AcctSessionTime\", \"AcctInputOctets\", \"AcctOutputOctets\", \"CalledStationId\",\n                                             \"CallingStationId\", \"AcctTerminateCause\", \"FramedIPAddress\"\n                                           );\n \n+// billing history query options list\n+$bill_history_query_options_all = array(\n+                                            \"id\" => t('all','ID'),\n+                                            \"username\" => t('all','Username'),\n+                                            \"planId\" => t('all','PlanId'),\n+\n+                                            \"billAmount\" => t('all','BillAmount'),\n+                                            \"billAction\" => t('all','BillAction'),\n+                                            \"billPerformer\" => t('all','BillPerformer'),\n+                                            \"billReason\" => t('all','BillReason'),\n+\n+                                            \"paymentmethod\" => t('ContactInfo','PaymentMethod'),\n+                                            \"cash\" => t('ContactInfo','Cash'),\n+\n+                                            \"creditcardname\" => t('ContactInfo','CreditCardName'),\n+                                            \"creditcardnumber\" => t('ContactInfo','CreditCardNumber'),\n+                                            \"creditcardverification\" => t('ContactInfo','CreditCardVerificationNumber'),\n+                                            \"creditcardtype\" => t('ContactInfo','CreditCardType'),\n+                                            \"creditcardexp\" => t('ContactInfo','CreditCardExpiration'),\n+                                            \"coupon\" => t('all','Coupon'),\n+                                            \"discount\" => t('all','Discount'),\n+                                            \"notes\" => t('ContactInfo','Notes'),\n+                                            \"creationdate\" => t('all','CreationDate'),\n+                                            \"creationby\" => t('all','CreationBy'),\n+                                            \"updatedate\" => t('all','UpdateDate'),\n+                                            \"updateby\" => t('all','UpdateBy')\n+                                       );\n+\n+// billing history query options selected by default\n+$bill_history_query_options_default = array(\n+                                                \"username\",\n+                                                \"planId\",\n+                                                \"billAmount\",\n+                                                \"billAction\",\n+                                                \"billPerformer\",\n+                                                \"paymentmethod\"\n+                                           );\n+\n+$bill_merchant_transactions_options_all = array(\n+                                                    \"id\" => t('all','ID'),\n+                                                    \"username\" => t('all','Username'),\n+                                                    \"password\"  => t('all','Password'),\n+                                                    \"txnId\"  => t('all','TxnId'),\n+                                                    \"planName\" => t('all','PlanName'),\n+                                                    \"planId\"  => t('all','PlanId'),\n+                                                    \"quantity\"  => t('all','Quantity'),\n+                                                    \"business_email\"  => t('all','ReceiverEmail'),\n+                                                    \"business_id\"  => t('all','Business'),\n+                                                    \"payment_tax\" => t('all','Tax'),\n+                                                    \"payment_cost\"  => t('all','Cost'),\n+                                                    \"payment_fee\" => t('all','TransactionFee'),\n+                                                    \"payment_total\" => t('all','TotalCost'),\n+                                                    \"payment_currency\" => t('all','PaymentCurrency'),\n+                                                    \"first_name\" => t('all','FirstName'),\n+                                                    \"last_name\" => t('all','LastName'),\n+                                                    \"payer_email\" => t('all','PayerEmail'),\n+                                                    \"payer_address_name\"  => t('all','AddressRecipient'),\n+                                                    \"payer_address_street\"  => t('all','Street'),\n+                                                    \"payer_address_country\" => t('all','Country'),\n+                                                    \"payer_address_country_code\"  => t('all','CountryCode'),\n+                                                    \"payer_address_city\" => t('all','City'),\n+                                                    \"payer_address_state\" => t('all','State'),\n+                                                    \"payer_address_zip\"  => t('all','Zip'),\n+                                                    \"payment_date\" => t('all','PaymentDate'),\n+                                                    \"payment_status\" => t('all','PaymentStatus'),\n+                                                    \"payer_status\" => t('all','PayerStatus'),\n+                                                    \"payment_address_status\" => t('all','PaymentAddressStatus'),\n+                                                    \"vendor_type\" => t('all','VendorType')\n+                                               );\n+                                               \n+$bill_merchant_transactions_options_default = array(\n+                                                        \"username\",\n+                                                        \"planName\",\n+                                                        \"payment_fee\",\n+                                                        \"payment_total\",\n+                                                        \"payment_currency\",\n+                                                        \"first_name\",\n+                                                        \"last_name\",\n+                                                        \"payer_email\",\n+                                                        \"payer_address_country\",\n+                                                        \"payer_address_city\",\n+                                                        \"payer_address_state\",\n+                                                        \"payment_date\",\n+                                                        \"payment_status\",\n+                                                        \"vendor_type\"\n+                                                   );\n+\n // validating values\n+\n+$valid_paymentStatus = array(\n+                              \"Any\", \"Completed\",  \"Denied\",  \"Expired\",  \"Failed\",  \"In-Progress\",  \"Pending\", \n+                              \"Processed\",  \"Refunded\",  \"Reversed\",  \"Canceled-Reversal\",  \"Voided\", \n+                            );\n+$valid_vendorTypes = array( \"Any\", \"2Checkout\", \"PayPal\" );\n+$valid_billactions = array( \"Any\", \"Refill Session Time\", \"Refill Session Traffic\" );\n+\n $valid_languages = array(\n                             \"en\" => \"English\", \n                             \"it\" => \"Italian\", "
        },
        {
          "filename": "menu-accounting-custom.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -23,7 +23,7 @@\n \n // prevent this file to be directly accessed\n if (strpos($_SERVER['PHP_SELF'], '/menu-accounting-custom.php') !== false) {\n-    header(\"Location: /index.php\");\n+    header(\"Location: index.php\");\n     exit;\n }\n "
        },
        {
          "filename": "menu-bill-history.php",
          "status": "modified",
          "additions": 71,
          "deletions": 81,
          "patch": "@@ -23,7 +23,7 @@\n \n // prevent this file to be directly accessed\n if (strpos($_SERVER['PHP_SELF'], '/menu-bill-history.php') !== false) {\n-    header(\"Location: /index.php\");\n+    header(\"Location: index.php\");\n     exit;\n }\n \n@@ -34,42 +34,6 @@\n include_once(\"include/menu/menu-items.php\");\n include_once(\"include/menu/billing-subnav.php\");\n \n-$checkboxes = array(\n-                        \"id\" => t('all','ID'),\n-                        \"username\" => t('all','Username'),\n-                        \"planId\" => t('all','PlanId'),\n-\n-                        \"billAmount\" => t('all','BillAmount'),\n-                        \"billAction\" => t('all','BillAction'),\n-                        \"billPerformer\" => t('all','BillPerformer'),\n-                        \"billReason\" => t('all','BillReason'),\n-\n-                        \"paymentmethod\" => t('ContactInfo','PaymentMethod'),\n-                        \"cash\" => t('ContactInfo','Cash'),\n-\n-                        \"creditcardname\" => t('ContactInfo','CreditCardName'),\n-                        \"creditcardnumber\" => t('ContactInfo','CreditCardNumber'),\n-                        \"creditcardverification\" => t('ContactInfo','CreditCardVerificationNumber'),\n-                        \"creditcardtype\" => t('ContactInfo','CreditCardType'),\n-                        \"creditcardexp\" => t('ContactInfo','CreditCardExpiration'),\n-                        \"coupon\" => t('all','Coupon'),\n-                        \"discount\" => t('all','Discount'),\n-                        \"notes\" => t('ContactInfo','Notes'),\n-                        \"creationdate\" => t('all','CreationDate'),\n-                        \"creationby\" => t('all','CreationBy'),\n-                        \"updatedate\" => t('all','UpdateDate'),\n-                        \"updateby\" => t('all','UpdateBy')\n-                    );\n-\n-$checkboxes_checked = array(\n-                                \"username\",\n-                                \"planId\",\n-                                \"billAmount\",\n-                                \"billAction\",\n-                                \"billPerformer\",\n-                                \"paymentmethod\"\n-                           );\n-\n ?>\n \n             <div id=\"sidebar\">\n@@ -82,64 +46,81 @@\n                             <input class=\"sidebutton\" type=\"submit\" name=\"submit\" value=\"<?= t('button','ProcessQuery') ?>\">\n                             \n                             <br><br>\n-\n-                            <h109><?= t('button','BetweenDates') ?></h109><br>\n+<?php\n+/*                            <h109><?= t('button','BetweenDates') ?></h109><br>\n                             <label style=\"user-select: none\" for=\"startdate\"><?= t('all','StartingDate') ?></label>\n                             <input name=\"startdate\" type=\"date\" id=\"startdate\" tooltipText=\"<?= t('Tooltip','Date') ?>\"\n                                 value=\"<?= (isset($billing_date_startdate)) ? $billing_date_startdate : date(\"Y-m-01\") ?>\">\n \n                             <label style=\"user-select: none\" for=\"enddate\"><?= t('all','EndingDate') ?></label>\n                             <input name=\"enddate\" type=\"date\" id=\"enddate\" tooltipText=\"<?= t('Tooltip','Date') ?>\"\n                                 value=\"<?= (isset($billing_date_enddate)) ? $billing_date_enddate : date(\"Y-m-t\") ?>\">\n-                            \n-                            <br><br>\n \n-                            <h109><?= t('all','Username') ?></h109><br>\n-                            <input name=\"username\" type=\"text\"\n-                                value=\"<?= (isset($billing_history_username)) ? $billing_history_username : \"*\" ?>\">\n-\n-                            <h109><?= t('all','BillAction') ?></h109><br>\n-                            <select name=\"billaction\" size=\"1\">\n-                                <option value=\"<?= (isset($billing_history_billaction)) ? $billing_history_billaction : \"%\" ?>\">\n-                                    <?= (isset($billing_history_billaction)) ? $billing_history_billaction : \"Any\" ?>\n-                                </option>\n-            \n-                                <option value=\"\"></option>\n-                                <option value=\"Refill Session Time\">Refill Session Time</option>\n-                                <option value=\"Refill Session Traffic\">Refill Session Traffic</option>\n-                            </select>\n+                            <br><br>\n+*/\n+\n+                            $descr = array(\n+                                            \"caption\" => t('all','Username'),\n+                                            \"type\" => \"text\",\n+                                            \"name\" => \"username\",\n+                                            \"value\" => ((isset($billing_history_username)) ? $billing_history_username : \"\"),\n+                                          );\n+                                          \n+                            print_form_component($descr);\n+\n+                            $descr = array(\n+                                            \"caption\" => t('all','BillAction'),\n+                                            \"type\" => \"select\",\n+                                            \"name\" => \"billaction\",\n+                                            \"options\" => $valid_billactions,\n+                                            \"selected_value\" => ((isset($billaction)) ? $billaction : $valid_billactions[0]),\n+                                          );\n                             \n+                            print_form_component($descr);\n+?>\n+\n                             <br><br>\n-                                \n-                            <h109><?= t('button','AccountingFieldsinQuery') ?></h109><br>\n <?php\n-                            foreach ($checkboxes as $value => $caption) {\n-                                $checked = in_array($value, $checkboxes_checked) ? ' checked' : '';\n-                                printf('<input type=\"checkbox\" name=\"sqlfields[]\" value=\"%s\"%s><h109>%s</h109><br>', $value, $checked, $caption);\n-                            }\n+                            \n+                            $descr = array(\n+                                            \"caption\" => t('button','AccountingFieldsinQuery'),\n+                                            \"type\" => \"select\",\n+                                            \"name\" => \"sqlfields[]\",\n+                                            \"id\" => \"sqlfields\",\n+                                            \"options\" => $bill_history_query_options_all,\n+                                            \"selected_value\" => ((isset($sqlfields)) ? $sqlfields : $bill_history_query_options_default),\n+                                            \"multiple\" => true\n+                                          );\n+                            \n+                            print_form_component($descr);\n+                            \n ?>\n-\n-                            <br>Select:\n-                            <a class=\"table\" href=\"javascript:SetChecked(1,'sqlfields[]','billhistory')\">All</a>\n-                            <a class=\"table\" href=\"javascript:SetChecked(0,'sqlfields[]','billhistory')\">None</a>\n-\n+                            <a style=\"display: inline\" href=\"#\" onclick=\"select('all')\">Select All</a>\n+                            <a style=\"display: inline\" href=\"#\" onclick=\"select('none')\">Select None</a>\n                             <br><br>\n-            \n-                            <h109><?= t('button','OrderBy') ?><h109><br>         \n-                            <div style=\"text-align: center\">\n-                                <select name=\"orderBy\" size=\"1\">\n-                                    <option value=\"id\"> Id </option>\n-                                    <option value=\"username\"> username </option>\n-                                    <option value=\"txnId\"> txnId </option>\n-                                </select>\n \n-                                <select name=\"orderType\" size=\"1\">\n-                                    <option value=\"ASC\"> Ascending </option>\n-                                    <option value=\"DESC\"> Descending </option>\n-                                </select>\n-                            </div>\n-\n-                            <br><br>\n+<?php\n+                            $descr = array(\n+                                            \"caption\" => t('button','OrderBy'),\n+                                            \"type\" => \"select\",\n+                                            \"name\" => \"orderBy\",\n+                                            \"options\" => $bill_history_query_options_all,\n+                                            \"selected_value\" => ((isset($orderBy)) ? $orderBy : $bill_history_query_options_all[0])\n+                                          );\n+                            \n+                            print_form_component($descr);\n+\n+                            $descr = array(\n+                                            \"caption\" => \"Order Type\",\n+                                            \"type\" => \"select\",\n+                                            \"name\" => \"orderType\",\n+                                            \"options\" => array(\"asc\" => \"Ascending\", \"desc\" => \"Descending\"),\n+                                            \"selected_value\" => ((isset($orderType)) ? $orderType : \"asc\")\n+                                          );\n+                            \n+                            print_form_component($descr);\n+?>\n+                            <br>\n    \n                             <input class=\"sidebutton\" type=\"submit\" name=\"submit\" value=\"<?= t('button','ProcessQuery') ?>\">\n                         </form>\n@@ -148,6 +129,15 @@\n             </div><!-- #sidebar -->\n \n <script>\n+    function select(what) {\n+        var selected = (what == 'all'),\n+            sqlfields = document.getElementById('sqlfields');\n+    \n+        for (var i = 0; i < sqlfields.options.length; i++) {\n+            sqlfields.options[i].selected = selected;\n+        }\n+    }\n+    \n     var tooltipObj = new DHTMLgoodies_formTooltip();\n     tooltipObj.setTooltipPosition('right');\n     tooltipObj.setPageBgColor('#EEEEEE');"
        },
        {
          "filename": "menu-bill-merchant.php",
          "status": "modified",
          "additions": 78,
          "deletions": 116,
          "patch": "@@ -23,7 +23,7 @@\n \n // prevent this file to be directly accessed\n if (strpos($_SERVER['PHP_SELF'], '/menu-bill-merchant.php') !== false) {\n-    header(\"Location: /index.php\");\n+    header(\"Location: index.php\");\n     exit;\n }\n \n@@ -33,54 +33,6 @@\n \n include_once(\"include/menu/menu-items.php\");\n include_once(\"include/menu/billing-subnav.php\");\n-    \n-$checkboxes = array(\n-                        \"id\" => t('all','ID'),\n-                        \"username\" => t('all','Username'),\n-                        \"password\"  => t('all','Password'),\n-                        \"txnId\"  => t('all','TxnId'),\n-                        \"planName\" => t('all','PlanName'),\n-                        \"planId\"  => t('all','PlanId'),\n-                        \"quantity\"  => t('all','Quantity'),\n-                        \"business_email\"  => t('all','ReceiverEmail'),\n-                        \"business_id\"  => t('all','Business'),\n-                        \"payment_tax\" => t('all','Tax'),\n-                        \"payment_cost\"  => t('all','Cost'),\n-                        \"payment_fee\" => t('all','TransactionFee'),\n-                        \"payment_total\" => t('all','TotalCost'),\n-                        \"payment_currency\" => t('all','PaymentCurrency'),\n-                        \"first_name\" => t('all','FirstName'),\n-                        \"last_name\" => t('all','LastName'),\n-                        \"payer_email\" => t('all','PayerEmail'),\n-                        \"payer_address_name\"  => t('all','AddressRecipient'),\n-                        \"payer_address_street\"  => t('all','Street'),\n-                        \"payer_address_country\" => t('all','Country'),\n-                        \"payer_address_country_code\"  => t('all','CountryCode'),\n-                        \"payer_address_city\" => t('all','City'),\n-                        \"payer_address_state\" => t('all','State'),\n-                        \"payer_address_zip\"  => t('all','Zip'),\n-                        \"payment_date\" => t('all','PaymentDate'),\n-                        \"payment_status\" => t('all','PaymentStatus'),\n-                        \"payer_status\" => t('all','PayerStatus'),\n-                        \"payment_address_status\" => t('all','PaymentAddressStatus'),\n-                        \"vendor_type\" => t('all','VendorType')\n-                   );\n-$checkboxes_checked = array(\n-                            \"username\",\n-                            \"planName\",\n-                            \"payment_fee\",\n-                            \"payment_total\",\n-                            \"payment_currency\",\n-                            \"first_name\",\n-                            \"last_name\",\n-                            \"payer_email\",\n-                            \"payer_address_country\",\n-                            \"payer_address_city\",\n-                            \"payer_address_state\",\n-                            \"payment_date\",\n-                            \"payment_status\",\n-                            \"vendor_type\"\n-                           );\n \n ?>\n \n@@ -99,81 +51,82 @@\n                                 \n                                 <label style=\"user-select: none\" for=\"startdate\"><?= t('all','StartingDate') ?></label>\n                                 <input name=\"startdate\" type=\"date\" id=\"startdate\" tooltipText=\"<?= t('Tooltip','Date') ?>\"\n-                                    value=\"<?= (isset($billing_date_startdate)) ? $billing_date_startdate : date(\"Y-m-01\") ?>\">\n+                                    value=\"<?= (!empty($billing_date_startdate)) ? $billing_date_startdate : date(\"Y-m-01\") ?>\">\n \n                                 <label style=\"user-select: none\" for=\"enddate\"><?= t('all','EndingDate') ?></label>\n-                                <input name=\"enddate\" type=\"text\" id=\"enddate\" tooltipText=\"<?= t('Tooltip','Date') ?>\"\n-                                    value=\"<?= (isset($billing_date_enddate)) ? $billing_date_enddate : date(\"Y-m-t\") ?>\">\n-\n-                                <br><br>\n-\n-                                <h109><?= t('all','VendorType'); ?></h109><br>\n-                                <select name=\"vendor_type\" size=\"1\">\n-                                    <option value=\"<?= (isset($billing_paypal_vendor_type)) ? $billing_paypal_vendor_type : \"%\" ?>\">\n-                                        <?= (isset($billing_paypal_vendor_type)) ? $billing_paypal_vendor_type : \"Any\" ?>\n-                                    </option>\n-                                    <option value=\"\"></option>\n-                                    <option value=\"%\">Any</option>\n-                                    <option value=\"PayPal\">PayPal</option>\n-                                    <option value=\"2Checkout\">2Checkout</option>\n-                                </select>\n-                                \n-                                <h109><?= t('all','PayerEmail'); ?></h109><br>\n-                                <input name=\"payer_email\" type=\"text\"\n-                                    value=\"<?= (isset($billing_paypal_payeremail)) ? $billing_paypal_payeremail : \"*\" ?>\">\n-\t\t\t\n-                                <br><br>\n-\n-                                <h109><?= t('all','PaymentStatus'); ?></h109><br>\n-                                <select name=\"payment_status\" size=\"1\">\n-                                    <option value=\"<?= (isset($billing_paypal_paymentstatus)) ? $billing_paypal_paymentstatus : \"%\" ?>\">\n-                                        <?= (isset($billing_paypal_paymentstatus)) ? $billing_paypal_paymentstatus : \"Any\" ?>\n-                                    </option>\n-                                    <option value=\"\"></option>\n-                                    <option value=\"Completed\">Completed</option>\n-                                    <option value=\"Denied\">Denied</option>\n-                                    <option value=\"Expired\">Expired</option>\n-                                    <option value=\"Failed\">Failed</option>\n-                                    <option value=\"In-Progress\">In-Progress</option>\n-                                    <option value=\"Pending\">Pending</option>\n-                                    <option value=\"Processed\">Processed</option>\n-                                    <option value=\"Refunded\">Refunded</option>\n-                                    <option value=\"Reversed\">Reversed</option>\n-                                    <option value=\"Canceled-Reversal\">Canceled-Reversal</option>\n-                                    <option value=\"Voided\">Voided</option>\n-                                </select>\n+                                <input name=\"enddate\" type=\"date\" id=\"enddate\" tooltipText=\"<?= t('Tooltip','Date') ?>\"\n+                                    value=\"<?= (!empty($billing_date_enddate)) ? $billing_date_enddate : date(\"Y-m-t\") ?>\">\n \n                                 <br><br>\n-\n-                                <h109><?= t('button','AccountingFieldsinQuery'); ?></h109><br>\n <?php\n-                                foreach ($checkboxes as $value => $caption) {\n-                                    $checked = in_array($value, $checkboxes_checked) ? ' checked' : '';\n-                                    printf('<input type=\"checkbox\" name=\"sqlfields[]\" value=\"%s\"%s><h109>%s</h109><br>',\n-                                           $value, $checked, $caption);\n-                                }\n+                            $descr = array(\n+                                            \"caption\" => t('all','VendorType'),\n+                                            \"type\" => \"select\",\n+                                            \"name\" => \"vendor_type\",\n+                                            \"options\" => $valid_vendorTypes,\n+                                            \"selected_value\" => ((isset($billing_paypal_vendor_type)) ? $billing_paypal_vendor_type : $valid_vendorTypes[0])\n+                                          );\n+                            \n+                            print_form_component($descr);\n+                            \n+                            $descr = array(\n+                                            \"caption\" => t('all','PayerEmail'),\n+                                            \"type\" => \"text\",\n+                                            \"name\" => \"payer_email\",\n+                                            \"value\" => ((isset($billing_paypal_payeremail)) ? $billing_paypal_payeremail : \"\"),\n+                                          );\n+                                          \n+                            print_form_component($descr);\n+\n+                            $descr = array(\n+                                            \"caption\" => t('all','PaymentStatus'),\n+                                            \"type\" => \"select\",\n+                                            \"name\" => \"payment_status\",\n+                                            \"options\" => $valid_paymentStatus,\n+                                            \"selected_value\" => ((isset($billing_paypal_paymentstatus)) ? $billing_paypal_paymentstatus : $valid_paymentStatus[0])\n+                                          );\n+                            \n+                            print_form_component($descr);\n+\n+                            $descr = array(\n+                                            \"caption\" => t('button','AccountingFieldsinQuery'),\n+                                            \"type\" => \"select\",\n+                                            \"name\" => \"sqlfields[]\",\n+                                            \"id\" => \"sqlfields\",\n+                                            \"options\" => $bill_merchant_transactions_options_all,\n+                                            \"selected_value\" => ((isset($sqlfields)) ? $sqlfields : $bill_merchant_transactions_options_default),\n+                                            \"multiple\" => true\n+                                          );\n+                            \n+                            print_form_component($descr);\n+                            \n ?>\n-                                <br><h109>Select:</h109>\n-                                <a class=\"table\" href=\"javascript:SetChecked(1,'sqlfields[]','billpaypaltransactions')\">All</a>\n-                                <a class=\"table\" href=\"javascript:SetChecked(0,'sqlfields[]','billpaypaltransactions')\">None</a>\n-\n+                                <a style=\"display: inline\" href=\"#\" onclick=\"select('all')\">Select All</a>\n+                                <a style=\"display: inline\" href=\"#\" onclick=\"select('none')\">Select None</a>\n                                 <br><br>\n-                                \n-                                <h109><?= t('button','OrderBy') ?></h109><br>\n-                                \n-                                <div style=\"text-align: center\">\n-                                    <select name=\"orderBy\" size=\"1\">\n-                                        <option value=\"id\"> Id </option>\n-                                        <option value=\"username\"> username </option>\n-                                        <option value=\"txnId\"> txnId </option>\n-                                    </select>\n-\n-                                    <select name=\"orderType\" size=\"1\">\n-                                        <option value=\"ASC\"> Ascending </option>\n-                                        <option value=\"DESC\"> Descending </option>\n-                                    </select>\n-                                </div>\n \n+<?php\n+                            $descr = array(\n+                                            \"caption\" => t('button','OrderBy'),\n+                                            \"type\" => \"select\",\n+                                            \"name\" => \"orderBy\",\n+                                            \"options\" => $bill_merchant_transactions_options_all,\n+                                            \"selected_value\" => ((isset($orderBy)) ? $orderBy : $bill_merchant_transactions_options_default[0])\n+                                          );\n+                            \n+                            print_form_component($descr);\n+\n+                            $descr = array(\n+                                            \"caption\" => \"Order Type\",\n+                                            \"type\" => \"select\",\n+                                            \"name\" => \"orderType\",\n+                                            \"options\" => array(\"asc\" => \"Ascending\", \"desc\" => \"Descending\"),\n+                                            \"selected_value\" => ((isset($orderType)) ? $orderType : \"asc\")\n+                                          );\n+                            \n+                            print_form_component($descr);\n+?>\n+                               \n                                 <br><br>\n                                 \n                                 <input class=\"sidebutton\" type=\"submit\" name=\"submit\" value=\"<?= t('button','ProcessQuery') ?>\">\n@@ -185,6 +138,15 @@\n             </div><!-- #sidebar -->\n \n <script>\n+    function select(what) {\n+        var selected = (what == 'all'),\n+            sqlfields = document.getElementById('sqlfields');\n+    \n+        for (var i = 0; i < sqlfields.options.length; i++) {\n+            sqlfields.options[i].selected = selected;\n+        }\n+    }\n+    \n     var tooltipObj = new DHTMLgoodies_formTooltip();\n     tooltipObj.setTooltipPosition('right');\n     tooltipObj.setPageBgColor('#EEEEEE');"
        },
        {
          "filename": "mng-batch-add.php",
          "status": "modified",
          "additions": 7,
          "deletions": 9,
          "patch": "@@ -27,17 +27,18 @@\n     include('library/check_operator_perm.php');\n     include_once('library/config_read.php');\n \n-    // set session's page variable\n-    $_SESSION['PREV_LIST_PAGE'] = $_SERVER['REQUEST_URI'];\n-\n     // init logging variables\n     $log = \"visited page: \";\n     $logAction = \"\";\n     $logDebugSQL = \"\";\n     \n-    // we import validation facilities\n-    include_once(\"library/validation.php\");\n-\n+    include_once(\"lang/main.php\");\n+    include(\"library/validation.php\");\n+    include(\"library/layout.php\");\n+    \n+    // set session's page variable\n+    $_SESSION['PREV_LIST_PAGE'] = $_SERVER['REQUEST_URI'];\n+    \n     // if cleartext passwords are not allowed, \n     // we remove Cleartext-Password from the $valid_passwordTypes array\n     if (isset($configValues['CONFIG_DB_PASSWORD_ENCRYPTION']) &&\n@@ -100,9 +101,6 @@ function addUserBatchHistory($dbSocket) {\n         return ($res->numRows() == 1) ? intval($res->fetchRow()[0]) : 0;        \n     }\n     \n-    include_once(\"lang/main.php\");\n-    \n-    include(\"library/layout.php\");\n \n     // print HTML prologue\n     $extra_css = array("
        },
        {
          "filename": "mng-edit.php",
          "status": "modified",
          "additions": 3,
          "deletions": 5,
          "patch": "@@ -32,8 +32,9 @@\n     $logAction = \"\";\n     $logDebugSQL = \"\";\n     \n-    // we import validation facilities\n-    include_once(\"library/validation.php\");\n+    include_once(\"lang/main.php\");\n+    include(\"library/validation.php\");\n+    include(\"library/layout.php\");\n     include_once(\"include/management/functions.php\");\n     \n     \n@@ -387,10 +388,7 @@ function addPlanProfile($dbSocket, $username, $planName, $oldplanName) {\n     $hiddenPassword = (strtolower($configValues['CONFIG_IFACE_PASSWORD_HIDDEN']) == \"yes\")\n                     ? 'password' : 'text';\n     \n-    include_once(\"lang/main.php\");\n     \n-    include(\"library/layout.php\");\n-\n     // print HTML prologue\n     $extra_css = array(\n         // css tabs stuff"
        },
        {
          "filename": "mng-hs-edit.php",
          "status": "modified",
          "additions": 4,
          "deletions": 5,
          "patch": "@@ -32,8 +32,10 @@\n     $logAction = \"\";\n     $logDebugSQL = \"\";\n \n-    // we import validation facilities\n-    include_once(\"library/validation.php\");\n+    include_once(\"lang/main.php\");\n+    include(\"library/validation.php\");\n+    include(\"library/layout.php\");\n+    \n \n     include('library/opendb.php');\n \n@@ -169,9 +171,6 @@\n \n     include('library/closedb.php');\n \n-    include_once(\"lang/main.php\");\n-    \n-    include(\"library/layout.php\");\n \n     // print HTML prologue\n     $extra_css = array("
        },
        {
          "filename": "mng-hs-list.php",
          "status": "modified",
          "additions": 15,
          "deletions": 25,
          "patch": "@@ -32,12 +32,12 @@\n     $logQuery = \"performed query for listing of records on page: \";\n     $logDebugSQL = \"\";\n \n+    include_once(\"lang/main.php\");\n+    include(\"library/layout.php\");\n+\n     // set session's page variable\n     $_SESSION['PREV_LIST_PAGE'] = $_SERVER['REQUEST_URI'];\n \n-    include_once(\"lang/main.php\");\n-    \n-    include(\"library/layout.php\");\n \n     // print HTML prologue\n     $extra_js = array(\n@@ -141,7 +141,8 @@\n         \n         <tbody>\n <?php\n-        $count = 1;\n+        $li_style = 'margin: 7px auto';\n+        $count = 0;\n         while ($row = $res->fetchRow()) {\n             $rowlen = count($row);\n         \n@@ -152,7 +153,6 @@\n         \n             list($name, $owner, $company, $type) = $row;\n             \n-            $li_style = 'margin: 7px auto';\n             $tooltipText = '<ul style=\"list-style-type: none\">'\n                          . sprintf('<li style=\"%s\"><a class=\"toolTip\" href=\"mng-hs-edit.php?name=%s\">%s</a></li>',\n                                    $li_style, urlencode($name), t('Tooltip','HotspotEdit'))\n@@ -201,26 +201,16 @@\n     }\n     \n     include('library/closedb.php');\n-?>\n-                \n-        </div><!-- #contentnorightbar -->\n-        \n-        <div id=\"footer\">\n-<?php\n+\n     include('include/config/logging.php');\n-    include('page-footer.php');\n-?>\n-        </div><!-- #footer -->\n-    </div>\n-</div>\n+    \n+    $inline_extra_js = \"\n+var tooltipObj = new DHTMLgoodies_formTooltip();\n+tooltipObj.setTooltipPosition('right');\n+tooltipObj.setPageBgColor('#EEEEEE');\n+tooltipObj.setTooltipCornerSize(15);\n+tooltipObj.initFormFieldTooltip()\";\n \n-<script>\n-    var tooltipObj = new DHTMLgoodies_formTooltip();\n-    tooltipObj.setTooltipPosition('right');\n-    tooltipObj.setPageBgColor('#EEEEEE');\n-    tooltipObj.setTooltipCornerSize(15);\n-    tooltipObj.initFormFieldTooltip();\n-</script>\n+    print_footer_and_html_epilogue($inline_extra_js);\n \n-</body>\n-</html>\n+?>"
        },
        {
          "filename": "mng-import-users.php",
          "status": "modified",
          "additions": 9,
          "deletions": 9,
          "patch": "@@ -32,26 +32,28 @@\n     $logAction = \"\";\n     $logDebugSQL = \"\";\n \n-    // we import validation facilities\n-    include_once(\"library/validation.php\");\n-    include(\"include/management/functions.php\");\n+    include_once(\"lang/main.php\");\n+    include(\"library/validation.php\");\n+    include(\"library/layout.php\");\n+    include_once(\"include/management/functions.php\");\n+\n+    include_once('include/management/populate_selectbox.php');\n \n     // custom valid authTypes\n     $valid_authTypes = array(\n                                 \"userAuth\" => \"Based on username and password\",\n                                 \"otherAuth\" => \"Based on MAC addr/PIN code\"\n                             );\n \n+    $valid_groups = get_groups();\n+    $valid_planNames = get_plans();\n+\n     // if cleartext passwords are not allowed, \n     // we remove Cleartext-Password from the $valid_passwordTypes array\n     if (isset($configValues['CONFIG_DB_PASSWORD_ENCRYPTION']) &&\n         strtolower($configValues['CONFIG_DB_PASSWORD_ENCRYPTION']) !== 'cleartext') {\n         $valid_passwordTypes = array_diff($valid_passwordTypes, array(\"Cleartext-Password\"));\n     }\n-    \n-    include_once('include/management/populate_selectbox.php');\n-    $valid_groups = get_groups();\n-    $valid_planNames = get_plans();\n \n     if ($_SERVER['REQUEST_METHOD'] === 'POST') {\n         if (array_key_exists('csrf_token', $_POST) && isset($_POST['csrf_token']) && dalo_check_csrf_token($_POST['csrf_token'])) {\n@@ -184,8 +186,6 @@\n         }\n     }\n \n-    include_once(\"lang/main.php\");\n-    include(\"library/layout.php\");\n \n     // print HTML prologue\n     $extra_css = array();"
        },
        {
          "filename": "mng-list-all.php",
          "status": "modified",
          "additions": 22,
          "deletions": 18,
          "patch": "@@ -101,9 +101,10 @@\n     $_SESSION['reportType'] = \"usernameListGeneric\";\n \n     // we use this simplified query just to initialize $numrows\n-    $sql0 = sprintf(\"SELECT COUNT(DISTINCT(username)) AS username\n-                       FROM %s\n-                      WHERE attribute='Auth-Type' OR attribute LIKE '%%-Password'\", $configValues['CONFIG_DB_TBL_RADCHECK']);\n+    $sql0 = sprintf(\"SELECT COUNT(DISTINCT(rc.username)) AS username\n+                       FROM %s AS rc, %s AS ui\n+                      WHERE rc.username=ui.username AND (rc.attribute='Auth-Type' OR rc.attribute LIKE '%%-Password')\",\n+                    $configValues['CONFIG_DB_TBL_RADCHECK'], $configValues['CONFIG_DB_TBL_DALOUSERINFO']);\n     $res = $dbSocket->query($sql0);\n     $logDebugSQL .= \"$sql0;\\n\";\n     $numrows = $res->fetchrow()[0];\n@@ -171,22 +172,25 @@\n             $usernamelist[] = sprintf(\"'%s'\", $dbSocket->escapeSimple($this_username));\n         }\n         \n-        // with this second query we retrieve user status (enabled/disabled) and user groups list\n-        $sql2 = sprintf(\"SELECT username, groupname FROM %s WHERE username IN (%s)\",\n-                        $configValues['CONFIG_DB_TBL_RADUSERGROUP'], implode(\", \", $usernamelist));\n-        $res = $dbSocket->query($sql2);\n-        $logDebugSQL .= \"$sql2;\\n\";\n+        if (count($usernamelist) > 0) {\n+        \n+            // with this second query we retrieve user status (enabled/disabled) and user groups list\n+            $sql2 = sprintf(\"SELECT username, groupname FROM %s WHERE username IN (%s)\",\n+                            $configValues['CONFIG_DB_TBL_RADUSERGROUP'], implode(\", \", $usernamelist));\n+            $res = $dbSocket->query($sql2);\n+            $logDebugSQL .= \"$sql2;\\n\";\n \n-        // foreach user we update the enabled flag and the grouplist\n-        while ($row = $res->fetchRow(DB_FETCHMODE_ASSOC)) {\n-            $this_username = $row['username'];\n-            $this_groupname = $row['groupname'];\n+            // foreach user we update the enabled flag and the grouplist\n+            while ($row = $res->fetchRow(DB_FETCHMODE_ASSOC)) {\n+                $this_username = $row['username'];\n+                $this_groupname = $row['groupname'];\n \n-            if ($this_groupname === 'daloRADIUS-Disabled-Users') {\n-                $records[$this_username]['enabled'] = false;\n-            } else {\n-                array_push($records[$this_username]['groups'],\n-                           htmlspecialchars($this_groupname, ENT_QUOTES, 'UTF-8'));\n+                if ($this_groupname === 'daloRADIUS-Disabled-Users') {\n+                    $records[$this_username]['enabled'] = false;\n+                } else {\n+                    array_push($records[$this_username]['groups'],\n+                               htmlspecialchars($this_groupname, ENT_QUOTES, 'UTF-8'));\n+                }\n             }\n         }\n         \n@@ -274,7 +278,7 @@\n                 </td>\n                 <td><?= \"$fullname\" ?></td>\n                 <td><?= \"$img $tooltip\" . sprintf(' <span class=\"badge badge-%s\">%s</span>', strtolower($type), $type); ?></td>\n-                <td><?= ($type == 'USER') ? $auth : \"\" ?></td>\n+                <td><?= ($type == 'USER') ? $auth : \"(n/a)\" ?></td>\n                 <td><?= $grouplist ?></td>\n             </tr>\n <?php"
        },
        {
          "filename": "mng-new-quick.php",
          "status": "modified",
          "additions": 5,
          "deletions": 7,
          "patch": "@@ -32,9 +32,10 @@\n     $logAction = \"\";\n     $logDebugSQL = \"\";\n \n-    // we import validation facilities\n-    include_once(\"library/validation.php\");\n-    include(\"include/management/functions.php\");\n+    include_once(\"lang/main.php\");\n+    include(\"library/validation.php\");\n+    include(\"library/layout.php\");\n+    include_once(\"include/management/functions.php\");\n     \n     // if cleartext passwords are not allowed, \n     // we remove Cleartext-Password from the $valid_passwordTypes array\n@@ -273,10 +274,7 @@\n \n     $hiddenPassword = (strtolower($configValues['CONFIG_IFACE_PASSWORD_HIDDEN']) == \"yes\")\n                     ? 'password' : 'text';\n-    \n-    include_once(\"lang/main.php\");\n-    \n-    include(\"library/layout.php\");\n+\n \n     // print HTML prologue\n     $extra_css = array("
        },
        {
          "filename": "mng-new.php",
          "status": "modified",
          "additions": 4,
          "deletions": 6,
          "patch": "@@ -32,9 +32,10 @@\n     $logAction = \"\";\n     $logDebugSQL = \"\";\n \n-    // we import validation facilities\n-    include_once(\"library/validation.php\");\n-    include(\"include/management/functions.php\");\n+    include_once(\"lang/main.php\");\n+    include(\"library/validation.php\");\n+    include(\"library/layout.php\");\n+    include_once(\"include/management/functions.php\");\n \n     // if cleartext passwords are not allowed, \n     // we remove Cleartext-Password from the $valid_passwordTypes array\n@@ -321,10 +322,7 @@\n     $hiddenPassword = (strtolower($configValues['CONFIG_IFACE_PASSWORD_HIDDEN']) == \"yes\")\n                     ? 'password' : 'text';\n     \n-    include_once(\"lang/main.php\");\n     \n-    include(\"library/layout.php\");\n-\n     // print HTML prologue\n     $extra_css = array(\n         // css tabs stuff"
        },
        {
          "filename": "mng-rad-attributes-edit.php",
          "status": "modified",
          "additions": 237,
          "deletions": 191,
          "patch": "@@ -32,81 +32,117 @@\n     $logAction = \"\";\n     $logDebugSQL = \"\";\n \n-    isset($_REQUEST['vendor']) ? $vendor = $_REQUEST['vendor'] : $vendor = \"\";\n-    isset($_REQUEST['attribute']) ? $attribute = $_REQUEST['attribute'] : $attribute = \"\";\n-\n-    if (isset($_POST[\"submit\"])) {\n-\n-        isset($_POST['vendor']) ? $vendor = $_POST['vendor'] : $vendor = \"\";\n-        isset($_POST['attributeOld']) ? $attributeOld = $_POST['attributeOld'] : $attributeOld = \"\";\n-        isset($_POST['attribute']) ? $attribute = $_POST['attribute'] : $attribute = \"\";\n-        isset($_POST['type']) ? $type = $_POST['type'] : $type = \"\";\n-        isset($_POST['RecommendedOP']) ? $RecommendedOP = $_POST['RecommendedOP'] : $RecommendedOP = \"\";\n-        isset($_POST['RecommendedTable']) ? $RecommendedTable = $_POST['RecommendedTable'] : $RecommendedTable = \"\";\n-        isset($_POST['RecommendedTooltip']) ? $RecommendedTooltip = $_POST['RecommendedTooltip'] : $RecommendedTooltip = \"\";\n-        isset($_POST['RecommendedHelper']) ? $RecommendedHelper = $_POST['RecommendedHelper'] : $RecommendedHelper = \"\";\n+    include_once(\"lang/main.php\");\n+    include(\"library/validation.php\");\n+    include(\"library/layout.php\");\n \n-        include 'library/opendb.php';\n+    // custom validation structures\n+    $valid_tables = array(\"check\", \"reply\");\n \n-        $sql = \"SELECT * FROM \".$configValues['CONFIG_DB_TBL_DALODICTIONARY'].\" WHERE vendor='\".$dbSocket->escapeSimple($vendor).\n-            \"' AND attribute='\".$dbSocket->escapeSimple($attribute).\"'\";\n+    function attribute_vendor_exist($dbSocket, $attribute, $vendor) {\n+        global $configValues, $logDebugSQL;\n+        \n+        $sql = sprintf(\"SELECT COUNT(DISTINCT(id)) FROM %s WHERE attribute='%s' AND vendor='%s'\",\n+                               $configValues['CONFIG_DB_TBL_DALODICTIONARY'],\n+                               $dbSocket->escapeSimple($attribute),\n+                               $dbSocket->escapeSimple($vendor));\n         $res = $dbSocket->query($sql);\n-        $logDebugSQL .= $sql . \"\\n\";\n-\n-        if ($res->numRows() == 1) {\n-            if (trim($vendor) != \"\" and trim($attribute) != \"\") {\n-                // update vendor/attribute pairs to database\n-                $sql = \"UPDATE \".$configValues['CONFIG_DB_TBL_DALODICTIONARY'].\" SET \n-                    type='\".\n-                    $dbSocket->escapeSimple($type).\"', attribute='\".$dbSocket->escapeSimple($attribute).\n-                    \"', RecommendedOP='\".$dbSocket->escapeSimple($RecommendedOP).\n-                    \"', RecommendedTable='\".$dbSocket->escapeSimple($RecommendedTable).\n-                    \"', RecommendedTooltip='\".$dbSocket->escapeSimple($RecommendedTooltip).\n-                    \"', RecommendedHelper='\".$dbSocket->escapeSimple($RecommendedHelper).\n-                    \"' WHERE Vendor='$vendor' AND Attribute='$attributeOld'\";\n-                $res = $dbSocket->query($sql);\n-                $logDebugSQL .= $sql . \"\\n\";\n-\n-                $successMsg = \"Updated database with vendor attribute: <b>$attribute</b> of vendor: <b>$vendor</b>\";\n-                $logAction .= \"Successfully update vendor [$vendor] and attribute [$attribute] on page: \";\n+        $logDebugSQL .= \"$sql;\\n\";\n+        \n+        return $res->fetchrow()[0] > 0;\n+    }\n+\n+    \n+    if ($_SERVER['REQUEST_METHOD'] === 'POST') {\n+        if (array_key_exists('csrf_token', $_POST) && isset($_POST['csrf_token']) && dalo_check_csrf_token($_POST['csrf_token'])) {\n+\n+            $vendor = (array_key_exists('vendor', $_POST) && !empty(str_replace(\"%\", \"\", trim($_POST['vendor']))))\n+                    ? str_replace(\"%\", \"\", trim($_POST['vendor'])) : \"\";\n+            $vendor_enc = (!empty($vendor)) ? htmlspecialchars($vendor, ENT_QUOTES, 'UTF-8') : \"\";\n+\n+            $attribute = (array_key_exists('attribute', $_POST) && !empty(str_replace(\"%\", \"\", trim($_POST['attribute']))))\n+                       ? str_replace(\"%\", \"\", trim($_POST['attribute'])) : \"\";\n+            $attribute_enc = (!empty($attribute)) ? htmlspecialchars($attribute, ENT_QUOTES, 'UTF-8') : \"\";\n+\n+            $type = (array_key_exists('type', $_POST) && !empty(trim($_POST['type'])) &&\n+                     in_array(trim($_POST['type']), $valid_attributeTypes))\n+                  ? $_POST['type'] : \"\";\n+\n+            $op = (array_key_exists('RecommendedOP', $_POST) && isset($_POST['RecommendedOP']) &&\n+                   in_array($_POST['RecommendedOP'], $valid_ops))\n+                ? $_POST['RecommendedOP'] : \"\";\n+            \n+            $table = (array_key_exists('RecommendedTable', $_POST) && isset($_POST['RecommendedTable']) &&\n+                      in_array($_POST['RecommendedTable'], $valid_tables))\n+                   ? $_POST['RecommendedTable'] : \"\";\n+            \n+            $helper = (array_key_exists('RecommendedHelper', $_POST) && isset($_POST['RecommendedHelper']) &&\n+                       in_array($_POST['RecommendedHelper'], $valid_recommendedHelpers))\n+                    ? $_POST['RecommendedHelper'] : \"\";\n+            \n+            $tooltip = (array_key_exists('RecommendedTooltip', $_POST) &&\n+                        !empty(str_replace(\"%\", \"\", trim($_POST['RecommendedTooltip']))))\n+                     ? str_replace(\"%\", \"\", trim($_POST['RecommendedTooltip'])) : \"\";\n+\n+            if (empty($vendor) || empty($attribute)) {\n+                // vendor and attribute are required\n+                $failureMsg = \"vendor and/or attribute are empty or invalid\";\n+                $logAction .= \"Failed updating attribute [$attribute] (possible empty/invalid vendor and/or attribute) on page: \";\n             } else {\n-                $failureMsg = \"you must provide atleast a vendor name and attribute\";    \n-                $logAction .= \"Failed updating vendor [$vendor] and attribute [$attribute] on page: \";\n+                \n+                include('library/opendb.php');\n+                \n+                $exists = attribute_vendor_exist($dbSocket, $attribute, $vendor);\n+                \n+                if (!$exists) {\n+                    // vendor and/or attribute invalid\n+                    $failureMsg = \"vendor and/or attribute are invalid\";\n+                    $logAction .= \"Failed updating attribute [$attribute] (possible invalid vendor and/or attribute) on page: \";\n+                } else {\n+                    \n+                    $sql = sprintf(\"UPDATE %s\n+                                       SET Type='%s', RecommendedOP='%s', RecommendedTable='%s',\n+                                           RecommendedTooltip='%s', RecommendedHelper='%s'\n+                                     WHERE Vendor='%s' AND Attribute='%s'\",\n+                                   $configValues['CONFIG_DB_TBL_DALODICTIONARY'], $dbSocket->escapeSimple($type),\n+                                   $dbSocket->escapeSimple($op), $dbSocket->escapeSimple($table),\n+                                   $dbSocket->escapeSimple($tooltip), $dbSocket->escapeSimple($helper), \n+                                   $dbSocket->escapeSimple($vendor), $dbSocket->escapeSimple($attribute));\n+                    $res = $dbSocket->query($sql);\n+                    $logDebugSQL .= \"$sql;\\n\";\n+                    \n+                    if (!DB::isError($res)) {\n+                        $format = \"Attribute information has been updated in the dictionary (attribute: %s, vendor: %s)\";\n+                        $successMsg = sprintf($format, $attribute_enc, $vendor_enc);\n+                        $logAction .= sprintf(\"$format on page: \", $attribute, $vendor);\n+                    } else {\n+                        $format = \"An error occurred when updating attribute information in the dictionary (attribute: %s, vendor: %s)\";\n+                        $failureMsg = sprintf($format, $attribute_enc, $vendor_enc);\n+                        $logAction .= sprintf(\"Failed to add an attribute [$format] on page: \", $attribute, $vendor);\n+                    }\n+                }\n+                \n+                include('library/closedb.php');\n             }\n-        } else { \n-            $failureMsg = \"You have tried to update a vendor's attribute that either is not present in the database or there\n-                    may be more than 1 entry for this vendor attribute in database (attribute :$attribute)\";\n-            $logAction .= \"Failed updating vendor attribute already in database [$attribute] on page: \";        \n+\n+        } else {\n+            // csrf\n+            $failureMsg = \"CSRF token error\";\n+            $logAction .= \"$failureMsg on page: \";\n         }\n-    \n-        include 'library/closedb.php';\n+    } else {\n+        // !POST\n+        \n+        $vendor = (array_key_exists('vendor', $_REQUEST) && !empty(str_replace(\"%\", \"\", trim($_REQUEST['vendor']))))\n+                ? str_replace(\"%\", \"\", trim($_REQUEST['vendor'])) : \"\";\n+        $vendor_enc = (!empty($vendor)) ? htmlspecialchars($vendor, ENT_QUOTES, 'UTF-8') : \"\";\n \n+        $attribute = (array_key_exists('attribute', $_REQUEST) && !empty(str_replace(\"%\", \"\", trim($_REQUEST['attribute']))))\n+                   ? str_replace(\"%\", \"\", trim($_REQUEST['attribute'])) : \"\";\n+        $attribute_enc = (!empty($attribute)) ? htmlspecialchars($attribute, ENT_QUOTES, 'UTF-8') : \"\";\n     }\n \n \n-\n-    include 'library/opendb.php';\n-\n-    $sql = \"SELECT * FROM \".$configValues['CONFIG_DB_TBL_DALODICTIONARY'].\" WHERE vendor='\".$dbSocket->escapeSimple($vendor).\n-        \"' AND attribute='\".$dbSocket->escapeSimple($attribute).\"'\";\n-    $res = $dbSocket->query($sql);\n-    $logDebugSQL .= $sql . \"\\n\";\n-\n-    $row = $res->fetchRow(DB_FETCHMODE_ASSOC);\n-\n-    isset($row['Attribute']) ? $attribute = $row['Attribute'] : $attribute = \"\";\n-    isset($row['Type']) ? $type = $row['Type'] : $type = \"\";\n-    isset($row['Vendor']) ? $vendor = $row['Vendor'] : $vendor = \"\";\n-    isset($row['RecommendedOP']) ? $RecommendedOP = $row['RecommendedOP'] : $RecommendedOP = \"\";\n-    isset($row['RecommendedTable']) ? $RecommendedTable = $row['RecommendedTable'] : $RecommendedTable = \"\";\n-    isset($row['RecommendedTooltip']) ? $RecommendedTooltip = $row['RecommendedTooltip'] : $RecommendedTooltip = \"\";\n-    isset($row['RecommendedHelper']) ? $RecommendedHelper = $row['RecommendedHelper'] : $RecommendedHelper = \"\";\n-\n-    include 'library/closedb.php';\n-\n-    include_once(\"lang/main.php\");\n-    include(\"library/layout.php\");\n-\n     // print HTML prologue\n     $title = t('Intro','mngradattributesedit.php');\n     $help = t('helpPage','mngradattributesedit');\n@@ -118,137 +154,147 @@\n     echo '<div id=\"contentnorightbar\">';\n     print_title_and_help($title, $help);\n \n-    include_once('include/management/actionMessages.php');\n+    include('library/opendb.php');\n+    \n+    $exists = attribute_vendor_exist($dbSocket, $attribute, $vendor);\n+                    \n+    if (!$exists) {\n+        // vendor and/or attribute invalid\n+        $failureMsg = \"vendor and/or attribute are invalid\";\n+        $logAction .= \"Failed updating attribute [$attribute] (possible invalid vendor and/or attribute) on page: \";\n+        \n+    } else {\n+        $sql = sprintf(\"SELECT id, Type, Attribute, Value, Format, Vendor, RecommendedOP,\n+                               RecommendedTable, RecommendedHelper, RecommendedTooltip\n+                          FROM %s WHERE attribute='%s' AND vendor='%s' LIMIT 1\",\n+                       $configValues['CONFIG_DB_TBL_DALODICTIONARY'],\n+                       $dbSocket->escapeSimple($attribute),\n+                       $dbSocket->escapeSimple($vendor));\n+        $res = $dbSocket->query($sql);\n+        $logDebugSQL .= \"$sql;\\n\";\n+        \n+        list(\n+                $this_id, $this_Type, $this_Attribute, $this_Value, $this_Format,\n+                $this_Vendor, $this_OP, $this_Table, $this_Helper, $this_Tooltip\n+            ) = $res->fetchrow();\n+            \n+        \n+    }\n+    \n+    include('library/closedb.php');\n \n-?>\n+    include_once('include/management/actionMessages.php');\n \n-        <form action=\"<?php echo $_SERVER['PHP_SELF']; ?>\" method=\"post\">\n-\n-    <fieldset>\n-\n-        <h302> <?php echo t('title','VendorAttribute'); ?> </h302>\n-        <br/>\n-\n-        <ul>\n-\n-        <input type='hidden' name='vendor' value='<?php if (isset($vendor)) echo $vendor ?>' />\n-\n-        <li class='fieldset'>\n-        <label for='vendor' class='form'><?php echo t('all','VendorName') ?></label>\n-        <input disabled name='vendor' type='text' id='vendor' value='<?php if (isset($vendor)) echo $vendor ?>' tabindex=100 />\n-        <img src='images/icons/comment.png' alt='Tip' border='0' onClick=\"javascript:toggleShowDiv('vendorNameTooltip')\" />\n-        \n-        <div id='vendorNameTooltip'  style='display:none;visibility:visible' class='ToolTip'>\n-            <img src='images/icons/comment.png' alt='Tip' border='0' />\n-            <?php echo t('Tooltip','vendorNameTooltip') ?>\n-        </div>\n-        </li>\n-\n-        <input type='hidden' name='attributeOld' value='<?php if (isset($attribute)) echo $attribute ?>' />\n-\n-        <li class='fieldset'>\n-        <label for='attribute' class='form'><?php echo t('all','Attribute') ?></label>\n-        <input name='attribute' type='text' id='attribute' value='<?php if (isset($attribute)) echo $attribute ?>' tabindex=101 />\n-        <img src='images/icons/comment.png' alt='Tip' border='0' onClick=\"javascript:toggleShowDiv('attributeTooltip')\" />\n-        \n-        <div id='attributeTooltip'  style='display:none;visibility:visible' class='ToolTip'>\n-            <img src='images/icons/comment.png' alt='Tip' border='0' />\n-            <?php echo t('Tooltip','attributeTooltip') ?>\n-        </div>\n-        </li>\n-\n-        <li class='fieldset'>\n-        <label for='type' class='form'><?php echo t('all','Type') ?></label>\n-        <select name='type' type='text' id='type' class='form' tabindex=102 />\n-        <option value='<?php echo $type; ?>'><?php echo $type; ?></option>\n-        <?php\n-            include_once('include/management/populate_selectbox.php');\n-            drawTypes();\n-        ?>\n-        </select>\n-        <img src='images/icons/comment.png' alt='Tip' border='0' onClick=\"javascript:toggleShowDiv('typeTooltip')\" />\n-        \n-        <div id='typeTooltip'  style='display:none;visibility:visible' class='ToolTip'>\n-            <img src='images/icons/comment.png' alt='Tip' border='0' />\n-            <?php echo t('Tooltip','typeTooltip') ?>\n-        </div>\n-        </li>\n-\n-        <li class='fieldset'>\n-        <label for='RecommendedOP' class='form'><?php echo t('all','RecommendedOP') ?></label>\n-        <select name='RecommendedOP' type='text' id='RecommendedOP' class='form' tabindex=103 />\n-        <option value='<?php echo $RecommendedOP; ?>'><?php echo $RecommendedOP; ?></option>\n-        <?php\n-            include_once('include/management/populate_selectbox.php');\n-            drawOptions();\n-        ?>\n-        </select>\n-        <img src='images/icons/comment.png' alt='Tip' border='0' onClick=\"javascript:toggleShowDiv('RecommendedOPTooltip')\" />\n-        \n-        <div id='RecommendedOPTooltip'  style='display:none;visibility:visible' class='ToolTip'>\n-            <img src='images/icons/comment.png' alt='Tip' border='0' />\n-            <?php echo t('Tooltip','RecommendedOPTooltip') ?>\n-        </div>\n-        </li>\n-\n-        <li class='fieldset'>\n-        <label for='RecommendedTable' class='form'><?php echo t('all','RecommendedTable') ?></label>\n-        <select name='RecommendedTable' type='text' id='RecommendedTable' class='form' tabindex=104 />\n-        <option value='<?php echo $RecommendedTable; ?>'><?php echo $RecommendedTable; ?></option>\n-        <?php\n-            include_once('include/management/populate_selectbox.php');\n-            drawTables();\n-        ?>\n-        </select>\n-        <img src='images/icons/comment.png' alt='Tip' border='0' onClick=\"javascript:toggleShowDiv('RecommendedTableTooltip')\" />\n-        \n-        <div id='RecommendedTableTooltip'  style='display:none;visibility:visible' class='ToolTip'>\n-            <img src='images/icons/comment.png' alt='Tip' border='0' />\n-            <?php echo t('Tooltip','RecommendedTableTooltip') ?>\n-        </div>\n-        </li>\n-\n-        <li class='fieldset'>\n-        <label for='RecommendedTooltip' class='form'><?php echo t('all','RecommendedTooltip') ?></label>\n-        <textarea class='form' name='RecommendedTooltip' type='text' id='RecommendedTooltip' tabindex=105 /><?php if (isset($RecommendedTooltip)) echo $RecommendedTooltip ?></textarea>\n-        <img src='images/icons/comment.png' alt='Tip' border='0' onClick=\"javascript:toggleShowDiv('RecommendedTooltipTooltip')\" />\n-        \n-        <div id='RecommendedTooltipTooltip'  style='display:none;visibility:visible' class='ToolTip'>\n-            <img src='images/icons/comment.png' alt='Tip' border='0' />\n-            <?php echo t('Tooltip','RecommendedTooltipTooltip') ?>\n-        </div>\n-        </li>\n-\n-\n-        <li class='fieldset'>\n-        <label for='RecommendedHelper' class='form'><?php echo t('all','RecommendedHelper') ?></label>\n-        <select name='RecommendedHelper' type='text' id='RecommendedHelper' class='form' tabindex=104 />\n-        <option value='<?php echo $RecommendedHelper; ?>'><?php echo $RecommendedHelper; ?></option>\n-        <?php\n-            include_once('include/management/populate_selectbox.php');\n-            drawRecommendedHelper();\n-        ?>\n-        </select>\n-        <img src='images/icons/comment.png' alt='Tip' border='0' onClick=\"javascript:toggleShowDiv('RecommendedHelperTooltip')\" />\n-        \n-        <div id='RecommendedHelperTooltip'  style='display:none;visibility:visible' class='ToolTip'>\n-            <img src='images/icons/comment.png' alt='Tip' border='0' />\n-            <?php echo t('Tooltip','RecommendedHelperTooltip') ?>\n-        </div>\n-        </li>\n-    \n-        <li class='fieldset'>\n-        <br/>\n-        <hr><br/>\n-        <input type='submit' name='submit' value='<?php echo t('buttons','apply') ?>' tabindex=10000 class='button' />\n-        </li>\n \n-        </ul>\n-    </fieldset>\n+    if (!isset($successMsg) && !empty($vendor) && !empty($attribute)) {\n+        \n+        $fieldset0_descriptor = array(\n+                                        \"title\" => t('title','VendorAttribute'),\n+                                     );\n \n-    </form>\n+        \n+        $input_descriptors0 = array();\n+        \n+        $input_descriptors0[] = array(\n+                                        \"name\" => \"vendor\",\n+                                        \"type\" => \"hidden\",\n+                                        \"value\" => (isset($vendor) ? $vendor : \"\"),\n+                                     );\n+                                     \n+        $input_descriptors0[] = array(\n+                                        \"name\" => \"attribute\",\n+                                        \"type\" => \"hidden\",\n+                                        \"value\" => (isset($attribute) ? $attribute : \"\"),\n+                                     );\n+        \n+        $input_descriptors0[] = array(\n+                                        \"name\" => \"vendor_presentation\",\n+                                        \"caption\" => t('all','VendorName'),\n+                                        \"type\" => \"text\",\n+                                        \"tooltipText\" => t('Tooltip','vendorNameTooltip'),\n+                                        \"value\" => (isset($vendor) ? $vendor : \"\"),\n+                                        \"disabled\" => true\n+                                     );\n+                                     \n+        $input_descriptors0[] = array(\n+                                        \"name\" => \"attribute_presentation\",\n+                                        \"caption\" => t('all','Attribute'),\n+                                        \"type\" => \"text\",\n+                                        \"tooltipText\" => t('Tooltip','attributeTooltip'),\n+                                        \"value\" => (isset($attribute) ? $attribute : \"\"),\n+                                        \"disabled\" => true\n+                                     );\n+                              \n+        $input_descriptors0[] = array(\n+                                        \"name\" => \"type\",\n+                                        \"caption\" => t('all','Type'),\n+                                        \"type\" => \"text\",\n+                                        \"datalist\" => $valid_attributeTypes,\n+                                        \"value\" => ((isset($type)) ? $type : \"\"),\n+                                        \"tooltipText\" => t('Tooltip','typeTooltip'),\n+                                     );\n+        \n+        $input_descriptors0[] = array(\n+                                        \"name\" => \"RecommendedOP\",\n+                                        \"caption\" => t('all','RecommendedOP'),\n+                                        \"type\" => \"text\",\n+                                        \"datalist\" => $valid_ops,\n+                                        \"value\" => ((isset($op)) ? $op : \"\"),\n+                                        \"tooltipText\" => t('Tooltip','RecommendedOPTooltip'),\n+                                     );\n+        \n+        $input_descriptors0[] = array(\n+                                        \"name\" => \"RecommendedTable\",\n+                                        \"caption\" => t('all','RecommendedTable'),\n+                                        \"type\" => \"text\",\n+                                        \"datalist\" => $valid_tables,\n+                                        \"value\" => ((isset($table)) ? $table : \"\"),\n+                                        \"tooltipText\" => t('Tooltip','RecommendedTableTooltip'),\n+                                     );\n+        \n+        $input_descriptors0[] = array(\n+                                        \"name\" => \"RecommendedHelper\",\n+                                        \"caption\" => t('all','RecommendedHelper'),\n+                                        \"type\" => \"text\",\n+                                        \"datalist\" => $valid_recommendedHelpers,\n+                                        \"value\" => ((isset($helper)) ? $helper : \"\"),\n+                                        \"tooltipText\" => t('Tooltip','RecommendedHelperTooltip'),\n+                                     );\n+        \n+        $input_descriptors0[] = array(\n+                                        \"name\" => \"RecommendedTooltip\",\n+                                        \"caption\" => t('all','RecommendedTooltip'),\n+                                        \"type\" => \"textarea\",\n+                                        \"tooltipText\" => t('Tooltip','RecommendedTooltipTooltip'),\n+                                        \"value\" => (isset($tooltip) ? $tooltip : \"\")\n+                                     );\n+        \n+        $input_descriptors0[] = array(\n+                                        \"name\" => \"csrf_token\",\n+                                        \"type\" => \"hidden\",\n+                                        \"value\" => dalo_csrf_token(),\n+                                     );\n+\n+        $input_descriptors0[] = array(\n+                                        'type' => 'submit',\n+                                        'name' => 'submit',\n+                                        'value' => t('buttons','apply')\n+                                     );\n+        \n+        open_form();\n+        \n+        open_fieldset($fieldset0_descriptor);\n+        \n+        foreach ($input_descriptors0 as $input_descriptor) {\n+            print_form_component($input_descriptor);\n+        }\n+        \n+        close_fieldset();\n+        \n+        close_form();\n+    }\n \n-<?php\n     include('include/config/logging.php');\n     print_footer_and_html_epilogue();\n+\n ?>"
        },
        {
          "filename": "mng-rad-attributes-new.php",
          "status": "modified",
          "additions": 179,
          "deletions": 141,
          "patch": "@@ -32,52 +32,102 @@\n     $logAction = \"\";\n     $logDebugSQL = \"\";\n \n-    if (isset($_POST[\"submit\"])) {\n-\n-        isset($_POST['vendor']) ? $vendor = $_POST['vendor'] : $vendor = \"\";\n-        isset($_POST['attribute']) ? $attribute = $_POST['attribute'] : $attribute = \"\";\n-        isset($_POST['type']) ? $type = $_POST['type'] : $type = \"\";\n-        isset($_POST['RecommendedOP']) ? $RecommendedOP = $_POST['RecommendedOP'] : $RecommendedOP = \"\";\n-        isset($_POST['RecommendedTable']) ? $RecommendedTable = $_POST['RecommendedTable'] : $RecommendedTable = \"\";\n-        isset($_POST['RecommendedTooltip']) ? $RecommendedTooltip = $_POST['RecommendedTooltip'] : $RecommendedTooltip = \"\";\n-\n-        include 'library/opendb.php';\n-\n-        $sql = \"SELECT * FROM \".$configValues['CONFIG_DB_TBL_DALODICTIONARY'].\" WHERE vendor='\".$dbSocket->escapeSimple($vendor).\n-            \"' AND attribute='\".$dbSocket->escapeSimple($attribute).\"'\";\n-        $res = $dbSocket->query($sql);\n-        $logDebugSQL .= $sql . \"\\n\";\n-\n-        if ($res->numRows() == 0) {\n-            if (trim($vendor) != \"\" and trim($attribute) != \"\") {\n-                // insert vendor/attribute pairs to database\n-                $sql = \"INSERT INTO \".$configValues['CONFIG_DB_TBL_DALODICTIONARY'].\n-                    \" (id, type, attribute, vendor, RecommendedOP, RecommendedTable, RecommendedTooltip) VALUES (0, '\".\n-                    $dbSocket->escapeSimple($type).\"', '\".$dbSocket->escapeSimple($attribute).\"','\".\n-                    $dbSocket->escapeSimple($vendor).\"','\".    $dbSocket->escapeSimple($RecommendedOP).\"','\".\n-                    $dbSocket->escapeSimple($RecommendedTable).\"','\".$dbSocket->escapeSimple($RecommendedTooltip).\"')\";\n-                $res = $dbSocket->query($sql);\n-                $logDebugSQL .= $sql . \"\\n\";\n+    include_once(\"lang/main.php\");\n+    include(\"library/validation.php\");\n+    include(\"library/layout.php\");\n \n-                $successMsg = \"Added to database new vendor attribute: <b>$attribute</b> of vendor: <b>$vendor</b>\";\n-                $logAction .= \"Successfully added new vendor [$vendor] and attribute [$attribute] on page: \";\n+    // custom validation structures\n+    $valid_tables = array(\"check\", \"reply\");\n+\n+    if ($_SERVER['REQUEST_METHOD'] === 'POST') {\n+        if (array_key_exists('csrf_token', $_POST) && isset($_POST['csrf_token']) && dalo_check_csrf_token($_POST['csrf_token'])) {\n+            \n+            $vendor = (array_key_exists('vendor', $_POST) && !empty(str_replace(\"%\", \"\", trim($_POST['vendor']))))\n+                    ? str_replace(\"%\", \"\", trim($_POST['vendor'])) : \"\";\n+            $vendor_enc = (!empty($vendor)) ? htmlspecialchars($vendor, ENT_QUOTES, 'UTF-8') : \"\";\n+\n+            $attribute = (array_key_exists('attribute', $_POST) && !empty(str_replace(\"%\", \"\", trim($_POST['attribute']))))\n+                       ? str_replace(\"%\", \"\", trim($_POST['attribute'])) : \"\";\n+            $attribute_enc = (!empty($attribute)) ? htmlspecialchars($attribute, ENT_QUOTES, 'UTF-8') : \"\";\n+            \n+            $type = (array_key_exists('type', $_POST) && isset($_POST['type']) &&\n+                     in_array($_POST['type'], $valid_attributeTypes))\n+                  ? $_POST['type'] : \"\";\n+\n+            $op = (array_key_exists('RecommendedOP', $_POST) && isset($_POST['RecommendedOP']) &&\n+                   in_array($_POST['RecommendedOP'], $valid_ops))\n+                ? $_POST['RecommendedOP'] : \"\";\n+            \n+            $table = (array_key_exists('RecommendedTable', $_POST) && isset($_POST['RecommendedTable']) &&\n+                      in_array($_POST['RecommendedTable'], $valid_tables))\n+                   ? $_POST['RecommendedTable'] : \"\";\n+\n+            $helper = (array_key_exists('RecommendedHelper', $_POST) && isset($_POST['RecommendedHelper']) &&\n+                       in_array($_POST['RecommendedHelper'], $valid_recommendedHelpers))\n+                    ? $_POST['RecommendedHelper'] : \"\";\n+\n+            $tooltip = (array_key_exists('RecommendedTooltip', $_POST) &&\n+                        !empty(str_replace(\"%\", \"\", trim($_POST['RecommendedTooltip']))))\n+                     ? str_replace(\"%\", \"\", trim($_POST['RecommendedTooltip'])) : \"\";\n+\n+            if (empty($vendor) || empty($attribute)) {\n+                // vendor and attribute are required\n+                $failureMsg = \"vendor and/or attribute are empty or invalid\";\n+                $logAction .= \"Failed adding new attribute [$attribute] (possible empty/invalid vendor and/or attribute) on page: \";\n             } else {\n-                $failureMsg = \"You must provide atleast a vendor name and attribute\";    \n-                $logAction .= \"Failed adding new vendor [$vendor] and attribute [$attribute] on page: \";\n+                include('library/opendb.php');\n+                \n+                $sql = sprintf(\"SELECT DISTINCT(Vendor) FROM %s WHERE attribute='%s'\",\n+                               $configValues['CONFIG_DB_TBL_DALODICTIONARY'], $dbSocket->escapeSimple($attribute));\n+                $res = $dbSocket->query($sql);\n+                $logDebugSQL .= \"$sql;\\n\";\n+\n+                $vendors = array();\n+                while ($row = $res->fetchrow()) {\n+                    $vendors[] = $row[0];\n+                }\n+                \n+                if (count($vendors) > 0) {\n+                    // already present\n+                    $format = \"An attribute with the same name is already present in another dictionary (attribute: %s, vendor(s): %s)\";\n+                    $failureMsg = sprintf($format, $attribute_enc, htmlspecialchars(implode(\", \", $vendors), ENT_QUOTES, 'UTF-8'));\n+                    $logAction .= sprintf(\"Failed to add an attribute [$format] on page: \", $attribute, implode(\", \", $vendors));\n+                    \n+                } else {\n+                    \n+                    $sql = sprintf(\"INSERT INTO %s (id, Type, Attribute, Value, Format, Vendor, RecommendedOP,\n+                                                    RecommendedTable, RecommendedHelper, RecommendedTooltip)\n+                                            VALUES (0, '%s', '%s', '', '', '%s', '%s', '%s', '%s', '%s')\",\n+                                   $configValues['CONFIG_DB_TBL_DALODICTIONARY'],\n+                                   $dbSocket->escapeSimple($type), $dbSocket->escapeSimple($attribute),\n+                                   $dbSocket->escapeSimple($vendor), $dbSocket->escapeSimple($op),\n+                                   $dbSocket->escapeSimple($table), $dbSocket->escapeSimple($helper),\n+                                   $dbSocket->escapeSimple($tooltip));\n+                    $res = $dbSocket->query($sql);\n+                    $logDebugSQL .= \"$sql;\\n\";\n+                    \n+                    if (!DB::isError($res)) {\n+                        $format = \"The new attribute has been inserted in the dictionary (attribute: %s, vendor: %s)\";\n+                        $successMsg = sprintf($format, $attribute_enc, $vendor_enc);\n+                        $logAction .= sprintf(\"$format on page: \", $attribute, $vendor);\n+                    } else {\n+                        $format = \"An error occurred when adding the new attribute to a dictionary (attribute: %s, vendor: %s)\";\n+                        $failureMsg = sprintf($format, $attribute_enc, $vendor_enc);\n+                        $logAction .= sprintf(\"Failed to add an attribute [$format] on page: \", $attribute, $vendor);\n+                    }\n+                }\n+                \n+                include('library/closedb.php');\n             }\n-        } else { \n-            $failureMsg = \"You have tried to add a vendor's attribute that already exist in the database: $attribute\";\n-            $logAction .= \"Failed adding new vendor attribute already in database [$attribute] on page: \";        \n+            \n+        } else {\n+            // csrf\n+            $failureMsg = \"CSRF token error\";\n+            $logAction .= \"$failureMsg on page: \";\n         }\n-    \n-        include 'library/closedb.php';\n-\n     }\n-\n-\n-    include_once(\"lang/main.php\");\n-    include(\"library/layout.php\");\n-\n+    \n+    \n     // print HTML prologue\n     $title = t('Intro','mngradattributesnew.php');\n     $help = t('helpPage','mngradattributesnew');\n@@ -91,113 +141,101 @@\n \n     include_once('include/management/actionMessages.php');\n \n-?>\n-\n-<form action=\"<?php echo $_SERVER['PHP_SELF']; ?>\" method=\"post\">\n-    \n-    <fieldset>\n-\n-        <h302> <?php echo t('title','VendorAttribute'); ?> </h302>\n-        <br/>\n+    if (!isset($successMsg)) {\n \n-        <ul>\n+        $fieldset0_descriptor = array(\n+                                        \"title\" => t('title','VendorAttribute'),\n+                                     );\n \n-        <li class='fieldset'>\n-        <label for='vendor' class='form'><?php echo t('all','VendorName') ?></label>\n-        <input name='vendor' type='text' id='vendor' value='' tabindex=100 />\n-        <img src='images/icons/comment.png' alt='Tip' border='0' onClick=\"javascript:toggleShowDiv('vendorNameTooltip')\" />\n         \n-        <div id='vendorNameTooltip'  style='display:none;visibility:visible' class='ToolTip'>\n-            <img src='images/icons/comment.png' alt='Tip' border='0' />\n-            <?php echo t('Tooltip','vendorNameTooltip') ?>\n-        </div>\n-        </li>\n-\n-        <li class='fieldset'>\n-        <label for='attribute' class='form'><?php echo t('all','Attribute') ?></label>\n-        <input name='attribute' type='text' id='attribute' value='' tabindex=101 />\n-        <img src='images/icons/comment.png' alt='Tip' border='0' onClick=\"javascript:toggleShowDiv('attributeTooltip')\" />\n-\n-        <div id='attributeTooltip'  style='display:none;visibility:visible' class='ToolTip'>\n-            <img src='images/icons/comment.png' alt='Tip' border='0' />\n-            <?php echo t('Tooltip','attributeTooltip') ?>\n-        </div>\n-        </li>\n-\n-        <li class='fieldset'>\n-        <label for='type' class='form'><?php echo t('all','Type') ?></label>\n-        <select name='type' type='text' id='type' class='form' tabindex=102 />\n-            <option value=''>Select Type...</option>\n-        <?php\n-            include_once('include/management/populate_selectbox.php');\n-            drawTypes();\n-        ?>\n-        </select>\n-        <img src='images/icons/comment.png' alt='Tip' border='0' onClick=\"javascript:toggleShowDiv('typeTooltip')\" />\n+        $input_descriptors0 = array();\n         \n-        <div id='typeTooltip'  style='display:none;visibility:visible' class='ToolTip'>\n-            <img src='images/icons/comment.png' alt='Tip' border='0' />\n-            <?php echo t('Tooltip','typeTooltip') ?>\n-        </div>\n-        </li>\n-\n-        <li class='fieldset'>\n-        <label for='RecommendedOP' class='form'><?php echo t('all','RecommendedOP') ?></label>\n-        <select name='RecommendedOP' id='RecommendedOP' class='form' tabindex=103 />\n-            <option value=''>Select OP...</option>\n-        <?php\n-            include_once('include/management/populate_selectbox.php');\n-            drawOptions();\n-        ?>\n-        </select>\n-        <img src='images/icons/comment.png' alt='Tip' border='0' onClick=\"javascript:toggleShowDiv('RecommendedOPTooltip')\" />\n+        $input_descriptors0[] = array(\n+                                        \"name\" => \"vendor\",\n+                                        \"caption\" => t('all','VendorName'),\n+                                        \"type\" => \"text\",\n+                                        \"tooltipText\" => t('Tooltip','vendorNameTooltip'),\n+                                        \"value\" => (isset($vendor) ? $vendor : \"\")\n+                                     );\n+                                     \n+        $input_descriptors0[] = array(\n+                                        \"name\" => \"attribute\",\n+                                        \"caption\" => t('all','Attribute'),\n+                                        \"type\" => \"text\",\n+                                        \"tooltipText\" => t('Tooltip','attributeTooltip'),\n+                                        \"value\" => (isset($attribute) ? $attribute : \"\")\n+                                     );\n+                              \n+        $input_descriptors0[] = array(\n+                                        \"name\" => \"type\",\n+                                        \"caption\" => t('all','Type'),\n+                                        \"type\" => \"text\",\n+                                        \"datalist\" => $valid_attributeTypes,\n+                                        \"value\" => ((isset($type)) ? $type : \"\"),\n+                                        \"tooltipText\" => t('Tooltip','typeTooltip'),\n+                                     );\n         \n-        <div id='RecommendedOPTooltip'  style='display:none;visibility:visible' class='ToolTip'>\n-            <img src='images/icons/comment.png' alt='Tip' border='0' />\n-            <?php echo t('Tooltip','RecommendedOPTooltip') ?>\n-        </div>\n-        </li>\n-\n-        <li class='fieldset'>\n-        <label for='RecommendedTable' class='form'><?php echo t('all','RecommendedTable') ?></label>\n-                <select name='RecommendedTable' id='RecommendedTable' class='form' tabindex=104 />\n-        <option value=''>Select Table...</option>\n-        <?php\n-            include_once('include/management/populate_selectbox.php');\n-            drawTables();\n-        ?>\n-        </select>\n-        <img src='images/icons/comment.png' alt='Tip' border='0' onClick=\"javascript:toggleShowDiv('RecommendedTableTooltip')\" />\n+        $input_descriptors0[] = array(\n+                                        \"name\" => \"RecommendedOP\",\n+                                        \"caption\" => t('all','RecommendedOP'),\n+                                        \"type\" => \"text\",\n+                                        \"datalist\" => $valid_ops,\n+                                        \"value\" => ((isset($op)) ? $op : \"\"),\n+                                        \"tooltipText\" => t('Tooltip','RecommendedOPTooltip'),\n+                                     );\n         \n-        <div id='RecommendedTableTooltip'  style='display:none;visibility:visible' class='ToolTip'>\n-            <img src='images/icons/comment.png' alt='Tip' border='0' />\n-            <?php echo t('Tooltip','RecommendedTableTooltip') ?>\n-        </div>\n-        </li>\n-\n-        <li class='fieldset'>\n-        <label for='RecommendedTooltip' class='form'><?php echo t('all','RecommendedTooltip') ?></label>\n-        <textarea class='form' name='RecommendedTooltip' type='text' id='RecommendedTooltip' tabindex=105 /></textarea>\n-        <img src='images/icons/comment.png' alt='Tip' border='0' onClick=\"javascript:toggleShowDiv('RecommendedTooltipTooltip')\" />\n-        <div id='RecommendedTooltipTooltip'  style='display:none;visibility:visible' class='ToolTip'>\n-            <img src='images/icons/comment.png' alt='Tip' border='0' />\n-            <?php echo t('Tooltip','RecommendedTooltipTooltip') ?>\n-        </div>\n-        </li>\n-\n+        $input_descriptors0[] = array(\n+                                        \"name\" => \"RecommendedTable\",\n+                                        \"caption\" => t('all','RecommendedTable'),\n+                                        \"type\" => \"text\",\n+                                        \"datalist\" => $valid_tables,\n+                                        \"value\" => ((isset($table)) ? $table : \"\"),\n+                                        \"tooltipText\" => t('Tooltip','RecommendedTableTooltip'),\n+                                     );\n+        \n+        $input_descriptors0[] = array(\n+                                        \"name\" => \"RecommendedHelper\",\n+                                        \"caption\" => t('all','RecommendedHelper'),\n+                                        \"type\" => \"text\",\n+                                        \"datalist\" => $valid_recommendedHelpers,\n+                                        \"value\" => ((isset($helper)) ? $helper : \"\"),\n+                                        \"tooltipText\" => t('Tooltip','RecommendedHelperTooltip'),\n+                                     );\n+        \n+        $input_descriptors0[] = array(\n+                                        \"name\" => \"RecommendedTooltip\",\n+                                        \"caption\" => t('all','RecommendedTooltip'),\n+                                        \"type\" => \"textarea\",\n+                                        \"tooltipText\" => t('Tooltip','RecommendedTooltipTooltip'),\n+                                        \"value\" => (isset($tooltip) ? $tooltip : \"\")\n+                                     );\n+        \n+        $input_descriptors0[] = array(\n+                                        \"name\" => \"csrf_token\",\n+                                        \"type\" => \"hidden\",\n+                                        \"value\" => dalo_csrf_token(),\n+                                     );\n+\n+        $input_descriptors0[] = array(\n+                                        'type' => 'submit',\n+                                        'name' => 'submit',\n+                                        'value' => t('buttons','apply')\n+                                     );\n+\n+        open_form();\n+        \n+        open_fieldset($fieldset0_descriptor);\n+        \n+        foreach ($input_descriptors0 as $input_descriptor) {\n+            print_form_component($input_descriptor);\n+        }\n+        \n+        close_fieldset();\n+        \n+        close_form();\n+    }\n     \n-        <li class='fieldset'>\n-        <br/>\n-        <hr><br/>\n-        <input type='submit' name='submit' value='<?php echo t('buttons','apply') ?>' tabindex=10000 class='button' />\n-        </li>\n-\n-        </ul>\n-    </fieldset>\n-\n-    </form>\n-\n-<?php\n     include('include/config/logging.php');\n     print_footer_and_html_epilogue();\n+\n ?>"
        },
        {
          "filename": "mng-rad-attributes-search.php",
          "status": "modified",
          "additions": 4,
          "deletions": 4,
          "patch": "@@ -32,9 +32,9 @@\n     $logQuery = \"performed query for listing of records on page: \";\n     $logDebugSQL = \"\";\n \n-    // get vendor name passed to us from menu-mng-rad-attributes.php\n-    $attribute = (array_key_exists('attribute', $_GET) && isset($_GET['attribute']))\n-            ? str_replace(\"%\", \"\", $_GET['attribute']) : \"\";\n+    // get attribute name passed to us from menu-mng-rad-attributes.php\n+    $attribute = (array_key_exists('attribute', $_GET) && !empty(str_replace(\"%\", \"\", trim($_GET['attribute']))))\n+               ? str_replace(\"%\", \"\", trim($_GET['attribute'])) : \"\";\n \n     include_once(\"lang/main.php\");\n     \n@@ -81,7 +81,7 @@\n \n     $sql_WHERE = array();\n     $sql_WHERE[] = \"(type <> '' OR type IS NOT NULL)\";\n-    if (!empty($vendor)) {\n+    if (!empty($attribute)) {\n         $sql_WHERE[] = sprintf(\"attribute LIKE '%s%%'\", $dbSocket->escapeSimple($attribute));\n     }\n     "
        },
        {
          "filename": "mng-rad-groupcheck-new.php",
          "status": "modified",
          "additions": 3,
          "deletions": 6,
          "patch": "@@ -32,8 +32,9 @@\n     $logAction = \"\";\n     $logDebugSQL = \"\";\n \n-    // we import validation facilities\n-    include_once(\"library/validation.php\");\n+    include_once(\"lang/main.php\");\n+    include(\"library/validation.php\");\n+    include(\"library/layout.php\");\n \n     include_once('include/management/populate_selectbox.php');\n     \n@@ -79,10 +80,6 @@\n     }\n \n \n-    include_once(\"lang/main.php\");\n-    \n-    include(\"library/layout.php\");\n-\n     // print HTML prologue\n     $extra_js = array(\n         \"library/javascript/ajax.js\","
        },
        {
          "filename": "mng-rad-groupreply-new.php",
          "status": "modified",
          "additions": 3,
          "deletions": 6,
          "patch": "@@ -32,8 +32,9 @@\n     $logAction = \"\";\n     $logDebugSQL = \"\";\n \n-    // we import validation facilities\n-    include_once(\"library/validation.php\");\n+    include_once(\"lang/main.php\");\n+    include(\"library/validation.php\");\n+    include(\"library/layout.php\");\n \n     include_once('include/management/populate_selectbox.php');\n     \n@@ -79,10 +80,6 @@\n     }\n \n \n-    include_once(\"lang/main.php\");\n-    \n-    include(\"library/layout.php\");\n-\n     // print HTML prologue\n     $extra_js = array(\n         \"library/javascript/ajax.js\","
        },
        {
          "filename": "mng-rad-nas-new.php",
          "status": "modified",
          "additions": 3,
          "deletions": 6,
          "patch": "@@ -25,18 +25,16 @@\n     $operator = $_SESSION['operator_user'];\n \n     include('library/check_operator_perm.php');\n+    include_once('library/config_read.php');\n \n     // init logging variables\n     $log = \"visited page: \";\n     $logAction = \"\";\n     $logDebugSQL = \"\";\n \n-    include_once('library/config_read.php');\n-    \n     include_once(\"lang/main.php\");\n-    \n-    // we import validation facilities\n-    include_once(\"library/validation.php\");\n+    include(\"library/validation.php\");\n+    include(\"library/layout.php\");\n     \n     if ($_SERVER['REQUEST_METHOD'] === 'POST') {\n         $nasname = (array_key_exists('nasname', $_POST) && isset($_POST['nasname'])) ? trim(str_replace(\"%\", \"\", $_POST['nasname'])) : \"\";\n@@ -95,7 +93,6 @@\n \n     }\n \n-    include(\"library/layout.php\");\n \n     // print HTML prologue\n     $extra_css = array("
        },
        {
          "filename": "mng-rad-profiles-edit.php",
          "status": "modified",
          "additions": 3,
          "deletions": 5,
          "patch": "@@ -32,8 +32,9 @@\n     $logAction = \"\";\n     $logDebugSQL = \"\";\n \n-    // we import validation facilities\n-    include_once(\"library/validation.php\");\n+    include_once(\"lang/main.php\");\n+    include(\"library/validation.php\");\n+    include(\"library/layout.php\");\n \n     if ($_SERVER['REQUEST_METHOD'] === 'POST') {\n         $profile_name = (array_key_exists('profile_name', $_POST) && !empty($_POST['profile_name']) &&\n@@ -47,9 +48,6 @@\n     \n     $profile_name_enc = (!empty($profile_name)) ? htmlspecialchars($profile_name, ENT_QUOTES, 'UTF-8') : \"\";\n \n-    include_once(\"lang/main.php\");\n-    \n-    include(\"library/layout.php\");\n \n     // print HTML prologue\n     $extra_css = array("
        },
        {
          "filename": "mng-rad-profiles-new.php",
          "status": "modified",
          "additions": 4,
          "deletions": 6,
          "patch": "@@ -32,8 +32,9 @@\n     $logDebugSQL = \"\";\n     $log = \"visited page: \";\n \n-    // we import validation facilities\n-    include_once(\"library/validation.php\");\n+    include_once(\"lang/main.php\");\n+    include(\"library/validation.php\");\n+    include(\"library/layout.php\");\n \n     if ($_SERVER['REQUEST_METHOD'] === 'POST') {\n     \n@@ -75,10 +76,7 @@\n             \n         } // profile name not empty    \n     }\n-    \n-    include_once(\"lang/main.php\");\n-    \n-    include(\"library/layout.php\");\n+\n \n     // print HTML prologue\n     $extra_css = array("
        },
        {
          "filename": "mng-rad-usergroup-list-user.php",
          "status": "modified",
          "additions": 5,
          "deletions": 2,
          "patch": "@@ -156,11 +156,11 @@\n         <tbody>\n <?php\n         $li_style = 'margin: 7px auto';\n-        $counter = 1;\n+        $counter = 0;\n         while ($row = $res->fetchRow()) {\n             $rowlen = count($row);\n             \n-            echo '<tr>';\n+            printf('<tr id=\"row-%d\">', $counter);\n             \n             for ($i = 0; $i < $rowlen; $i++) {\n                 $row[$i] = htmlspecialchars($row[$i], ENT_QUOTES, 'UTF-8');\n@@ -201,6 +201,9 @@\n         printTableFoot($per_page_numrows, $numrows, $colspan, $drawNumberLinks, $links, $partial_query_string);\n ?>\n     </table>\n+    \n+    <input type=\"hidden\" name=\"csrf_token\" value=\"<?= dalo_csrf_token() ?>\">\n+    \n </form>\n \n <?php"
        },
        {
          "filename": "mng-rad-usergroup-list.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -196,7 +196,7 @@ function print_user_group_prio($this_username, $this_groupname, $this_priority)\n                 'groups' => array()\n             );\n             \n-            $sql1 = sprintf(\"SELECT groupname, priority FROM %s WHERE username='%s' ORDER BY priority DESC, groupname ASC\",\n+            $sql1 = sprintf(\"SELECT groupname, priority FROM %s WHERE username='%s' ORDER BY priority ASC, groupname ASC\",\n                             $configValues['CONFIG_DB_TBL_RADUSERGROUP'], $dbSocket->escapeSimple($this_username));\n             $res1 = $dbSocket->query($sql1);\n             "
        },
        {
          "filename": "mng-search.php",
          "status": "modified",
          "additions": 15,
          "deletions": 18,
          "patch": "@@ -28,24 +28,12 @@\n     include_once('library/config_read.php');\n     \n     include_once(\"lang/main.php\");\n-    \n     include(\"library/layout.php\");\n \n-    // print HTML prologue\n-    $extra_js = array(\n-        \"library/javascript/ajax.js\",\n-        \"library/javascript/ajaxGeneric.js\"\n-    );\n-    \n-    $title = t('Intro','mngsearch.php');\n-    \n-    print_html_prologue($title, $langCode, array(), $extra_js);\n-\n     // we partially strip some character and\n     // leave validation/escaping to other functions used later in the script\n-    $username = (array_key_exists('username', $_GET) && isset($_GET['username']))\n-              ? str_replace(\"%\", \"\", $_GET['username']) : \"\";\n-    \n+    $username = (array_key_exists('username', $_GET) && !empty(str_replace(\"%\", \"\", trim($_GET['username']))))\n+              ? str_replace(\"%\", \"\", trim($_GET['username'])) : \"\";\n     $username_enc = (!empty($username))\n                   ? htmlspecialchars($username, ENT_QUOTES, 'UTF-8')\n                   : \"\";\n@@ -63,6 +51,17 @@\n     //feed the sidebar variables\n     $search_username = $username_enc;\n \n+\n+    // print HTML prologue\n+    $extra_js = array(\n+        \"library/javascript/ajax.js\",\n+        \"library/javascript/ajaxGeneric.js\"\n+    );\n+    \n+    $title = t('Intro','mngsearch.php');\n+    \n+    print_html_prologue($title, $langCode, array(), $extra_js);\n+\n     if (!empty($username_enc)) {\n         $title .=  \" :: \" . $username_enc;\n     }\n@@ -91,12 +90,10 @@\n     $orderType = (array_key_exists('orderType', $_GET) && isset($_GET['orderType']) &&\n                   in_array(strtolower($_GET['orderType']), array( \"desc\", \"asc\" )))\n                ? strtolower($_GET['orderType']) : \"desc\";\n-?>\n \n-    <div id=\"contentnorightbar\">\n-\n-<?php\n+    echo '<div id=\"contentnorightbar\">';\n     print_title_and_help($title, $help);\n+    \n     include('library/opendb.php');\n     include('include/management/pages_common.php');\n "
        },
        {
          "filename": "msg-error-permissions.php",
          "status": "modified",
          "additions": 10,
          "deletions": 17,
          "patch": "@@ -24,34 +24,27 @@\n     include (\"library/checklogin.php\");\n     $operator = $_SESSION['operator_user'];\n \n+    $log = \"visited page: \";\n+\n     include_once(\"lang/main.php\");\n-    \n     include(\"library/layout.php\");\n \n+\n     // print HTML prologue\n     $title = t('Intro','msgerrorpermissions.php');\n     $help = t('helpPage','msgerrorpermissions');\n     \n     print_html_prologue($title, $langCode);\n \n     include(\"menu-home.php\");\n-?>\n \n-                <div id=\"contentnorightbar\">\n-<?php\n+    echo '<div id=\"contentnorightbar\">';\n     print_title_and_help($title, $help);\n+\n     $failureMsg = t('helpPage','msgerrorpermissions');\n-    include_once(\"include/management/actionMessages.php\");\n-?>\n-                </div><!-- #contentnorightbar -->\n-                        \n-                <div id=\"footer\">\n-<?php\n-    include('page-footer.php');\n-?>\n-                </div><!-- #footer -->\n-            </div>\n-        </div>\n-    </body>\n-</html>\n+    include_once('include/management/actionMessages.php');\n \n+    include('include/config/logging.php');\n+    print_footer_and_html_epilogue();\n+\n+?>"
        },
        {
          "filename": "rep-batch.php",
          "status": "modified",
          "additions": 11,
          "deletions": 33,
          "patch": "@@ -1,4 +1,4 @@\n-<?php\n+<?php \n /*\n  *********************************************************************************************************\n  * daloRADIUS - RADIUS Web Platform\n@@ -21,50 +21,28 @@\n  *********************************************************************************************************\n  */\n \n-    include(\"library/checklogin.php\");\n+    include (\"library/checklogin.php\");\n     $operator = $_SESSION['operator_user'];\n-        \n+\n     include_once('library/config_read.php');\n-    \n+    $log = \"visited page: \";\n+\n     include_once(\"lang/main.php\");\n     \n     include(\"library/layout.php\");\n \n-    // print HTML prologue   \n+    // print HTML prologue\n     $title = t('Intro','repbatch.php');\n+    $help = t('helpPage','repbatch');\n     \n     print_html_prologue($title, $langCode);\n \n     include(\"menu-reports-batch.php\");\n     \n-    $log = \"visited page: \";\n-?>\n-        <div id=\"contentnorightbar\">\n-            <h2 id=\"Intro\">\n-                <a href=\"#\" onclick=\"javascript:toggleShowDiv('helpPage')\">\n-                    <?= t('Intro','repbatch.php'); ?><h144>&#x2754;</h144>\n-                </a>\n-            </h2>\n-\n-            <div id=\"helpPage\" style=\"display:none;visibility:visible\"><?= t('helpPage','repbatch') ?><br></div>\n-            <br>\n-<?php\n+    echo '<div id=\"contentnorightbar\">';\n+    print_title_and_help($title, $help);\n+    \n     include('include/config/logging.php');\n-?>\n+    print_footer_and_html_epilogue();\n \n-        </div><!-- #contentnorightbar -->\n-        \n-        <div id=\"footer\">\n-        \n-<?php\n-    include('page-footer.php');\n ?>\n-\n-        \n-        </div><!-- #footer -->\n-    </div>\n-</div>\n-\n-\n-</body>\n-</html>"
        },
        {
          "filename": "rep-hb.php",
          "status": "modified",
          "additions": 8,
          "deletions": 20,
          "patch": "@@ -1,4 +1,4 @@\n-<?php\n+<?php \n /*\n  *********************************************************************************************************\n  * daloRADIUS - RADIUS Web Platform\n@@ -21,9 +21,9 @@\n  *********************************************************************************************************\n  */\n \n-    include(\"library/checklogin.php\");\n+    include (\"library/checklogin.php\");\n     $operator = $_SESSION['operator_user'];\n-        \n+\n     include_once('library/config_read.php');\n     $log = \"visited page: \";\n \n@@ -38,23 +38,11 @@\n     print_html_prologue($title, $langCode);\n \n     include(\"menu-reports-hb.php\");\n-\n-?>\n-        <div id=\"contentnorightbar\">\n-<?php\n+    \n+    echo '<div id=\"contentnorightbar\">';\n     print_title_and_help($title, $help);\n-?>\n-\n-        </div><!-- #contentnorightbar -->\n-        \n-        <div id=\"footer\">\n-<?php\n+    \n     include('include/config/logging.php');\n-    include('page-footer.php');\n-?>\n-        </div><!-- #footer -->\n-    </div>\n-</div>\n+    print_footer_and_html_epilogue();\n \n-</body>\n-</html>\n+?>"
        },
        {
          "filename": "rep-lastconnect.php",
          "status": "modified",
          "additions": 1,
          "deletions": 3,
          "patch": "@@ -33,7 +33,7 @@\n     $logDebugSQL = \"\";\n     \n     include_once(\"lang/main.php\");\n-    \n+    include(\"library/validation.php\");\n     include(\"library/layout.php\");\n \n     // print HTML prologue\n@@ -57,8 +57,6 @@\n         break;\n     }\n     \n-    include(\"library/validation.php\");\n-    \n     // in other cases we just check that syntax is ok\n     $startdate = (array_key_exists('startdate', $_GET) && isset($_GET['startdate']) &&\n                   preg_match(DATE_REGEX, $_GET['startdate'], $m) !== false &&"
        },
        {
          "filename": "rep-logs-boot.php",
          "status": "modified",
          "additions": 10,
          "deletions": 23,
          "patch": "@@ -25,6 +25,12 @@\n     $operator = $_SESSION['operator_user'];\n \n     include('library/check_operator_perm.php');\n+    include_once('library/config_read.php');\n+    \n+    $log = \"visited page: \";\n+\n+    include_once(\"lang/main.php\");\n+    include(\"library/layout.php\");\n \n     // parameter validation\n     $bootLineCount = (array_key_exists('bootLineCount', $_GET) && isset($_GET['bootLineCount']) &&\n@@ -35,12 +41,6 @@\n     $bootFilter = (array_key_exists('bootFilter', $_GET) && isset($_GET['bootFilter']))\n                 ? $_GET['bootFilter'] : \"\";\n \n-    include_once('library/config_read.php');\n-    $log = \"visited page: \";\n-\n-    include_once(\"lang/main.php\");\n-    \n-    include(\"library/layout.php\");\n \n     // print HTML prologue\n     $title = t('Intro','replogsboot.php') . \" :: $bootLineCount Lines Count\";\n@@ -52,27 +52,14 @@\n     print_html_prologue($title, $langCode);\n \n     include(\"menu-reports-logs.php\");\n-      \n-?>    \n-    <div id=\"contentnorightbar\">\n \n-<?php\n+    echo '<div id=\"contentnorightbar\">';\n     print_title_and_help($title, $help);\n \n     include('library/exten-boot_log.php');\n     include_once('include/management/actionMessages.php');\n-?>\n-         </div><!-- #contentnorightbar -->\n-        \n-        <div id=\"footer\">\n-<?php\n+    \n     include('include/config/logging.php');\n-    include('page-footer.php');\n-?>\n-        </div><!-- #footer -->\n-    </div>\n-</div>\n-\n-</body>\n-</html>\n+    print_footer_and_html_epilogue();\n \n+?>"
        },
        {
          "filename": "rep-logs-radius.php",
          "status": "modified",
          "additions": 11,
          "deletions": 22,
          "patch": "@@ -25,6 +25,12 @@\n     $operator = $_SESSION['operator_user'];\n \n     include('library/check_operator_perm.php');\n+    include_once('library/config_read.php');\n+    \n+    $log = \"visited page: \";\n+\n+    include_once(\"lang/main.php\");\n+    include(\"library/layout.php\");\n \n     // parameter validation\n     $radiusLineCount = (array_key_exists('radiusLineCount', $_GET) && isset($_GET['radiusLineCount']) &&\n@@ -37,13 +43,6 @@\n                   ? $_GET['radiusFilter'] : \"\";\n \n \n-    include_once('library/config_read.php');\n-    $log = \"visited page: \";\n-\n-    include_once(\"lang/main.php\");\n-    \n-    include(\"library/layout.php\");\n-\n     // print HTML prologue\n     $title = t('Intro','replogsradius.php') . \" :: $radiusLineCount Lines Count\";\n     if (!empty($radiusFilter) && $radiusFilter !== '.+') {\n@@ -55,23 +54,13 @@\n \n     include (\"menu-reports-logs.php\");\n \n-?>\n-    <div id=\"contentnorightbar\">\n-<?php\n+    echo '<div id=\"contentnorightbar\">';\n     print_title_and_help($title, $help);\n+    \n     include('library/exten-radius_log.php');\n     include_once('include/management/actionMessages.php');\n-?>\n-        </div><!-- #contentnorightbar -->\n-        \n-        <div id=\"footer\">\n-<?php\n+\n     include('include/config/logging.php');\n-    include('page-footer.php');\n-?>\n-        </div><!-- #footer -->\n-    </div>\n-</div>\n+    print_footer_and_html_epilogue();\n \n-</body>\n-</html>\n+?>"
        },
        {
          "filename": "rep-logs-system.php",
          "status": "modified",
          "additions": 11,
          "deletions": 21,
          "patch": "@@ -25,7 +25,13 @@\n     $operator = $_SESSION['operator_user'];\n \n     include('library/check_operator_perm.php');\n+    include_once('library/config_read.php');\n+\n+    $log = \"visited page: \";\n \n+    include_once(\"lang/main.php\");\n+    include(\"library/layout.php\");\n+    \n     // parameter validation\n     $systemLineCount = (array_key_exists('systemLineCount', $_GET) && isset($_GET['systemLineCount']) &&\n                         intval($_GET['systemLineCount']) > 0)\n@@ -35,13 +41,7 @@\n     $systemFilter = (array_key_exists('systemFilter', $_GET) && isset($_GET['systemFilter']))\n                   ? $_GET['systemFilter'] : \"\";\n \n-    include_once('library/config_read.php');\n-    $log = \"visited page: \";\n-\n-    include_once(\"lang/main.php\");\n     \n-    include(\"library/layout.php\");\n-\n     // print HTML prologue\n     $title = t('Intro','replogssystem.php') . \" :: $systemLineCount Lines Count\";\n     if (!empty($systemFilter) && $systemFilter !== '.+') {\n@@ -52,24 +52,14 @@\n     print_html_prologue($title, $langCode);\n \n     include (\"menu-reports-logs.php\");      \n-?>    \n-        <div id=\"contentnorightbar\">\n \n-<?php\n+    echo '<div id=\"contentnorightbar\">';\n     print_title_and_help($title, $help);\n+    \n     include('library/exten-syslog_log.php');\n     include_once('include/management/actionMessages.php');\n-?>\n-        </div><!-- #contentnorightbar -->\n-        \n-        <div id=\"footer\">\n-<?php\n+\n     include('include/config/logging.php');\n-    include('page-footer.php');\n-?>\n-        </div><!-- #footer -->\n-    </div>\n-</div>\n+    print_footer_and_html_epilogue();\n \n-</body>\n-</html>\n+?>"
        },
        {
          "filename": "rep-logs.php",
          "status": "modified",
          "additions": 4,
          "deletions": 14,
          "patch": "@@ -27,10 +27,10 @@\n     include_once('library/config_read.php');\n     $log = \"visited page: \";\n \n-    include_once(\"lang/main.php\");\n-    \n+    include_once(\"lang/main.php\");    \n     include(\"library/layout.php\");\n \n+\n     // print HTML prologue\n     $title = t('Intro','replogs.php');\n     $help = t('helpPage','replogs');\n@@ -41,18 +41,8 @@\n \n     echo '<div id=\"contentnorightbar\">';\n     print_title_and_help($title, $help);\n-?>\n \n-        </div><!-- #contentnorightbar -->\n-        \n-        <div id=\"footer\">\n-<?php\n     include('include/config/logging.php');\n-    include('page-footer.php');\n-?>\n-        </div><!-- #footer -->\n-    </div>\n-</div>\n+    print_footer_and_html_epilogue();\n \n-</body>\n-</html>\n+?>"
        },
        {
          "filename": "rep-main.php",
          "status": "modified",
          "additions": 10,
          "deletions": 26,
          "patch": "@@ -1,4 +1,4 @@\n-<?php\n+<?php \n /*\n  *********************************************************************************************************\n  * daloRADIUS - RADIUS Web Platform\n@@ -21,13 +21,12 @@\n  *********************************************************************************************************\n  */\n \n-    include(\"library/checklogin.php\");\n+    include (\"library/checklogin.php\");\n     $operator = $_SESSION['operator_user'];\n \n-    //~ include('library/check_operator_perm.php');\n-    \n     include_once('library/config_read.php');\n-    \n+    $log = \"visited page: \";\n+\n     include_once(\"lang/main.php\");\n     \n     include(\"library/layout.php\");\n@@ -37,28 +36,13 @@\n     $help = t('helpPage','repmain');\n     \n     print_html_prologue($title, $langCode);\n-    \n-    include(\"menu-reports.php\");\n \n-?>\n-        \n-        <div id=\"contentnorightbar\">\n-<?php\n+    include(\"menu-reports.php\");\n+    \n+    echo '<div id=\"contentnorightbar\">';\n     print_title_and_help($title, $help);\n-?>\n-        \n-        </div><!-- #contentnorightbar -->\n-        \n-        <div id=\"footer\">\n-<?php\n-    $log = \"visited page: \";\n-\n+    \n     include('include/config/logging.php');\n-    include('page-footer.php');\n-?>\n-        </div><!-- #footer -->\n-    </div>\n-</div>\n+    print_footer_and_html_epilogue();\n \n-</body>\n-</html>\n+?>"
        },
        {
          "filename": "rep-newusers.php",
          "status": "modified",
          "additions": 2,
          "deletions": 3,
          "patch": "@@ -28,7 +28,9 @@\n     include('library/check_operator_perm.php');\n     include_once('library/config_read.php');\n     \n+    include_once(\"lang/main.php\");\n     include(\"library/validation.php\");\n+    include(\"library/layout.php\");\n \n     // we validate starting and ending dates\n     $startdate = (array_key_exists('startdate', $_GET) && isset($_GET['startdate']) &&\n@@ -52,9 +54,6 @@\n     }\n     $logQuery .= \"on page: \";\n \n-    include_once(\"lang/main.php\");\n-    \n-    include(\"library/layout.php\");\n \n     // print HTML prologue\n     $extra_css = array("
        },
        {
          "filename": "rep-stat-server.php",
          "status": "modified",
          "additions": 6,
          "deletions": 18,
          "patch": "@@ -25,12 +25,11 @@\n     $operator = $_SESSION['operator_user'];\n \n     include('library/check_operator_perm.php');\n-\n     include_once('library/config_read.php');\n+    \n     $log = \"visited page: \";\n \n     include_once(\"lang/main.php\");\n-    \n     include(\"library/layout.php\");\n \n     // print HTML prologue\n@@ -41,23 +40,12 @@\n \n     include(\"menu-reports-status.php\");\n     \n-?>    \n-        <div id=\"contentnorightbar\">\n-<?php\n+    echo '<div id=\"contentnorightbar\">';\n     print_title_and_help($title, $help);\n+    \n     include('library/exten-server_info.php');\n-?>\n-\n-        </div><!-- #contentnorightbar -->\n-        \n-        <div id=\"footer\">\n-<?php\n+    \n     include('include/config/logging.php');\n-    include('page-footer.php');\n-?>\n-        </div><!-- #footer -->\n-    </div>\n-</div>\n+    print_footer_and_html_epilogue();\n \n-</body>\n-</html>\n+?>"
        },
        {
          "filename": "rep-stat-services.php",
          "status": "modified",
          "additions": 7,
          "deletions": 22,
          "patch": "@@ -25,13 +25,11 @@\n     $operator = $_SESSION['operator_user'];\n \n     include('library/check_operator_perm.php');\n-\n     include_once('library/config_read.php');\n+    \n     $log = \"visited page: \";\n-    include('include/config/logging.php');\n-\n-    include_once(\"lang/main.php\");\n     \n+    include_once(\"lang/main.php\");\n     include(\"library/layout.php\");\n \n     // print HTML prologue\n@@ -42,25 +40,12 @@\n \n     include(\"menu-reports-status.php\");\n       \n-?>    \n-        <div id=\"contentnorightbar\">\n-\n-<?php\n+    echo '<div id=\"contentnorightbar\">';\n     print_title_and_help($title, $help);\n+    \n     include('library/exten-radius_server_info.php');\n-?>\n+    \n+    include('include/config/logging.php');\n+    print_footer_and_html_epilogue();\n \n-        </div><!-- #contentnorightbar -->\n-        \n-        <div id=\"footer\">        \n-<?php\n-        include('page-footer.php');\n ?>\n-\n-        </div><!-- #footer -->\n-    </div>\n-</div>\n-\n-\n-</body>\n-</html>"
        },
        {
          "filename": "rep-stat-ups.php",
          "status": "modified",
          "additions": 8,
          "deletions": 21,
          "patch": "@@ -25,28 +25,24 @@\n     $operator = $_SESSION['operator_user'];\n \n     include('library/check_operator_perm.php');\n-\n     include_once('library/config_read.php');\n+    \n     $log = \"visited page: \";\n     $logQuery = \"performed query on page: \";\n-    include('include/config/logging.php');\n-\n-    include_once(\"lang/main.php\");\n     \n+    include_once(\"lang/main.php\");\n     include(\"library/layout.php\");\n \n+\n     // print HTML prologue\n     $title = \"UPS Status\";\n     $help = \"\";\n     \n     print_html_prologue($title, $langCode);\n \n     include(\"menu-reports-status.php\");\n-      \n-?>\n-        <div id=\"contentnorightbar\">\n-<?php\n \n+    echo '<div id=\"contentnorightbar\">';\n     print_title_and_help($title, $help);\n \n     exec(\"which apcaccess || command -v apcaccess\", $output, $retStatus);\n@@ -83,17 +79,8 @@\n     if (!empty($failureMsg)) {\n         include_once('include/management/actionMessages.php');\n     }\n-?>\n-        </div>\n-        \n-        <div id=\"footer\">\n-<?php\n-    include('page-footer.php');\n-?>\n-        </div>\n-        \n-    </div>\n-</div>\n \n-</body>\n-</html>\n+    include('include/config/logging.php');\n+    print_footer_and_html_epilogue();\n+\n+?>"
        },
        {
          "filename": "rep-status.php",
          "status": "modified",
          "additions": 13,
          "deletions": 27,
          "patch": "@@ -1,4 +1,4 @@\n-<?php\n+<?php \n /*\n  *********************************************************************************************************\n  * daloRADIUS - RADIUS Web Platform\n@@ -14,20 +14,20 @@\n  * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.\n  *\n  *********************************************************************************************************\n-*\n- * Authors:\tLiran Tal <liran@enginx.com>\n+ *\n+ * Authors:    Liran Tal <liran@enginx.com>\n+ *             Filippo Lauria <filippo.lauria@iit.cnr.it>\n  *\n  *********************************************************************************************************\n  */\n \n-    include(\"library/checklogin.php\");\n+    include (\"library/checklogin.php\");\n     $operator = $_SESSION['operator_user'];\n-        \n-\tinclude_once('library/config_read.php');\n+\n+    include_once('library/config_read.php');\n     $log = \"visited page: \";\n-    \n+\n     include_once(\"lang/main.php\");\n-    \n     include(\"library/layout.php\");\n \n     // print HTML prologue\n@@ -37,24 +37,10 @@\n     print_html_prologue($title, $langCode);\n \n     include(\"menu-reports-status.php\");\n-\n-?>\n-\t\t<div id=\"contentnorightbar\">\n-<?php\n+    \n+    echo '<div id=\"contentnorightbar\">';\n     print_title_and_help($title, $help);\n+    \n+    include('include/config/logging.php');\n+    print_footer_and_html_epilogue();\n ?>\n-\t\t\n-        </div><!-- #contentnorightbar -->\n-        \n-        <div id=\"footer\">\n-<?php\n-    include_once('include/config/logging.php');\n-    include('page-footer.php');\n-?>\n-\n-        </div><!-- #footer -->\n-    </div>\n-</div>\n-\n-</body>\n-</html>"
        },
        {
          "filename": "rep-topusers.php",
          "status": "modified",
          "additions": 2,
          "deletions": 3,
          "patch": "@@ -27,7 +27,9 @@\n     include('library/check_operator_perm.php');\n     include_once('library/config_read.php');\n     \n+    include_once(\"lang/main.php\");\n     include(\"library/validation.php\");\n+    include(\"library/layout.php\");\n     \n     $limit = (array_key_exists('limit', $_GET) && isset($_GET['limit']) && intval($_GET['limit']) > 0)\n            ? intval($_GET['limit']) : \"\";\n@@ -48,9 +50,6 @@\n               ? str_replace(\"%\", \"\", trim($_GET['username'])) : \"\";\n     $username_enc = (!empty($username)) ? htmlspecialchars($username, ENT_QUOTES, 'UTF-8') : \"\";\n     \n-    include_once(\"lang/main.php\");\n-    \n-    include(\"library/layout.php\");\n \n     // print HTML prologue\n     $title = t('Intro','reptopusers.php');"
        },
        {
          "filename": "rep-username.php",
          "status": "modified",
          "additions": 13,
          "deletions": 13,
          "patch": "@@ -25,27 +25,27 @@\n     $operator = $_SESSION['operator_user'];\n \n     //~ include('library/check_operator_perm.php');\n+    include_once('library/config_read.php');\n+    \n+    include_once(\"lang/main.php\");\n+    include(\"library/validation.php\");\n+    include(\"library/layout.php\");\n \n     // validate this parameter before including menu\n-    $username = (array_key_exists('username', $_GET) && isset($_GET['username']))\n-                    ? str_replace(\"%\", \"\", $_GET['username']) : \"\";\n+    $username = (array_key_exists('username', $_GET) && !empty(str_replace(\"%\", \"\", trim($_GET['username']))))\n+              ? str_replace(\"%\", \"\", trim($_GET['username'])) : \"\";\n     $username_enc = (!empty($username)) ? htmlspecialchars($username, ENT_QUOTES, 'UTF-8') : \"\";\n     \n     $log = \"visited page: \";\n-    $logQuery = \"performed query for [$username\";\n-    if (!empty($limit)) {\n-        $logQuery .= \" : $limit\";\n+    $logQuery = \"performed query for \";\n+    if (!empty($username)) {\n+         $logQuery .= \"username(s) starting with [$username] \";\n+    } else {\n+        $logQuery .= \"all usernames \";\n     }\n-    $logQuery .= \"] on page: \";\n-\n-    include_once('library/config_read.php');\n-    \n-    include(\"library/validation.php\");\n+    $logQuery .= \"on page: \";\n \n-    include_once(\"lang/main.php\");\n     \n-    include(\"library/layout.php\");\n-\n     // print HTML prologue\n     $title = t('Intro','repusername.php');\n     $help = t('helpPage','repusername') . \" \" . $username_enc;"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 3,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 3,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "cda8c51659e296beeb56d69dea2f0fe978335f44",
            "date": "2025-01-03T15:57:00Z",
            "author_login": "dot-mike"
          },
          {
            "sha": "d9fb2eb77a340338e9307d2bfc436656797ad10e",
            "date": "2024-12-05T05:44:31Z",
            "author_login": "jahknem"
          },
          {
            "sha": "37e0dbbaa6831c6ea8c2d7aec75882f9fc263dec",
            "date": "2024-11-27T09:28:27Z",
            "author_login": "dpkrane"
          },
          {
            "sha": "5b99b4bcdd6f53864c1653d2d6cba45a9e9c4740",
            "date": "2024-11-24T11:47:00Z",
            "author_login": "parsa97"
          },
          {
            "sha": "30988bf24ac713039073a45526c97601fc5af238",
            "date": "2024-10-29T14:22:40Z",
            "author_login": "aweher"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 5.3,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:N",
    "cwe_id": "CWE-1004",
    "description": "Sensitive Cookie Without 'HttpOnly' Flag in GitHub repository lirantal/daloradius prior to master.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2022-12-21T18:15:09.157",
    "last_modified": "2024-11-21T07:35:37.843",
    "fix_date": "2022-12-16T13:45:00Z"
  },
  "references": [
    {
      "url": "https://github.com/lirantal/daloradius/commit/6878619dc661b3009429777a1aeeb383ddc0166b",
      "source": "security@huntr.dev",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/401661ee-40e6-4ee3-a925-3716b96ece5c",
      "source": "security@huntr.dev",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/lirantal/daloradius/commit/6878619dc661b3009429777a1aeeb383ddc0166b",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/401661ee-40e6-4ee3-a925-3716b96ece5c",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:04:23.192177",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "daloradius",
    "owner": "lirantal",
    "created_at": "2015-05-02T09:06:40Z",
    "updated_at": "2025-01-13T13:09:54Z",
    "pushed_at": "2025-01-03T15:57:00Z",
    "size": 26603,
    "stars": 707,
    "forks": 350,
    "open_issues": 68,
    "watchers": 707,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "PHP": 9561369,
      "HTML": 976444,
      "JavaScript": 234162,
      "Shell": 65413,
      "CSS": 47766,
      "Hack": 4356,
      "Dockerfile": 2182
    },
    "commit_activity": {
      "total_commits_last_year": 29,
      "avg_commits_per_week": 0.5576923076923077,
      "days_active_last_year": 24
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "gpl-2.0"
    },
    "collected_at": "2025-01-14T13:25:23.249627"
  }
}