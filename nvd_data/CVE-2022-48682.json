{
  "cve_id": "CVE-2022-48682",
  "github_data": {
    "repository": "adrianlopezroche/fdupes",
    "fix_commit": "85680897148f1ac33b55418e00334116e419717f",
    "related_commits": [
      "85680897148f1ac33b55418e00334116e419717f",
      "85680897148f1ac33b55418e00334116e419717f"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "85680897148f1ac33b55418e00334116e419717f",
      "commit_date": "2022-08-16T18:39:18Z",
      "author": {
        "login": "adrianlopezroche",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Call stat() before deleting any file to ensure it's still the same file.",
        "length": 72,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 67,
        "additions": 62,
        "deletions": 5
      },
      "files": [
        {
          "filename": "Makefile.am",
          "status": "modified",
          "additions": 4,
          "deletions": 0,
          "patch": "@@ -17,6 +17,8 @@ fdupes_SOURCES = fdupes.c\\\n  flags.h\\\n  confirmmatch.c\\\n  confirmmatch.h\\\n+ removeifnotchanged.c\\\n+ removeifnotchanged.h\\\n  mbstowcs_escape_invalid.c\\\n  mbstowcs_escape_invalid.h\\\n  md5/md5.c\\\n@@ -59,6 +61,8 @@ fdupes_SOURCES = fdupes.c\\\n  flags.h\\\n  confirmmatch.c\\\n  confirmmatch.h\\\n+ removeifnotchanged.c\\\n+ removeifnotchanged.h\\\n  mbstowcs_escape_invalid.c\\\n  mbstowcs_escape_invalid.h\\\n  positive_wcwidth.c\\"
        },
        {
          "filename": "fdupes.c",
          "status": "modified",
          "additions": 7,
          "deletions": 4,
          "patch": "@@ -49,6 +49,7 @@\n #include \"log.h\"\n #include \"sigint.h\"\n #include \"flags.h\"\n+#include \"removeifnotchanged.h\"\n \n long long minsize = -1;\n long long maxsize = -1;\n@@ -804,6 +805,7 @@ void deletefiles(file_t *files, int prompt, FILE *tty, char *logfile)\n   FILE *file1;\n   FILE *file2;\n   int ismatch;\n+  char *errorstring;\n \n   curfile = files;\n   \n@@ -1005,15 +1007,15 @@ void deletefiles(file_t *files, int prompt, FILE *tty, char *logfile)\n     }\n \n     if (ismatch) {\n-      if (remove(dupelist[x]->d_name) == 0) {\n+      if (removeifnotchanged(dupelist[x], &errorstring) == 0) {\n         printf(\"   [-] %s\\n\", dupelist[x]->d_name);\n \n         if (loginfo)\n           log_file_deleted(loginfo, dupelist[x]->d_name);\n       }\n       else {\n         printf(\"   [!] %s \", dupelist[x]->d_name);\n-        printf(\"-- unable to delete file!\\n\");\n+        printf(\"-- unable to delete file: %s!\\n\", errorstring);\n \n         if (loginfo)\n           log_file_remaining(loginfo, dupelist[x]->d_name);\n@@ -1130,6 +1132,7 @@ void deletesuccessor(file_t **existing, file_t *duplicate, int matchconfirmed,\n {\n   file_t *to_keep;\n   file_t *to_delete;\n+  char *errorstring;\n \n   if (comparef(duplicate, *existing) >= 0)\n   {\n@@ -1156,14 +1159,14 @@ void deletesuccessor(file_t **existing, file_t *duplicate, int matchconfirmed,\n \n   if (matchconfirmed)\n   {\n-    if (remove(to_delete->d_name) == 0) {\n+    if (removeifnotchanged(to_delete, &errorstring) == 0) {\n       printf(\"   [-] %s\\n\", to_delete->d_name);\n \n       if (loginfo)\n         log_file_deleted(loginfo, to_delete->d_name);\n     } else {\n       printf(\"   [!] %s \", to_delete->d_name);\n-      printf(\"-- unable to delete file!\\n\");\n+      printf(\"-- unable to delete file: %s!\\n\", errorstring);\n \n       if (loginfo)\n         log_file_remaining(loginfo, to_delete->d_name);"
        },
        {
          "filename": "ncurses-commands.c",
          "status": "modified",
          "additions": 2,
          "deletions": 1,
          "patch": "@@ -29,6 +29,7 @@\n #include \"wcs.h\"\n #include \"mbstowcs_escape_invalid.h\"\n #include \"log.h\"\n+#include \"removeifnotchanged.h\"\n #include <wchar.h>\n #include <pcre2.h>\n \n@@ -780,7 +781,7 @@ int cmd_prune(struct filegroup *groups, int groupcount, wchar_t *commandargument\n             ismatch = 1;\n           }\n \n-          if (ismatch && remove(groups[g].files[f].file->d_name) == 0)\n+          if (ismatch && removeifnotchanged(groups[g].files[f].file, 0) == 0)\n           {\n             set_file_action(&groups[g].files[f], FILEACTION_DELIST, deletiontally);\n "
        },
        {
          "filename": "removeifnotchanged.c",
          "status": "added",
          "additions": 41,
          "deletions": 0,
          "patch": "@@ -0,0 +1,41 @@\n+#include \"removeifnotchanged.h\"\n+#include <errno.h>\n+#include <string.h>\n+#include <stdio.h>\n+\n+int removeifnotchanged(const file_t *file, char **errorstring)\n+{\n+  int result;\n+  struct stat st;\n+\n+  static char *filechanged = \"File contents changed during processing\";\n+  static char *unknownerror = \"Unknown error\";\n+\n+  stat(file->d_name, &st);\n+\n+  if (file->device != st.st_dev ||\n+      file->inode != st.st_ino ||\n+      file->ctime != st.st_ctime ||\n+      file->mtime != st.st_mtime ||\n+      file->size != st.st_size)\n+  {\n+    if (errorstring != 0)\n+        *errorstring = filechanged;\n+\n+    return -2;\n+  }\n+  else\n+  {\n+    result = remove(file->d_name);\n+\n+    if (result != 0 && errorstring != 0)\n+    {\n+      *errorstring = strerror(errno);\n+\n+      if (*errorstring == 0)\n+        *errorstring = unknownerror;\n+    }\n+\n+    return result;\n+  }\n+}"
        },
        {
          "filename": "removeifnotchanged.h",
          "status": "added",
          "additions": 8,
          "deletions": 0,
          "patch": "@@ -0,0 +1,8 @@\n+#ifndef REMOVEIFNOTCHANGED_H\n+#define REMOVEIFNOTCHANGED_H\n+\n+#include \"fdupes.h\"\n+\n+int removeifnotchanged(const file_t *file, char **errorstring);\n+\n+#endif\n\\ No newline at end of file"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 1,
        "max_directory_depth": 0
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "482509f9958274303b3e7e95ec3ac8f9469b4d79",
            "date": "2024-07-15T00:20:12Z",
            "author_login": "adrianlopezroche"
          },
          {
            "sha": "e7be34eed3857f848e9e4f55d865c5003a2fc9bd",
            "date": "2024-07-15T00:13:05Z",
            "author_login": "adrianlopezroche"
          },
          {
            "sha": "83b005c7ccb73e29f6b94b3f474d6cc98104941b",
            "date": "2024-07-14T23:43:14Z",
            "author_login": "adrianlopezroche"
          },
          {
            "sha": "e4ab227ec2ed80e48f8e44682d490d30ed968292",
            "date": "2024-07-14T20:54:19Z",
            "author_login": "adrianlopezroche"
          },
          {
            "sha": "93e68bcb3bc5357a4908b1d9eb703ff5e9c54b48",
            "date": "2024-06-18T23:01:28Z",
            "author_login": "adrianlopezroche"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.0,
    "cvss_vector": "CVSS:3.1/AV:L/AC:H/PR:L/UI:R/S:U/C:N/I:H/A:H",
    "cwe_id": "CWE-367",
    "description": "In deletefiles in FDUPES before 2.2.0, a TOCTOU race condition allows arbitrary file deletion via a symlink.",
    "attack_vector": "LOCAL",
    "attack_complexity": "HIGH"
  },
  "temporal_data": {
    "published_date": "2024-04-26T01:15:45.900",
    "last_modified": "2024-11-21T07:33:45.687",
    "fix_date": "2022-08-16T18:39:18Z"
  },
  "references": [
    {
      "url": "https://bugzilla.suse.com/show_bug.cgi?id=1200381",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "https://github.com/adrianlopezroche/fdupes/blob/4b6bcde1b3eb1cebe87cd30814f7d6cf4ee46e95/fdupes.c",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "https://github.com/adrianlopezroche/fdupes/commit/85680897148f1ac33b55418e00334116e419717f",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "https://github.com/adrianlopezroche/fdupes/compare/v2.1.2...v2.2.0",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "https://bugzilla.suse.com/show_bug.cgi?id=1200381",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://github.com/adrianlopezroche/fdupes/blob/4b6bcde1b3eb1cebe87cd30814f7d6cf4ee46e95/fdupes.c",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://github.com/adrianlopezroche/fdupes/commit/85680897148f1ac33b55418e00334116e419717f",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://github.com/adrianlopezroche/fdupes/compare/v2.1.2...v2.2.0",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:08:07.025073",
    "processing_status": "enhanced"
  }
}