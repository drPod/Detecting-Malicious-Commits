{
  "cve_id": "CVE-2023-0046",
  "github_data": {
    "repository": "lirantal/daloradius",
    "fix_commit": "2013c2d1231e99dac918247b69b198ded1f30a1c",
    "related_commits": [
      "2013c2d1231e99dac918247b69b198ded1f30a1c",
      "2013c2d1231e99dac918247b69b198ded1f30a1c"
    ],
    "patch_url": "https://github.com/lirantal/daloradius/commit/2013c2d1231e99dac918247b69b198ded1f30a1c.patch",
    "fix_commit_details": {
      "sha": "2013c2d1231e99dac918247b69b198ded1f30a1c",
      "commit_date": "2023-01-04T10:43:01Z",
      "author": {
        "login": "filippolauria",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Better validating log filepath (#326)",
        "length": 37,
        "has_description": false,
        "references_issue": true
      },
      "stats": {
        "total": 192,
        "additions": 123,
        "deletions": 69
      },
      "files": [
        {
          "filename": "config-backup.php",
          "status": "modified",
          "additions": 3,
          "deletions": 13,
          "patch": "@@ -41,18 +41,8 @@\n \n     echo '<div id=\"contentnorightbar\">';\n     print_title_and_help($title, $help);\n-?>\n-\n-        </div><!-- #contentnorightbar -->\n-        \n-        <div id=\"footer\">\n-<?php\n+    \n     include('include/config/logging.php');\n-    include('page-footer.php');\n+    \n+    print_footer_and_html_epilogue();\n ?>\n-        </div><!-- #footer -->\n-    </div>\n-</div>\n-\n-</body>\n-</html>"
        },
        {
          "filename": "config-logging.php",
          "status": "modified",
          "additions": 120,
          "deletions": 56,
          "patch": "@@ -24,10 +24,17 @@\n     include (\"library/checklogin.php\");\n     $operator = $_SESSION['operator_user'];\n \n+    include('library/check_operator_perm.php');\n     include_once('library/config_read.php');\n+    \n+    // init logging variables\n     $log = \"visited page: \";\n-\n+    $logAction = \"\";\n+    $logDebugSQL = \"\";\n+    \n     include_once(\"lang/main.php\");\n+    include(\"library/validation.php\");\n+    include(\"library/layout.php\");\n \n     $param_label = array(\n                             'CONFIG_LOG_PAGES' => t('all','PagesLogging'),\n@@ -37,25 +44,69 @@\n                             'CONFIG_DEBUG_SQL_ONPAGE' => t('all','LoggingDebugOnPages')\n                         );\n \n-    // if the form has been submitted we validate and store the configuration\n-    if (array_key_exists('submit', $_POST) && isset($_POST['submit'])) {\n-        \n-        foreach ($param_label as $param => $label) {\n-            if (array_key_exists($param, $_POST) && isset($_POST[$param]) &&\n-                in_array(strtolower($_POST[$param]), array(\"yes\", \"no\"))) {\n-                $configValues[$param] = $_POST[$param];\n+    if ($_SERVER['REQUEST_METHOD'] === 'POST') {\n+        if (array_key_exists('csrf_token', $_POST) && isset($_POST['csrf_token']) && dalo_check_csrf_token($_POST['csrf_token'])) {\n+            \n+            $isError = false;\n+            \n+            // validate yes/no params\n+            foreach ($param_label as $param => $label) {\n+                if (array_key_exists($param, $_POST) && !empty(strtolower(trim($_POST[$param]))) &&\n+                    in_array(strtolower(trim($_POST[$param])), array(\"yes\", \"no\"))) {\n+                    $configValues[$param] = $_POST[$param];\n+                }\n             }\n+            \n+            // validate path\n+            $log_path_prefix = $configValues['CONFIG_PATH_DALO_VARIABLE_DATA'] . \"/log\";\n+            $log_file_suffix = \".log\";\n+            \n+            if (array_key_exists('CONFIG_LOG_FILE', $_POST) && !empty(trim($_POST['CONFIG_LOG_FILE']))) {\n+                $candidate_log_file = trim($_POST['CONFIG_LOG_FILE']);\n+                \n+                if (\n+                        // this ensure that the log_path_prefix is a directory\n+                        is_dir($log_path_prefix) &&\n+\n+                        // this ensures that candidate_log_file starts with the log_path_prefix\n+                        substr($candidate_log_file, 0, strlen($log_path_prefix)) === $log_path_prefix &&\n+                        \n+                        // this ensures that candidate_log_file does not contain \"..\"\n+                        strpos($candidate_log_file, \"..\") === false &&\n+                        \n+                        // this ensures that candidate_log_file ends with the log_file_suffix\n+                        substr($candidate_log_file, -strlen($log_file_suffix)) === $log_file_suffix &&\n+                        \n+                        // this ensures that candidate_log_file is at a writable location\n+                        // or that at least it can be written inside the parent directory\n+                        (is_writable($candidate_log_file) || is_writable(dirname($candidate_log_file)))\n+                    ) {\n+                    \n+                    $configValues['CONFIG_LOG_FILE'] = $candidate_log_file;\n+                    \n+                } else {\n+                    $isError = true;\n+                }\n+            } else {\n+                $isError = true;\n+            }\n+            \n+            // we write ONLY IF isError is false\n+            if (!$isError) {\n+                include(\"library/config_write.php\");\n+            } else {\n+                $failureMsg = sprintf(\"Log path not allowed. Ensure that log file name locates a writable %s file contained in %s\",\n+                                      $log_file_suffix, $log_path_prefix);\n+                $logAction .= \"$failureMsg on page: \";\n+            }\n+            \n+        } else {\n+            // csrf\n+            $failureMsg = \"CSRF token error\";\n+            $logAction .= \"$failureMsg on page: \";\n         }\n-\n-        if (array_key_exists('CONFIG_LOG_FILE', $_POST) && isset($_POST['CONFIG_LOG_FILE']) &&\n-            is_writable($_POST['CONFIG_LOG_FILE'])) {\n-            $configValues['CONFIG_LOG_FILE'] = $_POST['CONFIG_LOG_FILE'];\n-        }\n-\n-        include(\"library/config_write.php\");\n-    }    \n-\n-    include(\"library/layout.php\");\n+    }\n+        \n \n     // print HTML prologue\n     $title = t('Intro','configlogging.php');\n@@ -69,45 +120,58 @@\n     print_title_and_help($title, $help);\n \n     include_once('include/management/actionMessages.php');\n-\n-?>\n-\n-<form name=\"loggingsettings\" method=\"POST\">\n-    <fieldset>\n-        <h302><?= t('title','Settings'); ?></h302>\n-        <br>\n-        \n-        <ul>\n-<?php\n+    \n+    $fieldset0_descriptor = array(\n+                                    \"title\" => t('title','Settings')\n+                                 );\n+    \n+    \n+    $input_descriptors0 = array();\n+    \n     foreach ($param_label as $name => $label) {\n-        print_select_as_list_elem($name, $label, array(\"no\", \"yes\"), $configValues[$name]);\n+        $input_descriptors0[] = array(\n+                                        \"type\" => \"select\",\n+                                        \"options\" => array( \"yes\", \"no\" ),\n+                                        \"caption\" => $label,\n+                                        \"name\" => $name,\n+                                        \"selected_value\" => $configValues[$name]\n+                                     );\n     }\n-?>\n-\n-            <li class=\"fieldset\">\n-                <label for=\"CONFIG_LOG_FILE\" class=\"form\"><?= t('all','FilenameLogging') ?></label>\n-                <input value=\"<?= $configValues['CONFIG_LOG_FILE'] ?>\" name=\"CONFIG_LOG_FILE\" id=\"CONFIG_LOG_FILE\">\n-            </li>\n-\n-\n-            <li class=\"fieldset\">\n-                <br/><hr><br/>\n-                <input type=\"submit\" name=\"submit\" value=\"<?= t('buttons','apply') ?>\" class=\"button\">\n-            </li>\n-        </ul>\n-    </fieldset>\n-</form>\n-\n-        </div><!-- #contentnorightbar -->\n-        \n-        <div id=\"footer\">\n-<?php\n+    \n+    $input_descriptors0[] = array(\n+                                        \"type\" => \"text\",\n+                                        \"caption\" => t('all','FilenameLogging'),\n+                                        \"name\" => 'CONFIG_LOG_FILE',\n+                                        \"value\" => $configValues['CONFIG_LOG_FILE']\n+                                     );\n+    \n+    $input_descriptors0[] = array(\n+                                    \"name\" => \"csrf_token\",\n+                                    \"type\" => \"hidden\",\n+                                    \"value\" => dalo_csrf_token(),\n+                                 );\n+\n+    $input_descriptors0[] = array(\n+                                    'type' => 'submit',\n+                                    'name' => 'submit',\n+                                    'value' => t('buttons','apply')\n+                                 );\n+    \n+    open_form();\n+    \n+    // open 0-th fieldset\n+    open_fieldset($fieldset0_descriptor);\n+    \n+    foreach ($input_descriptors0 as $input_descriptor) {\n+        print_form_component($input_descriptor);\n+    }\n+    \n+    close_fieldset();\n+    \n+    close_form();\n+    \n     include('include/config/logging.php');\n-    include('page-footer.php');\n-?>\n-        </div><!-- #footer -->\n-    </div>\n-</div>\n+    \n+    print_footer_and_html_epilogue();\n \n-</body>\n-</html>\n+?>"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 2,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 1,
        "max_directory_depth": 0
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "cda8c51659e296beeb56d69dea2f0fe978335f44",
            "date": "2025-01-03T15:57:00Z",
            "author_login": "dot-mike"
          },
          {
            "sha": "d9fb2eb77a340338e9307d2bfc436656797ad10e",
            "date": "2024-12-05T05:44:31Z",
            "author_login": "jahknem"
          },
          {
            "sha": "37e0dbbaa6831c6ea8c2d7aec75882f9fc263dec",
            "date": "2024-11-27T09:28:27Z",
            "author_login": "dpkrane"
          },
          {
            "sha": "5b99b4bcdd6f53864c1653d2d6cba45a9e9c4740",
            "date": "2024-11-24T11:47:00Z",
            "author_login": "parsa97"
          },
          {
            "sha": "30988bf24ac713039073a45526c97601fc5af238",
            "date": "2024-10-29T14:22:40Z",
            "author_login": "aweher"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 7.2,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H",
    "cwe_id": "CWE-641",
    "description": "Improper Restriction of Names for Files and Other Resources in GitHub repository lirantal/daloradius prior to master-branch.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-01-04T12:15:08.613",
    "last_modified": "2024-11-21T07:36:27.290",
    "fix_date": "2023-01-04T10:43:01Z"
  },
  "references": [
    {
      "url": "https://github.com/lirantal/daloradius/commit/2013c2d1231e99dac918247b69b198ded1f30a1c",
      "source": "security@huntr.dev",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/2214dc41-f283-4342-95b1-34a2f4fea943",
      "source": "security@huntr.dev",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/lirantal/daloradius/commit/2013c2d1231e99dac918247b69b198ded1f30a1c",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/2214dc41-f283-4342-95b1-34a2f4fea943",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:04:23.250711",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "daloradius",
    "owner": "lirantal",
    "created_at": "2015-05-02T09:06:40Z",
    "updated_at": "2025-01-13T13:09:54Z",
    "pushed_at": "2025-01-03T15:57:00Z",
    "size": 26603,
    "stars": 707,
    "forks": 350,
    "open_issues": 68,
    "watchers": 707,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "PHP": 9561369,
      "HTML": 976444,
      "JavaScript": 234162,
      "Shell": 65413,
      "CSS": 47766,
      "Hack": 4356,
      "Dockerfile": 2182
    },
    "commit_activity": {
      "total_commits_last_year": 29,
      "avg_commits_per_week": 0.5576923076923077,
      "days_active_last_year": 24
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "gpl-2.0"
    },
    "collected_at": "2025-01-14T13:25:23.249627"
  }
}