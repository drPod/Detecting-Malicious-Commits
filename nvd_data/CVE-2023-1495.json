{
  "cve_id": "CVE-2023-1495",
  "github_data": {
    "repository": "getrebuild/rebuild",
    "fix_commit": "c9474f84e5f376dd2ade2078e3039961a9425da7",
    "related_commits": [
      "c9474f84e5f376dd2ade2078e3039961a9425da7",
      "c9474f84e5f376dd2ade2078e3039961a9425da7"
    ],
    "patch_url": "https://github.com/getrebuild/rebuild/commit/c9474f84e5f376dd2ade2078e3039961a9425da7.patch",
    "fix_commit_details": {
      "sha": "c9474f84e5f376dd2ade2078e3039961a9425da7",
      "commit_date": "2023-03-18T09:02:04Z",
      "author": {
        "login": "getrebuild",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "H5 sync2 (#595)",
        "length": 303,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 500,
        "additions": 359,
        "deletions": 141
      },
      "files": [
        {
          "filename": "@rbv",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -1 +1 @@\n-Subproject commit e7a767dce22fc0a5636a807402f0fd23ed393231\n+Subproject commit daad0b3376ceb75a2e8ba652ea50a7bf55871480"
        },
        {
          "filename": "src/main/java/com/rebuild/core/configuration/NavBuilder.java",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -488,7 +488,7 @@ static String renderTopNav2(HttpServletRequest request) {\n                     String name = StringUtils.defaultIfBlank((String) d[4], Language.L(\"\u672a\u547d\u540d\"));\n \n                     topNavHtml.append(\n-                            String.format(\"<li class=\\\"nav-item\\\" data-id=\\\"%s\\\"><a class=\\\"nav-link\\\" href=\\\"%s\\\">%s</a></li>\", useNav, url, name));\n+                            String.format(\"<li class=\\\"nav-item\\\" data-id=\\\"%s\\\"><a class=\\\"nav-link text-ellipsis\\\" href=\\\"%s\\\">%s</a></li>\", useNav, url, name));\n                     break;\n                 }\n             }"
        },
        {
          "filename": "src/main/java/com/rebuild/core/metadata/impl/EasyEntityConfigProps.java",
          "status": "modified",
          "additions": 4,
          "deletions": 0,
          "patch": "@@ -50,4 +50,8 @@ public class EasyEntityConfigProps {\n      * \u5217\u8868\u67e5\u8be2\u9762\u677f\n      */\n     public static final String ADV_LIST_FILTERPANE = \"advListFilterPane\";\n+    /**\n+     * \u5217\u8868\u67e5\u8be2\u9875\u7b7e\n+     */\n+    public static final String ADV_LIST_FILTERTABS = \"advListFilterTabs\";\n }"
        },
        {
          "filename": "src/main/java/com/rebuild/core/rbstore/ClassificationImporter.java",
          "status": "modified",
          "additions": 3,
          "deletions": 3,
          "patch": "@@ -15,7 +15,7 @@\n import com.rebuild.core.configuration.general.ClassificationService;\n import com.rebuild.core.metadata.EntityHelper;\n import com.rebuild.core.support.task.HeavyTask;\n-import org.apache.commons.lang.StringEscapeUtils;\n+import com.rebuild.utils.CommonsUtils;\n import org.apache.commons.lang.StringUtils;\n \n /**\n@@ -81,9 +81,9 @@ protected ID findOrCreate(String name, String code, ID parent, int level) {\n         String sql = \"select itemId from ClassificationData where dataId = ? and \";\n         if (StringUtils.isNotBlank(code)) {\n             sql += String.format(\"(code = '%s' or name = '%s')\",\n-                    StringEscapeUtils.escapeSql(code), StringEscapeUtils.escapeSql(name));\n+                    CommonsUtils.escapeSql(code), CommonsUtils.escapeSql(name));\n         } else {\n-            sql += String.format(\"name = '%s'\", StringEscapeUtils.escapeSql(name));\n+            sql += String.format(\"name = '%s'\", CommonsUtils.escapeSql(name));\n         }\n \n         if (parent != null) {"
        },
        {
          "filename": "src/main/java/com/rebuild/core/service/dataimport/RecordCheckout.java",
          "status": "modified",
          "additions": 3,
          "deletions": 3,
          "patch": "@@ -36,8 +36,8 @@\n import com.rebuild.core.service.query.QueryHelper;\n import com.rebuild.core.support.i18n.Language;\n import com.rebuild.core.support.state.StateManager;\n+import com.rebuild.utils.CommonsUtils;\n import lombok.extern.slf4j.Slf4j;\n-import org.apache.commons.lang.StringEscapeUtils;\n import org.apache.commons.lang.StringUtils;\n \n import java.text.MessageFormat;\n@@ -231,7 +231,7 @@ protected ID checkoutReferenceValue(Field field, Cell cell) {\n         if (refEntity.getEntityCode() == EntityHelper.User) {\n             String sql = MessageFormat.format(\n                     \"select userId from User where loginName = ''{0}'' or email = ''{0}'' or fullName = ''{0}''\",\n-                    StringEscapeUtils.escapeSql(val2Text.toString()));\n+                    CommonsUtils.escapeSql(val2Text.toString()));\n             query = Application.createQueryNoFilter(sql);\n         } else {\n             // \u67e5\u627e\u5f15\u7528\u5b9e\u4f53\u7684\u540d\u79f0\u5b57\u6bb5\u548c\u81ea\u52a8\u7f16\u53f7\u5b57\u6bb5\n@@ -248,7 +248,7 @@ protected ID checkoutReferenceValue(Field field, Cell cell) {\n                     String.format(\"select %s from %s where \", refEntity.getPrimaryField().getName(), refEntity.getName()));\n             for (String qf : queryFields) {\n                 sql.append(\n-                        String.format(\"%s = '%s' or \", qf, StringEscapeUtils.escapeSql(val2Text.toString())));\n+                        String.format(\"%s = '%s' or \", qf, CommonsUtils.escapeSql(val2Text.toString())));\n             }\n             sql = new StringBuilder(sql.substring(0, sql.length() - 4));\n "
        },
        {
          "filename": "src/main/java/com/rebuild/core/service/general/QuickCodeReindexTask.java",
          "status": "modified",
          "additions": 16,
          "deletions": 25,
          "patch": "@@ -17,7 +17,11 @@\n import com.rebuild.core.configuration.general.ClassificationManager;\n import com.rebuild.core.configuration.general.PickListManager;\n import com.rebuild.core.metadata.EntityHelper;\n-import com.rebuild.core.metadata.easymeta.*;\n+import com.rebuild.core.metadata.easymeta.DisplayType;\n+import com.rebuild.core.metadata.easymeta.EasyEmail;\n+import com.rebuild.core.metadata.easymeta.EasyMetaFactory;\n+import com.rebuild.core.metadata.easymeta.EasyPhone;\n+import com.rebuild.core.metadata.easymeta.EasyUrl;\n import com.rebuild.core.privileges.UserService;\n import com.rebuild.core.support.i18n.Language;\n import com.rebuild.core.support.state.StateManager;\n@@ -103,6 +107,8 @@ protected Integer exec() {\n     // --\n \n     /**\n+     * \u751f\u6210\u52a9\u8bb0\u7801\n+     *\n      * @param record\n      * @return\n      */\n@@ -111,7 +117,7 @@ public static String generateQuickCode(Record record) {\n         if (!entity.containsField(EntityHelper.QuickCode)) return null;\n \n         Field nameField = entity.getNameField();\n-        if (!record.hasValue(nameField.getName(), false)) return null;\n+        if (!record.hasValue(nameField.getName(), Boolean.FALSE)) return null;\n \n         Object nameValue = record.getObjectValue(nameField.getName());\n         DisplayType dt = EasyMetaFactory.getDisplayType(nameField);\n@@ -139,10 +145,7 @@ public static String generateQuickCode(Record record) {\n     }\n \n     /**\n-     * \u4f60\u597d\u4e16\u754c - NHSJ\n-     * HelloWorld - HW\n-     * hello world - HW\n-     * 43284327432 - \"\"\n+     * \u751f\u6210\u52a9\u8bb0\u7801\n      *\n      * @param nameVal\n      * @return\n@@ -159,34 +162,22 @@ public static String generateQuickCode(String nameVal) {\n         // \u5ffd\u7565\u6570\u5b57\u6216\u5c0f\u5b57\u6bcd\n         if (nameVal.matches(\"[a-z0-9]+\")) return StringUtils.EMPTY;\n \n-        String quickCode = StringUtils.EMPTY;\n+        String quickCode = nameVal;\n \n-        // \u4ec5\u5305\u542b\u5b57\u6bcd\u6570\u5b57\u6216\u7a7a\u683c\n         if (nameVal.matches(\"[a-zA-Z0-9\\\\s]+\")) {\n-            // \u63d0\u53d6\u82f1\u6587\u5355\u8bcd\u7684\u9996\u5b57\u6bcd\n-            String[] asplit = nameVal.split(\"(?=[A-Z\\\\s])\");\n-            if (asplit.length == 1) {\n-                quickCode = nameVal;\n-            } else {\n-                StringBuilder sb = new StringBuilder();\n-                for (String a : asplit) {\n-                    if (a.trim().length() > 0) {\n-                        sb.append(a.trim(), 0, 1);\n-                    }\n-                }\n-                quickCode = sb.toString();\n-            }\n-\n+            // \u4ec5\u5305\u542b\u5b57\u6bcd\u6570\u5b57\u6216\u7a7a\u683c\n         } else {\n-            // \u62fc\u97f3\u9996\u5b57\u6bcd\n-            nameVal = nameVal.replaceAll(\" \", \"\");\n+            // v3.3 \u62fc\u97f3\u5168\u62fc\n             try {\n-                quickCode = HanLP.convertToPinyinFirstCharString(nameVal, \"\", false);\n+                quickCode = HanLP.convertToPinyinString(nameVal, \"\", Boolean.FALSE);\n             } catch (Exception e) {\n                 log.error(\"QuickCode shorting error : \" + nameVal, e);\n+                quickCode = StringUtils.EMPTY;\n             }\n         }\n \n+        // \u53bb\u9664\u7a7a\u683c\n+        quickCode = quickCode.replaceAll(\" \", \"\");\n         return CommonsUtils.maxstr(quickCode, 50).toUpperCase();\n     }\n }"
        },
        {
          "filename": "src/main/java/com/rebuild/core/service/query/AdvFilterParser.java",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -29,9 +29,9 @@\n import com.rebuild.core.privileges.bizz.Department;\n import com.rebuild.core.support.SetUser;\n import com.rebuild.core.support.i18n.Language;\n+import com.rebuild.utils.CommonsUtils;\n import com.rebuild.utils.JSONUtils;\n import lombok.extern.slf4j.Slf4j;\n-import org.apache.commons.lang.StringEscapeUtils;\n import org.apache.commons.lang.StringUtils;\n import org.apache.commons.lang.math.NumberUtils;\n import org.springframework.util.Assert;\n@@ -587,7 +587,7 @@ private String quoteValue(String val, Type type) {\n         if (NumberUtils.isNumber(val) && isNumberType(type)) {\n             return val;\n         } else if (StringUtils.isNotBlank(val)) {\n-            return String.format(\"'%s'\", StringEscapeUtils.escapeSql(val));\n+            return String.format(\"'%s'\", CommonsUtils.escapeSql(val));\n         }\n         return \"''\";\n     }"
        },
        {
          "filename": "src/main/java/com/rebuild/core/support/KVStorage.java",
          "status": "modified",
          "additions": 9,
          "deletions": 2,
          "patch": "@@ -165,7 +165,7 @@ protected static String getValue(final String key, boolean noCache, Object defau\n     private static final Timer THROTTLED_TIMER = new Timer(\"KVStorage-Timer\");\n \n     static {\n-        THROTTLED_TIMER.scheduleAtFixedRate(new TimerTask() {\n+        final TimerTask localTimerTask = new TimerTask() {\n             @Override\n             public void run() {\n                 try {\n@@ -184,6 +184,13 @@ public void run() {\n                     log.error(null, ex);\n                 }\n             }\n-        }, 1000, 1000);\n+        };\n+\n+        THROTTLED_TIMER.scheduleAtFixedRate(localTimerTask, 2000, 2000);\n+\n+        Runtime.getRuntime().addShutdownHook(new Thread(() -> {\n+            log.info(\"The KVStorage shutdown hook is enabled\");\n+            localTimerTask.run();\n+        }));\n     }\n }"
        },
        {
          "filename": "src/main/java/com/rebuild/core/support/general/ProtocolFilterParser.java",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -26,9 +26,9 @@\n import com.rebuild.core.service.dashboard.ChartManager;\n import com.rebuild.core.service.query.AdvFilterParser;\n import com.rebuild.core.service.query.ParseHelper;\n+import com.rebuild.utils.CommonsUtils;\n import com.rebuild.utils.JSONUtils;\n import lombok.extern.slf4j.Slf4j;\n-import org.apache.commons.lang.StringEscapeUtils;\n import org.apache.commons.lang3.StringUtils;\n import org.springframework.util.Assert;\n \n@@ -199,7 +199,7 @@ protected String parseCategory(String entity, String value) {\n         if (categoryField == null || StringUtils.isBlank(value)) return \"(9=9)\";\n \n         DisplayType dt = EasyMetaFactory.getDisplayType(categoryField);\n-        value = StringEscapeUtils.escapeSql(value);\n+        value = CommonsUtils.escapeSql(value);\n \n         if (dt == DisplayType.MULTISELECT) {\n             return String.format(\"%s && %d\", categoryField.getName(), ObjectUtils.toInt(value));"
        },
        {
          "filename": "src/main/java/com/rebuild/utils/CommonsUtils.java",
          "status": "modified",
          "additions": 13,
          "deletions": 1,
          "patch": "@@ -13,6 +13,7 @@\n import com.rebuild.core.RebuildException;\n import lombok.extern.slf4j.Slf4j;\n import org.apache.commons.io.IOUtils;\n+import org.apache.commons.lang.StringEscapeUtils;\n import org.apache.commons.lang.StringUtils;\n import org.springframework.core.io.ClassPathResource;\n \n@@ -85,7 +86,7 @@ public static String maxstr(String text, int maxLength) {\n     /**\n      * @param text\n      * @return\n-     * @see org.apache.commons.lang.StringEscapeUtils#escapeHtml(String)\n+     * @see StringEscapeUtils#escapeHtml(String)\n      */\n     public static String escapeHtml(Object text) {\n         if (text == null || StringUtils.isBlank(text.toString())) {\n@@ -101,6 +102,17 @@ public static String escapeHtml(Object text) {\n                 .replace(\"<\", \"&lt;\");\n     }\n \n+    /**\n+     * @param text\n+     * @return\n+     * @see StringEscapeUtils#escapeSql(String)\n+     */\n+    public static String escapeSql(String text) {\n+        // https://github.com/getrebuild/rebuild/issues/594\n+        text = text.replace(\"\\\\'\", \"'\");\n+        return StringEscapeUtils.escapeSql(text);\n+    }\n+\n     /**\n      * \u83b7\u53d6 classpath \u4e0b\u7684\u914d\u7f6e\u6587\u4ef6\u6d41\n      *"
        },
        {
          "filename": "src/main/java/com/rebuild/web/admin/ConfigCommons.java",
          "status": "modified",
          "additions": 3,
          "deletions": 3,
          "patch": "@@ -11,7 +11,7 @@\n import com.rebuild.core.metadata.MetadataHelper;\n import com.rebuild.core.metadata.easymeta.EasyMetaFactory;\n import com.rebuild.core.support.i18n.I18nUtils;\n-import org.apache.commons.lang.StringEscapeUtils;\n+import com.rebuild.utils.CommonsUtils;\n import org.apache.commons.lang.StringUtils;\n \n import java.util.Date;\n@@ -31,10 +31,10 @@ public class ConfigCommons {\n      */\n     public static Object[][] queryListOfConfig(String sql, String belongEntity, String q) {\n         if (StringUtils.isNotBlank(belongEntity) && !\"$ALL$\".equalsIgnoreCase(belongEntity)) {\n-            sql = sql.replace(\"(1=1)\", \"belongEntity = '\" + StringEscapeUtils.escapeSql(belongEntity) + \"'\");\n+            sql = sql.replace(\"(1=1)\", \"belongEntity = '\" + CommonsUtils.escapeSql(belongEntity) + \"'\");\n         }\n         if (StringUtils.isNotBlank(q)) {\n-            sql = sql.replace(\"(2=2)\", \"name like '%\" + StringEscapeUtils.escapeSql(q) + \"%'\");\n+            sql = sql.replace(\"(2=2)\", \"name like '%\" + CommonsUtils.escapeSql(q) + \"%'\");\n         }\n \n         Object[][] array = Application.createQuery(sql).setLimit(500).array();"
        },
        {
          "filename": "src/main/java/com/rebuild/web/configuration/NavSettings.java",
          "status": "modified",
          "additions": 24,
          "deletions": 0,
          "patch": "@@ -11,6 +11,7 @@\n import cn.devezhao.persist4j.Record;\n import cn.devezhao.persist4j.engine.ID;\n import com.alibaba.fastjson.JSON;\n+import com.alibaba.fastjson.JSONObject;\n import com.rebuild.api.RespBody;\n import com.rebuild.core.Application;\n import com.rebuild.core.configuration.NavManager;\n@@ -27,6 +28,7 @@\n import org.apache.commons.lang.StringUtils;\n import org.springframework.web.bind.annotation.GetMapping;\n import org.springframework.web.bind.annotation.PostMapping;\n+import org.springframework.web.bind.annotation.RequestBody;\n import org.springframework.web.bind.annotation.RequestMapping;\n import org.springframework.web.bind.annotation.RestController;\n \n@@ -119,8 +121,30 @@ public RespBody getsTopNav() {\n \n     @PostMapping(\"nav-settings/topnav\")\n     public RespBody setsTopNav(HttpServletRequest request) {\n+        if (!UserHelper.isAdmin(getRequestUser(request))) return RespBody.error();\n+\n         String s = ServletUtils.getRequestString(request);\n         KVStorage.setCustomValue(\"TopNav32\", s);\n         return RespBody.ok();\n     }\n+\n+    @PostMapping(\"nav-settings/nav-copyto\")\n+    public RespBody navCopyTo(@RequestBody JSONObject post, HttpServletRequest request) {\n+        final ID user = getRequestUser(request);\n+        if (!UserHelper.isAdmin(user)) return RespBody.error();\n+\n+        final ID from  = ID.valueOf(post.getString(\"from\"));\n+        final JSON config = NavManager.instance.getLayoutById(from).getJSON(\"config\");\n+\n+        for (Object s : post.getJSONArray(\"copyTo\")) {\n+            ID to = ID.isId(s) ? ID.valueOf(s.toString()) : null;\n+            if (to == null || from.equals(to)) continue;\n+\n+            Record record = EntityHelper.forUpdate(to, user);\n+            record.setString(\"config\", config.toJSONString());\n+            Application.getBean(LayoutConfigService.class).createOrUpdate(record);\n+        }\n+\n+        return RespBody.ok();\n+    }\n }"
        },
        {
          "filename": "src/main/java/com/rebuild/web/files/FileListController.java",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -25,10 +25,10 @@\n import com.rebuild.core.service.project.ProjectManager;\n import com.rebuild.core.support.i18n.I18nUtils;\n import com.rebuild.core.support.i18n.Language;\n+import com.rebuild.utils.CommonsUtils;\n import com.rebuild.utils.JSONUtils;\n import com.rebuild.web.BaseController;\n import org.apache.commons.io.FileUtils;\n-import org.apache.commons.lang.StringEscapeUtils;\n import org.apache.commons.lang.StringUtils;\n import org.apache.commons.lang.math.NumberUtils;\n import org.springframework.web.bind.annotation.GetMapping;\n@@ -103,7 +103,7 @@ public JSON listFile(HttpServletRequest request) {\n \n         List<String> sqlWhere = new ArrayList<>();\n         if (StringUtils.isNotBlank(q)) {\n-            sqlWhere.add(String.format(\"filePath like '%%%s%%'\", StringEscapeUtils.escapeSql(q)));\n+            sqlWhere.add(String.format(\"filePath like '%%%s%%'\", CommonsUtils.escapeSql(q)));\n         }\n \n         // \u9644\u4ef6"
        },
        {
          "filename": "src/main/java/com/rebuild/web/general/GeneralListController.java",
          "status": "modified",
          "additions": 10,
          "deletions": 4,
          "patch": "@@ -81,7 +81,8 @@ public ModelAndView pageList(@PathVariable String entity,\n         if (listMode == 1) {\n             listConfig = DataListManager.instance.getListFields(entity, user);\n \n-            // \u6269\u5c55\u914d\u7f6e\n+            // \u4fa7\u680f\n+\n             String advListHideFilters = easyEntity.getExtraAttr(EasyEntityConfigProps.ADV_LIST_HIDE_FILTERS);\n             String advListHideCharts = easyEntity.getExtraAttr(EasyEntityConfigProps.ADV_LIST_HIDE_CHARTS);\n             String advListShowCategory = easyEntity.getExtraAttr(EasyEntityConfigProps.ADV_LIST_SHOWCATEGORY);\n@@ -94,10 +95,10 @@ public ModelAndView pageList(@PathVariable String entity,\n \n             // \u67e5\u8be2\u9762\u677f\n \n-            String advListFilterpane = easyEntity.getExtraAttr(EasyEntityConfigProps.ADV_LIST_FILTERPANE);\n-            mv.getModel().put(EasyEntityConfigProps.ADV_LIST_FILTERPANE, advListFilterpane);\n+            String advListFilterPane = easyEntity.getExtraAttr(EasyEntityConfigProps.ADV_LIST_FILTERPANE);\n+            mv.getModel().put(EasyEntityConfigProps.ADV_LIST_FILTERPANE, advListFilterPane);\n \n-            if (BooleanUtils.toBoolean(advListFilterpane)) {\n+            if (BooleanUtils.toBoolean(advListFilterPane)) {\n                 JSONArray paneFields = new JSONArray();\n                 for (String field : DataListManager.instance.getListFilterPaneFields(user, entity)) {\n                     if (AdvFilterParser.VF_ACU.equals(field)) {\n@@ -112,6 +113,11 @@ public ModelAndView pageList(@PathVariable String entity,\n                 mv.getModel().put(\"paneFields\", paneFields);\n             }\n \n+            // \u67e5\u8be2\u9875\u7b7e v3.3\n+\n+            String advListFilterTabs = easyEntity.getExtraAttr(EasyEntityConfigProps.ADV_LIST_FILTERTABS);\n+            mv.getModel().put(EasyEntityConfigProps.ADV_LIST_FILTERTABS, advListFilterTabs);\n+\n         } else if (listMode == 2) {\n             listConfig = DataListManager.instance.getFieldsLayoutMode2(listEntity);\n "
        },
        {
          "filename": "src/main/java/com/rebuild/web/general/ReferenceSearchController.java",
          "status": "modified",
          "additions": 3,
          "deletions": 3,
          "patch": "@@ -28,11 +28,11 @@\n import com.rebuild.core.support.general.FieldValueHelper;\n import com.rebuild.core.support.general.ProtocolFilterParser;\n import com.rebuild.core.support.i18n.Language;\n+import com.rebuild.utils.CommonsUtils;\n import com.rebuild.utils.JSONUtils;\n import com.rebuild.web.EntityController;\n import com.rebuild.web.EntityParam;\n import lombok.extern.slf4j.Slf4j;\n-import org.apache.commons.lang.StringEscapeUtils;\n import org.apache.commons.lang.StringUtils;\n import org.springframework.web.bind.annotation.GetMapping;\n import org.springframework.web.bind.annotation.RequestMapping;\n@@ -137,7 +137,7 @@ private JSON buildResultSearch(Entity searchEntity, String quickFields, String q\n                 return JSONUtils.EMPTY_ARRAY;\n             }\n \n-            String like = \" like '%\" + StringEscapeUtils.escapeSql(q) + \"%'\";\n+            String like = \" like '%\" + CommonsUtils.escapeSql(q) + \"%'\";\n             searchWhere = StringUtils.join(searchFields.iterator(), like + \" or \") + like;\n         }\n \n@@ -178,7 +178,7 @@ public JSON searchClassification(@EntityParam Entity entity, HttpServletRequest\n             }\n         }\n \n-        q = StringEscapeUtils.escapeSql(q);\n+        q = CommonsUtils.escapeSql(q);\n \n         int openLevel = ClassificationManager.instance.getOpenLevel(fieldMeta);\n         String sqlWhere = String.format("
        },
        {
          "filename": "src/main/java/com/rebuild/web/general/RelatedListController.java",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -25,11 +25,11 @@\n import com.rebuild.core.support.general.FieldValueHelper;\n import com.rebuild.core.support.general.ProtocolFilterParser;\n import com.rebuild.core.support.i18n.I18nUtils;\n+import com.rebuild.utils.CommonsUtils;\n import com.rebuild.utils.JSONUtils;\n import com.rebuild.web.BaseController;\n import com.rebuild.web.EntityParam;\n import com.rebuild.web.IdParam;\n-import org.apache.commons.lang.StringEscapeUtils;\n import org.apache.commons.lang.StringUtils;\n import org.apache.commons.lang.math.NumberUtils;\n import org.springframework.web.bind.annotation.GetMapping;\n@@ -146,7 +146,7 @@ private String buildBaseSql(ID mainid, String relatedExpr, String q, boolean cou\n             Set<String> searchFields = ParseHelper.buildQuickFields(relatedEntity, null);\n \n             if (!searchFields.isEmpty()) {\n-                String like = \" like '%\" + StringEscapeUtils.escapeSql(q) + \"%'\";\n+                String like = \" like '%\" + CommonsUtils.escapeSql(q) + \"%'\";\n                 String searchWhere = \" and ( \" + StringUtils.join(searchFields.iterator(), like + \" or \") + like + \" )\";\n                 where += searchWhere;\n             }"
        },
        {
          "filename": "src/main/java/com/rebuild/web/project/ProjectTaskController.java",
          "status": "modified",
          "additions": 3,
          "deletions": 3,
          "patch": "@@ -27,12 +27,12 @@\n import com.rebuild.core.support.general.FieldValueHelper;\n import com.rebuild.core.support.i18n.I18nUtils;\n import com.rebuild.core.support.i18n.Language;\n+import com.rebuild.utils.CommonsUtils;\n import com.rebuild.utils.JSONUtils;\n import com.rebuild.web.BaseController;\n import com.rebuild.web.IdParam;\n import com.rebuild.web.InvalidParameterException;\n import lombok.extern.slf4j.Slf4j;\n-import org.apache.commons.lang.StringEscapeUtils;\n import org.apache.commons.lang.StringUtils;\n import org.springframework.util.Assert;\n import org.springframework.web.bind.annotation.GetMapping;\n@@ -101,7 +101,7 @@ public JSON taskList(HttpServletRequest request) {\n         // \u5173\u952e\u8bcd\u641c\u7d22\n         String search = getParameter(request, \"search\");\n         if (StringUtils.isNotBlank(search)) {\n-            queryWhere += \" and taskName like '%\" + StringEscapeUtils.escapeSql(search) + \"%'\";\n+            queryWhere += \" and taskName like '%\" + CommonsUtils.escapeSql(search) + \"%'\";\n         }\n \n         // \u9ad8\u7ea7\u67e5\u8be2\n@@ -374,7 +374,7 @@ public JSON relatedTaskList(@IdParam(name = \"related\", required = false) ID rela\n         // \u5173\u952e\u8bcd\u641c\u7d22\n         String search = getParameter(request, \"search\");\n         if (StringUtils.isNotBlank(search)) {\n-            queryWhere += \" and taskName like '%\" + StringEscapeUtils.escapeSql(search) + \"%'\";\n+            queryWhere += \" and taskName like '%\" + CommonsUtils.escapeSql(search) + \"%'\";\n         }\n \n         int pageNo = getIntParameter(request, \"pageNo\", 1);"
        },
        {
          "filename": "src/main/resources/web/admin/bizuser/role-privileges.html",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -118,10 +118,10 @@\n           <div class=\"float-right\">\n             <button class=\"btn btn-secondary btn-space J_new-role\" type=\"button\"><i class=\"icon zmdi zmdi-plus\"></i> [[${bundle.L('\u65b0\u5efa\u89d2\u8272')}]]</button>\n             <div class=\"btn-group btn-space\">\n-              <button class=\"btn btn-primary J_save\" type=\"button\" disabled=\"disabled\"><i class=\"icon mdi mdi-account-plus\"></i> [[${bundle.L('\u4fdd\u5b58')}]]</button>\n+              <button class=\"btn btn-primary J_save\" type=\"button\" disabled=\"disabled\">[[${bundle.L('\u4fdd\u5b58')}]]</button>\n               <button class=\"btn btn-primary dropdown-toggle w-auto\" type=\"button\" data-toggle=\"dropdown\" disabled=\"disabled\"><i class=\"icon zmdi zmdi-chevron-down\"></i></button>\n               <div class=\"dropdown-menu dropdown-menu-primary dropdown-menu-right\">\n-                <a class=\"dropdown-item J_copy-role\"><i class=\"icon mdi mdi-account-multiple-plus\"></i> [[${bundle.L('\u590d\u5236\u89d2\u8272')}]]</a>\n+                <a class=\"dropdown-item J_copy-role\"><i class=\"icon zmdi zmdi-copy\"></i> [[${bundle.L('\u590d\u5236\u89d2\u8272')}]]</a>\n               </div>\n             </div>\n           </div>"
        },
        {
          "filename": "src/main/resources/web/admin/bizuser/user-list.html",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -60,8 +60,8 @@\n                           <button class=\"btn btn-secondary\" type=\"button\"><i class=\"icon zmdi zmdi-search\"></i></button>\n                         </span>\n                       </div>\n-                      <div class=\"float-left ml-2 mt-1\" style=\"padding-top: 2px\">\n-                        <label class=\"custom-control custom-control-sm custom-checkbox custom-control-inline\">\n+                      <div class=\"float-left ml-2 pt-1\">\n+                        <label class=\"custom-control custom-checkbox custom-control-inline\">\n                           <input class=\"custom-control-input\" type=\"checkbox\" id=\"showAllUsers\" />\n                           <span class=\"custom-control-label\">[[${bundle.L('\u663e\u793a\u5168\u90e8\u7528\u6237')}]]</span>\n                         </label>"
        },
        {
          "filename": "src/main/resources/web/assets/css/files.css",
          "status": "modified",
          "additions": 3,
          "deletions": 6,
          "patch": "@@ -44,7 +44,7 @@ See LICENSE and COMMERCIAL in the project root for license information.\n .file-list .file-list-item {\n   background-color: #fff;\n   border-bottom: 1px solid #e6e6e6;\n-  padding: 10px 20px;\n+  padding: 9px 20px;\n   display: table;\n   width: 100%;\n   cursor: default;\n@@ -199,17 +199,14 @@ See LICENSE and COMMERCIAL in the project root for license information.\n   font-weight: bold;\n }\n \n-.aside-2tree li > a > .icon {\n+.aside-2tree li > a > .icon.flag {\n   font-size: 12px;\n   color: #aaa;\n+  margin: 0;\n   margin-left: 6px;\n   cursor: help;\n }\n \n-.aside-2tree li.active > a > .icon {\n-  color: #fff;\n-}\n-\n .file-list-striped .file-list-item:nth-of-type(odd) > div.type .file-icon::before {\n   border-top-color: #f5f5f5;\n   border-right-color: #f5f5f5;"
        },
        {
          "filename": "src/main/resources/web/assets/css/list-page.css",
          "status": "modified",
          "additions": 42,
          "deletions": 6,
          "patch": "@@ -11,7 +11,7 @@ See LICENSE and COMMERCIAL in the project root for license information.\n   background-color: #fff;\n   padding: 3px 18px 12px;\n   margin-bottom: 12px;\n-  border-radius: 3px;\n+  border-radius: 2px;\n   min-height: 63px;\n }\n \n@@ -32,6 +32,7 @@ See LICENSE and COMMERCIAL in the project root for license information.\n   display: inline-block;\n   min-width: 227px;\n   position: relative;\n+  vertical-align: top;\n }\n \n .quick-filter-pane .col-item > div .filter-items > .row {\n@@ -94,11 +95,6 @@ See LICENSE and COMMERCIAL in the project root for license information.\n   border-color: #bababa;\n }\n \n-.quick-filter-pane .select2-container,\n-.quick-filter-pane .col-item.operating {\n-  transform: translateY(-1px);\n-}\n-\n .quick-filter-pane .col-item > div .filter-items .col-sm-5.val {\n   position: relative;\n }\n@@ -111,3 +107,43 @@ See LICENSE and COMMERCIAL in the project root for license information.\n   position: absolute;\n   color: #000;\n }\n+\n+.quick-filter-pane .select2-container--default .select2-selection--multiple .select2-search--inline .select2-search__field {\n+  min-width: 114px;\n+}\n+\n+/* filter tabs */\n+\n+.quick-filter-tabs {\n+  background-color: #fff;\n+  padding: 0 18px;\n+  margin-bottom: 12px;\n+  border-radius: 2px;\n+}\n+\n+.quick-filter-tabs > div {\n+  font-size: 0;\n+}\n+\n+.quick-filter-tabs > div .dropdown-item {\n+  display: inline-block;\n+  width: auto;\n+  line-height: 1;\n+  padding: 15px 18px;\n+  font-size: 1rem;\n+  cursor: pointer;\n+}\n+\n+.quick-filter-tabs > div .dropdown-item:active {\n+  background-color: #f5f5f5;\n+  color: unset;\n+}\n+\n+.quick-filter-tabs > div .dropdown-item.active {\n+  background-color: var(--rb-theme-color);\n+  border-radius: 0;\n+}\n+\n+.quick-filter-tabs > div .dropdown-item.active:active {\n+  color: #fff;\n+}"
        },
        {
          "filename": "src/main/resources/web/assets/css/rb-page.css",
          "status": "modified",
          "additions": 49,
          "deletions": 20,
          "patch": "@@ -293,12 +293,12 @@ a.link.inline {\n \n .btn {\n   min-height: 2.8rem;\n-  min-width: 98px;\n+  min-width: 88px;\n }\n \n .btn-group.w-auto > .btn,\n .btn.w-auto {\n-  min-width: 36px !important;\n+  min-width: 34px !important;\n }\n \n a.btn {\n@@ -779,7 +779,6 @@ body.dialog .main-content {\n \n .dialog-footer .btn {\n   margin-left: 5px;\n-  min-width: 98px;\n }\n \n .dialog-footer > .float-left > .custom-control {\n@@ -2057,6 +2056,36 @@ th.column-fixed {\n   color: #4285f4;\n }\n \n+.form-line.hover fieldset legend::before {\n+  font-family: 'Material-Design-Iconic-Font', serif;\n+  font-size: 1.4rem;\n+  content: '\\f2f9';\n+  width: 10px;\n+  display: inline-block;\n+  float: left;\n+  margin-right: 3px;\n+  text-align: center;\n+  line-height: 1;\n+  transform: translateY(-1px);\n+}\n+\n+.form-line.hover.collapsed fieldset legend::before {\n+  content: '\\f2fb';\n+}\n+\n+.form-line.v33 {\n+  background-color: #ebebeb;\n+  border-radius: 2px;\n+  height: 38px;\n+  margin-bottom: 11px;\n+  margin-top: 11px;\n+  padding-top: 2px;\n+}\n+\n+.form-line.v33 fieldset legend {\n+  background-color: transparent;\n+}\n+\n .form-line-breaked {\n   height: 0;\n   font-size: 0;\n@@ -2269,7 +2298,7 @@ th.column-fixed {\n   text-align: center;\n   font-size: 1.2rem;\n   border-radius: 2px;\n-  width: 24px;\n+  width: 22px;\n   display: none;\n }\n \n@@ -2291,6 +2320,16 @@ th.column-fixed {\n   padding-right: 10px;\n }\n \n+.aside-2tree li > a > .icon {\n+  color: #54aeff;\n+  font-size: 16px;\n+  margin-right: 5px;\n+}\n+\n+.aside-2tree li.active > a > .icon {\n+  color: rgba(255, 255, 255, 0.8) !important;\n+}\n+\n /* AdvFilter */\n \n .adv-search .dropdown-item div.action a {\n@@ -2486,15 +2525,15 @@ div.dataTables_wrapper div.dataTables_filter .dropdown-menu-advfilter input {\n \n .dataTables_wrapper .paging_sizes {\n   padding-top: 2px;\n-  padding-left: 9px;\n+  padding-left: 8px;\n }\n \n-.dataTables_wrapper .paging_sizes select {\n+.dataTables_wrapper .paging_sizes .form-control {\n   padding: 4px 6px;\n-  width: 50px;\n+  width: 45px;\n }\n \n-.dataTables_wrapper .paging_sizes select,\n+.dataTables_wrapper .paging_sizes .form-control,\n .dataTables_wrapper .paging_simple_numbers .page-link {\n   height: 36px !important;\n }\n@@ -3534,11 +3573,6 @@ form {\n   overflow: hidden;\n }\n \n-.page-aside.widgets .nav-tabs > li.nav-item a.nav-link {\n-  padding-left: 16px;\n-  padding-right: 16px;\n-}\n-\n .page-aside.widgets .tab-container {\n   margin-top: 2px;\n   min-width: 279px;\n@@ -3927,10 +3961,6 @@ a.icon-link > .zmdi {\n     width: 212px;\n   }\n \n-  .btn {\n-    min-width: 88px;\n-  }\n-\n   /* .page-aside {\n     width: 200px;\n   }\n@@ -4738,8 +4768,6 @@ pre.unstyle {\n }\n \n .protable .table .col-action {\n-  width: 88px;\n-  min-width: 88px;\n   padding-right: 0;\n   text-align: right;\n   width: 48px;\n@@ -5020,7 +5048,8 @@ pre.unstyle {\n \n .navbar-collapse .nav-item .nav-link {\n   position: relative;\n-  padding: 0 20px;\n+  padding: 0 20px !important;\n+  max-width: 200px;\n }\n \n .navbar-collapse .nav-item.active .nav-link::after {"
        },
        {
          "filename": "src/main/resources/web/assets/js/aside-tree.js",
          "status": "modified",
          "additions": 8,
          "deletions": 6,
          "patch": "@@ -16,7 +16,7 @@ class AsideTree extends React.Component {\n   }\n \n   render() {\n-    return <div className={`aside-2tree ${this.props.hideCollapse && 'hide-collapse'}`}>{this.renderTree(this.props.data || [])}</div>\n+    return <div className={`aside-2tree ${this.props.hideCollapse ? 'hide-collapse' : ''}`}>{this.renderTree(this.props.data || [])}</div>\n   }\n \n   renderTree(items, item) {\n@@ -43,28 +43,30 @@ class AsideTree extends React.Component {\n     return (\n       <li className={this.state.activeItem === item.id ? 'active' : ''}>\n         <span\n-          className={`collapse-icon ${!hasChild && 'no-child'}`}\n+          className={`collapse-icon ${hasChild ? '' : 'no-child'}`}\n           onClick={() => {\n             if (hasChild) {\n               const expandItemsNew = this.state.expandItems\n               expandItemsNew.toggle(item.id)\n               this.setState({ expandItems: expandItemsNew })\n             }\n           }}>\n-          <i className={`zmdi zmdi-chevron-right ${this.state.expandItems.contains(item.id) && 'open'} `} />\n+          <i className={`zmdi zmdi-chevron-right ${this.state.expandItems.contains(item.id) ? 'open' : ''} `} />\n         </span>\n         <a\n           data-id={item.id}\n-          className={`text-ellipsis ${item.disabled && 'text-disabled'}`}\n+          className={`text-ellipsis ${item.disabled ? 'text-disabled' : ''}`}\n           title={item.disabled ? $L('\u5df2\u7981\u7528') : null}\n           onClick={() => {\n             this.setState({ activeItem: item.id }, () => {\n               typeof this.props.onItemClick === 'function' && this.props.onItemClick(item)\n             })\n           }}>\n+          {this.props.icon && <i className={`icon ${this.props.icon}`} />}\n           {item.text || item.name}\n-          {item.private === true && <i className=\"icon zmdi zmdi-lock\" title={$L('\u79c1\u6709')} />}\n-          {!!item.specUsers && <i className=\"icon zmdi zmdi-account\" title={$L('\u6307\u5b9a\u7528\u6237')} />}\n+\n+          {item.private === true && <i className=\"icon flag zmdi zmdi-lock\" title={$L('\u79c1\u6709')} />}\n+          {!!item.specUsers && <i className=\"icon flag zmdi zmdi-account\" title={$L('\u6307\u5b9a\u7528\u6237')} />}\n         </a>\n         {typeof this.props.extrasAction === 'function' && this.props.extrasAction(item)}\n       </li>"
        },
        {
          "filename": "src/main/resources/web/assets/js/bizuser/role-privileges.js",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -275,10 +275,10 @@ class CopyRoleTo extends RbModalHandler {\n       <RbModal title={$L('\u590d\u5236\u89d2\u8272')} ref={(c) => (this._dlg = c)} disposeOnHide>\n         <div className=\"form\">\n           <div className=\"form-group row\">\n-            <label className=\"col-sm-3 col-form-label text-sm-right\">{$L('\u590d\u5236\u7ed9\u54ea\u4e9b\u89d2\u8272')}</label>\n+            <label className=\"col-sm-3 col-form-label text-sm-right\">{$L('\u590d\u5236\u5230\u54ea\u4e9b\u89d2\u8272')}</label>\n             <div className=\"col-sm-7\">\n               <UserSelector hideDepartment hideUser hideTeam ref={(c) => (this._UserSelector = c)} />\n-              <p className=\"form-text\">{$L('\u5c06\u5f53\u524d\u89d2\u8272\u6743\u9650\u590d\u5236\u7ed9\u9009\u62e9\u7684\u89d2\u8272\uff0c\u9009\u62e9\u89d2\u8272\u7684\u539f\u6709\u6743\u9650\u4f1a\u88ab\u5b8c\u5168\u8986\u76d6')}</p>\n+              <p className=\"form-text\">{$L('\u5c06\u5f53\u524d\u89d2\u8272\u6743\u9650\u590d\u5236\u5230\u9009\u62e9\u7684\u89d2\u8272\u4e2d\uff0c\u9009\u62e9\u89d2\u8272\u7684\u539f\u6709\u6743\u9650\u4f1a\u88ab\u5b8c\u5168\u8986\u76d6')}</p>\n             </div>\n           </div>\n         </div>"
        },
        {
          "filename": "src/main/resources/web/assets/js/file-preview.js",
          "status": "modified",
          "additions": 2,
          "deletions": 7,
          "patch": "@@ -307,20 +307,15 @@ class RbPreview extends React.Component {\n \n // ~ \u5171\u4eab\n const EXPIRES_TIME = [\n-  [5, 5 + $L('\u5206\u949f')],\n-  [30, 30 + $L('\u5206\u949f')],\n   [60, 1 + $L('\u5c0f\u65f6')],\n   [360, 6 + $L('\u5c0f\u65f6')],\n   [720, 12 + $L('\u5c0f\u65f6')],\n   [1440, 1 + $L('\u5929')],\n   [4320, 3 + $L('\u5929')],\n+  [10080, 7 + $L('\u5929')],\n ]\n \n class FileShare extends RbModalHandler {\n-  constructor(props) {\n-    super(props)\n-  }\n-\n   render() {\n     return (\n       <RbModal ref={(c) => (this._dlg = c)} title={$L('\u5206\u4eab\u6587\u4ef6')} disposeOnHide={true}>\n@@ -375,7 +370,7 @@ class FileShare extends RbModalHandler {\n   }\n \n   _changeTime = (e) => {\n-    const t = e ? ~~e.target.dataset.time : 5\n+    const t = e ? ~~e.target.dataset.time : EXPIRES_TIME[0][0]\n     if (this.state.time === t) return\n     this.setState({ time: t }, () => {\n       $.get(`/filex/make-share?url=${$encode(this.props.file)}&time=${t}`, (res) => {"
        },
        {
          "filename": "src/main/resources/web/assets/js/files/files-docs.js",
          "status": "modified",
          "additions": 2,
          "deletions": 1,
          "patch": "@@ -27,6 +27,7 @@ const FolderTree = {\n \n       renderRbcomp(\n         <AsideTree\n+          icon=\"mdi mdi-folder\"\n           data={__FolderData}\n           activeItem={__DEFAULT_ALL}\n           onItemClick={(item) => {\n@@ -423,7 +424,7 @@ class FilesList4Docs extends FilesList {\n     return (\n       <RF>\n         <span className=\"fop\">\n-          <a title={$L('\u4e0b\u8f7d')} className=\"fs-15\" onClick={(e) => $stopEvent(e)} href={`${rb.baseUrl}/filex/download/${item.filePath}?attname=${$fileCutName(item.filePath)}`} target=\"_blank\">\n+          <a title={$L('\u4e0b\u8f7d')} className=\"fs-16\" onClick={(e) => $stopEvent(e)} href={`${rb.baseUrl}/filex/download/${item.filePath}?attname=${$fileCutName(item.filePath)}`} target=\"_blank\">\n             <i className=\"icon zmdi zmdi-download\" />\n           </a>\n           {rb.fileSharable && ("
        },
        {
          "filename": "src/main/resources/web/assets/js/metadata/entity-advanced.js",
          "status": "modified",
          "additions": 12,
          "deletions": 0,
          "patch": "@@ -172,6 +172,17 @@ class DlgMode1Option extends RbFormHandler {\n               </div>\n             </div>\n           </div>\n+          <div className=\"form-group row bosskey-show\">\n+            <label className=\"col-sm-3 col-form-label text-sm-right\">{$L('\u663e\u793a\u9876\u90e8\u201c\u5e38\u7528\u67e5\u8be2\u201d')}</label>\n+            <div className=\"col-sm-9\">\n+              <div className=\"switch-button switch-button-xs\">\n+                <input type=\"checkbox\" id=\"advListFilterTabs\" defaultChecked={wpc.extConfig && wpc.extConfig.advListFilterTabs} />\n+                <span>\n+                  <label htmlFor=\"advListFilterTabs\" />\n+                </span>\n+              </div>\n+            </div>\n+          </div>\n           <div className=\"form-group row\">\n             <label className=\"col-sm-3 col-form-label text-sm-right\">{$L('\u663e\u793a\u9876\u90e8\u201c\u67e5\u8be2\u9762\u677f\u201d')}</label>\n             <div className=\"col-sm-9\">\n@@ -281,6 +292,7 @@ class DlgMode1Option extends RbFormHandler {\n       advListHideFilters: !$val('#advListHideFilters'),\n       advListHideCharts: !$val('#advListHideCharts'),\n       advListFilterPane: $val('#advListFilterPane'),\n+      advListFilterTabs: $val('#advListFilterTabs'),\n     }\n \n     if (this.state.advListShowCategory) {"
        },
        {
          "filename": "src/main/resources/web/assets/js/metadata/field-type.js",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -22,7 +22,7 @@ const FIELD_TYPES = {\n   'PICKLIST': [$L('\u4e0b\u62c9\u5217\u8868'), 'mdi-form-select'],\n   'CLASSIFICATION': [$L('\u5206\u7c7b'), 'mdi-form-dropdown'],\n   'MULTISELECT': [$L('\u591a\u9009'), 'mdi-format-list-checks'],\n-  'TAG': [$L('\u6807\u7b7e'), 'mdi-tag-outline', true],\n+  'TAG': [$L('\u6807\u7b7e'), 'mdi-tag-outline'],\n   'REFERENCE': [$L('\u5f15\u7528'), 'mdi-feature-search-outline'],\n   'N2NREFERENCE': [$L('\u591a\u5f15\u7528'), 'mdi-text-box-search-outline'],\n   'FILE': [$L('\u9644\u4ef6'), 'mdi-attachment'],"
        },
        {
          "filename": "src/main/resources/web/assets/js/nav-settings.js",
          "status": "modified",
          "additions": 62,
          "deletions": 1,
          "patch": "@@ -153,8 +153,17 @@ $(document).ready(() => {\n         renderRbcomp(<Share2 title={$L('\u5bfc\u822a\u83dc\u5355')} list={alist} configName={c ? c[1] : ''} shareTo={_current.shareTo} id={_current.id} />, 'shareTo', function () {\n           _Share2 = this\n \n+          const $menu = $(this._$switch).find('.dropdown-menu')\n+\n+          $(`<a class=\"dropdown-item\" ${c ? '' : 'disabled'}>${$L('\u590d\u5236\u5bfc\u822a\u83dc\u5355')}</a>`)\n+            .prependTo($menu)\n+            .on('click', () => {\n+              if (c) renderRbcomp(<CopyNavTo list={alist} current={c[0]} />)\n+            })\n+\n+          $('<div class=\"dropdown-divider bosskey-show\"></div>').prependTo($menu)\n           $(`<a class=\"dropdown-item bosskey-show\">${$L('\u914d\u7f6e\u9876\u90e8\u83dc\u5355')}</a>`)\n-            .appendTo($(this._$switch).find('.dropdown-menu'))\n+            .prependTo($menu)\n             .on('click', () => {\n               renderRbcomp(<TopNavSettings list={alist} />)\n             })\n@@ -425,3 +434,55 @@ class TopNavSettings extends Share2Switch {\n     $.post('/app/settings/nav-settings/topnav', JSON.stringify(sets), () => this.hide())\n   }\n }\n+\n+// eslint-disable-next-line no-undef\n+class CopyNavTo extends Share2Switch {\n+  renderContent() {\n+    return (\n+      <div style={{ margin: '0 15px' }}>\n+        <div className=\"form-group\">\n+          <label className=\"text-bold\">{$L('\u590d\u5236\u5230\u54ea\u4e9b\u5bfc\u822a\u83dc\u5355')}</label>\n+          <div ref={(c) => (this._$selected = c)}>\n+            {this.props.list.map((item) => {\n+              return (\n+                <label className=\"custom-control custom-checkbox custom-control-inline\" key={item[0]}>\n+                  <input className=\"custom-control-input\" type=\"checkbox\" data-id={item[0]} disabled={item[0] === this.props.current} />\n+                  <span className=\"custom-control-label\">\n+                    {item[1] || $L('\u672a\u547d\u540d')}\n+                    {item[0] === this.props.current && ` [${$L('\u5f53\u524d')}]`}\n+                  </span>\n+                </label>\n+              )\n+            })}\n+          </div>\n+          <div className=\"form-text mt-0\">{$L('\u5c06\u5f53\u524d\u5bfc\u822a\u83dc\u5355\u914d\u7f6e\u590d\u5236\u5230\u9009\u62e9\u7684\u5bfc\u822a\u83dc\u5355\u4e2d')}</div>\n+        </div>\n+        <div className=\"mb-1\">\n+          <button className=\"btn btn-primary\" type=\"button\" onClick={() => this.handleConfirm()}>\n+            {$L('\u786e\u5b9a')}\n+          </button>\n+        </div>\n+      </div>\n+    )\n+  }\n+\n+  handleConfirm() {\n+    const post = {\n+      from: this.props.current,\n+      copyTo: [],\n+    }\n+\n+    $(this._$selected)\n+      .find('input:checked')\n+      .each(function () {\n+        post.copyTo.push($(this).data('id'))\n+      })\n+\n+    console.log(post)\n+\n+    $.post('/app/settings/nav-settings/nav-copyto', JSON.stringify(post), () => {\n+      this.hide()\n+      RbHighbar.success($L('\u590d\u5236\u5b8c\u6210'))\n+    })\n+  }\n+}"
        },
        {
          "filename": "src/main/resources/web/assets/js/rb-advfilter.js",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -890,7 +890,7 @@ class ListAdvFilter extends AdvFilter {\n               </button>\n               <div className=\"dropdown-menu dropdown-menu-right\">\n                 <a className=\"dropdown-item\" onClick={() => this.handleNew()}>\n-                  {$L('\u4fdd\u5b58\u5e38\u7528\u67e5\u8be2')}\n+                  {$L('\u4fdd\u5b58\u5230\u5e38\u7528\u67e5\u8be2')}\n                 </a>\n               </div>\n             </div>"
        },
        {
          "filename": "src/main/resources/web/assets/js/rb-datalist.common.js",
          "status": "modified",
          "additions": 33,
          "deletions": 10,
          "patch": "@@ -114,18 +114,20 @@ const AdvFilters = {\n       })\n \n       // ASIDE\n-      if ($('#asideFilters').length > 0) {\n+      if ($('#asideFilters, .quick-filter-tabs').length > 0) {\n         const $ghost = $('.adv-search .dropdown-menu').clone()\n         $ghost.removeAttr('class')\n         $ghost.removeAttr('style')\n         $ghost.removeAttr('data-ps-id')\n-        $ghost.find('.ps-scrollbar-x-rail, .ps-scrollbar-y-rail').remove()\n+        $ghost.find('.ps-scrollbar-x-rail, .ps-scrollbar-y-rail, .action').remove()\n         $ghost.find('.dropdown-item').on('click', function () {\n           $ghost.find('.dropdown-item').removeClass('active')\n           $(this).addClass('active')\n           that._effectFilter($(this), 'aside')\n         })\n-        $ghost.appendTo($('#asideFilters').empty())\n+\n+        $ghost.clone(true).appendTo($('#asideFilters').empty())\n+        $ghost.clone(true).appendTo($('.quick-filter-tabs').empty())\n       }\n \n       if (!$defaultFilter) $defaultFilter = $('.adv-search .dropdown-item:eq(0)')\n@@ -146,6 +148,14 @@ const AdvFilters = {\n             return false\n           }\n         })\n+      $('.quick-filter-tabs .dropdown-item')\n+        .removeClass('active')\n+        .each(function () {\n+          if ($(this).data('id') === current) {\n+            $(this).addClass('active')\n+            return false\n+          }\n+        })\n     }\n \n     if (this.current === '$ALL$') this.current = null\n@@ -634,7 +644,9 @@ const RbListCommon = {\n     if (wpc.advFilter !== false) AdvFilters.init('.adv-search', entity[0])\n \n     // \u65b0\u5efa\n-    $('.J_new').on('click', () => RbFormModal.create({ title: $L('\u65b0\u5efa%s', entity[1]), entity: entity[0], icon: entity[2] }))\n+    $('.J_new')\n+      .attr('disabled', false)\n+      .on('click', () => RbFormModal.create({ title: $L('\u65b0\u5efa%s', entity[1]), entity: entity[0], icon: entity[2] }))\n     // \u5bfc\u51fa\n     $('.J_export').on('click', () => renderRbcomp(<DataExport listRef={_RbList()} entity={entity[0]} />))\n     // \u6279\u91cf\u4fee\u6539\n@@ -802,8 +814,9 @@ class RbList extends React.Component {\n \n       $addResizeHandler(() => {\n         let mh = $(window).height() - 210 + 5\n-        if ($('.main-content>.nav-tabs-classic').length > 0) mh -= 38 // Has tab\n-        if ($('.main-content .quick-filter-pane').length > 0) mh -= 75 // Has query-pane\n+        if ($('.main-content>.nav-tabs-classic')[0]) mh -= 38 // Has detail-tab\n+        if ($('.main-content .quick-filter-pane')[0]) mh -= 75 // Has query-pane\n+        if ($('.main-content .quick-filter-tabs')[0]) mh -= 55 // Has query-tabs\n         $scroller.css({ maxHeight: mh })\n         $scroller.perfectScrollbar('update')\n       })()\n@@ -890,7 +903,7 @@ class RbList extends React.Component {\n         this.setState({ rowsData: res.data.data || [], inLoad: false }, () => {\n           RbList.renderAfter()\n           this._clearSelected()\n-          $(this._$scroller).scrollTop(0)\n+          $(this._$scroller).scrollTop(0) //.perfectScrollbar('update')\n         })\n \n         if (reload && this._Pagination) {\n@@ -1185,6 +1198,9 @@ class RbListPagination extends React.Component {\n               <option value=\"500\">500</option>\n             </select>\n           </div>\n+          <div className=\"float-right paging_sizes\">\n+            <input className=\"form-control form-control-sm text-center\" title={$L('\u9875\u7801')} placeholder={$L('\u9875\u7801')} onKeyDown={this.setPageNo} />\n+          </div>\n           <div className=\"float-right dataTables_paginate paging_simple_numbers\">\n             <ul className=\"pagination mb-0\">\n               {this.state.pageNo > 1 && (\n@@ -1273,10 +1289,17 @@ class RbListPagination extends React.Component {\n     })\n   }\n \n+  setPageNo = (e) => {\n+    const pn = ~~e.target.value\n+    if (e.keyCode === 13 && pn && pn > 0) {\n+      this.goto(Math.min(pn, this.__pageTotal))\n+    }\n+  }\n+\n   setPageSize = (e) => {\n-    const s = e.target.value\n-    this.setState({ pageSize: s, pageNo: 1 }, () => {\n-      this.props.$$$parent.setPage(1, s)\n+    const ps = ~~e.target.value\n+    this.setState({ pageSize: ps, pageNo: 1 }, () => {\n+      this.props.$$$parent.setPage(1, ps)\n     })\n   }\n }"
        },
        {
          "filename": "src/main/resources/web/assets/js/rb-forms.append.js",
          "status": "modified",
          "additions": 7,
          "deletions": 1,
          "patch": "@@ -443,7 +443,7 @@ class BaiduMapModal extends RbModal {\n                                 $stopEvent(e, true)\n                                 this._suggestUpDown(e.which)\n                               } else if (e.which === 13) {\n-                                let $active = $(this._$suggestion).find('.active')\n+                                const $active = $(this._$suggestion).find('.active')\n                                 if ($active[0] && $active.text()) {\n                                   this._suggestSelect({ address: $active.text(), location: $active.data('location') })\n                                 }\n@@ -564,6 +564,12 @@ class BaiduMapModal extends RbModal {\n     $(this._$searchValue).val(item.address)\n     this._BaiduMap.center(item.location)\n     this.setState({ suggestion: [] })\n+\n+    this._latlngValue = {\n+      lat: item.location.lat,\n+      lng: item.location.lng,\n+      text: item.address,\n+    }\n   }\n \n   _suggestUpDown(key) {"
        },
        {
          "filename": "src/main/resources/web/assets/js/rb-forms.js",
          "status": "modified",
          "additions": 10,
          "deletions": 7,
          "patch": "@@ -2391,7 +2391,7 @@ class RbFormLocation extends RbFormElement {\n           lnglat={lnglat}\n           title={$L('\u9009\u53d6\u4f4d\u7f6e')}\n           onConfirm={(lnglat) => {\n-            const val = lnglat && lnglat.text ? `${lnglat.text}$$$$${lnglat.lng},${lnglat.lat}` : null\n+            const val = lnglat && lnglat.text ? `${lnglat.text}$$$$${lnglat.lng || 0},${lnglat.lat || 0}` : null\n             that.handleChange({ target: { value: val } }, true)\n           }}\n         />,\n@@ -2578,31 +2578,34 @@ class RbFormUnsupportted extends RbFormElement {\n class RbFormDivider extends React.Component {\n   constructor(props) {\n     super(props)\n+    this.state = { collapsed: false }\n   }\n \n   render() {\n     if (this.props.breaked === true) {\n       return <div className=\"form-line-breaked\"></div>\n     }\n+\n     return (\n-      <div className=\"form-line hover\" ref={(c) => (this._$formLine = c)}>\n+      <div className={`form-line hover -v33 ${this.state.collapsed && 'collapsed'}`} ref={(c) => (this._$formLine = c)}>\n         <fieldset>\n-          {this.props.label && (\n-            <legend onClick={() => this.toggle()} className=\"text-bold\" title={$L('\u5c55\u5f00/\u6536\u8d77')}>\n-              {this.props.label}\n-            </legend>\n-          )}\n+          <legend onClick={() => this.toggle()} title={$L('\u5c55\u5f00/\u6536\u8d77')}>\n+            {this.props.label || ''}\n+          </legend>\n         </fieldset>\n       </div>\n     )\n   }\n \n   toggle() {\n+    let collapsed = null\n     let $next = $(this._$formLine)\n     while (($next = $next.next()).length > 0) {\n       if ($next.hasClass('form-line') || $next.hasClass('footer')) break\n       $next.toggleClass('hide')\n+      if (collapsed === null) collapsed = $next.hasClass('hide')\n     }\n+    this.setState({ collapsed })\n   }\n }\n "
        },
        {
          "filename": "src/main/resources/web/assets/js/rb-page.js",
          "status": "modified",
          "additions": 0,
          "deletions": 1,
          "patch": "@@ -548,7 +548,6 @@ var $fileCutName = function (fileName) {\n  * \u83b7\u53d6\u9644\u4ef6\u6587\u4ef6\u6269\u5c55\u540d\n  */\n var $fileExtName = function (fileName) {\n-  debugger\n   fileName = (fileName || '').toLowerCase()\n   fileName = fileName.split('?')[0]\n   fileName = fileName.split('.')"
        },
        {
          "filename": "src/main/resources/web/common/shared-file.html",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -2,7 +2,7 @@\n <html xmlns:th=\"http://www.thymeleaf.org\">\n   <head>\n     <th:block th:replace=\"~{/_include/header}\" />\n-    <meta http-equiv=\"refresh\" content=\"1800\" />\n+    <meta http-equiv=\"refresh\" content=\"3600\" />\n     <title>[[${bundle.L('\u5206\u4eab\u6587\u4ef6')}]]</title>\n     <style>\n       .preview-modal .preview-header .float-right a:first-child {"
        },
        {
          "filename": "src/main/resources/web/general/detail-list.html",
          "status": "modified",
          "additions": 5,
          "deletions": 0,
          "patch": "@@ -41,6 +41,11 @@\n           </div>\n         </aside>\n         <div class=\"main-content container-fluid\">\n+          <div class=\"quick-filter-tabs\" th:if=\"${advListFilterTabs == 'true'}\">\n+            <div>\n+              <div class=\"dropdown-item\"><a>[[${bundle.L('\u5168\u90e8\u6570\u636e')}]]</a></div>\n+            </div>\n+          </div>\n           <div class=\"quick-filter-pane\" th:if=\"${advListFilterPane == 'true'}\">\n             <div class=\"ph-item rb\"></div>\n             <span></span>"
        },
        {
          "filename": "src/main/resources/web/general/record-list.html",
          "status": "modified",
          "additions": 6,
          "deletions": 1,
          "patch": "@@ -41,6 +41,11 @@\n           </div>\n         </aside>\n         <div class=\"main-content container-fluid\">\n+          <div class=\"quick-filter-tabs\" th:if=\"${advListFilterTabs == 'true'}\">\n+            <div>\n+              <div class=\"dropdown-item\"><a>[[${bundle.L('\u5168\u90e8\u6570\u636e')}]]</a></div>\n+            </div>\n+          </div>\n           <div class=\"quick-filter-pane\" th:if=\"${advListFilterPane == 'true'}\">\n             <div class=\"ph-item rb\"></div>\n             <span></span>\n@@ -88,7 +93,7 @@\n                     <div class=\"dataTables_oper\">\n                       <button class=\"btn btn-space btn-secondary J_view\" type=\"button\" disabled=\"disabled\"><i class=\"icon zmdi zmdi-folder\"></i> [[${bundle.L('\u6253\u5f00')}]]</button>\n                       <button class=\"btn btn-space btn-secondary J_edit\" type=\"button\" disabled=\"disabled\"><i class=\"icon zmdi zmdi-edit\"></i> [[${bundle.L('\u7f16\u8f91')}]]</button>\n-                      <button class=\"btn btn-space btn-primary J_new\" type=\"button\"><i class=\"icon zmdi zmdi-plus\"></i> [[${bundle.L('\u65b0\u5efa')}]]</button>\n+                      <button class=\"btn btn-space btn-primary J_new\" type=\"button\" disabled=\"disabled\"><i class=\"icon zmdi zmdi-plus\"></i> [[${bundle.L('\u65b0\u5efa')}]]</button>\n                       <div class=\"btn-group btn-space J_action\">\n                         <button class=\"btn btn-secondary dropdown-toggle\" type=\"button\" data-toggle=\"dropdown\">[[${bundle.L('\u66f4\u591a')}]] <i class=\"icon zmdi zmdi-more-vert\"></i></button>\n                         <div class=\"dropdown-menu dropdown-menu-right\">"
        },
        {
          "filename": "src/test/java/com/rebuild/core/support/task/QuickCodeReindexTaskTest.java",
          "status": "modified",
          "additions": 8,
          "deletions": 8,
          "patch": "@@ -20,16 +20,16 @@\n public class QuickCodeReindexTaskTest extends TestSupport {\n \n     @Test\n-    public void testGenerateQuickCode() {\n-        Assertions.assertFalse(\"NHHSJ\".equalsIgnoreCase(QuickCodeReindexTask.generateQuickCode(\"\u4f60 \u597d     hello      \u4e16 \u754c\")));\n-        Assertions.assertTrue(\"HW\".equalsIgnoreCase(QuickCodeReindexTask.generateQuickCode(\"hello     world     ........\")));\n-        Assertions.assertTrue(\"HW\".equalsIgnoreCase(QuickCodeReindexTask.generateQuickCode(\"HelloWorld!\")));\n-        Assertions.assertTrue(\"NHSJ\".equalsIgnoreCase(QuickCodeReindexTask.generateQuickCode(\"\u4f60\u597d\u4e16\u754c\")));\n-        Assertions.assertTrue(\"NHSJ\".equalsIgnoreCase(QuickCodeReindexTask.generateQuickCode(\"\u4f60 \u597d           \u4e16 \u754c\")));\n+    void testGenerateQuickCode() {\n+        Assertions.assertFalse(\"NIHAOHELLOSHIJIE\".equalsIgnoreCase(QuickCodeReindexTask.generateQuickCode(\"\u4f60 \u597d     hello      \u4e16 \u754c\")));\n+        Assertions.assertTrue(\"HELLOWORLD\".equalsIgnoreCase(QuickCodeReindexTask.generateQuickCode(\"hello     world     ........\")));\n+        Assertions.assertTrue(\"HELLOWORLD\".equalsIgnoreCase(QuickCodeReindexTask.generateQuickCode(\"HelloWorld!\")));\n+        Assertions.assertTrue(\"NIHAOSHIJIE\".equalsIgnoreCase(QuickCodeReindexTask.generateQuickCode(\"\u4f60\u597d\u4e16\u754c\")));\n+        Assertions.assertTrue(\"NIHAOSHIJIE\".equalsIgnoreCase(QuickCodeReindexTask.generateQuickCode(\"\u4f60 \u597d           \u4e16 \u754c\")));\n     }\n \n     @Test\n-    public void testGenerateQuickCodeEmpty() {\n+    void testGenerateQuickCodeEmpty() {\n         // Phone, contains `-`\n         Assertions.assertTrue(\"\".equalsIgnoreCase(QuickCodeReindexTask.generateQuickCode(\"021-123-123\")));\n         // EMail, contains `@` and `.`\n@@ -43,7 +43,7 @@ public void testGenerateQuickCodeEmpty() {\n     }\n \n     @Test\n-    public void testReindex() {\n+    void testReindex() {\n         new QuickCodeReindexTask(MetadataHelper.getEntity(\"User\")).run();\n     }\n }"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 5,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 24,
        "max_directory_depth": 8
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "b08ba222388d1be142ac2a5f62e16f7bbbd2f015",
            "date": "2025-01-09T08:29:43Z",
            "author_login": "getrebuild"
          },
          {
            "sha": "04fc15f1c09a4510632245783bbda9a36a3881e7",
            "date": "2025-01-09T08:14:52Z",
            "author_login": "getrebuild"
          },
          {
            "sha": "a97df2f42ed4ecdcab91b0414abc7e5334a087eb",
            "date": "2025-01-09T08:02:55Z",
            "author_login": "getrebuild"
          },
          {
            "sha": "0a9fbcdde1937bcaadd3d37f72e576773dee8e63",
            "date": "2025-01-09T05:22:12Z",
            "author_login": "getrebuild"
          },
          {
            "sha": "8c9e831d263386a093af0fb5b04757ded26155c0",
            "date": "2024-12-31T07:04:48Z",
            "author_login": "getrebuild"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.3,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L",
    "cwe_id": "CWE-89",
    "description": "A vulnerability classified as critical was found in Rebuild up to 3.2.3. Affected by this vulnerability is the function queryListOfConfig of the file /admin/robot/approval/list. The manipulation of the argument q leads to sql injection. The attack can be launched remotely. The exploit has been disclosed to the public and may be used. The identifier of the patch is c9474f84e5f376dd2ade2078e3039961a9425da7. It is recommended to apply a patch to fix this issue. The identifier VDB-223381 was assigned to this vulnerability.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-03-19T00:15:12.677",
    "last_modified": "2024-11-21T07:39:18.620",
    "fix_date": "2023-03-18T09:02:04Z"
  },
  "references": [
    {
      "url": "https://github.com/getrebuild/rebuild/commit/c9474f84e5f376dd2ade2078e3039961a9425da7",
      "source": "cna@vuldb.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/getrebuild/rebuild/issues/594",
      "source": "cna@vuldb.com",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://vuldb.com/?ctiid.223381",
      "source": "cna@vuldb.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://vuldb.com/?id.223381",
      "source": "cna@vuldb.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/getrebuild/rebuild/commit/c9474f84e5f376dd2ade2078e3039961a9425da7",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/getrebuild/rebuild/issues/594",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://vuldb.com/?ctiid.223381",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://vuldb.com/?id.223381",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:05:08.982992",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "rebuild",
    "owner": "getrebuild",
    "created_at": "2018-05-18T03:44:32Z",
    "updated_at": "2025-01-14T09:38:41Z",
    "pushed_at": "2025-01-13T15:20:15Z",
    "size": 43341,
    "stars": 815,
    "forks": 208,
    "open_issues": 9,
    "watchers": 815,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "rebuild-1.x"
    ],
    "languages": {
      "Java": 11205754,
      "HTML": 1057493,
      "CSS": 801620,
      "Shell": 755,
      "Dockerfile": 352
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "gpl-3.0"
    },
    "collected_at": "2025-01-14T15:13:14.528511"
  }
}