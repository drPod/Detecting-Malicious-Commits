{
  "cve_id": "CVE-2023-26489",
  "github_data": {
    "repository": "bytecodealliance/wasmtime",
    "fix_commit": "63fb30e4b4415455d47b3da5a19d79c12f4f2d1f",
    "related_commits": [
      "63fb30e4b4415455d47b3da5a19d79c12f4f2d1f",
      "63fb30e4b4415455d47b3da5a19d79c12f4f2d1f"
    ],
    "patch_url": "https://github.com/bytecodealliance/wasmtime/commit/63fb30e4b4415455d47b3da5a19d79c12f4f2d1f.patch",
    "fix_commit_details": {
      "sha": "63fb30e4b4415455d47b3da5a19d79c12f4f2d1f",
      "commit_date": "2023-03-08T19:00:40Z",
      "author": {
        "login": "alexcrichton",
        "type": "User",
        "stats": {
          "total_commits": 2087,
          "average_weekly_commits": 4.546840958605665,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 258
        }
      },
      "commit_message": {
        "title": "Merge pull request from GHSA-ff4p-7xrq-q5r8",
        "length": 506,
        "has_description": true,
        "references_issue": false
      },
      "stats": {
        "total": 72,
        "additions": 52,
        "deletions": 20
      },
      "files": [
        {
          "filename": "RELEASES.md",
          "status": "modified",
          "additions": 42,
          "deletions": 0,
          "patch": "@@ -20,6 +20,20 @@ Unreleased.\n \n --------------------------------------------------------------------------------\n \n+## 6.0.1\n+\n+Released 2023-03-08.\n+\n+### Fixed\n+\n+* Guest-controlled out-of-bounds read/write on x86\\_64\n+  [GHSA-ff4p-7xrq-q5r8](https://github.com/bytecodealliance/wasmtime/security/advisories/GHSA-ff4p-7xrq-q5r8)\n+\n+*  Miscompilation of `i8x16.select` with the same inputs on x86\\_64\n+  [GHSA-xm67-587q-r2vw](https://github.com/bytecodealliance/wasmtime/security/advisories/GHSA-xm67-587q-r2vw)\n+\n+--------------------------------------------------------------------------------\n+\n ## 6.0.0\n \n Released 2023-02-20\n@@ -74,6 +88,20 @@ Released 2023-02-20\n \n --------------------------------------------------------------------------------\n \n+## 5.0.1\n+\n+Released 2023-03-08.\n+\n+### Fixed\n+\n+* Guest-controlled out-of-bounds read/write on x86\\_64\n+  [GHSA-ff4p-7xrq-q5r8](https://github.com/bytecodealliance/wasmtime/security/advisories/GHSA-ff4p-7xrq-q5r8)\n+\n+*  Miscompilation of `i8x16.select` with the same inputs on x86\\_64\n+  [GHSA-xm67-587q-r2vw](https://github.com/bytecodealliance/wasmtime/security/advisories/GHSA-xm67-587q-r2vw)\n+\n+--------------------------------------------------------------------------------\n+\n ## 5.0.0\n \n Released 2023-01-20\n@@ -123,6 +151,20 @@ Released 2023-01-20\n \n --------------------------------------------------------------------------------\n \n+## 4.0.1\n+\n+Released 2023-03-08.\n+\n+### Fixed\n+\n+* Guest-controlled out-of-bounds read/write on x86\\_64\n+  [GHSA-ff4p-7xrq-q5r8](https://github.com/bytecodealliance/wasmtime/security/advisories/GHSA-ff4p-7xrq-q5r8)\n+\n+*  Miscompilation of `i8x16.select` with the same inputs on x86\\_64\n+  [GHSA-xm67-587q-r2vw](https://github.com/bytecodealliance/wasmtime/security/advisories/GHSA-xm67-587q-r2vw)\n+\n+--------------------------------------------------------------------------------\n+\n ## 4.0.0\n \n Released 2022-12-20"
        },
        {
          "filename": "cranelift/codegen/src/isa/x64/inst.isle",
          "status": "modified",
          "additions": 0,
          "deletions": 14,
          "patch": "@@ -1063,20 +1063,6 @@\n (rule 2 (amode_add (Amode.ImmReg off (valid_reg base) flags) (ishl index (iconst (uimm8 shift))))\n       (if (u32_lteq (u8_as_u32 shift) 3))\n       (Amode.ImmRegRegShift off base index shift flags))\n-(rule 2 (amode_add (Amode.ImmReg off (valid_reg base) flags) (uextend (ishl index (iconst (uimm8 shift)))))\n-      (if (u32_lteq (u8_as_u32 shift) 3))\n-      (Amode.ImmRegRegShift off base (extend_to_gpr index $I64 (ExtendKind.Zero)) shift flags))\n-\n-;; Same, but with a uextend of a shift of a 32-bit add. This is valid\n-;; because we know our lowering of a narrower-than-64-bit `iadd` will\n-;; always write the full register width, so we can effectively ignore\n-;; the `uextend` and look through it to the `ishl`.\n-;;\n-;; Priority 3 to avoid conflict with the previous rule.\n-(rule 3 (amode_add (Amode.ImmReg off (valid_reg base) flags)\n-                   (uextend (ishl index @ (iadd _ _) (iconst (uimm8 shift)))))\n-      (if (u32_lteq (u8_as_u32 shift) 3))\n-      (Amode.ImmRegRegShift off base index shift flags))\n \n ;; -- Case 4 (absorbing constant offsets).\n ;;"
        },
        {
          "filename": "cranelift/filetests/filetests/isa/x64/amode-opt.clif",
          "status": "modified",
          "additions": 10,
          "deletions": 6,
          "patch": "@@ -209,8 +209,9 @@ block0(v0: i64, v1: i32):\n ;   pushq   %rbp\n ;   movq    %rsp, %rbp\n ; block0:\n-;   movl    %esi, %ecx\n-;   movq    -1(%rdi,%rcx,8), %rax\n+;   movq    %rsi, %rdx\n+;   shll    $3, %edx, %edx\n+;   movq    -1(%rdi,%rdx,1), %rax\n ;   movq    %rbp, %rsp\n ;   popq    %rbp\n ;   ret\n@@ -220,8 +221,9 @@ block0(v0: i64, v1: i32):\n ;   pushq %rbp\n ;   movq %rsp, %rbp\n ; block1: ; offset 0x4\n-;   movl %esi, %ecx\n-;   movq -1(%rdi, %rcx, 8), %rax ; trap: heap_oob\n+;   movq %rsi, %rdx\n+;   shll $3, %edx\n+;   movq -1(%rdi, %rdx), %rax ; trap: heap_oob\n ;   movq %rbp, %rsp\n ;   popq %rbp\n ;   retq\n@@ -244,7 +246,8 @@ block0(v0: i64, v1: i32, v2: i32):\n ; block0:\n ;   movq    %rsi, %r8\n ;   addl    %r8d, %edx, %r8d\n-;   movq    -1(%rdi,%r8,4), %rax\n+;   shll    $2, %r8d, %r8d\n+;   movq    -1(%rdi,%r8,1), %rax\n ;   movq    %rbp, %rsp\n ;   popq    %rbp\n ;   ret\n@@ -256,7 +259,8 @@ block0(v0: i64, v1: i32, v2: i32):\n ; block1: ; offset 0x4\n ;   movq %rsi, %r8\n ;   addl %edx, %r8d\n-;   movq -1(%rdi, %r8, 4), %rax ; trap: heap_oob\n+;   shll $2, %r8d\n+;   movq -1(%rdi, %r8), %rax ; trap: heap_oob\n ;   movq %rbp, %rsp\n ;   popq %rbp\n ;   retq"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 3,
        "max_directory_depth": 5
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "a88eb702a4847d6ed2e09fa1ef1f86e38f49ca5e",
            "date": "2025-01-14T18:28:51Z",
            "author_login": "fitzgen"
          },
          {
            "sha": "8ed4470fc4aa70fe70502af0548fd7e5d6a529bc",
            "date": "2025-01-14T18:10:31Z",
            "author_login": "fitzgen"
          },
          {
            "sha": "75f7b2bed7b2c4360a1a01fdfdb2cfaac9b0b6ae",
            "date": "2025-01-14T15:49:21Z",
            "author_login": "nilsmartel"
          },
          {
            "sha": "e4fd50d1e27f3ba3d4757b85547d55f585d446f9",
            "date": "2025-01-14T01:28:53Z",
            "author_login": "alexcrichton"
          },
          {
            "sha": "8659e11c4ad12512defd6213de0a9d73f8ae6732",
            "date": "2025-01-14T00:47:04Z",
            "author_login": "fitzgen"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 9.9,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H",
    "cwe_id": "CWE-125",
    "description": "wasmtime is a fast and secure runtime for WebAssembly. In affected versions wasmtime's code generator, Cranelift, has a bug on x86_64 targets where address-mode computation mistakenly would calculate a 35-bit effective address instead of WebAssembly's defined 33-bit effective address. This bug means that, with default codegen settings, a wasm-controlled load/store operation could read/write addresses up to 35 bits away from the base of linear memory. Due to this bug, however, addresses up to `0xffffffff * 8 + 0x7ffffffc = 36507222004 = ~34G` bytes away from the base of linear memory are possible from guest code. This means that the virtual memory 6G away from the base of linear memory up to ~34G away can be read/written by a malicious module. A guest module can, without the knowledge of the embedder, read/write memory in this region. The memory may belong to other WebAssembly instances when using the pooling allocator, for example. Affected embedders are recommended to analyze preexisting wasm modules to see if they're affected by the incorrect codegen rules and possibly correlate that with an anomalous number of traps during historical execution to locate possibly suspicious modules. The specific bug in Cranelift's x86_64 backend is that a WebAssembly address which is left-shifted by a constant amount from 1 to 3 will get folded into x86_64's addressing modes which perform shifts. For example `(i32.load (i32.shl (local.get 0) (i32.const 3)))` loads from the WebAssembly address `$local0 << 3`. When translated to Cranelift the `$local0 << 3` computation, a 32-bit value, is zero-extended to a 64-bit value and then added to the base address of linear memory. Cranelift would generate an instruction of the form `movl (%base, %local0, 8), %dst` which calculates `%base + %local0 << 3`. The bug here, however, is that the address computation happens with 64-bit values, where the `$local0 << 3` computation was supposed to be truncated to a a 32-bit value. This means that `%local0`, which can use up to 32-bits for an address, gets 3 extra bits of address space to be accessible via this `movl` instruction. The fix in Cranelift is to remove the erroneous lowering rules in the backend which handle these zero-extended expression. The above example is then translated to `movl %local0, %temp; shl $3, %temp; movl (%base, %temp), %dst` which correctly truncates the intermediate computation of `%local0 << 3` to 32-bits inside the `%temp` register which is then added to the `%base` value. Wasmtime version 4.0.1, 5.0.1, and 6.0.1 have been released and have all been patched to no longer contain the erroneous lowering rules. While updating Wasmtime is recommended, there are a number of possible workarounds that embedders can employ to mitigate this issue if updating is not possible. Note that none of these workarounds are on-by-default and require explicit configuration: 1. The `Config::static_memory_maximum_size(0)` option can be used to force all accesses to linear memory to be explicitly bounds-checked. This will perform a bounds check separately from the address-mode computation which correctly calculates the effective address of a load/store. Note that this can have a large impact on the execution performance of WebAssembly modules. 2. The `Config::static_memory_guard_size(1 << 36)` option can be used to greatly increase the guard pages placed after linear memory. This will guarantee that memory accesses up-to-34G away are guaranteed to be semantically correct by reserving unmapped memory for the instance. Note that this reserves a very large amount of virtual memory per-instances and can greatly reduce the maximum number of concurrent instances being run. 3. If using a non-x86_64 host is possible, then that will also work around this bug. This bug does not affect Wasmtime's or Cranelift's AArch64 backend, for example.\n",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-03-08T20:15:09.583",
    "last_modified": "2024-11-21T07:51:37.430",
    "fix_date": "2023-03-08T19:00:40Z"
  },
  "references": [
    {
      "url": "https://docs.rs/wasmtime/latest/wasmtime/struct.Config.html#method.static_memory_guard_size",
      "source": "security-advisories@github.com",
      "tags": [
        "Product"
      ]
    },
    {
      "url": "https://docs.rs/wasmtime/latest/wasmtime/struct.Config.html#method.static_memory_maximum_size",
      "source": "security-advisories@github.com",
      "tags": [
        "Product"
      ]
    },
    {
      "url": "https://github.com/bytecodealliance/wasmtime/commit/63fb30e4b4415455d47b3da5a19d79c12f4f2d1f",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/bytecodealliance/wasmtime/security/advisories/GHSA-ff4p-7xrq-q5r8",
      "source": "security-advisories@github.com",
      "tags": [
        "Mitigation",
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://groups.google.com/a/bytecodealliance.org/g/sec-announce/c/Mov-ItrNJsQ",
      "source": "security-advisories@github.com",
      "tags": [
        "Mailing List",
        "Release Notes",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://docs.rs/wasmtime/latest/wasmtime/struct.Config.html#method.static_memory_guard_size",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Product"
      ]
    },
    {
      "url": "https://docs.rs/wasmtime/latest/wasmtime/struct.Config.html#method.static_memory_maximum_size",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Product"
      ]
    },
    {
      "url": "https://github.com/bytecodealliance/wasmtime/commit/63fb30e4b4415455d47b3da5a19d79c12f4f2d1f",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/bytecodealliance/wasmtime/security/advisories/GHSA-ff4p-7xrq-q5r8",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mitigation",
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://groups.google.com/a/bytecodealliance.org/g/sec-announce/c/Mov-ItrNJsQ",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List",
        "Release Notes",
        "Vendor Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:05:06.821900",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "wasmtime",
    "owner": "bytecodealliance",
    "created_at": "2017-08-29T14:01:55Z",
    "updated_at": "2025-01-14T09:40:55Z",
    "pushed_at": "2025-01-14T01:52:50Z",
    "size": 111616,
    "stars": 15702,
    "forks": 1345,
    "open_issues": 787,
    "watchers": 15702,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [
      "main",
      "release-0.32.0",
      "release-0.33.0",
      "release-0.34.0",
      "release-0.35.0",
      "release-0.36.0",
      "release-0.37.0",
      "release-0.38.0",
      "release-0.39.0",
      "release-0.40.0",
      "release-1.0.0",
      "release-2.0.0",
      "release-3.0.0",
      "release-4.0.0",
      "release-5.0.0",
      "release-6.0.0",
      "release-7.0.0",
      "release-8.0.0",
      "release-9.0.0"
    ],
    "languages": {
      "Rust": 19224087,
      "WebAssembly": 6773216,
      "Common Lisp": 1793054,
      "C": 257019,
      "JavaScript": 24116,
      "Shell": 23820,
      "C++": 21050,
      "CMake": 7205,
      "OCaml": 6903,
      "Assembly": 4165,
      "Dockerfile": 2564,
      "Makefile": 1432,
      "CSS": 303
    },
    "commit_activity": {
      "total_commits_last_year": 1586,
      "avg_commits_per_week": 30.5,
      "days_active_last_year": 278
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "apache-2.0"
    },
    "collected_at": "2025-01-14T13:32:42.127815"
  }
}