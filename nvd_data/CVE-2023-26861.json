{
  "cve_id": "CVE-2023-26861",
  "github_data": {
    "repository": "VivaPayments/API",
    "fix_commit": "c1169680508c6e144d3e102ebdb257612e4cd84a",
    "related_commits": [
      "c1169680508c6e144d3e102ebdb257612e4cd84a",
      "c1169680508c6e144d3e102ebdb257612e4cd84a"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "c1169680508c6e144d3e102ebdb257612e4cd84a",
      "commit_date": "2022-10-19T08:17:11Z",
      "author": {
        "login": "cmitsis-dev",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Remove Old Prestashop Smart checkout",
        "length": 36,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 2543,
        "additions": 0,
        "deletions": 2543
      },
      "files": [
        {
          "filename": "Plugins/prestashop/prestashop1.5-1.6/vivawallet/access.png",
          "status": "removed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "Plugins/prestashop/prestashop1.5-1.6/vivawallet/config.xml",
          "status": "removed",
          "additions": 0,
          "deletions": 12,
          "patch": "@@ -1,12 +0,0 @@\n-<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n-        <module>\n-            <name>vivawallet</name>\n-            <displayName><![CDATA[Vivawallet]]></displayName>\n-            <version><![CDATA[1]]></version>\n-            <description><![CDATA[Accept payments with Vivawallet]]></description>\n-            <author><![CDATA[vivawallet.com]]></author>\n-            <tab><![CDATA[payments_gateways]]></tab>\n-            <is_configurable>1</is_configurable>\n-            <need_instance>1</need_instance>\n-\t\t\t<limited_countries></limited_countries>\n-        </module>\n\\ No newline at end of file"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.5-1.6/vivawallet/dollar.gif",
          "status": "removed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "Plugins/prestashop/prestashop1.5-1.6/vivawallet/fail.php",
          "status": "removed",
          "additions": 0,
          "deletions": 66,
          "patch": "@@ -1,66 +0,0 @@\n-<?php\r\n-if(isset($_GET['s']) && $_GET['s']!=''){\r\n-include(dirname(__FILE__).'/../../config/config.inc.php');\r\n-if(substr(_PS_VERSION_,2,1) < 5){\r\n-include(dirname(__FILE__).'/../../header.php');\r\n-}\r\n-include(dirname(__FILE__).'/vivawallet.php');\r\n-\r\n-$vivawallet = new vivawallet();\r\n-$errors = '';\r\n-\r\n-  $OrderCode = addslashes($_GET['s']);\r\n-  \r\n-  $update_query = \"update vivawallet_data set order_state='F' where OrderCode='\".$OrderCode.\"'\";\r\n-  $update = Db::getInstance()->execute($update_query);\r\n-\r\n-  $transtat_query = \"select * from vivawallet_data where OrderCode='\".$OrderCode.\"' ORDER BY id DESC\";\r\n-  $transtat = Db::getInstance()->executeS($transtat_query, $array = true, $use_cache = 0);\r\n-\r\n-  $secure_key = $transtat[0]['secure_key'];\r\n-  $cartid = $transtat[0]['ref'];\r\n-  \r\n-if(substr(_PS_VERSION_,2,1) >= 5){\r\n-   Context::getContext()->cart = new Cart((int)$cart_id);\r\n-   Context::getContext()->cookie->id_cart = (int)$cart_id;\r\n-   \r\n-   $cart = new Cart((int)$cart_id);\r\n-   \r\n-\t if (Validate::isLoadedObject($cart)) {\r\n-\t\t\r\n-\t\t$shop = new Shop((int)$cart->id_shop);\r\n-\t\tif (Validate::isLoadedObject($shop)) {\r\n-\t\t Context::getContext()->shop = $shop;\r\n-\t\t}\r\n-\t\t\r\n-\t\t$customer = new Customer((int)$cart->id_customer);\r\n-\t\t\r\n-\t\tif (Validate::isLoadedObject($customer)) {\r\n-\t\t\t$customer->logged = 1;\r\n-\t\t\tContext::getContext()->customer = $customer;\r\n-\t\t\tContext::getContext()->cookie->id_customer = (int)$customer->id;\r\n-\t\t\tContext::getContext()->cookie->customer_lastname = $customer->lastname;\r\n-\t\t\tContext::getContext()->cookie->customer_firstname = $customer->firstname;\r\n-\t\t\tContext::getContext()->cookie->logged = 1;\r\n-\t\t\tContext::getContext()->cookie->check_cgv = 1;\r\n-\t\t\tContext::getContext()->cookie->is_guest = $customer->isGuest();\r\n-\t\t\tContext::getContext()->cookie->passwd = $customer->passwd;\r\n-\t\t\tContext::getContext()->cookie->email = $customer->email;\r\n-\t\t\t$secure_key = $customer->secure_key;\r\n-\t\t}\r\n-\t  }\r\n- \t}\r\n-\r\n-  $errors = 'Transaction failed or cancelled';\r\n-\r\n-   $vivawallet->validateOrder((int)$cartid, _PS_OS_ERROR_, 0, $vivawallet->displayName, $errors.'<br />', array(), NULL, false, $secure_key, $shop);  \r\n-\r\n-   if(substr(_PS_VERSION_,2,1) > 4){\r\n-   Tools::redirect('index.php?controller=order-confirmation&id_cart='.$cartid.'&id_module='.$vivawallet->id.'&id_order='.$vivawallet->currentOrder.'&key='.$secure_key);\r\n-   } else {\r\n-   Tools::redirectLink(__PS_BASE_URI__.\"order-confirmation.php?id_cart={$cartid}&id_module={$vivawallet->id}&id_order={$vivawallet->currentOrder}&key={$secure_key}\");\r\n-   }\r\n-}  else {\r\n-echo 'No valid input received.';\r\n-}     \r\n-?>\n\\ No newline at end of file"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.5-1.6/vivawallet/install.sql",
          "status": "removed",
          "additions": 0,
          "deletions": 15,
          "patch": "@@ -1,15 +0,0 @@\n-DROP TABLE IF EXISTS `vivawallet_data`;\n-CREATE TABLE IF NOT EXISTS `vivawallet_data` (\n-  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,\n-  `secure_key` varchar(150) DEFAULT NULL,\n-  `OrderCode` varchar(255) DEFAULT NULL,\n-  `ErrorCode` varchar(50) DEFAULT NULL,\n-  `ErrorText` varchar(255) DEFAULT NULL,\n-  `Timestamp` datetime DEFAULT NULL,\n-  `ref` varchar(150) DEFAULT NULL,\n-  `total_cost` int(11) DEFAULT NULL,\n-  `currency` char(3) DEFAULT NULL,\n-  `order_state` char(1) DEFAULT NULL,\n-  `sessionid` varchar(50) DEFAULT NULL,\n-  PRIMARY KEY (`id`)\n-) ENGINE=InnoDB DEFAULT CHARSET=utf8 AUTO_INCREMENT=1;"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.5-1.6/vivawallet/logo.gif",
          "status": "removed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "Plugins/prestashop/prestashop1.5-1.6/vivawallet/ok.gif",
          "status": "removed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "Plugins/prestashop/prestashop1.5-1.6/vivawallet/pay.php",
          "status": "removed",
          "additions": 0,
          "deletions": 29,
          "patch": "@@ -1,29 +0,0 @@\n-<?php\n-include(dirname(__FILE__).'/../../config/config.inc.php');\n-include(dirname(__FILE__).'/../../init.php');\n-include(dirname(__FILE__).'/vivawallet.php');\n-$vivawallet = new vivawallet();\n-\n-\n-?>\n-<noscript>\n-<p><?php echo  $vivawallet->l('In case you are not redirected to the payment page within 10 seconds, click the \"Pay Now\" button below.'); ?></p>\n-</noscript>\n-<form id=\"payment_form\" name=\"payment_form\" action=\"<?php echo $_POST['VivawalletUrl']; ?>\" method=\"get\">\n-\n-<?php\n-\tforeach( $_POST as $name => $value ) {\n-\tif($name !='VivawalletUrl'){\n-\t\techo '<input type=\"hidden\" name=\"'.$name.'\" value=\"'.$value.'\" />';\n-\t\t}\n-\t}\n-?>\n-<noscript>\n-<input type=\"submit\" value=\"<?php echo $vivawallet->l('Pay Now'); ?>\" />\n-</noscript>\n-</form>\n-<script type=\"text/javascript\">\n-\t<!--\n-\tdocument.getElementById('payment_form').submit();\n-\t//-->\n-</script>\n\\ No newline at end of file"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.5-1.6/vivawallet/payment.php",
          "status": "removed",
          "additions": 0,
          "deletions": 19,
          "patch": "@@ -1,19 +0,0 @@\n-<?php\n-/* SSL Management */\n-$useSSL = true;\n-\n-include(dirname(__FILE__).'/../../config/config.inc.php');\n-include(dirname(__FILE__).'/../../header.php');\n-include(dirname(__FILE__).'/vivawallet.php');\n-\n-if (!$cookie->isLogged(true))\n-\tTools::redirect('authentication.php?back=order.php');\n-elseif (!Customer::getAddressesTotalById((int)($cookie->id_customer)))\n-\tTools::redirect('address.php?back=order.php?step=1');\n-\t\n-$vivawallet = new vivawallet();\n-echo $vivawallet->execPayment($cart);\n-\n-include_once(dirname(__FILE__).'/../../footer.php');\n-\n-?>"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.5-1.6/vivawallet/payment.tpl",
          "status": "removed",
          "additions": 0,
          "deletions": 12,
          "patch": "@@ -1,12 +0,0 @@\n-<p class=\"payment_module clearfix\">\n-\t\t<span style=\"float:left;\"><img src=\"{$module_dir}vivawallet.gif\" alt=\"{l s='Pay by Vivawallet' mod='vivawallet'}\"/></span>\n-\t\t<span>{l s='Pay with Vivawallet' mod='vivawallet'}<br />{l s='Pay safely and quickly on the next page' mod='vivawallet'}</span>\n-</p>\n-<form name=\"vivawallet_confirmation\" action=\"{$base_dir_ssl}{$InstalmentUrl}\" method=\"post\">\n-    {$WbInstalLogic}\n-</form>\n-        \n-<form name=\"vivawallet_confirmation\" action=\"{$VivawalletUrl}\" method=\"get\">\n-    <input type=\"hidden\" name=\"Ref\" value=\"{$Ref}\" />\n-    <input style=\"{$WbSubmit}\" type=\"submit\" value=\"{l s='Pay Now' mod='vivawallet'}\" class=\"exclusive_large\" />\n-</form>\n\\ No newline at end of file"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.5-1.6/vivawallet/payment_eu.tpl",
          "status": "removed",
          "additions": 0,
          "deletions": 3,
          "patch": "@@ -1,3 +0,0 @@\n-<form id=\"vivawallet_payment_form\" name=\"vivawallet_confirmation\" action=\"{$VivawalletUrl}\" data-ajax=\"false\" title=\"{l s='Pay with Vivawallet' mod='vivawallet'}\" method=\"get\">\n-    <input type=\"hidden\" name=\"Ref\" value=\"{$Ref}\" />\n-</form>\n\\ No newline at end of file"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.5-1.6/vivawallet/payment_execution.tpl",
          "status": "removed",
          "additions": 0,
          "deletions": 31,
          "patch": "@@ -1,31 +0,0 @@\n-{capture name=path}{l s='Shipping'}{/capture}\n-\n-    <div id=\"cms_block\">\n-\t<h2>{l s='Vivawallet Payment Order Summary' mod='vivawallet'}</h2>\n-    {l s='Buy On-Line with Credit or Debit Card via Vivawallet.' mod='vivawallet'}\n-    </div>\n-\n-{assign var='current_step' value='payment'}\n-{include file=\"$tpl_dir./order-steps.tpl\"}\n-\n-\n-\n-<p>\n-\t<img src=\"{$this_path}vivawallet.gif\" alt=\"{l s='Vivawallet' mod='vivawallet'}\" style=\"float:left; margin: 0px 10px 5px 0px;\" />\n-\t{l s='You have chosen to pay by Vivawallet.' mod='vivawallet'}\n-</p>\n-<p>\n-\t<b>{l s='Please confirm your order by clicking \\'I confirm my order\\'' mod='vivawallet'}.</b>\n-</p>\n-\n-\n-<p align=\"right\"><a href=\"{$base_dir_ssl}order.php?step=3\" class=\"button_large\">{l s='Other payment methods' mod='vivawallet'}</a></p>\n-\n-<form name=\"vivawallet_confirmation\" action=\"{$this_path}payment.php\" method=\"post\" />\n-    {$WbInstalLogic}\n-</form>\n-        \n-<form name=\"vivawallet_confirmation\" action=\"{$VivawalletUrl}\" method=\"get\" />\n-    <input type=\"hidden\" name=\"Ref\" value=\"{$Ref}\" />\n-    <input style=\"{$WbSubmit}\" type=\"submit\" value=\"{l s='I confirm my order' mod='vivawallet'}\" class=\"exclusive_large\" />\n-</form>\n\\ No newline at end of file"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.5-1.6/vivawallet/payment_noinstall.tpl",
          "status": "removed",
          "additions": 0,
          "deletions": 18,
          "patch": "@@ -1,18 +0,0 @@\n-<script>\n-function submyform() {\n-        document.getElementById(\"vivawallet_payment_form\").submit();\n-}\n-</script>\n-\n-<p class=\"payment_module\">\n-\t<a title=\"{l s='Pay with Vivawallet' mod='vivawallet'}\" class=\"bankwire\" href=\"javascript:submyform()\" rel=\"nofollow\">\n-\t\t<img src=\"{$module_dir}vivawallet.gif\" alt=\"{l s='Pay with Vivawallet' mod='vivawallet'}\" style=\"float:left;\" />\n-\t\t<br />{l s='Pay with Vivawallet' mod='vivawallet'}\n-\t\t<br />{l s='Pay safely and quickly on the next page' mod='vivawallet'}\n-\t\t<br style=\"clear:both;\" />\n-\t</a>\n-</p>\n-\n-<form name=\"vivawallet_confirmation\" action=\"{$VivawalletUrl}\" method=\"get\" id=\"vivawallet_payment_form\">\n-    <input type=\"hidden\" name=\"Ref\" value=\"{$Ref}\" />\n-</form>\n\\ No newline at end of file"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.5-1.6/vivawallet/payment_noinstall_eu.tpl",
          "status": "removed",
          "additions": 0,
          "deletions": 3,
          "patch": "@@ -1,3 +0,0 @@\n-<form id=\"vivawallet_payment_form\" name=\"vivawallet_confirmation\" action=\"{$VivawalletUrl}\" data-ajax=\"false\" title=\"{l s='Pay with Vivawallet' mod='vivawallet'}\" method=\"get\">\n-    <input type=\"hidden\" name=\"Ref\" value=\"{$Ref}\" />\n-</form>\n\\ No newline at end of file"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.5-1.6/vivawallet/payment_return.tpl",
          "status": "removed",
          "additions": 0,
          "deletions": 9,
          "patch": "@@ -1,9 +0,0 @@\n-{if $status == 'ok'}\n-\t<p>{l s='Your order on' mod='vivawallet'} <span class=\"bold\">{$shop_name}</span> {l s='is complete.' mod='vivawallet'}\n-\t\t<br /><br />{l s='For any questions or for further information, please contact us.' mod='vivawallet'}\n-\t</p>\n-{else}\n-\t<p class=\"warning\">\n-\t\t{l s='We noticed a problem with your transaction. If you think this is an error, please contact us.' mod='vivawallet'} \n-\t</p>\n-{/if}"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.5-1.6/vivawallet/readme.txt",
          "status": "removed",
          "additions": 0,
          "deletions": 1,
          "patch": "@@ -1 +0,0 @@\n-"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.5-1.6/vivawallet/reset_eu.gif",
          "status": "removed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "Plugins/prestashop/prestashop1.5-1.6/vivawallet/success.php",
          "status": "removed",
          "additions": 0,
          "deletions": 77,
          "patch": "@@ -1,77 +0,0 @@\n-<?php\r\n-if(isset($_GET['s']) && $_GET['s']!=''){\r\n-include(dirname(__FILE__).'/../../config/config.inc.php');\r\n-if(substr(_PS_VERSION_,2,1) < 5){\r\n-include(dirname(__FILE__).'/../../header.php');\r\n-}\r\n-include(dirname(__FILE__).'/vivawallet.php');\r\n-\r\n-$vivawallet = new vivawallet();\r\n-$errors = '';\r\n-\r\n-  $OrderCode = addslashes($_GET['s']);\r\n-  \r\n-  $update_query = \"update vivawallet_data set order_state='P' where OrderCode='\".$OrderCode.\"'\";\r\n-  $update = Db::getInstance()->execute($update_query);\r\n-\r\n-  $transtat_query = \"select * from vivawallet_data where OrderCode='\".$OrderCode.\"' ORDER BY id DESC\";\r\n-  $transtat = Db::getInstance()->executeS($transtat_query, $array = true, $use_cache = 0);\r\n-\r\n-  $currency_payment = Db::getInstance()->getValue('SELECT id_currency FROM '._DB_PREFIX_.'currency WHERE iso_code = \"'.$transtat[0]['currency'].'\"');\r\n-  $total = floatval(number_format(($transtat[0]['total_cost'] / 100), 2, '.', ''));\r\n-  $secure_key = $transtat[0]['secure_key'];\r\n-  $cartid = $transtat[0]['ref'];\r\n-  \r\n-   if(substr(_PS_VERSION_,2,1) >= 5){\r\n-   Context::getContext()->cart = new Cart((int)$cart_id);\r\n-   Context::getContext()->cookie->id_cart = (int)$cart_id;\r\n-   \r\n-   $cart = new Cart((int)$cart_id);\r\n-   \r\n-\t if (Validate::isLoadedObject($cart)) {\r\n-\t\t$shop = new Shop((int)$cart->id_shop);\r\n-\t\tif (Validate::isLoadedObject($shop)) {\r\n-\t\t Context::getContext()->shop = $shop;\r\n-\t\t}\r\n-\t\t\r\n-\t\t$customer = new Customer((int)$cart->id_customer);\r\n-\t\tif (Validate::isLoadedObject($customer)) {\r\n-\t\t\t$customer->logged = 1;\r\n-\t\t\tContext::getContext()->customer = $customer;\r\n-\t\t\tContext::getContext()->cookie->id_customer = (int)$customer->id;\r\n-\t\t\tContext::getContext()->cookie->customer_lastname = $customer->lastname;\r\n-\t\t\tContext::getContext()->cookie->customer_firstname = $customer->firstname;\r\n-\t\t\tContext::getContext()->cookie->logged = 1;\r\n-\t\t\tContext::getContext()->cookie->check_cgv = 1;\r\n-\t\t\tContext::getContext()->cookie->is_guest = $customer->isGuest();\r\n-\t\t\tContext::getContext()->cookie->passwd = $customer->passwd;\r\n-\t\t\tContext::getContext()->cookie->email = $customer->email;\r\n-\t\t\t$secure_key = $customer->secure_key;\r\n-\t\t}\r\n-\t  }\r\n-\t  if ((int)Context::getContext()->cookie->id_cart > 0) {\r\n-\t\t\t\tContext::getContext()->cookie->__unset('id_cart');\r\n-\t  }\r\n- \t}\t\r\n-\t\r\n-  \r\n-  $details = array(\r\n-\t\t\t\t'id_transaction' => $OrderCode,\r\n-\t\t\t\t'transaction_id' => $OrderCode\r\n-\t\t\t);\r\n-\r\n-   $vivawallet->validateOrder((int)$cartid, _PS_OS_PAYMENT_, $total, $vivawallet->displayName, 'OrderCode: '.$OrderCode,$details,(int)$currency_payment,false,$secure_key, $shop);\r\n-   $currency = new Currency(intval(isset($_POST['currency_payement']) ? $_POST['currency_payement'] : $cookie->id_currency));\r\n-   $order = new Order($vivawallet->currentOrder);\r\n-   \r\n-//tommodps15 - redirect to controller\r\n-   if(substr(_PS_VERSION_,2,1) > 4){\r\n-   Tools::redirect('index.php?controller=order-confirmation&id_cart='.$cartid.'&id_module='.$vivawallet->id.'&id_order='.$vivawallet->currentOrder.'&key='.$secure_key);\r\n-   } else {\r\n-   Tools::redirectLink(__PS_BASE_URI__.\"order-confirmation.php?id_cart={$cartid}&id_module={$vivawallet->id}&id_order={$vivawallet->currentOrder}&key={$secure_key}\");\r\n-   }\r\n-\r\n-} else {\r\n-echo 'No valid input received.';\r\n-}\r\n-?>\n\\ No newline at end of file"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.5-1.6/vivawallet/translations/index.php",
          "status": "removed",
          "additions": 0,
          "deletions": 35,
          "patch": "@@ -1,35 +0,0 @@\n-<?php\n-/*\n-* 2007-2014 PrestaShop\n-*\n-* NOTICE OF LICENSE\n-*\n-* This source file is subject to the Academic Free License (AFL 3.0)\n-* that is bundled with this package in the file LICENSE.txt.\n-* It is also available through the world-wide-web at this URL:\n-* http://opensource.org/licenses/afl-3.0.php\n-* If you did not receive a copy of the license and are unable to\n-* obtain it through the world-wide-web, please send an email\n-* to license@prestashop.com so we can send you a copy immediately.\n-*\n-* DISCLAIMER\n-*\n-* Do not edit or add to this file if you wish to upgrade PrestaShop to newer\n-* versions in the future. If you wish to customize PrestaShop for your\n-* needs please refer to http://www.prestashop.com for more information.\n-*\n-*  @author PrestaShop SA <contact@prestashop.com>\n-*  @copyright  2007-2014 PrestaShop SA\n-*  @license    http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)\n-*  International Registered Trademark & Property of PrestaShop SA\n-*/\n-\t\t\t\t    \t\n-header(\"Expires: Mon, 26 Jul 1997 05:00:00 GMT\");\n-header(\"Last-Modified: \".gmdate(\"D, d M Y H:i:s\").\" GMT\");\n-\t\t\t\t\t\t\n-header(\"Cache-Control: no-store, no-cache, must-revalidate\");\n-header(\"Cache-Control: post-check=0, pre-check=0\", false);\n-header(\"Pragma: no-cache\");\n-\t\t\t\t\t\t\n-header(\"Location: ../\");\n-exit;\n\\ No newline at end of file"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.5-1.6/vivawallet/vivawallet.gif",
          "status": "removed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "Plugins/prestashop/prestashop1.5-1.6/vivawallet/vivawallet.php",
          "status": "removed",
          "additions": 0,
          "deletions": 827,
          "patch": "@@ -1,827 +0,0 @@\n-<?php\r\n-class vivawallet extends PaymentModule\r\n-{\r\n-\tconst INSTALL_SQL_FILE = 'install.sql';\r\n-\r\n-\tprivate $_html = '';\r\n-\tprivate $_postErrors = array();\r\n-\r\n-\tpublic function __construct()\r\n-\t{\r\n-\t\tif(substr(_PS_VERSION_,2,1) > 4){\r\n-\t\tif (empty(Context::getContext()->link))\r\n-\t\tContext::getContext()->link = new Link();\r\n-\t\t}\r\n-\r\n-\t\t$this->name = 'vivawallet';\r\n-\t\t$this->displayName = 'Vivawallet';\r\n-\t\t$this->tab = 'payments_gateways';\r\n-\t\t$this->author = 'Viva Wallet';\r\n-\t\t$this->version = '1.6.8';\r\n-\t\t//hookDisplayPaymentEU - added compatible\r\n-\t\t$this->is_eu_compatible = 1;\r\n-\r\n-\t\t$config = Configuration::getMultiple(array('VIVAWALLET_MERCHANTID','VIVAWALLET_MERCHANTPASS','VIVAWALLET_SOURCE','VIVAWALLET_INSTAL','VIVAWALLET_URL','VIVAWALLET_CURRENCIES'));\r\n-\r\n-\r\n-\r\n-\t\tif (isset($config['VIVAWALLET_MERCHANTID']))\r\n-\t\t\t$this->MerchantId = $config['VIVAWALLET_MERCHANTID'];\r\n-\t\tif (isset($config['VIVAWALLET_MERCHANTPASS']))\r\n-\t\t\t$this->MerchantPass = $config['VIVAWALLET_MERCHANTPASS'];\r\n-\t\tif (isset($config['VIVAWALLET_SOURCE']))\r\n-\t\t\t$this->Source = $config['VIVAWALLET_SOURCE'];\r\n-\t\tif (isset($config['VIVAWALLET_INSTAL']))\r\n-\t\t\t$this->wb_instal = $config['VIVAWALLET_INSTAL'];\r\n-\t\tif (isset($config['VIVAWALLET_URL']))\r\n-\t\t\t$this->wb_url = $config['VIVAWALLET_URL'];\r\n-\t\tif (isset($config['VIVAWALLET_CURRENCIES']))\r\n-\t\t\t$this->currencies = $config['VIVAWALLET_CURRENCIES'];\r\n-\r\n-\t\tparent::__construct();\r\n-\r\n-\t\t$this->page = basename(__FILE__, '.php');\r\n-\t\t$this->description = $this->l('Accept payments with Vivawallet');\r\n-\r\n-\t\tif (!isset($this->MerchantId) OR !isset($this->MerchantPass))\r\n-\t\t\t$this->warning = $this->l('your Vivawallet settings must be configured in order to use this module correctly');\r\n-\t\tif (!Configuration::get('VIVAWALLET_CURRENCIES'))\r\n-\t\t{\r\n-\t\t\t$currencies = Currency::getCurrencies();\r\n-\t\t\t$authorized_currencies = array();\r\n-\t\t\tforeach ($currencies as $currency)\r\n-\t\t\t\t$authorized_currencies[] = $currency['id_currency'];\r\n-\t\t\tConfiguration::updateValue('VIVAWALLET_CURRENCIES', implode(',', $authorized_currencies));\r\n-\t\t}\r\n-\t}\r\n-\r\n-\r\n-\tfunction install()\r\n-\t{\r\n-\t\t$currencies = Currency::getCurrencies();\r\n-\t\t$authorized_currencies = array();\r\n-\t\tforeach ($currencies as $currency)\r\n-\t\t$authorized_currencies[] = $currency['id_currency'];\r\n-\r\n-\t\t// SQL Table\r\n-\t\tif (!file_exists(dirname(__FILE__).'/'.self::INSTALL_SQL_FILE))\r\n-\t\t\tdie('error 1');\r\n-\t\telseif (!$sql = file_get_contents(dirname__FILE__).'/'.self::INSTALL_SQL_FILE))\r\n-\t\t\tdie('error 2');\r\n-\t\t$sql = preg_split(\"/;\\s*[\\r\\n]+/\", $sql);\r\n-\t\tforeach ($sql as $query)\r\n-\t\t\tif ($query AND sizeof($query) AND !Db::getInstance()->Execute(trim($query)))\r\n-\t\t\t\treturn false;\r\n-\r\n-\t\t//hookDisplayPaymentEU - added hook\r\n-\t\tif (!parent::install()\r\n-\t\t\tOR !Configuration::updateValue('VIVAWALLET_CURRENCIES', implode(',', $authorized_currencies))\r\n-\t\t\tOR !$this->registerHook('payment')\r\n-\t\t\tOR !$this->registerHook('displayPaymentEU')\r\n-\t\t\tOR !$this->registerHook('paymentReturn'))\r\n-\t\t\treturn false;\r\n-\t\treturn true;\r\n-\t}\r\n-\r\n-\r\n-\r\n-\tfunction uninstall()\r\n-\t{\r\n-\t\tif (!Configuration::deleteByName('VIVAWALLET_MERCHANTID')\r\n-\t\t\tOR !Configuration::deleteByName('VIVAWALLET_MERCHANTPASS')\r\n-\t\t\tOR !Configuration::deleteByName('VIVAWALLET_INSTAL')\r\n-\t\t\tOR !Configuration::deleteByName('VIVAWALLET_URL')\r\n-\t\t    OR !Configuration::deleteByName('VIVAWALLET_SOURCE')\r\n-\t\t\tOR !Configuration::deleteByName('VIVAWALLET_CURRENCIES')\r\n-\t\t\tOR !parent::uninstall())\r\n-\t\t\treturn false;\r\n-\t\treturn true;\r\n-\t}\r\n-\r\n-\r\n-\tfunction getContent()\r\n-\t{\r\n-\t\t$this->_html = '<h2>'.$this->displayName.'</h2>';\r\n-\r\n-\t\tif (!empty($_POST))\r\n-\t\t{\r\n-\r\n-\t\t\tif ($wb_instal = Tools::getValue('vivawallet_wb_instal'))\r\n-\t\t\t\tConfiguration::updateValue('VIVAWALLET_INSTAL', $wb_instal);\r\n-\t\t\tif ($wb_url = Tools::getValue('vivawallet_wb_url'))\r\n-\t\t\t\tConfiguration::updateValue('VIVAWALLET_URL', $wb_url);\r\n-\t\t\tif ($MerchantId = Tools::getValue('vivawallet_MerchantId'))\r\n-\t\t\t\tConfiguration::updateValue('VIVAWALLET_MERCHANTID', $MerchantId);\r\n-\t\t\tif ($MerchantPass = Tools::getValue('vivawallet_MerchantPass'))\r\n-\t\t\t\tConfiguration::updateValue('VIVAWALLET_MERCHANTPASS', $MerchantPass);\r\n-\t\t\tif ($Source = Tools::getValue('vivawallet_Source'))\r\n-\t\t\t\tConfiguration::updateValue('VIVAWALLET_SOURCE', $Source);\r\n-\r\n-\t\t\t$this->_postValidation();\r\n-\t\t\tif (!sizeof($this->_postErrors))\r\n-\t\t\t\t$this->_postProcess();\r\n-\t\t\telse\r\n-\t\t\t\tforeach ($this->_postErrors AS $err)\r\n-\t\t\t\t\t$this->_html .= \"<div class='alert error'>{$err}</div>\";\r\n-\t\t}\r\n-\t\telse\r\n-\t\t{\r\n-\t\t\t$this->_html .= \"<br />\";\r\n-\t\t}\r\n-\r\n-\t\t$this->_displayvivawallet();\r\n-\t\t$this->_displayForm();\r\n-\r\n-\t\treturn $this->_html;\r\n-\t}\r\n-\r\n-\r\n-\r\n-\tfunction hookPayment($params)\r\n-\t{\r\n-\t\tglobal $smarty, $cart, $cookie;\r\n-\r\n-\t\t$currency = Currency::getCurrencyInstance($cart->id_currency);\r\n-\r\n-\t\t$delivery = new Address(intval($cart->id_address_delivery));\r\n-\t\t$invoice = new Address(intval($cart->id_address_invoice));\r\n-\t\t$customer = new Customer(intval($cart->id_customer));\r\n-\r\n-\t\t$currencies = $this->getCurrency((int)$cart->id_currency);\r\n-\t\t$authorized_currencies = array_flip(explode(',', $this->currencies));\r\n-        $currencies_used = array();\r\n-\r\n-\r\n-\t  //currency correction\r\n-\t  $authorized_currencies = explode(\",\", $this->currencies);\r\n-\t  if(in_array((int)$currency->id, $authorized_currencies)){\r\n-\t   $dest_currency['iso_code'] = $currency->iso_code;\r\n-\t   $currency_override = '';\r\n-\t  } else {\r\n-\t   $currency = Currency::getCurrencyInstance((int)$authorized_currencies[0]);\r\n-\t   $currencycart = Currency::getCurrencyInstance((int)$cart->id_currency);\r\n-\t   $dest_currency['iso_code'] = $currency->iso_code;\r\n-\t   $dest_currency['id'] = $currency->id;\r\n-\t   $currency_override = $currency->id;\r\n-\t  }\r\n-\r\n-      \t$currency_symbol ='';\r\n-\t\t$language_code ='';\r\n-\t\t$eb_total ='';\r\n-\t\t$ebfullname ='';\r\n-\r\n-\t\t$currency_symbol ='';\r\n-\t\tswitch ($dest_currency['iso_code']) {\r\n-\t\tcase 'EUR':\r\n-   \t\t$currency_symbol = 978;\r\n-   \t\tbreak;\r\n-\t\tcase 'GBP':\r\n-   \t\t$currency_symbol = 826;\r\n-   \t\tbreak;\r\n-\t\tcase 'BGN':\r\n-   \t\t$currency_symbol = 975;\r\n-   \t\tbreak;\r\n-\t\tcase 'RON':\r\n-   \t\t$currency_symbol = 946;\r\n-   \t\tbreak;\r\n-\t\tdefault:\r\n-        $currency_symbol = 978;\r\n-\t\t}\r\n-\r\n-\t\t$amount = $cart->getOrderTotal(true, Cart::BOTH);\r\n-\r\n-\t\t//currency correction\r\n-\t\tif (isset($currency_override) && $currency_override!='')\r\n-\t\t{\r\n-\t\t\t$amount = ($amount / $currencycart->conversion_rate) * $currency->conversion_rate;\r\n-\t\t\t$amount = Tools::convertPrice($amount, new Currency((int)($dest_currency['id'])));\r\n-\t\t}\r\n-\r\n-\t\t$wb_total = number_format($amount, 2, '.', '');\r\n-\t\t$wb_instal_total = round($amount);\r\n-\r\n-\t\t$wb_total_cents = number_format($amount, 2, '.', '')*100;\r\n-\t\t$wb_total_cents = round($wb_total_cents);\r\n-\r\n-            $products = $cart->getProducts();\r\n-\r\n-\r\n-\t\t\tforeach ($products as $key => $product)\r\n-\t\t\t{\r\n-\t\t\t\t$products[$key]['name'] = str_replace('\"', '\\'', $product['name']);\r\n-\t\t\t\t$products[$key]['name'] = htmlentities(utf8_decode($product['name']));\r\n-\t\t\t}\r\n-\r\n-\t\t\tif(strtolower(Language::getIsoById($cookie->id_lang))=='el' || strtolower(Language::getIsoById($cookie->id_lang))=='gr'){\r\n-\t\t\t\t$languagecode ='el-GR';\r\n-\t\t\t\t} else {\r\n-\t\t\t\t$languagecode ='en-US';\r\n-\t\t\t\t}\r\n-\r\n-\t$MerchantID =  Configuration::get('VIVAWALLET_MERCHANTID');\r\n-\t$Password =   html_entity_decode(Configuration::get('VIVAWALLET_MERCHANTPASS'));\r\n-\t$BaseUrl =  trim(Configuration::get('VIVAWALLET_URL'));\r\n-\r\n-\t$poststring['Amount'] = $wb_total_cents;\r\n-\t$poststring['RequestLang'] = $languagecode;\r\n-\t$poststring['Email'] = $customer->email;\r\n-\r\n-\tif(isset($_REQUEST['wperiod']) && $_REQUEST['wperiod'] > 0){\r\n-\t$poststring['MaxInstallments'] = $_REQUEST['wperiod'];\r\n-\t} else {\r\n-\t$poststring['MaxInstallments'] = '1';\r\n-\t}\r\n-\r\n-\t$poststring['MerchantTrns'] = $cart->id;\r\n-\t$poststring['SourceCode'] = Configuration::get('VIVAWALLET_SOURCE');\r\n-\t$poststring['CurrencyCode'] = $currency_symbol;\r\n-\t$poststring['PaymentTimeOut'] = '300';\r\n-\t$TmSecureKey = 'd2ViaXQuYnovbGljZW5zZS50eHQ='; // for extra encryption options\r\n-\r\n-\t$curl = curl_init($BaseUrl.\"/api/orders\");\r\n-\tcurl_setopt($curl, CURLOPT_PORT, 443);\r\n-\r\n-\t$postargs = 'Amount='.urlencode($poststring['Amount']).'&RequestLang='.urlencode($poststring['RequestLang']).'&Email='.urlencode($poststring['Email']).'&MaxInstallments='.urlencode($poststring['MaxInstallments']).'&MerchantTrns='.urlencode($poststring['MerchantTrns']).'&SourceCode='.urlencode($poststring['SourceCode']).'&CurrencyCode='.urlencode($poststring['CurrencyCode']).'&PaymentTimeOut=300&DisableIVR=true';\r\n-\r\n-\tcurl_setopt($curl, CURLOPT_POST, true);\r\n-\tcurl_setopt($curl, CURLOPT_POSTFIELDS, $postargs);\r\n-\tcurl_setopt($curl, CURLOPT_HEADER, false);\r\n-\tcurl_setopt($curl, CURLOPT_RETURNTRANSFER, true);\r\n-\tcurl_setopt($curl, CURLOPT_USERPWD, $MerchantID.':'.$Password);\r\n-\t$curlversion = curl_version();\r\n-\tif(!preg_match(\"/NSS/\" , $curlversion['ssl_version'])){\r\n-\tcurl_setopt($curl, CURLOPT_SSL_CIPHER_LIST, \"TLSv1\");\r\n-\t}\r\n-\r\n-\t// execute curl\r\n-\t$response = curl_exec($curl);\r\n-\r\n-\tif(curl_error($curl)){\r\n-\tcurl_setopt($curl, CURLOPT_PORT, 443);\r\n-\tcurl_setopt($curl, CURLOPT_POST, true);\r\n-\tcurl_setopt($curl, CURLOPT_POSTFIELDS, $postargs);\r\n-\tcurl_setopt($curl, CURLOPT_HEADER, false);\r\n-\tcurl_setopt($curl, CURLOPT_RETURNTRANSFER, true);\r\n-\tcurl_setopt($curl, CURLOPT_USERPWD, $MerchantID.':'.$Password);\r\n-\tcurl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);\r\n-\t$response = curl_exec($curl);\r\n-\t}\r\n-\r\n-\t\tcurl_close($curl);\r\n-\r\n-\t\ttry {\r\n-\t\tif (version_compare(PHP_VERSION, '5.3.99', '>=')) {\r\n-\t\t$resultObj=json_decode($response, false, 512, JSON_BIGINT_AS_STRING);\r\n-\t\t} else {\r\n-\t\t$response = preg_replace('/:\\s*(\\-?\\d+(\\.\\d+)?([e|E][\\-|\\+]\\d+)?)/', ': \"$1\"', $response, 1);\r\n-\t\t$resultObj = json_decode($response);\r\n-\t\t}\r\n-\t\t} catch( Exception $e ) {\r\n-\t\t\tthrow new Exception(\"Result is not a json object (\" . $e->getMessage() . \")\");\r\n-\t\t}\r\n-\r\n-\t\tif ($resultObj->ErrorCode==0){\t//success when ErrorCode = 0\r\n-\t\t$OrderCode = $resultObj->OrderCode;\r\n-\t\t$ErrorCode = $resultObj->ErrorCode;\r\n-\t\t$ErrorText = $resultObj->ErrorText;\r\n-\t\t}\r\n-\t\telse{\r\n-\t\t\tthrow new Exception(\"Unable to create order code (\" . $resultObj->ErrorText . \")\");\r\n-\t\t}\r\n-\r\n-\tif (version_compare(_PS_VERSION_, '1.5', '<')){\r\n-\t$seckey = $customer->secure_key;\r\n-\t} else {\r\n-\t$seckey = Context::getContext()->customer->secure_key;\r\n-\t}\r\n-\r\n-\t$tmquery = \"insert into vivawallet_data (secure_key, OrderCode, ErrorCode, ErrorText, Timestamp, ref, total_cost, currency, order_state) values ('\".$seckey.\"','\".$OrderCode.\"','\".$ErrorCode.\"','\".$ErrorText.\"',now(),'\".$cart->id.\"','\".$wb_total_cents.\"','\".$dest_currency['iso_code'].\"','I')\";\r\n-\tDb::getInstance()->execute($tmquery); //tommodps15\r\n-\r\n-\t$this->VivawalletUrl = $BaseUrl.'/web/newtransaction.aspx';\r\n-\r\n-\t\t$wbsubmitbutton = '';\r\n-\t\t$selectdisable = '';\r\n-\r\n-\t\t$instal_logic = Configuration::get('VIVAWALLET_INSTAL');\r\n-\t\tif(isset($instal_logic) && $instal_logic !=''){\r\n-\t\t$split_instal_vivawallet = explode(',', $instal_logic);\r\n-\t\t$c = count ($split_instal_vivawallet);\r\n-\r\n-\t\t if(isset($_REQUEST['wperiod'])){\r\n-\t\t $wbsubmitbutton = 'visibility:visible';\r\n-\t\t $selectdisable = ' disabled=\"disabled\"';\r\n-\t\t } else {\r\n-\t\t $wbsubmitbutton = 'visibility:hidden';\r\n-\t\t  $selectdisable = '';\r\n-\t\t }\r\n-\r\n-\t\t$instal_vivawallet = '';\r\n-\t\t$instal_template = '';\r\n-\t\t$instal_vivawallet .= $this->l('Instalments: ') . '<select '.$selectdisable.' name=\"wperiod\" onChange=\"this.form.submit();\">'.\"\\n\";\r\n-\r\n-\t\t$instal_vivawallet .= '<option value=\"\">'.$this->l('Make a selection').'</option>'.\"\\n\";\r\n-\t\t$instal_vivawallet .= '<option value=\"0\"'. (isset($_REQUEST['wperiod']) && $_REQUEST['wperiod']=='0' ? ' selected=\"selected\"' : '') . '>'.$this->l('No Instalments').'</option>'.\"\\n\";\r\n-\r\n-\t\tfor($i=0; $i<$c; $i++)\r\n-\t\t{\r\n-\t\tlist($instal_amount, $instal_term) = explode(\":\", $split_instal_vivawallet[$i]);\r\n-\r\n-\t\tif($wb_instal_total >= $instal_amount){\r\n-\t\t$instal_template = 'true';\r\n-\t\t$instal_vivawallet .= '<option value=\"'.$instal_term.'\"'. (isset($_REQUEST['wperiod']) && $_REQUEST['wperiod']==$instal_term ? ' selected=\"selected\"' : '') . '>'. $instal_term . $this->l(' instalments').'</option>'.\"\\n\";\r\n-\t\t}\r\n-\t\t}\r\n-\t\t$instal_vivawallet .= '</select>'.$this->l(' wait until the confirmation button appears.').'<br><br>'.\"\\n\";\r\n-\r\n-\r\n-\t\t} else {\r\n-\t\t$instal_template = 'false';\r\n-\t\t$instal_vivawallet = '<input type=\"hidden\" name=\"wperiod\" value=\"\" />';\r\n-\t\t}\r\n-\r\n-\t\tif (Configuration::get('PS_ORDER_PROCESS_TYPE') == 1){\r\n-\t\t$instalment_url = '?controller=order-opc&isPaymentStep=true';\r\n-\t\t} else {\r\n-\t\t    if ((_PS_VERSION_ >= '1.6')){\r\n-\t\t\tisset($_GET['multishipping']) ? $multishipping = addslashes($_GET['multishipping']) : $multishipping = '';\r\n-\t\t\t$instalment_url = '?controller=order&step=3&multishipping='.$multishipping;\r\n-\t\t\t} else {\r\n-\t\t\t$instalment_url = 'order.php?step=3';\r\n-    \t\t}\r\n-\t\t}\r\n-\r\n-\t\t$smarty->assign(array(\r\n-\t\t'VivawalletUrl' \t\t=> $this->VivawalletUrl,\r\n-\t\t'InstalmentUrl'\t\t=> $instalment_url,\r\n-\t\t'Ref' \t\t\t\t=> $OrderCode,\r\n-\t\t'WbInstalLogic' \t=> $instal_vivawallet,\r\n-\t\t'WbSubmit' \t\t\t=> $wbsubmitbutton,\r\n-\t\t'this_path' \t\t=> $this->_path,\r\n-\t\t'this_path_ssl' \t=> Configuration::get('PS_FO_PROTOCOL').$_SERVER['HTTP_HOST'].__PS_BASE_URI__.\"modules/{$this->name}/\"));\r\n-\r\n-\t\t$smarty->assign(array(\r\n-            'this_path' \t\t=> $this->_path,\r\n-            'this_path_ssl' \t=> Configuration::get('PS_FO_PROTOCOL').$_SERVER['HTTP_HOST'].__PS_BASE_URI__.\"modules/{$this->name}/\"));\r\n-\r\n-\t\tif($instal_template=='true'){\r\n-\t\treturn $this->display(__FILE__, 'payment.tpl');\r\n-\t\t} else {\r\n-\t\treturn $this->display(__FILE__, 'payment_noinstall.tpl');\r\n-\t\t}\r\n-\t}\r\n-\r\n-\tfunction hookPaymentReturn($params)\r\n-\t{\r\n-\t\tglobal $smarty;\r\n-\t\t$state = $params['objOrder']->getCurrentState();\r\n-\t\tif ($state == _PS_OS_OUTOFSTOCK_ or $state == _PS_OS_PAYMENT_)\r\n-\t\t\t$smarty->assign(array( //tommodps15 remove 4th -false- parameter\r\n-\t\t\t\t'total_to_pay' \t=> Tools::displayPrice($params['total_to_pay'], $params['currencyObj'], false),\r\n-\t\t\t\t'status' \t\t=> 'ok',\r\n-\t\t\t\t'id_order' \t\t=> $params['objOrder']->id\r\n-\t\t\t));\r\n-\t\telse\r\n-\t\t\t$smarty->assign('status', 'failed');\r\n-\r\n-\t\treturn $this->display(__FILE__, 'payment_return.tpl');\r\n-\t}\r\n-\r\n-\t//displayPaymentEU\r\n-\tfunction hookDisplayPaymentEU($params)\r\n-\t{\r\n-\t\tglobal $smarty, $cart, $cookie;\r\n-\r\n-\t\t$currency = Currency::getCurrencyInstance($cart->id_currency);\r\n-\r\n-\t\t$delivery = new Address(intval($cart->id_address_delivery));\r\n-\t\t$invoice = new Address(intval($cart->id_address_invoice));\r\n-\t\t$customer = new Customer(intval($cart->id_customer));\r\n-\r\n-\t\t$currencies = $this->getCurrency((int)$cart->id_currency);\r\n-\t\t$authorized_currencies = array_flip(explode(',', $this->currencies));\r\n-        $currencies_used = array();\r\n-\r\n-\r\n-\t  //currency correction\r\n-\t  $authorized_currencies = explode(\",\", $this->currencies);\r\n-\t  if(in_array((int)$currency->id, $authorized_currencies)){\r\n-\t   $dest_currency['iso_code'] = $currency->iso_code;\r\n-\t   $currency_override = '';\r\n-\t  } else {\r\n-\t   $currency = Currency::getCurrencyInstance((int)$authorized_currencies[0]);\r\n-\t   $currencycart = Currency::getCurrencyInstance((int)$cart->id_currency);\r\n-\t   $dest_currency['iso_code'] = $currency->iso_code;\r\n-\t   $dest_currency['id'] = $currency->id;\r\n-\t   $currency_override = $currency->id;\r\n-\t  }\r\n-\r\n-      \t$currency_symbol ='';\r\n-\t\t$language_code ='';\r\n-\t\t$eb_total ='';\r\n-\t\t$ebfullname ='';\r\n-\r\n-\t\t$currency_symbol ='';\r\n-\t\tswitch ($dest_currency['iso_code']) {\r\n-\t\tcase 'EUR':\r\n-   \t\t$currency_symbol = 978;\r\n-   \t\tbreak;\r\n-\t\tcase 'GBP':\r\n-   \t\t$currency_symbol = 826;\r\n-   \t\tbreak;\r\n-\t\tcase 'BGN':\r\n-   \t\t$currency_symbol = 975;\r\n-   \t\tbreak;\r\n-\t\tcase 'RON':\r\n-   \t\t$currency_symbol = 946;\r\n-   \t\tbreak;\r\n-\t\tdefault:\r\n-        $currency_symbol = 978;\r\n-\t\t}\r\n-\r\n-\t\t$amount = $cart->getOrderTotal(true, Cart::BOTH);\r\n-\r\n-\t\t//currency correction\r\n-\t\tif (isset($currency_override) && $currency_override!='')\r\n-\t\t{\r\n-\t\t\t$amount = ($amount / $currencycart->conversion_rate) * $currency->conversion_rate;\r\n-\t\t\t$amount = Tools::convertPrice($amount, new Currency((int)($dest_currency['id'])));\r\n-\t\t}\r\n-\r\n-\t\t$wb_total = number_format($amount, 2, '.', '');\r\n-\t\t$wb_instal_total = round($amount);\r\n-\r\n-\t\t$wb_total_cents = number_format($amount, 2, '.', '')*100;\r\n-\t\t$wb_total_cents = round($wb_total_cents);\r\n-\r\n-            $products = $cart->getProducts();\r\n-\r\n-\r\n-\t\t\tforeach ($products as $key => $product)\r\n-\t\t\t{\r\n-\t\t\t\t$products[$key]['name'] = str_replace('\"', '\\'', $product['name']);\r\n-\t\t\t\t$products[$key]['name'] = htmlentities(utf8_decode($product['name']));\r\n-\t\t\t}\r\n-\r\n-\tif(strtolower(Language::getIsoById($cookie->id_lang))=='el' || strtolower(Language::getIsoById($cookie->id_lang))=='gr'){\r\n-\t$languagecode ='el-GR';\r\n-\t} else {\r\n-\t$languagecode ='en-US';\r\n-\t}\r\n-\r\n-\t$MerchantID =  Configuration::get('VIVAWALLET_MERCHANTID');\r\n-\t$Password =   Configuration::get('VIVAWALLET_MERCHANTPASS');\r\n-\t$BaseUrl =   trim(Configuration::get('VIVAWALLET_URL'));\r\n-\r\n-\t$poststring['Amount'] = $wb_total_cents;\r\n-\t$poststring['RequestLang'] = $languagecode;\r\n-\t$poststring['Email'] = $customer->email;\r\n-\r\n-\tif(isset($_REQUEST['wperiod']) && $_REQUEST['wperiod'] > 0){\r\n-\t$poststring['MaxInstallments'] = $_REQUEST['wperiod'];\r\n-\t$modInstallments = $_REQUEST['wperiod'];\r\n-\t} else {\r\n-\t$poststring['MaxInstallments'] = '1';\r\n-\t$modInstallments = '';\r\n-\t}\r\n-\r\n-\t//hookDisplayPaymentEU\r\n-\tif(isset($_REQUEST['wperiod'])){\r\n-\t$showDropdown = '1';\r\n-\t} else {\r\n-\t$showDropdown = '';\r\n-\t}\r\n-\r\n-\t$poststring['MerchantTrns'] = $cart->id;\r\n-\t$poststring['SourceCode'] = Configuration::get('VIVAWALLET_SOURCE');\r\n-\t$poststring['CurrencyCode'] = $currency_symbol;\r\n-\t$poststring['PaymentTimeOut'] = '300';\r\n-\t$TmSecureKey = 'd2ViaXQuYnovbGljZW5zZS50eHQ='; // for extra encryption options\r\n-\r\n-\t$curl = curl_init($BaseUrl.\"/api/orders\");\r\n-\tcurl_setopt($curl, CURLOPT_PORT, 443);\r\n-\r\n-\t$postargs = 'Amount='.urlencode($poststring['Amount']).'&RequestLang='.urlencode($poststring['RequestLang']).'&Email='.urlencode($poststring['Email']).'&MaxInstallments='.urlencode($poststring['MaxInstallments']).'&MerchantTrns='.urlencode($poststring['MerchantTrns']).'&SourceCode='.urlencode($poststring['SourceCode']).'&CurrencyCode='.urlencode($poststring['CurrencyCode']).'&PaymentTimeOut=300&DisableIVR=true';\r\n-\r\n-\tcurl_setopt($curl, CURLOPT_POST, true);\r\n-\tcurl_setopt($curl, CURLOPT_POSTFIELDS, $postargs);\r\n-\tcurl_setopt($curl, CURLOPT_HEADER, false);\r\n-\tcurl_setopt($curl, CURLOPT_RETURNTRANSFER, true);\r\n-\tcurl_setopt($curl, CURLOPT_USERPWD, $MerchantID.':'.$Password);\r\n-\t$curlversion = curl_version();\r\n-\tif(!preg_match(\"/NSS/\" , $curlversion['ssl_version'])){\r\n-\tcurl_setopt($curl, CURLOPT_SSL_CIPHER_LIST, \"TLSv1\");\r\n-\t}\r\n-\r\n-\t// execute curl\r\n-\t$response = curl_exec($curl);\r\n-\r\n-\tif(curl_error($curl)){\r\n-\tcurl_setopt($curl, CURLOPT_PORT, 443);\r\n-\tcurl_setopt($curl, CURLOPT_POST, true);\r\n-\tcurl_setopt($curl, CURLOPT_POSTFIELDS, $postargs);\r\n-\tcurl_setopt($curl, CURLOPT_HEADER, false);\r\n-\tcurl_setopt($curl, CURLOPT_RETURNTRANSFER, true);\r\n-\tcurl_setopt($curl, CURLOPT_USERPWD, $MerchantID.':'.$Password);\r\n-\tcurl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);\r\n-\t$response = curl_exec($curl);\r\n-\t}\r\n-\r\n-\t\tcurl_close($curl);\r\n-\r\n-\t\ttry {\r\n-\t\tif (version_compare(PHP_VERSION, '5.3.99', '>=')) {\r\n-\t\t$resultObj=json_decode($response, false, 512, JSON_BIGINT_AS_STRING);\r\n-\t\t} else {\r\n-\t\t$response = preg_replace('/:\\s*(\\-?\\d+(\\.\\d+)?([e|E][\\-|\\+]\\d+)?)/', ': \"$1\"', $response, 1);\r\n-\t\t$resultObj = json_decode($response);\r\n-\t\t}\r\n-\t\t} catch( Exception $e ) {\r\n-\t\t\tthrow new Exception(\"Result is not a json object (\" . $e->getMessage() . \")\");\r\n-\t\t}\r\n-\r\n-\t\tif ($resultObj->ErrorCode==0){\t//success when ErrorCode = 0\r\n-\t\t$OrderCode = $resultObj->OrderCode;\r\n-\t\t$ErrorCode = $resultObj->ErrorCode;\r\n-\t\t$ErrorText = $resultObj->ErrorText;\r\n-\t\t}\r\n-\t\telse{\r\n-\t\t\tthrow new Exception(\"Unable to create order code (\" . $resultObj->ErrorText . \")\");\r\n-\t\t}\r\n-\r\n-\tif (version_compare(_PS_VERSION_, '1.5', '<')){\r\n-\t$seckey = $customer->secure_key;\r\n-\t} else {\r\n-\t$seckey = Context::getContext()->customer->secure_key;\r\n-\t}\r\n-\r\n-\t$tmquery = \"insert into vivawallet_data (secure_key, OrderCode, ErrorCode, ErrorText, Timestamp, ref, total_cost, currency, order_state) values ('\".$seckey.\"','\".$OrderCode.\"','\".$ErrorCode.\"','\".$ErrorText.\"',now(),'\".$cart->id.\"','\".$wb_total_cents.\"','\".$dest_currency['iso_code'].\"','I')\";\r\n-\tDb::getInstance()->execute($tmquery); //tommodps15\r\n-\r\n-\t$this->VivawalletUrl = $BaseUrl.'/web/newtransaction.aspx';\r\n-\r\n-\t\t$wbsubmitbutton = '';\r\n-\t\t$selectdisable = '';\r\n-\r\n-\t\t$instal_logic = Configuration::get('VIVAWALLET_INSTAL');\r\n-\t\tif(isset($instal_logic) && $instal_logic !=''){\r\n-\t\t$split_instal_vivawallet = explode(',', $instal_logic);\r\n-\t\t$c = count ($split_instal_vivawallet);\r\n-\r\n-\t\t$instal_vivawallet = '';\r\n-\t\t$instal_template = '';\r\n-\t\t$instal_vivawallet .= $this->l('Instalments: ') . '<select '.$selectdisable.' name=\"wperiod\" onChange=\"this.form.submit();\">'.\"\\n\";\r\n-\r\n-\t\t$instal_vivawallet .= '<option value=\"\">'.$this->l('Make a selection').'</option>'.\"\\n\";\r\n-\t\t$instal_vivawallet .= '<option value=\"0\"'. (isset($_REQUEST['wperiod']) && $_REQUEST['wperiod']=='0' ? ' selected=\"selected\"' : '') . '>'.$this->l('No Instalments').'</option>'.\"\\n\";\r\n-\r\n-\t\tfor($i=0; $i<$c; $i++)\r\n-\t\t{\r\n-\t\tlist($instal_amount, $instal_term) = explode(\":\", $split_instal_vivawallet[$i]);\r\n-\r\n-\t\t//hookDisplayPaymentEU\r\n-\t\tif($wb_instal_total >= $instal_amount){\r\n-\t\t$instal_template = 'true';\r\n-\t\t$instal_vivawallet .= '<option value=\"'.$instal_term.'\"'. (isset($_REQUEST['wperiod']) && $_REQUEST['wperiod']==$instal_term ? ' selected=\"selected\"' : '') . '>'. $instal_term . $this->l(' instalments').'</option>'.\"\\n\";\r\n-\t\t}\r\n-\t\t}\r\n-\t\t$instal_vivawallet .= '</select>'.\"\\n\";\r\n-\r\n-\r\n-\t\t} else {\r\n-\t\t$instal_template = 'false';\r\n-\t\t$instal_vivawallet = '<input type=\"hidden\" name=\"wperiod\" value=\"\" />';\r\n-\t\t}\r\n-\r\n-\t\t//hookDisplayPaymentEU\r\n-\t\t$smarty->assign(array(\r\n-\t\t'VivawalletUrl' \t\t=> $this->VivawalletUrl,\r\n-\t\t'Ref' \t\t\t\t=> $OrderCode,\r\n-\t\t'WbInstalLogic' \t=> $instal_vivawallet,\r\n-\t\t'this_path' \t\t=> $this->_path,\r\n-\t\t'this_path_ssl' \t=> Configuration::get('PS_FO_PROTOCOL').$_SERVER['HTTP_HOST'].__PS_BASE_URI__.\"modules/{$this->name}/\"));\r\n-\r\n-\t\t$smarty->assign(array(\r\n-            'this_path' \t\t=> $this->_path,\r\n-            'this_path_ssl' \t=> Configuration::get('PS_FO_PROTOCOL').$_SERVER['HTTP_HOST'].__PS_BASE_URI__.\"modules/{$this->name}/\"));\r\n-\r\n-\t\t//hookDisplayPaymentEU\r\n-\t\tif($instal_template=='true'){\r\n-\r\n-\t\t\tif($showDropdown!='1'){\r\n-\t\t\treturn array(\r\n-\t\t\t\t\t'cta_text' => $this->l('Pay with Viva') . '<form id=\"vivawallet_confirmation_form\" name=\"vivawallet_confirmation\" data-ajax=\"false\" action=\"'.Tools::getHttpHost(true) . $_SERVER['REQUEST_URI'].'\" method=\"post\">'.$instal_vivawallet.'</form>',\r\n-\t\t\t\t\t'logo' => Media::getMediaPath(_PS_MODULE_DIR_.$this->name.'/vivawallet.gif'),\r\n-\t\t\t\t\t'form' => $this->display(__FILE__, 'payment_eu.tpl')\r\n-\t\t\t\t);\r\n-\t\t\t} else {\r\n-\r\n-\t\t\t\tif(isset($modInstallments) && $modInstallments > 0){\r\n-\t\t\t\t $instal_title = $this->l(' - Instalments: ') . $modInstallments . ' <img alt=\"'.$this->l('Reset').'\" src=\"'.Media::getMediaPath(_PS_MODULE_DIR_.$this->name.'/reset_eu.gif').'\" onclick=\"window.location.href=\\''.Tools::getHttpHost(true) . $_SERVER['REQUEST_URI'].'\\'\" />';\r\n-\t\t\t\t $instal_logo = Media::getMediaPath(_PS_MODULE_DIR_.$this->name.'/vivawallet_eu.gif');\r\n-\t\t\t\t} else {\r\n-\t\t\t\t $instal_title = '';\r\n-\t\t\t\t $instal_logo = Media::getMediaPath(_PS_MODULE_DIR_.$this->name.'/vivawallet.gif');\r\n-\t\t\t\t}\r\n-\r\n-\t\t\treturn array(\r\n-\t\t\t\t\t'cta_text' => $this->l('Pay with Viva') . $instal_title,\r\n-\t\t\t\t\t'logo' => $instal_logo,\r\n-\t\t\t\t\t'form' => $this->display(__FILE__, 'payment_eu.tpl')\r\n-\t\t\t\t);\r\n-\t\t\t}\r\n-\r\n-\t\t} else {\r\n-\t\treturn array(\r\n-\t\t\t\t'cta_text' => $this->l('Pay with Viva'),\r\n-\t\t\t\t'logo' => Media::getMediaPath(_PS_MODULE_DIR_.$this->name.'/vivawallet.gif'),\r\n-\t\t\t\t'form' => $this->display(__FILE__, 'payment_noinstall_eu.tpl')\r\n-\t\t\t);\r\n-\t\t}\r\n-\t}\r\n-\r\n-\tprivate function _postValidation()\r\n-\t{\r\n-\t\tif (isset($_POST['btnSubmit']))\r\n-\t\t{\r\n-\t\t\tif (empty($_POST['vivawallet_MerchantId']))\r\n-\t\t\t\t$this->_postErrors[] = $this->l('Your MerchantId is required.');\r\n-\t\t\tif (empty($_POST['vivawallet_MerchantPass']))\r\n-\t\t\t\t$this->_postErrors[] = $this->l('Your MerchantPass is required.');\r\n-\t\t}\r\n-\t\telseif (isset($_POST['currenciesSubmit']))\r\n-\t\t{\r\n-\t\t\t$currencies = Currency::getCurrencies();\r\n-\t\t\t$authorized_currencies = array();\r\n-\t\t\tforeach ($currencies as $currency)\r\n-\t\t\t\tif (isset($_POST['currency_'.$currency['id_currency']]) AND $_POST['currency_'.$currency['id_currency']])\r\n-\t\t\t\t\t$authorized_currencies[] = $currency['id_currency'];\r\n-\t\t\tif (!sizeof($authorized_currencies))\r\n-\t\t\t\t$this->_postErrors[] = $this->l('at least one currency is required.');\r\n-\t\t}\r\n-\t}\r\n-\r\n-\tprivate function _postProcess()\r\n-\t{\r\n-\t\tif (isset($_POST['btnSubmit']))\r\n-\t\t{\r\n-\t\t\tConfiguration::updateValue('VIVAWALLET_MERCHANTID', trim($_POST['vivawallet_MerchantId']));\r\n-\t\t\tConfiguration::updateValue('VIVAWALLET_MERCHANTPASS', trim($_POST['vivawallet_MerchantPass']));\r\n-\t\t\tConfiguration::updateValue('VIVAWALLET_INSTAL', trim($_POST['vivawallet_wb_instal']));\r\n-\t\t\tConfiguration::updateValue('VIVAWALLET_URL', trim($_POST['vivawallet_wb_url']));\r\n-\t\t\tConfiguration::updateValue('VIVAWALLET_SOURCE', trim($_POST['vivawallet_Source']));\r\n-\t\t}\r\n-\t\telseif (isset($_POST['currenciesSubmit']))\r\n-\t\t{\r\n-\t\t\t$currencies = Currency::getCurrencies();\r\n-\t\t\t$authorized_currencies = array();\r\n-\t\t\tforeach ($currencies as $currency)\r\n-\t\t\t\tif (isset($_POST['currency_'.$currency['id_currency']]) AND $_POST['currency_'.$currency['id_currency']])\r\n-\t\t\t\t\t$authorized_currencies[] = $currency['id_currency'];\r\n-\t\t\tConfiguration::updateValue('VIVAWALLET_CURRENCIES', implode(',', $authorized_currencies));\r\n-\t\t}\r\n-\t\t$ok = $this->l('Ok');\r\n-\t\t$updated = $this->l('Settings Updated');\r\n-\t\t$this->_html .= \"<div class='conf confirm'><img src='../modules/vivawallet/ok.gif' alt='{$ok}' />{$updated}</div>\";\r\n-\t}\r\n-\r\n-\tprivate function _displayvivawallet()\r\n-\t{\r\n-\t\t$modDesc \t= $this->l('This module allows you to accept payments using Vivawallet.');\r\n-\t\t$modStatus\t= $this->l('Vivawallet online banking service could be the right solution for you');\r\n-\t\t$modconfirm\t= $this->l('');\r\n-\t\t$this->_html .= \"<img src='../modules/vivawallet/vivawallet.gif' style='float:left; margin-right:15px;' />\r\n-\t\t\t\t\t\t<b>{$modDesc}</b>\r\n-\t\t\t\t\t\t<br />\r\n-\t\t\t\t\t\t{$modconfirm}\r\n-\t\t\t\t\t\t<br />\r\n-\t\t\t\t\t\t<br />\r\n-\t\t\t\t\t\t<br />\";\r\n-\t}\r\n-\r\n-\r\n-\r\n-\r\n-\tprivate function _displayForm()\r\n-\t{\r\n-\t\t$modvivawallet\t\t\t= $this->l('Vivawallet Setup');\r\n-\t\t$modvivawalletDesc\t\t= $this->l('Please specify the gateway settings');\r\n-\t\t$modInstalLabel\t\t\t= $this->l('Instalment logic');\r\n-\t\t$modInstalDescription\t= $this->l('Instalment logic example: 300:3,600:6 -> Order total 300 euro: allow 3 instalments, order total 600: allow 3 and 6 instalments.');\r\n-\r\n-\t\t$modUrlLabel\t\t\t= $this->l('Base URL');\r\n-\t\t$modUrlDescription\t= $this->l('Use https://www.vivapayments.com for live and https://demo.vivapayments.com for demo environment.');\r\n-\r\n-\t\t$modMerchantId\t\t= $this->l('MerchantId');\r\n-\t\t$modMerchantPass\t\t= $this->l('API Key');\r\n-\t\t$modSource\t\t\t= $this->l('Source Code');\r\n-\r\n-\t\t$modCurrencies\t\t\t\t= $this->l('Currencies');\r\n-\t\t$modUpdateSettings \t\t\t= $this->l('Update settings');\r\n-\t\t$modCurrenciesDescription\t=$this->l('Currencies authorized for Vivawallet payment.');\r\n-\t\t$modAuthorizedCurrencies\t= $this->l('Authorized currencies');\r\n-\r\n-\t\t$this->_html .=\r\n-\t\t\"<form action='{$_SERVER['REQUEST_URI']}' method='post'>\r\n-\t\t\t<fieldset>\r\n-\t\t\t<legend><img src='../modules/vivawallet/access.png' />{$modvivawallet}</legend>\r\n-\t\t\t\t<table border='0' width='500' cellpadding='0' cellspacing='0' id='form'>\r\n-\t\t\t\t\t<tr>\r\n-\t\t\t\t\t\t<td colspan='2'>\r\n-\t\t\t\t\t\t\t{$modvivawalletDesc}<br /><br />\r\n-\t\t\t\t\t\t</td>\r\n-\t\t\t\t\t</tr>\";\r\n-\r\n-\t$this->_html .=\"<tr>\r\n-\t\t\t\t\t\t<td colspan='2'>\r\n-\t\t\t\t\t\t\t{$modInstalDescription}\r\n-\t\t\t\t\t\t\t<br />\r\n-\t\t\t\t\t\t\t<br />\r\n-\t\t\t\t\t\t</td>\r\n-\t\t\t\t\t</tr><tr>\r\n-\t\t\t\t\t\t<td width='130'>{$modInstalLabel}<br /><br /></td>\r\n-\t\t\t\t\t\t<td>\";\r\n-\t$this->_html .= '<input type=\"text\" name=\"vivawallet_wb_instal\" value=\"'.Tools::getValue('vivawallet_wb_instal', Configuration::get('VIVAWALLET_INSTAL')).'\" />';\r\n-\r\n-\t$this->_html .= \"<br /><br /></td>\r\n-\t\t\t\t\t</tr>\";\r\n-\r\n-\t$this->_html .=\"<tr>\r\n-\t\t\t\t\t\t<td colspan='2'>\r\n-\t\t\t\t\t\t\t{$modUrlDescription}\r\n-\t\t\t\t\t\t\t<br />\r\n-\t\t\t\t\t\t\t<br />\r\n-\t\t\t\t\t\t</td>\r\n-\t\t\t\t\t</tr><tr>\r\n-\t\t\t\t\t\t<td width='130'>{$modUrlLabel}<br /><br /></td>\r\n-\t\t\t\t\t\t<td>\";\r\n-\t$this->_html .= '<input type=\"text\" name=\"vivawallet_wb_url\" value=\"'.Tools::getValue('vivawallet_wb_url', Configuration::get('VIVAWALLET_URL')).'\" />';\r\n-\r\n-\t$this->_html .= \"<br /><br /></td>\r\n-\t\t\t\t\t</tr>\";\r\n-\r\n-\t$this->_html .=\"<tr>\r\n-\t\t\t\t\t\t<td width='130'>{$modMerchantId}<br /><br /></td>\r\n-\t\t\t\t\t\t<td>\";\r\n-\t$this->_html .= '<input type=\"text\" name=\"vivawallet_MerchantId\" value=\"'.Tools::getValue('vivawallet_MerchantId', Configuration::get('VIVAWALLET_MERCHANTID')).'\" />';\r\n-\t$this->_html .= \"<br /><br /></td>\r\n-\t\t\t\t\t</tr>\";\r\n-\t$this->_html .=\"<tr>\r\n-\t\t\t\t\t\t<td width='130'>{$modMerchantPass}<br /><br /></td>\r\n-\t\t\t\t\t\t<td>\";\r\n-\t$this->_html .= '<input type=\"text\" name=\"vivawallet_MerchantPass\" value=\"'.Tools::getValue('vivawallet_MerchantPass', Configuration::get('VIVAWALLET_MERCHANTPASS')).'\" />';\r\n-\t$this->_html .= \"<br /><br /></td>\r\n-\t\t\t\t\t</tr>\";\r\n-\r\n-\t$this->_html .=\"<tr>\r\n-\t\t\t\t\t\t<td width='130'>{$modSource}<br /><br /></td>\r\n-\t\t\t\t\t\t<td>\";\r\n-\t$this->_html .= '<input type=\"text\" name=\"vivawallet_Source\" value=\"'.Tools::getValue('vivawallet_Source', Configuration::get('VIVAWALLET_SOURCE')).'\" />';\r\n-\t$this->_html .= \"<br /><br /></td>\r\n-\t\t\t\t\t</tr>\";\r\n-\r\n-\r\n-\t$this->_html .= \"<tr>\r\n-\t\t\t\t\t\t<td colspan='2' align='center'>\r\n-\t\t\t\t\t\t\t<input class='button' name='btnSubmit' value='{$modUpdateSettings}' type='submit' />\r\n-\t\t\t\t\t\t</td>\r\n-\t\t\t\t\t</tr>\r\n-\t\t\t\t</table>\r\n-\t\t\t</fieldset>\r\n-\t\t</form>\r\n-\t\t<br />\r\n-\t\t<br />\r\n-\t\t<form action='{$_SERVER['REQUEST_URI']}' method='post'>\r\n-\t\t\t<fieldset>\r\n-\t\t\t<legend><img src='../modules/vivawallet/dollar.gif' />{$modAuthorizedCurrencies}</legend>\r\n-\t\t\t\t<table border='0' width='500' cellpadding='0' cellspacing='0' id='form'>\r\n-\t\t\t\t\t<tr>\r\n-\t\t\t\t\t\t<td colspan='2'>\r\n-\t\t\t\t\t\t\t{$modCurrenciesDescription}\r\n-\t\t\t\t\t\t\t<br />\r\n-\t\t\t\t\t\t\t<br />\r\n-\t\t\t\t\t\t</td>\r\n-\t\t\t\t\t</tr>\r\n-\t\t\t\t\t<tr>\r\n-\t\t\t\t\t\t<td width='130' style='height: 35px; vertical-align:top'>{$modCurrencies}</td>\r\n-\t\t\t\t\t\t<td>\";\r\n-\t\t\t$currencies = Currency::getCurrencies();\r\n-\t\t\t$authorized_currencies = array_flip(explode(',', Configuration::get('VIVAWALLET_CURRENCIES')));\r\n-\t\t\tforeach ($currencies as $currency)\r\n-\t\t\t\t$this->_html .= '<label style=\"float:none; \"><input type=\"checkbox\" value=\"true\" name=\"currency_'.$currency['id_currency'].'\"'.(isset($authorized_currencies[$currency['id_currency']]) ? ' checked=\"checked\"' : '').' />&nbsp;<span style=\"font-weight:bold;\">'.$currency['name'].'</span> ('.$currency['sign'].')</label><br />';\r\n-\t\t\t\t$this->_html .=\"\r\n-\t\t\t\t\t\t</td>\r\n-\t\t\t\t\t</tr>\r\n-\t\t\t\t\t<tr>\r\n-\t\t\t\t\t\t<td colspan='2' align='center'>\r\n-\t\t\t\t\t\t\t<br />\r\n-\t\t\t\t\t\t\t<input class='button' name='currenciesSubmit' value='{$modUpdateSettings}' type='submit' />\r\n-\t\t\t\t\t\t</td>\r\n-\t\t\t\t\t</tr>\r\n-\t\t\t\t</table>\r\n-\t\t\t</fieldset>\r\n-\t\t</form>\";\r\n-\t}\r\n-}\r\n-\r\n-?>\r"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.5-1.6/vivawallet/vivawallet.tpl",
          "status": "removed",
          "additions": 0,
          "deletions": 6,
          "patch": "@@ -1,6 +0,0 @@\n-<p class=\"payment_module\">\n-\t<a href=\"javascript:$('#vivawallet_form').submit();\" title=\"{l s='Pay with Vivawallet' mod='vivawallet'}\">\n-\t\t<img src=\"../vivawallet/{$module_dir}vivawallet.gif\" alt=\"{l s='Pay with Vivawallet' mod='vivawallet'}\" class=\"img-responsive\" />\n-\t\t{l s='Pay with Vivawallet' mod='vivawallet'}\n-\t</a>\n-</p>\n\\ No newline at end of file"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.5-1.6/vivawallet/vivawallet_eu.gif",
          "status": "removed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "Plugins/prestashop/prestashop1.5-1.6/vivawallet/webhook.php",
          "status": "removed",
          "additions": 0,
          "deletions": 120,
          "patch": "@@ -1,120 +0,0 @@\n-<?php\r\n-include(dirname(__FILE__).'/../../config/config.inc.php');\r\n-if(substr(_PS_VERSION_,2,1) < 5){\r\n-include(dirname(__FILE__).'/../../header.php');\r\n-}\r\n-include(dirname(__FILE__).'/vivawallet.php');\r\n-\r\n-$vivawallet = new vivawallet();\r\n-$errors = '';\r\n-\r\n-\t$postdata = file_get_contents(\"php://input\");\r\n-\r\n-\t$MerchantID =  Configuration::get('VIVAWALLET_MERCHANTID');\r\n-\t$Password =   html_entity_decode(Configuration::get('VIVAWALLET_MERCHANTPASS'));\r\n-\t$BaseUrl =  trim(Configuration::get('VIVAWALLET_URL'));\r\n-\t$curl_adr \t= $BaseUrl.'/api/messages/config/token/';\r\n-\r\n-\t$curl = curl_init();\r\n-\tif (preg_match(\"/https/i\", $curl_adr)) {\r\n-\tcurl_setopt($curl, CURLOPT_PORT, 443);\r\n-\t}\r\n-\tcurl_setopt($curl, CURLOPT_POST, false);\r\n-\tcurl_setopt($curl, CURLOPT_URL, $curl_adr);\r\n-\tcurl_setopt($curl, CURLOPT_HEADER, false);\r\n-\tcurl_setopt($curl, CURLOPT_RETURNTRANSFER, true);\r\n-\tcurl_setopt($curl, CURLOPT_USERPWD, $MerchantID.':'.$Password);\r\n-\t$curlversion = curl_version();\r\n-\tif(!preg_match(\"/NSS/\" , $curlversion['ssl_version'])){\r\n-\tcurl_setopt($curl, CURLOPT_SSL_CIPHER_LIST, \"TLSv1\");\r\n-\t}\r\n-\t$response = curl_exec($curl);\r\n-\t\r\n-\tif(curl_error($curl)){\r\n-\tif (preg_match(\"/https/i\", $curl_adr)) {\r\n-\tcurl_setopt($curl, CURLOPT_PORT, 443);\r\n-\t}\r\n-\tcurl_setopt($curl, CURLOPT_POST, true);\r\n-\tcurl_setopt($curl, CURLOPT_POSTFIELDS, $postargs);\r\n-\tcurl_setopt($curl, CURLOPT_HEADER, false);\r\n-\tcurl_setopt($curl, CURLOPT_RETURNTRANSFER, true);\r\n-\tcurl_setopt($curl, CURLOPT_USERPWD, $MerchantID.':'.$Password);\r\n-\tcurl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);\r\n-\t$response = curl_exec($curl);\r\n-\t}\r\n-\t\r\n-\tcurl_close($curl);\r\n-\techo $response;\r\n-\t\r\n-\ttry {\r\n-\t\t\r\n-\tif(is_object(json_decode($postdata))){\r\n-\t\t$resultObj=json_decode($postdata);\r\n-\t}\r\n-\t} catch( Exception $e ) {\r\n-\t\techo $e->getMessage();\r\n-\t}\r\n-\t\r\n-\tif(isset($resultObj->EventData->StatusId) && $resultObj->EventData->StatusId=='F') {\r\n-\t$StatusId = $resultObj->EventData->StatusId;\r\n-\t$OrderCode = $resultObj->EventData->OrderCode;\r\n-\t$TransactionId = $resultObj->EventData->TransactionId;\r\n-\r\n-  $transtat_query = \"select * from vivawallet_data where OrderCode='\".addslashes($OrderCode).\"' ORDER BY id DESC\";\r\n-  $transtat = Db::getInstance()->executeS($transtat_query, $array = true, $use_cache = 0);\r\n-\r\n-  \r\n-  if($transtat[0]['order_state']=='I' && $StatusId=='F'){\r\n-  $update_query = \"update vivawallet_data set order_state='P' where OrderCode='\".addslashes($OrderCode).\"'\";\r\n-  $update = Db::getInstance()->execute($update_query);\r\n-\r\n-  $currency_payment = Db::getInstance()->getValue('SELECT id_currency FROM '._DB_PREFIX_.'currency WHERE iso_code = \"'.$emp_currency.'\"');\r\n-  $total = floatval(number_format(($transtat[0]['total_cost'] / 100), 2, '.', ''));\r\n-  $secure_key = $transtat[0]['secure_key'];\r\n-  $cartid = $transtat[0]['ref'];\r\n-  \r\n-   if(substr(_PS_VERSION_,2,1) >= 5){\r\n-   Context::getContext()->cart = new Cart((int)$cart_id);\r\n-   Context::getContext()->cookie->id_cart = (int)$cart_id;\r\n-   \r\n-   $cart = new Cart((int)$cart_id);\r\n-   \r\n-\t if (Validate::isLoadedObject($cart)) {\r\n-\t\t$shop = new Shop((int)$cart->id_shop);\r\n-\t\tif (Validate::isLoadedObject($shop)) {\r\n-\t\t Context::getContext()->shop = $shop;\r\n-\t\t}\r\n-\t\t\r\n-\t\t$customer = new Customer((int)$cart->id_customer);\r\n-\t\tif (Validate::isLoadedObject($customer)) {\r\n-\t\t\t$customer->logged = 1;\r\n-\t\t\tContext::getContext()->customer = $customer;\r\n-\t\t\tContext::getContext()->cookie->id_customer = (int)$customer->id;\r\n-\t\t\tContext::getContext()->cookie->customer_lastname = $customer->lastname;\r\n-\t\t\tContext::getContext()->cookie->customer_firstname = $customer->firstname;\r\n-\t\t\tContext::getContext()->cookie->logged = 1;\r\n-\t\t\tContext::getContext()->cookie->check_cgv = 1;\r\n-\t\t\tContext::getContext()->cookie->is_guest = $customer->isGuest();\r\n-\t\t\tContext::getContext()->cookie->passwd = $customer->passwd;\r\n-\t\t\tContext::getContext()->cookie->email = $customer->email;\r\n-\t\t\t$secure_key = $customer->secure_key;\r\n-\t\t}\r\n-\t  }\r\n-\t  if ((int)Context::getContext()->cookie->id_cart > 0) {\r\n-\t\t\t\tContext::getContext()->cookie->__unset('id_cart');\r\n-\t  }\r\n- \t}\t\r\n-\t\r\n-  \r\n-  $details = array(\r\n-\t\t\t\t'id_transaction' => $OrderCode,\r\n-\t\t\t\t'transaction_id' => $OrderCode\r\n-\t\t\t);\r\n-\r\n-   $vivawallet->validateOrder((int)$cartid, _PS_OS_PAYMENT_, $total, $vivawallet->displayName, 'OrderCode: '.$OrderCode,$details,(int)$currency_payment,false,$secure_key, $shop);\r\n-   $currency = new Currency(intval(isset($_POST['currency_payement']) ? $_POST['currency_payement'] : $cookie->id_currency));\r\n-   $order = new Order($vivawallet->currentOrder);\r\n-\r\n-} \r\n-}\r\n-?>\n\\ No newline at end of file"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.7/vivawallet/access.png",
          "status": "removed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "Plugins/prestashop/prestashop1.7/vivawallet/config.xml",
          "status": "removed",
          "additions": 0,
          "deletions": 12,
          "patch": "@@ -1,12 +0,0 @@\n-<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n-        <module>\n-            <name>vivawallet</name>\n-            <displayName><![CDATA[Vivawallet]]></displayName>\n-            <version><![CDATA[1]]></version>\n-            <description><![CDATA[Accept payments with Vivawallet]]></description>\n-            <author><![CDATA[vivawallet.com]]></author>\n-            <tab><![CDATA[payments_gateways]]></tab>\n-            <is_configurable>1</is_configurable>\n-            <need_instance>1</need_instance>\n-\t\t\t<limited_countries></limited_countries>\n-        </module>\n\\ No newline at end of file"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.7/vivawallet/controllers/front/fail.php",
          "status": "removed",
          "additions": 0,
          "deletions": 60,
          "patch": "@@ -1,60 +0,0 @@\n-<?php\r\n-class VivawalletFailModuleFrontController extends ModuleFrontController\r\n-{\r\n-\t/**\r\n-\t * @see FrontController::postProcess()\r\n-\t */\r\n-\tpublic function postProcess()\r\n-\t{\r\n-  \r\n-\t  if(isset($_GET['s']) && $_GET['s']!=''){\r\n-\r\n-\t  $OrderCode = addslashes($_GET['s']);\r\n-\t  \r\n-\t  $check_query = \"select * from vivawallet_data where OrderCode='\".$OrderCode.\"' ORDER BY id DESC\";\r\n-\t  $check = Db::getInstance()->executeS($check_query, $array = true, $use_cache = 0);\r\n-\t  $oid = $check[0]['ref'];\r\n-\t\r\n-\t\t$cart = $this->context->cart;\r\n-\t\tif ($cart->id_customer == 0 || $cart->id_address_delivery == 0 || $cart->id_address_invoice == 0 || !$this->module->active){\r\n-\t\t\t\r\n-\t\t\t$id_cart = (int)$oid;\r\n-\t\t\t$this->context->cart = new Cart($id_cart);\r\n-\t\t\t$this->context->cookie->id_cart = $id_cart;\r\n-\t\t\t\r\n-\t\t\t$cart = new Cart((int) $id_cart);\r\n-            if (Validate::isLoadedObject($cart)) {\r\n-                $customer = new Customer((int) $cart->id_customer);\r\n-                if (Validate::isLoadedObject($customer)) {\r\n-                    $customer->logged = 1;\r\n-                    $this->context->customer = $customer;\r\n-                    $this->context->cookie->id_customer = (int) $customer->id;\r\n-                    $this->context->cookie->customer_lastname = $customer->lastname;\r\n-                    $this->context->cookie->customer_firstname = $customer->firstname;\r\n-                    $this->context->cookie->logged = 1;\r\n-                    $this->context->cookie->check_cgv = 1;\r\n-                    $this->context->cookie->is_guest = $customer->isGuest();\r\n-                    $this->context->cookie->passwd = $customer->passwd;\r\n-                    $this->context->cookie->email = $customer->email;\r\n-                }\r\n-            }\r\n-\t\t\t\r\n-\t\t\tif ($cart->id_customer == 0 || $cart->id_address_delivery == 0 || $cart->id_address_invoice == 0 || !$this->module->active){\r\n-\t\t\t Tools::redirect('index.php?controller=order&step=1');\r\n-\t\t\t}\r\n-\t\t\t\r\n-\t\t}\t\r\n-\t\t\t\r\n-\t\t\t   $update_query = \"update vivawallet_data set order_state='F' where OrderCode='\".$OrderCode.\"'\";\r\n-\t\t\t   $update = Db::getInstance()->execute($update_query);\r\n-\t\t\t   \r\n-\t\t\t    $this->errors[] = $this->l('Transaction Failed.');\r\n-\t\t\t\t$this->redirectWithNotifications('index.php?controller=order&step=1');\r\n-\t\r\n-\r\n-\t}  else {\r\n-\techo 'No valid input received.';\r\n-\t}   \r\n-\t  \r\n-\t}\r\n-}\n\\ No newline at end of file"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.7/vivawallet/controllers/front/index.php",
          "status": "removed",
          "additions": 0,
          "deletions": 35,
          "patch": "@@ -1,35 +0,0 @@\n-<?php\r\n-/*\r\n-* 2007-2015 PrestaShop\r\n-*\r\n-* NOTICE OF LICENSE\r\n-*\r\n-* This source file is subject to the Academic Free License (AFL 3.0)\r\n-* that is bundled with this package in the file LICENSE.txt.\r\n-* It is also available through the world-wide-web at this URL:\r\n-* http://opensource.org/licenses/afl-3.0.php\r\n-* If you did not receive a copy of the license and are unable to\r\n-* obtain it through the world-wide-web, please send an email\r\n-* to license@prestashop.com so we can send you a copy immediately.\r\n-*\r\n-* DISCLAIMER\r\n-*\r\n-* Do not edit or add to this file if you wish to upgrade PrestaShop to newer\r\n-* versions in the future. If you wish to customize PrestaShop for your\r\n-* needs please refer to http://www.prestashop.com for more information.\r\n-*\r\n-*  @author PrestaShop SA <contact@prestashop.com>\r\n-*  @copyright  2007-2015 PrestaShop SA\r\r\n-*  @license    http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)\r\n-*  International Registered Trademark & Property of PrestaShop SA\r\n-*/\r\n-\r\n-header('Expires: Mon, 26 Jul 1997 05:00:00 GMT');\r\n-header('Last-Modified: '.gmdate('D, d M Y H:i:s').' GMT');\r\n-\r\n-header('Cache-Control: no-store, no-cache, must-revalidate');\r\n-header('Cache-Control: post-check=0, pre-check=0', false);\r\n-header('Pragma: no-cache');\r\n-\r\n-header('Location: ../../../../');\r\n-exit;\n\\ No newline at end of file"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.7/vivawallet/controllers/front/pay.php",
          "status": "removed",
          "additions": 0,
          "deletions": 34,
          "patch": "@@ -1,34 +0,0 @@\n-<?php\r\n-\r\n-class VivawalletPayModuleFrontController extends ModuleFrontController\r\n-{\r\n-\tpublic $ssl = true;\r\n-\r\n-\t/**\r\n-\t * @see FrontController::initContent()\r\n-\t */\r\n-\tpublic function initContent()\r\n-\t{\r\n-\t\tparent::initContent();\r\n-\t\t?>\r\n-        <form id=\"payment_form_vivawallet\" name=\"payment_form_vivawallet\" action=\"<?php echo $_POST['VivawalletUrl']; ?>\" method=\"get\">\r\n-\t\t<?php\r\n-            foreach( $_POST as $name => $value ) {\r\n-            if($name !='VivawalletUrl'){\r\n-                echo '<input type=\"hidden\" name=\"'.$name.'\" value=\"'.$value.'\" />';\r\n-                }\r\n-            }\r\n-        ?>\r\n-        <noscript>\r\n-        <input type=\"submit\" value=\"<?php echo $this->l('Pay Now'); ?>\" />\r\n-        </noscript>\r\n-        </form>\r\n-        <script type=\"text/javascript\">\r\n-            <!--\r\n-            document.getElementById('payment_form_vivawallet').submit();\r\n-            //-->\r\n-        </script>\r\n-            <?php\r\n-\t\t\t\r\n-\t}\r\n-}\r"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.7/vivawallet/controllers/front/success.php",
          "status": "removed",
          "additions": 0,
          "deletions": 137,
          "patch": "@@ -1,137 +0,0 @@\n-<?php\r\n-class VivawalletSuccessModuleFrontController extends ModuleFrontController\r\n-{\r\n-\t/**\r\n-\t * @see FrontController::postProcess()\r\n-\t */\r\n-\tpublic function postProcess()\r\n-\t{\r\n-\t\r\n-\t  if(isset($_GET['s']) && $_GET['s']!=''){\r\n-\t  $errors = '';\r\n-\t  $OrderCode = addslashes($_GET['s']);\r\n-\t  \r\n-\t  $check_query = \"select * from vivawallet_data where OrderCode='\".$OrderCode.\"' ORDER BY id DESC\";\r\n-\t  $check = Db::getInstance()->executeS($check_query, $array = true, $use_cache = 0);\r\n-\t  $oid = $check[0]['ref'];\r\n-\t  \r\n-\t  $cart = $this->context->cart;\r\n-\t\tif ($cart->id_customer == 0 || $cart->id_address_delivery == 0 || $cart->id_address_invoice == 0 || !$this->module->active){\r\n-\t\t\t\r\n-\t\t\t$id_cart = (int)$oid;\r\n-\t\t\t$this->context->cart = new Cart($id_cart);\r\n-\t\t\t$this->context->cookie->id_cart = $id_cart;\r\n-\t\t\t\r\n-\t\t\t$cart = new Cart((int) $id_cart);\r\n-            if (Validate::isLoadedObject($cart)) {\r\n-                $customer = new Customer((int) $cart->id_customer);\r\n-                if (Validate::isLoadedObject($customer)) {\r\n-                    $customer->logged = 1;\r\n-                    $this->context->customer = $customer;\r\n-                    $this->context->cookie->id_customer = (int) $customer->id;\r\n-                    $this->context->cookie->customer_lastname = $customer->lastname;\r\n-                    $this->context->cookie->customer_firstname = $customer->firstname;\r\n-                    $this->context->cookie->logged = 1;\r\n-                    $this->context->cookie->check_cgv = 1;\r\n-                    $this->context->cookie->is_guest = $customer->isGuest();\r\n-                    $this->context->cookie->passwd = $customer->passwd;\r\n-                    $this->context->cookie->email = $customer->email;\r\n-                }\r\n-            }\r\n-\t\t\t\r\n-\t\t\tif ($cart->id_customer == 0 || $cart->id_address_delivery == 0 || $cart->id_address_invoice == 0 || !$this->module->active){\r\n-\t\t\t Tools::redirect('index.php?controller=order&step=1');\r\n-\t\t\t}\r\n-\t\t\t\r\n-\t\t}\t\r\n-\t\t\t\r\n-\t\t$customer = new Customer((int) $cart->id_customer);\r\n-\t\tif (!Validate::isLoadedObject($customer))\r\n-\t\t\tTools::redirect('index.php?controller=order&step=1');\r\n-\t\t   \r\n-\t  $currency = $this->context->currency;\r\n-\t  $total = (float)$cart->getOrderTotal(true, Cart::BOTH);  \r\n-\t  \r\n-\t  $MerchantID =  trim(Configuration::get('VIVAWALLET_MERCHANTID'));\r\n-\t  $APIKey =   html_entity_decode(Configuration::get('VIVAWALLET_MERCHANTPASS'));\r\n-\t  $BaseUrl =  trim(Configuration::get('VIVAWALLET_URL'));\r\n-\t  $request = $BaseUrl.\"/api/transactions/\";\r\n-\t\t\r\n-\t\t$getargs = '?ordercode='.urlencode($OrderCode);\r\n-\t\t$session = curl_init($request);\r\n-\t\t\r\n-\t\tcurl_setopt($session, CURLOPT_HTTPGET, true);\r\n-\t\tcurl_setopt($session, CURLOPT_URL, $request . $getargs);\r\n-\t\tcurl_setopt($session, CURLOPT_RETURNTRANSFER, true);\r\n-\t\tcurl_setopt($session, CURLOPT_USERPWD, $MerchantID.':'.$APIKey);\r\n-\t\t$curlversion = curl_version();\r\n-        if(!preg_match(\"/NSS/\" , $curlversion['ssl_version'])){\r\n-            curl_setopt($session, CURLOPT_SSL_CIPHER_LIST, \"TLSv1\");\r\n-        }\r\n-\r\n-\t\t$response = curl_exec($session);\r\n-\t\tcurl_close($session);\r\n-\t\ttry {\r\n-\t\t\t\t\r\n-\t\t\tif(is_object(json_decode($response))){\r\n-\t\t\t  \t$resultObj=json_decode($response);\r\n-\t\t\t}\r\n-\t\t} catch( Exception $e ) {\r\n-\t\t\techo $e->getMessage();\r\n-\t\t}\r\n-\r\n-\t\tif ($resultObj->ErrorCode==0){\r\n-\t\t\tif(sizeof($resultObj->Transactions) > 0) {\r\n-\t\t\t\tforeach ($resultObj->Transactions as $t){\r\n-\t\t\t\t\t$TransactionId = $t->TransactionId;\r\n-\t\t\t\t\t$Amount = $t->Amount;\r\n-\t\t\t\t\t$StatusId = $t->StatusId;\r\n-\t\t\t\t\t$CustomerTrns = $t->CustomerTrns ;\r\n-                    $message = $this->l('Transactions completed Successfully');\r\n-\t\t\t\t}\r\n-\t\t\t} else {\r\n-\t\t\t\t$message = $this->l('No transactions found. Make sure the order code exists and is created by your account.');\r\n-\t\t\t}\r\n-\t\t} else {\r\n-\t\t\t$message = $this->l('The following error occured:') . '<strong>' . $resultObj->ErrorCode . '</strong>, ' . $resultObj->ErrorText;\r\n-\t\t}\r\n-        \r\n-\t\tif(isset($StatusId) && strtoupper($StatusId) == 'F')\r\n-\t\t{\r\n-\t\t  $transtat_query = \"select * from vivawallet_data where OrderCode='\".$OrderCode.\"' ORDER BY id DESC\";\r\n-\t\t  $transtat = Db::getInstance()->executeS($transtat_query, $array = true, $use_cache = 0);\r\n-\t\t  $order_state = $transtat[0]['order_state'];\r\n-\t\t\r\n-\t\t  $details = array(\r\n-\t\t\t\t\t\t'id_transaction' => $TransactionId,\r\n-\t\t\t\t\t\t'transaction_id' => $TransactionId\r\n-\t\t\t\t\t);\r\n-\t\t\r\n-\t\t   if($order_state=='I'){\r\n-\t\t    $this->context->shop = new Shop((int) $this->context->cart->id_shop);\r\n-\t\t\t$this->module->validateOrder($cart->id, _PS_OS_PAYMENT_, $total, $this->module->displayName, 'OrderCode: '.$OrderCode, $details,(int)$currency->id,false,$customer->secure_key,$this->context->shop);\r\n-\t\t   }\r\n-\t\t   \r\n-\t\t   $update_query = \"update vivawallet_data set order_state='P' where OrderCode='\".$OrderCode.\"'\";\r\n-\t\t   $update = Db::getInstance()->execute($update_query);\r\n-\t\t  \r\n-\t\t   Tools::redirect('index.php?controller=order-confirmation&id_cart='.$cart->id.'&id_module='.$this->module->id.'&id_order='.$this->module->currentOrder.'&key='.$customer->secure_key);\r\n-\t\t\r\n-\t\t} else  {\r\n-\t\t\r\n-\t\t   $update_query = \"update vivawallet_data set order_state='F' where OrderCode='\".$OrderCode.\"'\";\r\n-\t\t   $update = Db::getInstance()->execute($update_query);\r\n-\t\t\r\n-\t\t   $this->errors[] = $this->l('Transaction Failed.') . '<br>' . $this->l('Order Code: ') . $OrderCode;\r\n-\t\t   $this->redirectWithNotifications('index.php?controller=order&step=1');\r\n-\t\t\r\n-\t\t}\r\n-\t  \r\n-\t  \r\n-\t\r\n-\t} else {\r\n-\techo 'No valid input received.';\r\n-\t}\r\n-\r\n-\t}\r\n-}\n\\ No newline at end of file"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.7/vivawallet/controllers/front/webhook.php",
          "status": "removed",
          "additions": 0,
          "deletions": 128,
          "patch": "@@ -1,128 +0,0 @@\n-<?php\r\n-\r\n-class VivawalletWebhookModuleFrontController extends ModuleFrontController\r\n-{\r\n-\t \r\n-\tpublic function display($template = null, $cache_id = null, $compile_id = null, $parent = null)\r\n-    {\r\n-\t return false;\r\n-\t}\r\n-\t \r\n-\t/**\r\n-\t * @see FrontController::postProcess()\r\n-\t */\r\n-\tpublic function postProcess()\r\n-\t{\r\n-\t\r\n-\t\t$postdata = file_get_contents(\"php://input\");\r\n-\t\r\n-\t\t$MerchantID =  trim(Configuration::get('VIVAWALLET_MERCHANTID'));\r\n-\t\t$Password =   html_entity_decode(Configuration::get('VIVAWALLET_MERCHANTPASS'));\r\n-\t\t$BaseUrl =  trim(Configuration::get('VIVAWALLET_URL'));\r\n-\t\t$curl_adr \t= $BaseUrl.'/api/messages/config/token/';\r\n-\t\t\r\n-\t\t\r\n-\t\r\n-\t\t$curl = curl_init();\r\n-\t\tcurl_setopt($curl, CURLOPT_PORT, 443);\r\n-\t\tcurl_setopt($curl, CURLOPT_POST, false);\r\n-\t\tcurl_setopt($curl, CURLOPT_URL, $curl_adr);\r\n-\t\tcurl_setopt($curl, CURLOPT_HEADER, false);\r\n-\t\tcurl_setopt($curl, CURLOPT_RETURNTRANSFER, true);\r\n-\t\tcurl_setopt($curl, CURLOPT_USERPWD, $MerchantID.':'.$Password);\r\n-\t\t$curlversion = curl_version();\r\n-\t\tif(!preg_match(\"/NSS/\" , $curlversion['ssl_version'])){\r\n-\t\tcurl_setopt($curl, CURLOPT_SSL_CIPHER_LIST, \"TLSv1\");\r\n-\t\t}\r\n-\t\t$response = curl_exec($curl);\r\n-\t\t\r\n-\t\tif(curl_error($curl)){\r\n-\t\tcurl_setopt($curl, CURLOPT_PORT, 443);\r\n-\t\tcurl_setopt($curl, CURLOPT_POST, true);\r\n-\t\tcurl_setopt($curl, CURLOPT_POSTFIELDS, $postargs);\r\n-\t\tcurl_setopt($curl, CURLOPT_HEADER, false);\r\n-\t\tcurl_setopt($curl, CURLOPT_RETURNTRANSFER, true);\r\n-\t\tcurl_setopt($curl, CURLOPT_USERPWD, $MerchantID.':'.$Password);\r\n-\t\tcurl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);\r\n-\t\t$response = curl_exec($curl);\r\n-\t\t}\r\n-\t\t\r\n-\t\tcurl_close($curl);\r\n-\t\techo $response;\r\n-\t\t\r\n-\t\ttry {\r\n-\t\t\t\r\n-\t\tif(is_object(json_decode($postdata))){\r\n-\t\t\t$resultObj=json_decode($postdata);\r\n-\t\t}\r\n-\t\t} catch( Exception $e ) {\r\n-\t\t\techo $e->getMessage();\r\n-\t\t}\r\n-\t\r\n-\t\r\n-\t\tif(isset($resultObj->EventData->StatusId) && $resultObj->EventData->StatusId=='F') {\r\n-\t\t$StatusId = $resultObj->EventData->StatusId;\r\n-\t\t$OrderCode = $resultObj->EventData->OrderCode;\r\n-\t\t$TransactionId = $resultObj->EventData->TransactionId;\r\n-\t\t\r\n-\t\t$check_query = \"select * from vivawallet_data where OrderCode='\".$OrderCode.\"' ORDER BY id DESC\";\r\n-\t    $check = Db::getInstance()->executeS($transtat_query, $array = true, $use_cache = 0);\r\n-\t    $oid = $transtat[0]['ref'];\r\n-\t\t\r\n-\t\t$cart = $this->context->cart;\r\n-\t\tif ($cart->id_customer == 0 || $cart->id_address_delivery == 0 || $cart->id_address_invoice == 0 || !$this->module->active){\r\n-\t\t\t\r\n-\t\t\t$id_cart = (int)$oid;\r\n-\t\t\t$this->context->cart = new Cart($id_cart);\r\n-\t\t\t$this->context->cookie->id_cart = $id_cart;\r\n-\t\t\t\r\n-\t\t\t$cart = new Cart((int) $id_cart);\r\n-            if (Validate::isLoadedObject($cart)) {\r\n-                $customer = new Customer((int) $cart->id_customer);\r\n-                if (Validate::isLoadedObject($customer)) {\r\n-                    $customer->logged = 1;\r\n-                    $this->context->customer = $customer;\r\n-                    $this->context->cookie->id_customer = (int) $customer->id;\r\n-                    $this->context->cookie->customer_lastname = $customer->lastname;\r\n-                    $this->context->cookie->customer_firstname = $customer->firstname;\r\n-                    $this->context->cookie->logged = 1;\r\n-                    $this->context->cookie->check_cgv = 1;\r\n-                    $this->context->cookie->is_guest = $customer->isGuest();\r\n-                    $this->context->cookie->passwd = $customer->passwd;\r\n-                    $this->context->cookie->email = $customer->email;\r\n-                }\r\n-            }\r\n-\t\t\t\r\n-\t\t\tif ($cart->id_customer == 0 || $cart->id_address_delivery == 0 || $cart->id_address_invoice == 0 || !$this->module->active){\r\n-\t\t\t Tools::redirect('index.php?controller=order&step=1');\r\n-\t\t\t}\r\n-\t\t\t\r\n-\t\t}\t\r\n-\t\t\t\r\n-\t\t$customer = new Customer((int) $cart->id_customer);\r\n-\t\tif (!Validate::isLoadedObject($customer))\r\n-\t\t\tTools::redirect('index.php?controller=order&step=1');\r\n-\t\t   \r\n-\t    $currency = $this->context->currency;\r\n-\t    $total = (float)$cart->getOrderTotal(true, Cart::BOTH);\r\n-\t\r\n-\t\t  $transtat_query = \"select * from vivawallet_data where OrderCode='\".$OrderCode.\"' ORDER BY id DESC\";\r\n-\t\t  $transtat = Db::getInstance()->executeS($transtat_query, $array = true, $use_cache = 0);\r\n-\t\t  \r\n-\t\t  if($transtat[0]['order_state']=='I' && $StatusId=='F'){\r\n-\t\t  $update_query = \"update vivawallet_data set order_state='P' where OrderCode='\".$OrderCode.\"'\";\r\n-\t\t  $update = Db::getInstance()->execute($update_query);\r\n-\t\t\r\n-\t\t  $details = array(\r\n-\t\t\t\t\t\t'id_transaction' => $TransactionId,\r\n-\t\t\t\t\t\t'transaction_id' => $TransactionId\r\n-\t\t\t\t\t);\r\n-\t\t\r\n-\t\t   $this->context->shop = new Shop((int) $this->context->cart->id_shop);\r\n-\t\t   $this->module->validateOrder($cart->id, _PS_OS_PAYMENT_, $total, $this->module->displayName, 'OrderCode: '.$OrderCode, $details,(int)$currency->id,false,$customer->secure_key,$this->context->shop);\r\n-\t\t\r\n-\t\t} \r\n-\t\t}\r\n-\r\n-\t}\r\n-}\n\\ No newline at end of file"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.7/vivawallet/controllers/index.php",
          "status": "removed",
          "additions": 0,
          "deletions": 35,
          "patch": "@@ -1,35 +0,0 @@\n-<?php\r\n-/*\r\n-* 2007-2015 PrestaShop\r\n-*\r\n-* NOTICE OF LICENSE\r\n-*\r\n-* This source file is subject to the Academic Free License (AFL 3.0)\r\n-* that is bundled with this package in the file LICENSE.txt.\r\n-* It is also available through the world-wide-web at this URL:\r\n-* http://opensource.org/licenses/afl-3.0.php\r\n-* If you did not receive a copy of the license and are unable to\r\n-* obtain it through the world-wide-web, please send an email\r\n-* to license@prestashop.com so we can send you a copy immediately.\r\n-*\r\n-* DISCLAIMER\r\n-*\r\n-* Do not edit or add to this file if you wish to upgrade PrestaShop to newer\r\n-* versions in the future. If you wish to customize PrestaShop for your\r\n-* needs please refer to http://www.prestashop.com for more information.\r\n-*\r\n-*  @author PrestaShop SA <contact@prestashop.com>\r\n-*  @copyright  2007-2015 PrestaShop SA\r\r\n-*  @license    http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)\r\n-*  International Registered Trademark & Property of PrestaShop SA\r\n-*/\r\n-\r\n-header('Expires: Mon, 26 Jul 1997 05:00:00 GMT');\r\n-header('Last-Modified: '.gmdate('D, d M Y H:i:s').' GMT');\r\n-\r\n-header('Cache-Control: no-store, no-cache, must-revalidate');\r\n-header('Cache-Control: post-check=0, pre-check=0', false);\r\n-header('Pragma: no-cache');\r\n-\r\n-header('Location: ../../../');\r\n-exit;\n\\ No newline at end of file"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.7/vivawallet/dollar.gif",
          "status": "removed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "Plugins/prestashop/prestashop1.7/vivawallet/install.sql",
          "status": "removed",
          "additions": 0,
          "deletions": 15,
          "patch": "@@ -1,15 +0,0 @@\n-DROP TABLE IF EXISTS `vivawallet_data`;\n-CREATE TABLE IF NOT EXISTS `vivawallet_data` (\n-  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,\n-  `secure_key` varchar(150) DEFAULT NULL,\n-  `OrderCode` varchar(255) DEFAULT NULL,\n-  `ErrorCode` varchar(50) DEFAULT NULL,\n-  `ErrorText` varchar(255) DEFAULT NULL,\n-  `Timestamp` datetime DEFAULT NULL,\n-  `ref` varchar(150) DEFAULT NULL,\n-  `total_cost` int(11) DEFAULT NULL,\n-  `currency` char(3) DEFAULT NULL,\n-  `order_state` char(1) DEFAULT NULL,\n-  `sessionid` varchar(50) DEFAULT NULL,\n-  PRIMARY KEY (`id`)\n-) ENGINE=InnoDB DEFAULT CHARSET=utf8 AUTO_INCREMENT=1;"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.7/vivawallet/logo.gif",
          "status": "removed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "Plugins/prestashop/prestashop1.7/vivawallet/logos.png",
          "status": "removed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "Plugins/prestashop/prestashop1.7/vivawallet/ok.gif",
          "status": "removed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "Plugins/prestashop/prestashop1.7/vivawallet/payment.php",
          "status": "removed",
          "additions": 0,
          "deletions": 19,
          "patch": "@@ -1,19 +0,0 @@\n-<?php\n-/* SSL Management */\n-$useSSL = true;\n-\n-include(dirname(__FILE__).'/../../config/config.inc.php');\n-include(dirname(__FILE__).'/../../header.php');\n-include(dirname(__FILE__).'/vivawallet.php');\n-\n-if (!$cookie->isLogged(true))\n-\tTools::redirect('authentication.php?back=order.php');\n-elseif (!Customer::getAddressesTotalById((int)($cookie->id_customer)))\n-\tTools::redirect('address.php?back=order.php?step=1');\n-\t\n-$vivawallet = new vivawallet();\n-echo $vivawallet->execPayment($cart);\n-\n-include_once(dirname(__FILE__).'/../../footer.php');\n-\n-?>"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.7/vivawallet/payment.tpl",
          "status": "removed",
          "additions": 0,
          "deletions": 12,
          "patch": "@@ -1,12 +0,0 @@\n-<p class=\"payment_module clearfix\">\n-\t\t<span style=\"float:left;\"><img src=\"{$module_dir}vivawallet.gif\" alt=\"{l s='Pay by Vivawallet' mod='vivawallet'}\"/></span>\n-\t\t<span>{l s='Pay with Vivawallet' mod='vivawallet'}<br />{l s='Pay safely and quickly on the next page' mod='vivawallet'}</span>\n-</p>\n-<form name=\"vivawallet_confirmation\" action=\"{$base_dir_ssl}{$InstalmentUrl}\" method=\"post\">\n-    {$WbInstalLogic}\n-</form>\n-        \n-<form name=\"vivawallet_confirmation\" action=\"{$VivawalletUrl}\" method=\"get\">\n-    <input type=\"hidden\" name=\"Ref\" value=\"{$Ref}\" />\n-    <input style=\"{$WbSubmit}\" type=\"submit\" value=\"{l s='Pay Now' mod='vivawallet'}\" class=\"exclusive_large\" />\n-</form>\n\\ No newline at end of file"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.7/vivawallet/payment_eu.tpl",
          "status": "removed",
          "additions": 0,
          "deletions": 3,
          "patch": "@@ -1,3 +0,0 @@\n-<form id=\"vivawallet_payment_form\" name=\"vivawallet_confirmation\" action=\"{$VivawalletUrl}\" data-ajax=\"false\" title=\"{l s='Pay with Vivawallet' mod='vivawallet'}\" method=\"get\">\n-    <input type=\"hidden\" name=\"Ref\" value=\"{$Ref}\" />\n-</form>\n\\ No newline at end of file"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.7/vivawallet/payment_execution.tpl",
          "status": "removed",
          "additions": 0,
          "deletions": 31,
          "patch": "@@ -1,31 +0,0 @@\n-{capture name=path}{l s='Shipping'}{/capture}\n-\n-    <div id=\"cms_block\">\n-\t<h2>{l s='Vivawallet Payment Order Summary' mod='vivawallet'}</h2>\n-    {l s='Buy On-Line with Credit or Debit Card via Vivawallet.' mod='vivawallet'}\n-    </div>\n-\n-{assign var='current_step' value='payment'}\n-{include file=\"$tpl_dir./order-steps.tpl\"}\n-\n-\n-\n-<p>\n-\t<img src=\"{$this_path}vivawallet.gif\" alt=\"{l s='Vivawallet' mod='vivawallet'}\" style=\"float:left; margin: 0px 10px 5px 0px;\" />\n-\t{l s='You have chosen to pay by Vivawallet.' mod='vivawallet'}\n-</p>\n-<p>\n-\t<b>{l s='Please confirm your order by clicking \\'I confirm my order\\'' mod='vivawallet'}.</b>\n-</p>\n-\n-\n-<p align=\"right\"><a href=\"{$base_dir_ssl}order.php?step=3\" class=\"button_large\">{l s='Other payment methods' mod='vivawallet'}</a></p>\n-\n-<form name=\"vivawallet_confirmation\" action=\"{$this_path}payment.php\" method=\"post\" />\n-    {$WbInstalLogic}\n-</form>\n-        \n-<form name=\"vivawallet_confirmation\" action=\"{$VivawalletUrl}\" method=\"get\" />\n-    <input type=\"hidden\" name=\"Ref\" value=\"{$Ref}\" />\n-    <input style=\"{$WbSubmit}\" type=\"submit\" value=\"{l s='I confirm my order' mod='vivawallet'}\" class=\"exclusive_large\" />\n-</form>\n\\ No newline at end of file"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.7/vivawallet/payment_noinstall.tpl",
          "status": "removed",
          "additions": 0,
          "deletions": 18,
          "patch": "@@ -1,18 +0,0 @@\n-<script>\n-function submyform() {\n-        document.getElementById(\"vivawallet_payment_form\").submit();\n-}\n-</script>\n-\n-<p class=\"payment_module\">\n-\t<a title=\"{l s='Pay with Vivawallet' mod='vivawallet'}\" class=\"bankwire\" href=\"javascript:submyform()\" rel=\"nofollow\">\n-\t\t<img src=\"{$module_dir}vivawallet.gif\" alt=\"{l s='Pay with Vivawallet' mod='vivawallet'}\" style=\"float:left;\" />\n-\t\t<br />{l s='Pay with Vivawallet' mod='vivawallet'}\n-\t\t<br />{l s='Pay safely and quickly on the next page' mod='vivawallet'}\n-\t\t<br style=\"clear:both;\" />\n-\t</a>\n-</p>\n-\n-<form name=\"vivawallet_confirmation\" action=\"{$VivawalletUrl}\" method=\"get\" id=\"vivawallet_payment_form\">\n-    <input type=\"hidden\" name=\"Ref\" value=\"{$Ref}\" />\n-</form>\n\\ No newline at end of file"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.7/vivawallet/payment_noinstall_eu.tpl",
          "status": "removed",
          "additions": 0,
          "deletions": 3,
          "patch": "@@ -1,3 +0,0 @@\n-<form id=\"vivawallet_payment_form\" name=\"vivawallet_confirmation\" action=\"{$VivawalletUrl}\" data-ajax=\"false\" title=\"{l s='Pay with Vivawallet' mod='vivawallet'}\" method=\"get\">\n-    <input type=\"hidden\" name=\"Ref\" value=\"{$Ref}\" />\n-</form>\n\\ No newline at end of file"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.7/vivawallet/payment_return.tpl",
          "status": "removed",
          "additions": 0,
          "deletions": 9,
          "patch": "@@ -1,9 +0,0 @@\n-{if $status == 'ok'}\n-\t<p>{l s='Your order on' mod='vivawallet'} <span class=\"bold\">{$shop_name}</span> {l s='is complete.' mod='vivawallet'}\n-\t\t<br /><br />{l s='For any questions or for further information, please contact us.' mod='vivawallet'}\n-\t</p>\n-{else}\n-\t<p class=\"warning\">\n-\t\t{l s='We noticed a problem with your transaction. If you think this is an error, please contact us.' mod='vivawallet'} \n-\t</p>\n-{/if}"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.7/vivawallet/readme.txt",
          "status": "removed",
          "additions": 0,
          "deletions": 1,
          "patch": "@@ -1 +0,0 @@\n-Latest stable version of Viva Wallet for PrestaShop 1.7. To view download and installation instructions, see https://developer.vivawallet.com/e-commerce-plugins/prestashop1.7/."
        },
        {
          "filename": "Plugins/prestashop/prestashop1.7/vivawallet/reset_eu.gif",
          "status": "removed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "Plugins/prestashop/prestashop1.7/vivawallet/translations/index.php",
          "status": "removed",
          "additions": 0,
          "deletions": 35,
          "patch": "@@ -1,35 +0,0 @@\n-<?php\n-/*\n-* 2007-2014 PrestaShop\n-*\n-* NOTICE OF LICENSE\n-*\n-* This source file is subject to the Academic Free License (AFL 3.0)\n-* that is bundled with this package in the file LICENSE.txt.\n-* It is also available through the world-wide-web at this URL:\n-* http://opensource.org/licenses/afl-3.0.php\n-* If you did not receive a copy of the license and are unable to\n-* obtain it through the world-wide-web, please send an email\n-* to license@prestashop.com so we can send you a copy immediately.\n-*\n-* DISCLAIMER\n-*\n-* Do not edit or add to this file if you wish to upgrade PrestaShop to newer\n-* versions in the future. If you wish to customize PrestaShop for your\n-* needs please refer to http://www.prestashop.com for more information.\n-*\n-*  @author PrestaShop SA <contact@prestashop.com>\n-*  @copyright  2007-2014 PrestaShop SA\n-*  @license    http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)\n-*  International Registered Trademark & Property of PrestaShop SA\n-*/\n-\t\t\t\t    \t\n-header(\"Expires: Mon, 26 Jul 1997 05:00:00 GMT\");\n-header(\"Last-Modified: \".gmdate(\"D, d M Y H:i:s\").\" GMT\");\n-\t\t\t\t\t\t\n-header(\"Cache-Control: no-store, no-cache, must-revalidate\");\n-header(\"Cache-Control: post-check=0, pre-check=0\", false);\n-header(\"Pragma: no-cache\");\n-\t\t\t\t\t\t\n-header(\"Location: ../\");\n-exit;\n\\ No newline at end of file"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.7/vivawallet/translations/it.php",
          "status": "removed",
          "additions": 0,
          "deletions": 54,
          "patch": "@@ -1,54 +0,0 @@\n-<?php\n-\n-global $_MODULE;\n-$_MODULE = array();\n-$_MODULE['<{vivawallet}prestashop>payment_noinstall_eu_e0bff9b3bd11ba66ce75ada94f286318'] = 'Paga con Vivawallet';\n-$_MODULE['<{vivawallet}prestashop>vivawallet_04eb016e245ade96f838c8d391cd055e'] = 'Accetta pagamenti con Vivawallet';\n-$_MODULE['<{vivawallet}prestashop>vivawallet_d53b278d2cac6efca10302395d60084b'] = 'le impostazioni di Vivawallet devono essere configurate per utilizzare correttamente questo modulo';\n-$_MODULE['<{vivawallet}prestashop>vivawallet_020f37f4fd9842dbe123f05492ce010c'] = 'Carta di pagamento (Viva Wallet)';\n-$_MODULE['<{vivawallet}prestashop>vivawallet_f52ea4dc11aceba6a8333253c55f7f99'] = '\u00c8 richiesto il tuo MerchantId.';\n-$_MODULE['<{vivawallet}prestashop>vivawallet_81f305df1986353bb0542d67e4eb94b8'] = '\u00c8 richiesto il tuo MerchantPass.';\n-$_MODULE['<{vivawallet}prestashop>vivawallet_180f0e85dd3029ebb195ed78e91804e4'] = '\u00e8 richiesta almeno una valuta.';\n-$_MODULE['<{vivawallet}prestashop>vivawallet_a60852f204ed8028c1c58808b746d115'] = 'Ok';\n-$_MODULE['<{vivawallet}prestashop>vivawallet_597582c140dd691b522fe42299a24d34'] = 'Impostazioni aggiornate';\n-$_MODULE['<{vivawallet}prestashop>vivawallet_f26b7b9a5aabb43f69f8e5ae5ca81b70'] = 'Questo modulo ti consente di accettare pagamenti utilizzando Vivawallet.';\n-$_MODULE['<{vivawallet}prestashop>vivawallet_b95f5063ac3e48215b0aaf7897627bf4'] = 'Il servizio di online banking di Vivawallet potrebbe essere la soluzione giusta per te';\n-$_MODULE['<{vivawallet}prestashop>vivawallet_637a1e2e12a99173c2daee6d471c10c2'] = 'Configurazione di Vivawallet';\n-$_MODULE['<{vivawallet}prestashop>vivawallet_2184699b0e940d56694c59d4564a1c16'] = 'Si prega di specificare le impostazioni del gateway';\n-$_MODULE['<{vivawallet}prestashop>vivawallet_5f0b44ce5c0070ded64bc9dfb2f40203'] = 'Logica delle rate';\n-$_MODULE['<{vivawallet}prestashop>vivawallet_4b1125f1fca08645ac53e1f8fd2ab41b'] = 'Esempio di logica rata: 300: 3.600: 6 -> Totale ordine 300 euro: consentire 3 rate, totale ordine 600: consentire 3 e 6 rate.';\n-$_MODULE['<{vivawallet}prestashop>vivawallet_ade86bc4899761ad46c52e381b6228bb'] = 'URL di base';\n-$_MODULE['<{vivawallet}prestashop>vivawallet_924383a3ecc88bf2a8b238f531db1e7d'] = 'Usa https://www.vivapayments.com per live e https://demo.vivapayments.com per ambiente demo.';\n-$_MODULE['<{vivawallet}prestashop>vivawallet_b9673f400908af6b944e0ac525f82bb1'] = 'MerchantId';\n-$_MODULE['<{vivawallet}prestashop>vivawallet_d876ff8da67c3731ae25d8335a4168b4'] = 'Chaive API';\n-$_MODULE['<{vivawallet}prestashop>vivawallet_4c200f344d32f6a87d65cd4615afc915'] = 'Codice sorgente';\n-$_MODULE['<{vivawallet}prestashop>vivawallet_dfcfc43722eef1eab1e4a12e50a068b1'] = 'Valute';\n-$_MODULE['<{vivawallet}prestashop>vivawallet_b17f3f4dcf653a5776792498a9b44d6a'] = 'Aggiorna impostazioni';\n-$_MODULE['<{vivawallet}prestashop>vivawallet_c270215fe3545c73f3526f6022a5a8e1'] = 'Valute autorizzate per il pagamento Vivawallet.';\n-$_MODULE['<{vivawallet}prestashop>vivawallet_4d99e33e0cfc8cfca786e285f70be1ef'] = 'Valute autorizzate';\n-$_MODULE['<{vivawallet}prestashop>payment_return_2e2117b7c81aa9ea6931641ea2c6499f'] = 'Il tuo ordine su';\n-$_MODULE['<{vivawallet}prestashop>payment_return_75fbf512d744977d62599cc3f0ae2bb4'] = '\u00e8 completo.';\n-$_MODULE['<{vivawallet}prestashop>payment_return_49849739f555740f5e7443d67e3486a6'] = 'Per qualsiasi domanda o per ulteriori informazioni non esitate a contattarci.';\n-$_MODULE['<{vivawallet}prestashop>payment_return_e42e307ec07df4cefa39ee0ded34f7bc'] = 'Abbiamo notato un problema con la tua transazione. Se pensi che si tratti di un errore, contattaci.';\n-$_MODULE['<{vivawallet}prestashop>payment_eu_e0bff9b3bd11ba66ce75ada94f286318'] = 'Paga con Vivawallet';\n-$_MODULE['<{vivawallet}prestashop>vivawallet_e0bff9b3bd11ba66ce75ada94f286318'] = 'Paga con Vivawallet';\n-$_MODULE['<{vivawallet}prestashop>payment_24b64a11be339121db01575c9e6369da'] = 'Paga con Vivawallet';\n-$_MODULE['<{vivawallet}prestashop>payment_e0bff9b3bd11ba66ce75ada94f286318'] = 'Paga con Vivawallet';\n-$_MODULE['<{vivawallet}prestashop>payment_bc4b580b7d98f8ca37511213ae61c096'] = 'Paga in modo sicuro e veloce nella pagina successiva';\n-$_MODULE['<{vivawallet}prestashop>payment_1b498eaafc20a6c7d28810c82c493eba'] = 'Paga adesso';\n-$_MODULE['<{vivawallet}prestashop>payment_execution_b4a6d545c93ab9e1acc865f2eb6d49b9'] = 'Riepilogo dell\\'ordine di pagamento Vivawallet';\n-$_MODULE['<{vivawallet}prestashop>payment_execution_117cf0af0ac752749ae4411e1370ade5'] = 'Acquista online con carta di credito o debito tramite Viva Wallet.';\n-$_MODULE['<{vivawallet}prestashop>payment_execution_5202b174efb0011553d1588586bea3b9'] = 'Vivawallet';\n-$_MODULE['<{vivawallet}prestashop>payment_execution_731b84bd956f7e146b0b49be16eaa4e3'] = 'Hai scelto di pagare con Vivawallet.';\n-$_MODULE['<{vivawallet}prestashop>payment_execution_0881a11f7af33bc1b43e437391129d66'] = 'Conferma il tuo ordine facendo clic su \\\"Confermo il mio ordine\\\"';\n-$_MODULE['<{vivawallet}prestashop>payment_execution_569fd05bdafa1712c4f6be5b153b8418'] = 'Altri metodi di pagamento';\n-$_MODULE['<{vivawallet}prestashop>payment_execution_46b9e3665f187c739c55983f757ccda0'] = 'Confermo il mio ordine';\n-$_MODULE['<{vivawallet}prestashop>payment_noinstall_e0bff9b3bd11ba66ce75ada94f286318'] = 'Paga con Vivawallet';\n-$_MODULE['<{vivawallet}prestashop>payment_noinstall_bc4b580b7d98f8ca37511213ae61c096'] = 'Paga in modo sicuro e veloce nella pagina successiva';\n-$_MODULE['<{vivawallet}prestashop>success_c7b2ff4507c77377330a0e69192b9e66'] = 'Transazioni completate con successo';\n-$_MODULE['<{vivawallet}prestashop>success_35eef9a61f0b568d7f873a294af2094b'] = 'Nessuna transazione trovata. Assicurati che il codice dell\\'ordine esista e sia stato creato dal tuo account.';\n-$_MODULE['<{vivawallet}prestashop>success_bc2560d5cf619d776d466a083f03d291'] = 'Si \u00e8 verificato il seguente errore:';\n-$_MODULE['<{vivawallet}prestashop>success_4071a572c3e64ac904ba4be465f1f90f'] = 'Transazione fallita.';\n-$_MODULE['<{vivawallet}prestashop>success_3a6e46a50b2fae8ed55a4b11c3c09d13'] = 'Codice d\\'ordine:';\n-$_MODULE['<{vivawallet}prestashop>fail_4071a572c3e64ac904ba4be465f1f90f'] = 'Transazione fallita.';\n-$_MODULE['<{vivawallet}prestashop>pay_1b498eaafc20a6c7d28810c82c493eba'] = 'Paga adesso';"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.7/vivawallet/vivawallet.gif",
          "status": "removed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "Plugins/prestashop/prestashop1.7/vivawallet/vivawallet.php",
          "status": "removed",
          "additions": 0,
          "deletions": 613,
          "patch": "@@ -1,613 +0,0 @@\n-<?php\n-use PrestaShop\\PrestaShop\\Core\\Payment\\PaymentOption;\n-\n-class vivawallet extends PaymentModule\n-{\n-\tconst INSTALL_SQL_FILE = 'install.sql';\n-\n-\tprivate $_html = '';\n-\tprivate $_postErrors = array();\n-\n-\tpublic function __construct()\n-\t{\n-\t\tif(substr(_PS_VERSION_,2,1) > 4){\n-\t\tif (empty(Context::getContext()->link))\n-\t\tContext::getContext()->link = new Link();\n-\t\t}\n-\n-\t\t$this->name = 'vivawallet';\n-\t\t$this->displayName = 'Vivawallet';\n-\t\t$this->tab = 'payments_gateways';\n-\t\t$this->author = 'Viva Wallet';\n-\t\t$this->version = '1.7.9';\n-\t\t$this->controllers = array('pay', 'fail', 'success', 'webhook');\n-        $this->ps_versions_compliancy = array('min' => '1.7.0.0', 'max' => _PS_VERSION_);\n-        $this->is_eu_compatible = 1;\n-\n-\t\t$config = Configuration::getMultiple(array('VIVAWALLET_MERCHANTID','VIVAWALLET_MERCHANTPASS','VIVAWALLET_SOURCE','VIVAWALLET_INSTAL','VIVAWALLET_URL','VIVAWALLET_CURRENCIES'));\n-\n-\n-\n-\t\tif (isset($config['VIVAWALLET_MERCHANTID']))\n-\t\t\t$this->MerchantId = $config['VIVAWALLET_MERCHANTID'];\n-\t\tif (isset($config['VIVAWALLET_MERCHANTPASS']))\n-\t\t\t$this->MerchantPass = $config['VIVAWALLET_MERCHANTPASS'];\n-\t\tif (isset($config['VIVAWALLET_SOURCE']))\n-\t\t\t$this->Source = $config['VIVAWALLET_SOURCE'];\n-\t\tif (isset($config['VIVAWALLET_INSTAL']))\n-\t\t\t$this->wb_instal = $config['VIVAWALLET_INSTAL'];\n-\t\tif (isset($config['VIVAWALLET_URL']))\n-\t\t\t$this->wb_url = $config['VIVAWALLET_URL'];\n-\t\tif (isset($config['VIVAWALLET_CURRENCIES']))\n-\t\t\t$this->currencies = $config['VIVAWALLET_CURRENCIES'];\n-\n-\t\t$this->bootstrap = true;\n-\t\tparent::__construct();\n-\n-\t\t$this->page = basename(__FILE__, '.php');\n-\t\t$this->description = $this->l('Accept payments with Vivawallet');\n-\n-\t\tif (!isset($this->MerchantId) OR !isset($this->MerchantPass))\n-\t\t\t$this->warning = $this->l('your Vivawallet settings must be configured in order to use this module correctly');\n-\t\tif (!Configuration::get('VIVAWALLET_CURRENCIES'))\n-\t\t{\n-\t\t\t$currencies = Currency::getCurrencies();\n-\t\t\t$authorized_currencies = array();\n-\t\t\tforeach ($currencies as $currency)\n-\t\t\t\t$authorized_currencies[] = $currency['id_currency'];\n-\t\t\tConfiguration::updateValue('VIVAWALLET_CURRENCIES', implode(',', $authorized_currencies));\n-\t\t}\n-\t}\n-\n-\n-\tfunction install()\n-\t{\n-\t\t$currencies = Currency::getCurrencies();\n-\t\t$authorized_currencies = array();\n-\t\tforeach ($currencies as $currency)\n-\t\t$authorized_currencies[] = $currency['id_currency'];\n-\n-\t\t// SQL Table\n-\t\tif (!file_exists(dirname(__FILE__).'/'.self::INSTALL_SQL_FILE))\n-\t\t\tdie('error 1');\n-\t\telseif (!$sql = file_get_contents(dirname(__FILE__).'/'.self::INSTALL_SQL_FILE))\n-\t\t\tdie('error 2');\n-\t\t$sql = preg_split(\"/;\\s*[\\r\\n]+/\", $sql);\n-\t\tforeach ($sql as $query)\n-\t\t\tif ($query AND sizeof($query) AND !Db::getInstance()->Execute(trim($query)))\n-\t\t\t\treturn false;\n-\n-\t\t//hookDisplayPaymentEU - added hook\n-\t\tif (!parent::install()\n-\t\t\tOR !Configuration::updateValue('VIVAWALLET_CURRENCIES', implode(',', $authorized_currencies))\n-\t\t\tOR !$this->registerHook('PaymentOptions')\n-\t\t\tOR !$this->registerHook('paymentReturn'))\n-\t\t\treturn false;\n-\t\treturn true;\n-\t}\n-\n-\n-\n-\tfunction uninstall()\n-\t{\n-\t\tif (!Configuration::deleteByName('VIVAWALLET_MERCHANTID')\n-\t\t\tOR !Configuration::deleteByName('VIVAWALLET_MERCHANTPASS')\n-\t\t\tOR !Configuration::deleteByName('VIVAWALLET_INSTAL')\n-\t\t\tOR !Configuration::deleteByName('VIVAWALLET_URL')\n-\t\t    OR !Configuration::deleteByName('VIVAWALLET_SOURCE')\n-\t\t\tOR !Configuration::deleteByName('VIVAWALLET_CURRENCIES')\n-\t\t\tOR !parent::uninstall())\n-\t\t\treturn false;\n-\t\treturn true;\n-\t}\n-\n-\n-\tfunction getContent()\n-\t{\n-\t\t$this->_html = '<h2>'.$this->displayName.'</h2>';\n-\n-\t\tif (!empty($_POST))\n-\t\t{\n-\n-\t\t\tif ($wb_instal = Tools::getValue('vivawallet_wb_instal'))\n-\t\t\t\tConfiguration::updateValue('VIVAWALLET_INSTAL', $wb_instal);\n-\t\t\tif ($wb_url = Tools::getValue('vivawallet_wb_url'))\n-\t\t\t\tConfiguration::updateValue('VIVAWALLET_URL', $wb_url);\n-\t\t\tif ($MerchantId = Tools::getValue('vivawallet_MerchantId'))\n-\t\t\t\tConfiguration::updateValue('VIVAWALLET_MERCHANTID', $MerchantId);\n-\t\t\tif ($MerchantPass = Tools::getValue('vivawallet_MerchantPass'))\n-\t\t\t\tConfiguration::updateValue('VIVAWALLET_MERCHANTPASS', $MerchantPass);\n-\t\t\tif ($Source = Tools::getValue('vivawallet_Source'))\n-\t\t\t\tConfiguration::updateValue('VIVAWALLET_SOURCE', $Source);\n-\n-\t\t\t$this->_postValidation();\n-\t\t\tif (!sizeof($this->_postErrors))\n-\t\t\t\t$this->_postProcess();\n-\t\t\telse\n-\t\t\t\tforeach ($this->_postErrors AS $err)\n-\t\t\t\t\t$this->_html .= \"<div class='alert error'>{$err}</div>\";\n-\t\t}\n-\t\telse\n-\t\t{\n-\t\t\t$this->_html .= \"<br />\";\n-\t\t}\n-\n-\t\t$this->_displayvivawallet();\n-\t\t$this->_displayForm();\n-\n-\t\treturn $this->_html;\n-\t}\n-\n-\n-\tfunction hookPaymentReturn($params)\n-\t{\n-\t\tglobal $smarty, $cart, $cookie;\n-\n-\t\t$check = Db::getInstance()->executeS('SELECT transaction_id FROM '._DB_PREFIX_.'order_payment WHERE order_reference =\"'.$params['order']->reference.'\"');\n-\n-\t\t $transaction_id = '';\n-\t\t if ($check){\n-\t\t   $transaction_id = $check[0]['transaction_id'];\n-\t\t }\n-\n-   \t\t$currency = $this->context->currency;\n-\n-\t\t$state = $params['order']->getCurrentState();\n-\t\tif ($state == _PS_OS_OUTOFSTOCK_ or $state == _PS_OS_PAYMENT_)\n-\t\t\t$smarty->assign(array(\n-\t\t\t\t'total_to_pay' => Tools::displayPrice(\n-                    $params['order']->getOrdersTotalPaid(),\n-                    new Currency($params['order']->id_currency),\n-                    false\n-                ),\n-\t\t\t\t'status' \t\t=> 'ok',\n-\t\t\t\t'storename' \t=> $this->context->shop->name,\n-\t\t\t\t'shop_name' \t=> $this->context->shop->name,\n-\t\t\t\t'id_order' \t\t=> $params['order']->id\n-\t\t\t));\n-\t\telse\n-\t\t\t$smarty->assign('status', 'failed');\n-\n-\t\treturn $this->display(__FILE__, 'payment_return.tpl');\n-\t}\n-\n-\n-\tfunction hookPaymentOptions($params)\n-\t{\n-\n-\t\tif (!$this->active) {\n-            return;\n-        }\n-\n-\t\tglobal $smarty, $cart, $cookie;\n-\n-\t\t$currency = Currency::getCurrencyInstance($cart->id_currency);\n-\n-\t\t$delivery = new Address(intval($cart->id_address_delivery));\n-\t\t$invoice = new Address(intval($cart->id_address_invoice));\n-\t\t$customer = new Customer(intval($cart->id_customer));\n-\n-\t\t$currencies = $this->getCurrency((int)$cart->id_currency);\n-\t\t$authorized_currencies = array_flip(explode(',', $this->currencies));\n-        $currencies_used = array();\n-\n-\n-\t  //currency correction\n-\t  $authorized_currencies = explode(\",\", $this->currencies);\n-\t  if(in_array((int)$currency->id, $authorized_currencies)){\n-\t   $dest_currency['iso_code'] = $currency->iso_code;\n-\t   $currency_override = '';\n-\t  } else {\n-\t   $currency = Currency::getCurrencyInstance((int)$authorized_currencies[0]);\n-\t   $currencycart = Currency::getCurrencyInstance((int)$cart->id_currency);\n-\t   $dest_currency['iso_code'] = $currency->iso_code;\n-\t   $dest_currency['id'] = $currency->id;\n-\t   $currency_override = $currency->id;\n-\t  }\n-\n-      \t$currency_symbol ='';\n-\t\t$language_code ='';\n-\t\t$eb_total ='';\n-\t\t$ebfullname ='';\n-\n-\t\t$currency_symbol ='';\n-\t\tswitch ($dest_currency['iso_code']) {\n-\t\t\tcase 'HRK':\n-\t\t\t\t$currency_symbol = 191; // CROATIAN KUNA.\n-\t\t\t\tbreak;\n-\t\t\tcase 'CZK':\n-\t\t\t\t$currency_symbol = 203; // CZECH KORUNA.\n-\t\t\t\tbreak;\n-\t\t\tcase 'DKK':\n-\t\t\t\t$currency_symbol = 208; // DANISH KRONE.\n-\t\t\t\tbreak;\n-\t\t\tcase 'HUF':\n-\t\t\t\t$currency_symbol = 348; // HUNGARIAN FORINT.\n-\t\t\t\tbreak;\n-\t\t\tcase 'SEK':\n-\t\t\t\t$currency_symbol = 752; // SWEDISH KRONA.\n-\t\t\t\tbreak;\n-\t\t\tcase 'GBP':\n-\t\t\t\t$currency_symbol = 826; // POUND STERLING.\n-\t\t\t\tbreak;\n-\t\t\tcase 'RON':\n-\t\t\t\t$currency_symbol = 946; // ROMANIAN LEU.\n-\t\t\t\tbreak;\n-\t\t\tcase 'BGN':\n-\t\t\t\t$currency_symbol = 975; // BULGARIAN LEV.\n-\t\t\t\tbreak;\n-\t\t\tcase 'EUR':\n-\t\t\t\t$currency_symbol = 978; // EURO.\n-\t\t\t\tbreak;\n-\t\t\tcase 'PLN':\n-\t\t\t\t$currency_symbol = 985; // POLISH ZLOTY.\n-\t\t\t\tbreak;\n-\t\t\tdefault:\n-\t\t\t\t$currency_symbol = 978; // EURO.\n-\n-\t\t}\n-\n-\t\t$amount = $cart->getOrderTotal(true, Cart::BOTH);\n-\n-\t\t//currency correction\n-\t\tif (isset($currency_override) && $currency_override!='')\n-\t\t{\n-\t\t\t$amount = ($amount / $currencycart->conversion_rate) * $currency->conversion_rate;\n-\t\t\t$amount = Tools::convertPrice($amount, new Currency((int)($dest_currency['id'])));\n-\t\t}\n-\n-\t\t$wb_total = number_format($amount, 2, '.', '');\n-\t\t$wb_instal_total = round($amount);\n-\n-\t\t$wb_total_cents = number_format($amount, 2, '.', '')*100;\n-\t\t$wb_total_cents = round($wb_total_cents);\n-\n-            $products = $cart->getProducts();\n-\n-\n-\t\t\tforeach ($products as $key => $product)\n-\t\t\t{\n-\t\t\t\t$products[$key]['name'] = str_replace('\"', '\\'', $product['name']);\n-\t\t\t\t$products[$key]['name'] = htmlentities(utf8_decode($product['name']));\n-\t\t\t}\n-\n-\n-\n-\n-\t\tswitch (  strtolower(Language::getIsoById($cookie->id_lang)) ) {\n-\t\t\tcase 'en':\n-\t\t\t\t$languagecode ='en-US';\n-\t\t\t\tbreak;\n-\t\t\tcase 'el':\n-\t\t\t\t$languagecode ='el-GR';\n-\t\t\t\tbreak;\n-\t\t\tcase 'de':\n-\t\t\t\t$languagecode ='de-DE';\n-\t\t\t\tbreak;\n-\t\t\tcase 'nl':\n-\t\t\t\t$languagecode ='nl-NL';\n-\t\t\t\tbreak;\n-\t\t\tcase 'fr':\n-\t\t\t\t$languagecode ='fr-FR';\n-\t\t\t\tbreak;\n-\t\t\tcase 'it':\n-\t\t\t\t$languagecode ='it-IT';\n-\t\t\t\tbreak;\n-\t\t\tcase 'pl':\n-\t\t\t\t$languagecode ='pl-PL';\n-\t\t\t\tbreak;\n-\t\t\tcase 'pt':\n-\t\t\t\t$languagecode ='pt-PT';\n-\t\t\t\tbreak;\n-\t\t\tcase 'ro':\n-\t\t\t\t$languagecode ='ro-RO';\n-\t\t\t\tbreak;\n-\t\t\tcase 'es':\n-\t\t\t\t$languagecode ='es-ES';\n-\t\t\t\tbreak;\n-\t\t\tdefault:\n-\t\t\t\t$languagecode ='en-US';\n-\t\t}\n-\n-\t$MerchantID =  trim(Configuration::get('VIVAWALLET_MERCHANTID'));\n-\t$Password =   html_entity_decode(Configuration::get('VIVAWALLET_MERCHANTPASS'));\n-\t$BaseUrl =  trim(Configuration::get('VIVAWALLET_URL'));\n-\n-\t$poststring['Amount'] = $wb_total_cents;\n-\t$poststring['RequestLang'] = $languagecode;\n-\t$poststring['Email'] = $customer->email;\n-\n-\t$poststring['MerchantTrns'] = $cart->id;\n-\t$poststring['SourceCode'] = Configuration::get('VIVAWALLET_SOURCE');\n-\t$poststring['CurrencyCode'] = $currency_symbol;\n-\t$poststring['PaymentTimeOut'] = '300';\n-\n-\t$TmSecureKey = 'd2ViaXQuYnovbGljZW5zZS50eHQ='; // for extra encryption options\n-\n-\t$charge = number_format($cart->getOrderTotal(true, Cart::BOTH), 2, '.', '');\n-\n-\t$maxperiod = '1';\n-\t $installogic = Configuration::get('VIVAWALLET_INSTAL');\n-\t if(isset($installogic) && $installogic!=''){\n-\t $split_instal_nbghps = explode(',',$installogic);\n-\t $c = count($split_instal_nbghps);\n-\t $instal_nbghps_max = array();\n-\t for($i=0; $i<$c; $i++){\n-\t\tlist($instal_amount, $instal_term) = explode(\":\", $split_instal_nbghps[$i]);\n-\t\t\tif($charge >= $instal_amount){\n-\t\t\t$instal_nbghps_max[] = trim($instal_term);\n-\t\t\t}\n-\t\t}\n-\t\tif(count($instal_nbghps_max) > 0){\n-\t\t $maxperiod = max($instal_nbghps_max);\n-\t\t}\n-\t}\n-\n-\t$curl = curl_init($BaseUrl.\"/api/orders\");\n-\tcurl_setopt($curl, CURLOPT_PORT, 443);\n-\n-\t$postargs = 'Amount='.urlencode($poststring['Amount']).'&RequestLang='.urlencode($poststring['RequestLang']).'&Email='.urlencode($poststring['Email']).'&MaxInstallments='.urlencode($maxperiod).'&MerchantTrns='.urlencode($poststring['MerchantTrns']).'&SourceCode='.urlencode($poststring['SourceCode']).'&CurrencyCode='.urlencode($poststring['CurrencyCode']).'&PaymentTimeOut=300&disableCash=true&DisableIVR=true';\n-\n-\tcurl_setopt($curl, CURLOPT_POST, true);\n-\tcurl_setopt($curl, CURLOPT_POSTFIELDS, $postargs);\n-\tcurl_setopt($curl, CURLOPT_HEADER, false);\n-\tcurl_setopt($curl, CURLOPT_RETURNTRANSFER, true);\n-\tcurl_setopt($curl, CURLOPT_USERPWD, $MerchantID.':'.$Password);\n-\t$curlversion = curl_version();\n-\tif(!preg_match(\"/NSS/\" , $curlversion['ssl_version'])){\n-\tcurl_setopt($curl, CURLOPT_SSL_CIPHER_LIST, \"TLSv1\");\n-\t}\n-\n-\t// execute curl\n-\t$response = curl_exec($curl);\n-\n-\tif(curl_error($curl)){\n-\tcurl_setopt($curl, CURLOPT_PORT, 443);\n-\tcurl_setopt($curl, CURLOPT_POST, true);\n-\tcurl_setopt($curl, CURLOPT_POSTFIELDS, $postargs);\n-\tcurl_setopt($curl, CURLOPT_HEADER, false);\n-\tcurl_setopt($curl, CURLOPT_RETURNTRANSFER, true);\n-\tcurl_setopt($curl, CURLOPT_USERPWD, $MerchantID.':'.$Password);\n-\tcurl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);\n-\t$response = curl_exec($curl);\n-\t}\n-\n-\t\tcurl_close($curl);\n-\n-\t\ttry {\n-\t\tif (version_compare(PHP_VERSION, '5.3.99', '>=')) {\n-\t\t$resultObj=json_decode($response, false, 512, JSON_BIGINT_AS_STRING);\n-\t\t} else {\n-\t\t$response = preg_replace('/:\\s*(\\-?\\d+(\\.\\d+)?([e|E][\\-|\\+]\\d+)?)/', ': \"$1\"', $response, 1);\n-\t\t$resultObj = json_decode($response);\n-\t\t}\n-\t\t} catch( Exception $e ) {\n-\t\t\tthrow new Exception(\"Result is not a json object (\" . $e->getMessage() . \")\");\n-\t\t}\n-\n-\t\tif ($resultObj->ErrorCode==0){\t//success when ErrorCode = 0\n-\t\t$OrderCode = $resultObj->OrderCode;\n-\t\t$ErrorCode = $resultObj->ErrorCode;\n-\t\t$ErrorText = $resultObj->ErrorText;\n-\t\t}\n-\t\telse{\n-\t\t\tthrow new Exception(\"Unable to create order code (\" . $resultObj->ErrorText . \")\");\n-\t\t}\n-\n-\tif (version_compare(_PS_VERSION_, '1.5', '<')){\n-\t$seckey = $customer->secure_key;\n-\t} else {\n-\t$seckey = Context::getContext()->customer->secure_key;\n-\t}\n-\n-\t$tmquery = \"insert into vivawallet_data (secure_key, OrderCode, ErrorCode, ErrorText, Timestamp, ref, total_cost, currency, order_state) values ('\".$seckey.\"','\".$OrderCode.\"','\".$ErrorCode.\"','\".$ErrorText.\"',now(),'\".$cart->id.\"','\".$wb_total_cents.\"','\".$dest_currency['iso_code'].\"','I')\";\n-\tDb::getInstance()->execute($tmquery); //tommodps15\n-\n-\t$this->VivawalletUrl = $BaseUrl.'/web/newtransaction.aspx';\n-\n-\t\t$post_variables = Array(\n-\t\t'VivawalletUrl' \t\t=> $this->VivawalletUrl,\n-\t\t'Ref' \t\t\t\t=> $OrderCode);\n-\n-\t\t$formpost = '';\n-\t\tforeach ($post_variables as $name => $value) {\n-\t\t\t$formpost.= '<input type=\"hidden\" name=\"' . $name . '\" value=\"' . htmlspecialchars($value) . '\" />';\n-\t\t}\n-\n-\t\t$logo = Media::getMediaPath(_PS_MODULE_DIR_.$this->name.'/logos.png');\n-\n-        $formurl = $this->context->link->getModuleLink('vivawallet', 'pay', [], true);\n-\t\t$newOption = new PaymentOption();\n-        $newOption->setCallToActionText($this->l('Payment card (Viva Wallet)'))\n-\t\t->setLogo($logo)\n-\t\t->setForm('<form id=\"vivawallet_confirmation_form\" name=\"vivawallet_confirmation\" data-ajax=\"false\" action=\"'.$formurl.'\" method=\"post\">'.$formpost.'</form>');\n-\n-        return [$newOption];\n-\n-\t}\n-\n-\tprivate function _postValidation()\n-\t{\n-\t\tif (isset($_POST['btnSubmit']))\n-\t\t{\n-\t\t\tif (empty($_POST['vivawallet_MerchantId']))\n-\t\t\t\t$this->_postErrors[] = $this->l('Your MerchantId is required.');\n-\t\t\tif (empty($_POST['vivawallet_MerchantPass']))\n-\t\t\t\t$this->_postErrors[] = $this->l('Your MerchantPass is required.');\n-\t\t}\n-\t\telseif (isset($_POST['currenciesSubmit']))\n-\t\t{\n-\t\t\t$currencies = Currency::getCurrencies();\n-\t\t\t$authorized_currencies = array();\n-\t\t\tforeach ($currencies as $currency)\n-\t\t\t\tif (isset($_POST['currency_'.$currency['id_currency']]) AND $_POST['currency_'.$currency['id_currency']])\n-\t\t\t\t\t$authorized_currencies[] = $currency['id_currency'];\n-\t\t\tif (!sizeof($authorized_currencies))\n-\t\t\t\t$this->_postErrors[] = $this->l('at least one currency is required.');\n-\t\t}\n-\t}\n-\n-\tprivate function _postProcess()\n-\t{\n-\t\tif (isset($_POST['btnSubmit']))\n-\t\t{\n-\t\t\tConfiguration::updateValue('VIVAWALLET_MERCHANTID', trim($_POST['vivawallet_MerchantId']));\n-\t\t\tConfiguration::updateValue('VIVAWALLET_MERCHANTPASS', trim($_POST['vivawallet_MerchantPass']));\n-\t\t\tConfiguration::updateValue('VIVAWALLET_INSTAL', trim($_POST['vivawallet_wb_instal']));\n-\t\t\tConfiguration::updateValue('VIVAWALLET_URL', trim($_POST['vivawallet_wb_url']));\n-\t\t\tConfiguration::updateValue('VIVAWALLET_SOURCE', trim($_POST['vivawallet_Source']));\n-\t\t}\n-\t\telseif (isset($_POST['currenciesSubmit']))\n-\t\t{\n-\t\t\t$currencies = Currency::getCurrencies();\n-\t\t\t$authorized_currencies = array();\n-\t\t\tforeach ($currencies as $currency)\n-\t\t\t\tif (isset($_POST['currency_'.$currency['id_currency']]) AND $_POST['currency_'.$currency['id_currency']])\n-\t\t\t\t\t$authorized_currencies[] = $currency['id_currency'];\n-\t\t\tConfiguration::updateValue('VIVAWALLET_CURRENCIES', implode(',', $authorized_currencies));\n-\t\t}\n-\t\t$ok = $this->l('Ok');\n-\t\t$updated = $this->l('Settings Updated');\n-\t\t$this->_html .= \"<div class='conf confirm'><img src='../modules/vivawallet/ok.gif' alt='{$ok}' />{$updated}</div>\";\n-\t}\n-\n-\tprivate function _displayvivawallet()\n-\t{\n-\t\t$modDesc \t= $this->l('This module allows you to accept payments using Vivawallet.');\n-\t\t$modStatus\t= $this->l('Vivawallet online banking service could be the right solution for you');\n-\t\t$modconfirm\t= $this->l('');\n-\t\t$this->_html .= \"<img src='../modules/vivawallet/vivawallet.gif' style='float:left; margin-right:15px;' />\n-\t\t\t\t\t\t<b>{$modDesc}</b>\n-\t\t\t\t\t\t<br />\n-\t\t\t\t\t\t{$modconfirm}\n-\t\t\t\t\t\t<br />\n-\t\t\t\t\t\t<br />\n-\t\t\t\t\t\t<br />\";\n-\t}\n-\n-\n-\n-\n-\tprivate function _displayForm()\n-\t{\n-\t\t$modvivawallet\t\t\t= $this->l('Vivawallet Setup');\n-\t\t$modvivawalletDesc\t\t= $this->l('Please specify the gateway settings');\n-\t\t$modInstalLabel\t\t\t= $this->l('Instalment logic');\n-\t\t$modInstalDescription\t= $this->l('Instalment logic example: 300:3,600:6 -> Order total 300 euro: allow 3 instalments, order total 600: allow 3 and 6 instalments.');\n-\n-\t\t$modUrlLabel\t\t\t= $this->l('Base URL');\n-\t\t$modUrlDescription\t= $this->l('Use https://www.vivapayments.com for live and https://demo.vivapayments.com for demo environment.');\n-\n-\t\t$modMerchantId\t\t= $this->l('MerchantId');\n-\t\t$modMerchantPass\t\t= $this->l('API Key');\n-\t\t$modSource\t\t\t= $this->l('Source Code');\n-\n-\t\t$modCurrencies\t\t\t\t= $this->l('Currencies');\n-\t\t$modUpdateSettings \t\t\t= $this->l('Update settings');\n-\t\t$modCurrenciesDescription\t=$this->l('Currencies authorized for Vivawallet payment.');\n-\t\t$modAuthorizedCurrencies\t= $this->l('Authorized currencies');\n-\n-\t\t$this->_html .=\n-\t\t\"<form action='{$_SERVER['REQUEST_URI']}' method='post'>\n-\t\t\t<fieldset>\n-\t\t\t<legend><img src='../modules/vivawallet/access.png' />{$modvivawallet}</legend>\n-\t\t\t\t<table border='0' width='500' cellpadding='0' cellspacing='0' id='form'>\n-\t\t\t\t\t<tr>\n-\t\t\t\t\t\t<td colspan='2'>\n-\t\t\t\t\t\t\t{$modvivawalletDesc}<br /><br />\n-\t\t\t\t\t\t</td>\n-\t\t\t\t\t</tr>\";\n-\n-\t$this->_html .=\"<tr>\n-\t\t\t\t\t\t<td colspan='2'>\n-\t\t\t\t\t\t\t{$modInstalDescription}\n-\t\t\t\t\t\t\t<br />\n-\t\t\t\t\t\t\t<br />\n-\t\t\t\t\t\t</td>\n-\t\t\t\t\t</tr><tr>\n-\t\t\t\t\t\t<td width='130'>{$modInstalLabel}<br /><br /></td>\n-\t\t\t\t\t\t<td>\";\n-\t$this->_html .= '<input type=\"text\" name=\"vivawallet_wb_instal\" value=\"'.Tools::getValue('vivawallet_wb_instal', Configuration::get('VIVAWALLET_INSTAL')).'\" />';\n-\n-\t$this->_html .= \"<br /><br /></td>\n-\t\t\t\t\t</tr>\";\n-\n-\t$this->_html .=\"<tr>\n-\t\t\t\t\t\t<td colspan='2'>\n-\t\t\t\t\t\t\t{$modUrlDescription}\n-\t\t\t\t\t\t\t<br />\n-\t\t\t\t\t\t\t<br />\n-\t\t\t\t\t\t</td>\n-\t\t\t\t\t</tr><tr>\n-\t\t\t\t\t\t<td width='130'>{$modUrlLabel}<br /><br /></td>\n-\t\t\t\t\t\t<td>\";\n-\t$this->_html .= '<input type=\"text\" name=\"vivawallet_wb_url\" value=\"'.Tools::getValue('vivawallet_wb_url', Configuration::get('VIVAWALLET_URL')).'\" />';\n-\n-\t$this->_html .= \"<br /><br /></td>\n-\t\t\t\t\t</tr>\";\n-\n-\t$this->_html .=\"<tr>\n-\t\t\t\t\t\t<td width='130'>{$modMerchantId}<br /><br /></td>\n-\t\t\t\t\t\t<td>\";\n-\t$this->_html .= '<input type=\"text\" name=\"vivawallet_MerchantId\" value=\"'.Tools::getValue('vivawallet_MerchantId', Configuration::get('VIVAWALLET_MERCHANTID')).'\" />';\n-\t$this->_html .= \"<br /><br /></td>\n-\t\t\t\t\t</tr>\";\n-\t$this->_html .=\"<tr>\n-\t\t\t\t\t\t<td width='130'>{$modMerchantPass}<br /><br /></td>\n-\t\t\t\t\t\t<td>\";\n-\t$this->_html .= '<input type=\"text\" name=\"vivawallet_MerchantPass\" value=\"'.Tools::getValue('vivawallet_MerchantPass', Configuration::get('VIVAWALLET_MERCHANTPASS')).'\" />';\n-\t$this->_html .= \"<br /><br /></td>\n-\t\t\t\t\t</tr>\";\n-\n-\t$this->_html .=\"<tr>\n-\t\t\t\t\t\t<td width='130'>{$modSource}<br /><br /></td>\n-\t\t\t\t\t\t<td>\";\n-\t$this->_html .= '<input type=\"text\" name=\"vivawallet_Source\" value=\"'.Tools::getValue('vivawallet_Source', Configuration::get('VIVAWALLET_SOURCE')).'\" />';\n-\t$this->_html .= \"<br /><br /></td>\n-\t\t\t\t\t</tr>\";\n-\n-\n-\t$this->_html .= \"<tr>\n-\t\t\t\t\t\t<td colspan='2' align='center'>\n-\t\t\t\t\t\t\t<input class='button' name='btnSubmit' value='{$modUpdateSettings}' type='submit' />\n-\t\t\t\t\t\t</td>\n-\t\t\t\t\t</tr>\n-\t\t\t\t</table>\n-\t\t\t</fieldset>\n-\t\t</form>\n-\t\t<br />\n-\t\t<br />\n-\t\t<form action='{$_SERVER['REQUEST_URI']}' method='post'>\n-\t\t\t<fieldset>\n-\t\t\t<legend><img src='../modules/vivawallet/dollar.gif' />{$modAuthorizedCurrencies}</legend>\n-\t\t\t\t<table border='0' width='500' cellpadding='0' cellspacing='0' id='form'>\n-\t\t\t\t\t<tr>\n-\t\t\t\t\t\t<td colspan='2'>\n-\t\t\t\t\t\t\t{$modCurrenciesDescription}\n-\t\t\t\t\t\t\t<br />\n-\t\t\t\t\t\t\t<br />\n-\t\t\t\t\t\t</td>\n-\t\t\t\t\t</tr>\n-\t\t\t\t\t<tr>\n-\t\t\t\t\t\t<td width='130' style='height: 35px; vertical-align:top'>{$modCurrencies}</td>\n-\t\t\t\t\t\t<td>\";\n-\t\t\t$currencies = Currency::getCurrencies();\n-\t\t\t$authorized_currencies = array_flip(explode(',', Configuration::get('VIVAWALLET_CURRENCIES')));\n-\t\t\tforeach ($currencies as $currency)\n-\t\t\t\t$this->_html .= '<label style=\"float:none; \"><input type=\"checkbox\" value=\"true\" name=\"currency_'.$currency['id_currency'].'\"'.(isset($authorized_currencies[$currency['id_currency']]) ? ' checked=\"checked\"' : '').' />&nbsp;<span style=\"font-weight:bold;\">'.$currency['name'].'</span> ('.$currency['sign'].')</label><br />';\n-\t\t\t\t$this->_html .=\"\n-\t\t\t\t\t\t</td>\n-\t\t\t\t\t</tr>\n-\t\t\t\t\t<tr>\n-\t\t\t\t\t\t<td colspan='2' align='center'>\n-\t\t\t\t\t\t\t<br />\n-\t\t\t\t\t\t\t<input class='button' name='currenciesSubmit' value='{$modUpdateSettings}' type='submit' />\n-\t\t\t\t\t\t</td>\n-\t\t\t\t\t</tr>\n-\t\t\t\t</table>\n-\t\t\t</fieldset>\n-\t\t</form>\";\n-\t}\n-}\n-\n-?>"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.7/vivawallet/vivawallet.tpl",
          "status": "removed",
          "additions": 0,
          "deletions": 6,
          "patch": "@@ -1,6 +0,0 @@\n-<p class=\"payment_module\">\n-\t<a href=\"javascript:$('#vivawallet_form').submit();\" title=\"{l s='Pay with Vivawallet' mod='vivawallet'}\">\n-\t\t<img src=\"../vivawallet/{$module_dir}vivawallet.gif\" alt=\"{l s='Pay with Vivawallet' mod='vivawallet'}\" class=\"img-responsive\" />\n-\t\t{l s='Pay with Vivawallet' mod='vivawallet'}\n-\t</a>\n-</p>\n\\ No newline at end of file"
        },
        {
          "filename": "Plugins/prestashop/prestashop1.7/vivawallet/vivawallet_eu.gif",
          "status": "removed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "Plugins/prestashop/prestashop1.7/vivawallet1.7.zip",
          "status": "removed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 2,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 7,
        "max_directory_depth": 6
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "5120054a274f1bf4ab15633132bc7b1d67976274",
            "date": "2023-01-24T13:24:39Z",
            "author_login": "cmitsis-dev"
          },
          {
            "sha": "9939d618d787888039702a75761e04e31f5298ce",
            "date": "2023-01-24T11:04:24Z",
            "author_login": "cmitsis-dev"
          },
          {
            "sha": "89f660818912405cc1991895fdf9b885643d8b91",
            "date": "2023-01-24T11:00:26Z",
            "author_login": "cmitsis-dev"
          },
          {
            "sha": "8de92b741292c79438e8473bd25aebfcc66a0b88",
            "date": "2023-01-24T09:28:37Z",
            "author_login": "cmitsis-dev"
          },
          {
            "sha": "f1236967f4188c96e95ffbac655acaecc620bac5",
            "date": "2022-12-21T12:17:14Z",
            "author_login": "KostasPolymeropoulos"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 9.8,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
    "cwe_id": "CWE-89",
    "description": "SQL injection vulnerability found in PrestaShop vivawallet v.1.7.10 and before allows a remote attacker to gain privileges via the vivawallet() module.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-07-11T17:15:12.837",
    "last_modified": "2024-11-21T07:52:01.370",
    "fix_date": "2022-10-19T08:17:11Z"
  },
  "references": [
    {
      "url": "https://addons.prestashop.com/fr/paiement/89363-viva-wallet-smart-checkout.html",
      "source": "cve@mitre.org",
      "tags": [
        "Product"
      ]
    },
    {
      "url": "https://github.com/VivaPayments/API/commit/c1169680508c6e144d3e102ebdb257612e4cd84a",
      "source": "cve@mitre.org",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://security.friendsofpresta.org/modules/2023/07/11/vivawallet.html",
      "source": "cve@mitre.org",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://addons.prestashop.com/fr/paiement/89363-viva-wallet-smart-checkout.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Product"
      ]
    },
    {
      "url": "https://github.com/VivaPayments/API/commit/c1169680508c6e144d3e102ebdb257612e4cd84a",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://security.friendsofpresta.org/modules/2023/07/11/vivawallet.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:06:01.912197",
    "processing_status": "enhanced"
  }
}