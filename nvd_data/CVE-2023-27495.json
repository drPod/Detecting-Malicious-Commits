{
  "cve_id": "CVE-2023-27495",
  "github_data": {
    "repository": "fastify/csrf-protection",
    "fix_commit": "be3e5761f37aa05c7c1ac8ed44499c51ecec8058",
    "related_commits": [
      "be3e5761f37aa05c7c1ac8ed44499c51ecec8058",
      "be3e5761f37aa05c7c1ac8ed44499c51ecec8058"
    ],
    "patch_url": "https://github.com/fastify/csrf-protection/commit/be3e5761f37aa05c7c1ac8ed44499c51ecec8058.patch",
    "fix_commit_details": {
      "sha": "be3e5761f37aa05c7c1ac8ed44499c51ecec8058",
      "commit_date": "2023-04-20T07:39:58Z",
      "author": {
        "login": "marco-ippolito",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Merge pull request from GHSA-qrgf-9gpc-vrxw",
        "length": 404,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 144,
        "additions": 136,
        "deletions": 8
      },
      "files": [
        {
          "filename": "README.md",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -161,6 +161,7 @@ You can also pass the [cookie serialization](https://github.com/fastify/fastify-\n The option `userInfo` is required if `getUserInfo` has been specified in the module option.\n The provided `userInfo` is hashed  inside the csrf token and it is not directly exposed.\n This option is needed to protect against cookie tossing.\n+The option `csrfOpts.hmacKey` is required if `getUserInfo` has been specified in the module option in combination with using [@fastify/cookie](https://github.com/fastify/fastify-cookie) as sessionPlugin\n \n ### `fastify.csrfProtection(request, reply, next)`\n "
        },
        {
          "filename": "index.js",
          "status": "modified",
          "additions": 5,
          "deletions": 0,
          "patch": "@@ -42,6 +42,11 @@ async function fastifyCsrfProtection (fastify, opts) {\n   if (opts.getUserInfo) {\n     csrfOpts.userInfo = true\n   }\n+\n+  if (sessionPlugin === '@fastify/cookie' && csrfOpts.userInfo) {\n+    assert(csrfOpts.hmacKey, 'csrfOpts.hmacKey is required')\n+  }\n+\n   const tokens = new CSRF(csrfOpts)\n \n   const isCookieSigned = cookieOpts && cookieOpts.signed"
        },
        {
          "filename": "test/user-info.test.js",
          "status": "modified",
          "additions": 88,
          "deletions": 0,
          "patch": "@@ -17,6 +17,9 @@ test('Cookies with User-Info', async t => {\n   await fastify.register(fastifyCsrf, {\n     getUserInfo (req) {\n       return userInfoDB[req.body.username]\n+    },\n+    csrfOpts: {\n+      hmacKey: 'foo'\n     }\n   })\n \n@@ -73,6 +76,9 @@ test('Session with User-Info', async t => {\n     sessionPlugin: '@fastify/session',\n     getUserInfo (req) {\n       return req.session.username\n+    },\n+    csrfOpts: {\n+      hmacKey: 'foo'\n     }\n   })\n \n@@ -122,6 +128,9 @@ test('SecureSession with User-Info', async t => {\n     sessionPlugin: '@fastify/secure-session',\n     getUserInfo (req) {\n       return req.session.get('username')\n+    },\n+    csrfOpts: {\n+      hmacKey: 'foo'\n     }\n   })\n \n@@ -163,3 +172,82 @@ test('SecureSession with User-Info', async t => {\n \n   t.equal(response2.statusCode, 200)\n })\n+\n+test('Validate presence of hmac key with User-Info /1', async (t) => {\n+  const fastify = Fastify()\n+  await fastify.register(fastifyCookie)\n+\n+  await t.rejects(fastify.register(fastifyCsrf, {\n+    getUserInfo (req) {\n+      return req.session.get('username')\n+    }\n+  }), Error('csrfOpts.hmacKey is required'))\n+})\n+\n+test('Validate presence of hmac key with User-Info /2', async (t) => {\n+  const fastify = Fastify()\n+  await fastify.register(fastifyCookie)\n+\n+  await t.rejects(fastify.register(fastifyCsrf, {\n+    getUserInfo (req) {\n+      return req.session.get('username')\n+    },\n+    sessionPlugin: '@fastify/cookie'\n+  }), Error('csrfOpts.hmacKey is required'))\n+})\n+\n+test('Validate presence of hmac key with User-Info /3', async (t) => {\n+  const fastify = Fastify()\n+  await fastify.register(fastifyCookie)\n+\n+  await t.rejects(fastify.register(fastifyCsrf, {\n+    getUserInfo (req) {\n+      return req.session.get('username')\n+    },\n+    csrfOpts: {\n+      hmacKey: undefined\n+    }\n+  }), Error('csrfOpts.hmacKey is required'))\n+})\n+\n+test('Validate presence of hmac key with User-Info /4', async (t) => {\n+  const fastify = Fastify()\n+  await fastify.register(fastifyCookie)\n+\n+  await t.rejects(fastify.register(fastifyCsrf, {\n+    getUserInfo (req) {\n+      return req.session.get('username')\n+    },\n+    sessionPlugin: '@fastify/cookie',\n+    csrfOpts: {\n+      hmacKey: undefined\n+    }\n+  }), Error('csrfOpts.hmacKey is required'))\n+})\n+\n+test('Validate presence of hmac key with User-Info /5', async (t) => {\n+  const fastify = Fastify()\n+  await fastify.register(fastifySecureSession, { key, cookie: { path: '/', secure: false } })\n+\n+  await t.resolves(fastify.register(fastifyCsrf, {\n+    getUserInfo (req) {\n+      return req.session.get('username')\n+    },\n+    sessionPlugin: '@fastify/secure-session'\n+  }))\n+})\n+\n+test('Validate presence of hmac key with User-Info /6', async (t) => {\n+  const fastify = Fastify()\n+  await fastify.register(fastifySecureSession, { key, cookie: { path: '/', secure: false } })\n+\n+  await t.resolves(fastify.register(fastifyCsrf, {\n+    getUserInfo (req) {\n+      return req.session.get('username')\n+    },\n+    sessionPlugin: '@fastify/secure-session',\n+    csrfOpts: {\n+      hmacKey: 'foo'\n+    }\n+  }))\n+})"
        },
        {
          "filename": "types/index.d.ts",
          "status": "modified",
          "additions": 23,
          "deletions": 4,
          "patch": "@@ -26,17 +26,36 @@ declare namespace fastifyCsrfProtection {\n   export type CookieSerializeOptions = FastifyCookieSerializeOptions\n \n   export type GetTokenFn = (req: FastifyRequest) => string | void;\n-  \n-  export interface FastifyCsrfProtectionOptions {\n-    csrfOpts?: CSRFOptions;\n+\n+  interface FastifyCsrfProtectionOptionsBase {\n     cookieKey?: string;\n     cookieOpts?: CookieSerializeOptions;\n     sessionKey?: string;\n     getUserInfo?: (req: FastifyRequest) => string;\n     getToken?: GetTokenFn;\n-    sessionPlugin?: '@fastify/cookie' | '@fastify/session' | '@fastify/secure-session';\n   }\n \n+  interface FastifyCsrfProtectionOptionsFastifyCookie {\n+    sessionPlugin?: '@fastify/cookie';\n+    csrfOpts: Omit<CSRFOptions, 'hmacKey'> & Required<Pick<CSRFOptions, 'hmacKey'>>;\n+  }\n+\n+  interface FastifyCsrfProtectionOptionsFastifySession {\n+    sessionPlugin: '@fastify/session';\n+    csrfOpts?: CSRFOptions;\n+  }\n+\n+  interface FastifyCsrfProtectionOptionsFastifySecureSession {\n+    sessionPlugin: '@fastify/secure-session';\n+    csrfOpts?: CSRFOptions;\n+  }\n+\n+  export type FastifyCsrfProtectionOptions = FastifyCsrfProtectionOptionsBase & (\n+    FastifyCsrfProtectionOptionsFastifyCookie |\n+    FastifyCsrfProtectionOptionsFastifySession |\n+    FastifyCsrfProtectionOptionsFastifySecureSession\n+  )\n+\n   /**\n    * @deprecated Use FastifyCsrfProtectionOptions instead\n    */"
        },
        {
          "filename": "types/index.test-d.ts",
          "status": "modified",
          "additions": 19,
          "deletions": 4,
          "patch": "@@ -31,13 +31,28 @@ async function run() {\n }\n \n \n-fastify.register(FastifyCsrfProtection, { csrfOpts: { algorithm: 'sha1' } })\n+fastify.register(FastifyCsrfProtection, { csrfOpts: { algorithm: 'sha1', hmacKey: 'hmac' } })\n expectError(fastify.register(FastifyCsrfProtection, { csrfOpts: { algorithm: 1 } }))\n \n fastify.register(FastifySession)\n-fastify.register(FastifyCsrfProtection, { getUserInfo(req) {\n-  return req.session.get('username')\n-}})\n+fastify.register(FastifyCsrfProtection, {\n+  csrfOpts: {\n+    hmacKey: '123'\n+  },\n+  getUserInfo(req) {\n+    return req.session.get('username')\n+  }\n+})\n expectError(fastify.register(FastifyCsrfProtection, { getUserInfo: 'invalid' }))\n \n+fastify.register(FastifyCsrfProtection, { csrfOpts: { hmacKey: 'hmac' }, sessionPlugin: '@fastify/cookie' })\n+fastify.register(FastifyCsrfProtection, { csrfOpts: { hmacKey: 'hmac' } })\n+expectError(fastify.register(FastifyCsrfProtection, { }))\n+expectError(fastify.register(FastifyCsrfProtection, { csrfOpts: { }}))\n+expectError(fastify.register(FastifyCsrfProtection, { sessionPlugin: '@fastify/cookie', csrfOpts: { }}))\n+fastify.register(FastifyCsrfProtection, { csrfOpts: { }, sessionPlugin: '@fastify/session' })\n+fastify.register(FastifyCsrfProtection, { csrfOpts: { }, sessionPlugin: '@fastify/secure-session' })\n+fastify.register(FastifyCsrfProtection, { sessionPlugin: '@fastify/session' })\n+fastify.register(FastifyCsrfProtection, { sessionPlugin: '@fastify/secure-session' })\n+\n expectDeprecated({} as FastifyCsrfOptions)"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 2,
        "unique_directories": 3,
        "max_directory_depth": 1
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "71678f9a264a56ee1924a6bf9c66d3ccaa619ab0",
            "date": "2025-01-13T04:40:56Z",
            "author_login": "dependabot[bot]"
          },
          {
            "sha": "734ef4dfcb8ca422dac32ec6f7bf8fefc0a74476",
            "date": "2025-01-10T18:02:39Z",
            "author_login": "ilteoood"
          },
          {
            "sha": "b2d9892007982fbe2cbd2cd06ccf514d8acf94c5",
            "date": "2025-01-05T11:30:03Z",
            "author_login": "Fdawgs"
          },
          {
            "sha": "a405202995fa4bd0dabfcbf2f136c8022dd3aa98",
            "date": "2025-01-05T11:29:21Z",
            "author_login": "Fdawgs"
          },
          {
            "sha": "178a535d0fca2c09cb6d8aa4e9953404e7b79626",
            "date": "2025-01-05T11:12:07Z",
            "author_login": "Fdawgs"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 5.3,
    "cvss_vector": "CVSS:3.1/AV:N/AC:H/PR:N/UI:R/S:U/C:N/I:H/A:N",
    "cwe_id": "CWE-352",
    "description": "@fastify/csrf-protection is a plugin which helps protect Fastify servers against CSRF attacks. The CSRF protection enforced by the @fastify/csrf-protection library in combination with @fastify/cookie can be bypassed from network and same-site attackers under certain conditions. @fastify/csrf-protection supports an optional userInfo parameter that binds the CSRF token to the user. This parameter has been introduced to prevent cookie-tossing attacks as a fix for CVE-2021-29624. Whenever userInfo parameter is missing, or its value can be predicted for the target user account, network and same-site attackers can 1. fixate a _csrf cookie in the victim's browser, and 2. forge CSRF tokens that are valid for the victim's session. This allows attackers to bypass the CSRF protection mechanism. As a fix, @fastify/csrf-protection starting from version 6.3.0 (and v4.1.0) includes a server-defined secret hmacKey that cryptographically binds the CSRF token to the value of the _csrf cookie and the userInfo parameter, making tokens non-spoofable by attackers. This protection is effective as long as the userInfo parameter is unique for each user. This is patched in versions 6.3.0 and v4.1.0. Users are advised to upgrade. Users unable to upgrade may use a random, non-predictable userInfo parameter for each user as a mitigation.",
    "attack_vector": "NETWORK",
    "attack_complexity": "HIGH"
  },
  "temporal_data": {
    "published_date": "2023-04-20T18:15:07.233",
    "last_modified": "2024-11-21T07:53:01.347",
    "fix_date": "2023-04-20T07:39:58Z"
  },
  "references": [
    {
      "url": "https://github.com/fastify/csrf-protection/commit/be3e5761f37aa05c7c1ac8ed44499c51ecec8058",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/fastify/csrf-protection/security/advisories/GHSA-qrgf-9gpc-vrxw",
      "source": "security-advisories@github.com",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://www.cvedetails.com/cve/CVE-2021-29624",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/fastify/csrf-protection/commit/be3e5761f37aa05c7c1ac8ed44499c51ecec8058",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/fastify/csrf-protection/security/advisories/GHSA-qrgf-9gpc-vrxw",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://www.cvedetails.com/cve/CVE-2021-29624",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:05:11.817548",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "csrf-protection",
    "owner": "fastify",
    "created_at": "2019-01-07T07:09:39Z",
    "updated_at": "2025-01-13T04:41:00Z",
    "pushed_at": "2025-01-13T04:41:04Z",
    "size": 215,
    "stars": 154,
    "forks": 20,
    "open_issues": 5,
    "watchers": 154,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "master"
    ],
    "languages": {
      "JavaScript": 21313,
      "TypeScript": 2499
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T19:49:16.209366"
  }
}