{
  "cve_id": "CVE-2023-28629",
  "github_data": {
    "repository": "gocd/gocd",
    "fix_commit": "95f758229d419411a38577608709d8552cccf193",
    "related_commits": [
      "95f758229d419411a38577608709d8552cccf193",
      "c6aa644973b034305bbe9ea34b010dcf5b5790ce",
      "95f758229d419411a38577608709d8552cccf193",
      "c6aa644973b034305bbe9ea34b010dcf5b5790ce"
    ],
    "patch_url": "https://github.com/gocd/gocd/commit/95f758229d419411a38577608709d8552cccf193.patch",
    "fix_commit_details": {
      "sha": "95f758229d419411a38577608709d8552cccf193",
      "commit_date": "2022-12-03T16:08:05Z",
      "author": {
        "login": "chadlwilson",
        "type": "User",
        "stats": {
          "total_commits": 5215,
          "average_weekly_commits": 8.991379310344827,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 185
        }
      },
      "commit_message": {
        "title": "Improve escaping on legacy Freemarker templates",
        "length": 47,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 211,
        "additions": 138,
        "deletions": 73
      },
      "files": [
        {
          "filename": "server/src/main/java/com/thoughtworks/go/server/presentation/models/MaterialRevisionsJsonBuilder.java",
          "status": "modified",
          "additions": 7,
          "deletions": 7,
          "patch": "@@ -33,10 +33,10 @@\n import static java.lang.String.valueOf;\n \n public class MaterialRevisionsJsonBuilder extends ModificationVisitorAdapter {\n-    private List materials = new ArrayList();\n+    private final List<Object> materials = new ArrayList<>();\n     private Map<String, Object> materialJson;\n-    private List modificationsJson;\n-    private List modifiedFilesJson;\n+    private List<Object> modificationsJson;\n+    private List<Object> modifiedFilesJson;\n     private boolean includeModifiedFiles = true;\n     private final CommentRenderer commentRenderer;\n     private MaterialRevision revision;\n@@ -48,9 +48,9 @@ public MaterialRevisionsJsonBuilder(CommentRenderer commentRenderer) {\n     @Override\n     public void visit(MaterialRevision revision) {\n         this.revision = revision;\n-        modificationsJson = new ArrayList();\n+        modificationsJson = new ArrayList<>();\n \n-        materialJson = new LinkedHashMap();\n+        materialJson = new LinkedHashMap<>();\n         materialJson.put(\"revision\", revision.getRevision().getRevision());\n         materialJson.put(\"revision_href\", revision.getRevision().getRevisionUrl());\n         materialJson.put(\"user\", revision.buildCausedBy());\n@@ -68,7 +68,7 @@ public void visit(Material material, Revision revision) {\n \n     @Override\n     public void visit(Modification modification) {\n-        modifiedFilesJson = new ArrayList();\n+        modifiedFilesJson = new ArrayList<>();\n \n         Map<String, Object> jsonMap = new LinkedHashMap<>();\n         jsonMap.put(\"user\", modification.getUserDisplayName());\n@@ -97,7 +97,7 @@ public void visit(ModifiedFile file) {\n         modifiedFilesJson.add(jsonMap);\n     }\n \n-    public List json() {\n+    public List<Object> json() {\n         return materials;\n     }\n "
        },
        {
          "filename": "server/src/main/resources/freemarker-config.xml",
          "status": "modified",
          "additions": 6,
          "deletions": 1,
          "patch": "@@ -25,12 +25,17 @@\n             </list>\n         </property>\n         <property name=\"defaultEncoding\" value=\"utf-8\"/>\n+        <property name=\"freemarkerSettings\">\n+          <props>\n+            <prop key=\"recognizeStandardFileExtensions\">true</prop>\n+          </props>\n+        </property>\n     </bean>\n \n     <bean id=\"freeMarkerViewResolver\" class=\"org.springframework.web.servlet.view.freemarker.FreeMarkerViewResolver\">\n         <property name=\"cache\" value=\"true\"/>\n         <property name=\"prefix\" value=\"\"/>\n-        <property name=\"suffix\" value=\".ftl\"/>\n+        <property name=\"suffix\" value=\".ftlh\"/>\n         <property name=\"exposeSessionAttributes\" value=\"true\"/>\n         <property name=\"exposeSpringMacroHelpers\" value=\"true\"/>\n         <property name=\"requestContextAttribute\" value=\"req\"/>"
        },
        {
          "filename": "server/src/main/webapp/WEB-INF/rails/app/assets/config/manifest.js",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -19,7 +19,7 @@\n //= link application.js\n //= link lib/d3-3.1.5.min.js\n \n-// Used by legacy templates `_header.ftl`\n+// Used by legacy templates `_header.ftlh`\n //= link application.css\n //= link patterns/application.css\n //= link css/application.css"
        },
        {
          "filename": "server/src/main/webapp/WEB-INF/vm/build_detail/_artifacts.ftlh",
          "status": "renamed",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -23,6 +23,6 @@\n         </#if>\n     </#if>\n   <div class=\"files\">\n-      <#include \"../shared/_artifacts.ftl\">\n+      <#include \"../shared/_artifacts.ftlh\">\n   </div>\n </div>"
        },
        {
          "filename": "server/src/main/webapp/WEB-INF/vm/build_detail/_build_detail_summary_jstemplate.ftlh",
          "status": "renamed",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -33,7 +33,7 @@\n   </#if>\n </li>\n   <li><span class=\"header\">Completed on: </span><span id=\"build_completed_date\">${r'${% build.build_completed_date %}'}</span></li>\n-<li><span class=\"header\">Build cause: </span><span id=\"stage-${r'${% build.id %}'}-buildCause\">${presenter.buildCauseMessage?html?html}</span></li>\n+<li><span class=\"header\">Build cause: </span><span id=\"stage-${r'${% build.id %}'}-buildCause\"><#noautoesc>${presenter.buildCauseMessage?html?html}</#noautoesc></span></li>\n   {if build.current_status.toLowerCase() == 'passed' ||  build.current_status.toLowerCase() == 'failed'}\n <li><span class=\"header\">Duration: </span><span>${r\"${% moment.duration(parseInt(build.current_build_duration), 's').humanizeForGoCD() %}\"}</span></li>\n {/if}"
        },
        {
          "filename": "server/src/main/webapp/WEB-INF/vm/build_detail/_build_output_raw.ftlh",
          "status": "renamed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "server/src/main/webapp/WEB-INF/vm/build_detail/_buildoutput.ftlh",
          "status": "renamed",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -15,5 +15,5 @@\n  -->\n <#-- @ftlvariable name=\"buildoutput_extra_attrs\" type=\"java.lang.String\" -->\n <div id=\"tab-content-of-console\" class=\"ansi-color-toggle\" ${buildoutput_extra_attrs}>\n-    <#include \"_build_output_raw.ftl\">\n+    <#include \"_build_output_raw.ftlh\">\n </div>"
        },
        {
          "filename": "server/src/main/webapp/WEB-INF/vm/build_detail/_customized.ftlh",
          "status": "renamed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "server/src/main/webapp/WEB-INF/vm/build_detail/_material_revisions_jstemplate.ftl",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -46,7 +46,7 @@\n                     <span title=\"Comment\" class=\"comment\">\n \n                         {if revision.scmType == 'Package' }\n-                            <#include '../shared/_package_material_revision_comment.ftl'>\n+                            <#include '../shared/_package_material_revision_comment.ftlh'>\n                         {else}\n                             <#noparse>\"${%comment.replace(/\\n/g,\"<br>\")%}\"</#noparse>\n                         {/if}"
        },
        {
          "filename": "server/src/main/webapp/WEB-INF/vm/build_detail/_materials.ftlh",
          "status": "renamed",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -16,7 +16,7 @@\n <#-- @ftlvariable name=\"modification_extra_attrs\" type=\"java.lang.String\" -->\n <div id=\"tab-content-of-materials\" class=\"widget\" ${modification_extra_attrs}>\n     <script type=\"text/javascript\">\n-        var json = ${presenter.getMaterialRevisionsJson()};\n+        var json = ${presenter.getMaterialRevisionsJson()?no_esc};\n     </script>\n     <script type=\"text/javascript\">\n         Event.observe(window, 'load', function(){"
        },
        {
          "filename": "server/src/main/webapp/WEB-INF/vm/build_detail/_test_output_config.ftlh",
          "status": "renamed",
          "additions": 11,
          "deletions": 9,
          "patch": "@@ -17,17 +17,19 @@\n <p>No test output found. Make sure your job configuration includes a test artifact.</p><br/>\n <p>For example:</p><br/>\n <pre>\n+<#noautoesc>\n &lt;job name=\"example\"&gt;\n-  ${tab} &lt;resources&gt;\n-  ${tab}${tab} &lt;resource&gt;java&lt;/resource&gt;\n-  ${tab} &lt;/resources&gt;\n-  <strong class='code'>${tab} &lt;artifacts&gt;\n-  ${tab}${tab} &lt;test src=\"target/reports\" /&gt;\n-  ${tab} &lt;/artifacts&gt;</strong>\n-  ${tab} &lt;tasks&gt;\n-  ${tab}${tab} &lt;ant target=\"unit_tests\" /&gt;\n-  ${tab} &lt;/tasks&gt;\n+${tab}&lt;resources&gt;\n+${tab}${tab}&lt;resource&gt;java&lt;/resource&gt;\n+${tab}&lt;/resources&gt;\n+<strong class='code'>${tab}&lt;artifacts&gt;\n+${tab}${tab}&lt;test src=\"target/reports\" /&gt;\n+${tab}&lt;/artifacts&gt;</strong>\n+${tab}&lt;tasks&gt;\n+${tab}${tab}&lt;ant target=\"unit_tests\" /&gt;\n+${tab}&lt;/tasks&gt;\n &lt;/job&gt;\n+</#noautoesc>\n </pre>\n <br/>\n <p><a href=\"${currentGoCDVersion.docsUrl('/configuration/managing_artifacts_and_reports.html')}\" target='_blank' class=\"obvious_link\">Help Topic: Managing Artifacts and Reports</a></p>"
        },
        {
          "filename": "server/src/main/webapp/WEB-INF/vm/build_detail/_tests.ftlh",
          "status": "renamed",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -19,7 +19,7 @@\n         <#if presenter.hasTests()>\n             <iframe sandbox=\"allow-scripts\" src=\"${req.getContextPath()}/${presenter.indexPageURL}\" width=\"95%\" height=\"500\" frameborder=\"0\"></iframe>\n         <#else>\n-            <#include \"_test_output_config.ftl\">\n+            <#include \"_test_output_config.ftlh\">\n         </#if>\n     </div>\n </div>"
        },
        {
          "filename": "server/src/main/webapp/WEB-INF/vm/build_detail/build_detail_page.ftlh",
          "status": "renamed",
          "additions": 12,
          "deletions": 12,
          "patch": "@@ -16,33 +16,33 @@\n <#assign title = \"${presenter.buildName} Job Details - Go\">\n <#assign _page_title = \"Job Details for ${presenter.buildLocatorForDisplay}\">\n <#assign current_tab = \"build\">\n-<#include \"../shared/_header.ftl\">\n+<#include \"../shared/_header.ftlh\">\n \n-<#include \"_build_detail_summary_jstemplate.ftl\">\n+<#include \"_build_detail_summary_jstemplate.ftlh\">\n <div id=\"yui-main\">\n   <div class=\"yui-b\">\n     <!-- breadcrumbs -->\n       <#assign current_page=\"build_detail\">\n       <#assign pipelineName=\"${presenter.pipelineName}\">\n       <#assign stageLocator=\"${presenter.stageLocator}\">\n \n-      <#include \"../shared/_job_details_breadcrumbs.ftl\">\n+      <#include \"../shared/_job_details_breadcrumbs.ftlh\">\n     <!-- /breadcrumbs -->\n \n     <div class=\"content_wrapper_outer\">\n       <div class=\"row\">\n         <div class=\"content_wrapper_inner\">\n           <div id=\"build-status-panel\" class=\"bd-container rounded-corner-for-pipeline\">\n             <div class=\"maincol build_detail\">\n-                <#include \"../shared/_flash_message.ftl\">\n+                <#include \"../shared/_flash_message.ftlh\">\n                 <#assign jobConfigName = \"${presenter.buildName}\">\n               <div id=\"build_detail_summary_container\" class=\"build_detail_summary\">\n                 <ul id=\"build-detail-summary\" class=\"summary\">\n                   <li><span class=\"header\">Scheduled on: </span><span id=\"build_scheduled_date\">Loading...</span></li>\n                   <li><span class=\"header\">Agent: </span><span id=\"agent_name\">Loading...</span></li>\n                   <li><span class=\"header\">Completed on: </span><span id=\"build_completed_date\">Loading...</span></li>\n                   <li><span class=\"header\">Build cause: </span><span\n-                    id=\"stage-${presenter.id?c}-buildCause\">${presenter.buildCauseMessage?html}</span></li>\n+                    id=\"stage-${presenter.id?c}-buildCause\">${presenter.buildCauseMessage}</span></li>\n                   <li class=\"timer_area\">\n                     <div class=\"progress-info\">\n                       <div id=\"${presenter.buildName}_progress_bar\" class=\"progress-bar\" style=\"display: none;\">\n@@ -93,7 +93,7 @@\n                 </div>\n \n               <div class=\"sidebar_history\">\n-                  <#include \"../sidebar/_sidebar_build_list.ftl\">\n+                  <#include \"../sidebar/_sidebar_build_list.ftlh\">\n               </div>\n                 <div class=\"build_detail_container sub_tab_container rounded-corner-for-tab-container\">\n \n@@ -102,20 +102,20 @@\n                     <div class=\"clear\"></div>\n \n                       <#assign buildoutput_extra_attrs=\"\">\n-                      <#include \"_buildoutput.ftl\">\n+                      <#include \"_buildoutput.ftlh\">\n \n                       <#assign tests_extra_attrs=\"style='display:none'\">\n-                      <#include \"_tests.ftl\">\n+                      <#include \"_tests.ftlh\">\n \n                       <#assign artifacts_extra_attrs=\"style='display:none'\">\n-                      <#include \"_artifacts.ftl\">\n+                      <#include \"_artifacts.ftlh\">\n \n                       <#assign modification_extra_attrs=\"style='display:none'\">\n-                      <#include \"_materials.ftl\">\n+                      <#include \"_materials.ftlh\">\n                       <#list presenter.customizedTabs as tab>\n                         <#assign customized_name=\"${tab.name}\">\n                         <#assign customized_path=\"${tab.path}\">\n-                        <#include \"_customized.ftl\">\n+                        <#include \"_customized.ftlh\">\n                       </#list>\n                   </div>\n                 </div>\n@@ -128,4 +128,4 @@\n   </div>\n </div>\n </div>\n-<#include \"../shared/_footer.ftl\">\n+<#include \"../shared/_footer.ftlh\">"
        },
        {
          "filename": "server/src/main/webapp/WEB-INF/vm/exceptions_page.ftlh",
          "status": "renamed",
          "additions": 4,
          "deletions": 5,
          "patch": "@@ -15,15 +15,14 @@\n  -->\n <#-- @ftlvariable name=\"errorMessage\" type=\"java.lang.String\" -->\n <#assign title = 'Exception Detail - GoCD'>\n-<#include \"shared/_header.ftl\">\n-<#include \"shared/_flash_message.ftl\">\n+<#include \"shared/_header.ftlh\">\n+<#include \"shared/_flash_message.ftlh\">\n     <div id=\"yui-main\">\n         <div class=\"yui-b\"></div>\n     </div>\n     <script type=\"text/javascript\">\n-        $('trans_content').update(\"Sorry, an unexpected error occurred<#if errorMessage??> [${errorMessage?js_string?html}]</#if>. :( Please check the server logs for more information.\");\n-        var transMessage = new TransMessage('trans_message', document.body,\n-                {type: TransMessage.TYPE_ERROR, offsetTop: 200, autoHide: false});\n+        $('trans_content').update(\"Sorry, an unexpected error occurred<#if errorMessage??> [${errorMessage?js_string?no_esc}]</#if>. :( Please check the server logs for more information.\");\n+        var transMessage = new TransMessage('trans_message', document.body, {type: TransMessage.TYPE_ERROR, offsetTop: 200, autoHide: false});\n     </script>\n \n </body>"
        },
        {
          "filename": "server/src/main/webapp/WEB-INF/vm/rest/html.ftlh",
          "status": "renamed",
          "additions": 3,
          "deletions": 3,
          "patch": "@@ -16,7 +16,7 @@\n  -->\n <#-- @ftlvariable name=\"jobIdentifier\" type=\"com.thoughtworks.go.domain.JobIdentifier\" -->\n <#assign title = \"Artifacts for ${jobIdentifier.pipelineName} > ${jobIdentifier.pipelineLabel} > ${jobIdentifier.stageName} > ${jobIdentifier.stageCounter} > ${jobIdentifier.buildName}\">\n-<#include \"../shared/_header.ftl\">\n+<#include \"../shared/_header.ftlh\">\n \n <div id=\"yui-main\">\n     <div class=\"yui-b\">\n@@ -26,10 +26,10 @@\n                 <h2>${title}</h2>\n \n                 <div id=\"artifacts\" class=\"container-in-body\">\n-                    <#include \"../shared/_artifacts.ftl\">\n+                    <#include \"../shared/_artifacts.ftlh\">\n                 </div>\n             </div>\n         </div>\n \n-<#include \"../shared/_footer.ftl\">\n+<#include \"../shared/_footer.ftlh\">\n "
        },
        {
          "filename": "server/src/main/webapp/WEB-INF/vm/shared/_artifact_entry.ftlh",
          "status": "renamed",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -13,4 +13,4 @@\n  * See the License for the specific language governing permissions and\n  * limitations under the License.\n  -->\n-${presenter.renderArtifactFiles(req.getContextPath())}\n+${presenter.renderArtifactFiles(req.getContextPath())?no_esc}"
        },
        {
          "filename": "server/src/main/webapp/WEB-INF/vm/shared/_artifacts.ftlh",
          "status": "renamed",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -13,7 +13,7 @@\n  * See the License for the specific language governing permissions and\n  * limitations under the License.\n  -->\n-<#include '_artifact_entry.ftl'>\n+<#include '_artifact_entry.ftlh'>\n \n <script type=\"text/javascript\">\n     try{"
        },
        {
          "filename": "server/src/main/webapp/WEB-INF/vm/shared/_flash_message.ftlh",
          "status": "renamed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "server/src/main/webapp/WEB-INF/vm/shared/_footer.ftlh",
          "status": "renamed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "server/src/main/webapp/WEB-INF/vm/shared/_header.ftlh",
          "status": "renamed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "server/src/main/webapp/WEB-INF/vm/shared/_job_details_breadcrumbs.ftlh",
          "status": "renamed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "server/src/main/webapp/WEB-INF/vm/shared/_package_material_revision_comment.ftlh",
          "status": "renamed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "server/src/main/webapp/WEB-INF/vm/sidebar/_sidebar_build_list.ftlh",
          "status": "renamed",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -37,7 +37,7 @@\n     </div>\n     <script type=\"text/javascript\">\n         <#list presenter.recent25 as listPresenter>\n-        json_to_css.update_build_list(eval(${listPresenter.toJsonString()}), ${listPresenter?counter}, \"${req.getContextPath()}/${concatenatedStageBarCancelledIconFilePath}\");\n+        json_to_css.update_build_list(eval(${listPresenter.toJsonString()?no_esc}), ${listPresenter?counter}, \"${req.getContextPath()}/${concatenatedStageBarCancelledIconFilePath}\");\n         </#list>\n \n       jQuery(function() {"
        },
        {
          "filename": "server/src/test-fast/java/com/thoughtworks/go/server/view/freemarker/AbstractFreemarkerTemplateTest.java",
          "status": "renamed",
          "additions": 12,
          "deletions": 1,
          "patch": "@@ -14,19 +14,24 @@\n  * limitations under the License.\n  */\n \n-package com.thoughtworks.go.server.view.velocity;\n+package com.thoughtworks.go.server.view.freemarker;\n \n import com.thoughtworks.go.server.service.*;\n+import org.jsoup.parser.Parser;\n+import org.junit.jupiter.api.AfterEach;\n import org.junit.jupiter.api.extension.ExtendWith;\n import org.mockito.AdditionalAnswers;\n import org.mockito.Mock;\n import org.mockito.junit.jupiter.MockitoExtension;\n \n+import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Mockito.*;\n \n @ExtendWith(MockitoExtension.class)\n public class AbstractFreemarkerTemplateTest {\n     protected TestFreeMarkerView view;\n+    protected final Parser parser = Parser.htmlParser().setTrackErrors(100);\n+\n     @Mock\n     private RailsAssetsService railsAssetsService;\n     @Mock\n@@ -51,4 +56,10 @@ public void setUp(String template) throws Exception {\n         lenient().doReturn(securityService).when(view).getSecurityService();\n         lenient().doReturn(maintenanceModeService).when(view).getMaintenanceModeService();\n     }\n+\n+    @AfterEach\n+    public void checkParseErrors() {\n+        assertThat(parser.isTrackErrors()).isTrue();\n+        assertThat(parser.getErrors()).isEmpty();\n+    }\n }"
        },
        {
          "filename": "server/src/test-fast/java/com/thoughtworks/go/server/view/freemarker/BuildDetailPageFreeMarkerTemplateTest.java",
          "status": "renamed",
          "additions": 53,
          "deletions": 18,
          "patch": "@@ -13,21 +13,22 @@\n  * See the License for the specific language governing permissions and\n  * limitations under the License.\n  */\n-package com.thoughtworks.go.server.view.velocity;\n+package com.thoughtworks.go.server.view.freemarker;\n \n import com.thoughtworks.go.config.Tabs;\n import com.thoughtworks.go.config.TrackingTool;\n import com.thoughtworks.go.config.materials.MaterialConfigs;\n import com.thoughtworks.go.config.materials.git.GitMaterial;\n import com.thoughtworks.go.config.materials.git.GitMaterialConfig;\n+import com.thoughtworks.go.domain.JobInstance;\n import com.thoughtworks.go.domain.JobInstances;\n import com.thoughtworks.go.domain.MaterialRevisions;\n import com.thoughtworks.go.domain.Pipeline;\n import com.thoughtworks.go.domain.materials.Modification;\n import com.thoughtworks.go.helper.StageMother;\n import com.thoughtworks.go.server.presentation.models.JobDetailPresentationModel;\n import com.thoughtworks.go.server.service.ArtifactsService;\n-import org.jsoup.Jsoup;\n+import org.apache.commons.text.StringEscapeUtils;\n import org.jsoup.nodes.Document;\n import org.junit.jupiter.api.BeforeEach;\n import org.junit.jupiter.api.Test;\n@@ -41,27 +42,56 @@\n import static com.thoughtworks.go.helper.MaterialConfigsMother.gitMaterialConfig;\n import static com.thoughtworks.go.helper.PipelineConfigMother.pipelineConfig;\n import static com.thoughtworks.go.helper.PipelineMother.schedule;\n-import static org.hamcrest.MatcherAssert.assertThat;\n-import static org.hamcrest.Matchers.containsString;\n+import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Mockito.*;\n \n public class BuildDetailPageFreeMarkerTemplateTest extends AbstractFreemarkerTemplateTest {\n \n+    private static final String DODGY_LABEL = \"label-1-<dodgy>-hello('world')\";\n+    private static final String DODGY_LABEL_UNICODE_ESCAPED = \"label-1-\\\\u003cdodgy\\\\u003e-hello(\\\\u0027world\\\\u0027)\";\n+\n     @BeforeEach\n     public void setUp() throws Exception {\n-        super.setUp(\"build_detail/build_detail_page.ftl\");\n+        super.setUp(\"build_detail/build_detail_page.ftlh\");\n     }\n \n     @Test\n-    public void shouldEscapeBuildCauseOnVelocityTemplate() {\n-        Document actualDoc = Jsoup.parse(view.render(createJobDetailModel()));\n-        assertThat(actualDoc.select(\"#build-detail-summary\").last().html(), containsString(\"modified by Ernest Hemingway &lt;oldman@sea.com&gt;\"));\n+    public void shouldEscapeBuildCauseForHtml() {\n+        Document actualDoc = parser.parseInput(view.render(createJobDetailModel()), \"\");\n+        assertThat(actualDoc.select(\"#build-detail-summary\").last().html())\n+            .contains(\"modified by Ernest Hemingway &lt;oldman@sea.com&gt;\");\n     }\n \n     @Test\n-    public void shouldEscapeBuildCauseInTrimPathTemplate() {\n-        Document actualDoc = Jsoup.parse(view.render(createJobDetailModel()));\n-        assertThat(actualDoc.select(\"#build-summary-template\").last().html(), containsString(\"modified by Ernest Hemingway &amp;lt;oldman@sea.com&amp;gt;\"));\n+    public void shouldEscapeBuildCauseForJavaScriptViaTrimPathTemplate() {\n+        Document actualDoc = parser.parseInput(view.render(createJobDetailModel()), \"\");\n+        assertThat(actualDoc.select(\"#build-summary-template\").last().html())\n+            .contains(\"modified by Ernest Hemingway &amp;lt;oldman@sea.com&amp;gt;\");\n+    }\n+\n+    @Test\n+    public void shouldEscapeRenderedPipelineLabels() {\n+        Document actualDoc = parser.parseInput(view.render(createJobDetailModel()), \"\");\n+\n+        // Header is escaped\n+        assertThat(actualDoc.select(\"#job_details_header\").last().html())\n+            .contains(StringEscapeUtils.escapeHtml4(DODGY_LABEL));\n+\n+        // Sidebar links are escaped\n+        assertThat(actualDoc.select(\"#buildlist-container ul li[id=build_list_1]\").last().html())\n+            .contains(String.format(\"pipeline/%s/stage/1/job\", StringEscapeUtils.escapeHtml4(DODGY_LABEL)));\n+\n+        // Strange JS that updates sidebar should be correctly JS escaped\n+        assertThat(actualDoc.select(\"#build_history_holder script\").last().html())\n+            .contains(\"json_to_css.update_build_list(eval({\\\"building_info\\\"\")\n+            .contains(String.format(\"\\\"buildLocatorForDisplay\\\":\\\"pipeline/%s/stage/1/job\\\"\", DODGY_LABEL_UNICODE_ESCAPED));\n+    }\n+\n+    @Test\n+    public void shouldRenderArtifactFilesAsRawHtml() {\n+        Document actualDoc = parser.parseInput(view.render(createJobDetailModel()), \"\");\n+        assertThat(actualDoc.select(\"#tab-content-of-artifacts .files\").last().html())\n+            .contains(\"<a href=\\\"null\\\"> console.log </a>\");\n     }\n \n     @Test\n@@ -70,22 +100,27 @@ public void shouldRenderIframeSandboxForTestsTab() {\n         when(jobDetailPresentationModel.hasTests()).thenReturn(true);\n         when(jobDetailPresentationModel.getCustomizedTabs()).thenReturn(new Tabs());\n \n-        Document actualDoc = Jsoup.parse(view.render(minimalModelFrom(jobDetailPresentationModel)));\n-\n-        assertThat(actualDoc.select(\"#tab-content-of-tests\").last().html(), containsString(\"<iframe sandbox=\\\"allow-scripts\\\"\"));\n+        Document actualDoc = parser.parseInput(view.render(minimalModelFrom(jobDetailPresentationModel)), \"\");\n+        assertThat(actualDoc.select(\"#tab-content-of-tests\").last().html())\n+            .contains(\"<iframe sandbox=\\\"allow-scripts\\\"\");\n     }\n \n     private Map<String, Object> createJobDetailModel() {\n         GitMaterialConfig gitMaterialConfig = gitMaterialConfig();\n \n         MaterialRevisions materialRevisions = new MaterialRevisions();\n         materialRevisions.addRevision(new GitMaterial(gitMaterialConfig),\n-                new Modification(\"Ernest Hemingway <oldman@sea.com>\", \"comment\", \"email\", new Date(), \"12\", \"\"));\n+            new Modification(\"Ernest Hemingway <oldman@sea.com>\", \"comment\", \"email\", new Date(), \"12\", \"\"));\n \n         Pipeline pipeline = schedule(pipelineConfig(\"pipeline\", new MaterialConfigs(gitMaterialConfig)), createWithModifications(materialRevisions, \"\"));\n-        JobDetailPresentationModel model = new JobDetailPresentationModel(building(\"job\"), new JobInstances(), null,\n-                pipeline, new Tabs(), new TrackingTool(),\n-                mock(ArtifactsService.class), StageMother.custom(\"stage\"));\n+        JobInstance jobInstance = building(\"job\");\n+        jobInstance.getIdentifier().setPipelineLabel(DODGY_LABEL);\n+\n+        JobInstances recent25 = new JobInstances();\n+        recent25.add(jobInstance);\n+        JobDetailPresentationModel model = new JobDetailPresentationModel(jobInstance, recent25, null,\n+            pipeline, new Tabs(), new TrackingTool(),\n+            mock(ArtifactsService.class), StageMother.custom(\"stage\"));\n \n         return minimalModelFrom(model);\n     }"
        },
        {
          "filename": "server/src/test-fast/java/com/thoughtworks/go/server/view/freemarker/ExceptionTemplateTest.java",
          "status": "renamed",
          "additions": 14,
          "deletions": 6,
          "patch": "@@ -13,19 +13,18 @@\n  * See the License for the specific language governing permissions and\n  * limitations under the License.\n  */\n-package com.thoughtworks.go.server.view.velocity;\n+package com.thoughtworks.go.server.view.freemarker;\n \n import org.junit.jupiter.api.BeforeEach;\n import org.junit.jupiter.api.Test;\n \n import java.util.HashMap;\n import java.util.Map;\n \n-import static org.hamcrest.MatcherAssert.assertThat;\n-import static org.hamcrest.Matchers.containsString;\n+import static org.assertj.core.api.Assertions.assertThat;\n \n public class ExceptionTemplateTest extends AbstractFreemarkerTemplateTest {\n-    public static final String TEMPLATE_PATH = \"exceptions_page.ftl\";\n+    public static final String TEMPLATE_PATH = \"exceptions_page.ftlh\";\n \n     @BeforeEach\n     public void setUp() throws Exception {\n@@ -38,12 +37,21 @@ public void shouldHaveErrorMessageAlongWithCustomMessageInOutputOfTemplate() {\n         data.put(\"errorMessage\", \"ERROR MESSAGE\");\n \n         String output = view.render(data);\n-        assertThat(output, containsString(\"$('trans_content').update(\\\"Sorry, an unexpected error occurred [ERROR MESSAGE]. :( Please check the server logs for more information.\\\");\"));\n+        assertThat(output).contains(\"$('trans_content').update(\\\"Sorry, an unexpected error occurred [ERROR MESSAGE]. :( Please check the server logs for more information.\\\");\");\n+    }\n+\n+    @Test\n+    public void shouldHaveErrorMessageAlongWithCustomMessageEscapedCorrectly() {\n+        Map<String, Object> data = new HashMap<>();\n+        data.put(\"errorMessage\", \"<Error> you shouldn't \\\"expect\\\"\");\n+\n+        String output = view.render(data);\n+        assertThat(output).contains(\"$('trans_content').update(\\\"Sorry, an unexpected error occurred [<Error> you shouldn\\\\'t \\\\\\\"expect\\\\\\\"]. :( Please check the server logs for more information.\\\");\");\n     }\n \n     @Test\n     public void shouldHaveTheGenericMessageInOutputOfTemplateWhenCustomErrorMessageIsNotProvided() {\n         String output = view.render(new HashMap<>());\n-        assertThat(output, containsString(\"$('trans_content').update(\\\"Sorry, an unexpected error occurred. :( Please check the server logs for more information.\\\");\"));\n+        assertThat(output).contains(\"$('trans_content').update(\\\"Sorry, an unexpected error occurred. :( Please check the server logs for more information.\\\");\");\n     }\n }"
        },
        {
          "filename": "server/src/test-fast/java/com/thoughtworks/go/server/view/freemarker/TestFreeMarkerView.java",
          "status": "renamed",
          "additions": 6,
          "deletions": 1,
          "patch": "@@ -13,7 +13,7 @@\n  * See the License for the specific language governing permissions and\n  * limitations under the License.\n  */\n-package com.thoughtworks.go.server.view.velocity;\n+package com.thoughtworks.go.server.view.freemarker;\n \n import com.thoughtworks.go.server.newsecurity.SessionUtilsHelper;\n import com.thoughtworks.go.server.web.GoCDFreeMarkerView;\n@@ -24,6 +24,7 @@\n \n import java.nio.charset.StandardCharsets;\n import java.util.Map;\n+import java.util.Properties;\n \n class TestFreeMarkerView extends GoCDFreeMarkerView {\n \n@@ -34,6 +35,10 @@ public TestFreeMarkerView(String template) throws Exception {\n         configurer.setDefaultEncoding(StandardCharsets.UTF_8.name());\n         configurer.setTemplateLoaderPath(\"file:src/main/webapp/WEB-INF/vm\");\n \n+        Properties settings = new Properties();\n+        settings.put(\"recognizeStandardFileExtensions\", \"true\");\n+        configurer.setFreemarkerSettings(settings);\n+\n         setConfiguration(configurer.createConfiguration());\n         setServletContext(new MockServletContext());\n         setRequestContextAttribute(REQUEST_CONTEXT_ATTRIBUTE);"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 3,
        "dependency_files": 0,
        "test_files": 6,
        "unique_directories": 9,
        "max_directory_depth": 10
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "745b8846335e2d352bd17223122b3585ba63bc18",
            "date": "2025-01-14T11:10:03Z",
            "author_login": "chadlwilson"
          },
          {
            "sha": "7e0e0c87401d8ce8d76c651194e9165523416037",
            "date": "2025-01-14T11:09:46Z",
            "author_login": "chadlwilson"
          },
          {
            "sha": "99aa6ecc886d9c30f79601e30c06224112da3045",
            "date": "2025-01-14T11:09:29Z",
            "author_login": "chadlwilson"
          },
          {
            "sha": "6e87477e6527985cddd634b48bd3505be1079d4d",
            "date": "2025-01-14T11:09:11Z",
            "author_login": "chadlwilson"
          },
          {
            "sha": "90fccf4ddc5b1641b3fcaadd6eaeff34501aefb6",
            "date": "2025-01-14T10:44:32Z",
            "author_login": "dependabot[bot]"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 5.4,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N",
    "cwe_id": "CWE-79",
    "description": "GoCD is an open source continuous delivery server. GoCD versions before 23.1.0 are vulnerable to a stored XSS vulnerability, where pipeline configuration with a malicious pipeline label configuration can affect browser display of pipeline runs generated from that configuration. An attacker that has permissions to configure GoCD pipelines could include JavaScript elements within the label template, causing a XSS vulnerability to be triggered for any users viewing the Value Stream Map or Job Details for runs of the affected pipeline, potentially allowing them to perform arbitrary actions within the victim's browser context rather than their own. This issue has been fixed in GoCD 23.1.0. Users are advised to upgrade. There are no known workarounds for this vulnerability.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-03-27T21:15:12.483",
    "last_modified": "2024-11-21T07:55:41.920",
    "fix_date": "2022-12-03T16:08:05Z"
  },
  "references": [
    {
      "url": "https://docs.gocd.org/current/configuration/pipeline_labeling.html",
      "source": "security-advisories@github.com",
      "tags": [
        "Product"
      ]
    },
    {
      "url": "https://github.com/gocd/gocd/commit/95f758229d419411a38577608709d8552cccf193",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/gocd/gocd/commit/c6aa644973b034305bbe9ea34b010dcf5b5790ce",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/gocd/gocd/releases/tag/23.1.0",
      "source": "security-advisories@github.com",
      "tags": [
        "Release Notes"
      ]
    },
    {
      "url": "https://github.com/gocd/gocd/security/advisories/GHSA-3vvg-gjfr-q9vm",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://www.gocd.org/releases/#23-1-0",
      "source": "security-advisories@github.com",
      "tags": [
        "Release Notes"
      ]
    },
    {
      "url": "https://docs.gocd.org/current/configuration/pipeline_labeling.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Product"
      ]
    },
    {
      "url": "https://github.com/gocd/gocd/commit/95f758229d419411a38577608709d8552cccf193",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/gocd/gocd/commit/c6aa644973b034305bbe9ea34b010dcf5b5790ce",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/gocd/gocd/releases/tag/23.1.0",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes"
      ]
    },
    {
      "url": "https://github.com/gocd/gocd/security/advisories/GHSA-3vvg-gjfr-q9vm",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://www.gocd.org/releases/#23-1-0",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:05:09.016790",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "gocd",
    "owner": "gocd",
    "created_at": "2013-12-13T05:26:16Z",
    "updated_at": "2025-01-14T12:47:48Z",
    "pushed_at": "2025-01-14T11:10:10Z",
    "size": 393992,
    "stars": 7159,
    "forks": 972,
    "open_issues": 82,
    "watchers": 7159,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "master"
    ],
    "languages": {
      "Java": 20251061,
      "TypeScript": 4424594,
      "Groovy": 2080119,
      "JavaScript": 753678,
      "SCSS": 564746,
      "Ruby": 364252,
      "HTML": 253777,
      "XSLT": 202698,
      "NSIS": 24216,
      "Shell": 15469,
      "FreeMarker": 13061,
      "EJS": 1626,
      "CSS": 1575,
      "Batchfile": 474
    },
    "commit_activity": {
      "total_commits_last_year": 1743,
      "avg_commits_per_week": 33.51923076923077,
      "days_active_last_year": 299
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "apache-2.0"
    },
    "collected_at": "2025-01-14T13:11:02.445502"
  }
}