{
  "cve_id": "CVE-2023-28846",
  "github_data": {
    "repository": "unpoly/unpoly-rails",
    "fix_commit": "cd9ad0007daceeb3b2354fdcab4f88350427bf16",
    "related_commits": [
      "cd9ad0007daceeb3b2354fdcab4f88350427bf16",
      "cd9ad0007daceeb3b2354fdcab4f88350427bf16"
    ],
    "patch_url": "https://github.com/unpoly/unpoly-rails/commit/cd9ad0007daceeb3b2354fdcab4f88350427bf16.patch",
    "fix_commit_details": {
      "sha": "cd9ad0007daceeb3b2354fdcab4f88350427bf16",
      "commit_date": "2023-03-29T20:11:02Z",
      "author": {
        "login": "triskweline",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Only echo the request URL as X-Up-Location if it contains query params prefixed with \"_up\"",
        "length": 90,
        "has_description": false,
        "references_issue": true
      },
      "stats": {
        "total": 43,
        "additions": 22,
        "deletions": 21
      },
      "files": [
        {
          "filename": "lib/unpoly/rails/request_echo_headers.rb",
          "status": "modified",
          "additions": 6,
          "deletions": 2,
          "patch": "@@ -18,9 +18,13 @@ def self.included(base)\n       end\n \n       private\n-      \n+\n       def set_up_request_echo_headers\n-        response.headers['X-Up-Location'] = up.request_url_without_up_params\n+        request_url_without_up_params = up.request_url_without_up_params\n+        unless request_url_without_up_params == request.original_url\n+          response.headers['X-Up-Location'] = up.request_url_without_up_params\n+        end\n+\n         response.headers['X-Up-Method'] = request.method\n       end\n "
        },
        {
          "filename": "spec/unpoly/rails/controller_spec.rb",
          "status": "modified",
          "additions": 16,
          "deletions": 19,
          "patch": "@@ -995,31 +995,28 @@ def controller_eval(headers: {}, &expression)\n \n   describe 'echoing of the request location' do\n \n-    it 'echoes the current path in an X-Up-Location response header' do\n+    it 'does not echo the current path in an X-Up-Location response header to prevent the user-controlled request URL from exceeding the maximum response header size' do\n       get '/binding_test/text'\n-      expect(response.headers['X-Up-Location']).to end_with('/binding_test/text')\n+      expect(response.headers['X-Up-Location']).to be_nil\n     end\n \n-    it 'echoes the current path after a redirect' do\n-      get '/binding_test/redirect1'\n-      expect(response).to be_redirect\n-      follow_redirect!\n-      expect(response.headers['X-Up-Location']).to end_with('/binding_test/redirect2')\n-    end\n+    describe 'when the request URL contains query params prefixed with \"_up-\"' do\n \n-    it 'echoes the current path with query params' do\n-      get '/binding_test/text?foo=bar'\n-      expect(response.headers['X-Up-Location']).to end_with('/binding_test/text?foo=bar')\n-    end\n+      it 'removes params prefixed with \"_up-\"' do\n+        get '/binding_test/text?_up_1&_up_2=y'\n+        expect(response.headers['X-Up-Location']).to end_with('/binding_test/text')\n+      end\n \n-    it 'removes _up-* params' do\n-      get '/binding_test/text?_up_1=x&foo=bar&_up_2=y'\n-      expect(response.headers['X-Up-Location']).to end_with('/binding_test/text?foo=bar')\n-    end\n+      it 'keeps params not prefixed with \"_up-\"' do\n+        get '/binding_test/text?_up_1=x&foo=bar&_up_2=y'\n+        expect(response.headers['X-Up-Location']).to end_with('/binding_test/text?foo=bar')\n+      end\n+\n+      it 'does not mangle array params (BUGFIX)' do\n+        get '/binding_test/text?_up_1=x&foo%5B%5D=bar&foo%5B%5D=qux&_up_location=up_location'\n+        expect(response.headers['X-Up-Location']).to end_with('/binding_test/text?foo%5B%5D=bar&foo%5B%5D=qux')\n+      end\n \n-    it 'does not mangle array params (BUGFIX)' do\n-      get '/binding_test/text?foo%5B%5D=bar&foo%5B%5D=qux&_up_location=up_location'\n-      expect(response.headers['X-Up-Location']).to end_with('/binding_test/text?foo%5B%5D=bar&foo%5B%5D=qux')\n     end\n \n   end"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 2,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "9e2550e4c3965cd07e71cfb25a6f954b9d6ccbe1",
            "date": "2024-12-13T11:54:52Z",
            "author_login": "triskweline"
          },
          {
            "sha": "951dc56f107fbfde26f647a39747a6f99330672a",
            "date": "2024-11-15T10:15:09Z",
            "author_login": "triskweline"
          },
          {
            "sha": "de5579aefbb6279888cf48c1ad401153dd5d1dc6",
            "date": "2024-11-15T10:09:17Z",
            "author_login": "triskweline"
          },
          {
            "sha": "1cd0ed426c4824cfea129ec473cb11087c909ed6",
            "date": "2024-11-15T10:09:01Z",
            "author_login": "triskweline"
          },
          {
            "sha": "3d09d5328b57a0f81a3a0528378963fd9c7f7387",
            "date": "2024-10-30T08:17:36Z",
            "author_login": "triskweline"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 5.9,
    "cvss_vector": "CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:N/I:N/A:H",
    "cwe_id": "CWE-400",
    "description": "Unpoly is a JavaScript framework for server-side web applications. There is a possible Denial of Service (DoS) vulnerability in the `unpoly-rails` gem that implements the Unpoly server protocol for Rails applications. This issues affects Rails applications that operate as an upstream of a load balancer's that uses passive health checks. The `unpoly-rails` gem echoes the request URL as an `X-Up-Location` response header. By making a request with exceedingly long URLs (paths or query string), an attacker can cause unpoly-rails to write a exceedingly large response header.  If the response header is too large to be parsed by a load balancer downstream of the Rails application, it may cause the load balancer to remove the upstream from a load balancing group. This causes that application instance to become unavailable until a configured timeout is reached or until an active healthcheck succeeds. This issue has been fixed and released as version 2.7.2.2 which is available via RubyGems and GitHub. Users unable to upgrade may: Configure your load balancer to use active health checks, e.g. by periodically requesting a route with a known response that indicates healthiness; Configure your load balancer so the maximum size of response headers is at least twice the maximum size of a URL; or instead of changing your server configuration you may also configure your Rails application to delete redundant `X-Up-Location` headers set by unpoly-rails.\n",
    "attack_vector": "NETWORK",
    "attack_complexity": "HIGH"
  },
  "temporal_data": {
    "published_date": "2023-03-30T20:15:07.780",
    "last_modified": "2024-11-21T07:56:08.807",
    "fix_date": "2023-03-29T20:11:02Z"
  },
  "references": [
    {
      "url": "https://docs.nginx.com/nginx/admin-guide/load-balancer/http-health-check/#passive-health-checks",
      "source": "security-advisories@github.com",
      "tags": [
        "Technical Description"
      ]
    },
    {
      "url": "https://github.com/unpoly/unpoly-rails/",
      "source": "security-advisories@github.com",
      "tags": [
        "Product"
      ]
    },
    {
      "url": "https://github.com/unpoly/unpoly-rails/commit/cd9ad0007daceeb3b2354fdcab4f88350427bf16",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/unpoly/unpoly-rails/security/advisories/GHSA-m875-3xf6-mf78",
      "source": "security-advisories@github.com",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://makandracards.com/operations/537537-nginx-proxy-buffer-tuning",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://tryhexadecimal.com/guides/http/414-request-uri-too-long",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://unpoly.com/up.protocol",
      "source": "security-advisories@github.com",
      "tags": [
        "Product"
      ]
    },
    {
      "url": "https://docs.nginx.com/nginx/admin-guide/load-balancer/http-health-check/#passive-health-checks",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Technical Description"
      ]
    },
    {
      "url": "https://github.com/unpoly/unpoly-rails/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Product"
      ]
    },
    {
      "url": "https://github.com/unpoly/unpoly-rails/commit/cd9ad0007daceeb3b2354fdcab4f88350427bf16",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/unpoly/unpoly-rails/security/advisories/GHSA-m875-3xf6-mf78",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://makandracards.com/operations/537537-nginx-proxy-buffer-tuning",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://tryhexadecimal.com/guides/http/414-request-uri-too-long",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://unpoly.com/up.protocol",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Product"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:05:09.028126",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "unpoly-rails",
    "owner": "unpoly",
    "created_at": "2021-07-16T12:04:11Z",
    "updated_at": "2024-12-16T02:23:09Z",
    "pushed_at": "2024-12-13T12:06:31Z",
    "size": 129,
    "stars": 18,
    "forks": 5,
    "open_issues": 0,
    "watchers": 18,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "Ruby": 83639,
      "JavaScript": 77
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-14T22:14:22.524714"
  }
}