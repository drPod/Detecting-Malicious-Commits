{
  "cve_id": "CVE-2023-29201",
  "github_data": {
    "repository": "xwiki/xwiki-commons",
    "fix_commit": "4a185e0594d90cd4916d60aa60bb4333dc5623b2",
    "related_commits": [
      "4a185e0594d90cd4916d60aa60bb4333dc5623b2",
      "b11eae9d82cb53f32962056b5faa73f3720c6182",
      "4a185e0594d90cd4916d60aa60bb4333dc5623b2",
      "b11eae9d82cb53f32962056b5faa73f3720c6182"
    ],
    "patch_url": "https://github.com/xwiki/xwiki-commons/commit/4a185e0594d90cd4916d60aa60bb4333dc5623b2.patch",
    "fix_commit_details": {
      "sha": "4a185e0594d90cd4916d60aa60bb4333dc5623b2",
      "commit_date": "2022-06-27T15:50:15Z",
      "author": {
        "login": "michitux",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "XCOMMONS-2426: Provide a component for filtering safe HTML elements and attributes",
        "length": 449,
        "has_description": true,
        "references_issue": false
      },
      "stats": {
        "total": 1485,
        "additions": 1484,
        "deletions": 1
      },
      "files": [
        {
          "filename": "xwiki-commons-core/xwiki-commons-xml/pom.xml",
          "status": "modified",
          "additions": 6,
          "deletions": 1,
          "patch": "@@ -32,7 +32,7 @@\n   <packaging>jar</packaging>\n   <description>XWiki Commons - XML</description>\n   <properties>\n-    <xwiki.jacoco.instructionRatio>0.72</xwiki.jacoco.instructionRatio>\n+    <xwiki.jacoco.instructionRatio>0.82</xwiki.jacoco.instructionRatio>\n     <!-- There's a utility class with lots of features, allow it to have many dependencies;\n          There's a SAX event listener, which requires complex code -->\n     <checkstyle.suppressions.location>${basedir}/src/main/checkstyle/checkstyle-suppressions.xml\n@@ -53,6 +53,11 @@\n       <artifactId>xwiki-commons-context</artifactId>\n       <version>${project.version}</version>\n     </dependency>\n+    <dependency>\n+      <groupId>org.xwiki.commons</groupId>\n+      <artifactId>xwiki-commons-configuration-api</artifactId>\n+      <version>${project.version}</version>\n+    </dependency>\n     <dependency>\n       <groupId>org.apache.commons</groupId>\n       <artifactId>commons-lang3</artifactId>"
        },
        {
          "filename": "xwiki-commons-core/xwiki-commons-xml/src/main/checkstyle/checkstyle-suppressions.xml",
          "status": "modified",
          "additions": 5,
          "deletions": 0,
          "patch": "@@ -36,4 +36,9 @@\n   <!-- XWikiDomSerializer copied from DomSerializer -->\n   <suppress checks=\"CyclomaticComplexity\" files=\"XWikiDOMSerializer\" />\n   <suppress checks=\"NPathComplexity\" files=\"XWikiDOMSerializer\" />\n+\n+  <!-- These files have lists of strings copied from a source, making them constants would complicate updating from\n+   upstream. -->\n+  <suppress checks=\"MultipleStringLiterals\"\n+    files=\"SecureHTMLElementSanitizer.java|HTMLDefinitions.java|MathMLDefinitions.java|SVGDefinitions.java\"/>\n </suppressions>"
        },
        {
          "filename": "xwiki-commons-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/html/HTMLElementSanitizer.java",
          "status": "added",
          "additions": 55,
          "deletions": 0,
          "patch": "@@ -0,0 +1,55 @@\n+/*\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+package org.xwiki.xml.html;\n+\n+import org.xwiki.component.annotation.Role;\n+import org.xwiki.stability.Unstable;\n+\n+/**\n+ * Provides methods to check if HTML elements and attributes/attribute values are considered safe.\n+ * <p>\n+ * This also includes SVG and MathML elements and attributes.\n+ *\n+ * @version $Id$\n+ * @since 14.6RC1\n+ */\n+@Role\n+@Unstable\n+public interface HTMLElementSanitizer\n+{\n+    /**\n+     * The key under which a hint can be stored that will be used by the default implementation.\n+     */\n+    String EXECUTION_CONTEXT_HINT_KEY = \"xml.html.htmlElementSanitizerHint\";\n+\n+    /**\n+     * @param elementName the name of the HTML element\n+     * @return {@code true} if the given element is allowed in principle (given appropriate attributes)\n+     */\n+    boolean isElementAllowed(String elementName);\n+\n+    /**\n+     * @param elementName the element for which the attributes shall be checked\n+     * @param attributeName the attributes to check\n+     * @param value the value of the attribute\n+     * @return {@code true} if the attribute with this value is considered safe\n+     */\n+    boolean isAttributeAllowed(String elementName, String attributeName, String value);\n+}"
        },
        {
          "filename": "xwiki-commons-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/internal/html/DefaultHTMLElementSanitizer.java",
          "status": "added",
          "additions": 135,
          "deletions": 0,
          "patch": "@@ -0,0 +1,135 @@\n+/*\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+package org.xwiki.xml.internal.html;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+import javax.inject.Provider;\n+import javax.inject.Singleton;\n+\n+import org.apache.commons.lang3.exception.ExceptionUtils;\n+import org.slf4j.Logger;\n+import org.xwiki.component.annotation.Component;\n+import org.xwiki.component.manager.ComponentLookupException;\n+import org.xwiki.component.manager.ComponentManager;\n+import org.xwiki.component.phase.Initializable;\n+import org.xwiki.component.phase.InitializationException;\n+import org.xwiki.configuration.ConfigurationSource;\n+import org.xwiki.context.Execution;\n+import org.xwiki.context.ExecutionContext;\n+import org.xwiki.stability.Unstable;\n+import org.xwiki.xml.html.HTMLElementSanitizer;\n+\n+/**\n+ * Default {@link HTMLElementSanitizer} that loads the implementation chosen by the configuration.\n+ *\n+ * @version $Id$\n+ * @since 14.6RC1\n+ */\n+@Component\n+@Singleton\n+@Unstable\n+public class DefaultHTMLElementSanitizer implements HTMLElementSanitizer, Initializable\n+{\n+    private static final String CONFIGURATION_KEY = \"xml.htmlElementSanitizer\";\n+\n+    private HTMLElementSanitizer implementation;\n+\n+    @Inject\n+    @Named(\"restricted\")\n+    private Provider<ConfigurationSource> configurationSourceProvider;\n+\n+    @Inject\n+    private Execution execution;\n+\n+    @Inject\n+    private Provider<ComponentManager> componentManagerProvider;\n+\n+    @Inject\n+    private Logger logger;\n+\n+    @Override\n+    public void initialize() throws InitializationException\n+    {\n+\n+        ConfigurationSource configurationSource = this.configurationSourceProvider.get();\n+\n+        String hint;\n+        if (configurationSource != null) {\n+            hint = configurationSource.getProperty(CONFIGURATION_KEY, SecureHTMLElementSanitizer.HINT);\n+        } else {\n+            hint = SecureHTMLElementSanitizer.HINT;\n+        }\n+\n+        try {\n+            this.implementation = loadImplementationWithSecureFallback(hint);\n+        } catch (ComponentLookupException ex) {\n+            throw new InitializationException(\"Couldn't initialize the default secure HTMLElementSanitizer\", ex);\n+        }\n+    }\n+\n+    private HTMLElementSanitizer loadImplementationWithSecureFallback(String hint) throws ComponentLookupException\n+    {\n+        ComponentManager componentManager = this.componentManagerProvider.get();\n+        HTMLElementSanitizer result;\n+\n+        try {\n+            result = componentManager.getInstance(HTMLElementSanitizer.class, hint);\n+        } catch (ComponentLookupException e) {\n+            this.logger.error(\"Couldn't load the configured HTMLElementSanitizer with hint [{}], falling back to the \"\n+                + \"default secure implementation: {}\", hint, ExceptionUtils.getRootCauseMessage(e));\n+            result = componentManager.getInstance(HTMLElementSanitizer.class, SecureHTMLElementSanitizer.HINT);\n+        }\n+\n+        return result;\n+    }\n+\n+    private HTMLElementSanitizer getImplementation()\n+    {\n+        ExecutionContext context = this.execution.getContext();\n+\n+        HTMLElementSanitizer result = this.implementation;\n+\n+        if (context != null && context.hasProperty(HTMLElementSanitizer.EXECUTION_CONTEXT_HINT_KEY)) {\n+            String hint = (String) context.getProperty(HTMLElementSanitizer.EXECUTION_CONTEXT_HINT_KEY);\n+\n+            try {\n+                result = this.componentManagerProvider.get().getInstance(HTMLElementSanitizer.class, hint);\n+            } catch (ComponentLookupException e) {\n+                this.logger.error(\"Couldn't load the HTMLElementSanitizer with hint [{}] from the execution context, \"\n+                    + \"falling back to the configured implementation: {}\", hint, ExceptionUtils.getRootCauseMessage(e));\n+            }\n+        }\n+\n+        return result;\n+    }\n+\n+    @Override\n+    public boolean isElementAllowed(String elementName)\n+    {\n+        return getImplementation().isElementAllowed(elementName);\n+    }\n+\n+    @Override\n+    public boolean isAttributeAllowed(String elementName, String attributeName, String value)\n+    {\n+        return getImplementation().isAttributeAllowed(elementName, attributeName, value);\n+    }\n+}"
        },
        {
          "filename": "xwiki-commons-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/internal/html/HTMLDefinitions.java",
          "status": "added",
          "additions": 110,
          "deletions": 0,
          "patch": "@@ -0,0 +1,110 @@\n+/*\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+/*\n+ * Alternatively, at your choice, the contents of this file may be used under the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can obtain one at https://mozilla.org/MPL/2.0/.\n+ */\n+package org.xwiki.xml.internal.html;\n+\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+import javax.inject.Singleton;\n+\n+import org.xwiki.component.annotation.Component;\n+\n+/**\n+ * Provides definitions of safe HTML attributes and tags.\n+ * <p>\n+ * Unless otherwise noted, lists of elements and attributes are copied from DOMPurify by Cure53 and other contributors |\n+ * Released under the Apache license 2.0 and Mozilla Public License 2.0 -\n+ * <a href=\"https://github.com/cure53/DOMPurify/blob/main/LICENSE\">LICENSE</a>.\n+ *\n+ * @version $Id$\n+ * @since 14.6RC1\n+ */\n+@Component(roles = HTMLDefinitions.class)\n+@Singleton\n+public class HTMLDefinitions\n+{\n+    /**\n+     * Allowed HTML elements.\n+     */\n+    private final Set<String> htmlTags;\n+\n+    /**\n+     * Allowed attributes.\n+     */\n+    private final Set<String> htmlAttributes;\n+\n+    /**\n+     * Default constructor.\n+     */\n+    public HTMLDefinitions()\n+    {\n+        this.htmlTags = new HashSet<>(\n+            Arrays.asList(\"a\", \"abbr\", \"acronym\", \"address\", \"area\", \"article\", \"aside\", \"audio\", \"b\", \"bdi\", \"bdo\",\n+                \"big\", \"blink\", \"blockquote\", \"body\", \"br\", \"button\", \"canvas\", \"caption\", \"center\", \"cite\", \"code\",\n+                \"col\", \"colgroup\", \"content\", \"data\", \"datalist\", \"dd\", \"decorator\", \"del\", \"details\", \"dfn\", \"dialog\",\n+                \"dir\", \"div\", \"dl\", \"dt\", \"element\", \"em\", \"fieldset\", \"figcaption\", \"figure\", \"font\", \"footer\", \"form\",\n+                \"h1\", \"h2\", \"h3\", \"h4\", \"h5\", \"h6\", \"head\", \"header\", \"hgroup\", \"hr\", \"html\", \"i\", \"img\", \"input\",\n+                \"ins\", \"kbd\", \"label\", \"legend\", \"li\", \"main\", \"map\", \"mark\", \"marquee\", \"menu\", \"menuitem\", \"meter\",\n+                \"nav\", \"nobr\", \"ol\", \"optgroup\", \"option\", \"output\", \"p\", \"picture\", \"pre\", \"progress\", \"q\", \"rp\", \"rt\",\n+                \"ruby\", \"s\", \"samp\", \"section\", \"select\", \"shadow\", \"small\", \"source\", \"spacer\", \"span\", \"strike\",\n+                \"strong\", \"style\", \"sub\", \"summary\", \"sup\", \"table\", \"tbody\", \"td\", \"template\", \"textarea\", \"tfoot\",\n+                \"th\", \"thead\", \"time\", \"tr\", \"track\", \"tt\", \"u\", \"ul\", \"var\", \"video\", \"wbr\"));\n+\n+        // Attributes that are in general allowed. Note that \"target\" is not generally safe, but XWiki contains code\n+        // that already adds the necessary attributes to make it safe both in HTMLCleaner and in XHTML rendering.\n+        this.htmlAttributes = new HashSet<>(\n+            Arrays.asList(\"accept\", \"action\", \"align\", \"alt\", \"autocapitalize\", \"autocomplete\", \"autopictureinpicture\",\n+                \"autoplay\", \"background\", \"bgcolor\", \"border\", \"capture\", \"cellpadding\", \"cellspacing\", \"checked\",\n+                \"cite\", \"class\", \"clear\", \"color\", \"cols\", \"colspan\", \"controls\", \"controlslist\", \"coords\",\n+                \"crossorigin\", \"datetime\", \"decoding\", \"default\", \"dir\", \"disabled\", \"disablepictureinpicture\",\n+                \"disableremoteplayback\", \"download\", \"draggable\", \"enctype\", \"enterkeyhint\", \"face\", \"for\", \"headers\",\n+                \"height\", \"hidden\", \"high\", \"href\", \"hreflang\", \"id\", \"inputmode\", \"integrity\", \"ismap\", \"kind\",\n+                \"label\", \"lang\", \"list\", \"loading\", \"loop\", \"low\", \"max\", \"maxlength\", \"media\", \"method\", \"min\",\n+                \"minlength\", \"multiple\", \"muted\", \"name\", \"nonce\", \"noshade\", \"novalidate\", \"nowrap\", \"open\", \"optimum\",\n+                \"pattern\", \"placeholder\", \"playsinline\", \"poster\", \"preload\", \"pubdate\", \"radiogroup\", \"readonly\",\n+                \"rel\", \"required\", \"rev\", \"reversed\", \"role\", \"rows\", \"rowspan\", \"spellcheck\", \"scope\", \"selected\",\n+                \"shape\", \"size\", \"sizes\", \"span\", \"srclang\", \"start\", \"src\", \"srcset\", \"step\", \"style\", \"summary\",\n+                \"tabindex\", \"title\", \"translate\", \"type\", \"usemap\", \"valign\", \"value\", \"width\", \"xmlns\", \"slot\",\n+                \"target\"));\n+    }\n+\n+    /**\n+     * @param tagName the name of the tag to check\n+     * @return if the tag is considered safe\n+     */\n+    public boolean isSafeTag(String tagName)\n+    {\n+        return this.htmlTags.contains(tagName);\n+    }\n+\n+    /**\n+     * @param attributeName the name of the attribute to check\n+     * @return if the attribute is allowed\n+     */\n+    public boolean isAllowedAttribute(String attributeName)\n+    {\n+        return this.htmlAttributes.contains(attributeName);\n+    }\n+}"
        },
        {
          "filename": "xwiki-commons-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/internal/html/HTMLElementSanitizerConfiguration.java",
          "status": "added",
          "additions": 144,
          "deletions": 0,
          "patch": "@@ -0,0 +1,144 @@\n+/*\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+package org.xwiki.xml.internal.html;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+import javax.inject.Provider;\n+import javax.inject.Singleton;\n+\n+import org.xwiki.component.annotation.Component;\n+import org.xwiki.configuration.ConfigurationSource;\n+\n+/**\n+ * Provides methods to easily access the configuration options of {@link org.xwiki.xml.html.HTMLElementSanitizer}.\n+ *\n+ * @version $Id$\n+ * @since 14.6RC1\n+ */\n+@Component(roles = HTMLElementSanitizerConfiguration.class)\n+@Singleton\n+public class HTMLElementSanitizerConfiguration\n+{\n+    private static final String EXTRA_ALLOWED_TAGS_CONFIGURATION = \"xml.htmlElementSanitizer.extraAllowedTags\";\n+\n+    private static final String EXTRA_ALLOWED_ATTRIBUTES_CONFIGURATION =\n+        \"xml.htmlElementSanitizer.extraAllowedAttributes\";\n+\n+    private static final String EXTRA_URI_SAFE_ATTRIBUTES_CONFIGURATION =\n+        \"xml.htmlElementSanitizer.extraURISafeAttributes\";\n+\n+    private static final String EXTRA_DATA_URI_TAGS_CONFIGURATION = \"xml.htmlElementSanitizer.extraDataUriTags\";\n+\n+    private static final String FORBID_TAGS_CONFIGURATION = \"xml.htmlElementSanitizer.forbidTags\";\n+\n+    private static final String FORBID_ATTRIBUTES_CONFIGURATION = \"xml.htmlElementSanitizer.forbidAttributes\";\n+\n+    private static final String ALLOW_UNKNOWN_PROTOCOLS_CONFIGURATION =\n+        \"xml.htmlElementSanitizer.allowUnknownProtocols\";\n+\n+    private static final String ALLOWED_URI_REGEXP_CONFIGURATION = \"xml.htmlElementSanitizer.allowedUriRegexp\";\n+\n+    @Inject\n+    @Named(\"restricted\")\n+    private Provider<ConfigurationSource> configurationSourceProvider;\n+\n+    private <T> T getValue(String key, Class<T> valueType, T defaultValue)\n+    {\n+        ConfigurationSource configurationSource = this.configurationSourceProvider.get();\n+\n+        T result;\n+\n+        if (configurationSource != null) {\n+            result = configurationSource.getProperty(key, valueType, defaultValue);\n+        } else {\n+            result = defaultValue;\n+        }\n+\n+        return result;\n+    }\n+\n+    /**\n+     * @return The list of additionally allowed tags\n+     */\n+    public List<String> getExtraAllowedTags()\n+    {\n+        return getValue(EXTRA_ALLOWED_TAGS_CONFIGURATION, List.class, Collections.emptyList());\n+    }\n+\n+    /**\n+     * @return the list of additionally allowed attributes\n+     */\n+    public List<String> getExtraAllowedAttributes()\n+    {\n+        return getValue(EXTRA_ALLOWED_ATTRIBUTES_CONFIGURATION, List.class, Collections.emptyList());\n+    }\n+\n+    /**\n+     * @return the list of additional tags that are safe for all kinds of URIs\n+     */\n+    public List<String> getExtraUriSafeAttributes()\n+    {\n+        return getValue(EXTRA_URI_SAFE_ATTRIBUTES_CONFIGURATION, List.class, Collections.emptyList());\n+    }\n+\n+    /**\n+     * @return the list of additional tags whose attributes may have data URIs\n+     */\n+    public List<String> getExtraDataUriTags()\n+    {\n+        return getValue(EXTRA_DATA_URI_TAGS_CONFIGURATION, List.class, Collections.emptyList());\n+    }\n+\n+    /**\n+     * @return the list of forbidden tags\n+     */\n+    public List<String> getForbidTags()\n+    {\n+        return getValue(FORBID_TAGS_CONFIGURATION, List.class, Collections.emptyList());\n+    }\n+\n+    /**\n+     * @return the list of forbidden attributes\n+     */\n+    public List<String> getForbidAttributes()\n+    {\n+        return getValue(FORBID_ATTRIBUTES_CONFIGURATION, List.class, Collections.emptyList());\n+    }\n+\n+    /**\n+     * @return if unknown protocols shall be allowed\n+     */\n+    public boolean isAllowUnknownProtocols()\n+    {\n+        return getValue(ALLOW_UNKNOWN_PROTOCOLS_CONFIGURATION, Boolean.class, Boolean.TRUE);\n+    }\n+\n+    /**\n+     * @return the regular expression for allowed URIs\n+     */\n+    public String getAllowedUriRegexp()\n+    {\n+        return getValue(ALLOWED_URI_REGEXP_CONFIGURATION, String.class, null);\n+    }\n+}"
        },
        {
          "filename": "xwiki-commons-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/internal/html/InsecureHTMLElementSanitizer.java",
          "status": "added",
          "additions": 52,
          "deletions": 0,
          "patch": "@@ -0,0 +1,52 @@\n+/*\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+package org.xwiki.xml.internal.html;\n+\n+import javax.inject.Named;\n+import javax.inject.Singleton;\n+\n+import org.xwiki.component.annotation.Component;\n+import org.xwiki.stability.Unstable;\n+import org.xwiki.xml.html.HTMLElementSanitizer;\n+\n+/**\n+ * Implementation of {@link HTMLElementSanitizer} that allows all elements and attributes.\n+ *\n+ * @version $Id$\n+ * @since 14.6RC1\n+ */\n+@Component\n+@Singleton\n+@Named(\"insecure\")\n+@Unstable\n+public class InsecureHTMLElementSanitizer implements HTMLElementSanitizer\n+{\n+    @Override\n+    public boolean isElementAllowed(String elementName)\n+    {\n+        return true;\n+    }\n+\n+    @Override\n+    public boolean isAttributeAllowed(String elementName, String attributeName, String value)\n+    {\n+        return true;\n+    }\n+}"
        },
        {
          "filename": "xwiki-commons-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/internal/html/MathMLDefinitions.java",
          "status": "added",
          "additions": 119,
          "deletions": 0,
          "patch": "@@ -0,0 +1,119 @@\n+/*\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+/*\n+ * Alternatively, at your choice, the contents of this file may be used under the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can obtain one at https://mozilla.org/MPL/2.0/.\n+ */\n+package org.xwiki.xml.internal.html;\n+\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+import javax.inject.Singleton;\n+\n+import org.xwiki.component.annotation.Component;\n+\n+/**\n+ * Provides MathML tag and attribute definitions with a focus on safe tags/attributes.\n+ * <p>\n+ * Unless otherwise noted, lists of elements and attributes are copied from DOMPurify by Cure53 and other contributors |\n+ * Released under the Apache license 2.0 and Mozilla Public License 2.0 -\n+ * <a href=\"https://github.com/cure53/DOMPurify/blob/main/LICENSE\">LICENSE</a>.\n+ *\n+ * @version $Id$\n+ * @since 14.6RC1\n+ */\n+@Component(roles = MathMLDefinitions.class)\n+@Singleton\n+public class MathMLDefinitions\n+{\n+    private final Set<String> safeTags;\n+\n+    private final Set<String> allTags;\n+\n+    private final Set<String> allowedAttributes;\n+\n+    private final Set<String> textIntegrationPoints;\n+\n+    /**\n+     * Default constructor.\n+     */\n+    public MathMLDefinitions()\n+    {\n+        this.safeTags = new HashSet<>(\n+            Arrays.asList(\"math\", \"menclose\", \"merror\", \"mfenced\", \"mfrac\", \"mglyph\", \"mi\", \"mlabeledtr\",\n+                \"mmultiscripts\", \"mn\", \"mo\", \"mover\", \"mpadded\", \"mphantom\", \"mroot\", \"mrow\", \"ms\", \"mspace\", \"msqrt\",\n+                \"mstyle\", \"msub\", \"msup\", \"msubsup\", \"mtable\", \"mtd\", \"mtext\", \"mtr\", \"munder\", \"munderover\"));\n+\n+        this.allTags = new HashSet<>(\n+            Arrays.asList(\"maction\", \"maligngroup\", \"malignmark\", \"mlongdiv\", \"mscarries\", \"mscarry\", \"msgroup\",\n+                \"mstack\", \"msline\", \"msrow\", \"semantics\", \"annotation\", \"annotation-xml\", \"mprescripts\", \"none\"));\n+\n+        this.allTags.addAll(this.safeTags);\n+\n+        this.allowedAttributes = new HashSet<>(\n+            Arrays.asList(\"accent\", \"accentunder\", \"align\", \"bevelled\", \"close\", \"columnsalign\", \"columnlines\",\n+                \"columnspan\", \"denomalign\", \"depth\", \"dir\", \"display\", \"displaystyle\", \"encoding\", \"fence\", \"frame\",\n+                \"height\", \"href\", \"id\", \"largeop\", \"length\", \"linethickness\", \"lspace\", \"lquote\", \"mathbackground\",\n+                \"mathcolor\", \"mathsize\", \"mathvariant\", \"maxsize\", \"minsize\", \"movablelimits\", \"notation\", \"numalign\",\n+                \"open\", \"rowalign\", \"rowlines\", \"rowspacing\", \"rowspan\", \"rspace\", \"rquote\", \"scriptlevel\",\n+                \"scriptminsize\", \"scriptsizemultiplier\", \"selection\", \"separator\", \"separators\", \"stretchy\",\n+                \"subscriptshift\", \"supscriptshift\", \"symmetric\", \"voffset\", \"width\", \"xmlns\"));\n+\n+        this.textIntegrationPoints = new HashSet<>(Arrays.asList(\"mi\", \"mo\", \"mn\", \"ms\", \"mtext\", \"annotation-xml\"));\n+    }\n+\n+    /**\n+     * @param tagName the name of the tag to check\n+     * @return if the tag is considered safe\n+     */\n+    public boolean isSafeTag(String tagName)\n+    {\n+        return this.safeTags.contains(tagName);\n+    }\n+\n+    /**\n+     * @param tagName the name of the tag to check\n+     * @return if the tag is a MathML tag\n+     */\n+    public boolean isMathMLTag(String tagName)\n+    {\n+        return this.allTags.contains(tagName);\n+    }\n+\n+    /**\n+     * @param attributeName the name of the attribute to check\n+     * @return if the attribute is allowed\n+     */\n+    public boolean isAllowedAttribute(String attributeName)\n+    {\n+        return this.allowedAttributes.contains(attributeName);\n+    }\n+\n+    /**\n+     * @param tagName the name of the tag to check\n+     * @return if the tag is a text integration point, i.e., its children can be HTML elements\n+     */\n+    public boolean isTextOrHTMLIntegrationPoint(String tagName)\n+    {\n+        return this.textIntegrationPoints.contains(tagName);\n+    }\n+}"
        },
        {
          "filename": "xwiki-commons-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/internal/html/SVGDefinitions.java",
          "status": "added",
          "additions": 171,
          "deletions": 0,
          "patch": "@@ -0,0 +1,171 @@\n+/*\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+/*\n+ * Alternatively, at your choice, the contents of this file may be used under the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can obtain one at https://mozilla.org/MPL/2.0/.\n+ */\n+package org.xwiki.xml.internal.html;\n+\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+import javax.inject.Singleton;\n+\n+import org.xwiki.component.annotation.Component;\n+\n+/**\n+ * Provides SVG tag and attribute definitions with a focus on safe tags/attributes.\n+ * <p>\n+ * Unless otherwise noted, lists of elements and attributes are copied from DOMPurify by Cure53 and other contributors |\n+ * Released under the Apache license 2.0 and Mozilla Public License 2.0 -\n+ * <a href=\"https://github.com/cure53/DOMPurify/blob/main/LICENSE\">LICENSE</a>.\n+ *\n+ * @version $Id$\n+ * @since 14.6RC1\n+ */\n+@Component(roles = SVGDefinitions.class)\n+@Singleton\n+public class SVGDefinitions\n+{\n+    private final Set<String> safeTags;\n+\n+    private final Set<String> filterTags;\n+\n+    private final Set<String> allTags;\n+\n+    private final Set<String> allowedAttributes;\n+\n+    private final Set<String> commonHTMLElements;\n+\n+    private final Set<String> htmlIntegrationPoints;\n+\n+    /**\n+     * Default constructor.\n+     */\n+    public SVGDefinitions()\n+    {\n+        this.allowedAttributes = new HashSet<>(\n+            Arrays.asList(\"accent-height\", \"accumulate\", \"additive\", \"alignment-baseline\", \"ascent\", \"attributename\",\n+                \"attributetype\", \"azimuth\", \"basefrequency\", \"baseline-shift\", \"begin\", \"bias\", \"by\", \"class\", \"clip\",\n+                \"clippathunits\", \"clip-path\", \"clip-rule\", \"color\", \"color-interpolation\",\n+                \"color-interpolation-filters\", \"color-profile\", \"color-rendering\", \"cx\", \"cy\", \"d\", \"dx\", \"dy\",\n+                \"diffuseconstant\", \"direction\", \"display\", \"divisor\", \"dur\", \"edgemode\", \"elevation\", \"end\", \"fill\",\n+                \"fill-opacity\", \"fill-rule\", \"filter\", \"filterunits\", \"flood-color\", \"flood-opacity\", \"font-family\",\n+                \"font-size\", \"font-size-adjust\", \"font-stretch\", \"font-style\", \"font-variant\", \"font-weight\", \"fx\",\n+                \"fy\", \"g1\", \"g2\", \"glyph-name\", \"glyphref\", \"gradientunits\", \"gradienttransform\", \"height\", \"href\",\n+                \"id\", \"image-rendering\", \"in\", \"in2\", \"k\", \"k1\", \"k2\", \"k3\", \"k4\", \"kerning\", \"keypoints\", \"keysplines\",\n+                \"keytimes\", \"lang\", \"lengthadjust\", \"letter-spacing\", \"kernelmatrix\", \"kernelunitlength\",\n+                \"lighting-color\", \"local\", \"marker-end\", \"marker-mid\", \"marker-start\", \"markerheight\", \"markerunits\",\n+                \"markerwidth\", \"maskcontentunits\", \"maskunits\", \"max\", \"mask\", \"media\", \"method\", \"mode\", \"min\", \"name\",\n+                \"numoctaves\", \"offset\", \"operator\", \"opacity\", \"order\", \"orient\", \"orientation\", \"origin\", \"overflow\",\n+                \"paint-order\", \"path\", \"pathlength\", \"patterncontentunits\", \"patterntransform\", \"patternunits\",\n+                \"points\", \"preservealpha\", \"preserveaspectratio\", \"primitiveunits\", \"r\", \"rx\", \"ry\", \"radius\", \"refx\",\n+                \"refy\", \"repeatcount\", \"repeatdur\", \"restart\", \"result\", \"rotate\", \"scale\", \"seed\", \"shape-rendering\",\n+                \"specularconstant\", \"specularexponent\", \"spreadmethod\", \"startoffset\", \"stddeviation\", \"stitchtiles\",\n+                \"stop-color\", \"stop-opacity\", \"stroke-dasharray\", \"stroke-dashoffset\", \"stroke-linecap\",\n+                \"stroke-linejoin\", \"stroke-miterlimit\", \"stroke-opacity\", \"stroke\", \"stroke-width\", \"style\",\n+                \"surfacescale\", \"systemlanguage\", \"tabindex\", \"targetx\", \"targety\", \"transform\", \"transform-origin\",\n+                \"text-anchor\", \"text-decoration\", \"text-rendering\", \"textlength\", \"type\", \"u1\", \"u2\", \"unicode\",\n+                \"values\", \"viewbox\", \"visibility\", \"version\", \"vert-adv-y\", \"vert-origin-x\", \"vert-origin-y\", \"width\",\n+                \"word-spacing\", \"wrap\", \"writing-mode\", \"xchannelselector\", \"ychannelselector\", \"x\", \"x1\", \"x2\",\n+                \"xmlns\", \"y\", \"y1\", \"y2\", \"z\", \"zoomandpan\"));\n+\n+        this.safeTags = new HashSet<>(\n+            Arrays.asList(\"svg\", \"a\", \"altglyph\", \"altglyphdef\", \"altglyphitem\", \"animatecolor\", \"animatemotion\",\n+                \"animatetransform\", \"circle\", \"clippath\", \"defs\", \"desc\", \"ellipse\", \"filter\", \"font\", \"g\", \"glyph\",\n+                \"glyphref\", \"hkern\", \"image\", \"line\", \"lineargradient\", \"marker\", \"mask\", \"metadata\", \"mpath\", \"path\",\n+                \"pattern\", \"polygon\", \"polyline\", \"radialgradient\", \"rect\", \"stop\", \"style\", \"switch\", \"symbol\", \"text\",\n+                \"textpath\", \"title\", \"tref\", \"tspan\", \"view\", \"vkern\"));\n+\n+        this.filterTags = new HashSet<>(\n+            Arrays.asList(\"feBlend\", \"feColorMatrix\", \"feComponentTransfer\", \"feComposite\", \"feConvolveMatrix\",\n+                \"feDiffuseLighting\", \"feDisplacementMap\", \"feDistantLight\", \"feFlood\", \"feFuncA\", \"feFuncB\", \"feFuncG\",\n+                \"feFuncR\", \"feGaussianBlur\", \"feImage\", \"feMerge\", \"feMergeNode\", \"feMorphology\", \"feOffset\",\n+                \"fePointLight\", \"feSpecularLighting\", \"feSpotLight\", \"feTile\", \"feTurbulence\"));\n+\n+        this.allTags = new HashSet<>(\n+            Arrays.asList(\"animate\", \"color-profile\", \"cursor\", \"discard\", \"fedropshadow\", \"font-face\",\n+                \"font-face-format\", \"font-face-name\", \"font-face-src\", \"font-face-uri\", \"foreignobject\", \"hatch\",\n+                \"hatchpath\", \"mesh\", \"meshgradient\", \"meshpatch\", \"meshrow\", \"missing-glyph\", \"script\", \"set\",\n+                \"solidcolor\", \"unknown\", \"use\"));\n+\n+        this.allTags.addAll(this.filterTags);\n+        this.allTags.addAll(this.safeTags);\n+\n+        this.commonHTMLElements = new HashSet<>(Arrays.asList(\"title\", \"style\", \"font\", \"a\", \"script\"));\n+\n+        this.htmlIntegrationPoints = new HashSet<>(Arrays.asList(\"foreignobject\", \"desc\", \"title\", \"annotation-xml\"));\n+    }\n+\n+    /**\n+     * @param attributeName the attribute to check\n+     * @return if the attribute is allowed, i.e., considered safe\n+     */\n+    public boolean isAllowedAttribute(String attributeName)\n+    {\n+        return this.allowedAttributes.contains(attributeName);\n+    }\n+\n+    /**\n+     * @param tagName the name of the tag to check\n+     * @return if the tag is considered safe\n+     */\n+    public boolean isSafeTag(String tagName)\n+    {\n+        return this.safeTags.contains(tagName) || isFilterTag(tagName);\n+    }\n+\n+    /**\n+     * @param tagName the name of the tag to check\n+     * @return if the tag is an SVG filter\n+     */\n+    public boolean isFilterTag(String tagName)\n+    {\n+        return this.filterTags.contains(tagName);\n+    }\n+\n+    /**\n+     * @param tagName the name of the tag to check\n+     * @return if the tag is an SVG tag\n+     */\n+    public boolean isSVGTag(String tagName)\n+    {\n+        return this.allTags.contains(tagName);\n+    }\n+\n+    /**\n+     * @param tagName the name of the tag to check\n+     * @return if the tag is both an HTML and an SVG tag\n+     */\n+    public boolean isCommonHTMLElement(String tagName)\n+    {\n+        return this.commonHTMLElements.contains(tagName);\n+    }\n+\n+    /**\n+     * @param tagName the name of the tag to check\n+     * @return if the tag can contain HTML children\n+     */\n+    public boolean isHTMLIntegrationPoint(String tagName)\n+    {\n+        return this.htmlIntegrationPoints.contains(tagName);\n+    }\n+}"
        },
        {
          "filename": "xwiki-commons-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/internal/html/SecureHTMLElementSanitizer.java",
          "status": "added",
          "additions": 233,
          "deletions": 0,
          "patch": "@@ -0,0 +1,233 @@\n+/*\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+/*\n+ * Alternatively, at your choice, the contents of this file may be used under the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can obtain one at https://mozilla.org/MPL/2.0/.\n+ */\n+package org.xwiki.xml.internal.html;\n+\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.Set;\n+import java.util.regex.Pattern;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+import javax.inject.Singleton;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.xwiki.component.annotation.Component;\n+import org.xwiki.component.phase.Initializable;\n+import org.xwiki.component.phase.InitializationException;\n+import org.xwiki.stability.Unstable;\n+import org.xwiki.xml.html.HTMLElementSanitizer;\n+\n+/**\n+ * Secure default implementation of {@link HTMLElementSanitizer} based on a definition of allowed elements and\n+ * attributes.\n+ * <p>\n+ * This is heavily inspired by DOMPurify by Cure53 and other contributors | Released under the Apache license 2.0 and\n+ * Mozilla Public License 2.0 - <a href=\"https://github.com/cure53/DOMPurify/blob/main/LICENSE\">LICENSE</a>.\n+ *\n+ * @version $Id$\n+ * @since 14.6RC1\n+ */\n+@Component\n+@Named(SecureHTMLElementSanitizer.HINT)\n+@Singleton\n+@Unstable\n+public class SecureHTMLElementSanitizer implements HTMLElementSanitizer, Initializable\n+{\n+    /**\n+     * The hint of this component.\n+     */\n+    public static final String HINT = \"secure\";\n+\n+    static final Pattern IS_SCRIPT_OR_DATA = Pattern.compile(\"^(?:\\\\w+script|data):\", Pattern.CASE_INSENSITIVE);\n+\n+    static final Pattern ATTR_WHITESPACE =\n+        Pattern.compile(\"[\\\\u0000-\\\\u0020\\\\u00A0\\\\u1680\\\\u180E\\\\u2000-\\\\u2029\\\\u205F\\\\u3000]\");\n+\n+    static final Pattern DATA_ATTR = Pattern.compile(\"^data-[\\\\-\\\\w.\\\\u00B7-\\\\uFFFF]\");\n+\n+    static final Pattern ARIA_ATTR = Pattern.compile(\"^aria-[\\\\-\\\\w]+$\");\n+\n+    static final Pattern IS_ALLOWED_URI = Pattern.compile(\"^(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp):\",\n+        Pattern.CASE_INSENSITIVE);\n+\n+    static final Pattern IS_NO_URI = Pattern.compile(\"^(?:[^a-z]|[a-z+.\\\\-]+(?:[^a-z+.\\\\-:]|$))\",\n+        Pattern.CASE_INSENSITIVE);\n+\n+    @Inject\n+    private HTMLElementSanitizerConfiguration htmlElementSanitizerConfiguration;\n+\n+    @Inject\n+    private HTMLDefinitions htmlDefinitions;\n+\n+    @Inject\n+    private SVGDefinitions svgDefinitions;\n+\n+    @Inject\n+    private MathMLDefinitions mathMLDefinitions;\n+\n+    /**\n+     * Additionally allowed elements.\n+     */\n+    private final Set<String> extraAllowedTags;\n+\n+    /**\n+     * Additionally allowed attributes.\n+     */\n+    private final Set<String> extraAllowedAttributes;\n+\n+    /**\n+     * XML attributes that should be allowed.\n+     */\n+    private final Set<String> xmlAttributes;\n+\n+    /**\n+     * Tags that are safe for data: URIs.\n+     */\n+    private final Set<String> dataUriTags;\n+\n+    /**\n+     * Attributes safe for values like \"javascript:\".\n+     */\n+    private final Set<String> uriSafeAttributes;\n+\n+    private final Set<String> forbidTags;\n+\n+    private final Set<String> forbidAttributes;\n+\n+    private boolean allowUnknownProtocols;\n+\n+    private Pattern allowedUriPattern;\n+\n+    /**\n+     * Default constructor.\n+     */\n+    public SecureHTMLElementSanitizer()\n+    {\n+        this.dataUriTags = new HashSet<>(Arrays.asList(\"audio\", \"video\", \"img\", \"source\", \"image\", \"track\"));\n+\n+        this.uriSafeAttributes = new HashSet<>(\n+            Arrays.asList(\"alt\", \"class\", \"for\", \"id\", \"label\", \"name\", \"pattern\", \"placeholder\", \"role\", \"summary\",\n+                \"title\", \"value\", \"style\", \"xmlns\"));\n+\n+        this.xmlAttributes =\n+            new HashSet<>(Arrays.asList(\"xlink:href\", \"xml:id\", \"xlink:title\", \"xml:space\", \"xmlns:xlink\"));\n+\n+        this.extraAllowedTags = new HashSet<>();\n+\n+        this.extraAllowedAttributes = new HashSet<>();\n+\n+        this.forbidTags = new HashSet<>();\n+\n+        this.forbidAttributes = new HashSet<>();\n+\n+        this.allowedUriPattern = IS_ALLOWED_URI;\n+    }\n+\n+    @Override\n+    public void initialize() throws InitializationException\n+    {\n+        this.extraAllowedTags.addAll(this.htmlElementSanitizerConfiguration.getExtraAllowedTags());\n+        this.extraAllowedAttributes.addAll(this.htmlElementSanitizerConfiguration.getExtraAllowedAttributes());\n+        this.uriSafeAttributes.addAll(this.htmlElementSanitizerConfiguration.getExtraUriSafeAttributes());\n+        this.dataUriTags.addAll(this.htmlElementSanitizerConfiguration.getExtraDataUriTags());\n+        this.allowUnknownProtocols = this.htmlElementSanitizerConfiguration.isAllowUnknownProtocols();\n+        this.forbidTags.addAll(this.htmlElementSanitizerConfiguration.getForbidTags());\n+        this.forbidAttributes.addAll(this.htmlElementSanitizerConfiguration.getForbidAttributes());\n+        String configuredRegexp = this.htmlElementSanitizerConfiguration.getAllowedUriRegexp();\n+        if (StringUtils.isNotBlank(configuredRegexp)) {\n+            this.allowedUriPattern = Pattern.compile(configuredRegexp, Pattern.CASE_INSENSITIVE);\n+        }\n+    }\n+\n+    @Override\n+    public boolean isElementAllowed(String elementName)\n+    {\n+        return !this.forbidTags.contains(elementName)\n+            && (this.extraAllowedTags.contains(elementName) || isElementSafe(elementName));\n+    }\n+\n+    private boolean isElementSafe(String elementName)\n+    {\n+        return this.htmlDefinitions.isSafeTag(elementName) || this.svgDefinitions.isSafeTag(elementName)\n+            || this.mathMLDefinitions.isSafeTag(elementName);\n+    }\n+\n+    @Override\n+    public boolean isAttributeAllowed(String elementName, String attributeName, String attributeValue)\n+    {\n+        boolean result = false;\n+\n+        String lowerElement = elementName.toLowerCase();\n+        String lowerAttribute = attributeName.toLowerCase();\n+\n+        if ((DATA_ATTR.matcher(lowerAttribute).find() || ARIA_ATTR.matcher(lowerAttribute).find())\n+            && !this.forbidAttributes.contains(lowerAttribute))\n+        {\n+            result = true;\n+        } else if (isAttributeAllowed(lowerAttribute) && !this.forbidAttributes.contains(lowerAttribute)) {\n+            result = isAllowedValue(lowerElement, lowerAttribute, attributeValue);\n+        }\n+\n+        return result;\n+    }\n+\n+    private boolean isAllowedValue(String lowercaseElementName, String lowercaseAttributeName, String attributeValue)\n+    {\n+        // Break into several statements to avoid too long boolean expression.\n+        boolean result = StringUtils.isBlank(attributeValue);\n+        if (!result) {\n+            String valueNoWhitespace = ATTR_WHITESPACE.matcher(attributeValue).replaceAll(\"\");\n+            result = this.uriSafeAttributes.contains(lowercaseAttributeName);\n+            result = result || IS_NO_URI.matcher(valueNoWhitespace).find();\n+            result = result || this.allowedUriPattern.matcher(valueNoWhitespace).find();\n+            result = result || isAllowedDataValue(lowercaseElementName, lowercaseAttributeName, attributeValue);\n+            result = result || (this.allowUnknownProtocols && !isScriptOrData(attributeValue));\n+        }\n+        return result;\n+    }\n+\n+    private boolean isAttributeAllowed(String attributeName)\n+    {\n+        boolean result = this.extraAllowedAttributes.contains(attributeName);\n+        result = result || this.htmlDefinitions.isAllowedAttribute(attributeName);\n+        result = result || this.svgDefinitions.isAllowedAttribute(attributeName);\n+        result = result || this.mathMLDefinitions.isAllowedAttribute(attributeName);\n+        result = result || this.xmlAttributes.contains(attributeName);\n+        return result;\n+    }\n+\n+    private boolean isScriptOrData(String attributeValue)\n+    {\n+        return IS_SCRIPT_OR_DATA.matcher(ATTR_WHITESPACE.matcher(attributeValue).replaceAll(\"\")).find();\n+    }\n+\n+    private boolean isAllowedDataValue(String elementName, String attributeName, String attributeValue)\n+    {\n+        boolean attributeAllowsData = \"src\".equals(attributeName) || \"xlink:href\".equals(attributeName)\n+            || \"href\".equals(attributeName);\n+        return attributeAllowsData && !\"script\".equals(elementName) && attributeValue.startsWith(\"data:\")\n+            && this.dataUriTags.contains(elementName);\n+    }\n+}"
        },
        {
          "filename": "xwiki-commons-core/xwiki-commons-xml/src/main/resources/META-INF/components.txt",
          "status": "modified",
          "additions": 7,
          "deletions": 0,
          "patch": "@@ -8,5 +8,12 @@ org.xwiki.xml.internal.html.filter.AttributeFilter\n org.xwiki.xml.internal.html.filter.UniqueIdFilter\n org.xwiki.xml.internal.html.DefaultHTMLCleaner\n org.xwiki.xml.internal.html.XWikiHTML5TagProvider\n+org.xwiki.xml.internal.html.DefaultHTMLElementSanitizer\n+org.xwiki.xml.internal.html.SecureHTMLElementSanitizer\n+org.xwiki.xml.internal.html.InsecureHTMLElementSanitizer\n+org.xwiki.xml.internal.html.HTMLElementSanitizerConfiguration\n+org.xwiki.xml.internal.html.HTMLDefinitions\n+org.xwiki.xml.internal.html.MathMLDefinitions\n+org.xwiki.xml.internal.html.SVGDefinitions\n org.xwiki.xml.internal.LocalEntityResolver\n org.xwiki.xml.internal.DefaultXMLReaderFactory"
        },
        {
          "filename": "xwiki-commons-core/xwiki-commons-xml/src/test/java/org/xwiki/xml/internal/html/DefaultHTMLElementSanitizerTest.java",
          "status": "added",
          "additions": 183,
          "deletions": 0,
          "patch": "@@ -0,0 +1,183 @@\n+/*\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+package org.xwiki.xml.internal.html;\n+\n+import java.lang.reflect.Type;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import javax.inject.Named;\n+\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.RegisterExtension;\n+import org.xwiki.component.manager.ComponentLookupException;\n+import org.xwiki.configuration.ConfigurationSource;\n+import org.xwiki.configuration.internal.RestrictedConfigurationSourceProvider;\n+import org.xwiki.context.Execution;\n+import org.xwiki.context.ExecutionContext;\n+import org.xwiki.test.LogLevel;\n+import org.xwiki.test.annotation.ComponentList;\n+import org.xwiki.test.junit5.LogCaptureExtension;\n+import org.xwiki.test.junit5.mockito.ComponentTest;\n+import org.xwiki.test.junit5.mockito.MockComponent;\n+import org.xwiki.test.mockito.MockitoComponentManager;\n+import org.xwiki.xml.html.HTMLConstants;\n+import org.xwiki.xml.html.HTMLElementSanitizer;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertFalse;\n+import static org.junit.jupiter.api.Assertions.assertThrows;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.when;\n+\n+/**\n+ * Test the {@link DefaultHTMLElementSanitizer}.\n+ *\n+ * @version $Id$\n+ * @since 14.6RC1\n+ */\n+@ComponentTest\n+@ComponentList({ DefaultHTMLElementSanitizer.class,\n+    SecureHTMLElementSanitizer.class,\n+    InsecureHTMLElementSanitizer.class,\n+    HTMLElementSanitizerConfiguration.class,\n+    RestrictedConfigurationSourceProvider.class,\n+    HTMLDefinitions.class,\n+    MathMLDefinitions.class,\n+    SVGDefinitions.class\n+})\n+class DefaultHTMLElementSanitizerTest\n+{\n+    private static final String EXPECTED_ERROR_LOADING_FOO =\n+        \"Couldn't load the configured HTMLElementSanitizer with hint [foo], falling back to \"\n+            + \"the default secure implementation: ComponentLookupException: Can't find descriptor for the \"\n+            + \"component with type [interface org.xwiki.xml.html.HTMLElementSanitizer] and hint [foo]\";\n+\n+    private static final String EXPECTED_ERROR_LOADING_FOO_FROM_EXECUTION = \"Couldn't load the HTMLElementSanitizer \"\n+        + \"with hint [foo] from the execution context, falling back to the configured implementation: \"\n+        + \"ComponentLookupException: Can't find descriptor for the component with type \"\n+        + \"[interface org.xwiki.xml.html.HTMLElementSanitizer] and hint [foo]\";\n+\n+    private static final String FOO = \"foo\";\n+\n+    private static final String INSECURE = \"insecure\";\n+\n+    @RegisterExtension\n+    private final LogCaptureExtension logCaptureExtension = new LogCaptureExtension(LogLevel.ERROR);\n+\n+    @MockComponent\n+    @Named(\"restricted\")\n+    private ConfigurationSource configurationSource;\n+\n+    @MockComponent\n+    private Execution execution;\n+\n+    @BeforeEach\n+    void mockConfiguration()\n+    {\n+        when(this.configurationSource.getProperty(any(), eq(List.class), eq(Collections.emptyList())))\n+            .thenReturn(Collections.emptyList());\n+        when(this.configurationSource.getProperty(any(), eq(Boolean.class), eq(true))).thenReturn(true);\n+    }\n+\n+    @Test\n+    void secure(MockitoComponentManager componentManager) throws ComponentLookupException\n+    {\n+        when(this.configurationSource.getProperty(any(), eq(SecureHTMLElementSanitizer.HINT)))\n+            .thenReturn(SecureHTMLElementSanitizer.HINT);\n+        HTMLElementSanitizer htmlElementSanitizer = componentManager.getInstance(HTMLElementSanitizer.class);\n+        assertFalse(htmlElementSanitizer.isElementAllowed(\"no-such-element\"));\n+        assertFalse(htmlElementSanitizer.isAttributeAllowed(HTMLConstants.TAG_IMG, \"onerror\", \"hello\"));\n+        assertTrue(htmlElementSanitizer.isAttributeAllowed(HTMLConstants.TAG_SPAN, \"data-xwiki\", \"true\"));\n+    }\n+\n+    @Test\n+    void insecure(MockitoComponentManager componentManager) throws ComponentLookupException\n+    {\n+        when(this.configurationSource.getProperty(any(), eq(SecureHTMLElementSanitizer.HINT)))\n+            .thenReturn(INSECURE);\n+        HTMLElementSanitizer htmlElementSanitizer = componentManager.getInstance(HTMLElementSanitizer.class);\n+        assertTrue(htmlElementSanitizer.isElementAllowed(HTMLConstants.TAG_SCRIPT));\n+    }\n+\n+    @Test\n+    void fallback(MockitoComponentManager componentManager) throws ComponentLookupException\n+    {\n+        when(this.configurationSource.getProperty(any(), eq(SecureHTMLElementSanitizer.HINT))).thenReturn(FOO);\n+\n+        HTMLElementSanitizer htmlElementSanitizer = componentManager.getInstance(HTMLElementSanitizer.class);\n+\n+        assertEquals(EXPECTED_ERROR_LOADING_FOO, this.logCaptureExtension.getMessage(0));\n+        assertFalse(htmlElementSanitizer.isElementAllowed(FOO));\n+    }\n+\n+    @Test\n+    void throwingWhenFailure(MockitoComponentManager componentManager)\n+    {\n+        componentManager.unregisterComponent((Type) HTMLElementSanitizer.class, SecureHTMLElementSanitizer.HINT);\n+\n+        when(this.configurationSource.getProperty(any(), eq(SecureHTMLElementSanitizer.HINT))).thenReturn(FOO);\n+\n+        ComponentLookupException exception = assertThrows(ComponentLookupException.class,\n+            () -> componentManager.getInstance(HTMLElementSanitizer.class));\n+        assertEquals(\"Couldn't initialize the default secure HTMLElementSanitizer\",\n+            exception.getCause().getMessage());\n+\n+        assertEquals(EXPECTED_ERROR_LOADING_FOO, this.logCaptureExtension.getMessage(0));\n+    }\n+\n+    @Test\n+    void customFromExecutionContext(MockitoComponentManager componentManager) throws ComponentLookupException\n+    {\n+        when(this.configurationSource.getProperty(any(), eq(SecureHTMLElementSanitizer.HINT)))\n+            .thenReturn(SecureHTMLElementSanitizer.HINT);\n+\n+        HTMLElementSanitizer htmlElementSanitizer = componentManager.getInstance(HTMLElementSanitizer.class);\n+        assertFalse(htmlElementSanitizer.isElementAllowed(FOO));\n+\n+        ExecutionContext context = new ExecutionContext();\n+        context.setProperty(HTMLElementSanitizer.EXECUTION_CONTEXT_HINT_KEY, INSECURE);\n+        when(this.execution.getContext()).thenReturn(context);\n+\n+        assertTrue(htmlElementSanitizer.isElementAllowed(FOO));\n+    }\n+\n+    @Test\n+    void fallBackToConfiguredWhenExecutionContextHintIsInvalid(MockitoComponentManager componentManager)\n+        throws ComponentLookupException\n+    {\n+        when(this.configurationSource.getProperty(any(), eq(SecureHTMLElementSanitizer.HINT)))\n+            .thenReturn(SecureHTMLElementSanitizer.HINT);\n+\n+        HTMLElementSanitizer htmlElementSanitizer = componentManager.getInstance(HTMLElementSanitizer.class);\n+        assertFalse(htmlElementSanitizer.isElementAllowed(FOO));\n+\n+        ExecutionContext context = new ExecutionContext();\n+        context.setProperty(HTMLElementSanitizer.EXECUTION_CONTEXT_HINT_KEY, FOO);\n+        when(this.execution.getContext()).thenReturn(context);\n+\n+        assertFalse(htmlElementSanitizer.isElementAllowed(FOO));\n+\n+        assertEquals(EXPECTED_ERROR_LOADING_FOO_FROM_EXECUTION, this.logCaptureExtension.getMessage(0));\n+    }\n+}"
        },
        {
          "filename": "xwiki-commons-core/xwiki-commons-xml/src/test/java/org/xwiki/xml/internal/html/HTMLElementSanitizerTest.java",
          "status": "added",
          "additions": 128,
          "deletions": 0,
          "patch": "@@ -0,0 +1,128 @@\n+/*\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+package org.xwiki.xml.internal.html;\n+\n+import java.util.function.Supplier;\n+import java.util.stream.Stream;\n+\n+import org.junit.jupiter.api.Named;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInstance;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.Arguments;\n+import org.junit.jupiter.params.provider.MethodSource;\n+import org.xwiki.test.annotation.ComponentList;\n+import org.xwiki.test.junit5.mockito.ComponentTest;\n+import org.xwiki.test.junit5.mockito.InjectMockComponents;\n+import org.xwiki.xml.html.HTMLConstants;\n+import org.xwiki.xml.html.HTMLElementSanitizer;\n+\n+import static org.junit.jupiter.api.Assertions.assertFalse;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.junit.jupiter.params.provider.Arguments.arguments;\n+\n+/**\n+ * Test the {@link SecureHTMLElementSanitizer}.\n+ *\n+ * @version $Id$\n+ * @since 14.6RC1\n+ */\n+@ComponentTest\n+@ComponentList({\n+    HTMLDefinitions.class,\n+    MathMLDefinitions.class,\n+    SVGDefinitions.class\n+})\n+@TestInstance(TestInstance.Lifecycle.PER_CLASS)\n+class HTMLElementSanitizerTest\n+{\n+    private static final String JAVASCRIPT_ALERT = \"javascript:alert(1)\";\n+\n+    @InjectMockComponents\n+    private SecureHTMLElementSanitizer secureHTMLElementSanitizer;\n+\n+    @InjectMockComponents\n+    private InsecureHTMLElementSanitizer insecureHTMLElementSanitizer;\n+\n+    @Test\n+    void scriptIsDisallowedInSecureSanitizer()\n+    {\n+        assertFalse(this.secureHTMLElementSanitizer.isElementAllowed(HTMLConstants.TAG_SCRIPT));\n+        assertFalse(this.secureHTMLElementSanitizer.isAttributeAllowed(HTMLConstants.TAG_IMG, \"onerror\", \"alert(1)\"));\n+        assertFalse(this.secureHTMLElementSanitizer.isAttributeAllowed(HTMLConstants.TAG_A,\n+            HTMLConstants.ATTRIBUTE_HREF, JAVASCRIPT_ALERT));\n+    }\n+\n+    @ParameterizedTest\n+    @MethodSource(\"allSanitizersProvider\")\n+    void dataAttributeIsAllowed(Supplier<HTMLElementSanitizer> htmlElementSanitizer)\n+    {\n+        assertTrue(htmlElementSanitizer.get().isAttributeAllowed(HTMLConstants.TAG_SPAN, \"data-foo\", JAVASCRIPT_ALERT));\n+    }\n+\n+    @ParameterizedTest\n+    @MethodSource(\"allSanitizersProvider\")\n+    void dataImgIsAllowed(Supplier<HTMLElementSanitizer> htmlElementSanitizer)\n+    {\n+        assertTrue(htmlElementSanitizer.get().isAttributeAllowed(HTMLConstants.TAG_IMG, HTMLConstants.ATTRIBUTE_SRC,\n+            \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4\"\n+                + \"  //8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU5ErkJggg==\"));\n+    }\n+\n+    @ParameterizedTest\n+    @MethodSource(\"allSanitizersProvider\")\n+    void linkProtocolsAreAllowed(Supplier<HTMLElementSanitizer> htmlElementSanitizer)\n+    {\n+        assertTrue(htmlElementSanitizer.get().isAttributeAllowed(HTMLConstants.TAG_A, HTMLConstants.ATTRIBUTE_HREF,\n+            \"https://www.xwiki.org\"));\n+        assertTrue(htmlElementSanitizer.get().isAttributeAllowed(HTMLConstants.TAG_A, HTMLConstants.ATTRIBUTE_HREF,\n+            \"tel:+1234567890\"));\n+    }\n+\n+    @Test\n+    void arbitraryAttributesAreDisallowedInSecureSanitizer()\n+    {\n+        assertFalse(this.secureHTMLElementSanitizer.isElementAllowed(\"foo\"));\n+        assertFalse(this.secureHTMLElementSanitizer.isAttributeAllowed(HTMLConstants.TAG_SPAN, \"bar\", \"baz\"));\n+    }\n+\n+    @Test\n+    void arbitraryAttributesAreAllowedInInsecureSanitizer()\n+    {\n+        assertTrue(this.insecureHTMLElementSanitizer.isElementAllowed(\"xwiki\"));\n+        assertTrue(this.insecureHTMLElementSanitizer.isAttributeAllowed(HTMLConstants.TAG_SPAN, \"hello\", \"world\"));\n+    }\n+\n+    private Arguments getSecureSanitizer()\n+    {\n+        // Use a supplier because the components haven't been injected yet when the arguments are collected.\n+        return arguments(Named.<Supplier<HTMLElementSanitizer>>of(\"secure\", () -> this.secureHTMLElementSanitizer));\n+    }\n+\n+    private Arguments getInsecureSanitizer()\n+    {\n+        return arguments(Named.<Supplier<HTMLElementSanitizer>>of(\"insecure\", () -> this.insecureHTMLElementSanitizer));\n+    }\n+\n+    Stream<Arguments> allSanitizersProvider()\n+    {\n+        return Stream.of(getSecureSanitizer(), getInsecureSanitizer());\n+    }\n+}"
        },
        {
          "filename": "xwiki-commons-core/xwiki-commons-xml/src/test/java/org/xwiki/xml/internal/html/SecureHTMLElementSanitizerTest.java",
          "status": "added",
          "additions": 136,
          "deletions": 0,
          "patch": "@@ -0,0 +1,136 @@\n+/*\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+package org.xwiki.xml.internal.html;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+\n+import org.junit.jupiter.api.Test;\n+import org.xwiki.test.annotation.BeforeComponent;\n+import org.xwiki.test.annotation.ComponentList;\n+import org.xwiki.test.junit5.mockito.ComponentTest;\n+import org.xwiki.test.junit5.mockito.InjectMockComponents;\n+import org.xwiki.test.junit5.mockito.MockComponent;\n+import org.xwiki.xml.html.HTMLConstants;\n+\n+import static org.junit.jupiter.api.Assertions.assertFalse;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.mockito.Mockito.when;\n+\n+/**\n+ * Unit tests for the {@link SecureHTMLElementSanitizer}.\n+ *\n+ * @version $Id$\n+ * @since 14.6RC1\n+ */\n+@ComponentTest\n+@ComponentList({\n+    HTMLDefinitions.class,\n+    MathMLDefinitions.class,\n+    SVGDefinitions.class\n+})\n+class SecureHTMLElementSanitizerTest\n+{\n+    private static final String ALLOWED_ATTRIBUTE = \"allowed_attribute\";\n+\n+    private static final String ONERROR = \"onerror\";\n+\n+    @MockComponent\n+    private HTMLElementSanitizerConfiguration htmlElementSanitizerConfiguration;\n+\n+    @InjectMockComponents\n+    private SecureHTMLElementSanitizer secureHTMLElementSanitizer;\n+\n+    @BeforeComponent\n+    void setupMocks()\n+    {\n+        when(this.htmlElementSanitizerConfiguration.getForbidTags())\n+            .thenReturn(Collections.singletonList(HTMLConstants.TAG_A));\n+        when(this.htmlElementSanitizerConfiguration.getForbidAttributes())\n+            .thenReturn(Collections.singletonList(HTMLConstants.ATTRIBUTE_ALT));\n+        when(this.htmlElementSanitizerConfiguration.getExtraAllowedTags())\n+            .thenReturn(Collections.singletonList(HTMLConstants.TAG_SCRIPT));\n+        when(this.htmlElementSanitizerConfiguration.getExtraAllowedAttributes())\n+            .thenReturn(Arrays.asList(ALLOWED_ATTRIBUTE, ONERROR));\n+        when(this.htmlElementSanitizerConfiguration.getExtraUriSafeAttributes())\n+            .thenReturn(Collections.singletonList(HTMLConstants.ATTRIBUTE_SRC));\n+        when(this.htmlElementSanitizerConfiguration.getExtraDataUriTags())\n+            .thenReturn(Arrays.asList(HTMLConstants.TAG_SCRIPT, HTMLConstants.TAG_NAV));\n+        when(this.htmlElementSanitizerConfiguration.isAllowUnknownProtocols())\n+            .thenReturn(false);\n+        when(this.htmlElementSanitizerConfiguration.getAllowedUriRegexp())\n+            .thenReturn(\"^(xwiki|https):\");\n+    }\n+\n+    @Test\n+    void forbiddenTags()\n+    {\n+        assertFalse(this.secureHTMLElementSanitizer.isElementAllowed(HTMLConstants.TAG_A));\n+    }\n+\n+    @Test\n+    void forbiddenAttributes()\n+    {\n+        assertFalse(this.secureHTMLElementSanitizer.isAttributeAllowed(HTMLConstants.TAG_IMG,\n+            HTMLConstants.ATTRIBUTE_ALT, \"XWiki\"));\n+    }\n+\n+    @Test\n+    void extraAllowedTags()\n+    {\n+        assertTrue(this.secureHTMLElementSanitizer.isElementAllowed(HTMLConstants.TAG_SCRIPT));\n+    }\n+\n+    @Test\n+    void extraAllowedAttributes()\n+    {\n+        assertTrue(this.secureHTMLElementSanitizer.isAttributeAllowed(HTMLConstants.TAG_IMG, ALLOWED_ATTRIBUTE,\n+            \"value\"));\n+        assertTrue(this.secureHTMLElementSanitizer.isAttributeAllowed(HTMLConstants.TAG_IMG, ONERROR, \"alert(1)\"));\n+    }\n+\n+    @Test\n+    void extraUriSafeAttributes()\n+    {\n+        assertTrue(this.secureHTMLElementSanitizer.isAttributeAllowed(HTMLConstants.TAG_IMG,\n+            HTMLConstants.ATTRIBUTE_SRC, \"javascript:alert(1)\"));\n+    }\n+\n+    @Test\n+    void extraDataUriTags()\n+    {\n+        assertTrue(this.secureHTMLElementSanitizer.isAttributeAllowed(HTMLConstants.TAG_NAV,\n+            HTMLConstants.ATTRIBUTE_HREF, \"data:test\"));\n+        // Script cannot be enabled for data-attributes.\n+        assertFalse(this.secureHTMLElementSanitizer.isAttributeAllowed(HTMLConstants.TAG_SCRIPT,\n+            HTMLConstants.ATTRIBUTE_HREF, \"data:script\"));\n+    }\n+\n+    @Test\n+    void restrictedURIs()\n+    {\n+        assertTrue(this.secureHTMLElementSanitizer.isAttributeAllowed(HTMLConstants.TAG_A,\n+            HTMLConstants.ATTRIBUTE_HREF, \"https://www.xwiki.org\"));\n+        assertTrue(this.secureHTMLElementSanitizer.isAttributeAllowed(HTMLConstants.TAG_A,\n+            HTMLConstants.ATTRIBUTE_HREF, \"xwiki:test\"));\n+        assertFalse(this.secureHTMLElementSanitizer.isAttributeAllowed(HTMLConstants.TAG_A,\n+            HTMLConstants.ATTRIBUTE_HREF, \"http://example.com\"));\n+    }\n+}"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 1,
        "dependency_files": 0,
        "test_files": 3,
        "unique_directories": 6,
        "max_directory_depth": 10
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "85b59159bb4fb19b6419bac3169b4d40f3d348b2",
            "date": "2025-01-13T15:52:46Z",
            "author_login": "tmortagne"
          },
          {
            "sha": "f3fd1088356deb08a7ef9f13100339111922fc82",
            "date": "2025-01-13T15:51:12Z",
            "author_login": "tmortagne"
          },
          {
            "sha": "0ecc68313bbc332ad0920eb13df5036bee737b02",
            "date": "2025-01-10T16:43:17Z",
            "author_login": "tmortagne"
          },
          {
            "sha": "c6c8a421e5ce215f3e62c8ea7d12254e5483f3b5",
            "date": "2025-01-10T14:52:33Z",
            "author_login": "tmortagne"
          },
          {
            "sha": "eaf8b5b360fd57d5c262f0830766b92fcf334d04",
            "date": "2025-01-10T14:08:59Z",
            "author_login": "tmortagne"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 9.0,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:H/I:H/A:H",
    "cwe_id": "CWE-79",
    "description": "XWiki Commons are technical libraries common to several other top level XWiki projects. The \"restricted\" mode of the HTML cleaner in XWiki, introduced in version 4.2-milestone-1, only escaped `<script>` and `<style>`-tags but neither attributes that can be used to inject scripts nor other dangerous HTML tags like `<iframe>`. As a consequence, any code relying on this \"restricted\" mode for security is vulnerable to JavaScript injection (\"cross-site scripting\"/XSS). When a privileged user with programming rights visits such a comment in XWiki, the malicious JavaScript code is executed in the context of the user session. This allows server-side code execution with programming rights, impacting the confidentiality, integrity and availability of the XWiki instance. This problem has been patched in XWiki 14.6 RC1 with the introduction of a filter with allowed HTML elements and attributes that is enabled in restricted mode. There are no known workarounds apart from upgrading to a version including the fix.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-04-15T15:15:08.273",
    "last_modified": "2024-11-21T07:56:42.300",
    "fix_date": "2022-06-27T15:50:15Z"
  },
  "references": [
    {
      "url": "https://github.com/xwiki/xwiki-commons/commit/4a185e0594d90cd4916d60aa60bb4333dc5623b2",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-commons/commit/b11eae9d82cb53f32962056b5faa73f3720c6182",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-commons/security/advisories/GHSA-m3jr-cvhj-f35j",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://jira.xwiki.org/browse/XCOMMONS-1680",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Issue Tracking"
      ]
    },
    {
      "url": "https://jira.xwiki.org/browse/XCOMMONS-2426",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Issue Tracking"
      ]
    },
    {
      "url": "https://jira.xwiki.org/browse/XWIKI-9118",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Issue Tracking"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-commons/commit/4a185e0594d90cd4916d60aa60bb4333dc5623b2",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-commons/commit/b11eae9d82cb53f32962056b5faa73f3720c6182",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-commons/security/advisories/GHSA-m3jr-cvhj-f35j",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://jira.xwiki.org/browse/XCOMMONS-1680",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Issue Tracking"
      ]
    },
    {
      "url": "https://jira.xwiki.org/browse/XCOMMONS-2426",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Issue Tracking"
      ]
    },
    {
      "url": "https://jira.xwiki.org/browse/XWIKI-9118",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Issue Tracking"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:05:11.790669",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "xwiki-commons",
    "owner": "xwiki",
    "created_at": "2011-03-04T21:31:54Z",
    "updated_at": "2025-01-13T15:52:59Z",
    "pushed_at": "2025-01-13T15:52:55Z",
    "size": 38500,
    "stars": 85,
    "forks": 123,
    "open_issues": 27,
    "watchers": 85,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "master",
      "stable-14.10.x",
      "stable-15.10.x",
      "stable-16.4.x",
      "stable-16.10.x"
    ],
    "languages": {
      "Java": 7553862,
      "AspectJ": 6773,
      "AMPL": 4949,
      "Groovy": 1367,
      "JavaScript": 911,
      "CSS": 21
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "lgpl-2.1"
    },
    "collected_at": "2025-01-14T16:59:29.086917"
  }
}