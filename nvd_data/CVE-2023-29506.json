{
  "cve_id": "CVE-2023-29506",
  "github_data": {
    "repository": "xwiki/xwiki-platform",
    "fix_commit": "1943ea26c967ef868fb5f67c487d98d97cba0380",
    "related_commits": [
      "1943ea26c967ef868fb5f67c487d98d97cba0380",
      "1943ea26c967ef868fb5f67c487d98d97cba0380"
    ],
    "patch_url": "https://github.com/xwiki/xwiki-platform/commit/1943ea26c967ef868fb5f67c487d98d97cba0380.patch",
    "fix_commit_details": {
      "sha": "1943ea26c967ef868fb5f67c487d98d97cba0380",
      "commit_date": "2022-11-15T15:30:18Z",
      "author": {
        "login": "surli",
        "type": "User",
        "stats": {
          "total_commits": 1932,
          "average_weekly_commits": 2.0251572327044025,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 283
        }
      },
      "commit_message": {
        "title": "XWIKI-20335: Wiki existence is not properly checked in authenticate",
        "length": 67,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 59,
        "additions": 55,
        "deletions": 4
      },
      "files": [
        {
          "filename": "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandler.java",
          "status": "modified",
          "additions": 16,
          "deletions": 0,
          "patch": "@@ -37,6 +37,8 @@\n import org.xwiki.resource.ResourceReferenceHandlerException;\n import org.xwiki.resource.ResourceType;\n import org.xwiki.security.authentication.AuthenticationResourceReference;\n+import org.xwiki.wiki.descriptor.WikiDescriptorManager;\n+import org.xwiki.wiki.manager.WikiManagerException;\n \n import com.xpn.xwiki.XWikiContext;\n import com.xpn.xwiki.XWikiContextInitializer;\n@@ -59,6 +61,9 @@ public class AuthenticationResourceReferenceHandler extends AbstractResourceRefe\n     @Inject\n     private Execution execution;\n \n+    @Inject\n+    private WikiDescriptorManager wikiDescriptorManager;\n+\n     @Override\n     public List<ResourceType> getSupportedResourceReferences()\n     {\n@@ -71,6 +76,17 @@ public void handle(ResourceReference reference, ResourceReferenceHandlerChain ch\n     {\n         AuthenticationResourceReference authenticationResourceReference = (AuthenticationResourceReference) reference;\n \n+        WikiReference wikiReference = authenticationResourceReference.getWikiReference();\n+        try {\n+            if (!this.wikiDescriptorManager.exists(wikiReference.getName())) {\n+                throw new ResourceReferenceHandlerException(\n+                    String.format(\"The wiki [%s] does not exist.\", wikiReference.getName()));\n+            }\n+        } catch (WikiManagerException e) {\n+            throw new ResourceReferenceHandlerException(\n+                String.format(\"Error when checking if wiki [%s] exists.\", wikiReference.getName()), e);\n+        }\n+\n         switch (authenticationResourceReference.getAction()) {\n             case RETRIEVE_USERNAME:\n                 this.handleAction(\"forgotusername\", authenticationResourceReference.getWikiReference());"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandlerTest.java",
          "status": "modified",
          "additions": 39,
          "deletions": 4,
          "patch": "@@ -31,11 +31,14 @@\n import org.xwiki.context.ExecutionContext;\n import org.xwiki.model.reference.WikiReference;\n import org.xwiki.resource.ResourceReferenceHandlerChain;\n+import org.xwiki.resource.ResourceReferenceHandlerException;\n import org.xwiki.security.authentication.AuthenticationAction;\n import org.xwiki.security.authentication.AuthenticationResourceReference;\n import org.xwiki.test.junit5.mockito.ComponentTest;\n import org.xwiki.test.junit5.mockito.InjectMockComponents;\n import org.xwiki.test.junit5.mockito.MockComponent;\n+import org.xwiki.wiki.descriptor.WikiDescriptorManager;\n+import org.xwiki.wiki.manager.WikiManagerException;\n \n import com.xpn.xwiki.XWiki;\n import com.xpn.xwiki.XWikiContext;\n@@ -45,6 +48,7 @@\n import com.xpn.xwiki.web.XWikiResponse;\n \n import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertThrows;\n import static org.mockito.ArgumentMatchers.any;\n import static org.mockito.ArgumentMatchers.eq;\n import static org.mockito.Mockito.mock;\n@@ -69,6 +73,9 @@ class AuthenticationResourceReferenceHandlerTest\n     @MockComponent\n     private Execution execution;\n \n+    @MockComponent\n+    private WikiDescriptorManager wikiDescriptorManager;\n+\n     private XWikiResponse response;\n \n     private XWiki xwiki;\n@@ -112,13 +119,19 @@ void getSupportedResourceReferences()\n     void handleResetPassword() throws Exception\n     {\n         WikiReference wikiReference = new WikiReference(\"foo\");\n+        when(this.wikiDescriptorManager.exists(\"foo\")).thenReturn(false);\n         AuthenticationResourceReference resourceReference = new AuthenticationResourceReference(\n             wikiReference,\n             AuthenticationAction.RESET_PASSWORD);\n \n-        when(this.xwiki.evaluateTemplate(\"resetpassword.vm\", context)).thenReturn(\"Reset password content\");\n-\n         ResourceReferenceHandlerChain chain = mock(ResourceReferenceHandlerChain.class);\n+        ResourceReferenceHandlerException exception =\n+            assertThrows(ResourceReferenceHandlerException.class,\n+                () -> this.resourceReferenceHandler.handle(resourceReference, chain));\n+        assertEquals(\"The wiki [foo] does not exist.\", exception.getMessage());\n+\n+        when(this.wikiDescriptorManager.exists(\"foo\")).thenReturn(true);\n+        when(this.xwiki.evaluateTemplate(\"resetpassword.vm\", context)).thenReturn(\"Reset password content\");\n         this.resourceReferenceHandler.handle(resourceReference, chain);\n \n         verify(response).setContentType(\"text/html; charset=UTF-8\");\n@@ -133,20 +146,42 @@ void handleResetPassword() throws Exception\n     void handleForgotUsername() throws Exception\n     {\n         WikiReference wikiReference = new WikiReference(\"bar\");\n+        when(this.wikiDescriptorManager.exists(\"bar\")).thenReturn(false);\n         AuthenticationResourceReference resourceReference = new AuthenticationResourceReference(\n             wikiReference,\n             AuthenticationAction.RETRIEVE_USERNAME);\n \n+        ResourceReferenceHandlerChain chain = mock(ResourceReferenceHandlerChain.class);\n+        ResourceReferenceHandlerException exception =\n+            assertThrows(ResourceReferenceHandlerException.class,\n+                () -> this.resourceReferenceHandler.handle(resourceReference, chain));\n+        assertEquals(\"The wiki [bar] does not exist.\", exception.getMessage());\n+\n+        when(this.wikiDescriptorManager.exists(\"bar\")).thenReturn(true);\n         when(this.xwiki.evaluateTemplate(\"forgotusername.vm\", context)).thenReturn(\"Forgot user name content\");\n \n-        ResourceReferenceHandlerChain chain = mock(ResourceReferenceHandlerChain.class);\n         this.resourceReferenceHandler.handle(resourceReference, chain);\n-\n         verify(response).setContentType(\"text/html; charset=UTF-8\");\n         verify(this.xWikiContextInitializer).initialize(any(ExecutionContext.class));\n         verify(servletOutputStream).write(\"Forgot user name content\".getBytes(StandardCharsets.UTF_8));\n         verify(chain).handleNext(resourceReference);\n         verify(context).setWikiReference(wikiReference);\n         verify(context).setWikiReference(currentWiki);\n     }\n+\n+    @Test\n+    void handleForgotUsernameWikiDescriptorError() throws Exception\n+    {\n+        WikiReference wikiReference = new WikiReference(\"bar\");\n+        when(this.wikiDescriptorManager.exists(\"bar\")).thenThrow(new WikiManagerException(\"Cannot access wiki\"));\n+        AuthenticationResourceReference resourceReference = new AuthenticationResourceReference(\n+            wikiReference,\n+            AuthenticationAction.RETRIEVE_USERNAME);\n+\n+        ResourceReferenceHandlerChain chain = mock(ResourceReferenceHandlerChain.class);\n+        ResourceReferenceHandlerException exception =\n+            assertThrows(ResourceReferenceHandlerException.class,\n+                () -> this.resourceReferenceHandler.handle(resourceReference, chain));\n+        assertEquals(\"Error when checking if wiki [bar] exists.\", exception.getMessage());\n+    }\n }"
        }
      ],
      "file_patterns": {
        "security_files": 2,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 2,
        "max_directory_depth": 13
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "88e3e7d23cbd3e6ed059dbcd6532f94016d42678",
            "date": "2025-01-13T16:58:06Z",
            "author_login": "Sereza7"
          },
          {
            "sha": "9b506ab2bed52744b52699ea05cde15986d42abb",
            "date": "2025-01-13T16:36:24Z",
            "author_login": "mflorea"
          },
          {
            "sha": "d53d6e347b97ac20f60e21fb2bae381f4aaf10f4",
            "date": "2025-01-13T13:25:24Z",
            "author_login": "tmortagne"
          },
          {
            "sha": "d85bd8f9c67c412e0cfb45fb4695b8d4e759bab6",
            "date": "2025-01-13T12:03:22Z",
            "author_login": "tmortagne"
          },
          {
            "sha": "6f210dabc99167cf9f020a048c88325eca34ceea",
            "date": "2025-01-13T08:54:32Z",
            "author_login": "tmortagne"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 5.4,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:L/I:L/A:N",
    "cwe_id": "CWE-79",
    "description": "XWiki Commons are technical libraries common to several other top level XWiki projects. It was possible to inject some code using the URL of authenticated endpoints. This problem has been patched on XWiki 13.10.11, 14.4.7 and 14.10.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-04-16T07:15:53.123",
    "last_modified": "2024-11-21T07:57:11.703",
    "fix_date": "2022-11-15T15:30:18Z"
  },
  "references": [
    {
      "url": "https://github.com/xwiki/xwiki-platform/commit/1943ea26c967ef868fb5f67c487d98d97cba0380",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/security/advisories/GHSA-jjm5-5v9v-7hx2",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://jira.xwiki.org/browse/XWIKI-20335",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Issue Tracking"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/commit/1943ea26c967ef868fb5f67c487d98d97cba0380",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/security/advisories/GHSA-jjm5-5v9v-7hx2",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://jira.xwiki.org/browse/XWIKI-20335",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Issue Tracking"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:05:11.798579",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "xwiki-platform",
    "owner": "xwiki",
    "created_at": "2011-03-10T13:26:41Z",
    "updated_at": "2025-01-13T16:58:10Z",
    "pushed_at": "2025-01-14T12:32:03Z",
    "size": 561595,
    "stars": 1030,
    "forks": 554,
    "open_issues": 136,
    "watchers": 1030,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "Java": 34276921,
      "JavaScript": 2392892,
      "HTML": 388086,
      "Less": 318945,
      "AspectJ": 280487,
      "Vue": 222987,
      "CSS": 115460,
      "XSLT": 109285,
      "Clean": 44054,
      "Shell": 32569,
      "Batchfile": 14604,
      "Python": 5046,
      "Groovy": 3012,
      "AMPL": 1296
    },
    "commit_activity": {
      "total_commits_last_year": 1723,
      "avg_commits_per_week": 33.13461538461539,
      "days_active_last_year": 263
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "lgpl-2.1"
    },
    "collected_at": "2025-01-14T12:58:58.685838"
  }
}