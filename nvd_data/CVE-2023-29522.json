{
  "cve_id": "CVE-2023-29522",
  "github_data": {
    "repository": "xwiki/xwiki-platform",
    "fix_commit": "d7e56185376641ee5d66477c6b2791ca8e85cfee",
    "related_commits": [
      "d7e56185376641ee5d66477c6b2791ca8e85cfee",
      "d7e56185376641ee5d66477c6b2791ca8e85cfee"
    ],
    "patch_url": "https://github.com/xwiki/xwiki-platform/commit/d7e56185376641ee5d66477c6b2791ca8e85cfee.patch",
    "fix_commit_details": {
      "sha": "d7e56185376641ee5d66477c6b2791ca8e85cfee",
      "commit_date": "2023-01-03T16:37:10Z",
      "author": {
        "login": "manuelleduc",
        "type": "User",
        "stats": {
          "total_commits": 953,
          "average_weekly_commits": 0.9989517819706499,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 179
        }
      },
      "commit_message": {
        "title": "XWIKI-20456: Improved escaping of XWiki.ClassSheet",
        "length": 50,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 680,
        "additions": 621,
        "deletions": 59
      },
      "files": [
        {
          "filename": "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/locationPicker_macros.vm",
          "status": "modified",
          "additions": 25,
          "deletions": 17,
          "patch": "@@ -40,12 +40,14 @@\n     #set ($escapedValue = $escapetool.xml($value))\n     #if ($titleField.label)\n       <dt>\n-        <label for=\"$!{options.id}Title\">$services.localization.render($titleField.label)</label>\n-        <span class=\"xHint\">$!services.localization.render($titleField.hint)</span>\n+        <label for=\"$escapetool.xml($!{options.id})Title\">##\n+          $escapetool.xml($services.localization.render($titleField.label))##\n+        </label>\n+        <span class=\"xHint\">$!escapetool.xml($services.localization.render($titleField.hint))</span>\n       </dt>\n       <dd>\n-        <input type=\"text\" id=\"$!{options.id}Title\" name=\"$titleField.name\" value=\"$!escapedValue\"\n-          class=\"location-title-field\" placeholder=\"$!services.localization.render($titleField.placeholder)\" />\n+        <input type=\"text\" id=\"$escapetool.xml($!{options.id})Title\" name=\"$escapetool.xml($titleField.name)\" value=\"$!escapedValue\"\n+          class=\"location-title-field\" placeholder=\"$escapetool.xml($!services.localization.render($titleField.placeholder))\" />\n       </dd>\n     #elseif ($titleField)\n       <dt class=\"hidden\"></dt>\n@@ -60,8 +62,8 @@\n     ## ---------------------------------------------------------------------------------------------------------\n     ##\n     <dt>\n-      <label>$services.localization.render($options.preview.label)</label>\n-      <span class=\"xHint\">$services.localization.render($options.preview.hint)</span>\n+      <label>$escapetool.xml($services.localization.render($options.preview.label))</label>\n+      <span class=\"xHint\">$escapetool.xml($services.localization.render($options.preview.hint))</span>\n     </dt>\n     <dd>\n       #if ($isDocumentTreeAvailable)\n@@ -113,8 +115,10 @@\n       #set ($escapedValue = $escapetool.xml($value))\n       #if ($wikiField.label && $displayWikiFields)\n         <dt>\n-          <label for=\"$!{options.id}Wiki\">$services.localization.render($wikiField.label)</label>\n-          <span class=\"xHint\">$!services.localization.render($wikiField.hint)</span>\n+          <label for=\"$escapetool.xml($!{options.id})Wiki\">##\n+            $escapetool.xml($services.localization.render($wikiField.label))##\n+          </label>\n+          <span class=\"xHint\">$!escapetool.xml($services.localization.render($wikiField.hint))</span>\n         </dt>\n         <dd>\n           <select id=\"$!{options.id}Wiki\" name=\"$wikiField.name\" class=\"location-wiki-field\">\n@@ -156,13 +160,15 @@\n       #end\n       #set ($escapedValue = $escapetool.xml($value))\n       <dt>\n-        <label for=\"$!{options.id}ParentReference\">$services.localization.render($parentField.label)</label>\n-        <span class=\"xHint\">$!services.localization.render($parentField.hint)</span>\n+        <label for=\"$escapetool.xml($!{options.id})ParentReference\">##\n+          $escapetool.xml($services.localization.render($parentField.label))##\n+        </label>\n+        <span class=\"xHint\">$!escapetool.xml($services.localization.render($parentField.hint))</span>\n       </dt>\n       <dd>\n-        <input type=\"text\" id=\"$!{options.id}ParentReference\" class=\"location-parent-field suggestSpaces\"\n-          name=\"$parentField.name\" value=\"$!escapedValue\"\n-          placeholder=\"$!services.localization.render($parentField.placeholder)\" />\n+        <input type=\"text\" id=\"$escapetool.xml($!{options.id})ParentReference\" class=\"location-parent-field suggestSpaces\"\n+          name=\"$escapetool.xml($parentField.name)\" value=\"$!escapedValue\"\n+          placeholder=\"$!escapetool.xml($services.localization.render($parentField.placeholder))\" />\n       </dd>\n       ##\n       ## ---------------------------------------------------------------------------------------------------------\n@@ -177,13 +183,15 @@\n       #set ($escapedValue = $escapetool.xml($value))\n       #if ($nameField.label)\n         <dt>\n-          <label for=\"$!{options.id}Name\">$services.localization.render($nameField.label)</label>\n-          <span class=\"xHint\">$!services.localization.render($nameField.hint)</span>\n+          <label for=\"$escapetool.xml($!{options.id})Name\">##\n+            $escapetool.xml($services.localization.render($nameField.label))##\n+          </label>\n+          <span class=\"xHint\">$escapetool.xml($services.localization.render($nameField.hint))</span>\n         </dt>\n         <dd>\n-          <input type=\"text\" id=\"$!{options.id}Name\" name=\"$nameField.name\" class=\"location-name-field\"\n+          <input type=\"text\" id=\"$escapetool.xml($!{options.id})Name\" name=\"$escapetool.xml($nameField.name)\" class=\"location-name-field\"\n             value=\"$!escapedValue\"\n-            placeholder=\"$!services.localization.render($nameField.placeholder)\" />\n+            placeholder=\"$escapetool.xml($!services.localization.render($nameField.placeholder))\" />\n         </dd>\n       #elseif ($nameField)\n         <dt class=\"hidden\"></dt>"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-xclass/xwiki-platform-xclass-ui/pom.xml",
          "status": "modified",
          "additions": 40,
          "deletions": 0,
          "patch": "@@ -85,5 +85,45 @@\n       <version>${project.version}</version>\n       <scope>runtime</scope>\n     </dependency>\n+    <dependency>\n+      <groupId>org.xwiki.platform</groupId>\n+      <artifactId>xwiki-platform-rendering-xwiki</artifactId>\n+      <version>${project.version}</version>\n+      <scope>runtime</scope>\n+    </dependency>\n+    <!-- Test dependencies. -->\n+    <dependency>\n+      <groupId>org.xwiki.platform</groupId>\n+      <artifactId>xwiki-platform-test-page</artifactId>\n+      <version>${project.version}</version>\n+      <scope>test</scope>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.xwiki.platform</groupId>\n+      <artifactId>xwiki-platform-web-templates</artifactId>\n+      <version>${project.version}</version>\n+      <scope>test</scope>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.xwiki.platform</groupId>\n+      <artifactId>xwiki-platform-livedata-macro</artifactId>\n+      <version>${project.version}</version>\n+      <scope>test</scope>\n+      <type>test-jar</type>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.xwiki.platform</groupId>\n+      <artifactId>xwiki-platform-rendering-xwiki</artifactId>\n+      <version>${project.version}</version>\n+      <scope>test</scope>\n+      <type>test-jar</type>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.xwiki.platform</groupId>\n+      <artifactId>xwiki-platform-rendering-configuration-default</artifactId>\n+      <version>${project.version}</version>\n+      <type>test-jar</type>\n+      <scope>test</scope>\n+    </dependency>\n   </dependencies>\n </project>"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-xclass/xwiki-platform-xclass-ui/src/main/resources/XWiki/ClassSheet.xml",
          "status": "modified",
          "additions": 96,
          "deletions": 42,
          "patch": "@@ -129,31 +129,45 @@\n \n   #set ($classEditorURL = $doc.getURL('edit', 'editor=class'))\n   #if($doc.getxWikiClass().properties.size() == 0)\n-    {{warning}}$services.localization.render('platform.xclass.defaultClassSheet.properties.empty', [\n-      \"{{html}}&lt;a href='$classEditorURL'&gt;\",\n-      '&lt;/a&gt;{{/html}}'\n-    ]){{/warning}}\n+    #set ($openLink = \"&lt;a href='$escapetool.xml($classEditorURL)'&gt;\")\n+    #set ($closeLink = '&lt;/a&gt;')\n+    {{warning}}\n+      {{html}}\n+      ## First escape the content of the translation, then replace the placeholders with content that would otherwise be\n+      ## escaped during the first escaping.\n+      #set ($warningMessage = $services.localization.render('platform.xclass.defaultClassSheet.properties.empty', \n+        ['__OPEN_LINK__', '__CLOSE_LINK__']))\n+      $escapetool.xml($warningMessage).replace('__OPEN_LINK__', $openLink).replace('__CLOSE_LINK__', $closeLink)\n+      {{/html}}\n+    {{/warning}}\n   #else\n     (% id=\"HClassProperties\" %)\n     = {{translation key=\"platform.xclass.defaultClassSheet.properties.heading\"/}} =\n     #foreach($property in $doc.getxWikiClass().properties)\n       * $services.rendering.escape(\"$property.prettyName ($property.name: $xwiki.metaclass.get($property.classType).prettyName)\", $xwiki.currentContentSyntaxId)\n     #end\n-    * //$services.localization.render('platform.xclass.defaultClassSheet.properties.edit', [\n-      \"{{html}}&lt;a href='$classEditorURL'&gt;\",\n-      '&lt;/a&gt;{{/html}}'\n-    ])//\n+    #set ($openLink = \"&lt;a href='$escapetool.xml($classEditorURL)'&gt;\")\n+    #set ($closeLink = '&lt;/a&gt;')\n+    #set ($warningMessage = $escapetool.xml($services.localization.render('platform.xclass.defaultClassSheet.properties.edit', ['__OPEN_LINK__', '__CLOSE_LINK__'])))\n+    ## First escape the content of the translation, then replace the placeholders with content that would otherwise be\n+    ## escaped during the first escaping.\n+    * //{{html}}$warningMessage.replace('__OPEN_LINK__', $openLink).replace('__CLOSE_LINK__', $closeLink){{/html}}//\n \n   #end\n   #if ($hasClassSheets &amp;&amp; $hasClassTemplate)\n     (% id=\"HCreatePage\" %)\n     = {{translation key=\"platform.xclass.defaultClassSheet.createPage.heading\"/}} =\n     #if(\"$!targetDocRef\" != '' &amp;&amp; $xwiki.exists($targetDocRef))\n-\n-      {{warning}}$services.localization.render('platform.xclass.defaultClassSheet.createPage.pageAlreadyExists', [\n-        '[[',\n-        \"&gt;&gt;$services.model.serialize($targetDocRef)]]\"\n-      ]){{/warning}}\n+      {{warning}}\n+        {{html}}\n+          #set ($targetDocLink = $xwiki.getURL($targetDocRef))\n+          #set ($openLink = \"&lt;a href='$escapetool.xml($targetDocLink)'&gt;\")\n+          #set ($message = $escapetool.xml($services.localization.render('platform.xclass.defaultClassSheet.createPage.pageAlreadyExists', ['__OPEN_LINK__', '__CLOSE_LINK__'])))\n+          ## First escape the content of the translation, then replace the placeholders with content that would\n+          ## otherwise be escaped during the first escaping.\n+          $message.replace('__OPEN_LINK__', $openLink).replace('__CLOSE_LINK__', '&lt;/a&gt;')\n+        {{/html}}\n+      {{/warning}}\n     #elseif(\"$!targetDocRef\" != '')\n \n       {{warning}}{{translation key=\"platform.xclass.defaultClassSheet.createPage.denied\"/}}{{/warning}}\n@@ -164,8 +178,8 @@\n       &lt;fieldset&gt;\n       &lt;div class=\"hidden\"&gt;\n         &lt;input type=\"hidden\" name=\"form_token\" value=\"$!{services.csrf.getToken()}\" /&gt;\n-        &lt;input type=\"hidden\" name=\"parent\" value=\"${defaultParent}\"/&gt;\n-        &lt;input type=\"hidden\" name=\"template\" value=\"${classTemplateDoc}\"/&gt;\n+        &lt;input type=\"hidden\" name=\"parent\" value=\"$escapetool.xml(${defaultParent})\"/&gt;\n+        &lt;input type=\"hidden\" name=\"template\" value=\"$escapetool.xml(${classTemplateDoc})\"/&gt;\n         &lt;input type=\"hidden\" name=\"sheet\" value=\"1\"/&gt;\n       &lt;/div&gt;\n       #locationPicker({\n@@ -219,8 +233,8 @@\n     id=\"classEntries\"\n     properties=\"doc.title,doc.location,doc.date,doc.author,doc.objectCount,_actions\"\n     source=\"liveTable\"\n-    className=\"${doc.fullName}\"\n-    sourceParameters=\"${escapetool.url($options)}\"\n+    className=\"$services.rendering.escape(${doc.fullName}, 'xwiki/2.1')\"\n+    sourceParameters=\"$services.rendering.escape($escapetool.url($options), 'xwiki/2.1')\"\n   }}\n   {\n     \"meta\": {\n@@ -247,15 +261,21 @@\n     {{translation key=\"platform.xclass.defaultClassSheet.sheets.missing\"/}}\n   #end\n \n-  {{info}}$services.localization.render('platform.xclass.defaultClassSheet.sheets.description', ['//', '//']){{/info}}\n+  {{info}}\n+    #set ($message = $services.localization.render('platform.xclass.defaultClassSheet.sheets.description', ['__START_EM__', '__END_EM__']))\n+    #set ($message = $escapetool.xml($message))\n+    ## First escape the content of the translation, then replace the placeholders with content that would\n+    ## otherwise be escaped during the first escaping.\n+    {{html}}$message.replace('__START_EM__', '&lt;em&gt;').replace('__END_EM__', '&lt;/em&gt;'){{/html}}\n+  {{/info}}\n \n   #if(!$hasClassSheets)\n     {{html}}\n       &lt;form action=\"$xwiki.getURL($defaultClassSheetReference, 'save', 'editor=wiki')\" method=\"post\"&gt;\n         &lt;div&gt;\n           &lt;input type=\"hidden\" name=\"form_token\" value=\"$!{services.csrf.getToken()}\" /&gt;\n-          &lt;input type=\"hidden\" name=\"parent\" value=\"${doc.fullName}\"/&gt;\n-          &lt;input type=\"hidden\" name=\"xredirect\" value=\"${doc.URL}\"/&gt;\n+          &lt;input type=\"hidden\" name=\"parent\" value=\"$escapetool.xml(${doc.fullName})\"/&gt;\n+          &lt;input type=\"hidden\" name=\"xredirect\" value=\"$escapetool.xml(${doc.URL})\"/&gt;\n           #set ($sheetContent = $xwiki.getDocument('XWiki.ObjectSheet').getContent().replace('XWiki.MyClass',\n             $doc.fullName))\n           ## We have to encode the new line characters in order to preserve them, otherwise they are replace with a\n@@ -280,7 +300,9 @@\n         {{translation key=\"platform.xclass.defaultClassSheet.sheets.notBound\"/}} ##\n         #if ($hasEdit)\n           {{html}}\n-          &lt;a href=\"$bindURL\"&gt;$services.localization.render('platform.xclass.defaultClassSheet.sheets.bind') \u00bb&lt;/a&gt;.\n+          &lt;a href=\"$escapetool.xml($bindURL)\"&gt;##\n+            $escapetool.xml($services.localization.render('platform.xclass.defaultClassSheet.sheets.bind')) \u00bb##\n+          &lt;/a&gt;.\n           {{/html}}\n         #end\n       {{/warning}}\n@@ -292,7 +314,12 @@\n         #set($classSheetDoc = $xwiki.getDocument($classSheetReferences.get(0)))\n       #end\n       #set ($sheetPath = \"#hierarchy($classSheetDoc.documentReference, {'plain': true, 'local': true, 'limit': 4})\")\n-      [[$services.localization.render('platform.xclass.defaultClassSheet.sheets.view', [$sheetPath.trim()]) \u00bb&gt;&gt;${classSheetDoc.fullName}]]\n+      #set ($classSheetLink = \"$services.localization.render('platform.xclass.defaultClassSheet.sheets.view', [$sheetPath.trim()]) \u00bb\")\n+      #set ($classSheetLink = $services.rendering.escape($classSheetLink, 'xwiki/2.1'))\n+      #set ($classSheetLink = $services.rendering.escape($classSheetLink, 'xwiki/2.1'))\n+      #set ($classSheetText = ${classSheetDoc.fullName})\n+      #set ($classSheetText = $services.rendering.escape($classSheetText, 'xwiki/2.1'))\n+      [[$classSheetLink&gt;&gt;$classSheetText]]\n     #else\n       {{translation key=\"platform.xclass.defaultClassSheet.sheets.list\"/}}\n \n@@ -305,17 +332,22 @@\n   (% id=\"HClassTemplate\" %)\n   = {{translation key=\"platform.xclass.defaultClassSheet.template.heading\"/}} =\n \n-    {{info}}$services.localization.render('platform.xclass.defaultClassSheet.template.description',\n-      ['//', '//']){{/info}}\n+    {{info}}\n+      #set ($message = $services.localization.render('platform.xclass.defaultClassSheet.template.description', ['__START_EM__', '__END_EM__']))\n+      #set ($message = $escapetool.xml($message))\n+      ## First escape the content of the translation, then replace the placeholders with content that would\n+      ## otherwise be escaped during the first escaping.\n+      {{html}}$message.replace('__START_EM__', '&lt;em&gt;').replace('__END_EM__', '&lt;/em&gt;'){{/html}}\n+    {{/info}}\n \n   #if (!$hasClassTemplate)\n     {{html}}\n-      &lt;form action=\"$classTemplateDoc.getURL('save', 'editor=wiki')\" method=\"post\"&gt;\n+      &lt;form action=\"$escapetool.xml($classTemplateDoc.getURL('save', 'editor=wiki'))\" method=\"post\"&gt;\n         &lt;div&gt;\n           &lt;input type=\"hidden\" name=\"form_token\" value=\"$!{services.csrf.getToken()}\" /&gt;\n-          &lt;input type=\"hidden\" name=\"parent\" value=\"${doc.fullName}\"/&gt;\n-          &lt;input type=\"hidden\" name=\"xredirect\" value=\"${doc.URL}\"/&gt;\n-          &lt;input type=\"hidden\" name=\"title\" value=\"$className Template\"/&gt;\n+          &lt;input type=\"hidden\" name=\"parent\" value=\"$escapetool.xml(${doc.fullName})\"/&gt;\n+          &lt;input type=\"hidden\" name=\"xredirect\" value=\"$escapetool.xml(${doc.URL})\"/&gt;\n+          &lt;input type=\"hidden\" name=\"title\" value=\"$escapetool.xml($className) Template\"/&gt;\n           &lt;span class=\"buttonwrapper\"&gt;&lt;input type=\"submit\" class=\"button\" value=\"$escapetool.xml(\n             $services.localization.render('platform.xclass.defaultClassSheet.template.create'))\"/&gt;&lt;/span&gt;\n         &lt;/div&gt;\n@@ -324,25 +356,44 @@\n   #else\n     #if(!$classTemplateDoc.getObject(${doc.fullName}))\n       #set($xredirect = $xwiki.relativeRequestURL)\n-      #set($createUrl = $classTemplateDoc.getURL('objectadd', \"classname=${escapetool.url($doc.fullName)}&amp;amp;xredirect=${escapetool.url($xredirect)}&amp;amp;form_token=$!{services.csrf.getToken()}\"))\n+      #set($createUrl = $classTemplateDoc.getURL('objectadd', \"classname=${escapetool.url($doc.fullName)}&amp;xredirect=${escapetool.url($xredirect)}&amp;form_token=$!{services.csrf.getToken()}\"))\n       {{warning}}\n-        $services.localization.render('platform.xclass.defaultClassSheet.template.missingObject', [\"//$className//\"]) ##\n-        {{html}}&lt;a href=\"$createUrl\"&gt;$escapetool.xml($services.localization.render(\n-          'platform.xclass.defaultClassSheet.template.addObject', [$className])) \u00bb&lt;/a&gt;.{{/html}}\n+        #set ($message = $services.localization.render('platform.xclass.defaultClassSheet.template.missingObject', ['__CLASS_NAME__']))\n+        #set ($message = $escapetool.xml($message))\n+        {{html}}\n+          ## First escape the content of the translation, then replace the placeholders with content that would\n+          ## otherwise be escaped during the first escaping.\n+          $message.replace('__CLASS_NAME__', \"&lt;em&gt;$escapetool.xml($className)&lt;/em&gt;\")\n+          &lt;a href=\"$escapetool.xml($createUrl)\"&gt;##\n+            $escapetool.xml($services.localization.render('platform.xclass.defaultClassSheet.template.addObject', [$className])) \u00bb##\n+          &lt;/a&gt;.\n+        {{/html}}\n       {{/warning}}\n \n     #end\n     #set ($templatePath = \"#hierarchy($classTemplateDoc.documentReference, {'plain': true, 'local': true, 'limit': 4})\")\n-    [[$services.localization.render('platform.xclass.defaultClassSheet.template.view',\n-      [$templatePath.trim()]) \u00bb&gt;&gt;${classTemplateDoc.fullName}]]\n+    #set ($templateDocLink = \"$services.localization.render('platform.xclass.defaultClassSheet.template.view', [$templatePath.trim()]) \u00bb\")\n+    #set ($templateDocLink = $services.rendering.escape($templateDocLink, 'xwiki/2.1'))\n+    #set ($templateDocLink = $services.rendering.escape($templateDocLink, 'xwiki/2.1'))\n+    #set ($templateDocText = \"${classTemplateDoc.fullName}\")\n+    ## First escape the xwiki/2.1 syntax of the translation, then replace the placeholders with content that would\n+    ## otherwise be escaped during the first escaping.\n+    #set ($templateDocText = $services.rendering.escape($templateDocText, 'xwiki/2.1'))\n+    [[$templateDocLink&gt;&gt;$templateDocText]]\n   #end\n   ## Create a template provider only if a template for the current class exists.\n   #if ($classTemplateDoc.getObject(${doc.fullName}))\n     (% id=\"HClassTemplateProvider\" %)\n     = {{translation key=\"platform.xclass.defaultClassSheet.templateProvider.heading\"/}} =\n \n-      {{info}}$services.localization.render('platform.xclass.defaultClassSheet.templateProvider.description',\n-        ['//']){{/info}}\n+      {{info}}\n+        #set ($message = $services.localization.render('platform.xclass.defaultClassSheet.templateProvider.description', ['__EM__']))\n+        #set ($message = $services.rendering.escape($message, 'xwiki/2.1'))\n+        ## First escape the xwiki/2.1 syntax of the translation, then replace the placeholders with content that would\n+        ## otherwise be escaped during the first escaping.\n+        ## The replacement key is itself escaped, and it's escaped form needs to be used for the replacement.\n+        $message.replace('~_~_~E~M~_~_', '//')\n+      {{/info}}\n \n     #if (!$hasClassTemplateProvider)\n       #set ($templateProviderClassName = 'XWiki.TemplateProviderClass')\n@@ -362,21 +413,24 @@\n         \"${templateProviderClassName}_visibilityRestrictions\": $restrictionSpace}))\n       #set ($createUrl = $classTemplateProviderDoc.getURL('objectadd', $createUrlQueryString))\n       {{html}}\n-        &lt;form action=\"$classTemplateProviderDoc.getURL('save', 'editor=wiki')\" method=\"post\"&gt;\n+        &lt;form action=\"$escapetool.xml($classTemplateProviderDoc.getURL('save', 'editor=wiki'))\" method=\"post\"&gt;\n           &lt;div&gt;\n             &lt;input type=\"hidden\" name=\"form_token\" value=\"$!{services.csrf.getToken()}\" /&gt;\n-            &lt;input type=\"hidden\" name=\"parent\" value=\"${doc.fullName}\"/&gt;\n-            &lt;input type=\"hidden\" name=\"xredirect\" value=\"$createUrl\"/&gt;\n-            &lt;input type=\"hidden\" name=\"title\" value=\"$className Template Provider\"/&gt;\n+            &lt;input type=\"hidden\" name=\"parent\" value=\"$escapetool.xml(${doc.fullName})\"/&gt;\n+            &lt;input type=\"hidden\" name=\"xredirect\" value=\"$escapetool.xml($createUrl)\"/&gt;\n+            &lt;input type=\"hidden\" name=\"title\" value=\"$escapetool.xml($className) Template Provider\"/&gt;\n             &lt;span class=\"buttonwrapper\"&gt;&lt;input type=\"submit\" class=\"button\" value=\"$escapetool.xml(\n               $services.localization.render('platform.xclass.defaultClassSheet.templateProvider.create'))\"/&gt;&lt;/span&gt;\n           &lt;/div&gt;\n         &lt;/form&gt;\n       {{/html}}\n     #else\n       #set ($templateProviderPath = \"#hierarchy($classTemplateProviderDoc.documentReference, {'plain': true, 'local': true, 'limit': 4})\")\n-      [[$services.localization.render('platform.xclass.defaultClassSheet.templateProvider.view',\n-        [$templateProviderPath.trim()]) \u00bb&gt;&gt;${classTemplateProviderDoc.fullName}]]\n+      #set ($linkTarget = \"$services.localization.render('platform.xclass.defaultClassSheet.templateProvider.view', [$templateProviderPath.trim()]) \u00bb\")\n+      #set ($linkTarget = $services.rendering.escape($linkTarget, 'xwiki/2.1'))\n+      #set ($linkTarget = $services.rendering.escape($linkTarget, 'xwiki/2.1'))\n+      #set ($linkLabel = $services.rendering.escape(${classTemplateProviderDoc.fullName}, 'xwiki/2.1'))\n+      [[$linkTarget&gt;&gt;$linkLabel]]\n     #end\n   #end\n "
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-xclass/xwiki-platform-xclass-ui/src/test/java/org/xwiki/xclass/ClassSheetPageTest.java",
          "status": "added",
          "additions": 460,
          "deletions": 0,
          "patch": "@@ -0,0 +1,460 @@\n+/*\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+package org.xwiki.xclass;\n+\n+import java.util.HashMap;\n+\n+import javax.script.ScriptContext;\n+\n+import org.jsoup.Jsoup;\n+import org.jsoup.nodes.Document;\n+import org.jsoup.nodes.Element;\n+import org.jsoup.select.Elements;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.xwiki.icon.IconManager;\n+import org.xwiki.livedata.internal.macro.LiveDataMacroComponentList;\n+import org.xwiki.localization.macro.internal.TranslationMacro;\n+import org.xwiki.model.reference.DocumentReference;\n+import org.xwiki.model.script.ModelScriptService;\n+import org.xwiki.rendering.RenderingScriptServiceComponentList;\n+import org.xwiki.rendering.internal.configuration.DefaultRenderingConfigurationComponentList;\n+import org.xwiki.rendering.internal.macro.message.InfoMessageMacro;\n+import org.xwiki.rendering.internal.macro.message.WarningMessageMacro;\n+import org.xwiki.script.ScriptContextManager;\n+import org.xwiki.template.internal.macro.TemplateMacro;\n+import org.xwiki.template.script.TemplateScriptService;\n+import org.xwiki.test.annotation.ComponentList;\n+import org.xwiki.test.page.HTML50ComponentList;\n+import org.xwiki.test.page.PageTest;\n+import org.xwiki.test.page.TestNoScriptMacro;\n+import org.xwiki.test.page.XWikiSyntax20ComponentList;\n+import org.xwiki.test.page.XWikiSyntax21ComponentList;\n+import org.xwiki.velocity.tools.EscapeTool;\n+\n+import com.xpn.xwiki.XWikiException;\n+import com.xpn.xwiki.doc.XWikiDocument;\n+import com.xpn.xwiki.objects.BaseObject;\n+import com.xpn.xwiki.objects.classes.BaseClass;\n+import com.xpn.xwiki.plugin.skinx.SkinExtensionPluginApi;\n+import com.xpn.xwiki.script.sheet.SheetScriptService;\n+\n+import static javax.script.ScriptContext.GLOBAL_SCOPE;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+/**\n+ * Page Test of {@code XWiki.ClassSheet}.\n+ *\n+ * @version $Id$\n+ * @since 15.0RC1\n+ * @since 14.10.3\n+ * @since 14.4.8\n+ */\n+@HTML50ComponentList\n+@XWikiSyntax21ComponentList\n+@XWikiSyntax20ComponentList\n+@LiveDataMacroComponentList\n+@RenderingScriptServiceComponentList\n+@DefaultRenderingConfigurationComponentList\n+@ComponentList({\n+    TemplateMacro.class,\n+    TranslationMacro.class,\n+    WarningMessageMacro.class,\n+    InfoMessageMacro.class,\n+    TemplateScriptService.class,\n+    TestNoScriptMacro.class,\n+    ModelScriptService.class,\n+    SheetScriptService.class\n+})\n+class ClassSheetPageTest extends PageTest\n+{\n+    private static final DocumentReference CLASS_SHEET_BINDING_DOCUMENT_REFERENCE =\n+        new DocumentReference(\"xwiki\", \"XWiki\", \"ClassSheetBinding\");\n+\n+    private static final DocumentReference XWIKI_CLASS_SHEET = new DocumentReference(\"xwiki\", \"XWiki\", \"ClassSheet\");\n+\n+    private ScriptContext scriptContext;\n+\n+    @BeforeEach\n+    void setUp() throws Exception\n+    {\n+        // Spy the jsfx plugin used during the macro rendering to return a mock of its API when required. \n+        when(this.oldcore.getSpyXWiki().getPluginApi(\"jsfx\", this.context))\n+            .thenReturn(mock(SkinExtensionPluginApi.class));\n+\n+        // Return minimal icons metadata since this is not what we want to test in this test suite.\n+        IconManager iconManager = this.componentManager.registerMockComponent(IconManager.class);\n+        doReturn(new HashMap<>()).when(iconManager).getMetaData(anyString());\n+\n+        initializeClassSheetBinding();\n+\n+        this.scriptContext = this.oldcore.getMocker().<ScriptContextManager>getInstance(ScriptContextManager.class)\n+            .getCurrentScriptContext();\n+    }\n+\n+    @Test\n+    void notASheetNoProperties() throws Exception\n+    {\n+        XWikiDocument xwikiDocument =\n+            this.xwiki.getDocument(new DocumentReference(\"xwiki\", \"Space\", \"/}}{{/html}}{{noscript/}}\"), this.context);\n+        XWikiDocument doc = loadPage(XWIKI_CLASS_SHEET);\n+\n+        // Set up the current doc in the context so that $doc is bound in scripts\n+        this.context.setDoc(xwikiDocument);\n+\n+        Document document = render(doc);\n+\n+        Elements forms = document.select(\"form\");\n+\n+        Element warningMessage = document.selectFirst(\".warningmessage\");\n+        assertEquals(\"platform.xclass.defaultClassSheet.properties.empty [, ]\", warningMessage.text());\n+        assertEquals(\"/xwiki/bin/edit/Space/%2F%7D%7D%7B%7B%2Fhtml%7D%7D%7B%7Bnoscript%2F%7D%7D?editor=class\",\n+            warningMessage.selectFirst(\"a\").attr(\"href\"));\n+        Element classSheetForm = forms.get(0);\n+        assertEquals(\"Space./}}{{/html}}{{noscript/}}\", classSheetForm.selectFirst(\"[name='parent']\").val());\n+        assertEquals(\"/xwiki/bin/view/Space/%2F%7D%7D%7B%7B%2Fhtml%7D%7D%7B%7Bnoscript%2F%7D%7D\",\n+            classSheetForm.selectFirst(\"[name='xredirect']\").val());\n+        assertEquals(\"#if($doc.documentReference.name == '/}}{{/html}}{{noscript/}}Sheet')/}}{{/html}}\"\n+            + \"{{noscript/}} Sheet#{else}$services.display.title($doc, {'displayerHint': 'default', \"\n+            + \"'outputSyntaxId': 'plain/1.0'})#end\", classSheetForm.selectFirst(\"[name='title']\").val());\n+        Element classTemplateForm = forms.get(1);\n+        assertEquals(\"Space./}}{{/html}}{{noscript/}}\", classTemplateForm.selectFirst(\"[name='parent']\").val());\n+        assertEquals(\"/xwiki/bin/view/Space/%2F%7D%7D%7B%7B%2Fhtml%7D%7D%7B%7Bnoscript%2F%7D%7D\",\n+            classTemplateForm.selectFirst(\"[name='xredirect']\").val());\n+        assertEquals(\"/}}{{/html}}{{noscript/}} Template\", classTemplateForm.selectFirst(\"[name='title']\").val());\n+        Elements infomessages = document.select(\".infomessage\");\n+        Element infomessage1 = infomessages.get(0);\n+        assertEquals(\"platform.xclass.defaultClassSheet.sheets.description [, ]\", infomessage1.text());\n+        assertNotNull(infomessage1.selectFirst(\"em\"));\n+        Element infomessage2 = infomessages.get(1);\n+        assertEquals(\"platform.xclass.defaultClassSheet.template.description [, ]\", infomessage2.text());\n+        assertNotNull(infomessage2.selectFirst(\"em\"));\n+    }\n+\n+    @Test\n+    void notASheetHasProperties() throws Exception\n+    {\n+        XWikiDocument xwikiDocument =\n+            this.xwiki.getDocument(new DocumentReference(\"xwiki\", \"Space\", \"/}}{{/html}}{{noscript/}}\"), this.context);\n+        xwikiDocument.getXClass().addTextField(\"testField\", \"Test Field\", 10);\n+        XWikiDocument doc = loadPage(XWIKI_CLASS_SHEET);\n+\n+        // Set up the current doc in the context so that $doc is bound in scripts\n+        this.context.setDoc(xwikiDocument);\n+\n+        Document document = render(doc);\n+        Elements forms = document.select(\"form\");\n+\n+        Element ul = document.selectFirst(\"ul\");\n+        Elements lis = ul.select(\"li\");\n+        assertEquals(\"Test Field (testField: String)\", lis.get(0).text());\n+        assertEquals(\"platform.xclass.defaultClassSheet.properties.edit [, ]\", lis.get(1).text());\n+        assertEquals(\"/xwiki/bin/edit/Space/%2F%7D%7D%7B%7B%2Fhtml%7D%7D%7B%7Bnoscript%2F%7D%7D?editor=class\",\n+            lis.get(1).selectFirst(\"a\").attr(\"href\"));\n+        Element classSheetForm = forms.get(0);\n+        assertEquals(\"Space./}}{{/html}}{{noscript/}}\", classSheetForm.selectFirst(\"[name='parent']\").val());\n+        assertEquals(\"/xwiki/bin/view/Space/%2F%7D%7D%7B%7B%2Fhtml%7D%7D%7B%7Bnoscript%2F%7D%7D\",\n+            classSheetForm.selectFirst(\"[name='xredirect']\").val());\n+        assertEquals(\"#if($doc.documentReference.name == '/}}{{/html}}{{noscript/}}Sheet')/}}{{/html}}\"\n+            + \"{{noscript/}} Sheet#{else}$services.display.title($doc, {'displayerHint': 'default', \"\n+            + \"'outputSyntaxId': 'plain/1.0'})#end\", classSheetForm.selectFirst(\"[name='title']\").val());\n+        Element classTemplateForm = forms.get(1);\n+        assertEquals(\"Space./}}{{/html}}{{noscript/}}\", classTemplateForm.selectFirst(\"[name='parent']\").val());\n+        assertEquals(\"/xwiki/bin/view/Space/%2F%7D%7D%7B%7B%2Fhtml%7D%7D%7B%7Bnoscript%2F%7D%7D\",\n+            classTemplateForm.selectFirst(\"[name='xredirect']\").val());\n+        assertEquals(\"/}}{{/html}}{{noscript/}} Template\", classTemplateForm.selectFirst(\"[name='title']\").val());\n+    }\n+\n+    @Test\n+    void notASheetHasSheetAlreadyExists() throws Exception\n+    {\n+        String alreadyExistsPageName = \"AlreadyExists/}}{{noscript/}}\";\n+        XWikiDocument alreadyExistsDoc =\n+            this.xwiki.getDocument(new DocumentReference(\"xwiki\", \"Space\", alreadyExistsPageName), this.context);\n+        this.xwiki.saveDocument(alreadyExistsDoc, this.context);\n+\n+        XWikiDocument xwikiDocument =\n+            this.xwiki.getDocument(new DocumentReference(\"xwiki\", \"Space\", \"/}}{{/html}}{{noscript/}}\"), this.context);\n+        xwikiDocument.getXClass().addTextField(\"testField\", \"Test Field\", 10);\n+        BaseObject baseObject = xwikiDocument.newXObject(CLASS_SHEET_BINDING_DOCUMENT_REFERENCE, this.context);\n+        baseObject.set(\"sheet\", alreadyExistsPageName, this.context);\n+        this.xwiki.saveDocument(xwikiDocument, this.context);\n+        XWikiDocument doc = loadPage(XWIKI_CLASS_SHEET);\n+\n+        // Set up the current doc in the context so that $doc is bound in scripts\n+        this.context.setDoc(xwikiDocument);\n+\n+        Document document = render(doc);\n+\n+        Elements h1s = document.select(\"h1\");\n+        assertEquals(\"platform.xclass.defaultClassSheet.properties.heading\", h1s.get(0).text());\n+        assertEquals(\"platform.xclass.defaultClassSheet.pages.heading\", h1s.get(1).text());\n+\n+        Element ul = document.selectFirst(\"ul\");\n+        Elements lis = ul.select(\"li\");\n+        assertEquals(\"Test Field (testField: String)\", lis.get(0).text());\n+        assertEquals(\"platform.xclass.defaultClassSheet.properties.edit [, ]\", lis.get(1).text());\n+        assertEquals(\"/xwiki/bin/edit/Space/%2F%7D%7D%7B%7B%2Fhtml%7D%7D%7B%7Bnoscript%2F%7D%7D?editor=class\",\n+            lis.get(1).selectFirst(\"a\").attr(\"href\"));\n+        Element classSheetForm = document.selectFirst(\"form\");\n+        assertEquals(\"Space./}}{{/html}}{{noscript/}}\", classSheetForm.selectFirst(\"[name='parent']\").val());\n+        assertEquals(\"/xwiki/bin/view/Space/%2F%7D%7D%7B%7B%2Fhtml%7D%7D%7B%7Bnoscript%2F%7D%7D\",\n+            classSheetForm.selectFirst(\"[name='xredirect']\").val());\n+        assertEquals(\"/}}{{/html}}{{noscript/}} Template\", classSheetForm.selectFirst(\"[name='title']\").val());\n+\n+        assertEquals(String.format(\"platform.xclass.defaultClassSheet.sheets.view [Space / %s] \u00bb\",\n+                new EscapeTool().xml(alreadyExistsPageName)),\n+            document.selectFirst(String.format(\"[href='Space.%s']\", alreadyExistsPageName)).text());\n+    }\n+\n+    @Test\n+    void notASheetHasSheetAlreadyExistsClassTemplateExists() throws Exception\n+    {\n+        String alreadyExistsPageName = \"AlreadyExists/}}{{noscript/}}\";\n+        String pageName = \"/}}{{/html}}{{noscript/}}\";\n+        XWikiDocument alreadyExistsDoc =\n+            this.xwiki.getDocument(new DocumentReference(\"xwiki\", \"Space\", alreadyExistsPageName), this.context);\n+        this.xwiki.saveDocument(alreadyExistsDoc, this.context);\n+\n+        XWikiDocument alreadyExistsDocTemplate =\n+            this.xwiki.getDocument(new DocumentReference(\"xwiki\", \"Space\", pageName + \"Template\"), this.context);\n+        this.xwiki.saveDocument(alreadyExistsDocTemplate, this.context);\n+\n+        XWikiDocument xwikiDocument =\n+            this.xwiki.getDocument(new DocumentReference(\"xwiki\", \"Space\", pageName), this.context);\n+        xwikiDocument.getXClass().addTextField(\"testField\", \"Test Field\", 10);\n+        BaseObject baseObject = xwikiDocument.newXObject(CLASS_SHEET_BINDING_DOCUMENT_REFERENCE, this.context);\n+        baseObject.set(\"sheet\", alreadyExistsPageName, this.context);\n+        this.xwiki.saveDocument(xwikiDocument, this.context);\n+        XWikiDocument doc = loadPage(XWIKI_CLASS_SHEET);\n+\n+        // Set up the current doc in the context so that $doc is bound in scripts\n+        this.context.setDoc(xwikiDocument);\n+\n+        Document document = render(doc);\n+\n+        Elements h1s = document.select(\"h1\");\n+        assertEquals(\"platform.xclass.defaultClassSheet.properties.heading\", h1s.get(0).text());\n+        assertEquals(\"platform.xclass.defaultClassSheet.createPage.heading\", h1s.get(1).text());\n+\n+        Element ul = document.selectFirst(\"ul\");\n+        Elements lis = ul.select(\"li\");\n+        assertEquals(\"Test Field (testField: String)\", lis.get(0).text());\n+        assertEquals(String.format(\"%s [, ]\", \"platform.xclass.defaultClassSheet.properties.edit\"), lis.get(1).text());\n+        assertEquals(\"/xwiki/bin/edit/Space/%2F%7D%7D%7B%7B%2Fhtml%7D%7D%7B%7Bnoscript%2F%7D%7D?editor=class\",\n+            lis.get(1).selectFirst(\"a\").attr(\"href\"));\n+        Element classSheetForm = document.selectFirst(\"form\");\n+        assertEquals(\"Space./}}{{/html}}{{noscript/}}\", classSheetForm.selectFirst(\"[name='parent']\").val());\n+        assertEquals(\"Space./}}{{/html}}{{noscript/}}Template\", classSheetForm.selectFirst(\"[name='template']\").val());\n+        assertEquals(\"1\", classSheetForm.selectFirst(\"[name='sheet']\").val());\n+\n+        assertEquals(String.format(\"platform.xclass.defaultClassSheet.sheets.view [Space / %s] \u00bb\",\n+                new EscapeTool().xml(alreadyExistsPageName)),\n+            document.selectFirst(String.format(\"[href='Space.%s']\", alreadyExistsPageName)).text());\n+    }\n+\n+    @Test\n+    void hasClassSheetsAndHasClassTemplate() throws Exception\n+    {\n+        String pageName = \"Page\";\n+        String sheetPage = \"MySheet\";\n+        DocumentReference mainPageReference = new DocumentReference(\"xwiki\", \"Space\", pageName);\n+        XWikiDocument xwikiDocument = this.xwiki.getDocument(mainPageReference, this.context);\n+        xwikiDocument.getXClass().addTextField(\"testField\", \"Test Field\", 10);\n+        BaseObject classSheetBindingObject =\n+            xwikiDocument.newXObject(CLASS_SHEET_BINDING_DOCUMENT_REFERENCE, this.context);\n+        classSheetBindingObject.set(\"sheet\", sheetPage, this.context);\n+\n+        this.xwiki.saveDocument(xwikiDocument, this.context);\n+        XWikiDocument doc = loadPage(XWIKI_CLASS_SHEET);\n+\n+        // Class Template Creation.\n+        XWikiDocument templateProvider = this.xwiki.getDocument(\n+            new DocumentReference(pageName + \"Template\", mainPageReference.getLastSpaceReference()),\n+            this.context);\n+        this.xwiki.saveDocument(templateProvider, this.context);\n+\n+        // Class docRef\n+        XWikiDocument docRef = this.xwiki.getDocument(\n+            new DocumentReference(\"DOC_NAME\", mainPageReference.getLastSpaceReference()),\n+            this.context);\n+        this.xwiki.saveDocument(docRef, this.context);\n+\n+        this.request.put(\"docName\", \"DOC_NAME\");\n+\n+        // Set up the current doc in the context so that $doc is bound in scripts\n+        this.context.setDoc(xwikiDocument);\n+\n+        Document document = render(doc);\n+\n+        Elements warnings = document.select(\".warningmessage\");\n+        Element warning1 = warnings.get(0);\n+        assertEquals(\"platform.xclass.defaultClassSheet.createPage.pageAlreadyExists [, ]\", warning1.text());\n+        assertEquals(\"/xwiki/bin/view/Space/DOC_NAME\", warning1.selectFirst(\"a\").attr(\"href\"));\n+        Element warning2 = warnings.get(1);\n+        assertEquals(\"platform.xclass.defaultClassSheet.template.missingObject [Page] \"\n+            + \"platform.xclass.defaultClassSheet.template.addObject [Page] \u00bb.\", warning2.text());\n+        assertEquals(\"/xwiki/bin/objectadd/Space/PageTemplate\"\n+                + \"?classname=Space.Page&xredirect=%2Fxwiki%2Fbin%2FMain%2FWebHome&form_token=\",\n+            warning2.selectFirst(\"a\").attr(\"href\"));\n+    }\n+\n+    @Test\n+    void hasEditAndDefaultClassSheetReference() throws Exception\n+    {\n+        this.scriptContext.setAttribute(\"hasEdit\", true, GLOBAL_SCOPE);\n+\n+        String pageName = \"Page\";\n+        DocumentReference mainPageReference = new DocumentReference(\"xwiki\", \"Space\", pageName);\n+        XWikiDocument xwikiDocument = this.xwiki.getDocument(mainPageReference, this.context);\n+        xwikiDocument.getXClass().addTextField(\"testField\", \"Test Field\", 10);\n+        this.xwiki.saveDocument(xwikiDocument, this.context);\n+\n+        // Create defaultClassSheetReference\n+        XWikiDocument defaultClassSheet =\n+            this.xwiki.getDocument(new DocumentReference(\"xwiki\", \"Space\", \"PageSheet\"), this.context);\n+        this.xwiki.saveDocument(defaultClassSheet, this.context);\n+\n+        XWikiDocument doc = loadPage(XWIKI_CLASS_SHEET);\n+\n+        this.request.put(\"docName\", \"DOC_NAME\");\n+\n+        // Set up the current doc in the context so that $doc is bound in scripts\n+        this.context.setDoc(xwikiDocument);\n+\n+        Document document = render(doc);\n+\n+        Element warning = document.selectFirst(\".warningmessage\");\n+        assertEquals(\"platform.xclass.defaultClassSheet.sheets.notBound \"\n+            + \"platform.xclass.defaultClassSheet.sheets.bind \u00bb.\", warning.text());\n+        assertEquals(\"/xwiki/bin/view/Space/Page?bindSheet=xwiki%3ASpace.PageSheet\"\n+            + \"&xredirect=%2Fxwiki%2Fbin%2FMain%2FWebHome&form_token=\", warning.selectFirst(\"a\").attr(\"href\"));\n+    }\n+\n+    @Test\n+    void hasEditAndDefaultClassSheetReferenceTemplateHasDoc() throws Exception\n+    {\n+        this.scriptContext.setAttribute(\"hasEdit\", true, GLOBAL_SCOPE);\n+\n+        String pageName = \"Page\";\n+        DocumentReference mainPageReference = new DocumentReference(\"xwiki\", \"Space\", pageName);\n+        XWikiDocument xwikiDocument = this.xwiki.getDocument(mainPageReference, this.context);\n+        xwikiDocument.getXClass().addTextField(\"testField\", \"Test Field\", 10);\n+        this.xwiki.saveDocument(xwikiDocument, this.context);\n+\n+        // Create defaultClassSheetReference\n+        XWikiDocument defaultClassSheet =\n+            this.xwiki.getDocument(new DocumentReference(\"xwiki\", \"Space\", \"PageSheet\"), this.context);\n+        this.xwiki.saveDocument(defaultClassSheet, this.context);\n+\n+        XWikiDocument pageTemplate =\n+            this.xwiki.getDocument(new DocumentReference(\"xwiki\", \"Space\", \"PageTemplate\"), this.context);\n+        pageTemplate.newXObject(mainPageReference, this.context);\n+        this.xwiki.saveDocument(pageTemplate, this.context);\n+\n+        XWikiDocument doc = loadPage(XWIKI_CLASS_SHEET);\n+\n+        this.request.put(\"docName\", \"DOC_NAME\");\n+\n+        // Set up the current doc in the context so that $doc is bound in scripts\n+        this.context.setDoc(xwikiDocument);\n+\n+        Document document = render(doc);\n+\n+        Elements infomessages = document.select(\".infomessage\");\n+        assertEquals(\"platform.xclass.defaultClassSheet.sheets.description [, ]\", infomessages.get(0).text());\n+        assertEquals(\"platform.xclass.defaultClassSheet.template.description [, ]\", infomessages.get(1).text());\n+        assertEquals(\"platform.xclass.defaultClassSheet.templateProvider.description []\", infomessages.get(2).text());\n+        assertNotNull(infomessages.get(2).selectFirst(\"em\"));\n+    }\n+\n+    @Test\n+    void hasEditAndDefaultClassSheetReferenceTemplateHasDocHasClassTemplateProvider() throws Exception\n+    {\n+        this.scriptContext.setAttribute(\"hasEdit\", true, GLOBAL_SCOPE);\n+\n+        DocumentReference mainPageReference = new DocumentReference(\"xwiki\", \"Space\", \"Page\");\n+        XWikiDocument xwikiDocument = this.xwiki.getDocument(mainPageReference, this.context);\n+        xwikiDocument.getXClass().addTextField(\"testField\", \"Test Field\", 10);\n+        this.xwiki.saveDocument(xwikiDocument, this.context);\n+\n+        // Create defaultClassSheetReference\n+        XWikiDocument defaultClassSheet =\n+            this.xwiki.getDocument(new DocumentReference(\"xwiki\", \"Space\", \"PageSheet\"), this.context);\n+        this.xwiki.saveDocument(defaultClassSheet, this.context);\n+\n+        XWikiDocument pageTemplate =\n+            this.xwiki.getDocument(new DocumentReference(\"xwiki\", \"Space\", \"PageTemplate\"), this.context);\n+        pageTemplate.newXObject(mainPageReference, this.context);\n+        this.xwiki.saveDocument(pageTemplate, this.context);\n+\n+        XWikiDocument pageTemplateProvider =\n+            this.xwiki.getDocument(new DocumentReference(\"xwiki\", \"Space\", \"PageTemplateProvider\"), this.context);\n+        this.xwiki.saveDocument(pageTemplateProvider, this.context);\n+\n+        XWikiDocument doc = loadPage(XWIKI_CLASS_SHEET);\n+\n+        this.request.put(\"docName\", \"DOC_NAME\");\n+\n+        // Set up the current doc in the context so that $doc is bound in scripts\n+        this.context.setDoc(xwikiDocument);\n+\n+        Document document = render(doc);\n+\n+        Elements infomessages = document.select(\".infomessage\");\n+        assertEquals(\"platform.xclass.defaultClassSheet.sheets.description [, ]\", infomessages.get(0).text());\n+        assertEquals(\"platform.xclass.defaultClassSheet.template.description [, ]\", infomessages.get(1).text());\n+        assertEquals(\"platform.xclass.defaultClassSheet.templateProvider.description []\", infomessages.get(2).text());\n+        assertNotNull(infomessages.get(2).selectFirst(\"em\"));\n+        Elements links = document.select(\"a\");\n+        Element lastLink = links.get(links.size() - 1);\n+        assertEquals(\"platform.xclass.defaultClassSheet.templateProvider.view [Space / PageTemplateProvider] \u00bb\",\n+            lastLink.text());\n+        assertEquals(\"Space.PageTemplateProvider\", lastLink.attr(\"href\"));\n+    }\n+\n+    private Document render(XWikiDocument doc) throws XWikiException\n+    {\n+        return Jsoup.parse(doc.getRenderedContent(this.context));\n+    }\n+\n+    /**\n+     * TODO: Create the class because it is required but we currently do not support loading documents from other\n+     * modules. An option would be to move ClassSheetBinding to a mandatory document initializer.\n+     */\n+    private void initializeClassSheetBinding() throws Exception\n+    {\n+        XWikiDocument document = this.xwiki.getDocument(CLASS_SHEET_BINDING_DOCUMENT_REFERENCE, this.context);\n+\n+        if (!document.isNew()) {\n+            return;\n+        }\n+\n+        BaseClass xClass = document.getXClass();\n+        xClass.addPageField(\"sheet\", \"Sheet\", 30, false, false, \"\");\n+\n+        this.xwiki.saveDocument(document, this.context);\n+    }\n+}"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 4,
        "max_directory_depth": 9
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "88e3e7d23cbd3e6ed059dbcd6532f94016d42678",
            "date": "2025-01-13T16:58:06Z",
            "author_login": "Sereza7"
          },
          {
            "sha": "9b506ab2bed52744b52699ea05cde15986d42abb",
            "date": "2025-01-13T16:36:24Z",
            "author_login": "mflorea"
          },
          {
            "sha": "d53d6e347b97ac20f60e21fb2bae381f4aaf10f4",
            "date": "2025-01-13T13:25:24Z",
            "author_login": "tmortagne"
          },
          {
            "sha": "d85bd8f9c67c412e0cfb45fb4695b8d4e759bab6",
            "date": "2025-01-13T12:03:22Z",
            "author_login": "tmortagne"
          },
          {
            "sha": "6f210dabc99167cf9f020a048c88325eca34ceea",
            "date": "2025-01-13T08:54:32Z",
            "author_login": "tmortagne"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 9.9,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:L",
    "cwe_id": "CWE-74",
    "description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. Any user with view rights can execute arbitrary script macros including Groovy and Python macros that allow remote code execution including unrestricted read and write access to all wiki contents. The attack works by opening a non-existing page with a name crafted to contain a dangerous payload. This issue has been patched in XWiki 14.4.8, 14.10.3 and 15.0RC1. Users are advised to upgrade. There are no known workarounds for this vulnerability.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-04-19T00:15:08.897",
    "last_modified": "2024-11-21T07:57:13.580",
    "fix_date": "2023-01-03T16:37:10Z"
  },
  "references": [
    {
      "url": "https://github.com/xwiki/xwiki-platform/commit/d7e56185376641ee5d66477c6b2791ca8e85cfee",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/security/advisories/GHSA-mjw9-3f9f-jq2w",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://jira.xwiki.org/browse/XWIKI-20456",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/commit/d7e56185376641ee5d66477c6b2791ca8e85cfee",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/security/advisories/GHSA-mjw9-3f9f-jq2w",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://jira.xwiki.org/browse/XWIKI-20456",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Patch",
        "Vendor Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:05:11.811956",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "xwiki-platform",
    "owner": "xwiki",
    "created_at": "2011-03-10T13:26:41Z",
    "updated_at": "2025-01-13T16:58:10Z",
    "pushed_at": "2025-01-14T12:32:03Z",
    "size": 561595,
    "stars": 1030,
    "forks": 554,
    "open_issues": 136,
    "watchers": 1030,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "Java": 34276921,
      "JavaScript": 2392892,
      "HTML": 388086,
      "Less": 318945,
      "AspectJ": 280487,
      "Vue": 222987,
      "CSS": 115460,
      "XSLT": 109285,
      "Clean": 44054,
      "Shell": 32569,
      "Batchfile": 14604,
      "Python": 5046,
      "Groovy": 3012,
      "AMPL": 1296
    },
    "commit_activity": {
      "total_commits_last_year": 1723,
      "avg_commits_per_week": 33.13461538461539,
      "days_active_last_year": 263
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "lgpl-2.1"
    },
    "collected_at": "2025-01-14T12:58:58.685838"
  }
}