{
  "cve_id": "CVE-2023-29523",
  "github_data": {
    "repository": "xwiki/xwiki-platform",
    "fix_commit": "0d547181389f7941e53291af940966413823f61c",
    "related_commits": [
      "0d547181389f7941e53291af940966413823f61c",
      "0d547181389f7941e53291af940966413823f61c"
    ],
    "patch_url": "https://github.com/xwiki/xwiki-platform/commit/0d547181389f7941e53291af940966413823f61c.patch",
    "fix_commit_details": {
      "sha": "0d547181389f7941e53291af940966413823f61c",
      "commit_date": "2022-12-01T17:06:56Z",
      "author": {
        "login": "michitux",
        "type": "User",
        "stats": {
          "total_commits": 378,
          "average_weekly_commits": 0.39622641509433965,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 108
        }
      },
      "commit_message": {
        "title": "XWIKI-20327: Escape closing HTML macro in XWikiDocument#display",
        "length": 63,
        "has_description": false,
        "references_issue": true
      },
      "stats": {
        "total": 44,
        "additions": 41,
        "deletions": 3
      },
      "files": [
        {
          "filename": "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/doc/XWikiDocument.java",
          "status": "modified",
          "additions": 14,
          "deletions": 3,
          "patch": "@@ -220,6 +220,8 @@ public class XWikiDocument implements DocumentModelBridge, Cloneable\n \n     private static final String TM_FAILEDDOCUMENTPARSE = \"core.document.error.failedParse\";\n \n+    private static final String CLOSE_HTML_MACRO = \"{{/html}}\";\n+\n     /**\n      * An attachment waiting to be deleted at next document save.\n      *\n@@ -3885,10 +3887,19 @@ public String display(String fieldname, String type, String pref, BaseObject obj\n             // We test if we're inside the rendering engine since it's also possible that this display() method is\n             // called directly from a template and in this case we only want HTML as a result and not wiki syntax.\n             // TODO: find a more generic way to handle html macro because this works only for XWiki 1.0 and XWiki 2.0\n-            // Add the {{html}}{{/html}} only when result really contains html since it's not needed for pure text\n-            if (isInRenderingEngine && !is10Syntax(wrappingSyntaxId) && HTMLUtils.containsElementText(result)) {\n+            // Add the {{html}}{{/html}} only when result really contains html or { which could be part of an XWiki\n+            // macro syntax since it's not needed for pure text\n+            if (isInRenderingEngine && !is10Syntax(wrappingSyntaxId)\n+                && (HTMLUtils.containsElementText(result) || result.indexOf(\"{\") != -1))\n+            {\n                 result.insert(0, \"{{html clean=\\\"false\\\" wiki=\\\"false\\\"}}\");\n-                result.append(\"{{/html}}\");\n+                // Escape closing HTML macro syntax.\n+                int startIndex = 0;\n+                // Start searching at the last match to avoid scanning the whole string again.\n+                while ((startIndex = result.indexOf(CLOSE_HTML_MACRO, startIndex)) != -1) {\n+                    result.replace(startIndex, startIndex + 2, \"&#123;&#123;\");\n+                }\n+                result.append(CLOSE_HTML_MACRO);\n             }\n \n             return result.toString();"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/doc/XWikiDocumentTest.java",
          "status": "modified",
          "additions": 27,
          "deletions": 0,
          "patch": "@@ -59,6 +59,7 @@\n import com.xpn.xwiki.api.DocumentSection;\n import com.xpn.xwiki.objects.BaseObject;\n import com.xpn.xwiki.objects.classes.BaseClass;\n+import com.xpn.xwiki.objects.classes.PropertyClass;\n import com.xpn.xwiki.objects.classes.TextAreaClass;\n import com.xpn.xwiki.store.XWikiStoreInterface;\n import com.xpn.xwiki.store.XWikiVersioningStoreInterface;\n@@ -76,10 +77,12 @@\n import static org.junit.jupiter.api.Assertions.assertSame;\n import static org.junit.jupiter.api.Assertions.assertTrue;\n import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyBoolean;\n import static org.mockito.ArgumentMatchers.anyInt;\n import static org.mockito.ArgumentMatchers.anyString;\n import static org.mockito.ArgumentMatchers.argThat;\n import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.doAnswer;\n import static org.mockito.Mockito.doReturn;\n import static org.mockito.Mockito.mock;\n import static org.mockito.Mockito.verify;\n@@ -647,6 +650,30 @@ public void displayTemplate20()\n         assertEquals(\"<p>area</p>\", this.document.display(\"area\", \"view\", this.oldcore.getXWikiContext()));\n     }\n \n+    @Test\n+    void displayEscapesClosingHTMLMacro()\n+    {\n+        this.oldcore.getXWikiContext().put(\"isInRenderingEngine\", true);\n+        when(this.xWiki.getCurrentContentSyntaxId(any())).thenReturn(\"xwiki/2.1\");\n+        this.document.setSyntax(Syntax.XWIKI_2_0);\n+\n+        BaseObject object = mock(BaseObject.class);\n+        when(object.getOwnerDocument()).thenReturn(this.document);\n+\n+        BaseClass xClass = mock(BaseClass.class);\n+        when(object.getXClass(any())).thenReturn(xClass);\n+        PropertyClass propertyInterface = mock(PropertyClass.class);\n+        when(xClass.get(\"mock\")).thenReturn(propertyInterface);\n+        doAnswer(call -> {\n+            call.getArgument(0, StringBuffer.class).append(\"{{/html}}content{{/html}}\");\n+            return null;\n+        }).when(propertyInterface).displayView(any(StringBuffer.class), eq(\"mock\"), any(String.class), eq(object),\n+            anyBoolean(), any(XWikiContext.class));\n+\n+        assertEquals(\"{{html clean=\\\"false\\\" wiki=\\\"false\\\"}}&#123;&#123;/html}}content&#123;&#123;/html}}{{/html}}\",\n+            this.document.display(\"mock\", \"view\", object, this.oldcore.getXWikiContext()));\n+    }\n+\n     @Test\n     public void convertSyntax() throws XWikiException\n     {"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 2,
        "max_directory_depth": 9
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "88e3e7d23cbd3e6ed059dbcd6532f94016d42678",
            "date": "2025-01-13T16:58:06Z",
            "author_login": "Sereza7"
          },
          {
            "sha": "9b506ab2bed52744b52699ea05cde15986d42abb",
            "date": "2025-01-13T16:36:24Z",
            "author_login": "mflorea"
          },
          {
            "sha": "d53d6e347b97ac20f60e21fb2bae381f4aaf10f4",
            "date": "2025-01-13T13:25:24Z",
            "author_login": "tmortagne"
          },
          {
            "sha": "d85bd8f9c67c412e0cfb45fb4695b8d4e759bab6",
            "date": "2025-01-13T12:03:22Z",
            "author_login": "tmortagne"
          },
          {
            "sha": "6f210dabc99167cf9f020a048c88325eca34ceea",
            "date": "2025-01-13T08:54:32Z",
            "author_login": "tmortagne"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 9.9,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H",
    "cwe_id": "CWE-74",
    "description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. Any user who can edit their own user profile can execute arbitrary script macros including Groovy and Python macros that allow remote code execution including unrestricted read and write access to all wiki contents. The same vulnerability can also be exploited in other contexts where the `display` method on a document is used to display a field with wiki syntax, for example in applications created using `App Within Minutes`. This has been patched in XWiki 13.10.11, 14.4.8, 14.10.2 and 15.0RC1. There is no workaround apart from upgrading.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-04-19T00:15:08.987",
    "last_modified": "2024-11-21T07:57:13.700",
    "fix_date": "2022-12-01T17:06:56Z"
  },
  "references": [
    {
      "url": "https://extensions.xwiki.org/xwiki/bin/view/Extension/App%20Within%20Minutes%20Application",
      "source": "security-advisories@github.com",
      "tags": [
        "Product"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/commit/0d547181389f7941e53291af940966413823f61c",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/security/advisories/GHSA-x764-ff8r-9hpx",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://jira.xwiki.org/browse/XWIKI-20327",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://extensions.xwiki.org/xwiki/bin/view/Extension/App%20Within%20Minutes%20Application",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Product"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/commit/0d547181389f7941e53291af940966413823f61c",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/security/advisories/GHSA-x764-ff8r-9hpx",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://jira.xwiki.org/browse/XWIKI-20327",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Patch",
        "Vendor Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:05:11.812114",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "xwiki-platform",
    "owner": "xwiki",
    "created_at": "2011-03-10T13:26:41Z",
    "updated_at": "2025-01-13T16:58:10Z",
    "pushed_at": "2025-01-14T12:32:03Z",
    "size": 561595,
    "stars": 1030,
    "forks": 554,
    "open_issues": 136,
    "watchers": 1030,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "Java": 34276921,
      "JavaScript": 2392892,
      "HTML": 388086,
      "Less": 318945,
      "AspectJ": 280487,
      "Vue": 222987,
      "CSS": 115460,
      "XSLT": 109285,
      "Clean": 44054,
      "Shell": 32569,
      "Batchfile": 14604,
      "Python": 5046,
      "Groovy": 3012,
      "AMPL": 1296
    },
    "commit_activity": {
      "total_commits_last_year": 1723,
      "avg_commits_per_week": 33.13461538461539,
      "days_active_last_year": 263
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "lgpl-2.1"
    },
    "collected_at": "2025-01-14T12:58:58.685838"
  }
}