{
  "cve_id": "CVE-2023-3095",
  "github_data": {
    "repository": "nilsteampassnet/teampass",
    "fix_commit": "774985f62f080715774604927fba2cb6ef701612",
    "related_commits": [
      "774985f62f080715774604927fba2cb6ef701612",
      "774985f62f080715774604927fba2cb6ef701612"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "774985f62f080715774604927fba2cb6ef701612",
      "commit_date": "2023-06-04T09:20:08Z",
      "author": {
        "login": "nilsteampassnet",
        "type": "User",
        "stats": {
          "total_commits": 2012,
          "average_weekly_commits": 2.9415204678362574,
          "total_additions": 5301385,
          "total_deletions": 4813706,
          "weeks_active": 411
        }
      },
      "commit_message": {
        "title": "3.0.9",
        "length": 47,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 1532,
        "additions": 1329,
        "deletions": 203
      },
      "files": [
        {
          "filename": "install/install.php",
          "status": "modified",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "install/install.queries.php",
          "status": "modified",
          "additions": 2,
          "deletions": 1,
          "patch": "@@ -430,8 +430,9 @@ function encryptFollowingDefuse($message, $ascii_key)\n                             `auto_update_pwd_next_date` varchar(100) NOT null DEFAULT '0',\n                             `encryption_type` VARCHAR(20) NOT NULL DEFAULT 'not_set',\n                             `fa_icon` varchar(100) DEFAULT NULL,\n+                            `item_key` varchar(500) NOT NULL DEFAULT '1',\n                             PRIMARY KEY (`id`),\n-                            KEY    `restricted_inactif_idx` (`restricted_to`,`inactif`)\n+                            KEY `restricted_inactif_idx` (`restricted_to`,`inactif`)\n                             ) CHARSET=utf8;\"\n                         );\n                     } elseif ($task === 'log_items') {"
        },
        {
          "filename": "install/tp.functions.php",
          "status": "modified",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "install/upgrade.php",
          "status": "modified",
          "additions": 8,
          "deletions": 2,
          "patch": "@@ -1090,11 +1090,17 @@ function(data) {\n function runUpdate (script_file, type_parameter, start_at, noitems_by_loop, loop_number, file_number)\n {\n     var d = new Date(),\n-        info = '';\n+        info = '',\n+        text_action_in_progress = script_file;\n     loop_number ++;\n     var rand_number = createRandomId();\n \n-    $(\"#step4_progress\").html(\"<div>\" + getTime() +\" - <i>\"+script_file+\"</i> - Loop #\"+loop_number+\" <span id='span_\"+rand_number+\"'>is now running ... <i class=\\\"fas fa-cog fa-spin\\\" style=\\\"color:orange\\\"></i></span></div>\"+ $(\"#step4_progress\").html());\n+    // Inform\n+    if (script_file === 'upgrade_operations.php') {\n+        text_action_in_progress = 'Performing operation ' + type_parameter;\n+    }\n+\n+    $(\"#step4_progress\").html(\"<div>\" + getTime() +\" - <i>\"+text_action_in_progress+\"</i> - Loop #\"+loop_number+\" <span id='span_\"+rand_number+\"'>is now running ... <i class=\\\"fas fa-cog fa-spin\\\" style=\\\"color:orange\\\"></i></span></div>\"+ $(\"#step4_progress\").html());\n \n     if (type_parameter === 'user_id') {\n         info = $(\"#infotmp\").val();"
        },
        {
          "filename": "install/upgrade_ajax.php",
          "status": "modified",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "install/upgrade_operations.php",
          "status": "added",
          "additions": 141,
          "deletions": 0,
          "patch": "@@ -0,0 +1,141 @@\n+<?php\n+/**\n+ * Teampass - a collaborative passwords manager.\n+ * ---\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n+ * ---\n+ * @project   Teampass\n+ * @file      upgrade_operations.php\n+ * ---\n+ * @author    Nils Laumaill\u00e9 (nils@teampass.net)\n+ * @copyright 2009-2023 Teampass.net\n+ * @license   https://spdx.org/licenses/GPL-3.0-only.html#licenseText GPL-3.0\n+ * ---\n+ * @see       https://www.teampass.net\n+ */\n+\n+set_time_limit(600);\n+\n+\n+require_once '../sources/SecureHandler.php';\n+session_name('teampass_session');\n+session_start();\n+error_reporting(E_ERROR | E_PARSE);\n+$_SESSION['CPM'] = 1;\n+\n+//include librairies\n+require_once '../includes/language/english.php';\n+require_once '../includes/config/include.php';\n+require_once '../includes/config/settings.php';\n+require_once '../sources/main.functions.php';\n+require_once '../includes/libraries/Tree/NestedTree/NestedTree.php';\n+require_once 'tp.functions.php';\n+require_once 'libs/aesctr.php';\n+require_once '../includes/config/tp.config.php';\n+\n+// Prepare POST variables\n+$post_nb = filter_input(INPUT_POST, 'nb', FILTER_SANITIZE_NUMBER_INT);\n+$post_start = filter_input(INPUT_POST, 'start', FILTER_SANITIZE_NUMBER_INT);\n+\n+// Load libraries\n+require_once '../includes/libraries/protect/SuperGlobal/SuperGlobal.php';\n+$superGlobal = new protect\\SuperGlobal\\SuperGlobal();\n+\n+// Some init\n+$_SESSION['settings']['loaded'] = '';\n+$finish = true;\n+\n+// Get the encrypted password\n+define('DB_PASSWD_CLEAR', defuse_return_decrypted(DB_PASSWD));\n+\n+// DataBase\n+// Test DB connexion\n+$pass = DB_PASSWD_CLEAR;\n+$server = DB_HOST;\n+$pre = DB_PREFIX;\n+$database = DB_NAME;\n+$port = DB_PORT;\n+$user = DB_USER;\n+\n+if (mysqli_connect(\n+    $server,\n+    $user,\n+    $pass,\n+    $database,\n+    $port\n+)) {\n+    $db_link = mysqli_connect(\n+        $server,\n+        $user,\n+        $pass,\n+        $database,\n+        $port\n+    );\n+} else {\n+    $res = 'Impossible to get connected to server. Error is: ' . addslashes(mysqli_connect_error());\n+    echo '[{\"finish\":\"1\", \"msg\":\"\", \"error\":\"Impossible to get connected to server. Error is: ' . addslashes(mysqli_connect_error()) . '!\"}]';\n+    mysqli_close($db_link);\n+    exit();\n+}\n+\n+// Load libraries\n+require_once '../includes/libraries/protect/SuperGlobal/SuperGlobal.php';\n+$superGlobal = new protect\\SuperGlobal\\SuperGlobal();\n+\n+// Get POST with operation to perform\n+$post_operation = filter_input(INPUT_POST, 'type', FILTER_SANITIZE_FULL_SPECIAL_CHARS);\n+if (isset($post_operation) === true && empty($post_operation) === false) {\n+    // ---->\n+    // OPERATION - 20230604_1 - generate key for item_key\n+\n+    // Get items to treat\n+    $rows = mysqli_query(\n+        $db_link,\n+        \"SELECT id FROM \".$pre.\"items\n+        WHERE item_key = '-1'\n+        ORDER BY id\n+        LIMIT \".$post_nb.\";\"\n+    );\n+    // Handle error on query\n+    if (!$rows) {\n+        echo '[{\"finish\":\"1\" , \"error\":\"'.mysqli_error($db_link).'\"}]';\n+        exit();\n+    }\n+\n+    // Get total of items to treat\n+    $total = mysqli_num_rows($rows);\n+\n+    // Loop on items and update for requested ones\n+    if ((int) $total > 0) {\n+        while ($row = mysqli_fetch_array($rows, MYSQLI_ASSOC)) {\n+            // Gererate a key and update\n+            mysqli_query(\n+                $db_link,\n+                \"UPDATE `\".$pre.\"items`\n+                SET `item_key` = '\".uniqidReal(50).\"'\n+                WHERE `id` = \".$row['id'].\";\"\n+            );\n+            if (mysqli_error($db_link)) {\n+                echo '[{\"finish\":\"1\", \"next\":\"\", \"error\":\"MySQL Error! '.addslashes(mysqli_error($db_link)).'\"}]';\n+                exit();\n+            }\n+        }\n+    }\n+\n+    // Manage end of operation\n+    if ($total === 0) {\n+        $finish = 1;\n+    } else {\n+        $finish = 0;\n+    }\n+    // ----<\n+}\n+\n+// Close connection\n+mysqli_close($db_link);\n+\n+\n+// Return back\n+echo '[{\"finish\":\"'.$finish.'\" , \"next\":\"\", \"error\":\"\", \"total\":\"'.$total.'\"}]';\n\\ No newline at end of file"
        },
        {
          "filename": "install/upgrade_run_3.0.0.php",
          "status": "modified",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "install/upgrade_run_3.0.php",
          "status": "modified",
          "additions": 1168,
          "deletions": 194,
          "patch": "@@ -7,7 +7,7 @@\n  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n  * ---\n  * @project   Teampass\n- * @file      upgrade_run_3.0.php\n+ * @file      upgrade.php\n  * ---\n  * @author    Nils Laumaill\u00e9 (nils@teampass.net)\n  * @copyright 2009-2023 Teampass.net\n@@ -16,250 +16,1224 @@\n  * @see       https://www.teampass.net\n  */\n \n-set_time_limit(600);\n \n+header('X-XSS-Protection: 1; mode=block');\n+header('X-Frame-Options: SameOrigin');\n+\n+// **PREVENTING SESSION HIJACKING**\n+// Prevents javascript XSS attacks aimed to steal the session ID\n+ini_set('session.cookie_httponly', 1);\n+\n+// **PREVENTING SESSION FIXATION**\n+// Session ID cannot be passed through URLs\n+ini_set('session.use_only_cookies', 1);\n+\n+// Uses a secure connection (HTTPS) if possible\n+ini_set('session.cookie_secure', 0);\n \n require_once '../sources/SecureHandler.php';\n session_name('teampass_session');\n session_start();\n-error_reporting(E_ERROR | E_PARSE);\n+//Session teampass tag\n $_SESSION['CPM'] = 1;\n+define('MIN_PHP_VERSION', 7.4);\n+define('MIN_MYSQL_VERSION', '8.0.13');\n+define('MIN_MARIADB_VERSION', '10.2.1');\n+\n+// Prepare POST variables\n+$post_root_url = filter_input(INPUT_POST, 'root_url', FILTER_SANITIZE_FULL_SPECIAL_CHARS);\n+$post_step = filter_input(INPUT_POST, 'step', FILTER_SANITIZE_NUMBER_INT);\n+$post_actual_cpm_version = filter_input(INPUT_POST, 'actual_cpm_version', FILTER_SANITIZE_FULL_SPECIAL_CHARS);\n+$post_cpm_isUTF8 = filter_input(INPUT_POST, 'cpm_isUTF8', FILTER_SANITIZE_FULL_SPECIAL_CHARS);\n+$post_user_granted = filter_input(INPUT_POST, 'user_granted', FILTER_SANITIZE_FULL_SPECIAL_CHARS);\n+$post_session_salt = filter_input(INPUT_POST, 'session_salt', FILTER_SANITIZE_FULL_SPECIAL_CHARS);\n+$post_url_path = filter_input(INPUT_POST, 'url_path', FILTER_SANITIZE_FULL_SPECIAL_CHARS);\n+$post_infotmp = filter_input(INPUT_POST, 'infotmp', FILTER_SANITIZE_FULL_SPECIAL_CHARS);\n+\n+//###############\n+//# Function permits to get the value from a line\n+//###############\n+/**\n+ * @param string $val\n+ */\n+function getSettingValue($val)\n+{\n+    $val = trim(strstr($val, '='));\n \n-//include librairies\n+    return trim(str_replace('\"', '', substr($val, 1, strpos($val, ';') - 1)));\n+}\n+\n+//get infos from SETTINGS.PHP file\n+$filename = '../includes/config/settings.php';\n+$events = '';\n+if (file_exists($filename)) {\n+    include_once $filename;\n+}\n+\n+?>\n+<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n+<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n+    <head>\n+        <title>TeamPass Upgrade</title>\n+        \n+        <meta http-equiv='Content-Type' content='text/html;charset=utf-8' />\n+        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\"/>\n+        <meta http-equiv=\"x-ua-compatible\" content=\"ie=edge\"/>\n+\n+        <link rel=\"stylesheet\" href=\"css/install.css\" type=\"text/css\" />\n+        <link rel=\"stylesheet\" href=\"../plugins/fontawesome-free-6/css/all.css\">\n+        \n+        <!-- Theme style -->\n+        <link rel=\"stylesheet\" href=\"../plugins/adminlte/css/adminlte.min.css\">\n+        <link rel=\"stylesheet\" href=\"../plugins/alertifyjs/css/alertify.min.css\"/>\n+        <link rel=\"stylesheet\" href=\"../plugins/alertifyjs/css/themes/bootstrap.min.css\"/>\n+        \n+        \n+    </head>\n+    \n+    <body>\n+<?php\n require_once '../includes/language/english.php';\n require_once '../includes/config/include.php';\n-require_once '../includes/config/settings.php';\n-require_once '../sources/main.functions.php';\n-require_once '../includes/libraries/Tree/NestedTree/NestedTree.php';\n-require_once 'tp.functions.php';\n-require_once 'libs/aesctr.php';\n-require_once '../includes/config/tp.config.php';\n-\n-// Get the encrypted password\n-define('DB_PASSWD_CLEAR', defuse_return_decrypted(DB_PASSWD));\n-\n-/*\n-//Build tree\n-$tree = new Tree\\NestedTree\\NestedTree(\n-    $pre . 'nested_tree',\n-    'id',\n-    'parent_id',\n-    'title'\n+\n+if (empty($post_root_url) === false) {\n+    $_SESSION['fullurl'] = $post_root_url;\n+}\n+\n+//define root path\n+$abs_path = rtrim(\n+    filter_var($_SERVER['DOCUMENT_ROOT'], FILTER_SANITIZE_FULL_SPECIAL_CHARS),\n+    '/'\n+).substr(\n+    filter_var($_SERVER['PHP_SELF'], FILTER_SANITIZE_FULL_SPECIAL_CHARS),\n+    0,\n+    strlen(filter_var($_SERVER['PHP_SELF'], FILTER_SANITIZE_FULL_SPECIAL_CHARS)) - 20\n );\n-*/\n-\n-// DataBase\n-// Test DB connexion\n-$pass = DB_PASSWD_CLEAR;\n-$server = DB_HOST;\n-$pre = DB_PREFIX;\n-$database = DB_NAME;\n-$port = DB_PORT;\n-$user = DB_USER;\n-\n-if (mysqli_connect(\n-    $server,\n-    $user,\n-    $pass,\n-    $database,\n-    $port\n-)) {\n-    $db_link = mysqli_connect(\n-        $server,\n-        $user,\n-        $pass,\n-        $database,\n-        $port\n-    );\n+if (isset($_SERVER['HTTPS'])) {\n+    $protocol = 'https://';\n } else {\n-    $res = 'Impossible to get connected to server. Error is: ' . addslashes(mysqli_connect_error());\n-    echo '[{\"finish\":\"1\", \"msg\":\"\", \"error\":\"Impossible to get connected to server. Error is: ' . addslashes(mysqli_connect_error()) . '!\"}]';\n-    mysqli_close($db_link);\n-    exit();\n+    $protocol = 'http://';\n }\n \n-// Load libraries\n-require_once '../includes/libraries/protect/SuperGlobal/SuperGlobal.php';\n-$superGlobal = new protect\\SuperGlobal\\SuperGlobal();\n \n+// HEADER\n+echo '\n+    <div id=\"top\" class=\"center-screen\">\n+        <div id=\"logo\" class=\"lcol\"><img src=\"../includes/images/teampass-logo2-home.png\" /></div>\n+        <div class=\"lcol\">\n+            <span class=\"header-title\">'.strtoupper(TP_TOOL_NAME).'</span>\n+            <!--<span class=\"header-title-small\"> v'.TP_VERSION.'</span>-->\n+        </div>\n+    <div id=\"content\">\n+        <form name=\"install\" method=\"post\" action=\"\">\n+        <div class=\"card card-default color-palette-box\">\n+            <div class=\"card-header\">\n+                <h3 class=\"card-title\">\n+                    <i class=\"fas fa-people-carry mr-2\"></i>Teampass upgrade\n+                </h3>\n+            </div>\n+            <div class=\"card-body\">';\n \n-//--->BEGIN 3.0.1\n+//HIDDEN THINGS\n+echo '\n+                <input type=\"hidden\" id=\"step\" name=\"step\" value=\"', isset($post_step) ? $post_step : '', '\" />\n+                <input type=\"hidden\" id=\"actual_cpm_version\" name=\"actual_cpm_version\" value=\"', isset($post_actual_cpm_version) ? $post_actual_cpm_version : '', '\" />\n+                <input type=\"hidden\" id=\"cpm_isUTF8\" name=\"cpm_isUTF8\" value=\"', isset($post_cpm_isUTF8) ? $post_cpm_isUTF8 : '', '\" />\n+                <input type=\"hidden\" name=\"menu_action\" id=\"menu_action\" value=\"\" />\n+                <input type=\"hidden\" name=\"user_granted\" id=\"user_granted\" value=\"\" />\n+                <input type=\"hidden\" name=\"infotmp\" id=\"infotmp\" value=\"', isset($post_infotmp) ? $post_infotmp : '', '\" />\n+                <input type=\"hidden\" name=\"url_path\" id=\"url_path\" value=\"'.$protocol.$_SERVER['HTTP_HOST'].substr($_SERVER['PHP_SELF'], 0, strrpos($_SERVER['PHP_SELF'], '/') - 8).'\" />\n+                <input type=\"hidden\" name=\"session_salt\" id=\"session_salt\" value=\"', (isset($post_session_salt) && !empty($post_session_salt)) ? $post_session_salt : @$_SESSION['encrypt_key'], '\" />';\n \n-// Ensure admin user is ready\n-mysqli_query(\n-    $db_link,\n-    \"UPDATE \".$pre.\"users \n-    SET is_ready_for_usage = 1, otp_provided = 1 \n-    WHERE id = 1\"\n-);\n+if (!isset($_GET['step']) && !isset($post_step)) {\n+    //ETAPE O\n+    echo '\n+                <div class=\"row\">\n+                    <div class=\"callout callout-warning col-12\">\n+                        <h5>Information</h5>\n+    \n+                        <p>Upgrade process is about to start. This will upgrade Teampass database to version '.TP_VERSION.'.</p>\n+                        <p>Version 3 comes with a new secured encryption strategy getting rid of any Saltkey. It relies on public and private keys generated for each user. As an impact, this upgrade will automatically generate a One-Time-Code for each user and send by email. It will be requested on first login. Please ensure your users have filled in their email with a valid value.</p>\n+                    </div>\n \n-//---<END 3.0.1\n+                    <div class=\"callout callout-info col-12\">\n+                        <h5>Before starting, take a couple of minutes to perform backup of current Teampass instance:</h5>\n+    \n+                        <p>\n+                        <ul>\n+                            <li><i class=\"fas fa-exclamation-circle mr-2 text-danger\"></i>Ensure to clear your browser cache (keyboard: <i>CTRL + F5</i>)</li>\n+                            <li><i class=\"fas fa-exclamation-triangle mr-2 text-warning\"></i>Create a dump of your database</li>\n+                            <li><i class=\"fas fa-exclamation-triangle mr-2 text-warning\"></i>Perform a zip of the current Teampass folder</li>\n+                            <li><i class=\"fas fa-info-circle mr-2 text-success\"></i>Refer to <a href=\"https://teampass.readthedocs.io/en/latest/install/upgrade/\" target=\"_blank\" class=\"text-info\">upgrade documentation</a>.</li>\n+                        </ul>\n+                        </p>\n+                    </div>\n+                </div>\n \n+                <div class=\"row card card-primary\">\n+                    <div class=\"card-body col-12\">\n+                        <div class=\"form-group\">\n+                            <label>Administrator Login</label>\n+                            <input type=\"text\" class=\"form-control\" id=\"user_login\" placeholder=\"Enter admin login\">\n+                        </div>\n+                        <div class=\"form-group\">\n+                            <label>Password</label>\n+                            <input type=\"password\" class=\"form-control\" id=\"user_pwd\" placeholder=\"Enter admin password\">\n+                        </div>\n+                        <div class=\"alert alert-warning hidden\" id=\"res_step0\"></div>\n+                    </div>\n+                </div>\n \n-//--->BEGIN 3.0.5\n \n-// Add the INDEX process_id_idx to the processes_tasks table\n-$res = checkIndexExist(\n-    $pre . 'processes_tasks',\n-    'process_id_idx',\n-    \"ADD KEY `process_id_idx` (`process_id`)\"\n-);\n-if (!$res) {\n-    echo '[{\"finish\":\"1\", \"msg\":\"\", \"error\":\"An error appears when adding the INDEX process_id_idx to the processes_tasks table! ' . mysqli_error($db_link) . '!\"}]';\n-    mysqli_close($db_link);\n-    exit();\n-}\n+                <input type=\"hidden\" id=\"step0\" name=\"step0\" value=\"\" />\n \n-//---<END 3.0.5\n+            </div>';\n+// STEP1\n+} elseif ((isset($post_step) && $post_step == 1)\n+    || (isset($_GET['step']) && $_GET['step'] == 1)\n+    && $post_user_granted === '1'\n+) {\n+    //ETAPE 1\n+    $_SESSION['user_granted'] = $post_user_granted;\n+    echo '\n+            <div class=\"row\">\n+                <div class=\"col-12\">\n+                    <div class=\"card card-primary\">\n+                        <div class=\"card-header\">\n+                            <h5>Server information</h5>\n+                        </div>\n+                        <div class=\"card-body\">\n+                            <div class=\"form-group\">\n+                                <label>Absolute path to TeamPass folder</label>\n+                                <input type=\"text\" class=\"form-control\" id=\"root_path\" value=\"'.$abs_path.'\">\n+                            </div>\n+                            <div class=\"form-group\">\n+                                <label>Full URL to TeamPass</label>\n+                                <input type=\"text\" class=\"form-control\" id=\"root_url\" value=\"'.$protocol.$_SERVER['HTTP_HOST'].substr($_SERVER['PHP_SELF'], 0, strrpos($_SERVER['PHP_SELF'], '/') - 8).'\">\n+                            </div>\n+                        </div>\n+                    </div>\n+                </div>\n+            </div>\n \n+            <div class=\"row\">\n+                <div class=\"col-12\">\n+                    <div class=\"card card-primary\">\n+                        <div class=\"card-header\">\n+                            <h5>Next elements will be checked</h5>\n+                        </div>\n+                        <div class=\"card-body\">\n \n-//--->BEGIN 3.0.6\n-// Add new setting 'sending_emails_job_frequency'\n-$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\" . $pre . \"misc` WHERE type = 'admin' AND intitule = 'sending_emails_job_frequency'\"));\n-if (intval($tmp) === 0) {\n-    mysqli_query(\n-        $db_link,\n-        \"INSERT INTO `\" . $pre . \"misc` (`type`, `intitule`, `valeur`) VALUES ('admin', 'sending_emails_job_frequency', '2')\"\n-    );\n-}\n-// Add new setting 'user_keys_job_frequency'\n-$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\" . $pre . \"misc` WHERE type = 'admin' AND intitule = 'user_keys_job_frequency'\"));\n-if (intval($tmp) === 0) {\n-    mysqli_query(\n-        $db_link,\n-        \"INSERT INTO `\" . $pre . \"misc` (`type`, `intitule`, `valeur`) VALUES ('admin', 'user_keys_job_frequency', '1')\"\n-    );\n+                            <div id=\"res_step1\">\n+                            <span>File \"settings.php\" is writable</span><br />\n+                            <span>Directory \"/install/\" is writable</span><br />\n+                            <span>Directory \"/includes/\" is writable</span><br />\n+                            <span>Directory \"/includes/config/\" is writable</span><br />\n+                            <span>Directory \"/includes/avatars/\" is writable</span><br />\n+                            <span>Directory \"/files/\" is writable</span><br />\n+                            <span>Directory \"/upload/\" is writable</span><br />\n+                            <span>PHP extension \"openssl\" is loaded</span><br />\n+                            <span>PHP extension \"gd\" is loaded</span><br />\n+                            <span>PHP extension \"mbstring\" is loaded</span><br />\n+                            <span>PHP extension \"bcmath\" is loaded</span><br />\n+                            <span>PHP extension \"iconv\" is loaded</span><br />\n+                            <span>PHP extension \"xml\" is loaded</span><br />\n+                            <span>PHP extension \"curl\" is loaded</span><br />\n+                            <span>PHP extension \"gmp\" is loaded</span><br />\n+                            <span>PHP extension \"mcrypt\" is loaded</span><br />\n+                            <span>PHP version is greater or equal to '.MIN_PHP_VERSION.'</span><br />\n+                            <span>SQL version is greater or equal to MySQL '.MIN_MYSQL_VERSION.' or MariaDB '.MIN_MARIADB_VERSION.'</span><br />\n+                            </div>\n+                        \n+                        </div>\n+                    </div>\n+                </div>\n+            </div>\n+            <input type=\"hidden\" id=\"step1\" name=\"step1\" value=\"\" />';\n+// STEP2\n+} elseif ((isset($post_step) && $post_step == 2)\n+    || (isset($_GET['step']) && $_GET['step'] == 2)\n+    && $_SESSION['user_granted'] === '1'\n+) {\n+    // Do we have all database settings\n+    if (null !== DB_HOST\n+        && null !== DB_USER\n+        && null !== DB_PASSWD\n+        && null !== DB_NAME\n+        && null !== DB_PREFIX\n+        && null !== DB_PORT\n+    ) {\n+        $dbSettings = true;\n+    } else {\n+        $dbSettings = false;\n+    }\n+    //ETAPE 2\n+    echo '\n+        <div class=\"row\">\n+            <div class=\"col-12\">\n+                <div class=\"card card-',$dbSettings === true ? 'primary' : 'warning','\">\n+                    <div class=\"card-header\">\n+                        <h5>DataBase Informations</h5>\n+                    </div>\n+                    <div class=\"card-body\">\n+                        <!--<div class=\"form-group\">\n+                            <label>Host</label>\n+                            <input type=\"text\" class=\"form-control\" name=\"db_host\" id=\"db_host\" class=\"ui-widget\" value=\"'.DB_HOST.'\">\n+                        </div>\n+                        \n+                        <div class=\"form-group\">\n+                            <label>Database name</label>\n+                            <input type=\"text\" class=\"form-control\" name=\"db_name\" id=\"db_name\" class=\"ui-widget\" value=\"'.DB_NAME.'\">\n+                        </div>\n+                        \n+                        <div class=\"form-group\">\n+                            <label>Login</label>\n+                            <input type=\"text\" class=\"form-control\" name=\"db_user\" id=\"db_user\" class=\"ui-widget\" value=\"'.DB_USER.'\">\n+                        </div>\n+                        \n+                        <div class=\"form-group\">\n+                            <label>Password</label>\n+                            <input type=\"text\" class=\"form-control\" name=\"db_pw\" id=\"db_pw\" class=\"ui-widget\" value=\"'.$visible_pwd.'\">\n+                        </div>\n+                        \n+                        <div class=\"form-group\">\n+                            <label>Prefix</label>\n+                            <input type=\"text\" class=\"form-control\" name=\"db_prefix\" id=\"db_prefix\" class=\"ui-widget\" value=\"'.DB_PREFIX.'\">\n+                        </div>\n+                        \n+                        <div class=\"form-group\">\n+                            <label>Port</label>\n+                            <input type=\"text\" class=\"form-control\" name=\"db_port\" id=\"db_port\" class=\"ui-widget\" value=\"'.DB_PORT.'\">\n+                        </div>-->';\n+\n+    // check if all database  info are available\n+    if ($dbSettings === true) {\n+        echo '\n+                        <div>\n+                        Database settings has been retreived.<br>\n+                        If you need to change them, please edit file `/includes/config/settings.php` and relaunch the upgrade process.\n+                        </div>';\n+    } else {\n+        echo '\n+                        <div>\n+                        The database information has not been retreived from the settings file.<br>\n+                        You need to adapt the file `/includes/config/settings.php` and relaunch the upgrade process.\n+                        </div>';\n+    }\n+\n+    echo '\n+                        <a href=\"'.$protocol.$_SERVER['HTTP_HOST'].substr($_SERVER['PHP_SELF'], 0, strrpos($_SERVER['PHP_SELF'], '/') - 8).'/install/upgrade.php\">Restart upgrade process</a>\n+                    </div>\n+                </div>\n+\n+                <div class=\"card card-primary\">\n+                    <div class=\"card-header\">\n+                        <h5>Maintenance Mode</h5>\n+                    </div>\n+                    <div class=\"card-body\">\n+                        <div>\n+                            <input type=\"checkbox\" class=\"mr-2\" id=\"no_maintenance_mode\">\n+                            <label for=\"no_maintenance_mode\">Don\\'t activate the Maintenance mode</label>\n+                        </div>\n+                        <small class=\"form-text text-muted\">\n+                            By default, the maintenance mode is enabled when an Update is performed. This prevents the use of TeamPass while the scripts are running.<br />\n+                            However, some administrators may prefer to warn the users in another way. Nevertheless, keep in mind that the update process may fail or even be corrupted due to parallel queries.\n+                        </small>\n+                    </div>\n+                </div>\n+\n+                <div class=\"card card-primary\">\n+                    <div class=\"card-header\">\n+                        <h5>Database dump</h5>\n+                    </div>\n+                    <div class=\"card-body\">\n+                        <div>\n+                            If you have NOT performed a dump of your database, please considere to create one now.\n+                        </div>\n+                        <div>\n+                            <a href=\"#\" onclick=\"launch_database_dump(); return false;\">Launch a new database dump</a>\n+                        </div>\n+                        <div>\n+                            <span id=\"dump_result\" style=\"margin-top:4px;\" class=\"card card-info\"></span>\n+                        </div>\n+                    </div>\n+                </div>\n+\n+                <!-- teampass_version = 2.1.27 and no encrypt_key in db -->\n+                <div class=\"callout card-warning hidden\" id=\"no_encrypt_key\">\n+                    <div class=\"card-header\">\n+                        <h5>Database Origine</h5>\n+                    </div>\n+                    <div class=\"card-body\">\n+                        <div>\n+                            Please select:&nbsp;<select id=\"no_key_selection\">\n+                            <option value=\"false\">-- select --</option>\n+                            <option value=\"no_previous_sk_sel\">We have never used Teampass in an older version than 2.1.27(.x)</option>\n+                            <option value=\"previous_sk_sel\">We have used Teampass in an older version (example: 2.1.26)</option>\n+                        </select>\n+                        <div id=\"previous_sk_div\" style=\"display:none;\">\n+                            <p>Please use the next field to enter the saltkey you used in previous version of Teampass. It can be retrieved by editing sk.php file (in case you are upgrading from a version older than 2.1.27) or a sk.php backup file (in case you are upgrading from 2.1.27).<br>\n+                            </p>\n+                            <label for=\"previous_sk\">Previous SaltKey:&nbsp</label>\n+                            <input type=\"text\" id=\"previous_sk\" size=\"100px\" value=\"'.@$_SESSION['encrypt_key'].'\" />\n+                        </div>\n+                        </div>\n+                    </div>\n+                </div>\n+\n+                <div style=\"margin-top:20px;font-weight:bold;text-align:center;height:27px;\" id=\"res_step2\"></div>\n+                <input type=\"hidden\" id=\"step2\" name=\"step2\" value=\"\">\n+\n+            </div>\n+        </div>';\n+\n+\n+// STEP3\n+} elseif ((isset($post_step) && $post_step == 3 || isset($_GET['step']) && $_GET['step'] == 3)\n+    && isset($post_actual_cpm_version)\n+    && intVal($_SESSION['user_granted']) === 1\n+) {\n+    if (version_compare($post_actual_cpm_version, '2.1.26', '<')) {\n+        $conversion_utf8 = true;\n+    } else {\n+        $conversion_utf8 = false;\n+    }\n+    echo '\n+        <div class=\"card card-primary\">\n+            <div class=\"card-header\">\n+                <h5>Converting database to UTF-8</h5>\n+            </div>\n+            <div class=\"card-body\">\n+                <div>\n+                ', $conversion_utf8 === true ?\n+                'Notice that TeamPass is now only using UTF-8 charset.\n+                This step will convert the database to this charset.\n+                <div>\n+                <input type=\"checkbox\" id=\"prefix_before_convert\" class=\"mr-2\"><label for=\"prefix_before_convert\">Save previous tables before converting (prefix \"old_\" will be used)</label>\n+                </div>' :\n+                'The database is currently using UTF-8 charset <i class=\"fas fa-check-circle fa-lg text-success ml-3\"></i>', '\n+                </div>\n+            </div>\n+        </div>';\n+// STEP4\n+} elseif ((isset($post_step) && $post_step == 4) || (isset($_GET['step'])\n+    && $_GET['step'] == 4)\n+    && $_SESSION['user_granted'] === '1'\n+) {\n+    echo '\n+        <div class=\"card card-primary\">\n+            <div class=\"card-header\">\n+                <h5>Database updates</h5>\n+            </div>\n+            <div class=\"card-body\">\n+                <small class=\"form-text text-muted\">\n+                    The database needs to be adapted. This step can take a very long time depending on the data volume and server performance.\n+                </small>\n+                <div class=\"row card card-primary mt-2\">\n+                    <div class=\"card-body col-12 font-weight-light\" id=\"step4_progress\" style=\"overflow-y: scroll; height:400px;\">\n+                        Please click the button START.\n+                    </div>\n+                </div>\n+\n+                <div class=\"hidden\" id=\"change_pw_encryption\">\n+                    <br />\n+                    <p><b>Encryption protocol of existing passwords now has to be started. It may take a very long time depending on the data volume and server performance.</b></p>\n+                    <p>\n+                        <div style=\"display:none;\" id=\"change_pw_encryption_progress\"></div>\n+                    </p>\n+                    <input type=\"button\" value=\"Click to continue\" id=\"but_encrypt_continu\" onclick=\"newEncryptPw(0);\" />\n+                    <input type=\"hidden\" id=\"change_pw_encryption_start\" value=\"\" />\n+                    <input type=\"hidden\" id=\"change_pw_encryption_total\" value=\"\" />\n+                </div>\n+\n+                <div style=\"margin-top:20px;font-weight:bold;text-align:center;height:27px;\" id=\"res_step4\"></div>\n+                <input type=\"hidden\" id=\"step4\" name=\"step4\" value=\"\">\n+            </div>\n+        </div>';\n+// STEP5\n+} elseif ((isset($post_step) && $post_step == 5)\n+    || (isset($_GET['step']) && $_GET['step'] == 5)\n+    && $_SESSION['user_granted'] === '1'\n+) {\n+    //ETAPE 5\n+    echo '\n+        <h4>Finalization</h4>\n+        <div>\n+            <ul>\n+            <li>Regenerate settings.php file <span id=\"step5_settingFile\"></span></li>\n+            <li>Anonymize saltkey file <span id=\"step5_saltkeyFile\"></span></li>\n+            <li>Generate config file <span id=\"step5_configFile\"></span></li>\n+            <li>Generate CSRFP config file <span id=\"step5_csrfpFile\"></span></li>\n+            <li>Add new cron job <span id=\"step5_cronJob\"></span></li>\t\n+            </ul>\n+        </div>';\n+\n+    echo '\n+        <div class=\"card card-primary\">\n+            <div class=\"card-header\">\n+                <h5>Absolute path to SaltKey</h5>\n+            </div>\n+            <div class=\"card-body\">\n+                <small class=\"form-text text-muted\">\n+                The SaltKey is stored in a file stored in a folder outside the www folder of your server.\n+                </small>\n+                <div class=\"mt-4\">\n+                    <input type=\"text\" class=\"form-control\" id=\"sk_path\" value=\"', defined('SECUREPATH') === true ? SECUREPATH : '', '\" placeholder=\"Path to folder\">\n+                </div>\n+            </div>\n+        </div>';\n+\n+    echo '\n+        <div class=\"alert alert-info mt-4 hidden\" id=\"res_step5\"></div>';\n+} elseif ((isset($post_step) && $post_step == 6)\n+    || (isset($_GET['step']) && $_GET['step'] == 6)\n+    && $_SESSION['user_granted'] === '1'\n+) {\n+    //ETAPE 5\n+    echo '\n+        <h4>Upgrade is now completed</h4>\n+        <div class=\"callout callout-info mt-4\">\n+            <div>\n+                For news, help and information, visit <a href=\"https://teampass.net\" target=\"_blank\" class=\"text-info\">TeamPass website</a>\n+            </div>\n+        </div>\n+        <div class=\"alert alert-primary mt-4\">\n+            <i class=\"far fa-lightbulb text-warning mr-2 fa-lg\"></i>It is recommended to clean the cache of your Web Browser before trying to log in.\n+        </div>';\n+\n+    if (version_compare($post_actual_cpm_version, '2.1.27', '<=')) {\n+        echo '\n+        <div class=\"alert alert-warning mt-4\">\n+            <i class=\"fa fa-exclamation-circle text-danger mr-2 fa-lg\"></i>This upgrade was a heavy one. Indeed we have changed the encryption of your data to make them safer now as they don\\'t rely anymore on a key.<br>\n+            This forced us to encode your users data with a One-Time-Code that they did receive by email. For any reason, they did not received it, you as an admin, can change it from the users management page.\n+        </div>';\n+    }\n+\n+    echo '\n+        <div class=\"mt-5\">\n+        <a href=\"#\" class=\"btn btn-primary\" onclick=\"javascript:window.location.href=\\'', (isset($_SERVER['HTTPS']) && ($_SERVER['HTTPS'] == 'on' || $_SERVER['HTTPS'] == 1) || isset($_SERVER['HTTP_X_FORWARDED_PROTO']) && $_SERVER['HTTP_X_FORWARDED_PROTO'] == 'https') ? 'https' : 'http', '://'.$_SERVER['HTTP_HOST'].substr($_SERVER['PHP_SELF'], 0, strrpos($_SERVER['PHP_SELF'], '/') - 8).'\\';\"><b>Open TeamPass</b></a>\n+        </div>';\n }\n-// Add new setting 'items_statistics_job_frequency'\n-$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\" . $pre . \"misc` WHERE type = 'admin' AND intitule = 'enable_tasks_items_statistics_job_frequencymanager'\"));\n-if (intval($tmp) === 0) {\n-    mysqli_query(\n-        $db_link,\n-        \"INSERT INTO `\" . $pre . \"misc` (`type`, `intitule`, `valeur`) VALUES ('admin', 'items_statistics_job_frequency', '5')\"\n-    );\n+\n+echo '\n+            <div class=\"card-footer\">';\n+//buttons\n+if (!isset($post_step)) {\n+    echo '\n+            <input type=\"button\" id=\"but_launch\" data-step=\"step0\" class=\"btn btn-primary\" value=\"START\">\n+            <input type=\"button\" id=\"but_next\" data-target=\"1\" style=\"\" class=\"btn btn-primary\" value=\"NEXT\" disabled=\"disabled\">';\n+} elseif (intVal($post_step) === 3 && $conversion_utf8 === false && $_SESSION['user_granted'] === '1') {\n+    echo '\n+            <input type=\"button\" id=\"but_next\" target_id=\"'.(intval($post_step) + 1).'\" class=\"btn btn-primary\" value=\"NEXT\">';\n+} elseif (intVal($post_step) === 3 && $conversion_utf8 === true && $_SESSION['user_granted'] === '1') {\n+    echo '\n+            <input type=\"button\" id=\"but_launch\" data-step=\"step'.$post_step.'\" class=\"btn btn-primary\" value=\"START\">\n+            <input type=\"button\" id=\"but_next\" data-target=\"'.(intval($post_step) + 1).'\" class=\"btn btn-primary\" value=\"NEXT\" disabled=\"disabled\">';\n+} elseif (intVal($post_step) === 6 && $_SESSION['user_granted'] === '1') {\n+    // Nothong to do\n+} else {\n+    echo '\n+            <input type=\"button\" id=\"but_launch\" data-step=\"step'.$post_step.'\" class=\"btn btn-primary\" value=\"START\" />\n+            <input type=\"button\" id=\"but_next\" data-target=\"'.(intval($post_step) + 1).'\" class=\"btn btn-primary\" value=\"NEXT\" disabled=\"disabled\">';\n }\n \n-// Add field ongoing_process_id to USERS table\n-$res = addColumnIfNotExist(\n-    $pre . 'users',\n-    'ongoing_process_id',\n-    \"varchar(100) NULL;\"\n-);\n-if ($res === false) {\n-    echo '[{\"finish\":\"1\", \"msg\":\"\", \"error\":\"An error appears when adding field ongoing_process_id to table USERS! ' . mysqli_error($db_link) . '!\"}]';\n-    mysqli_close($db_link);\n-    exit();\n+echo '\n+            </div>\n+        </div>\n+        </form>\n+    </div>';\n+//FOOTER\n+echo '\n+    <div id=\"footer\">\n+        <div style=\"width:500px; font-size:16px;\">\n+            '.TP_TOOL_NAME.' '.TP_VERSION.' &#169; copyright 2009-'.date(\"Y\").'\n+        </div>\n+        <div style=\"float:right;margin-top:-15px;\">\n+        </div>\n+    </div>';\n+?>\n+    </div>\n+\n+</body>\n+</html>\n+\n+\n+<script type=\"text/javascript\" src=\"js/aes.min.js\"></script>\n+<!-- jQuery -->\n+<script src=\"../plugins/jquery/jquery.min.js\"></script>\n+<!-- jQuery -->\n+<script src=\"../plugins/jqueryUI/jquery-ui.min.js\"></script>\n+<!-- Popper -->\n+<script src=\"../plugins/popper/umd/popper.min.js\"></script>\n+<!-- Bootstrap -->\n+<script src=\"../plugins/bootstrap/js/bootstrap.bundle.min.js\"></script>\n+<!-- AdminLTE -->\n+<script src=\"../plugins/adminlte/js/adminlte.min.js\"></script>\n+<!-- Altertify -->\n+<script type=\"text/javascript\" src=\"../plugins/alertifyjs/alertify.min.js\"></script>\n+\n+\n+\n+\n+<script type=\"text/javascript\">\n+var timeTaken = '';\n+\n+\n+$(function(){\n+    // click on button NEXT\n+    $(\"#but_next\").click(function(event) {\n+        $(\"#step\").val($(this).data(\"target\"));\n+        document.install.submit();\n+    });\n+\n+    $(\"#dump_done\").click(function(event) {\n+        if($(\"#dump_done\").is(':checked')) {\n+            $(\"#but_next\").prop(\"disabled\", false);\n+        } else {\n+            $(\"#but_next\").prop(\"disabled\", true);\n+        }\n+    });\n+\n+    $(\"#no_key_selection\").change(function() {\n+        if ($(\"#no_key_selection\").val() === \"no_previous_sk_sel\") {\n+            $(\"#previous_sk_div\").hide();\n+            $(\"#previous_sk\").val(\"\");\n+        } else if ($(\"#no_key_selection\").val() === \"previous_sk_sel\") {\n+            $(\"#previous_sk_div\").show();\n+        }\n+    });\n+\n+    // click on button START\n+    $('#but_launch').click(function(event) {\n+        var currentStep = $(this).data('step'),\n+            postData = '';\n+        // STEP 0\n+        if (currentStep === 'step0') {\n+            if ($(\"#user_login\").val() === \"\" || $(\"#user_pwd\").val() === \"\") {\n+                alertify\n+                    .error('<i class=\"fas fa-ban mr-2\">[ERROR] You must provide credentials</i>', 10)\n+                    .dismissOthers();\n+                return false;\n+            }\n+\n+            postData = {\n+                type : currentStep,\n+                login : $(\"#user_login\").val(),\n+                pwd : window.btoa(aesEncrypt($(\"#user_pwd\").val()))\n+            }\n+            \n+        } else if (currentStep === 'step1') {\n+            postData = {\n+                type : currentStep,\n+                abspath : $(\"#root_path\").val(),\n+                fullurl : $(\"#root_url\").val()\n+            }\n+        } else if (currentStep === 'step2') {\n+            postData = {\n+                type : currentStep,\n+                abspath : $(\"#root_path\").val(),\n+                fullurl : $(\"#root_url\").val()\n+            }\n+        } else if (currentStep === 'step3') {\n+            postData = {\n+                type : currentStep,\n+                abspath : $(\"#root_path\").val(),\n+                fullurl : $(\"#root_url\").val(),\n+                prefix_before_convert : $('#prefix_before_convert').prop(\"checked\")\n+            }\n+\n+        } else if (currentStep === \"step4\") {\n+            upgrade_file = \"\";\n+            timeTaken = getTime();\n+            manageUpgradeScripts(\"0\");\n+            return false;\n+\n+        } else if (currentStep === \"step5\") {\n+            postData = {\n+                type : currentStep,\n+                url_path : $(\"#url_path\").val()\n+            }\n+        }\n+\n+        alertify\n+            .message('<i class=\"fas fa-cog fa-spin fa-2x\"></i>', 0)\n+            .dismissOthers();\n+        $(\"#res_\"+currentStep).html(\"\").addClass(\"hidden\");\n+\n+        // EXECUTE AJAX REQUEST\n+        return $.ajax({\n+            url: \"upgrade_ajax.php\",\n+            type : \"POST\",\n+            dataType : \"json\",\n+            async: false,\n+            data : postData,\n+            complete : function(result, status){\n+                //console.log(result.responseText)\n+                data = $.parseJSON(result.responseText)[0];\n+                console.log(data)\n+                // manage error\n+                if (data.error !== \"\") {\n+                    $(\"#user_granted\").val(\"0\");\n+                    $('#but_next').attr('disabled');\n+\n+                    if (data.info !== \"\") {\n+                        $('#res_'+currentStep).html(data.info).removeClass(\"hidden\");\n+                    }\n+                    alertify\n+                        .error('<i class=\"fas fa-exclamation-triangle mr-2\"></i>  '+data.error+'</i>', 5)\n+                        .dismissOthers();\n+                } else {\n+                    $(\"#step\").val(data.index);\n+                    $(\"#user_granted\").val(\"1\");\n+                    $('#but_next').removeAttr('disabled');\n+\n+                    // Special\n+                    if (currentStep === 'step0') {\n+                        $(\"#infotmp\").val(data.info);\n+                    } else if (currentStep === 'step1') {\n+                        $('#res_step1').html(data.info).removeClass('hidden');\n+                    } else if (currentStep === 'step2') {\n+                        \n+                        $('#res_step2').html(data.info).removeClass('hidden');\n+                        $('#cpm_isUTF8').val(data.isUtf8);\n+                        if (parseInt(data.isUtf8) === 1) {\n+                            $('#step').val(4);\n+                            $('#but_next').data('target', \"4\");\n+                        }\n+                    } else if (currentStep === 'step5') {\n+                        $(\"#res_step5\").html(\"Operations are successfully completed.\").removeClass(\"hidden\");\n+                        var res = $.parseJSON(atob(data.info));\n+                        \n+                        $.each(res, function(index, value) {\n+                            $('#'+value.id).html(value.html);\n+                        });\n+                    }\n+\n+                    // Display\n+                    alertify\n+                        .success('<i class=\"fas fa-thumbs-up mr-2\">  Done</i>', 5)\n+                        .dismissOthers();\n+                }\n+            }\n+        });\n+    });\n+\n+});\n+\n+function aesEncrypt(text)\n+{\n+    return Aes.Ctr.encrypt(text, \"cpm\", 128);\n }\n-//---<END 3.0.6\n \n \n-//--->BEGIN 3.0.7\n-// Alter\n-try {\n-    mysqli_query(\n-        $db_link,\n-        'ALTER TABLE `' . $pre . 'cache_tree` CHANGE `data` `data` LONGTEXT DEFAULT NULL;'\n+function manageUpgradeScripts(file_number)\n+{\n+    var start_at = 0;\n+    var noitems_by_loop = 100;\n+    var loop_number = 0;\n+\n+    if (file_number == 0) {\n+        $(\"#step4_progress\").html(\"\");\n+        alertify\n+            .success('Done', 1)\n+            .dismissOthers();\n+    }\n+\n+    request = $.post(\"upgrade_scripts_manager.php\",\n+        {\n+            file_number : parseInt(file_number)\n+        },\n+        function(data) {\n+            console.log(data[0])\n+            // work not finished\n+            if (data[0].finish !== \"1\") {\n+                // loop\n+                runUpdate(data[0].scriptname, data[0].parameter, start_at, noitems_by_loop, loop_number, file_number);\n+            }\n+            // work finished\n+            else {\n+                // refresh categories cache\n+                rand_number = createRandomId();\n+                $(\"#step4_progress\")\n+                    .html(\n+                        \"<div>\" + getTime() + \" - <span id='user_\"+rand_number+\"'>Performing database update operations ... <i class=\\\"fas fa-cog fa-spin\\\" style=\\\"color:orange\\\"></i></span></div>\"+ \n+                        $(\"#step4_progress\").html()\n+                    );\n+                $.ajax({\n+                    url: \"upgrade_ajax.php\",\n+                    type : \"POST\",\n+                    dataType : \"json\",\n+                    async: false,\n+                    data : {\n+                        type : \"perform_nestedtree_categories_population_3.0.0.18\"\n+                    },\n+                    complete : function(result, status) {\n+                        console.log(\"Tash perform_nestedtree_categories_population_3.0.0.18 DONE\");\n+                        $(\"#user_\"+rand_number)\n+                            .html('Database update operations done <i class=\"fas fa-thumbs-up\" style=\"color:green\"></i>'); \n+                        migrateUsersToV3('step1', '', 'init', createRandomId(), 0, false, 0);\n+\n+                        alertify\n+                            .success('Done with initialization phase', 3)\n+                            .dismissOthers();\n+                    }\n+                });\n+            }\n+        },\n+        \"json\"\n     );\n-} catch (Exception $e) {\n-    // Do nothing\n }\n \n-// Fix for #3679\n-mysqli_query(\n-    $db_link,\n-    \"UPDATE `\" . $pre . \"users` SET `treeloadstrategy` = 'full' WHERE treeloadstrategy NOT IN ('full','sequential');\"\n-);\n+var usersList = [],\n+    previousStep = '',\n+    usersRestList = [];\n+/**\n+    * We need to migrate all users\n+    * This will change the users encryption and generate a OTC\n+    *\n+    * @return void\n+    */\n+function migrateUsersToV3(step, data, number, rand_number, loop_start, loop_finished, tp_user_done)\n+{\n+    console.log(\"> \"+step+\" - Number: \"+number + \" - Previous step: \"+previousStep);\n+    console.log(usersList);\n+    var d = new Date(),\n+        count_in_loop = <?php echo (int) NUMBER_ITEMS_IN_BATCH;?>,\n+        userSteps = {};\n \n-//---<END 3.0.7\n \n+    // Decode data\n+    var newData = '';\n+    if (data !== '' && step === 'step1') {\n+        newData = JSON.parse(window.atob(data));\n+    }\n+    console.log(\"TO DO : \"+step+\" -- \"+number+\" -- \"+loop_start+\" -- \"+loop_finished+\" -- \"+newData.id)\n \n-//--->BEGIN 3.0.8\n-// Add field mfa_disabled to USERS table\n-$res = addColumnIfNotExist(\n-    $pre . 'users',\n-    'mfa_enabled',\n-    \"tinyint(1) NOT null DEFAULT '1';\"\n-);\n-if ($res === false) {\n-    echo '[{\"finish\":\"1\", \"msg\":\"\", \"error\":\"An error appears when adding field mfa_disabled to table USERS! ' . mysqli_error($db_link) . '!\"}]';\n-    mysqli_close($db_link);\n-    exit();\n-}\n+    if (step === 'step1') {\n+        userInfo = '';\n+        // Show progress to user\n+        $(\"#user_\"+rand_number).html(\"User id \" + newData.id + \" done <i class=\\\"fas fa-thumbs-up\\\" style=\\\"color:green\\\"></i>\");\n+\n+        if (newData !== '') {\n+            usersList.push(newData);\n+        }\n+        console.log('List of users');\n+        console.log(JSON.stringify(usersList))\n+        \n+        if (usersRestList.length > 0) {\n+            number = usersRestList[0];\n+            usersRestList.shift();\n+        } else if (number !== 'init') {\n+            number = 'end';\n+        }\n+        //console.log('List of next users');\n+        //console.log(JSON.stringify(usersRestList) + \" ; Number = \"+number)\n+        \n+        rand_number = createRandomId();\n+        $(\"#step4_progress\").html(\"<div>\" + getTime() + \" - <span id='user_\"+rand_number+\"'>Treating User account ... <i class=\\\"fas fa-cog fa-spin\\\" style=\\\"color:orange\\\"></i></span></div>\"+ $(\"#step4_progress\").html());\n+        // --\n+        // --\n+    } else {\n+        // Prepare array                \n+        if (usersList[number] !== undefined) {\n+            userSteps = {\n+                'step1' : {\n+                    'text' : 'Users public / private keys were generated if needed',\n+                    'number' : 0,\n+                    'start' : 0\n+                },\n+                'step2' : {\n+                    'text' : 'User '+usersList[number].id+' - All ITEMS keys generated',\n+                    'number' : 0,\n+                    'start' : 0\n+                },\n+                'step3' : {\n+                    'text' : 'User '+usersList[number].id+' - All LOGS keys generated',\n+                    'number' : number,\n+                    'start' : 0\n+                },\n+                'step4' : {\n+                    'text' : 'User '+usersList[number].id+' - All FIELDS keys generated',\n+                    'number' : number,\n+                    'start' : 0\n+                },\n+                'step5' : {\n+                    'text' : 'User '+usersList[number].id+' - All SUGGESTIONS keys generated',\n+                    'number' : number,\n+                    'start' : 0\n+                },\n+                'step6' : {\n+                    'text' : 'User '+usersList[number].id+' - All FILES keys generated',\n+                    'number' : number,\n+                    'start' : 0\n+                },\n+                'nextUser' : {\n+                    'number' : parseInt(number) + 1,\n+                    'start' : 0\n+                }\n+            };\n+        }\n+\n+        // What strategy to have for next treatment\n+        if (previousStep === 'step1') {\n+            $(\"#user_\"+rand_number).html(\"Users public / private keys were generated if needed <i class=\\\"fas fa-thumbs-up\\\" style=\\\"color:green\\\"></i>\");\n+\n+            number = 0;\n+            loop_start = 0;\n+            // --\n+        } else if (previousStep === step) {\n+            // IF we are in the same step and we continue\n+            $(\"#user_\"+rand_number).html(userSteps[previousStep].text + \" until \" + (loop_start + count_in_loop) + \" done <i class=\\\"fas fa-thumbs-up\\\" style=\\\"color:green\\\"></i>\");\n+\n+            loop_start += count_in_loop;\n+            // --\n+        } else if (step !== 'nextUser' && loop_finished === \"true\") {\n+            // The loop on current topic is finished but still with same user\n+            $(\"#user_\"+rand_number).html(userSteps[previousStep].text + \" <i class=\\\"fas fa-thumbs-up\\\" style=\\\"color:green\\\"></i>\");\n+\n+            number = userSteps[step].number;\n+            loop_start = userSteps[step].start;\n+            // --\n+        } else if (step === 'nextUser') {\n+            // The treatment of current user is finished\n+            // Select next user\n+            $(\"#user_\"+rand_number)\n+                .html(userSteps[previousStep].text + \" <i class=\\\"fas fa-thumbs-up\\\" style=\\\"color:green\\\"></i>\");\n+\n+            $(\"#user_\"+rand_number).parent()\n+                .prepend('<div>' + getTime() +' - User ' + usersList[number].id + ' fully treated <i class=\"fas fa-thumbs-up\" style=\"color:green\"></i></div>');                    \n+\n+            // Have we handled all users\n+            // If not then restart at step2 for next user\n+            if ((parseInt(number)+1) < usersList.length) {\n+                number = userSteps[step].number;\n+                loop_start = userSteps[step].start;\n+                step = 'step2';\n+            } else {\n+                // Prepare list of users to be displayed\n+                if (usersList.length === 1 && usersList[0].login === 'TP') {\n+                    // do nothing and finish\n+                    sendPwdToUsers(usersList, true, 0, usersList.length);\n+                } else {\n+                    var htmlUsersList = '<i class=\"fas fa-info-circle mr-2\"></i>You could provide those unique codes to users by your own.<br><ul>';\n+                    $.each(usersList, function(index, user) {\n+                        htmlUsersList += '<li>User: '+user.name+' '+user.lastname+' (login: '+user.login+') ; OneTime code: '+user.otp+'</li>'\n+                    });\n+                    htmlUsersList += '</ul>';\n+\n+                    // Done\n+                    $(\"#user_\"+rand_number).parent()\n+                        .prepend(\n+                            '<div>' + getTime() +' - All keys have been generated for users <i class=\"fas fa-thumbs-up\" style=\"color:green\"></i>'+\n+                            '<br>'+\n+                            '<div type=\"button\" class=\"btn btn-primary btn-sm\" id=\"buttonListOfUsers\">Show/Hide list of users</div>'+\n+                            '<div class=\"hidden alert alert-secondary mt-2\" id=\"htmlListOfUsers\" role=\"alert\">'+htmlUsersList+'</div>'+\n+                            '</div>'\n+                        );\n+\n+                    // Act on button click\n+                    $(document).on('click', '#buttonListOfUsers', function() { \n+                        if ($('#htmlListOfUsers').hasClass('hidden') === true) {\n+                            $('#htmlListOfUsers').removeClass('hidden');\n+                        } else {\n+                            $('#htmlListOfUsers').addClass('hidden');\n+                        }\n+                    });\n+\n+                    console.log(usersList);\n+                    // Now send passwords\n+                    console.log(\"Send emails to users from now\");\n+                    sendPwdToUsers(usersList, true, 0, usersList.length);\n+                }\n \n-//---<END 3.0.8\n+                return;\n+            }\n+        }\n+        \n+        if (usersList.length === 0 && step === 'step2' && loop_finished === 'true' && number === 0 && loop_start === 0) {\n+            /* Unlock this step */\n+            document.getElementById(\"but_next\").disabled = \"\";\n+            document.getElementById(\"but_launch\").disabled = \"disabled\";\n+            \n+            $(\"#user_\"+rand_number).parent()\n+                .prepend('<div>' + getTime() +' - All steps have been successfully performed <i class=\"fas fa-thumbs-up\" style=\"color:green\"></i></div>'); \n+            return;\n+        } else {\n+            // Show progress\n+            rand_number = createRandomId();\n+            $(\"#step4_progress\").html(\"<div>\" + getTime() +\" - <span id='user_\"+rand_number+\"'>User \"+usersList[number].id+\" - Creating keys until \"+(loop_start + count_in_loop)+\" ... <i class=\\\"fas fa-cog fa-spin\\\" style=\\\"color:orange\\\"></i></span></div>\"+ $(\"#step4_progress\").html());\n \n+            // Prepare user information                \n+            userInfo = {\n+                'id' : usersList[number].id,\n+                'otp' : usersList[number].otp,\n+                'public_key' : usersList[number].public_key,\n+                'private_key' : usersList[number].private_key,\n+                'login' : usersList[number].login,\n+                'name' : encode_utf8(usersList[number].name),\n+                'lastname' : encode_utf8(usersList[number].lastname),\n+            };\n+        }\n+    }\n+    // Migrate if needed all account to new AES encryption\n+    //console.log('Posting number = '+number);\n+    $.post(\n+        \"upgrade_run_3.0.0_users.php\",\n+        {\n+            step : step,\n+            number : number === 'init' ? '' : number,\n+            userInfo : window.btoa(unescape(encodeURIComponent(JSON.stringify(userInfo)))),\n+            start : loop_start,\n+            count_in_loop : count_in_loop,\n+            info : $('#infotmp').val(),\n+            extra : number === 'end' ? 'all_users_created' : '',\n+            tp_user_done : tp_user_done,\n+        },\n+        function(data) {\n+            console.log(data[0]);\n+            //console.log(JSON.parse(window.atob(data[0].rest)));\n+            //console.log(JSON.parse(window.atob(data[0].data)));\n+            previousStep = step;\n \n-//--->BEGIN 3.0.9\n-// Add new setting 'reload_cache_table_task'\n-$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\" . $pre . \"misc` WHERE type = 'admin' AND intitule = 'reload_cache_table_task'\"));\n-if (intval($tmp) === 0) {\n-    mysqli_query(\n-        $db_link,\n-        \"INSERT INTO `\" . $pre . \"misc` (`type`, `intitule`, `valeur`) VALUES ('admin', 'reload_cache_table_task', '')\"\n+            if (data[0].finish !== \"1\") {\n+                // Manage list of users that is provide on number = 0\n+                if (number === 'init' && step === 'step1') {\n+                    if (data[0].rest !== '') {\n+                        usersRestList = JSON.parse(window.atob(data[0].rest));\n+                    }else {\n+                        usersRestList = '';\n+                    }\n+                    console.log(\"USERLIST = \"+usersRestList);\n+                }\n+\n+                // loop\n+                migrateUsersToV3(\n+                    data[0].next,\n+                    data[0].data,\n+                    data[0].number,\n+                    rand_number,\n+                    loop_start,\n+                    data[0].loop_finished,\n+                    1\n+                );\n+            } else {\n+                // Done\n+                /* Unlock this step */\n+                document.getElementById(\"but_next\").disabled = \"\";\n+                document.getElementById(\"but_launch\").disabled = \"disabled\";\n+            }\n+        },\n+        \"json\"\n     );\n }\n-// Add new setting 'rebuild_config_file'\n-$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\" . $pre . \"misc` WHERE type = 'admin' AND intitule = 'rebuild_config_file'\"));\n-if (intval($tmp) === 0) {\n-    mysqli_query(\n-        $db_link,\n-        \"INSERT INTO `\" . $pre . \"misc` (`type`, `intitule`, `valeur`) VALUES ('admin', 'rebuild_config_file', '')\"\n-    );\n-}// Add new setting 'purge_temporary_files_task'\n-$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\" . $pre . \"misc` WHERE type = 'admin' AND intitule = 'purge_temporary_files_task'\"));\n-if (intval($tmp) === 0) {\n-    mysqli_query(\n-        $db_link,\n-        \"INSERT INTO `\" . $pre . \"misc` (`type`, `intitule`, `valeur`) VALUES ('admin', 'purge_temporary_files_task', '')\"\n+\n+/**\n+* \n+ */\n+function sendPwdToUsers(usersList, init, cpt, total)\n+{\n+    var d = new Date();\n+\n+    // Inform\n+    if (init === true) {\n+        rand_number = createRandomId();\n+        $(\"#step4_progress\").html(\"<div>\" + getTime() +\" - <span id='user_\"+rand_number+\"'>Now sending new users password by email ... \" +\n+            \"<i class=\\\"fas fa-cog fa-spin\\\" style=\\\"color:orange\\\"></i><span id='sending_emails_pct' class='ml-3'>0%</span></div>\"+ $(\"#step4_progress\").html());\n+    }\n+    \n+    // Prepare user data to be sent\n+    userInfo = {\n+        'id' : usersList[0].id,\n+        'otp' : usersList[0].otp,\n+    };\n+    //console.log('Envoi email pour : ');\n+    //console.log(userInfo);\n+\n+    // Remove user from list\n+    usersList.shift();\n+\n+    // Send email for each user\n+    $.post(\n+        \"upgrade_run_3.0.0_users.php\",\n+        {\n+            step : 'send_pwd_by_email',\n+            userInfo : window.btoa(JSON.stringify(userInfo))\n+        },\n+        function(data) {\n+            //console.log(data);\n+            //console.log('----');\n+            // Done with sending the user email\n+            if (usersList.length === 0) {\n+                // all users have received their email\n+                $(\"#user_\"+rand_number)\n+                    .html(\"Emails were sent <i class=\\\"fas fa-thumbs-up\\\" style=\\\"color:green\\\"></i>\");\n+\n+                /* Unlock this step */\n+                document.getElementById(\"but_next\").disabled = \"\";\n+                document.getElementById(\"but_launch\").disabled = \"disabled\";\n+                \n+                $(\"#user_\"+rand_number).parent()\n+                .prepend('<div>' + getTime() +' - All steps have been successfully performed <i class=\"fas fa-thumbs-up\" style=\"color:green\"></i></div>'); \n+                \n+            } else {\n+                // current user received his email\n+                // Send to the next one\n+                $(\"#sending_emails_pct\").text(Math.round((cpt / total) * 100) + \"%\");\n+\n+                sendPwdToUsers(usersList, false, cpt++, total);\n+            }\n+        },\n+        \"json\"\n     );\n }\n-// Add new setting 'clean_orphan_objects_task'\n-$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\" . $pre . \"misc` WHERE type = 'admin' AND intitule = 'clean_orphan_objects_task'\"));\n-if (intval($tmp) === 0) {\n-    mysqli_query(\n-        $db_link,\n-        \"INSERT INTO `\" . $pre . \"misc` (`type`, `intitule`, `valeur`) VALUES ('admin', 'clean_orphan_objects_task', '')\"\n+\n+function runUpdate (script_file, type_parameter, start_at, noitems_by_loop, loop_number, file_number)\n+{\n+    var d = new Date(),\n+        info = '',\n+        text_action_in_progress = script_file;\n+    loop_number ++;\n+    var rand_number = createRandomId();\n+\n+    // Inform\n+    if (script_file === 'upgrade_operations.php') {\n+        text_action_in_progress = 'Performing operation ' + type_parameter;\n+    }\n+\n+    $(\"#step4_progress\").html(\"<div>\" + getTime() +\" - <i>\"+text_action_in_progress+\"</i> - Loop #\"+loop_number+\" <span id='span_\"+rand_number+\"'>is now running ... <i class=\\\"fas fa-cog fa-spin\\\" style=\\\"color:orange\\\"></i></span></div>\"+ $(\"#step4_progress\").html());\n+\n+    if (type_parameter === 'user_id') {\n+        info = $(\"#infotmp\").val();\n+    }\n+\n+    request = $.post(\n+        script_file,\n+        {\n+            type        : type_parameter,\n+            start       : start_at,\n+            total       : start_at,\n+            nb          : noitems_by_loop,\n+            session_salt: $(\"#session_salt\").val(),\n+            info        : info,\n+        },\n+        function(data) {\n+            console.info(type_parameter)\n+            console.log(data)\n+            // work not finished\n+            if (data[0].finish !== \"1\") {\n+                $(\"#span_\"+rand_number).html(\"<i class=\\\"fas fa-thumbs-up\\\" style=\\\"color:green\\\"></i>\")\n+                // loop\n+                runUpdate(script_file, type_parameter, data[0].next, noitems_by_loop, loop_number, file_number);\n+            // is there an error\n+            } else if (data[0].finish === \"1\" && data[0].error !== \"\") {\n+                $(\"#span_\"+rand_number).html(\"<i class=\\\"fas fa-thumbs-down\\\" style=\\\"color:red\\\"></i>\");\n+                $(\"#step4_progress\").html(\"<div style=\\\"margin:15px 0 15px 0; font-style:italic;\\\">\"+getTime() +\" - <b>ERROR</b>: \"+data[0].error+\"</div>\"+ $(\"#step4_progress\").html());\n+                $(\"#step4_progress\").html(\"<div>An error occurred. Please check and relaunch.</div>\"+ $(\"#step4_progress\").html());\n+            // work finished\n+            } else {\n+                $(\"#span_\"+rand_number).html(\"<i class=\\\"fas fa-thumbs-up\\\" style=\\\"color:green\\\"></i>\")\n+                // continue with next script file\n+                file_number ++;\n+                manageUpgradeScripts(file_number);\n+            }\n+        },\n+        \"json\"\n     );\n }\n-// Add new setting 'users_personal_folder_task'\n-$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\" . $pre . \"misc` WHERE type = 'admin' AND intitule = 'users_personal_folder_task'\"));\n-if (intval($tmp) === 0) {\n-    mysqli_query(\n-        $db_link,\n-        \"INSERT INTO `\" . $pre . \"misc` (`type`, `intitule`, `valeur`) VALUES ('admin', 'users_personal_folder_task', '')\"\n+\n+function newEncryptPw(suggestion)\n+{\n+    var nb = 20;\n+    var start = 0;\n+\n+    if ($(\"#change_pw_encryption_start\").val() != \"\") {\n+        start = $(\"#change_pw_encryption_start\").val();\n+    } else {\n+        $(\"#change_pw_encryption_progress\").html('Progress: 0% <i class=\"fas fa-cog fa-spin fa-2x\"></i>');\n+    }\n+    var request = $.post(\"upgrade_ajax.php\",\n+        {\n+            type        : \"new_encryption_of_pw\",\n+            start       : start,\n+            total       : $(\"#change_pw_encryption_total\").val(),\n+            suggestion  : suggestion,\n+            nb          : nb\n+        },\n+        function(data) {\n+            if (data[0].finish != 1 && data[0].finish != \"suggestion\") {\n+                // handle re-encryption of passwords in Items table\n+                $(\"#change_pw_encryption_start\").val(data[0].next);\n+                $(\"#change_pw_encryption_progress\").html('Progress: '+data[0].progress+'% <i class=\"fas fa-cog fa-spin fa-2x\"></i>');\n+                if (parseInt(start) < parseInt($(\"#change_pw_encryption_total\").val())) {\n+                    newEncryptPw(\"0\");\n+                }\n+            } else if (data[0].finish == \"suggestion\") {\n+                // handle the re-encryption of passwords in suggestion table\n+                newEncryptPw(\"1\");\n+            } else {\n+                // handle finishing\n+                $(\"#change_pw_encryption_progress\").html(\"Done\");\n+                $(\"#but_encrypt_continu\").hide();\n+                /* Unlock this step */\n+                document.getElementById(\"but_next\").disabled = \"\";\n+                document.getElementById(\"but_launch\").disabled = \"disabled\";\n+                document.getElementById(\"res_step4\").innerHTML = \"dataBase has been populated\";\n+                document.getElementById(\"loader\").style.display = \"none\";\n+            }\n+        },\n+        \"json\"\n     );\n+\n }\n \n-// Remove unused settings\n-mysqli_query(\n-    $db_link,\n-    \"DELETE FROM `\" . $pre . \"misc` WHERE `intitule`='maintenance_job_tasks';\"\n-);\n-mysqli_query(\n-    $db_link,\n-    \"DELETE FROM `\" . $pre . \"misc` WHERE `intitule`='maintenance_job_frequency';\"\n-);\n+function launch_database_dump() {\n+    alertify\n+        .message('<i class=\"fas fa-cog fa-spin fa-2x\"></i>', 0)\n+        .dismissOthers();\n \n-//---<END 3.0.9\n+    request = $.post(\n+        \"upgrade_ajax.php\",\n+        {\n+            type      : \"perform_database_dump\"\n+        },\n+        function(data) {\n+            console.log(data)\n+            if (data[0].error !== \"\") {\n+                // ERROR\n+                $(\"#dump_result\").html(data[0].error);\n \n-// Save timestamp\n-$tmp = mysqli_num_rows(mysqli_query($db_link, \"SELECT * FROM `\" . $pre . \"misc` WHERE type = 'admin' AND intitule = 'upgrade_timestamp'\"));\n-if (intval($tmp) === 0) {\n-    mysqli_query(\n-        $db_link,\n-        \"INSERT INTO `\" . $pre . \"misc` (`type`, `intitule`, `valeur`) VALUES ('admin', 'upgrade_timestamp', \".time().\")\"\n-    );\n-} else {\n-    mysqli_query(\n-        $db_link,\n-        \"UPDATE `\" . $pre . \"misc` SET valeur = \".time().\" WHERE type = 'admin' AND intitule = 'upgrade_timestamp'\"\n+                alertify\n+                    .Error('Error', 1)\n+                    .dismissOthers();\n+            } else {\n+                // DONE\n+                $(\"#dump_result\").html('<div class=\"alert alert-info mt-2\">Dump is successfull. File stored in file <b>' + data[0].filename + '</b></div>');\n+                $('#but_next').attr(\"disabled\", false);\n+                alertify\n+                    .success('Success', 1)\n+                    .dismissOthers();\n+            }\n+        },\n+        \"json\"\n     );\n }\n \n-//---< END 3.0.X upgrade steps\n+function createRandomId()\n+{\n+    var randLetter = String.fromCharCode(65 + Math.floor(Math.random() * 26));\n+    return randLetter + Date.now();\n+}\n+\n+function getTime()\n+{\n+    var d = new Date();\n+    return (\"0\" +d.getHours()).slice(-2)+\":\"+(\"0\" + d.getMinutes()).slice(-2)+\":\"+(\"0\" + d.getSeconds()).slice(-2)\n+}\n+\n+function encode_utf8( s )\n+{\n+  return unescape( encodeURIComponent( s ) );\n+}\n \n-// Close connection\n-mysqli_close($db_link);\n+</script>\n \n-// Finished\n-echo '[{\"finish\":\"1\" , \"next\":\"\", \"error\":\"\"}]';\n\\ No newline at end of file"
        },
        {
          "filename": "install/upgrade_scripts_manager.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -38,6 +38,7 @@\n     array('upgrade_run_3.0.0_suggestions.php', 'user_id'),\n     array('upgrade_run_3.0.0_files.php', 'user_id'),\n     array('upgrade_run_3.0.php', 'user_id'),\n+    array('upgrade_operations.php', '20230604_1'),\n );\n $param = '';\n "
        },
        {
          "filename": "pages/items.js.php",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -3688,7 +3688,7 @@ function(teampassItem) {\n                                     type: \"POST\",\n                                     async: false,\n                                     url: 'sources/items.queries.php',\n-                                    data: 'type=show_item_password&item_id=' + trigger.getAttribute('data-item-id') +\n+                                    data: 'type=show_item_password&item_key=' + trigger.getAttribute('data-item-key') +\n                                         '&key=<?php echo $_SESSION['key']; ?>',\n                                     dataType: \"\",\n                                     success: function(data) {\n@@ -3967,7 +3967,7 @@ function(teampassApplication) {\n                     }\n                     // Pwd icon\n                     if (value.pw_status !== 'pw_is_empty' && value.pw_status !== 'encryption_error') {\n-                        icon_pwd = '<span class=\"fa-stack fa-clickable fa-clickable-password pointer infotip mr-2\" title=\"<?php echo langHdl('item_menu_copy_pw'); ?>\" data-item-id=\"' + value.item_id + '\" data-item-label=\"' + value.label + '\"><i class=\"fas fa-circle fa-stack-2x\"></i><i class=\"fas fa-key fa-stack-1x fa-inverse\"></i></span>';\n+                        icon_pwd = '<span class=\"fa-stack fa-clickable fa-clickable-password pointer infotip mr-2\" title=\"<?php echo langHdl('item_menu_copy_pw'); ?>\" data-item-key=\"' + value.item_key + '\" data-item-label=\"' + value.label + '\"><i class=\"fas fa-circle fa-stack-2x\"></i><i class=\"fas fa-key fa-stack-1x fa-inverse\"></i></span>';\n                     }\n \n                     // Now check if pwd is empty. If it is then warn user"
        },
        {
          "filename": "sources/items.queries.php",
          "status": "modified",
          "additions": 7,
          "deletions": 4,
          "patch": "@@ -448,6 +448,7 @@\n                             'complexity_level' => $post_complexity_level,\n                             'encryption_type' => 'teampass_aes',\n                             'fa_icon' => $post_fa_icon,\n+                            'unique' => uniqidReal(50),\n                         )\n                     );\n                     $newID = DB::insertId();\n@@ -2609,6 +2610,7 @@\n                 $arrData['tags'] = $tags;\n                 $arrData['folder'] = (int) $dataItem['id_tree'];\n                 $arrData['fa_icon'] = $dataItem['fa_icon'];\n+                $arrData['item_key'] = $dataItem['item_key'];\n \n                 if (\n                     isset($SETTINGS['enable_server_password_change'])\n@@ -3815,7 +3817,7 @@\n                         $post_nb_items_to_display_once;\n                     //db::debugmode(true);\n                     $rows = DB::query(\n-                        'SELECT i.id AS id, MIN(i.restricted_to) AS restricted_to, MIN(i.perso) AS perso,\n+                        'SELECT i.id AS id, i.item_key AS item_key, MIN(i.restricted_to) AS restricted_to, MIN(i.perso) AS perso,\n                         MIN(i.label) AS label, MIN(i.description) AS description, MIN(i.pw) AS pw, MIN(i.login) AS login,\n                         MIN(i.anyone_can_modify) AS anyone_can_modify, l.date AS date, i.id_tree AS tree_id, i.fa_icon AS fa_icon,\n                         MIN(n.renewal_period) AS renewal_period,\n@@ -3836,7 +3838,7 @@\n                     $where->add('i.inactif=%i', 0);\n \n                     $rows = DB::query(\n-                        'SELECT i.id AS id, MIN(i.restricted_to) AS restricted_to, MIN(i.perso) AS perso,\n+                        'SELECT i.id AS id, i.item_key AS item_key, MIN(i.restricted_to) AS restricted_to, MIN(i.perso) AS perso,\n                         MIN(i.label) AS label, MIN(i.description) AS description, MIN(i.pw) AS pw, MIN(i.login) AS login,\n                         MIN(i.anyone_can_modify) AS anyone_can_modify,l.date AS date, i.id_tree AS tree_id, i.fa_icon AS fa_icon,\n                         MIN(n.renewal_period) AS renewal_period,\n@@ -3923,6 +3925,7 @@\n                         // Init\n                         $html_json[$record['id']]['expired'] = (int) $expired_item;\n                         $html_json[$record['id']]['item_id'] = (int) $record['id'];\n+                        $html_json[$record['id']]['item_key'] = (string) $record['item_key'];\n                         $html_json[$record['id']]['tree_id'] = (int) $record['tree_id'];\n                         $html_json[$record['id']]['label'] = strip_tags($record['label']);\n                         if (isset($SETTINGS['show_description']) === true && (int) $SETTINGS['show_description'] === 1) {\n@@ -4162,9 +4165,9 @@\n                 'SELECT i.pw AS pw, s.share_key AS share_key\n                 FROM ' . prefixTable('items') . ' AS i\n                 INNER JOIN ' . prefixTable('sharekeys_items') . ' AS s ON (s.object_id = i.id)\n-                WHERE user_id = %i AND i.id = %i',\n+                WHERE user_id = %i AND i.item_key = %i',\n                 $_SESSION['user_id'],\n-                $inputData['itemId']\n+                $inputData['item_key']\n             );\n \n             // Uncrypt PW"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 3,
        "max_directory_depth": 1
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "aacdf6a3f2daf9b52a826d4b3d8a39873e2e2062",
            "date": "2025-01-13T17:24:23Z",
            "author_login": "nilsteampassnet"
          },
          {
            "sha": "eb95bc3e37f6e1f19fce98aa4c44c251f2084cd7",
            "date": "2025-01-13T17:20:31Z",
            "author_login": "nilsteampassnet"
          },
          {
            "sha": "9969d0ef636e28c1afcdb047aac2d2a5387b62b5",
            "date": "2025-01-12T17:29:37Z",
            "author_login": "nilsteampassnet"
          },
          {
            "sha": "4963736272bc4b281586f8ad4dcee70015d595b1",
            "date": "2025-01-12T17:22:24Z",
            "author_login": "nilsteampassnet"
          },
          {
            "sha": "b5a997952a43e4760c9eaceedfd9a7ba4a5683d2",
            "date": "2025-01-10T16:06:22Z",
            "author_login": "nilsteampassnet"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.5,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:N/A:N",
    "cwe_id": "CWE-284",
    "description": "Improper Access Control in GitHub repository nilsteampassnet/teampass prior to 3.0.9.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-06-04T11:15:09.167",
    "last_modified": "2024-11-21T08:16:26.800",
    "fix_date": "2023-06-04T09:20:08Z"
  },
  "references": [
    {
      "url": "https://github.com/nilsteampassnet/teampass/commit/774985f62f080715774604927fba2cb6ef701612",
      "source": "security@huntr.dev",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/35c899a9-40a0-4e17-bfb5-2a1430bc83c4",
      "source": "security@huntr.dev",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/nilsteampassnet/teampass/commit/774985f62f080715774604927fba2cb6ef701612",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/35c899a9-40a0-4e17-bfb5-2a1430bc83c4",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:05:59.301450",
    "processing_status": "enhanced"
  }
}