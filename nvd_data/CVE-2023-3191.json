{
  "cve_id": "CVE-2023-3191",
  "github_data": {
    "repository": "nilsteampassnet/teampass",
    "fix_commit": "241dbd4159a5d63b55af426464d30dbb53925705",
    "related_commits": [
      "241dbd4159a5d63b55af426464d30dbb53925705",
      "241dbd4159a5d63b55af426464d30dbb53925705"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "241dbd4159a5d63b55af426464d30dbb53925705",
      "commit_date": "2023-06-10T07:30:21Z",
      "author": {
        "login": "nilsteampassnet",
        "type": "User",
        "stats": {
          "total_commits": 2012,
          "average_weekly_commits": 2.9415204678362574,
          "total_additions": 5301385,
          "total_deletions": 4813706,
          "weeks_active": 411
        }
      },
      "commit_message": {
        "title": "3.0.9",
        "length": 53,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 430,
        "additions": 273,
        "deletions": 157
      },
      "files": [
        {
          "filename": "includes/js/functions.js",
          "status": "modified",
          "additions": 123,
          "deletions": 26,
          "patch": "@@ -390,34 +390,14 @@ if (typeof String.prototype.utf8Decode == 'undefined') {\n     };\n }\n \n-function fieldSanitizeStep1(\n-    field,\n-    bHtml=true,\n-    bSvg=true,\n-    bSvgFilters=true,\n-    text=''\n+function simplePurifier(\n+    text,\n+    bHtml = false,\n+    bSvg = false,\n+    bSvgFilters = false\n )\n {\n-    if (field === undefined ||field === '') {\n-        return false;\n-    }\n-    let string = '';\n-    text = (text === '') ? $(field).val() : text;\n-/*\n-    // Sanitize string\n-    var tagsToReplace = {\n-        '&': '&amp;',\n-        '<': '&lt;',\n-        '>': '&gt;',\n-        \"'\" : '&#39;',\n-        '\"' : '&quot;'\n-    };\n-    text = text.replace(/[&<>'\"]/g, function(tag) {\n-        return tagsToReplace[tag] || tag;\n-    });\n-    */\n-    // Purify string\n-    string = DOMPurify.sanitize(\n+    return DOMPurify.sanitize(\n         text\n             .replaceAll('&lt;', '<')\n             .replaceAll('&gt;', '>')\n@@ -426,12 +406,129 @@ function fieldSanitizeStep1(\n             .replaceAll('&#39;', \"'\"),\n         {USE_PROFILES: {html:bHtml, svg:bSvg, svgFilters: bSvgFilters}}\n     );\n+}\n+\n+/**\n+ * Permits to purify the content of a string using domPurify\n+ * @param {*} field \n+ * @param {*} bHtml \n+ * @param {*} bSvg \n+ * @param {*} bSvgFilters \n+ * @param {*} text \n+ * @returns bool||string\n+ */\n+function fieldDomPurifier(\n+    field,\n+    bHtml = false,\n+    bSvg = false,\n+    bSvgFilters = false,\n+    text = ''\n+)\n+{\n+    if (field === undefined ||field === '') {\n+        return false;\n+    }\n+    let string = '';\n+    text = (text === '') ? $(field).val() : text;\n+\n+    // Purify string\n+    string = simplePurifier(text, bHtml, bSvg, bSvgFilters);\n     \n     // Clear field if string is empty and warn user\n     if (string === '' && text !== '') {\n         $(field).val('');\n         return false;\n     }\n \n+    return string;\n+}\n+\n+/**\n+ * Permits to get all fields of a class and purify them\n+ * @param {*} elementClass \n+ * @returns array\n+ */\n+function fieldDomPurifierLoop(elementClass)\n+{\n+    let purifyStop = false,\n+        arrFields = [];\n+    $.each($(elementClass), function(index, element) {\n+        purifiedField = fieldDomPurifier(\n+            '#' + $(element).attr('id'), \n+            $(element).hasClass('purifyHtml') === true ? true : false,\n+            $(element).hasClass('purifySvg') === true ? true : false,\n+            $(element).hasClass('purifySvgFilter') === true ? true : false,\n+            typeof $(element).data('purify-text') !== undefined ? $(element).data('purify-text') : ''\n+        );\n+\n+        if (purifiedField === false) {\n+            // Label is empty\n+            toastr.remove();\n+            toastr.warning(\n+                'XSS attempt detected. Please remove all special characters from your input.',\n+                'Error', {\n+                    timeOut: 5000,\n+                    progressBar: true\n+                }\n+            );\n+            $('#' + $(element).attr('id')).focus();\n+            purifyStop = true;\n+            return {\n+                'purifyStop' : purifyStop,\n+                'arrFields' : arrFields\n+            };\n+        } else {\n+            $(element).val(purifiedField);\n+            arrFields[$(element).data('field')] = purifiedField;\n+        }\n+    });\n+    \n+    // return\n+    return {\n+        'purifyStop' : purifyStop,\n+        'arrFields' : arrFields\n+    };\n+}\n+\n+/**\n+ * Permits to purify the content of a string using domPurify\n+ * @param {*} field \n+ * @param {*} bHtml \n+ * @param {*} bSvg \n+ * @param {*} bSvgFilters \n+ * @returns bool||string\n+ */\n+function fieldDomPurifierWithWarning(\n+    field,\n+    bHtml = false,\n+    bSvg = false,\n+    bSvgFilters = false,\n+)\n+{\n+    if (field === undefined || field === '') {\n+        return false;\n+    }\n+    if ($(field).val() === '') {\n+        return '';\n+    }\n+    let string = '';\n+\n+    // Purify string\n+    string = simplePurifier($(field).val(), bHtml, bSvg, bSvgFilters);\n+    \n+    // Clear field if string is empty and warn user\n+    if (string === '') {\n+        toastr.remove();\n+        toastr.warning(\n+            'XSS attempt detected. Please remove all special characters from your input.',\n+            'Error', {\n+                timeOut: 5000,\n+                progressBar: true\n+            }\n+        );\n+        $(field).focus();\n+        return false;\n+    }\n+\n     return string;\n }\n\\ No newline at end of file"
        },
        {
          "filename": "pages/admin.js.php",
          "status": "modified",
          "additions": 7,
          "deletions": 0,
          "patch": "@@ -134,6 +134,13 @@ function(data) {\n             return false;\n         }\n \n+        // Sanitize value\n+        value = fieldDomPurifierWithWarning('#' + field);\n+        if (value === false) {\n+            return false;\n+        }\n+        $('#' + field).val(value);\n+\n         requestRunning = true;\n \n         var data = {"
        },
        {
          "filename": "pages/api.js.php",
          "status": "modified",
          "additions": 19,
          "deletions": 5,
          "patch": "@@ -65,10 +65,17 @@\n         if ($('#new_api_key_label') === '') {\n             return false;\n         }\n+        \n+        // Sanitize text fields\n+        purifyRes = fieldDomPurifierLoop('#new_api_key_label');\n+        if (purifyRes.purifyStop === true) {\n+            // if purify failed, stop\n+            return false;\n+        }\n \n         // Prepare data\n         var data = {\n-            'label': $('#new_api_key_label').val(),\n+            'label': purifyRes.arrFields['label'], //$('#new_api_key_label').val(),\n             'action': 'add',\n         }\n \n@@ -196,7 +203,7 @@ function(data) {\n \n     $(document).on('click', '#new-api-key-save', function() {\n         var keyId = $(this).closest('tr').data('id'),\n-            label = $(this).prev('input').val(),\n+            label = simplePurifier($(this).prev('input').val()),\n             cell = $(this).closest('td');\n \n         // Prepare data\n@@ -205,7 +212,7 @@ function(data) {\n             'label': label,\n             'action': 'update',\n         }\n-\n+        \n         // Launch action\n         $.post(\n             'sources/admin.queries.php', {\n@@ -258,9 +265,16 @@ function(data) {\n             return false;\n         }\n \n+        // Sanitize text fields\n+        purifyRes = fieldDomPurifierLoop('#new-api-ip .purify');\n+        if (purifyRes.purifyStop === true) {\n+            // if purify failed, stop\n+            return false;\n+        }\n+\n         // Prepare data\n         var data = {\n-            'label': $('#new_api_ip_label').val(),\n+            'label': purifyRes.arrFields['label'],\n             'ip': $('#new_api_ip_value').val(),\n             'action': 'add',\n         }\n@@ -398,7 +412,7 @@ function(data) {\n         // Prepare data\n         var data = {\n             'id': ipId,\n-            'value': label,\n+            'value': simplePurifier(label),\n             'field': field,\n             'action': 'update',\n         }"
        },
        {
          "filename": "pages/api.php",
          "status": "modified",
          "additions": 4,
          "deletions": 4,
          "patch": "@@ -161,7 +161,7 @@\n                                         <span class=\"text-bold\"><?php echo langHdl('adding_new_api_key'); ?></span>\n \n                                         <div class=\"row mt-1 ml-1\">\n-                                            <input type=\"text\" placeholder=\"<?php echo langHdl('label'); ?>\" class=\"col-4 form-control form-control-sm\" id=\"new_api_key_label\">\n+                                            <input type=\"text\" placeholder=\"<?php echo langHdl('label'); ?>\" class=\"col-4 form-control form-control-sm purify\" id=\"new_api_key_label\" data-field=\"label\">\n                                             <span class=\"fa-stack ml-2 infotip pointer\" title=\"<?php echo langHdl('adding_new_api_key'); ?>\" id=\"button-new-api-key\">\n                                                 <i class=\"fas fa-square fa-stack-2x\"></i>\n                                                 <i class=\"fas fa-plus fa-stack-1x fa-inverse\"></i>\n@@ -211,13 +211,13 @@\n                                     </div>\n                                 </div>\n \n-                                <div class=\"form-group mt-4\">\n+                                <div class=\"form-group mt-4\" id=\"new-api-ip\">\n                                     <div class=\"callout callout-info\">\n                                         <span class=\"text-bold\"><?php echo langHdl('adding_new_api_ip'); ?></span>\n \n                                         <div class=\"row mt-1 ml-1\">\n-                                            <input type=\"text\" placeholder=\"<?php echo langHdl('ip'); ?>\" class=\"col-4 form-control\" id=\"new_api_ip_value\" data-inputmask=\"'alias': 'ip'\" data-mask>\n-                                            <input type=\"text\" placeholder=\"<?php echo langHdl('label'); ?>\" class=\"col-4 form-control ml-2\" id=\"new_api_ip_label\">\n+                                            <input type=\"text\" placeholder=\"<?php echo langHdl('ip'); ?>\" class=\"col-4 form-control\" id=\"new_api_ip_value\" data-inputmask=\"'alias': 'ip'\">\n+                                            <input type=\"text\" placeholder=\"<?php echo langHdl('label'); ?>\" class=\"col-4 form-control ml-2 purify\" id=\"new_api_ip_label\" data-field=\"label\">\n                                             <span class=\"fa-stack ml-2 infotip pointer\" title=\"<?php echo langHdl('settings_api_add_ip'); ?>\" id=\"button-new-api-ip\">\n                                                 <i class=\"fas fa-square fa-stack-2x\"></i>\n                                                 <i class=\"fas fa-plus fa-stack-1x fa-inverse\"></i>"
        },
        {
          "filename": "pages/backups.js.php",
          "status": "modified",
          "additions": 3,
          "deletions": 3,
          "patch": "@@ -96,7 +96,7 @@ function(data) {\n \n                 // Prepare data\n                 var data = {\n-                    'encryptionKey': $('#onthefly-backup-key').val(),\n+                    'encryptionKey': simplePurifier($('#onthefly-backup-key').val()),\n                 };\n \n                 //send query\n@@ -125,7 +125,7 @@ function(data) {\n                             // Store KEY in DB\n                             var newData = {\n                                 \"field\": 'bck_script_passkey',\n-                                \"value\": $('#onthefly-backup-key').val(),\n+                                \"value\": simplePurifier($('#onthefly-backup-key').val()),\n                             }\n \n                             $.post(\n@@ -193,7 +193,7 @@ function(data) {\n \n                 // Prepare data\n                 var data = {\n-                    'encryptionKey': $('#onthefly-restore-key').val(),\n+                    'encryptionKey': simplePurifier($('#onthefly-restore-key').val()),\n                     'backupFile': $('#onthefly-restore-file').data('operation-id')\n                 };\n                 console.log(data);"
        },
        {
          "filename": "pages/emails.js.php",
          "status": "modified",
          "additions": 0,
          "deletions": 47,
          "patch": "@@ -145,52 +145,5 @@ function(data) {\n         );\n     }\n \n-\n-    $(document).on('click', '#button-duo-save', function() {\n-        // Prepare data\n-        var data = {\n-            'akey': $('#duo_akey').val(),\n-            'ikey': $('#duo_ikey').val(),\n-            'skey': $('#duo_skey').val(),\n-            'host': $('#duo_host').val(),\n-        }\n-        console.log(data);\n-\n-        // Launch action\n-        $.post(\n-            'sources/admin.queries.php', {\n-                type: 'save_duo_in_sk_file',\n-                data: prepareExchangedData(JSON.stringify(data), \"encode\", \"<?php echo $_SESSION['key']; ?>\"),\n-                key: '<?php echo $_SESSION['key']; ?>'\n-            },\n-            function(data) {\n-                //decrypt data\n-                data = decodeQueryReturn(data, '<?php echo $_SESSION['key']; ?>');\n-\n-                if (data.error === true) {\n-                    // ERROR\n-                    toastr.remove();\n-                    toastr.warning(\n-                        '<?php echo langHdl('none_selected_text'); ?>',\n-                        '', {\n-                            timeOut: 5000,\n-                            progressBar: true\n-                        }\n-                    );\n-                } else {\n-                    // Inform user\n-                    toastr.remove();\n-                    toastr.success(\n-                        '<?php echo langHdl('done'); ?>',\n-                        '', {\n-                            timeOut: 1000\n-                        }\n-                    );\n-                }\n-            }\n-        );\n-    });\n-\n-\n     //]]>\n </script>"
        },
        {
          "filename": "pages/folders.js.php",
          "status": "modified",
          "additions": 26,
          "deletions": 11,
          "patch": "@@ -96,17 +96,25 @@\n \n         } else if ($(this).data('action') === 'new-submit') {\n             //--- SAVE NEW FOLDER\n+\n+            // Sanitize text fields\n+            purifyRes = fieldDomPurifierLoop('#folder-new .purify');\n+            if (purifyRes.purifyStop === true) {\n+                // if purify failed, stop\n+                return false;\n+            }\n+\n             // Prepare data\n             var data = {\n-                'title': DOMPurify.sanitize($('#new-title').val()),\n+                'title': purifyRes.arrFields['title'],\n                 'parentId': parseInt($('#new-parent').val()),\n                 'complexity': parseInt($('#new-complexity').val()),\n                 'accessRight': $('#new-access-right').val(),\n-                'renewalPeriod': DOMPurify.sanitize($('#new-renewal').val() === '' ? 0 : parseInt($('#new-renewal').val())),\n+                'renewalPeriod': $('#new-renewal').val() === '' ? 0 : parseInt($('#new-renewal').val()),\n                 'addRestriction': $('#new-add-restriction').prop(\"checked\") === true ? 1 : 0,\n                 'editRestriction': $('#new-edit-restriction').prop(\"checked\") === true ? 1 : 0,\n-                'icon': DOMPurify.sanitize($('#new-folder-add-icon').val(), {USE_PROFILES: {html: true}}),\n-                'iconSelected': DOMPurify.sanitize($('#new-folder-add-icon-selected').val(), {USE_PROFILES: {html: true}}),\n+                'icon': purifyRes.arrFields['icon'],\n+                'iconSelected': purifyRes.arrFields['iconSelected'],\n             }\n             console.log(data)\n             // Launch action\n@@ -647,7 +655,7 @@ function(data) {\n             '<div class=\"card-body\">' +\n             '<div class=\"form-group ml-2\">' +\n             '<label for=\"folder-edit-title\"><?php echo langHdl('label'); ?></label>' +\n-            '<input type=\"text\" class=\"form-control clear-me\" id=\"folder-edit-title\" value=\"' + folderTitle + '\">' +\n+            '<input type=\"text\" class=\"form-control clear-me purify\" id=\"folder-edit-title\" data-field=\"title\" value=\"' + folderTitle + '\">' +\n             '</div>' +\n             '<div class=\"form-group ml-2\">' +\n             '<label for=\"folder-edit-parent\"><?php echo langHdl('parent'); ?></label><br>' +\n@@ -663,14 +671,14 @@ function(data) {\n             '</div>' +\n             '<div class=\"form-group ml-2\">' +\n             '<label><?php echo langHdl('icon'); ?></label>' +\n-            '<input type=\"text\" class=\"form-control form-folder-control\" id=\"folder-edit-icon\" value=\"'+folderIcon+'\">' +\n+            '<input type=\"text\" class=\"form-control form-folder-control purify\" id=\"folder-edit-icon\" data-field=\"icon\" value=\"'+folderIcon+'\">' +\n             '<small class=\"form-text text-muted\">' +\n             '<?php echo langHdl('fontawesome_icon_tip'); ?><a href=\"<?php echo FONTAWESOME_URL;?>\" target=\"_blank\"><i class=\"fas fa-external-link-alt ml-1\"></i></a>' +\n             '</small>' +\n             '</div>' +\n             '<div class=\"form-group ml-2\">' +\n             '<label><?php echo langHdl('icon_on_selection'); ?></label>' +\n-            '<input type=\"text\" class=\"form-control form-folder-control\" id=\"folder-edit-icon-selected\" value=\"'+folderIconSelection+'\">' +\n+            '<input type=\"text\" class=\"form-control form-folder-control purify\" id=\"folder-edit-icon-selected\" data-field=\"iconSelected\" value=\"'+folderIconSelection+'\">' +\n             '<small class=\"form-text text-muted\">' +\n             '<?php echo langHdl('fontawesome_icon_tip'); ?><a href=\"<?php echo FONTAWESOME_URL;?>\" target=\"_blank\"><i class=\"fas fa-external-link-alt ml-1\"></i></a>' +\n             '</small>' +\n@@ -738,17 +746,24 @@ function(data) {\n                 selectedFolders.push($(this).data('id'));\n             });\n \n+            // Sanitize text fields\n+            purifyRes = fieldDomPurifierLoop('#table-folders .purify');\n+            if (purifyRes.purifyStop === true) {\n+                // if purify failed, stop\n+                return false;\n+            }\n+\n             // Prepare data\n             var data = {\n                 'id': currentFolderId,\n-                'title': DOMPurify.sanitize($('#folder-edit-title').val()),\n+                'title': purifyRes.arrFields['title'],    //$('#folder-edit-title').val(),\n                 'parentId': $('#folder-edit-parent').val(),\n                 'complexity': $('#folder-edit-complexity').val(),\n-                'renewalPeriod': DOMPurify.sanitize($('#folder-edit-renewal').val()),\n+                'renewalPeriod': $('#new-renewal').val() === '' ? 0 : parseInt($('#new-renewal').val()),\n                 'addRestriction': $('#folder-edit-add-restriction').prop(\"checked\") === true ? 1 : 0,\n                 'editRestriction': $('#folder-edit-edit-restriction').prop(\"checked\") === true ? 1 : 0,\n-                'icon': DOMPurify.sanitize($('#folder-edit-icon').val(), {USE_PROFILES: {html: true}}),\n-                'iconSelected': DOMPurify.sanitize($('#folder-edit-icon-selected').val(), {USE_PROFILES: {html: true}})\n+                'icon': purifyRes.arrFields['icon'],    //$('#folder-edit-icon').val(),\n+                'iconSelected': purifyRes.arrFields['iconSelected'],    //$('#folder-edit-icon-selected').val(),\n             }\n             console.log(data)\n             // Launch action"
        },
        {
          "filename": "pages/folders.php",
          "status": "modified",
          "additions": 4,
          "deletions": 4,
          "patch": "@@ -143,7 +143,7 @@\n                             <div class=\"card-body\">\n                                 <div class=\"form-group\">\n                                     <label for=\"new-title\"><?php echo langHdl('label'); ?></label>\n-                                    <input type=\"text\" class=\"form-control clear-me\" id=\"new-title\">\n+                                    <input type=\"text\" class=\"form-control clear-me purify\" id=\"new-title\" data-field=\"title\">\n                                 </div>\n                                 <div class=\"form-group\">\n                                     <label for=\"new-parent\"><?php echo langHdl('parent'); ?></label>\n@@ -171,14 +171,14 @@\n                                 </div>\n                                 <div class=\"form-group\">\n                                     <label><?php echo langHdl('icon'); ?></label>\n-                                    <input type=\"text\" class=\"form-control form-folder-control\" id=\"new-folder-add-icon\">\n+                                    <input type=\"text\" class=\"form-control form-folder-control purify\" id=\"new-folder-add-icon\" data-field=\"icon\">\n                                     <small class='form-text text-muted'>\n                                         <?php echo langHdl('fontawesome_icon_tip'); ?><a href=\"<?php echo FONTAWESOME_URL;?>\" target=\"_blank\"><i class=\"fas fa-external-link-alt ml-1\"></i></a>\n                                     </small>\n                                 </div>\n                                 <div class=\"form-group\">\n                                     <label><?php echo langHdl('icon_on_selection'); ?></label>\n-                                    <input type=\"text\" class=\"form-control form-folder-control\" id=\"new-folder-add-icon-selected\">\n+                                    <input type=\"text\" class=\"form-control form-folder-control purify\" id=\"new-folder-add-icon-selected\" data-field=\"iconSelected\">\n                                     <small class='form-text text-muted'>\n                                         <?php echo langHdl('fontawesome_icon_tip'); ?><a href=\"<?php echo FONTAWESOME_URL;?>\" target=\"_blank\"><i class=\"fas fa-external-link-alt ml-1\"></i></a>\n                                     </small>\n@@ -193,7 +193,7 @@\n                                         <input type=\"checkbox\" class=\"form-check-input form-control\" id=\"new-edit-restriction\">\n                                         <label for=\"new-edit-restriction\" class=\"form-check-label pointer ml-2\"><?php echo langHdl('edit_without_password_minimal_complexity_target'); ?></label>\n                                     </div>\n-</div>\n+                                </div>\n                             </div>\n                             <!-- /.card-body -->\n "
        },
        {
          "filename": "pages/items.js.php",
          "status": "modified",
          "additions": 45,
          "deletions": 18,
          "patch": "@@ -1680,9 +1680,9 @@ function(data) {\n         userUploadedFile = false;\n \n         // Sanitize text fields\n-        let formLabel = fieldSanitizeStep1('#form-folder-add-label', false, false, false),\n-            formIcon = fieldSanitizeStep1('#form-folder-add-icon', false, false, false),\n-            formIconSelected = fieldSanitizeStep1('#form-folder-add-icon-selected', false, false, false);\n+        let formLabel = fieldDomPurifier('#form-folder-add-label', false, false, false),\n+            formIcon = fieldDomPurifier('#form-folder-add-icon', false, false, false),\n+            formIconSelected = fieldDomPurifier('#form-folder-add-icon-selected', false, false, false);\n         if (formLabel === false || formIcon === false || formIconSelected === false) {\n             // Label is empty\n             toastr.remove();\n@@ -2115,6 +2115,7 @@ function(teampassUser) {\n \n             // Load item info\n             Details(\n+                //$(this).hasClass('but-prev-item') === true ? $('#list-item-row_' + $(this).attr('data-prev-item-key')) : $('#list-item-row_' + $(this).attr('data-next-item-key')),\n                 $(this).hasClass('but-prev-item') === true ? $('#list-item-row_' + $(this).attr('data-prev-item-id')) : $('#list-item-row_' + $(this).attr('data-next-item-id')),\n                 'show'\n             );\n@@ -2677,12 +2678,12 @@ function(teampassApplication) {\n             var reg = new RegExp(\"[.|,|;|:|!|=|+|-|*|/|#|\\\"|'|&]\");\n \n             // Sanitize text fields\n-            let formLabel = fieldSanitizeStep1('#form-item-label', false, false, false),\n-                formDescription = $('#form-item-description').summernote('code') !== \"<p><br></p>\" ? fieldSanitizeStep1('#form-item-description', true, false, false, $('#form-item-description').summernote('code')) : '',\n-                formEmail = fieldSanitizeStep1('#form-item-email'),\n-                formTags = fieldSanitizeStep1('#form-item-tags'),\n-                formUrl = fieldSanitizeStep1('#form-item-url'),\n-                formIcon = fieldSanitizeStep1('#form-item-icon');\n+            let formLabel = fieldDomPurifier('#form-item-label', false, false, false),\n+                formDescription = $('#form-item-description').summernote('code') !== \"<p><br></p>\" ? fieldDomPurifier('#form-item-description', true, false, false, $('#form-item-description').summernote('code')) : '',\n+                formEmail = fieldDomPurifier('#form-item-email'),\n+                formTags = fieldDomPurifier('#form-item-tags'),\n+                formUrl = fieldDomPurifier('#form-item-url'),\n+                formIcon = fieldDomPurifier('#form-item-icon');\n             if (formLabel === false || formDescription === false || formEmail === false || formTags === false || formUrl === false || formIcon === false) {\n                 // Label is empty\n                 toastr.remove();\n@@ -3948,8 +3949,12 @@ function(teampassApplication) {\n                     console.log(prevIdForNextItem);\n                 }\n                 if (prevIdForNextItem !== -1) {\n-                    $('#list-item-row_' + value.item_id).attr('data-next-item-id', prevIdForNextItem.item_id);\n-                    $('#list-item-row_' + value.item_id).attr('data-next-item-label', value.label);\n+                    //$('#list-item-row_' + value.item_id).attr('data-next-item-id', prevIdForNextItem.item_id);\n+                    //$('#list-item-row_' + value.item_id).attr('data-next-item-label', value.label);\n+                    $('[data-item-key=\"'+value.item_key+'\"]')\n+                        //.attr('data-next-item-id', prevIdForNextItem.item_id)\n+                        .attr('data-next-item-key', prevIdForNextItem.item_key)\n+                        .attr('data-next-item-label', value.label);\n                 }\n                 \n                 // Prepare anyone can modify icon\n@@ -3986,9 +3991,9 @@ function(teampassApplication) {\n                     value.rights > 10\n                 ) {\n                     if (value.is_favourited === 1) {\n-                        icon_favorite = '<span class=\"fa-stack fa-clickable item-favourite pointer infotip mr-2\" title=\"<?php echo langHdl('unfavorite'); ?>\" data-item-id=\"' + value.item_id + '\" data-item-favourited=\"1\"><i class=\"fas fa-circle fa-stack-2x\"></i><i class=\"fas fa-star fa-stack-1x fa-inverse text-warning\"></i></span>';\n+                        icon_favorite = '<span class=\"fa-stack fa-clickable item-favourite pointer infotip mr-2\" title=\"<?php echo langHdl('unfavorite'); ?>\" data-item-id=\"' + value.item_id + '\" data-item-key=\"' + value.item_key + '\" data-item-favourited=\"1\"><i class=\"fas fa-circle fa-stack-2x\"></i><i class=\"fas fa-star fa-stack-1x fa-inverse text-warning\"></i></span>';\n                     } else {\n-                        icon_favorite = '<span class=\"fa-stack fa-clickable item-favourite pointer infotip mr-2\" title=\"<?php echo langHdl('favorite'); ?>\" data-item-id=\"' + value.item_id + '\" data-item-favourited=\"0\"><i class=\"fas fa-circle fa-stack-2x\"></i><i class=\"far fa-star fa-stack-1x fa-inverse\"></i></span>';\n+                        icon_favorite = '<span class=\"fa-stack fa-clickable item-favourite pointer infotip mr-2\" title=\"<?php echo langHdl('favorite'); ?>\" data-item-id=\"' + value.item_id + '\" data-item-key=\"' + value.item_key + '\" data-item-favourited=\"0\"><i class=\"fas fa-circle fa-stack-2x\"></i><i class=\"far fa-star fa-stack-1x fa-inverse\"></i></span>';\n                     }\n                 }\n \n@@ -3998,7 +4003,7 @@ function(teampassApplication) {\n                 }\n \n                 $('#teampass_items_list').append(\n-                    '<tr class=\"list-item-row' + (value.canMove === 1 ? ' is-draggable' : '') + '\" id=\"list-item-row_' + value.item_id + '\" data-item-edition=\"' + value.open_edit + '\" data-item-id=\"' + value.item_id + '\" data-item-sk=\"' + value.sk + '\" data-item-expired=\"' + value.expired + '\" data-item-rights=\"' + value.rights + '\" data-item-display=\"' + value.display + '\" data-item-open-edit=\"' + value.open_edit + '\" data-item-tree-id=\"' + value.tree_id + '\" data-is-search-result=\"' + value.is_result_of_search + '\" data-label=\"' + escape(value.label) + '\">' +\n+                    '<tr class=\"list-item-row' + (value.canMove === 1 ? ' is-draggable' : '') + '\" id=\"list-item-row_' + value.item_id + '\" data-item-key=\"' + value.item_key + '\" data-item-edition=\"' + value.open_edit + '\" data-item-id=\"' + value.item_id + '\" data-item-sk=\"' + value.sk + '\" data-item-expired=\"' + value.expired + '\" data-item-rights=\"' + value.rights + '\" data-item-display=\"' + value.display + '\" data-item-open-edit=\"' + value.open_edit + '\" data-item-tree-id=\"' + value.tree_id + '\" data-is-search-result=\"' + value.is_result_of_search + '\" data-label=\"' + escape(value.label) + '\">' +\n                     '<td class=\"list-item-description\" style=\"width: 100%;\">' +\n                     // Show user a grippy bar to move item\n                     (value.canMove === 1  ? '<i class=\"fas fa-ellipsis-v mr-2 dragndrop\"></i>' : '') + //&& value.is_result_of_search === 0\n@@ -4011,7 +4016,7 @@ function(teampassApplication) {\n                     // Show item fa_icon if set\n                     (value.fa_icon !== '' ? '<i class=\"'+value.fa_icon+' mr-1\"></i>' : '') +\n                     // Prepare item info\n-                    '<span class=\"list-item-clicktoshow' + (value.rights === 10 ? '' : ' pointer') + '\" data-item-id=\"' + value.item_id + '\">' +\n+                    '<span class=\"list-item-clicktoshow' + (value.rights === 10 ? '' : ' pointer') + '\" data-item-id=\"' + value.item_id + '\" data-item-key=\"' + value.item_key + '\">' +\n                     '<span class=\"list-item-row-description' + (value.rights === 10 ? ' font-weight-light' : '') + '\">' + value.label + '</span>' + (value.rights === 10 ? '' : value.desc) + '</span>' +\n                     '<span class=\"list-item-actions hidden\">' +\n                     (value.rights === 10 ?\n@@ -4027,7 +4032,8 @@ function(teampassApplication) {\n \n                 // Save id for usage\n                 prevIdForNextItem = {\n-                    'item_id' : value.item_id,\n+                    //'item_id' : value.item_id,\n+                    'item_key' : value.item_key,\n                     'label': value.label,\n                 };\n \n@@ -4216,11 +4222,15 @@ function(data) {\n      *\n      */\n     function Details(itemDefinition, actionType, hotlink = false) {\n-        if (debugJavascript === true) console.info('EXPECTED ACTION on ' + itemDefinition + ' is ' + actionType + ' -- ')\n+        if (debugJavascript === true) {\n+            console.info('EXPECTED ACTION on ' + itemDefinition + ' is ' + actionType + ' -- ');\n+            console.log(itemDefinition);\n+        }\n \n         // Init\n         if (hotlink === false) {\n             var itemId = parseInt($(itemDefinition).data('item-id')) || '';\n+            var itemKey = parseInt($(itemDefinition).data('item-key')) || '';\n             var itemTreeId = parseInt($(itemDefinition).data('item-tree-id')) || '';\n             var itemSk = parseInt($(itemDefinition).data('item-sk')) || 0;\n             var itemExpired = parseInt($(itemDefinition).data('item-expired')) || '';\n@@ -4231,6 +4241,7 @@ function Details(itemDefinition, actionType, hotlink = false) {\n             var itemRights = parseInt($(itemDefinition).data('item-rights')) || 10;\n         } else {\n             var itemId = itemDefinition || '';\n+            var itemKey = itemDefinition || '';\n             var itemTreeId = store.get('teampassApplication').selectedFolder || '';\n             var itemSk = 0;\n             var itemExpired = '';\n@@ -4885,8 +4896,24 @@ function(teampassItem) {\n                         .attr('data-next-item-id', $('#list-item-row_'+data.id).next('.list-item-row').attr('data-item-id'))\n                         .removeClass('hidden');\n                 }\n+\n+                /*\n+                dataItemKey = $('[data-item-key=\"'+data.item_key+'\"]');\n+                if (dataItemKey.prev('.list-item-row').attr('data-item-key') !== undefined) {\n+                    $('.but-prev-item')\n+                        .html('<i class=\"fas fa-arrow-left mr-2\"></i>' + unescape(dataItemKey.prev('.list-item-row').attr('data-label')))\n+                        .attr('data-prev-item-key', dataItemKey.attr('data-item-key'))\n+                        .removeClass('hidden');\n+                }\n+                if (dataItemKey.next('.list-item-row').attr('data-item-key') !== undefined) {\n+                    $('.but-next-item')\n+                        .html('<i class=\"fas fa-arrow-right mr-2\"></i>' + unescape(dataItemKey.next('.list-item-row').attr('data-label')))\n+                        .attr('data-next-item-id', dataItemKey.next('.list-item-row').attr('data-item-id'))\n+                        .removeClass('hidden');\n+                }\n+                */\n                 if (debugJavascript === true) {\n-                    console.log(\"PREV: \" + $('#list-item-row_'+data.id).prev('.list-item-row').attr('data-item-id') + \" - NEXT: \" + $('#list-item-row_'+data.id).next('.list-item-row').attr('data-item-id'));\n+                    //console.log(\"PREV: \" + dataItemKey.attr('data-item-key') + \" - NEXT: \" + $('#list-item-row_'+data.id).next('.list-item-row').attr('data-item-id'));\n                 }\n \n                 // Inform user"
        },
        {
          "filename": "pages/profile.js.php",
          "status": "modified",
          "additions": 3,
          "deletions": 3,
          "patch": "@@ -165,9 +165,9 @@ function(data) {\n     // Save user settings\n     $('#profile-user-save-settings').click(function() {\n         // Sanitize text fields\n-        let formName = fieldSanitizeStep1('#profile-user-name', false, false, false),\n-            formLastname = fieldSanitizeStep1('#profile-user-lastname', false, false, false),\n-            formEmail = fieldSanitizeStep1('#profile-user-email', false, false, false);\n+        let formName = fieldDomPurifier('#profile-user-name', false, false, false),\n+            formLastname = fieldDomPurifier('#profile-user-lastname', false, false, false),\n+            formEmail = fieldDomPurifier('#profile-user-email', false, false, false);\n         if (formName === false || formLastname === false || formEmail === false) {\n             // Label is empty\n             toastr.remove();"
        },
        {
          "filename": "pages/roles.js.php",
          "status": "modified",
          "additions": 8,
          "deletions": 1,
          "patch": "@@ -474,9 +474,16 @@ function(data) {\n             toastr.remove();\n             toastr.info('<?php echo langHdl('in_progress'); ?> ... <i class=\"fas fa-circle-notch fa-spin fa-2x\"></i>');\n \n+            // Sanitize value\n+            value = fieldDomPurifierWithWarning('#form-role-label');\n+            if (value === false) {\n+                return false;\n+            }\n+            $('#form-role-label').val(value);\n+\n             // Prepare data\n             var data = {\n-                'label': DOMPurify.sanitize($('#form-role-label').val()),\n+                'label': value,\n                 'complexity': $('#form-complexity-list').val() === null ? 0 : $('#form-complexity-list').val(),\n                 'folderId': $('#roles-list').find(':selected').val(),\n                 'allowEdit': $('#form-role-privilege').is(\":checked\") === true ? 1 : 0,"
        },
        {
          "filename": "pages/users.js.php",
          "status": "modified",
          "additions": 23,
          "deletions": 27,
          "patch": "@@ -880,24 +880,6 @@ function(data) {\n                 }\n             });\n \n-            // Sanitize text fields\n-            let formLogin = fieldSanitizeStep1('#form-login', false, false, false),\n-                formName = fieldSanitizeStep1('#form-name', false, false, false),\n-                formLastname = fieldSanitizeStep1('#form-lastname', false, false, false),\n-                formEmail = fieldSanitizeStep1('#form-email', false, false, false);\n-            if (formLogin === false || formName === false || formLastname === false || formEmail === false) {\n-                // Label is empty\n-                toastr.remove();\n-                toastr.warning(\n-                    'XSS attempt detected. Field has been emptied.',\n-                    'Error', {\n-                        timeOut: 5000,\n-                        progressBar: true\n-                    }\n-                );\n-                return false;\n-            }\n-\n             if (arrayQuery.length > 0) {\n                 // Now save\n                 // get lists\n@@ -975,13 +957,20 @@ function(teampassUser) {\n                     }\n                 );\n \n+                // Sanitize text fields\n+                purifyRes = fieldDomPurifierLoop('#form-user .purify');\n+                if (purifyRes.purifyStop === true) {\n+                    // if purify failed, stop\n+                    return false;\n+                }\n+\n                 //prepare data\n                 var data = {\n                     'user_id': store.get('teampassApplication').formUserId,\n-                    'login': formLogin,\n-                    'name': formName,\n-                    'lastname': formLastname,\n-                    'email': formEmail,\n+                    'login': purifyRes.arrFields['login'],\n+                    'name': purifyRes.arrFields['name'],\n+                    'lastname': purifyRes.arrFields['lastname'],\n+                    'email': purifyRes.arrFields['email'],\n                     'admin': $('#privilege-admin').prop('checked'),\n                     'manager': $('#privilege-manager').prop('checked'),\n                     'hr': $('#privilege-hr').prop('checked'),\n@@ -1678,7 +1667,7 @@ function(teampassApplication) {\n \n                 // Prepare data\n                 var data = {\n-                    'label': DOMPurify.sanitize($('#ldap-new-role-selection').val()),\n+                    'label': simplePurifier($('#ldap-new-role-selection').val()),\n                     'complexity': $('#ldap-new-role-complexity').val(),\n                     'allowEdit': 0,\n                     'action': 'add_role',\n@@ -2273,12 +2262,19 @@ function addUserInTeampass() {\n             roles.push($(this).val())\n         });\n \n+        // Sanitize text fields\n+        purifyRes = fieldDomPurifierLoop('#form-user .purify');\n+        if (purifyRes.purifyStop === true) {\n+            // if purify failed, stop\n+            return false;\n+        }\n+\n         // prepare data\n         var data = {\n-            'login': DOMPurify.sanitize($('.selected-user').data('user-login')),\n-            'name': DOMPurify.sanitize($('.selected-user').data('user-name') === '' ? $('#ldap-user-name').val() : $('.selected-user').data('user-name')),\n-            'lastname': DOMPurify.sanitize($('.selected-user').data('user-lastname')),\n-            'email': DOMPurify.sanitize($('.selected-user').data('user-email')),\n+            'login': simplePurifier($('.selected-user').data('user-login')),\n+            'name': simplePurifier($('.selected-user').data('user-name') === '' ? $('#ldap-user-name').val() : $('.selected-user').data('user-name')),\n+            'lastname': simplePurifier($('.selected-user').data('user-lastname')),\n+            'email': simplePurifier($('.selected-user').data('user-email')),\n             'roles' : roles,\n         };\n         if (debugJavascript === true) console.log(data)"
        },
        {
          "filename": "pages/users.php",
          "status": "modified",
          "additions": 5,
          "deletions": 5,
          "patch": "@@ -271,23 +271,23 @@\n                             <div class=\"col-lg-6\">\n                                 <div class=\"form-group\">\n                                     <label for=\"form-name\"><?php echo langHdl('name'); ?></label>\n-                                    <input type=\"text\" class=\"form-control clear-me required track-change\" id=\"form-name\">\n+                                    <input type=\"text\" class=\"form-control clear-me required track-change purify\" id=\"form-name\" data-field=\"name\">\n                                 </div>\n                                 <div class=\"form-group\">\n                                     <label for=\"form-login\"><?php echo langHdl('login'); ?></label>\n-                                    <input type=\"text\" class=\"form-control clear-me required build-login track-change\" id=\"form-login\">\n+                                    <input type=\"text\" class=\"form-control clear-me required build-login track-change purify\" id=\"form-login\" data-field=\"login\">\n                                     <input type=\"hidden\" id=\"form-login-conform\" value=\"0\">\n                                 </div>\n                             </div>\n                             \n                             <div class=\"col-lg-6\">\n                                 <div class=\"form-group\">\n                                     <label for=\"form-lastname\"><?php echo langHdl('lastname'); ?></label>\n-                                    <input type=\"text\" class=\"form-control clear-me required track-change\" id=\"form-lastname\">\n+                                    <input type=\"text\" class=\"form-control clear-me required track-change purify\" id=\"form-lastname\" data-field=\"lastname\">\n                                 </div>\n                                 <div class=\"form-group\">\n                                     <label for=\"form-login\"><?php echo langHdl('email'); ?></label>\n-                                    <input type=\"email\" class=\"form-control clear-me required track-change validate-email\" id=\"form-email\">\n+                                    <input type=\"email\" class=\"form-control clear-me required track-change validate-email purify\" id=\"form-email\" data-field=\"email\">\n                                 </div>\n                             </div>\n                         </div>\n@@ -342,7 +342,7 @@\n                         <div class=\"form-group not-for-admin\" id=\"group-create-special-folder\">\n                             <input type=\"checkbox\" class=\"form-check-input form-control flat-blue track-change\" id=\"form-create-special-folder\">\n                             <label class=\"form-check-label mr-2\" for=\"form-create-special-folder\"><?php echo langHdl('auto_create_folder_role'); ?></label>\n-                            <input type=\"text\" class=\"form-control clear-me mt-1\" id=\"form-special-folder\" disabled=\"true\" placeholder=\"<?php echo langHdl('label'); ?>\">\n+                            <input type=\"text\" class=\"form-control clear-me mt-1 purify\" id=\"form-special-folder\" data-field=\"\" disabled=\"true\" placeholder=\"<?php echo langHdl('label'); ?>\">\n                         </div>\n                         <div class=\"form-group not-for-admin\" id=\"form-create-mfa-enabled-div\">\n                             <input type=\"checkbox\" class=\"form-check-input form-control flat-blue track-change\" id=\"form-create-mfa-enabled\">"
        },
        {
          "filename": "sources/admin.queries.php",
          "status": "modified",
          "additions": 3,
          "deletions": 3,
          "patch": "@@ -1874,20 +1874,20 @@\n             $post_id = DB::insertId();\n             // Update existing key\n         } elseif (null !== $post_action && $post_action === 'update') {\n-            $post_id = filter_var($dataReceived['id'], FILTER_SANITIZE_FULL_SPECIAL_CHARS);\n+            $post_id = filter_var($dataReceived['id'], FILTER_SANITIZE_NUMBER_INT);\n \n             DB::update(\n                 prefixTable('api'),\n                 array(\n                     'label' => $post_label,\n                     'timestamp' => $timestamp,\n                 ),\n-                'id=%i',\n+                'increment_id=%i',\n                 $post_id\n             );\n             // Delete existing key\n         } elseif (null !== $post_action && $post_action === 'delete') {\n-            $post_id = filter_var($dataReceived['id'], FILTER_SANITIZE_FULL_SPECIAL_CHARS);\n+            $post_id = filter_var($dataReceived['id'], FILTER_SANITIZE_NUMBER_INT);\n \n             DB::query(\n                 'DELETE FROM ' . prefixTable('api') . ' WHERE increment_id = %i',"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 3,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "aacdf6a3f2daf9b52a826d4b3d8a39873e2e2062",
            "date": "2025-01-13T17:24:23Z",
            "author_login": "nilsteampassnet"
          },
          {
            "sha": "eb95bc3e37f6e1f19fce98aa4c44c251f2084cd7",
            "date": "2025-01-13T17:20:31Z",
            "author_login": "nilsteampassnet"
          },
          {
            "sha": "9969d0ef636e28c1afcdb047aac2d2a5387b62b5",
            "date": "2025-01-12T17:29:37Z",
            "author_login": "nilsteampassnet"
          },
          {
            "sha": "4963736272bc4b281586f8ad4dcee70015d595b1",
            "date": "2025-01-12T17:22:24Z",
            "author_login": "nilsteampassnet"
          },
          {
            "sha": "b5a997952a43e4760c9eaceedfd9a7ba4a5683d2",
            "date": "2025-01-10T16:06:22Z",
            "author_login": "nilsteampassnet"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 5.4,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N",
    "cwe_id": "CWE-79",
    "description": "Cross-site Scripting (XSS) - Stored in GitHub repository nilsteampassnet/teampass prior to 3.0.9.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-06-10T09:15:09.730",
    "last_modified": "2024-11-21T08:16:39.710",
    "fix_date": "2023-06-10T07:30:21Z"
  },
  "references": [
    {
      "url": "https://github.com/nilsteampassnet/teampass/commit/241dbd4159a5d63b55af426464d30dbb53925705",
      "source": "security@huntr.dev",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/19fed157-128d-4bfb-a30e-eadf748cbd1a",
      "source": "security@huntr.dev",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/nilsteampassnet/teampass/commit/241dbd4159a5d63b55af426464d30dbb53925705",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/19fed157-128d-4bfb-a30e-eadf748cbd1a",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:05:59.351257",
    "processing_status": "enhanced"
  }
}