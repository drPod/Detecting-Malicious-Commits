{
  "cve_id": "CVE-2023-33177",
  "github_data": {
    "repository": "xibosignage/xibo-cms",
    "fix_commit": "1cbba380fa751a00756e70d7b08b5c6646092658",
    "related_commits": [
      "1cbba380fa751a00756e70d7b08b5c6646092658",
      "45c6b53c3978639db03b63270a56f4397f49b2c9",
      "1cbba380fa751a00756e70d7b08b5c6646092658",
      "45c6b53c3978639db03b63270a56f4397f49b2c9"
    ],
    "patch_url": "https://github.com/xibosignage/xibo-cms/commit/1cbba380fa751a00756e70d7b08b5c6646092658.patch",
    "fix_commit_details": {
      "sha": "1cbba380fa751a00756e70d7b08b5c6646092658",
      "commit_date": "2023-05-04T14:51:36Z",
      "author": {
        "login": "dasgarner",
        "type": "User",
        "stats": {
          "total_commits": 6644,
          "average_weekly_commits": 8.346733668341708,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 617
        }
      },
      "commit_message": {
        "title": "Various bugfixes (#1774)",
        "length": 293,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 58,
        "additions": 42,
        "deletions": 16
      },
      "files": [
        {
          "filename": "lib/Controller/Base.php",
          "status": "modified",
          "additions": 5,
          "deletions": 3,
          "patch": "@@ -1,6 +1,6 @@\n <?php\n /*\n- * Copyright (c) 2022 Xibo Signage Ltd\n+ * Copyright (C) 2023 Xibo Signage Ltd\n  *\n  * Xibo - Digital Signage - http://www.xibo.org.uk\n  *\n@@ -319,7 +319,8 @@ public function render(Request $request, Response $response)\n             try {\n                 $response = $this->getView()->render($response, $state->template . '.twig', $data);\n             } catch (LoaderError | RuntimeError | SyntaxError $e) {\n-                throw new GeneralException(__('Twig Error ') . $e->getMessage());\n+                $this->getLog()->error('Twig Error' . $e->getMessage());\n+                throw new GeneralException(__('Unable to view this page'));\n             }\n         }\n         $this->rendered = true;\n@@ -345,7 +346,8 @@ public function renderTwigAjaxReturn(Request $request, Response $response)\n         try {\n             $view = $this->getView()->render($response, $state->template . '.twig', $data);\n         } catch (LoaderError | RuntimeError | SyntaxError $e) {\n-            throw new GeneralException(__('Twig Error ') . $e->getMessage());\n+            $this->getLog()->error('Twig Error' . $e->getMessage());\n+            throw new GeneralException(__('Unable to view this page'));\n         }\n \n         $view = $view->getBody();"
        },
        {
          "filename": "lib/Entity/DataSet.php",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -525,7 +525,7 @@ public function getData($filterBy = [], $options = [])\n                     continue;\n                 }\n \n-                $formula = str_replace($this->blackList, '', htmlspecialchars_decode($column->formula, ENT_QUOTES));\n+                $formula = str_ireplace($this->blackList, '', htmlspecialchars_decode($column->formula, ENT_QUOTES));\n                 $formula = str_replace('[DisplayId]', $displayId, $formula);\n \n                 $heading = str_replace('[DisplayGeoLocation]', $displayGeoLocation, $formula) . ' AS `' . $column->heading . '`';\n@@ -544,7 +544,7 @@ public function getData($filterBy = [], $options = [])\n         if ($filter != '') {\n             // Support display filtering.\n             $filter = str_replace('[DisplayId]', $displayId, $filter);\n-            $filter = str_replace($this->blackList, '', $filter);\n+            $filter = str_ireplace($this->blackList, '', $filter);\n \n             $body .= ' AND ' . $filter;\n         }"
        },
        {
          "filename": "lib/Factory/BaseFactory.php",
          "status": "modified",
          "additions": 7,
          "deletions": 1,
          "patch": "@@ -1,6 +1,6 @@\n <?php\n /*\n- * Copyright (c) 2022 Xibo Signage Ltd\n+ * Copyright (C) 2023 Xibo Signage Ltd\n  *\n  * Xibo - Digital Signage - http://www.xibo.org.uk\n  *\n@@ -389,6 +389,12 @@ public function nameFilter($tableName, $tableColumn, $terms, &$body, &$params, $\n                 continue;\n             }\n \n+            // Validate the logical operator\n+            if (!in_array($logicalOperator, ['AND', 'OR'])) {\n+                $this->getLog()->error('Invalid logical operator ' . $logicalOperator);\n+                return;\n+            }\n+\n             // Not like, or like?\n             if (substr($searchName, 0, 1) == '-') {\n                 if ($i === 1) {"
        },
        {
          "filename": "lib/Factory/DisplayFactory.php",
          "status": "modified",
          "additions": 13,
          "deletions": 3,
          "patch": "@@ -1,6 +1,6 @@\n <?php\n /*\n- * Copyright (C) 2022 Xibo Signage Ltd\n+ * Copyright (C) 2023 Xibo Signage Ltd\n  *\n  * Xibo - Digital Signage - http://www.xibo.org.uk\n  *\n@@ -357,8 +357,18 @@ public function query($sortOrder = null, $filterBy = [])\n         // Filter by map bound?\n         if ($parsedBody->getString('bounds') !== null) {\n             $coordinates = explode(',', $parsedBody->getString('bounds'));\n-            $body .= ' AND IFNULL( ' . $functionPrefix . 'X(display.GeoLocation), ' . $this->config->getSetting('DEFAULT_LAT'). ')  BETWEEN ' . $coordinates['1'] . ' AND ' . $coordinates['3'] .\n-                ' AND IFNULL( ' . $functionPrefix . 'Y(display.GeoLocation), ' . $this->config->getSetting('DEFAULT_LONG'). ')  BETWEEN  ' . $coordinates['0'] . ' AND ' . $coordinates['2'] . ' ';\n+            $defaultLat = $this->config->getSetting('DEFAULT_LAT');\n+            $defaultLng = $this->config->getSetting('DEFAULT_LONG');\n+\n+            $body .= ' AND IFNULL( ' . $functionPrefix . 'X(display.GeoLocation), ' . $defaultLat\n+                . ')  BETWEEN :coordinates_1 AND :coordinates_3 '\n+                . ' AND IFNULL( ' . $functionPrefix . 'Y(display.GeoLocation), ' . $defaultLng\n+                . ')  BETWEEN :coordinates_0 AND :coordinates_2 ';\n+\n+            $params['coordinates_0'] = $coordinates[0];\n+            $params['coordinates_1'] = $coordinates[1];\n+            $params['coordinates_2'] = $coordinates[2];\n+            $params['coordinates_3'] = $coordinates[3];\n         }\n \n         // Filter by Display ID?"
        },
        {
          "filename": "lib/Factory/LayoutFactory.php",
          "status": "modified",
          "additions": 15,
          "deletions": 7,
          "patch": "@@ -1016,7 +1016,7 @@ public function loadByJson($layoutJson, $playlistJson, $nestedPlaylistJson, Fold\n                             }\n                         }\n                     }\n-                    \n+\n                     $combined = array_combine($oldIds, $newIds);\n \n                     $playlists = $this->createNestedPlaylistWidgets($widgets, $combined, $playlists);\n@@ -1241,14 +1241,22 @@ public function createFromZip($zipFile, $layoutName, $userId, $template, $replac\n         foreach ($mappings as $file) {\n             // Import the Media File\n             $intendedMediaName = $file['name'];\n-            $temporaryFileName = $libraryLocation . $file['file'];\n+\n+            // Validate the file name\n+            $fileName = basename($file['file']);\n+            if (empty($fileName) || $fileName == '.') {\n+                $this->getLog()->error('Skipping file on import due to invalid filename. ' . $fileName);\n+                continue;\n+            }\n+\n+            $temporaryFileName = $libraryLocation . $fileName;\n \n             // Get the file from the ZIP\n-            $fileStream = $zip->getStream('library/' . $file['file']);\n+            $fileStream = $zip->getStream('library/' . $fileName);\n \n             if ($fileStream === false) {\n                 // Log out the entire ZIP file and all entries.\n-                $log = 'Problem getting library/' . $file['file'] . '. Files: ';\n+                $log = 'Problem getting library/' . $fileName . '. Files: ';\n                 for ($i = 0; $i < $zip->numFiles; $i++) {\n                     $log .= $zip->getNameIndex($i) . ', ';\n                 }\n@@ -1287,9 +1295,9 @@ public function createFromZip($zipFile, $layoutName, $userId, $template, $replac\n                 }\n             } catch (NotFoundException $e) {\n                 // Create it instead\n-                $this->getLog()->debug('Media does not exist in Library, add it ' .  $file['file']);\n+                $this->getLog()->debug('Media does not exist in Library, add it ' .  $fileName);\n \n-                $media = $this->mediaFactory->create($intendedMediaName, $file['file'], $file['type'], $userId, $file['duration']);\n+                $media = $this->mediaFactory->create($intendedMediaName, $fileName, $file['type'], $userId, $file['duration']);\n \n                 if ($importTags && isset($file['tags'])) {\n                     foreach ($file['tags'] as $tagNode) {\n@@ -1444,7 +1452,7 @@ public function createFromZip($zipFile, $layoutName, $userId, $template, $replac\n                 $columnWithImages = [];\n                 // We must null the ID so that we don't try to load the dataset when we assign columns\n                 $dataSet->dataSetId = null;\n-                \n+\n                 // Hydrate the columns\n                 foreach ($item['columns'] as $columnItem) {\n                     $this->getLog()->debug(sprintf('Assigning column: %s', json_encode($columnItem)));"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 3,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "be0bb7188b1957283c948dbb5f956bfcc20e486d",
            "date": "2025-01-14T16:24:58Z",
            "author_login": "dasgarner"
          },
          {
            "sha": "baad63a883af2cb7722787606fa6d969a7207aa9",
            "date": "2025-01-14T11:25:37Z",
            "author_login": "mgbaybay"
          },
          {
            "sha": "f4418e8c16f8b329997d704fa389fd45a08fa17c",
            "date": "2025-01-10T16:47:44Z",
            "author_login": "mgbaybay"
          },
          {
            "sha": "7682f3ca9687a7abada5b7ebbda8df984cad034d",
            "date": "2025-01-10T16:16:41Z",
            "author_login": "maurofmferrao"
          },
          {
            "sha": "847f5441d792825fc2072a275867b4b4a9153e7a",
            "date": "2025-01-10T14:23:25Z",
            "author_login": "nadzpogi"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 8.8,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H",
    "cwe_id": "CWE-22",
    "description": "Xibo is a content management system (CMS). A path traversal vulnerability exists in the Xibo CMS whereby a specially crafted zip file can be uploaded to the CMS via the layout import function by an authenticated user which would allow creation of files outside of the CMS library directory as the webserver user. This can be used to upload a PHP webshell inside the web root directory and achieve remote code execution as the webserver user. Users should upgrade to version 2.3.17 or 3.3.5, which fix this issue. Customers who host their CMS with Xibo Signage have already received an upgrade or patch to resolve this issue regardless of the CMS version that they are running.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-05-30T20:15:10.837",
    "last_modified": "2024-11-21T08:05:03.337",
    "fix_date": "2023-05-04T14:51:36Z"
  },
  "references": [
    {
      "url": "https://claroty.com/team82/disclosure-dashboard",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/xibosignage/xibo-cms/commit/1cbba380fa751a00756e70d7b08b5c6646092658",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xibosignage/xibo-cms/commit/45c6b53c3978639db03b63270a56f4397f49b2c9",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xibosignage/xibo-cms/security/advisories/GHSA-jj27-x85q-crqv",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://xibosignage.com/blog/security-advisory-2023-05/",
      "source": "security-advisories@github.com",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://claroty.com/team82/disclosure-dashboard",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/xibosignage/xibo-cms/commit/1cbba380fa751a00756e70d7b08b5c6646092658",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xibosignage/xibo-cms/commit/45c6b53c3978639db03b63270a56f4397f49b2c9",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xibosignage/xibo-cms/security/advisories/GHSA-jj27-x85q-crqv",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://xibosignage.com/blog/security-advisory-2023-05/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Vendor Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:05:59.275140",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "xibo-cms",
    "owner": "xibosignage",
    "created_at": "2015-01-08T13:10:34Z",
    "updated_at": "2025-01-14T11:25:41Z",
    "pushed_at": "2025-01-14T11:25:52Z",
    "size": 199650,
    "stars": 394,
    "forks": 286,
    "open_issues": 6,
    "watchers": 394,
    "has_security_policy": false,
    "default_branch": "develop",
    "protected_branches": [
      "develop",
      "kopff",
      "master"
    ],
    "languages": {
      "PHP": 7461954,
      "Twig": 2434420,
      "JavaScript": 1823110,
      "Handlebars": 224198,
      "SCSS": 166721,
      "CSS": 83520,
      "Shell": 26455,
      "C": 15992,
      "Python": 12616,
      "Dockerfile": 7927,
      "HTML": 2
    },
    "commit_activity": {
      "total_commits_last_year": 499,
      "avg_commits_per_week": 9.596153846153847,
      "days_active_last_year": 168
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "agpl-3.0"
    },
    "collected_at": "2025-01-14T13:38:15.726881"
  }
}