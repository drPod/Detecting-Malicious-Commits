{
  "cve_id": "CVE-2023-34454",
  "github_data": {
    "repository": "xerial/snappy-java",
    "fix_commit": "d0042551e4a3509a725038eb9b2ad1f683674d94",
    "related_commits": [
      "d0042551e4a3509a725038eb9b2ad1f683674d94",
      "d0042551e4a3509a725038eb9b2ad1f683674d94"
    ],
    "patch_url": "https://github.com/xerial/snappy-java/commit/d0042551e4a3509a725038eb9b2ad1f683674d94.patch",
    "fix_commit_details": {
      "sha": "d0042551e4a3509a725038eb9b2ad1f683674d94",
      "commit_date": "2023-06-14T18:06:30Z",
      "author": {
        "login": "aidancch",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Merge pull request from GHSA-fjpj-2g6w-x25r",
        "length": 850,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 102,
        "additions": 94,
        "deletions": 8
      },
      "files": [
        {
          "filename": "src/main/java/org/xerial/snappy/Snappy.java",
          "status": "modified",
          "additions": 30,
          "deletions": 6,
          "patch": "@@ -169,7 +169,11 @@ public static int compress(ByteBuffer uncompressed, ByteBuffer compressed)\n     public static byte[] compress(char[] input)\n             throws IOException\n     {\n-        return rawCompress(input, input.length * 2); // char uses 2 bytes\n+        int byteSize = input.length * 2;\n+        if (byteSize < input.length) {\n+            throw new SnappyError(SnappyErrorCode.TOO_LARGE_INPUT, \"input array size is too large: \" + input.length);\n+        }\n+        return rawCompress(input, byteSize); // char uses 2 bytes\n     }\n \n     /**\n@@ -181,7 +185,11 @@ public static byte[] compress(char[] input)\n     public static byte[] compress(double[] input)\n             throws IOException\n     {\n-        return rawCompress(input, input.length * 8); // double uses 8 bytes\n+        int byteSize = input.length * 8;\n+        if (byteSize < input.length) {\n+            throw new SnappyError(SnappyErrorCode.TOO_LARGE_INPUT, \"input array size is too large: \" + input.length);\n+        }\n+        return rawCompress(input, byteSize); // double uses 8 bytes\n     }\n \n     /**\n@@ -193,7 +201,11 @@ public static byte[] compress(double[] input)\n     public static byte[] compress(float[] input)\n             throws IOException\n     {\n-        return rawCompress(input, input.length * 4); // float uses 4 bytes\n+        int byteSize = input.length * 4;\n+        if (byteSize < input.length) {\n+            throw new SnappyError(SnappyErrorCode.TOO_LARGE_INPUT, \"input array size is too large: \" + input.length);\n+        }\n+        return rawCompress(input, byteSize); // float uses 4 bytes\n     }\n \n     /**\n@@ -205,7 +217,11 @@ public static byte[] compress(float[] input)\n     public static byte[] compress(int[] input)\n             throws IOException\n     {\n-        return rawCompress(input, input.length * 4); // int uses 4 bytes\n+        int byteSize = input.length * 4;\n+        if (byteSize < input.length) {\n+            throw new SnappyError(SnappyErrorCode.TOO_LARGE_INPUT, \"input array size is too large: \" + input.length);\n+        }\n+        return rawCompress(input, byteSize); // int uses 4 bytes\n     }\n \n     /**\n@@ -217,7 +233,11 @@ public static byte[] compress(int[] input)\n     public static byte[] compress(long[] input)\n             throws IOException\n     {\n-        return rawCompress(input, input.length * 8); // long uses 8 bytes\n+        int byteSize = input.length * 8;\n+        if (byteSize < input.length) {\n+            throw new SnappyError(SnappyErrorCode.TOO_LARGE_INPUT, \"input array size is too large: \" + input.length);\n+        }\n+        return rawCompress(input, byteSize); // long uses 8 bytes\n     }\n \n     /**\n@@ -229,7 +249,11 @@ public static byte[] compress(long[] input)\n     public static byte[] compress(short[] input)\n             throws IOException\n     {\n-        return rawCompress(input, input.length * 2); // short uses 2 bytes\n+        int byteSize = input.length * 2;\n+        if (byteSize < input.length) {\n+            throw new SnappyError(SnappyErrorCode.TOO_LARGE_INPUT, \"input array size is too large: \" + input.length);\n+        }\n+        return rawCompress(input, byteSize); // short uses 2 bytes\n     }\n \n     /**"
        },
        {
          "filename": "src/test/java/org/xerial/snappy/SnappyTest.java",
          "status": "modified",
          "additions": 64,
          "deletions": 2,
          "patch": "@@ -19,7 +19,7 @@\n // SnappyTest.java\n // Since: 2011/03/30\n //\n-// $URL$ \n+// $URL$\n // $Author$\n //--------------------------------------\n package org.xerial.snappy;\n@@ -331,8 +331,8 @@ public void isValidCompressedData()\n         }\n     }\n \n-    /*\n \n+    /*\n     Tests happy cases for SnappyInputStream.read method\n     - {0}\n      */\n@@ -385,6 +385,67 @@ public void isInvalidChunkLengthForSnappyInputStreamOutOfMemory()\n     - int: 0, 10\n     - long: 0, 10\n     - short: 0, 10\n+     */\n+    @Test\n+    public void isValidArrayInputLength()\n+            throws Exception {\n+        byte[] a = Snappy.compress(new char[0]);\n+        byte[] b = Snappy.compress(new double[0]);\n+        byte[] c = Snappy.compress(new float[0]);\n+        byte[] d = Snappy.compress(new int[0]);\n+        byte[] e = Snappy.compress(new long[0]);\n+        byte[] f = Snappy.compress(new short[0]);\n+        byte[] g = Snappy.compress(new char[10]);\n+        byte[] h = Snappy.compress(new double[10]);\n+        byte[] i = Snappy.compress(new float[10]);\n+        byte[] j = Snappy.compress(new int[10]);\n+        byte[] k = Snappy.compress(new long[10]);\n+        byte[] l = Snappy.compress(new short[10]);\n+    }\n+\n+    /*\n+    Tests sad cases for Snappy.compress\n+    - Allocate a buffer whose byte size will be a bit larger than Integer.MAX_VALUE\n+    - char\n+    - double\n+    - float\n+    - int\n+    - long\n+    - short\n+     */\n+    @Test(expected = SnappyError.class)\n+    public void isTooLargeDoubleArrayInputLength() throws Exception {\n+        Snappy.compress(new double[Integer.MAX_VALUE / 8 + 1]);\n+    }\n+\n+    @Test(expected = SnappyError.class)\n+    public void isTooLargeCharArrayInputLength() throws Exception {\n+        Snappy.compress(new char[Integer.MAX_VALUE / 2 + 1]);\n+    }\n+\n+    @Test(expected = SnappyError.class)\n+    public void isTooLargeFloatArrayInputLength() throws Exception {\n+        Snappy.compress(new float[Integer.MAX_VALUE / 4 + 1]);\n+    }\n+\n+    @Test(expected = SnappyError.class)\n+    public void isTooLargeIntArrayInputLength() throws Exception {\n+        Snappy.compress(new int[Integer.MAX_VALUE / 4 + 1]);\n+    }\n+\n+    @Test(expected = SnappyError.class)\n+    public void isTooLargeLongArrayInputLength() throws Exception {\n+        Snappy.compress(new long[Integer.MAX_VALUE / 8 + 1]);\n+    }\n+\n+    @Test(expected = SnappyError.class)\n+    public void isTooLargeShortArrayInputLength() throws Exception {\n+        Snappy.compress(new short[Integer.MAX_VALUE / 2 + 1]);\n+    }\n+\n+    /*\n+    Tests happy cases for Snappy.compress\n+    - char: 0, 10\n     */\n     @Test\n     public void isValidArrayInputLengthForBitShuffleShuffle()\n@@ -435,5 +496,6 @@ public void isTooLargeLongArrayInputLengthForBitShuffleShuffle() throws Exceptio\n     public void isTooLargeShortArrayInputLengthForBitShuffleShuffle() throws Exception {\n         BitShuffle.shuffle(new short[Integer.MAX_VALUE / 2 + 1]);\n \n+\n     }\n }"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 2,
        "max_directory_depth": 6
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "ec23d7c611563bedce536ca4d02ebdb9a690ea91",
            "date": "2025-01-08T19:46:21Z",
            "author_login": "xerial-bot"
          },
          {
            "sha": "192e0ee28647cf47972810b1104646031bfdffcc",
            "date": "2025-01-08T19:46:12Z",
            "author_login": "xerial-bot"
          },
          {
            "sha": "dfbf67a4cb49930aa7be2bf6c6d9e77e6aba79e2",
            "date": "2024-12-20T00:16:05Z",
            "author_login": "xerial-bot"
          },
          {
            "sha": "f6b188896cd6f7fa93aebd1c9d29916687a84e78",
            "date": "2024-12-19T17:33:33Z",
            "author_login": "xerial-bot"
          },
          {
            "sha": "1fe7685ae729513b9640ec235dc34f56a751e16a",
            "date": "2024-12-19T17:33:16Z",
            "author_login": "xerial-bot"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 5.9,
    "cvss_vector": "CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:N/I:N/A:H",
    "cwe_id": "CWE-190",
    "description": "snappy-java is a fast compressor/decompressor for Java. Due to unchecked multiplications, an integer overflow may occur in versions prior to 1.1.10.1, causing an unrecoverable fatal error.\n\nThe function `compress(char[] input)` in the file `Snappy.java` receives an array of characters and compresses it. It does so by multiplying the length by 2 and passing it to the rawCompress` function.\n\nSince the length is not tested, the multiplication by two can cause an integer overflow and become negative. The rawCompress function then uses the received length and passes it to the natively compiled maxCompressedLength function, using the returned value to allocate a byte array.\n\nSince the maxCompressedLength function treats the length as an unsigned integer, it doesn\u2019t care that it is negative, and it returns a valid value, which is casted to a signed integer by the Java engine. If the result is negative, a `java.lang.NegativeArraySizeException` exception will be raised while trying to allocate the array `buf`. On the other side, if the result is positive, the `buf` array will successfully be allocated, but its size might be too small to use for the compression, causing a fatal Access Violation error.\n\nThe same issue exists also when using the `compress` functions that receive double, float, int, long and short, each using a different multiplier that may cause the same issue. The issue most likely won\u2019t occur when using a byte array, since creating a byte array of size 0x80000000 (or any other negative value) is impossible in the first place.\n\nVersion 1.1.10.1 contains a patch for this issue.",
    "attack_vector": "NETWORK",
    "attack_complexity": "HIGH"
  },
  "temporal_data": {
    "published_date": "2023-06-15T17:15:09.873",
    "last_modified": "2024-12-12T17:15:08.430",
    "fix_date": "2023-06-14T18:06:30Z"
  },
  "references": [
    {
      "url": "https://github.com/xerial/snappy-java/blob/05c39b2ca9b5b7b39611529cc302d3d796329611/src/main/java/org/xerial/snappy/Snappy.java#L169",
      "source": "security-advisories@github.com",
      "tags": [
        "Issue Tracking"
      ]
    },
    {
      "url": "https://github.com/xerial/snappy-java/blob/05c39b2ca9b5b7b39611529cc302d3d796329611/src/main/java/org/xerial/snappy/Snappy.java#L422",
      "source": "security-advisories@github.com",
      "tags": [
        "Issue Tracking"
      ]
    },
    {
      "url": "https://github.com/xerial/snappy-java/blob/master/src/main/java/org/xerial/snappy/Snappy.java",
      "source": "security-advisories@github.com",
      "tags": [
        "Issue Tracking",
        "Product"
      ]
    },
    {
      "url": "https://github.com/xerial/snappy-java/commit/d0042551e4a3509a725038eb9b2ad1f683674d94",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xerial/snappy-java/security/advisories/GHSA-fjpj-2g6w-x25r",
      "source": "security-advisories@github.com",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/xerial/snappy-java/blob/05c39b2ca9b5b7b39611529cc302d3d796329611/src/main/java/org/xerial/snappy/Snappy.java#L169",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Issue Tracking"
      ]
    },
    {
      "url": "https://github.com/xerial/snappy-java/blob/05c39b2ca9b5b7b39611529cc302d3d796329611/src/main/java/org/xerial/snappy/Snappy.java#L422",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Issue Tracking"
      ]
    },
    {
      "url": "https://github.com/xerial/snappy-java/blob/master/src/main/java/org/xerial/snappy/Snappy.java",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Issue Tracking",
        "Product"
      ]
    },
    {
      "url": "https://github.com/xerial/snappy-java/commit/d0042551e4a3509a725038eb9b2ad1f683674d94",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xerial/snappy-java/security/advisories/GHSA-fjpj-2g6w-x25r",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/xerial/snappy-java/security/advisories/GHSA-fjpj-2g6w-x25r",
      "source": "134c704f-9b21-4f2e-91b3-4a467353bcc0",
      "tags": [
        "Vendor Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:05:59.369489",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "snappy-java",
    "owner": "xerial",
    "created_at": "2012-09-06T01:30:21Z",
    "updated_at": "2025-01-08T19:46:26Z",
    "pushed_at": "2025-01-13T16:03:43Z",
    "size": 37531,
    "stars": 1044,
    "forks": 234,
    "open_issues": 55,
    "watchers": 1044,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "master"
    ],
    "languages": {
      "Java": 318875,
      "C++": 227887,
      "Shell": 94403,
      "Makefile": 9706,
      "Scala": 6541,
      "C": 5658,
      "CSS": 1554,
      "CMake": 525
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "apache-2.0"
    },
    "collected_at": "2025-01-14T13:48:15.891299"
  }
}