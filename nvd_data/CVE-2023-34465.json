{
  "cve_id": "CVE-2023-34465",
  "github_data": {
    "repository": "xwiki/xwiki-platform",
    "fix_commit": "8910b8857d3442d2e8142f655fdc0512930354d1",
    "related_commits": [
      "8910b8857d3442d2e8142f655fdc0512930354d1",
      "d28d7739089e1ae8961257d9da7135d1a01cb7d4",
      "8910b8857d3442d2e8142f655fdc0512930354d1",
      "d28d7739089e1ae8961257d9da7135d1a01cb7d4"
    ],
    "patch_url": "https://github.com/xwiki/xwiki-platform/commit/8910b8857d3442d2e8142f655fdc0512930354d1.patch",
    "fix_commit_details": {
      "sha": "8910b8857d3442d2e8142f655fdc0512930354d1",
      "commit_date": "2023-02-22T09:33:54Z",
      "author": {
        "login": "manuelleduc",
        "type": "User",
        "stats": {
          "total_commits": 953,
          "average_weekly_commits": 0.9989517819706499,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 179
        }
      },
      "commit_message": {
        "title": "XWIKI-20671: Fix Mail.MailConfig initialization",
        "length": 47,
        "has_description": false,
        "references_issue": true
      },
      "stats": {
        "total": 71,
        "additions": 58,
        "deletions": 13
      },
      "files": [
        {
          "filename": "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authorization/xwiki-platform-security-authorization-bridge/src/main/java/org/xwiki/security/internal/DocumentInitializerRightsManager.java",
          "status": "modified",
          "additions": 41,
          "deletions": 11,
          "patch": "@@ -20,12 +20,12 @@\n package org.xwiki.security.internal;\n \n import java.util.List;\n-import java.util.stream.Collectors;\n \n import javax.inject.Inject;\n import javax.inject.Provider;\n import javax.inject.Singleton;\n \n+import org.apache.commons.lang3.StringUtils;\n import org.slf4j.Logger;\n import org.xwiki.component.annotation.Component;\n import org.xwiki.security.authorization.Right;\n@@ -36,6 +36,7 @@\n import com.xpn.xwiki.doc.XWikiDocument;\n import com.xpn.xwiki.objects.BaseObject;\n \n+import static java.util.stream.Collectors.joining;\n import static org.xwiki.security.authorization.Right.DELETE;\n import static org.xwiki.security.authorization.Right.EDIT;\n import static org.xwiki.security.authorization.Right.VIEW;\n@@ -76,28 +77,28 @@ public class DocumentInitializerRightsManager\n     public boolean restrictToAdmin(XWikiDocument document)\n     {\n         boolean updated = false;\n+        List<Right> rights = List.of(VIEW, EDIT, DELETE);\n+\n+        if (fixBadlyInitializedRights(document, rights)) {\n+            updated = true;\n+        }\n+\n         // If some rights have already been set on the document, we consider that it has already been protected \n         // manually.\n         if (document.getXObjects(LOCAL_CLASS_REFERENCE).isEmpty()) {\n-            updated = initializeRights(document, XWIKI_ADMIN_GROUP_DOCUMENT_REFERENCE, List.of(VIEW, EDIT, DELETE));\n+            updated = updated || initializeRights(document, rights);\n         }\n \n         return updated;\n     }\n \n-    private boolean initializeRights(XWikiDocument document, String xwikiAdminGroupDocumentReference,\n-        List<Right> rights)\n+    private boolean initializeRights(XWikiDocument document, List<Right> rights)\n     {\n         boolean updated = false;\n \n         try {\n-            XWikiContext xwikiContext = this.xcontextProvider.get();\n-            BaseObject object = document.newXObject(LOCAL_CLASS_REFERENCE, xwikiContext);\n-            XWikiContext xWikiContext = this.xcontextProvider.get();\n-            object.set(GROUPS_FIELD_NAME, xwikiAdminGroupDocumentReference, xWikiContext);\n-            object.set(LEVELS_FIELD_NAME, rights.stream().map(Right::getName).collect(Collectors.toList()),\n-                xWikiContext);\n-            object.set(ALLOW_FIELD_NAME, 1, xWikiContext);\n+            BaseObject object = document.newXObject(LOCAL_CLASS_REFERENCE, this.xcontextProvider.get());\n+            setRights(object, rights);\n             updated = true;\n         } catch (XWikiException e) {\n             this.logger.error(String.format(\"Error adding a [%s] object to the document [%s]\", LOCAL_CLASS_REFERENCE,\n@@ -106,4 +107,33 @@ private boolean initializeRights(XWikiDocument document, String xwikiAdminGroupD\n \n         return updated;\n     }\n+\n+    /**\n+     * Because of XWIKI-20519, the levels of the rights of {@code XWiki.XWikiAdminGroup} can be badly initialized, and\n+     * needs to be fixed. This is the case when upgrading from instances running exactly version 14.10.5 or 15.1-rc-1.\n+     *\n+     * @param document the document to fix\n+     * @param rights the rights to set to the {@code XWiki.XWikiAdminGroup} group\n+     */\n+    private boolean fixBadlyInitializedRights(XWikiDocument document, List<Right> rights)\n+    {\n+        boolean updated = false;\n+        if (document.getXObjects(LOCAL_CLASS_REFERENCE).size() == 1) {\n+            BaseObject object = document.getXObject(LOCAL_CLASS_REFERENCE);\n+            if (StringUtils.isEmpty(object.getStringValue(LEVELS_FIELD_NAME))\n+                && StringUtils.isEmpty(object.getLargeStringValue(GROUPS_FIELD_NAME)))\n+            {\n+                setRights(object, rights);\n+                updated = true;\n+            }\n+        }\n+        return updated;\n+    }\n+\n+    private void setRights(BaseObject object, List<Right> rights)\n+    {\n+        object.setLargeStringValue(GROUPS_FIELD_NAME, XWIKI_ADMIN_GROUP_DOCUMENT_REFERENCE);\n+        object.setStringValue(LEVELS_FIELD_NAME, rights.stream().map(Right::getName).collect(joining(\",\")));\n+        object.setIntValue(ALLOW_FIELD_NAME, 1);\n+    }\n }"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authorization/xwiki-platform-security-authorization-bridge/src/test/java/org/xwiki/security/internal/DocumentInitializerRightsManagerTest.java",
          "status": "modified",
          "additions": 17,
          "deletions": 2,
          "patch": "@@ -92,18 +92,33 @@ void setUp(MockitoComponentManager componentManager) throws Exception\n     @Test\n     void restrictToAdminSkipWhenAlreadyHasRights() throws Exception\n     {\n-        this.document.newXObject(LOCAL_CLASS_REFERENCE, this.xWikiContext);\n+        BaseObject baseObject = this.document.newXObject(LOCAL_CLASS_REFERENCE, this.xWikiContext);\n+        baseObject.setLargeStringValue(LEVELS_FIELD_NAME, \"edit\");\n         assertFalse(this.rightsManager.restrictToAdmin(this.document));\n     }\n \n+    @Test\n+    void restrictToAdminBadlyInitialized() throws Exception\n+    {\n+        BaseObject object = this.document.newXObject(LOCAL_CLASS_REFERENCE, this.xWikiContext);\n+        object.setLargeStringValue(GROUPS_FIELD_NAME, \"\");\n+        object.setLargeStringValue(LEVELS_FIELD_NAME, \"\");\n+        object.setIntValue(ALLOW_FIELD_NAME, 1);\n+        assertTrue(this.rightsManager.restrictToAdmin(this.document));\n+        BaseObject xObject = this.document.getXObject(LOCAL_CLASS_REFERENCE);\n+        assertEquals(\"XWiki.XWikiAdminGroup\", xObject.getStringValue(GROUPS_FIELD_NAME));\n+        assertEquals(\"view,edit,delete\", xObject.getStringValue(LEVELS_FIELD_NAME));\n+        assertEquals(\"1\", xObject.getStringValue(ALLOW_FIELD_NAME));\n+    }\n+\n     @Test\n     void restrictToAdmin()\n     {\n         assertTrue(this.rightsManager.restrictToAdmin(this.document));\n         assertEquals(1, this.document.getXObjects(LOCAL_CLASS_REFERENCE).size());\n         BaseObject xObject = this.document.getXObject(LOCAL_CLASS_REFERENCE);\n         assertEquals(\"XWiki.XWikiAdminGroup\", xObject.getStringValue(GROUPS_FIELD_NAME));\n-        assertEquals(\"view, edit, delete\", xObject.getStringValue(LEVELS_FIELD_NAME));\n+        assertEquals(\"view,edit,delete\", xObject.getStringValue(LEVELS_FIELD_NAME));\n         assertEquals(\"1\", xObject.getStringValue(ALLOW_FIELD_NAME));\n     }\n "
        }
      ],
      "file_patterns": {
        "security_files": 2,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 2,
        "max_directory_depth": 11
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "88e3e7d23cbd3e6ed059dbcd6532f94016d42678",
            "date": "2025-01-13T16:58:06Z",
            "author_login": "Sereza7"
          },
          {
            "sha": "9b506ab2bed52744b52699ea05cde15986d42abb",
            "date": "2025-01-13T16:36:24Z",
            "author_login": "mflorea"
          },
          {
            "sha": "d53d6e347b97ac20f60e21fb2bae381f4aaf10f4",
            "date": "2025-01-13T13:25:24Z",
            "author_login": "tmortagne"
          },
          {
            "sha": "d85bd8f9c67c412e0cfb45fb4695b8d4e759bab6",
            "date": "2025-01-13T12:03:22Z",
            "author_login": "tmortagne"
          },
          {
            "sha": "6f210dabc99167cf9f020a048c88325eca34ceea",
            "date": "2025-01-13T08:54:32Z",
            "author_login": "tmortagne"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 9.9,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H",
    "cwe_id": "CWE-269",
    "description": "XWiki Platform is a generic wiki platform. Starting in version 11.8-rc-1 and prior to versions 14.4.8, 14.10.6, and 15.2, `Mail.MailConfig` can be edited by any logged-in user by default. Consequently, they can change the mail obfuscation configuration and view and edit the mail sending configuration, including the smtp domain name and credentials. The problem has been patched in XWiki 14.4.8, 14.10.6, and 15.1. As a workaround, the rights of the `Mail.MailConfig` page can be manually updated so that only a set of trusted users can view, edit and delete it (e.g., the `XWiki.XWikiAdminGroup` group).",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-06-23T16:15:09.303",
    "last_modified": "2024-11-21T08:07:18.760",
    "fix_date": "2023-02-22T09:33:54Z"
  },
  "references": [
    {
      "url": "https://github.com/xwiki/xwiki-platform/commit/8910b8857d3442d2e8142f655fdc0512930354d1",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/commit/d28d7739089e1ae8961257d9da7135d1a01cb7d4",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/security/advisories/GHSA-g75c-cjr6-39mc",
      "source": "security-advisories@github.com",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://jira.xwiki.org/browse/XWIKI-20519",
      "source": "security-advisories@github.com",
      "tags": [
        "Issue Tracking",
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://jira.xwiki.org/browse/XWIKI-20671",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/commit/8910b8857d3442d2e8142f655fdc0512930354d1",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/commit/d28d7739089e1ae8961257d9da7135d1a01cb7d4",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/security/advisories/GHSA-g75c-cjr6-39mc",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://jira.xwiki.org/browse/XWIKI-20519",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Issue Tracking",
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://jira.xwiki.org/browse/XWIKI-20671",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Patch",
        "Vendor Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:06:01.857628",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "xwiki-platform",
    "owner": "xwiki",
    "created_at": "2011-03-10T13:26:41Z",
    "updated_at": "2025-01-13T16:58:10Z",
    "pushed_at": "2025-01-14T12:32:03Z",
    "size": 561595,
    "stars": 1030,
    "forks": 554,
    "open_issues": 136,
    "watchers": 1030,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "Java": 34276921,
      "JavaScript": 2392892,
      "HTML": 388086,
      "Less": 318945,
      "AspectJ": 280487,
      "Vue": 222987,
      "CSS": 115460,
      "XSLT": 109285,
      "Clean": 44054,
      "Shell": 32569,
      "Batchfile": 14604,
      "Python": 5046,
      "Groovy": 3012,
      "AMPL": 1296
    },
    "commit_activity": {
      "total_commits_last_year": 1723,
      "avg_commits_per_week": 33.13461538461539,
      "days_active_last_year": 263
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "lgpl-2.1"
    },
    "collected_at": "2025-01-14T12:58:58.685838"
  }
}