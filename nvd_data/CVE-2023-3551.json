{
  "cve_id": "CVE-2023-3551",
  "github_data": {
    "repository": "nilsteampassnet/teampass",
    "fix_commit": "cc6abc76aa46ed4a27736c1d2f21e432a5d54e6f",
    "related_commits": [
      "cc6abc76aa46ed4a27736c1d2f21e432a5d54e6f",
      "cc6abc76aa46ed4a27736c1d2f21e432a5d54e6f"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "cc6abc76aa46ed4a27736c1d2f21e432a5d54e6f",
      "commit_date": "2023-07-08T08:02:56Z",
      "author": {
        "login": "nilsteampassnet",
        "type": "User",
        "stats": {
          "total_commits": 2012,
          "average_weekly_commits": 2.9415204678362574,
          "total_additions": 5301385,
          "total_deletions": 4813706,
          "weeks_active": 411
        }
      },
      "commit_message": {
        "title": "3.0.10",
        "length": 86,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 85,
        "additions": 44,
        "deletions": 41
      },
      "files": [
        {
          "filename": "includes/js/functions.js",
          "status": "modified",
          "additions": 25,
          "deletions": 4,
          "patch": "@@ -395,10 +395,10 @@ function simplePurifier(\n     bHtml = false,\n     bSvg = false,\n     bSvgFilters = false\n-)\n+) \n {\n     return DOMPurify.sanitize(\n-        text\n+        sanitizeDom(text)\n             .replaceAll('&lt;', '<')\n             .replaceAll('&#x3C;', '<')\n             .replaceAll('&#60;', '<')\n@@ -515,6 +515,7 @@ function fieldDomPurifierWithWarning(\n     bHtml = false,\n     bSvg = false,\n     bSvgFilters = false,\n+    bSetting = false,\n )\n {\n     if (field === undefined || field === '') {\n@@ -523,10 +524,22 @@ function fieldDomPurifierWithWarning(\n     if ($(field).val() === '') {\n         return '';\n     }\n-    let string = '';\n+    let string = '',\n+        currentString = $(field).val();\n+\n+    // if bSetting is true, we use the setting value\n+    // remove any closing ', string that could corrupt the setting\n+    if (bSetting === true) {\n+        currentString = currentString.replace(/',/g, '');\n+    }\n \n     // Purify string\n-    string = simplePurifier($(field).val(), bHtml, bSvg, bSvgFilters);\n+    string = simplePurifier(\n+        sanitizeDom(currentString),\n+        bHtml,\n+        bSvg,\n+        bSvgFilters\n+    );\n     \n     // Clear field if string is empty and warn user\n     if (string === '') {\n@@ -543,4 +556,12 @@ function fieldDomPurifierWithWarning(\n     }\n \n     return string;\n+}\n+\n+const sanitizeDom = (str) => {\n+    const div = document.createElement('div');\n+    div.textContent = str;\n+    newString = div.innerHTML;\n+    div.remove();\n+    return newString;\n }\n\\ No newline at end of file"
        },
        {
          "filename": "includes/libraries/anti-xss-master/src/voku/helper/AntiXSS.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -455,6 +455,7 @@ public function __construct()\n     {\n         $this->_initNeverAllowedStr();\n         $this->_initNeverAllowedRegex();\n+        UTF8::checkForSupport();\n     }\n \n     /**"
        },
        {
          "filename": "pages/2fa.js.php",
          "status": "modified",
          "additions": 6,
          "deletions": 25,
          "patch": "@@ -55,34 +55,15 @@\n <script type='text/javascript'>\n     //<![CDATA[\n \n-    console.log('2FA loaded')\n-\n-    $(document).on('click', '.generate-key', function() {\n-        var size = $(this).data('length'),\n-            target = $(this).closest('.input-group').find('input').attr('id');\n-\n-        $.post(\n-            'sources/main.queries.php', {\n-                type: 'generate_new_key',\n-                type_category: 'action_key',\n-                size: size\n-            },\n-            function(data) {\n-                $('#' + target).val(data[0].key);\n-            },\n-            'json'\n-        );\n-    })\n-\n-\n     $(document).on('click', '#button-duo-config-check', function() {\n-        var data = \"{\\\"ikey\\\":\\\"\" + sanitizeString($(\"#duo_ikey\").val()) + \"\\\", \\\"skey\\\":\\\"\" + sanitizeString($(\"#duo_skey\").val()) + \"\\\", \\\"host\\\":\\\"\" + sanitizeString($(\"#duo_host\").val()) + \"\\\"}\";\n+        toastr\n+            .info('<?php echo langHdl('loading_item'); ?> ... <i class=\"fas fa-circle-notch fa-spin fa-2x\"></i>');\n \n         // Prepare data\n         var data = {\n-            'duo_ikey': $('#duo_ikey').val(),\n-            'duo_skey': $('#duo_skey').val(),\n-            'duo_host': $('#duo_host').val()\n+            'duo_ikey': sanitizeString($('#duo_ikey').val()),\n+            'duo_skey': sanitizeString($('#duo_skey').val()),\n+            'duo_host': sanitizeString($('#duo_host').val())\n         }\n         console.log(data);\n \n@@ -110,7 +91,7 @@ function(data) {\n                 } else {\n                     // Inform user\n                     toastr.remove();\n-                    toastr.info(\n+                    toastr.success(\n                         '<?php echo langHdl('duo-config-check-success'); ?>',\n                         '', {\n                             timeOut: 5000"
        },
        {
          "filename": "pages/2fa.php",
          "status": "modified",
          "additions": 4,
          "deletions": 4,
          "patch": "@@ -157,7 +157,7 @@\n                                         </small>\n                                     </div>\n                                     <div class=\"col-3\">\n-                                        <input type=\"text\" class=\"form-control form-control-sm\" id=\"ga_website_name\" value=\"<?php echo isset($SETTINGS['ga_website_name']) === true ? $SETTINGS['ga_website_name'] : ''; ?>\">\n+                                        <input type=\"text\" class=\"form-control form-control-sm purify\" data-field=\"label\" id=\"ga_website_name\" value=\"<?php echo isset($SETTINGS['ga_website_name']) === true ? $SETTINGS['ga_website_name'] : ''; ?>\">\n                                     </div>\n                                 </div>\n \n@@ -205,23 +205,23 @@\n                                         <?php echo langHdl('admin_duo_ikey'); ?>\n                                     </div>\n                                     <div class=\"col-7\">\n-                                        <input type=\"text\" class=\"form-control form-control-sm\" id=\"duo_ikey\" value=\"<?php echo isset($SETTINGS['duo_ikey']) === true ? $SETTINGS['duo_ikey'] : ''; ?>\">\n+                                        <input type=\"text\" class=\"form-control form-control-sm purify\" data-field=\"label\" id=\"duo_ikey\" value=\"<?php echo isset($SETTINGS['duo_ikey']) === true ? $SETTINGS['duo_ikey'] : ''; ?>\">\n                                     </div>\n                                 </div>\n                                 <div class=\"row mb-2\">\n                                     <div class=\"col-5\">\n                                         <?php echo langHdl('admin_duo_skey'); ?>\n                                     </div>\n                                     <div class=\"col-7\">\n-                                        <input type=\"text\" class=\"form-control form-control-sm\" id=\"duo_skey\" value=\"<?php echo isset($SETTINGS['duo_skey']) === true ? $SETTINGS['duo_skey'] : ''; ?>\">\n+                                        <input type=\"text\" class=\"form-control form-control-sm purify\" data-field=\"label\" id=\"duo_skey\" value=\"<?php echo isset($SETTINGS['duo_skey']) === true ? $SETTINGS['duo_skey'] : ''; ?>\">\n                                     </div>\n                                 </div>\n                                 <div class=\"row mb-2\">\n                                     <div class=\"col-5\">\n                                         <?php echo langHdl('admin_duo_host'); ?>\n                                     </div>\n                                     <div class=\"col-7\">\n-                                        <input type=\"text\" class=\"form-control form-control-sm\" id=\"duo_host\" value=\"<?php echo isset($SETTINGS['duo_host']) === true ? $SETTINGS['duo_host'] : ''; ?>\">\n+                                        <input type=\"text\" class=\"form-control form-control-sm purify\" data-field=\"label\" id=\"duo_host\" value=\"<?php echo isset($SETTINGS['duo_host']) === true ? $SETTINGS['duo_host'] : ''; ?>\">\n                                     </div>\n                                 </div>\n "
        },
        {
          "filename": "pages/admin.js.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -135,7 +135,7 @@ function(data) {\n         }\n \n         // Sanitize value\n-        value = fieldDomPurifierWithWarning('#' + field);\n+        value = fieldDomPurifierWithWarning('#' + field, false, false, false, true);\n         if (value === false) {\n             return false;\n         }"
        },
        {
          "filename": "pages/users.js.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -898,7 +898,7 @@ function(data) {\n \n                 // Mandatory?\n                 var validated = true,\n-                    validEmailRegex = /^\\w+([\\.-]?\\w+)*@\\w+([\\.-]?\\w+)*(\\.\\w{2,3})+$/;\n+                    validEmailRegex = /^\\w+([\\.-]?\\w+)*@\\w+([\\.-]?\\w+)*(\\.\\w{2,15})+$/;\n                 $('.required').each(function(i, obj) {\n                     if ($(this).val() === '' && $(this).hasClass('select2') === false) {\n                         $(this).addClass('is-invalid');"
        },
        {
          "filename": "sources/logs.datatables.php",
          "status": "modified",
          "additions": 6,
          "deletions": 6,
          "patch": "@@ -838,7 +838,7 @@\n     }\n } elseif (isset($_GET['action']) && $_GET['action'] === 'tasks_in_progress') {\n     //Columns name\n-    $aColumns = ['increment_id', 'created_at', 'updated_at', 'process_type', 'is_in_progress'];\n+    $aColumns = ['p.increment_id', 'p.created_at', 'p.updated_at', 'p.process_type', 'p.is_in_progress'];\n     //Ordering\n     if (isset($_GET['order'][0]['dir']) === true\n         && in_array($_GET['order'][0]['dir'], $aSortTypes) === true\n@@ -854,7 +854,7 @@\n             $aColumns[0].' DESC';\n     }\n \n-    $sWhere = ' WHERE ((finished_at = \"\")';\n+    $sWhere = ' WHERE ((p.finished_at = \"\")';\n     if (isset($_GET['search']['value']) === true && $_GET['search']['value'] !== '') {\n         $sWhere .= ' AND (';\n         for ($i = 0; $i < count($aColumns); ++$i) {\n@@ -865,13 +865,13 @@\n     $sWhere .= ') ';\n     DB::debugmode(false);\n     $iTotal = DB::queryFirstField(\n-    'SELECT COUNT(increment_id)\n+    'SELECT COUNT(p.increment_id)\n         FROM '.prefixTable('processes').' AS p \n         LEFT JOIN '.prefixTable('users').' AS u ON u.id = json_extract(p.arguments, \"$[0]\")'.\n         $sWhere\n     );\n     $rows = DB::query(\n-        'SELECT *\n+        'SELECT p.*\n             FROM '.prefixTable('processes').' AS p \n             LEFT JOIN '.prefixTable('users').' AS u ON u.id = json_extract(p.arguments, \"$[0]\")'.\n             $sWhere.\n@@ -951,14 +951,14 @@\n     \n     DB::debugmode(false);\n     $iTotal = DB::queryFirstField(\n-        'SELECT COUNT(increment_id)\n+        'SELECT COUNT(p.increment_id)\n             FROM '.prefixTable('processes').' AS p \n             LEFT JOIN '.prefixTable('users').' AS u ON u.id = json_extract(p.arguments, \"$[0]\")'.\n             $sWhere\n     );\n \n     $rows = DB::query(\n-        'SELECT *\n+        'SELECT p.*\n             FROM '.prefixTable('processes').' AS p \n             LEFT JOIN '.prefixTable('users').' AS u ON u.id = json_extract(p.arguments, \"$[0]\")'.\n             $sWhere."
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 4,
        "max_directory_depth": 6
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "aacdf6a3f2daf9b52a826d4b3d8a39873e2e2062",
            "date": "2025-01-13T17:24:23Z",
            "author_login": "nilsteampassnet"
          },
          {
            "sha": "eb95bc3e37f6e1f19fce98aa4c44c251f2084cd7",
            "date": "2025-01-13T17:20:31Z",
            "author_login": "nilsteampassnet"
          },
          {
            "sha": "9969d0ef636e28c1afcdb047aac2d2a5387b62b5",
            "date": "2025-01-12T17:29:37Z",
            "author_login": "nilsteampassnet"
          },
          {
            "sha": "4963736272bc4b281586f8ad4dcee70015d595b1",
            "date": "2025-01-12T17:22:24Z",
            "author_login": "nilsteampassnet"
          },
          {
            "sha": "b5a997952a43e4760c9eaceedfd9a7ba4a5683d2",
            "date": "2025-01-10T16:06:22Z",
            "author_login": "nilsteampassnet"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 7.2,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H",
    "cwe_id": "CWE-94",
    "description": " Code Injection in GitHub repository nilsteampassnet/teampass prior to 3.0.10.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-07-08T09:15:42.750",
    "last_modified": "2024-11-21T08:17:31.210",
    "fix_date": "2023-07-08T08:02:56Z"
  },
  "references": [
    {
      "url": "https://github.com/nilsteampassnet/teampass/commit/cc6abc76aa46ed4a27736c1d2f21e432a5d54e6f",
      "source": "security@huntr.dev",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/cf8878ff-6cd9-49be-b313-7ac2a94fc7f7",
      "source": "security@huntr.dev",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/nilsteampassnet/teampass/commit/cc6abc76aa46ed4a27736c1d2f21e432a5d54e6f",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://huntr.dev/bounties/cf8878ff-6cd9-49be-b313-7ac2a94fc7f7",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:06:01.904599",
    "processing_status": "enhanced"
  }
}