{
  "cve_id": "CVE-2023-37473",
  "github_data": {
    "repository": "zenstruck/collection",
    "fix_commit": "f4b1c488206e1b1581b06fcd331686846f13f19c",
    "related_commits": [
      "f4b1c488206e1b1581b06fcd331686846f13f19c",
      "f4b1c488206e1b1581b06fcd331686846f13f19c"
    ],
    "patch_url": "https://github.com/zenstruck/collection/commit/f4b1c488206e1b1581b06fcd331686846f13f19c.patch",
    "fix_commit_details": {
      "sha": "f4b1c488206e1b1581b06fcd331686846f13f19c",
      "commit_date": "2023-07-14T14:21:50Z",
      "author": {
        "login": "kbond",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "security(orm): prevent passing callable strings to `find()`/`query()`",
        "length": 69,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 35,
        "additions": 29,
        "deletions": 6
      },
      "files": [
        {
          "filename": "src/Collection/Doctrine/ORM/EntityRepository.php",
          "status": "modified",
          "additions": 4,
          "deletions": 4,
          "patch": "@@ -33,7 +33,7 @@ public function __construct(private EntityManagerInterface $em, private string $\n     }\n \n     /**\n-     * @param mixed|Criteria|array<string,mixed>|callable(QueryBuilder):void $specification\n+     * @param mixed|Criteria|array<string,mixed>|(object&callable(QueryBuilder):void) $specification\n      */\n     public function find(mixed $specification): ?object\n     {\n@@ -46,7 +46,7 @@ public function find(mixed $specification): ?object\n                 return $this->em()->getUnitOfWork()->getEntityPersister($this->class)->load($specification, limit: 1); // @phpstan-ignore-line\n             }\n \n-            if (\\is_callable($specification)) {\n+            if (\\is_callable($specification) && \\is_object($specification)) {\n                 $specification($qb = $this->qb(), 'e');\n \n                 return $qb->getQuery()->getSingleResult();\n@@ -59,7 +59,7 @@ public function find(mixed $specification): ?object\n     }\n \n     /**\n-     * @param Criteria|array<string,mixed>|callable(QueryBuilder):void $specification\n+     * @param Criteria|array<string,mixed>|(object&callable(QueryBuilder):void) $specification\n      *\n      * @return EntityResult<V>\n      */\n@@ -71,7 +71,7 @@ public function query(mixed $specification): EntityResult\n             return $qb->addCriteria($specification)->result();\n         }\n \n-        if (\\is_callable($specification)) {\n+        if (\\is_callable($specification) && \\is_object($specification)) {\n             $specification($qb, 'e');\n \n             return $qb->result();"
        },
        {
          "filename": "src/Collection/Doctrine/ORM/EntityRepositoryBridge.php",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -25,7 +25,7 @@ trait EntityRepositoryBridge\n     private EntityRepository $collectionRepo;\n \n     /**\n-     * @param mixed|Criteria|array<string,mixed>|callable(QueryBuilder):void $specification\n+     * @param mixed|Criteria|array<string,mixed>|(object&callable(QueryBuilder):void) $specification\n      */\n     public function find($specification, $lockMode = null, $lockVersion = null): ?object\n     {\n@@ -38,7 +38,7 @@ public function find($specification, $lockMode = null, $lockVersion = null): ?ob\n     }\n \n     /**\n-     * @param Criteria|array<string,mixed>|callable(QueryBuilder):void $specification\n+     * @param Criteria|array<string,mixed>|(object&callable(QueryBuilder):void) $specification\n      *\n      * @return EntityResult<V>\n      */"
        },
        {
          "filename": "tests/Doctrine/ORM/EntityRepositoryTest.php",
          "status": "modified",
          "additions": 23,
          "deletions": 0,
          "patch": "@@ -155,6 +155,29 @@ public function can_filter_with_callable(): void\n         $this->assertSame('value 2', \\iterator_to_array($objects)[0]->value);\n     }\n \n+    /**\n+     * @test\n+     */\n+    public function cannot_find_with_callable_strings(): void\n+    {\n+        $this->assertIsCallable('system');\n+        $this->assertNull($this->repo()->find('system'));\n+    }\n+\n+    /**\n+     * @test\n+     */\n+    public function cannot_query_with_callable_strings(): void\n+    {\n+        $this->assertIsCallable('system');\n+\n+        $repo = $this->repo();\n+\n+        $this->expectException(\\InvalidArgumentException::class);\n+\n+        $repo->query('system');\n+    }\n+\n     /**\n      * @test\n      */"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 2,
        "max_directory_depth": 4
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "fc126936e76d24ba6c5ad49df6b1e7eefe9cb62c",
            "date": "2024-11-23T20:48:41Z",
            "author_login": "kbond"
          },
          {
            "sha": "f9d0ee7c1dabf8bf731716697497da53c66f19ad",
            "date": "2024-11-23T20:45:19Z",
            "author_login": "kbond"
          },
          {
            "sha": "c614171403b2c5bba9b38bde8e5973794f683679",
            "date": "2024-11-23T20:11:10Z",
            "author_login": "kbond"
          },
          {
            "sha": "4bbf2264a9b575343957e8c2c32bc44e4daa796a",
            "date": "2024-11-23T19:38:48Z",
            "author_login": "kbond"
          },
          {
            "sha": "ffa728bb113be8ae2a28722301a8328b4bb0908b",
            "date": "2024-10-28T18:11:15Z",
            "author_login": "kbond"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 8.5,
    "cvss_vector": "CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:C/C:H/I:H/A:H",
    "cwe_id": "CWE-74",
    "description": "zenstruck/collections is a set of helpers for iterating/paginating/filtering collections. Passing _callable strings_ (ie `system`) caused the function to be executed. This would result in a limited subset of specific user input being executed as if it were code. This issue has been addressed in commit `f4b1c48820` and included in release version 0.2.1. Users are advised to upgrade. Users unable to upgrade should ensure that user input is not passed to either `EntityRepository::find()` or `query()`.",
    "attack_vector": "NETWORK",
    "attack_complexity": "HIGH"
  },
  "temporal_data": {
    "published_date": "2023-07-14T21:15:09.047",
    "last_modified": "2024-11-21T08:11:47.053",
    "fix_date": "2023-07-14T14:21:50Z"
  },
  "references": [
    {
      "url": "https://github.com/zenstruck/collection/commit/f4b1c488206e1b1581b06fcd331686846f13f19c",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/zenstruck/collection/releases/tag/v0.2.1",
      "source": "security-advisories@github.com",
      "tags": [
        "Release Notes"
      ]
    },
    {
      "url": "https://github.com/zenstruck/collection/security/advisories/GHSA-7xr2-8ff7-6fjq",
      "source": "security-advisories@github.com",
      "tags": [
        "Mitigation"
      ]
    },
    {
      "url": "https://github.com/zenstruck/collection/commit/f4b1c488206e1b1581b06fcd331686846f13f19c",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/zenstruck/collection/releases/tag/v0.2.1",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes"
      ]
    },
    {
      "url": "https://github.com/zenstruck/collection/security/advisories/GHSA-7xr2-8ff7-6fjq",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mitigation"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:06:04.244362",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "collection",
    "owner": "zenstruck",
    "created_at": "2021-04-27T19:04:29Z",
    "updated_at": "2024-11-23T20:48:45Z",
    "pushed_at": "2024-11-23T20:49:33Z",
    "size": 497,
    "stars": 13,
    "forks": 2,
    "open_issues": 1,
    "watchers": 13,
    "has_security_policy": false,
    "default_branch": "1.x",
    "protected_branches": [],
    "languages": {
      "PHP": 289576,
      "Twig": 2565
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-14T18:00:21.652856"
  }
}