{
  "cve_id": "CVE-2023-37480",
  "github_data": {
    "repository": "ethyca/fides",
    "fix_commit": "5aea738463960d81821c11ae7ade1d627a46bf32",
    "related_commits": [
      "5aea738463960d81821c11ae7ade1d627a46bf32",
      "5aea738463960d81821c11ae7ade1d627a46bf32"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "5aea738463960d81821c11ae7ade1d627a46bf32",
      "commit_date": "2023-07-06T16:46:17Z",
      "author": {
        "login": "galvana",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Merge pull request from GHSA-g95c-2jgm-hqc6",
        "length": 118,
        "has_description": true,
        "references_issue": false
      },
      "stats": {
        "total": 64,
        "additions": 64,
        "deletions": 0
      },
      "files": [
        {
          "filename": "src/fides/api/service/connectors/saas/connector_registry_service.py",
          "status": "modified",
          "additions": 4,
          "deletions": 0,
          "patch": "@@ -40,6 +40,7 @@\n     replace_dataset_placeholders,\n     replace_version,\n )\n+from fides.api.util.unsafe_file_util import verify_zip\n from fides.config import CONFIG\n \n \n@@ -181,6 +182,9 @@ def save_template(cls, db: Session, zip_file: ZipFile) -> None:\n         custom connector template, registers the template, and saves it to the database.\n         \"\"\"\n \n+        # verify the zip file before we use it\n+        verify_zip(zip_file)\n+\n         config_contents = None\n         dataset_contents = None\n         icon_contents = None"
        },
        {
          "filename": "src/fides/api/util/unsafe_file_util.py",
          "status": "added",
          "additions": 34,
          "deletions": 0,
          "patch": "@@ -0,0 +1,34 @@\n+from typing import Optional\n+from zipfile import ZipFile\n+\n+MAX_FILE_SIZE = 16 * 1024 * 1024  # 16 MB\n+CHUNK_SIZE = 1024\n+\n+\n+def verify_zip(zip_file: ZipFile, max_file_size: Optional[int] = None) -> None:\n+    \"\"\"\n+    Function to safely verify the contents of zipped files. It prevents potential\n+    'zip bomb' attacks by checking the file size of the files in the zip without fully\n+    extracting them. If the size of any file in the zip exceeds the specified\n+    max_file_size, it raises a ValueError. If the max_file_size is not provided,\n+    it uses a default value of 16 MB.\n+\n+    :param zip_file: A ZipFile object to be verified.\n+    :param max_file_size: An optional integer specifying the maximum bytes allowed per file. If not provided, a default value is used.\n+    :raises ValueError: If a file in the zip file exceeds the maximum allowed size\n+    \"\"\"\n+\n+    if max_file_size is None:\n+        max_file_size = MAX_FILE_SIZE\n+\n+    for file_info in zip_file.infolist():\n+        file_size = 0\n+\n+        with zip_file.open(file_info) as file:\n+            # wraps the file read in an iterator that stops once no bytes\n+            # are returned or the max file size is reached\n+            for chunk in iter(lambda: file.read(CHUNK_SIZE), b\"\"):\n+                file_size += len(chunk)\n+\n+                if file_size > max_file_size:\n+                    raise ValueError(\"File size exceeds maximum allowed size\")"
        },
        {
          "filename": "tests/ops/util/test_unsafe_file_util.py",
          "status": "added",
          "additions": 26,
          "deletions": 0,
          "patch": "@@ -0,0 +1,26 @@\n+from io import BytesIO\n+from zipfile import ZipFile\n+\n+import pytest\n+\n+from fides.api.util.unsafe_file_util import verify_zip\n+from tests.ops.test_helpers.saas_test_utils import create_zip_file\n+\n+\n+class TestVerifyZip:\n+    @pytest.fixture\n+    def zip_file(self) -> BytesIO:\n+        return create_zip_file(\n+            {\n+                \"config.yml\": \"This file isn't that big, but it will be considered suspicious if the max file size is set too low\",\n+            }\n+        )\n+\n+    def test_verify_zip(self, zip_file):\n+        verify_zip(ZipFile(zip_file))\n+\n+    def test_verify_zip_with_small_file_size_limit(self, zip_file):\n+        \"\"\"We set the max file size to 1 byte, so the zip file should be rejected.\"\"\"\n+        with pytest.raises(ValueError) as exc:\n+            verify_zip(ZipFile(zip_file), 1)\n+        assert \"File size exceeds maximum allowed size\" in str(exc.value)"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 3,
        "max_directory_depth": 6
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "a51da8fc111d2b2dad6dcd48e455f6a6804e1c54",
            "date": "2025-01-23T01:06:09Z",
            "author_login": "JadeCara"
          },
          {
            "sha": "1174c2c31153f92fc6b07b955b62a2d1832b240e",
            "date": "2025-01-22T22:03:02Z",
            "author_login": "lucanovera"
          },
          {
            "sha": "abbb24e8d40e82c6cbe331693c85efc8ff43aa59",
            "date": "2025-01-22T19:28:53Z",
            "author_login": "thingscouldbeworse"
          },
          {
            "sha": "bbba31d7fe61655665653fea2b88b635adea102c",
            "date": "2025-01-21T20:16:26Z",
            "author_login": "adamsachs"
          },
          {
            "sha": "7043171c4d6f3564c93e39b48abf9f53f6af0dbe",
            "date": "2025-01-20T21:07:10Z",
            "author_login": "Vagoasdf"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 2.7,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:N/I:N/A:L",
    "cwe_id": "CWE-400",
    "description": "Fides is an open-source privacy engineering platform for managing data privacy requests and privacy regulations. The Fides webserver is vulnerable to a type of Denial of Service (DoS) attack. Attackers can exploit a weakness in the connector template upload feature to upload a malicious zip bomb file, resulting in resource exhaustion and service unavailability for all users of the Fides webserver. This vulnerability affects Fides versions `2.11.0` through `2.15.1`. Exploitation is limited to users with elevated privileges with the `CONNECTOR_TEMPLATE_REGISTER` scope, which includes root users and users with the owner role. The vulnerability has been patched in Fides version `2.16.0`. Users are advised to upgrade to this version or later to secure their systems against this threat. There is no known workaround to remediate this vulnerability without upgrading. If an attack occurs, the impact can be mitigated by manually or automatically restarting the affected container.\n",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-07-18T19:15:09.840",
    "last_modified": "2024-11-21T08:11:48.090",
    "fix_date": "2023-07-06T16:46:17Z"
  },
  "references": [
    {
      "url": "https://github.com/ethyca/fides/commit/5aea738463960d81821c11ae7ade1d627a46bf32",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/ethyca/fides/security/advisories/GHSA-g95c-2jgm-hqc6",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/ethyca/fides/commit/5aea738463960d81821c11ae7ade1d627a46bf32",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/ethyca/fides/security/advisories/GHSA-g95c-2jgm-hqc6",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:06:04.253788",
    "processing_status": "enhanced"
  },
  "repository_context": {
    "name": "fides",
    "owner": "ethyca",
    "created_at": "2021-02-04T22:42:33Z",
    "updated_at": "2025-01-24T10:02:27Z",
    "pushed_at": "2025-01-24T16:30:49Z",
    "size": 111165,
    "stars": 385,
    "forks": 74,
    "open_issues": 278,
    "watchers": 385,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [],
    "languages": {
      "Python": 7135477,
      "TypeScript": 4467849,
      "CSS": 38461,
      "JavaScript": 32908,
      "HTML": 32388,
      "SCSS": 15015,
      "Dockerfile": 4511,
      "Jinja": 3618,
      "Mako": 494
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "apache-2.0"
    },
    "collected_at": "2025-01-26T07:40:51.642007"
  }
}