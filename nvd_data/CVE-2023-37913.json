{
  "cve_id": "CVE-2023-37913",
  "github_data": {
    "repository": "xwiki/xwiki-platform",
    "fix_commit": "45d182a4141ff22f3ff289cf71e4669bdc714544",
    "related_commits": [
      "45d182a4141ff22f3ff289cf71e4669bdc714544",
      "45d182a4141ff22f3ff289cf71e4669bdc714544"
    ],
    "patch_url": "https://github.com/xwiki/xwiki-platform/commit/45d182a4141ff22f3ff289cf71e4669bdc714544.patch",
    "fix_commit_details": {
      "sha": "45d182a4141ff22f3ff289cf71e4669bdc714544",
      "commit_date": "2023-03-10T16:26:25Z",
      "author": {
        "login": "michitux",
        "type": "User",
        "stats": {
          "total_commits": 378,
          "average_weekly_commits": 0.39622641509433965,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 108
        }
      },
      "commit_message": {
        "title": "XWIKI-20715: Don't use user-provided filenames in office import",
        "length": 1012,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 1071,
        "additions": 836,
        "deletions": 235
      },
      "files": [
        {
          "filename": "xwiki-platform-core/xwiki-platform-bridge/src/main/java/org/xwiki/bridge/DocumentAccessBridge.java",
          "status": "modified",
          "additions": 18,
          "deletions": 0,
          "patch": "@@ -23,6 +23,7 @@\n import java.util.List;\n import java.util.Map;\n \n+import org.apache.commons.io.IOUtils;\n import org.apache.commons.lang3.NotImplementedException;\n import org.xwiki.component.annotation.Role;\n import org.xwiki.model.EntityType;\n@@ -539,6 +540,23 @@ default InputStream getAttachmentContent(EntityReference reference) throws Excep\n      */\n     void setAttachmentContent(AttachmentReference attachmentReference, byte[] attachmentData) throws Exception;\n \n+    /**\n+     * Sets the content of a document attachment. If the document or the attachment does not exist, both will be created\n+     * newly.\n+     *\n+     * @param attachmentReference the name of the attachment to access\n+     * @param attachmentData Attachment content.\n+     * @throws Exception If the storage cannot be accessed.\n+     * @since 14.10.8\n+     * @since 15.3RC1\n+     */\n+    @Unstable\n+    default void setAttachmentContent(AttachmentReference attachmentReference, InputStream attachmentData)\n+        throws Exception\n+    {\n+        setAttachmentContent(attachmentReference, IOUtils.toByteArray(attachmentData));\n+    }\n+\n     /**\n      * Sets the content of a document attachment. If the document or the attachment does not exist, both will be created\n      * newly."
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-legacy/xwiki-platform-legacy-office/xwiki-platform-legacy-office-importer/src/main/aspect/org/xwiki/officeimporter/document/CompatibilityOfficeDocument.java",
          "status": "modified",
          "additions": 21,
          "deletions": 1,
          "patch": "@@ -19,7 +19,10 @@\n  */\n package org.xwiki.officeimporter.document;\n \n+import java.io.File;\n+import java.util.Collections;\n import java.util.Map;\n+import java.util.Set;\n \n public interface CompatibilityOfficeDocument\n {\n@@ -30,8 +33,25 @@ public interface CompatibilityOfficeDocument\n      * as artifacts.\n      *\n      * @return a map containing artifacts for this document.\n-     * @deprecated Since 13.1RC1 use {@link OfficeDocument#getArtifactsFiles()}.\n+     * @deprecated Since 13.1RC1 use {@link #getArtifactsFiles()}.\n      */\n     @Deprecated\n     Map<String, byte[]> getArtifacts();\n+\n+    /**\n+     * Returns the files corresponding to all the artifacts for this office document, except the conversion of the\n+     * document itself.\n+     * Artifacts are generated during the import operation if the original office document contains embedded\n+     * non-textual elements. Also, some office formats (like presentations) result in multiple output files when\n+     * converted into html. In this case all these output files will be considered as artifacts.\n+     *\n+     * @return the set of artifacts related to this office document.\n+     * @since 13.1RC1\n+     * @deprecated Use {@link OfficeDocument#getArtifactsMap()} instead.\n+     */\n+    @Deprecated(since = \"15.3RC1, 14.10.8\")\n+    default Set<File> getArtifactsFiles()\n+    {\n+        return Collections.emptySet();\n+    }\n }"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-legacy/xwiki-platform-legacy-office/xwiki-platform-legacy-office-importer/src/main/aspect/org/xwiki/officeimporter/document/XDOMOfficeDocumentCompatibilityAspect.aj",
          "status": "modified",
          "additions": 48,
          "deletions": 11,
          "patch": "@@ -20,23 +20,31 @@\n package org.xwiki.officeimporter.document;\n \n import java.io.File;\n-import java.io.FileInputStream;\n import java.io.IOException;\n+import java.io.InputStream;\n import java.util.Collections;\n import java.util.HashMap;\n import java.util.Map;\n import java.util.Set;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n \n import org.apache.commons.io.IOUtils;\n import org.xwiki.component.manager.ComponentManager;\n+import org.xwiki.officeimporter.OfficeImporterException;\n import org.xwiki.officeimporter.converter.OfficeConverterResult;\n+import org.xwiki.officeimporter.internal.document.ByteArrayOfficeDocumentArtifact;\n+import org.xwiki.officeimporter.internal.document.FileOfficeDocumentArtifact;\n import org.xwiki.rendering.block.XDOM;\n \n public privileged aspect XDOMOfficeDocumentCompatibilityAspect\n {\n     @Deprecated\n     private Map<String, byte[]> XDOMOfficeDocument.artifacts;\n \n+    @Deprecated\n+    private Set<File> XDOMOfficeDocument.fileArtifacts;\n+\n     /**\n      * Creates a new {@link XDOMOfficeDocument}.\n      *\n@@ -48,10 +56,33 @@ public privileged aspect XDOMOfficeDocumentCompatibilityAspect\n     @Deprecated\n     public XDOMOfficeDocument.new(XDOM xdom, Map<String, byte[]> artifacts, ComponentManager componentManager)\n     {\n-        this(xdom, Collections.emptySet(), componentManager, null);\n+        this(xdom, artifacts.entrySet().stream()\n+                .map(entry -> new ByteArrayOfficeDocumentArtifact(entry.getKey(), entry.getValue()))\n+                .collect(Collectors.toMap(ByteArrayOfficeDocumentArtifact::getName, Function.identity())),\n+            componentManager, null);\n         this.artifacts = artifacts;\n     }\n \n+    /**\n+     * Creates a new {@link XDOMOfficeDocument}.\n+     *\n+     * @param xdom {@link XDOM} corresponding to office document content.\n+     * @param artifactFiles artifacts for this office document.\n+     * @param componentManager {@link ComponentManager} used to lookup for various renderers.\n+     * @param converterResult the {@link OfficeConverterResult} used to build that object.\n+     * @since 13.1RC1\n+     * @deprecated Use {@link #XDOMOfficeDocument(XDOM, Map, ComponentManager, OfficeConverterResult)} instead.\n+     */\n+    @Deprecated(since = \"14.10.8, 15.3RC1\")\n+    public XDOMOfficeDocument.new(XDOM xdom, Set<File> artifactFiles, ComponentManager componentManager,\n+        OfficeConverterResult converterResult)\n+    {\n+        this(xdom, artifactFiles.stream().collect(Collectors.toMap(File::getName,\n+                file -> new FileOfficeDocumentArtifact(file.getName(), file))),\n+            componentManager, converterResult);\n+        this.fileArtifacts = artifactFiles;\n+    }\n+\n     /**\n      * Overrides {@link CompatibilityOfficeDocument#getArtifacts()}.\n      */\n@@ -60,20 +91,26 @@ public privileged aspect XDOMOfficeDocumentCompatibilityAspect\n     {\n         if (this.artifacts == null) {\n             this.artifacts = new HashMap<>();\n-            FileInputStream fis = null;\n-\n-            for (File file : this.artifactFiles) {\n-                try {\n-                    fis = new FileInputStream(file);\n-                    this.artifacts.put(file.getName(), IOUtils.toByteArray(fis));\n-                } catch (IOException e) {\n+            for (Map.Entry<String, OfficeDocumentArtifact> mapItem : this.artifactsMap.entrySet()) {\n+                OfficeDocumentArtifact artifact = mapItem.getValue();\n+                String fileName = mapItem.getKey();\n+                try (InputStream is = artifact.getContentInputStream()) {\n+                    this.artifacts.put(fileName, IOUtils.toByteArray(is));\n+                } catch (OfficeImporterException | IOException e) {\n                     // FIXME\n                     e.printStackTrace();\n-                } finally {\n-                    IOUtils.closeQuietly(fis);\n                 }\n             }\n         }\n         return this.artifacts;\n     }\n+\n+    /**\n+     * Overrides {@link CompatibilityOfficeDocument#getArtifactsFiles()}.\n+     */\n+    @Deprecated\n+    public Set<File> XDOMOfficeDocument.getArtifactsFiles()\n+    {\n+        return this.fileArtifacts != null ? this.fileArtifacts : Collections.emptySet();\n+    }\n }"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-legacy/xwiki-platform-legacy-office/xwiki-platform-legacy-office-importer/src/main/aspect/org/xwiki/officeimporter/document/XHTMLOfficeDocumentCompatibilityAspect.aj",
          "status": "modified",
          "additions": 46,
          "deletions": 11,
          "patch": "@@ -20,22 +20,30 @@\n package org.xwiki.officeimporter.document;\n \n import java.io.File;\n-import java.io.FileInputStream;\n import java.io.IOException;\n+import java.io.InputStream;\n import java.util.Collections;\n import java.util.HashMap;\n import java.util.Map;\n import java.util.Set;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n \n import org.apache.commons.io.IOUtils;\n import org.w3c.dom.Document;\n+import org.xwiki.officeimporter.OfficeImporterException;\n import org.xwiki.officeimporter.converter.OfficeConverterResult;\n+import org.xwiki.officeimporter.internal.document.ByteArrayOfficeDocumentArtifact;\n+import org.xwiki.officeimporter.internal.document.FileOfficeDocumentArtifact;\n \n public privileged aspect XHTMLOfficeDocumentCompatibilityAspect\n {\n     @Deprecated\n     private Map<String, byte[]> XHTMLOfficeDocument.artifacts;\n \n+    @Deprecated\n+    private Set<File> XHTMLOfficeDocument.fileArtifacts;\n+\n     /**\n      * Creates a new {@link XHTMLOfficeDocument}.\n      *\n@@ -46,10 +54,31 @@ public privileged aspect XHTMLOfficeDocumentCompatibilityAspect\n     @Deprecated\n     public XHTMLOfficeDocument.new(Document document, Map<String, byte[]> artifacts)\n     {\n-        this(document, Collections.emptySet(), null);\n+        this(document, artifacts.entrySet().stream()\n+                .map(entry -> new ByteArrayOfficeDocumentArtifact(entry.getKey(), entry.getValue()))\n+                .collect(Collectors.toMap(ByteArrayOfficeDocumentArtifact::getName, Function.identity())),\n+            null);\n         this.artifacts = artifacts;\n     }\n \n+    /**\n+     * Creates a new {@link XHTMLOfficeDocument}.\n+     *\n+     * @param document the w3c dom representing the office document.\n+     * @param artifactFiles artifacts for this office document.\n+     * @param converterResult the {@link OfficeConverterResult} used to build that object.\n+     * @since 13.1RC1\n+     * @deprecated Use {@link #XHTMLOfficeDocument(Document, Map, OfficeConverterResult)} instead.\n+     */\n+    @Deprecated(since = \"14.10.8, 15.3RC1\")\n+    public XHTMLOfficeDocument.new(Document document, Set<File> artifactFiles, OfficeConverterResult converterResult)\n+    {\n+        this(document, artifactFiles.stream().collect(Collectors.toMap(File::getName,\n+                file -> new FileOfficeDocumentArtifact(file.getName(), file))),\n+            converterResult);\n+        this.fileArtifacts = artifactFiles;\n+    }\n+\n     /**\n      * Overrides {@link CompatibilityOfficeDocument#getArtifacts()}.\n      */\n@@ -58,20 +87,26 @@ public privileged aspect XHTMLOfficeDocumentCompatibilityAspect\n     {\n         if (this.artifacts == null) {\n             this.artifacts = new HashMap<>();\n-            FileInputStream fis = null;\n-\n-            for (File file : this.artifactFiles) {\n-                try {\n-                    fis = new FileInputStream(file);\n-                    this.artifacts.put(file.getName(), IOUtils.toByteArray(fis));\n-                } catch (IOException e) {\n+            for (Map.Entry<String, OfficeDocumentArtifact> mapItem : this.artifactsMap.entrySet()) {\n+                OfficeDocumentArtifact artifact = mapItem.getValue();\n+                String fileName = mapItem.getKey();\n+                try (InputStream is = artifact.getContentInputStream()) {\n+                    this.artifacts.put(fileName, IOUtils.toByteArray(is));\n+                } catch (OfficeImporterException | IOException e) {\n                     // FIXME\n                     e.printStackTrace();\n-                } finally {\n-                    IOUtils.closeQuietly(fis);\n                 }\n             }\n         }\n         return this.artifacts;\n     }\n+\n+    /**\n+     * Overrides {@link CompatibilityOfficeDocument#getArtifactsFiles()}.\n+     */\n+    @Deprecated(since = \"14.10.8, 15.3RC1\")\n+    public Set<File> XHTMLOfficeDocument.getArtifactsFiles()\n+    {\n+        return this.fileArtifacts != null ? this.fileArtifacts : Collections.emptySet();\n+    }\n }"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/document/OfficeDocument.java",
          "status": "modified",
          "additions": 10,
          "deletions": 6,
          "patch": "@@ -20,12 +20,12 @@\n package org.xwiki.officeimporter.document;\n \n import java.io.Closeable;\n-import java.io.File;\n import java.io.IOException;\n import java.util.Collections;\n-import java.util.Set;\n+import java.util.Map;\n \n import org.xwiki.officeimporter.converter.OfficeConverterResult;\n+import org.xwiki.stability.Unstable;\n \n /**\n  * Represents an office document being imported.\n@@ -57,13 +57,17 @@ public interface OfficeDocument extends Closeable\n      * Artifacts are generated during the import operation if the original office document contains embedded\n      * non-textual elements. Also, some office formats (like presentations) result in multiple output files when\n      * converted into html. In this case all these output files will be considered as artifacts.\n+     * <p>\n+     * The key of the map is the artifact name.\n      *\n-     * @return the set of artifacts related to this office document.\n-     * @since 13.1RC1\n+     * @return the map of artifact names to artifacts related to this office document\n+     * @since 14.10.8\n+     * @since 15.3RC1\n      */\n-    default Set<File> getArtifactsFiles()\n+    @Unstable\n+    default Map<String, OfficeDocumentArtifact> getArtifactsMap()\n     {\n-        return Collections.emptySet();\n+        return Collections.emptyMap();\n     }\n \n     /**"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/document/OfficeDocumentArtifact.java",
          "status": "added",
          "additions": 46,
          "deletions": 0,
          "patch": "@@ -0,0 +1,46 @@\n+/*\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+package org.xwiki.officeimporter.document;\n+\n+import java.io.InputStream;\n+\n+import org.xwiki.officeimporter.OfficeImporterException;\n+import org.xwiki.stability.Unstable;\n+\n+/**\n+ * An artifact for an office document.\n+ *\n+ * @version $Id$\n+ * @since 14.10.8\n+ * @since 15.3RC1\n+ */\n+@Unstable\n+public interface OfficeDocumentArtifact\n+{\n+    /**\n+     * @return the name of the artifact\n+     */\n+    String getName();\n+\n+    /**\n+     * @return an input stream for reading the artifact's content\n+     */\n+    InputStream getContentInputStream() throws OfficeImporterException;\n+}"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/document/XDOMOfficeDocument.java",
          "status": "modified",
          "additions": 12,
          "deletions": 10,
          "patch": "@@ -19,9 +19,8 @@\n  */\n package org.xwiki.officeimporter.document;\n \n-import java.io.File;\n import java.io.IOException;\n-import java.util.Set;\n+import java.util.Map;\n \n import org.apache.commons.lang3.StringUtils;\n import org.xwiki.component.manager.ComponentLookupException;\n@@ -35,6 +34,7 @@\n import org.xwiki.rendering.renderer.printer.DefaultWikiPrinter;\n import org.xwiki.rendering.renderer.printer.WikiPrinter;\n import org.xwiki.rendering.syntax.Syntax;\n+import org.xwiki.stability.Unstable;\n \n /**\n  * An {@link OfficeDocument} backed by an {@link XDOM} document.\n@@ -52,7 +52,7 @@ public class XDOMOfficeDocument implements OfficeDocument\n     /**\n      * Artifacts for this office document.\n      */\n-    private Set<File> artifactFiles;\n+    private final Map<String, OfficeDocumentArtifact> artifactsMap;\n \n     /**\n      * {@link ComponentManager} used to lookup for various renderers.\n@@ -65,16 +65,18 @@ public class XDOMOfficeDocument implements OfficeDocument\n      * Creates a new {@link XDOMOfficeDocument}.\n      *\n      * @param xdom {@link XDOM} corresponding to office document content.\n-     * @param artifactFiles artifacts for this office document.\n+     * @param artifacts artifacts for this office document.\n      * @param componentManager {@link ComponentManager} used to lookup for various renderers.\n      * @param converterResult the {@link OfficeConverterResult} used to build that object.\n-     * @since 13.1RC1\n+     * @since 14.10.8\n+     * @since 15.3-rc-1\n      */\n-    public XDOMOfficeDocument(XDOM xdom, Set<File> artifactFiles, ComponentManager componentManager,\n-        OfficeConverterResult converterResult)\n+    @Unstable\n+    public XDOMOfficeDocument(XDOM xdom, Map<String, OfficeDocumentArtifact> artifacts,\n+        ComponentManager componentManager, OfficeConverterResult converterResult)\n     {\n         this.xdom = xdom;\n-        this.artifactFiles = artifactFiles;\n+        this.artifactsMap = artifacts;\n         this.componentManager = componentManager;\n         this.converterResult = converterResult;\n     }\n@@ -111,9 +113,9 @@ public String getContentAsString(String syntaxId)\n     }\n \n     @Override\n-    public Set<File> getArtifactsFiles()\n+    public Map<String, OfficeDocumentArtifact> getArtifactsMap()\n     {\n-        return this.artifactFiles;\n+        return this.artifactsMap;\n     }\n \n     /**"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/document/XHTMLOfficeDocument.java",
          "status": "modified",
          "additions": 12,
          "deletions": 9,
          "patch": "@@ -19,12 +19,12 @@\n  */\n package org.xwiki.officeimporter.document;\n \n-import java.io.File;\n import java.io.IOException;\n-import java.util.Set;\n+import java.util.Map;\n \n import org.w3c.dom.Document;\n import org.xwiki.officeimporter.converter.OfficeConverterResult;\n+import org.xwiki.stability.Unstable;\n import org.xwiki.xml.html.HTMLUtils;\n \n /**\n@@ -43,22 +43,25 @@ public class XHTMLOfficeDocument implements OfficeDocument\n     /**\n      * Artifacts for this office document.\n      */\n-    private Set<File> artifactFiles;\n+    private Map<String, OfficeDocumentArtifact> artifactsMap;\n \n     private OfficeConverterResult converterResult;\n \n     /**\n      * Creates a new {@link XHTMLOfficeDocument}.\n      *\n      * @param document the w3c dom representing the office document.\n-     * @param artifactFiles artifacts for this office document.\n+     * @param artifacts artifacts for this office document.\n      * @param converterResult the {@link OfficeConverterResult} used to build that object.\n-     * @since 13.1RC1\n+     * @since 14.10.8\n+     * @since 15.3RC1\n      */\n-    public XHTMLOfficeDocument(Document document, Set<File> artifactFiles, OfficeConverterResult converterResult)\n+    @Unstable\n+    public XHTMLOfficeDocument(Document document, Map<String, OfficeDocumentArtifact> artifacts,\n+        OfficeConverterResult converterResult)\n     {\n         this.document = document;\n-        this.artifactFiles = artifactFiles;\n+        this.artifactsMap = artifacts;\n         this.converterResult = converterResult;\n     }\n \n@@ -75,9 +78,9 @@ public String getContentAsString()\n     }\n \n     @Override\n-    public Set<File> getArtifactsFiles()\n+    public Map<String, OfficeDocumentArtifact> getArtifactsMap()\n     {\n-        return this.artifactFiles;\n+        return this.artifactsMap;\n     }\n \n     @Override"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/internal/ModelBridge.java",
          "status": "modified",
          "additions": 14,
          "deletions": 14,
          "patch": "@@ -19,20 +19,20 @@\n  */\n package org.xwiki.officeimporter.internal;\n \n-import java.io.File;\n-import java.io.FileInputStream;\n-import java.util.Set;\n+import java.io.InputStream;\n+import java.util.Map;\n \n import javax.inject.Inject;\n import javax.inject.Singleton;\n \n-import org.apache.commons.io.IOUtils;\n+import org.apache.commons.lang3.exception.ExceptionUtils;\n import org.slf4j.Logger;\n import org.xwiki.bridge.DocumentAccessBridge;\n import org.xwiki.component.annotation.Component;\n import org.xwiki.model.reference.AttachmentReference;\n import org.xwiki.model.reference.DocumentReference;\n import org.xwiki.officeimporter.OfficeImporterException;\n+import org.xwiki.officeimporter.document.OfficeDocumentArtifact;\n import org.xwiki.officeimporter.document.XDOMOfficeDocument;\n import org.xwiki.security.authorization.ContextualAuthorizationManager;\n import org.xwiki.security.authorization.Right;\n@@ -117,7 +117,7 @@ public void save(XDOMOfficeDocument doc, DocumentReference documentReference, St\n         }\n \n         // Finally attach all the artifacts into target document.\n-        attachArtifacts(doc.getArtifactsFiles(), documentReference);\n+        attachArtifacts(doc.getArtifactsMap(), documentReference);\n     }\n \n     /**\n@@ -126,17 +126,17 @@ public void save(XDOMOfficeDocument doc, DocumentReference documentReference, St\n      * @param artifactFiles set of artifact files.\n      * @param targetDocumentReference target wiki page into which artifacts are to be attached\n      */\n-    private void attachArtifacts(Set<File> artifactFiles, DocumentReference targetDocumentReference)\n+    private void attachArtifacts(Map<String, OfficeDocumentArtifact> artifactFiles,\n+        DocumentReference targetDocumentReference)\n     {\n-        for (File artifact : artifactFiles) {\n-            AttachmentReference attachmentReference =\n-                new AttachmentReference(artifact.getName(), targetDocumentReference);\n-            try (FileInputStream fis = new FileInputStream(artifact)) {\n-                this.docBridge.setAttachmentContent(attachmentReference, IOUtils.toByteArray(fis));\n+        artifactFiles.forEach((filename, artifact) -> {\n+            AttachmentReference attachmentReference = new AttachmentReference(filename, targetDocumentReference);\n+            try (InputStream is = artifact.getContentInputStream()) {\n+                this.docBridge.setAttachmentContent(attachmentReference, is);\n             } catch (Exception ex) {\n-                // Log the error and skip the artifact.\n-                this.logger.error(\"Error while attaching artifact.\", ex);\n+                // Log the error as warning and skip the artifact.\n+                this.logger.warn(\"Error while attaching artifact: [{}].\", ExceptionUtils.getRootCauseMessage(ex));\n             }\n-        }\n+        });\n     }\n }"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/internal/builder/DefaultPresentationBuilder.java",
          "status": "modified",
          "additions": 15,
          "deletions": 20,
          "patch": "@@ -25,10 +25,8 @@\n import java.io.StringReader;\n import java.io.UnsupportedEncodingException;\n import java.net.URLEncoder;\n-import java.nio.file.Files;\n import java.util.Collections;\n import java.util.HashMap;\n-import java.util.HashSet;\n import java.util.Map;\n import java.util.Set;\n import java.util.regex.Matcher;\n@@ -52,14 +50,18 @@\n import org.xwiki.officeimporter.builder.PresentationBuilder;\n import org.xwiki.officeimporter.converter.OfficeConverterException;\n import org.xwiki.officeimporter.converter.OfficeConverterResult;\n+import org.xwiki.officeimporter.document.OfficeDocumentArtifact;\n import org.xwiki.officeimporter.document.XDOMOfficeDocument;\n+import org.xwiki.officeimporter.internal.converter.OfficeConverterFileStorage;\n+import org.xwiki.officeimporter.internal.document.FileOfficeDocumentArtifact;\n import org.xwiki.officeimporter.server.OfficeServer;\n import org.xwiki.rendering.block.Block;\n import org.xwiki.rendering.block.ExpandedMacroBlock;\n import org.xwiki.rendering.block.XDOM;\n import org.xwiki.rendering.listener.MetaData;\n import org.xwiki.rendering.parser.Parser;\n import org.xwiki.rendering.renderer.BlockRenderer;\n+import org.xwiki.xml.XMLUtils;\n import org.xwiki.xml.html.HTMLCleaner;\n import org.xwiki.xml.html.HTMLCleanerConfiguration;\n import org.xwiki.xml.html.HTMLUtils;\n@@ -119,18 +121,14 @@ public class DefaultPresentationBuilder implements PresentationBuilder\n     public XDOMOfficeDocument build(InputStream officeFileStream, String officeFileName,\n         DocumentReference documentReference) throws OfficeImporterException\n     {\n-        // Accents seems to cause issues in some conditions\n-        // See https://jira.xwiki.org/browse/XWIKI-14692\n-        String cleanedOfficeFileName = StringUtils.stripAccents(officeFileName);\n-\n         // Invoke the office document converter.\n-        OfficeConverterResult officeConverterResult = importPresentation(officeFileStream, cleanedOfficeFileName);\n+        OfficeConverterResult officeConverterResult = importPresentation(officeFileStream, officeFileName);\n \n-        Pair<String, Set<File>> htmlPresentationResult = null;\n+        Pair<String, Map<String, OfficeDocumentArtifact>> htmlPresentationResult;\n         // Create presentation HTML.\n         try {\n             htmlPresentationResult = buildPresentationHTML(officeConverterResult,\n-                StringUtils.substringBeforeLast(cleanedOfficeFileName, \".\"));\n+                StringUtils.substringBeforeLast(officeFileName, \".\"));\n         } catch (IOException e) {\n             throw new OfficeImporterException(\"Error while preparing the presentation artifacts.\", e);\n         }\n@@ -157,15 +155,15 @@ public XDOMOfficeDocument build(InputStream officeFileStream, String officeFileN\n     protected OfficeConverterResult importPresentation(InputStream officeFileStream, String officeFileName)\n         throws OfficeImporterException\n     {\n-        Map<String, InputStream> inputStreams = new HashMap<String, InputStream>();\n-        inputStreams.put(officeFileName, officeFileStream);\n+        String inputFileName = OfficeConverterFileStorage.getSafeInputFilenameFromExtension(officeFileName);\n+        Map<String, InputStream> inputStreams = Map.of(inputFileName, officeFileStream);\n         try {\n             // The office converter uses the output file name extension to determine the output format/syntax.\n             // The returned artifacts are of three types: imgX.jpg (slide screen shot), imgX.html (HTML page that\n             // display the corresponding slide screen shot) and textX.html (HTML page that display the text extracted\n             // from the corresponding slide). We use \"img0.html\" as the output file name because the corresponding\n             // artifact displays a screen shot of the first presentation slide.\n-            return this.officeServer.getConverter().convertDocument(inputStreams, officeFileName, \"img0.html\");\n+            return this.officeServer.getConverter().convertDocument(inputStreams, inputFileName, \"img0.html\");\n         } catch (OfficeConverterException e) {\n             String message = \"Error while converting document [%s] into html.\";\n             throw new OfficeImporterException(String.format(message, officeFileName), e);\n@@ -183,22 +181,19 @@ protected OfficeConverterResult importPresentation(InputStream officeFileStream,\n      * @param nameSpace the prefix to add in front of all slide image names to prevent name conflicts\n      * @return the presentation HTML\n      */\n-    protected Pair<String, Set<File>> buildPresentationHTML(OfficeConverterResult officeConverterResult, String nameSpace)\n-        throws IOException\n+    protected Pair<String, Map<String, OfficeDocumentArtifact>> buildPresentationHTML(\n+        OfficeConverterResult officeConverterResult, String nameSpace) throws IOException\n     {\n-        Set<File> artifactFiles = new HashSet<>();\n+        Map<String, OfficeDocumentArtifact> artifactFiles = new HashMap<>();\n         // Iterate all the slides.\n         Set<File> conversionOutputFiles = officeConverterResult.getAllFiles();\n-        File outputDirectory = officeConverterResult.getOutputDirectory();\n         Map<Integer, String> filenames = new HashMap<>();\n         for (File conversionOutputFile : conversionOutputFiles) {\n             Matcher matcher = SLIDE_FORMAT.matcher(conversionOutputFile.getName());\n             if (matcher.matches()) {\n                 String number = matcher.group(\"number\");\n                 String slideImageName = String.format(\"%s-slide%s.jpg\", nameSpace, number);\n-                File artifact = new File(outputDirectory, slideImageName);\n-                artifactFiles.add(artifact);\n-                Files.copy(conversionOutputFile.toPath(), artifact.toPath());\n+                artifactFiles.put(slideImageName, new FileOfficeDocumentArtifact(slideImageName, conversionOutputFile));\n                 // Append slide image to the presentation HTML.\n                 String slideImageURL = null;\n                 try {\n@@ -219,7 +214,7 @@ protected Pair<String, Set<File>> buildPresentationHTML(OfficeConverterResult of\n         }\n         // We sort by number so that the filenames are ordered by slide number.\n         String presentationHTML = filenames.entrySet().stream().sorted(Map.Entry.comparingByKey())\n-            .map(entry -> String.format(\"<p><img src=\\\"%s\\\"/></p>\", entry.getValue()))\n+            .map(entry -> String.format(\"<p><img src=\\\"%s\\\"/></p>\", XMLUtils.escapeAttributeValue(entry.getValue())))\n             .collect(Collectors.joining());\n         return Pair.of(presentationHTML, artifactFiles);\n     }"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/internal/builder/DefaultXDOMOfficeDocumentBuilder.java",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -100,7 +100,7 @@ public XDOMOfficeDocument build(XHTMLOfficeDocument xhtmlOfficeDocument) throws\n         } catch (ParseException ex) {\n             throw new OfficeImporterException(\"Error: Could not parse xhtml office content.\", ex);\n         }\n-        return new XDOMOfficeDocument(xdom, xhtmlOfficeDocument.getArtifactsFiles(), this.componentManager,\n+        return new XDOMOfficeDocument(xdom, xhtmlOfficeDocument.getArtifactsMap(), this.componentManager,\n             xhtmlOfficeDocument.getConverterResult());\n     }\n }"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/internal/builder/DefaultXHTMLOfficeDocumentBuilder.java",
          "status": "modified",
          "additions": 39,
          "deletions": 34,
          "patch": "@@ -21,23 +21,17 @@\n \n import java.io.File;\n import java.io.FileNotFoundException;\n-import java.io.FileOutputStream;\n import java.io.FileReader;\n-import java.io.IOException;\n import java.io.InputStream;\n import java.io.Reader;\n import java.util.HashMap;\n-import java.util.HashSet;\n import java.util.Map;\n-import java.util.Set;\n \n import javax.inject.Inject;\n import javax.inject.Named;\n import javax.inject.Singleton;\n \n-import org.apache.commons.io.IOUtils;\n import org.apache.commons.lang3.StringUtils;\n-import org.apache.tika.parser.html.HtmlEncodingDetector;\n import org.w3c.dom.Document;\n import org.xwiki.component.annotation.Component;\n import org.xwiki.model.reference.DocumentReference;\n@@ -46,7 +40,11 @@\n import org.xwiki.officeimporter.builder.XHTMLOfficeDocumentBuilder;\n import org.xwiki.officeimporter.converter.OfficeConverterException;\n import org.xwiki.officeimporter.converter.OfficeConverterResult;\n+import org.xwiki.officeimporter.document.OfficeDocumentArtifact;\n import org.xwiki.officeimporter.document.XHTMLOfficeDocument;\n+import org.xwiki.officeimporter.internal.converter.OfficeConverterFileStorage;\n+import org.xwiki.officeimporter.internal.document.ByteArrayOfficeDocumentArtifact;\n+import org.xwiki.officeimporter.internal.document.FileOfficeDocumentArtifact;\n import org.xwiki.officeimporter.server.OfficeServer;\n import org.xwiki.xml.html.HTMLCleaner;\n import org.xwiki.xml.html.HTMLCleanerConfiguration;\n@@ -80,49 +78,54 @@ public class DefaultXHTMLOfficeDocumentBuilder implements XHTMLOfficeDocumentBui\n     @Named(\"openoffice\")\n     private HTMLCleaner officeHtmlCleaner;\n \n-    /**\n-     * Used to determine the encoding of the HTML byte array produced by the office server.\n-     */\n-    private HtmlEncodingDetector htmlEncodingDetector = new HtmlEncodingDetector();\n-\n     @Override\n     public XHTMLOfficeDocument build(InputStream officeFileStream, String officeFileName, DocumentReference reference,\n         boolean filterStyles) throws OfficeImporterException\n     {\n-        // Accents seems to cause issues in some conditions\n-        // See https://jira.xwiki.org/browse/XWIKI-14692\n-        String cleanedOfficeFileName = StringUtils.stripAccents(officeFileName);\n+        String inputFileName = OfficeConverterFileStorage.getSafeInputFilenameFromExtension(officeFileName);\n \n         // Invoke the office document converter.\n-        Map<String, InputStream> inputStreams = new HashMap<String, InputStream>();\n-        inputStreams.put(cleanedOfficeFileName, officeFileStream);\n+        Map<String, InputStream> inputStreams = new HashMap<>();\n+        inputStreams.put(inputFileName, officeFileStream);\n         // The office converter uses the output file name extension to determine the output format/syntax.\n-        String outputFileName = StringUtils.substringBeforeLast(cleanedOfficeFileName, \".\") + \".html\";\n+        String outputFileName = \"output.html\";\n         OfficeConverterResult officeConverterResult;\n         try {\n             officeConverterResult =\n-                this.officeServer.getConverter().convertDocument(inputStreams, cleanedOfficeFileName, outputFileName);\n+                this.officeServer.getConverter().convertDocument(inputStreams, inputFileName, outputFileName);\n         } catch (OfficeConverterException ex) {\n             String message = \"Error while converting document [%s] into html.\";\n             throw new OfficeImporterException(String.format(message, officeFileName), ex);\n         }\n \n-        Document xhtmlDoc = this.cleanAndCreateFile(reference, filterStyles, officeConverterResult);\n-        Set<File> artifacts = this.handleArtifacts(xhtmlDoc, officeConverterResult);\n+        // Replace the prefix \"output_html\" that JODConverter/LibreOffice prepend based on the output file name by\n+        // prefix based on the user-provided input name\n+        String replacePrefix = \"output_html_\";\n+        String replacementPrefix = StringUtils.substringBeforeLast(officeFileName, \".\") + \"_\";\n+\n+        Document xhtmlDoc = this.cleanAndCreateFile(reference, filterStyles, officeConverterResult,\n+            replacePrefix, replacementPrefix);\n+        Map<String, OfficeDocumentArtifact> artifacts = this.handleArtifacts(xhtmlDoc, officeConverterResult,\n+            replacePrefix, replacementPrefix);\n \n         // Return a new XHTMLOfficeDocument instance.\n         return new XHTMLOfficeDocument(xhtmlDoc, artifacts, officeConverterResult);\n     }\n \n     private Document cleanAndCreateFile(DocumentReference reference, boolean filterStyles,\n-        OfficeConverterResult officeConverterResult) throws OfficeImporterException\n+        OfficeConverterResult officeConverterResult, String replacePrefix, String replacementPrefix)\n+        throws OfficeImporterException\n     {\n         // Prepare the parameters for HTML cleaning.\n         Map<String, String> params = new HashMap<String, String>();\n         params.put(\"targetDocument\", this.entityReferenceSerializer.serialize(reference));\n         // Extract the images that are embedded through the Data URI scheme and add them to the other artifacts so that\n         // they end up as attachments.\n         params.put(\"attachEmbeddedImages\", \"true\");\n+        // Replace the prefix of the static output filename by the replacement based on the user-provided input\n+        // filename.\n+        params.put(\"replaceImagePrefix\", replacePrefix);\n+        params.put(\"replacementImagePrefix\", replacementPrefix);\n         if (filterStyles) {\n             params.put(\"filterStyles\", \"strict\");\n         }\n@@ -141,25 +144,27 @@ private Document cleanAndCreateFile(DocumentReference reference, boolean filterS\n         return this.officeHtmlCleaner.clean(html, configuration);\n     }\n \n-    private Set<File> handleArtifacts(Document xhtmlDoc, OfficeConverterResult officeConverterResult)\n-        throws OfficeImporterException\n+    private Map<String, OfficeDocumentArtifact> handleArtifacts(Document xhtmlDoc,\n+        OfficeConverterResult officeConverterResult, String replacePrefix, String replacementPrefix)\n     {\n-        Set<File> artifacts = new HashSet<>(officeConverterResult.getAllFiles());\n-        artifacts.remove(officeConverterResult.getOutputFile());\n+        Map<String, OfficeDocumentArtifact> artifacts = new HashMap<>();\n+        for (File file : officeConverterResult.getAllFiles()) {\n+            // Rename the file if it starts with the static prefix similar to the image filter.\n+            String filename = file.getName();\n+            if (StringUtils.startsWith(filename, replacePrefix)) {\n+                filename = replacementPrefix + StringUtils.removeStart(filename, replacePrefix);\n+            }\n+            artifacts.put(filename, new FileOfficeDocumentArtifact(file.getName(), file));\n+        }\n+        // Remove the output file from the artifacts\n+        artifacts.remove(officeConverterResult.getOutputFile().getName());\n \n         @SuppressWarnings(\"unchecked\")\n         Map<String, byte[]> embeddedImages = (Map<String, byte[]>) xhtmlDoc.getUserData(\"embeddedImages\");\n         if (embeddedImages != null) {\n-            File outputDirectory = officeConverterResult.getOutputDirectory();\n             for (Map.Entry<String, byte[]> embeddedImage : embeddedImages.entrySet()) {\n-                File outputFile = new File(outputDirectory, embeddedImage.getKey());\n-                try (FileOutputStream fos = new FileOutputStream(outputFile)) {\n-                    IOUtils.write(embeddedImage.getValue(), fos);\n-                } catch (IOException e) {\n-                    throw new OfficeImporterException(\n-                        String.format(\"Error when writing embedded image file [%s]\", outputFile.getAbsolutePath()), e);\n-                }\n-                artifacts.add(outputFile);\n+                String fileName = embeddedImage.getKey();\n+                artifacts.put(fileName, new ByteArrayOfficeDocumentArtifact(fileName, embeddedImage.getValue()));\n             }\n         }\n         return artifacts;"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/internal/converter/DefaultOfficeConverter.java",
          "status": "modified",
          "additions": 3,
          "deletions": 0,
          "patch": "@@ -92,6 +92,9 @@ public DefaultOfficeConverterResult convertDocument(Map<String, InputStream> inp\n             OfficeConverterFileStorage storage = new OfficeConverterFileStorage(this.workDir, inputFileName,\n                 outputFileName);\n \n+            // Check that the potentially cleaned filename is actually in the input streams.\n+            this.checkInputStream(inputStreams, storage.getInputFile().getName());\n+\n             // Write out all the input streams.\n             for (Map.Entry<String, InputStream> entry : inputStreams.entrySet()) {\n                 File temp = new File(storage.getInputDir(), entry.getKey());"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/internal/converter/OfficeConverterFileStorage.java",
          "status": "modified",
          "additions": 60,
          "deletions": 3,
          "patch": "@@ -22,7 +22,9 @@\n import java.io.File;\n import java.io.IOException;\n import java.util.UUID;\n+import java.util.regex.Pattern;\n \n+import org.apache.commons.compress.utils.FileNameUtils;\n import org.apache.commons.lang3.StringUtils;\n \n /**\n@@ -34,6 +36,20 @@\n  */\n public class OfficeConverterFileStorage\n {\n+    /**\n+     * Pattern for matching a file extension that is safe, i.e., contains between 1 and 20 alphanumeric\n+     * characters. The upper limit is arbitrary but should fit all extensions and is there to ensure that the\n+     * filename won't be too long.\n+     */\n+    private static final Pattern SAFE_EXTENSION = Pattern.compile(\"^[a-zA-Z0-9]{1,20}$\");\n+\n+    /**\n+     * Pattern for matching characters not allowed in filenames. Currently just matches directory separators.\n+     */\n+    private static final Pattern DISALLOWED_CHARACTERS = Pattern.compile(\"[/\\\\\\\\]\");\n+\n+    private static final String INPUT = \"input\";\n+\n     /**\n      * Top-level temporary working directory.\n      */\n@@ -75,11 +91,11 @@ public OfficeConverterFileStorage(File parentDir, String inputFileName, String o\n         // Realize the temporary directory hierarchy.\n         this.rootDir = new File(parentDir, UUID.randomUUID().toString());\n         if (this.rootDir.mkdir()) {\n-            this.inputDir = new File(this.rootDir, \"input\");\n+            this.inputDir = new File(this.rootDir, INPUT);\n             this.outputDir = new File(this.rootDir, \"output\");\n             if (this.inputDir.mkdir() && this.outputDir.mkdir()) {\n-                this.inputFile = new File(this.inputDir, StringUtils.stripAccents(inputFileName));\n-                this.outputFile = new File(this.outputDir, StringUtils.stripAccents(outputFileName));\n+                this.inputFile = new File(this.inputDir, cleanFilename(inputFileName));\n+                this.outputFile = new File(this.outputDir, cleanFilename(outputFileName));\n                 success = true;\n             }\n         }\n@@ -91,6 +107,47 @@ public OfficeConverterFileStorage(File parentDir, String inputFileName, String o\n         }\n     }\n \n+    /**\n+     * Gets a filename that is safe to use as input filename for a conversion operation.\n+     * <p>\n+     * The extension is kept from the input filename if it is alphanumeric and contains between 1 and 20 characters.\n+     *\n+     * @param filename the filename for getting the extension\n+     * @return the input filename\n+     */\n+    public static String getSafeInputFilenameFromExtension(String filename)\n+    {\n+        String extension = FileNameUtils.getExtension(filename);\n+        if (!SAFE_EXTENSION.matcher(extension).matches()) {\n+            extension = \"\";\n+        }\n+\n+        return StringUtils.isBlank(extension) ? INPUT : INPUT + \".\" + extension;\n+    }\n+\n+    /**\n+     * Clean a file name for use as input or output name.\n+     *\n+     * @param name the filename to clean\n+     * @return the cleaned name, shortened to 255 characters if needed\n+     */\n+    public static String cleanFilename(String name)\n+    {\n+        String result = DISALLOWED_CHARACTERS.matcher(StringUtils.stripAccents(name)).replaceAll(\"_\");\n+\n+        // Make sure that the filename is not blank. Don't use an extension so maybe content guessing works.\n+        if (StringUtils.isBlank(result)) {\n+            result = \"fallback\";\n+        }\n+\n+        // If the filename is too long, keep the part at the end as it contains the extension.\n+        if (result.length() > 255) {\n+            result = result.substring(result.length() - 255);\n+        }\n+\n+        return result;\n+    }\n+\n     /**\n      * @return {@link File} representing the input directory where the main input document as well as any other\n      *         dependent artifacts should be located."
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/internal/document/ByteArrayOfficeDocumentArtifact.java",
          "status": "added",
          "additions": 88,
          "deletions": 0,
          "patch": "@@ -0,0 +1,88 @@\n+/*\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+package org.xwiki.officeimporter.internal.document;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+\n+import org.apache.commons.lang3.builder.EqualsBuilder;\n+import org.apache.commons.lang3.builder.HashCodeBuilder;\n+import org.xwiki.officeimporter.document.OfficeDocumentArtifact;\n+\n+/**\n+ * A {@link OfficeDocumentArtifact} backed by a byte array.\n+ *\n+ * @version $Id$\n+ * @since 14.10.8\n+ * @since 15.3RC1\n+ */\n+public class ByteArrayOfficeDocumentArtifact implements OfficeDocumentArtifact\n+{\n+    private final String name;\n+\n+    private final byte[] content;\n+\n+    /**\n+     * Construct a new {@link OfficeDocumentArtifact} backed by a byte array.\n+     *\n+     * @param name the name of the artifact\n+     * @param content the content as byte array\n+     */\n+    public ByteArrayOfficeDocumentArtifact(String name, byte[] content)\n+    {\n+        this.name = name;\n+        this.content = content;\n+    }\n+\n+    @Override\n+    public String getName()\n+    {\n+        return this.name;\n+    }\n+\n+    @Override\n+    public InputStream getContentInputStream()\n+    {\n+        return new ByteArrayInputStream(this.content);\n+    }\n+\n+    @Override\n+    public boolean equals(Object o)\n+    {\n+        if (this == o) {\n+            return true;\n+        }\n+\n+        if (o == null || getClass() != o.getClass()) {\n+            return false;\n+        }\n+\n+        ByteArrayOfficeDocumentArtifact that = (ByteArrayOfficeDocumentArtifact) o;\n+\n+        return new EqualsBuilder().append(getName(), that.getName())\n+            .append(this.content, that.content).isEquals();\n+    }\n+\n+    @Override\n+    public int hashCode()\n+    {\n+        return new HashCodeBuilder(17, 37).append(getName()).toHashCode();\n+    }\n+}"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/internal/document/FileOfficeDocumentArtifact.java",
          "status": "added",
          "additions": 95,
          "deletions": 0,
          "patch": "@@ -0,0 +1,95 @@\n+/*\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+package org.xwiki.officeimporter.internal.document;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileNotFoundException;\n+import java.io.InputStream;\n+\n+import org.apache.commons.lang3.builder.EqualsBuilder;\n+import org.apache.commons.lang3.builder.HashCodeBuilder;\n+import org.xwiki.officeimporter.OfficeImporterException;\n+import org.xwiki.officeimporter.document.OfficeDocumentArtifact;\n+\n+/**\n+ * A {@link OfficeDocumentArtifact} backed by a file.\n+ *\n+ * @version $Id$\n+ * @since 14.10.8\n+ * @since 15.3RC1\n+ */\n+public class FileOfficeDocumentArtifact implements OfficeDocumentArtifact\n+{\n+    private final String name;\n+\n+    private final File content;\n+\n+    /**\n+     * Construct a new {@link OfficeDocumentArtifact} backed by a file.\n+     *\n+     * @param name the name of the artifact\n+     * @param content the content of the artifact\n+     */\n+    public FileOfficeDocumentArtifact(String name, File content)\n+    {\n+        this.name = name;\n+        this.content = content;\n+    }\n+\n+    @Override\n+    public String getName()\n+    {\n+        return this.name;\n+    }\n+\n+    @Override\n+    public InputStream getContentInputStream() throws OfficeImporterException\n+    {\n+        try {\n+            return new FileInputStream(this.content);\n+        } catch (FileNotFoundException e) {\n+            throw new OfficeImporterException(\"Artifact file not found\", e);\n+        }\n+    }\n+\n+    @Override\n+    public boolean equals(Object o)\n+    {\n+        if (this == o) {\n+            return true;\n+        }\n+\n+        if (o == null || getClass() != o.getClass()) {\n+            return false;\n+        }\n+\n+        FileOfficeDocumentArtifact that = (FileOfficeDocumentArtifact) o;\n+\n+        return new EqualsBuilder().append(getName(), that.getName())\n+            .append(this.content, that.content).isEquals();\n+    }\n+\n+    @Override\n+    public int hashCode()\n+    {\n+        return new HashCodeBuilder(17, 37).append(getName()).append(this.content).toHashCode();\n+    }\n+}"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/internal/filter/ImageFilter.java",
          "status": "modified",
          "additions": 24,
          "deletions": 7,
          "patch": "@@ -112,11 +112,15 @@ public void filter(Document htmlDocument, Map<String, String> cleaningParams)\n             htmlDocument.setUserData(EMBEDDED_IMAGES, new HashMap<String, byte[]>(), null);\n         }\n \n+        String replaceAttachmentPrefix = cleaningParams.get(\"replaceImagePrefix\");\n+        String replacementAttachmentPrefix = cleaningParams.get(\"replacementImagePrefix\");\n+\n         List<Element> images = filterDescendants(htmlDocument.getDocumentElement(), new String[] {TAG_IMG});\n         for (Element image : images) {\n             Attr source = image.getAttributeNode(ATTRIBUTE_SRC);\n             if (source != null && targetDocumentReference != null) {\n-                filterImageSource(source, targetDocumentReference);\n+                filterImageSource(source, targetDocumentReference, replaceAttachmentPrefix,\n+                    replacementAttachmentPrefix);\n             }\n \n             // The 'align' attribute of images creates a lot of problems. First,the office server has a problem with\n@@ -127,11 +131,12 @@ public void filter(Document htmlDocument, Map<String, String> cleaningParams)\n         }\n     }\n \n-    private void filterImageSource(Attr source, DocumentReference targetDocumentReference)\n+    private void filterImageSource(Attr source, DocumentReference targetDocumentReference, String replacePrefix,\n+        String replacementPrefix)\n     {\n         String fileName = null;\n         try {\n-            fileName = getFileName(source);\n+            fileName = getFileName(source, replacePrefix, replacementPrefix);\n         } catch (Exception e) {\n             this.logger.warn(\"Failed to extract the image file name. Root cause is [{}]\",\n                 ExceptionUtils.getRootCauseMessage(e));\n@@ -155,7 +160,7 @@ private void filterImageSource(Attr source, DocumentReference targetDocumentRefe\n         image.getParentNode().insertBefore(afterComment, image.getNextSibling());\n     }\n \n-    private String getFileName(Attr source) throws MimeTypeException\n+    private String getFileName(Attr source, String replacePrefix, String replacementPrefix) throws MimeTypeException\n     {\n         String value = source.getValue();\n         String fileName = null;\n@@ -194,13 +199,25 @@ private String getFileName(Attr source) throws MimeTypeException\n                 fileName = fileName.replaceAll(\"\\\\+\", \"%2B\");\n                 // We have to decode the image file name in case it contains URL special characters.\n                 fileName = URLDecoder.decode(fileName, UTF_8);\n-\n-                // '@' must also be escaped in order to resolve properly the path in XWiki\n-                fileName = fileName.replaceAll(\"@\", \"\\\\\\\\@\");\n             } catch (Exception e) {\n                 // This shouldn't happen. Use the encoded image file name.\n             }\n+\n+            fileName = replacePrefix(replacePrefix, replacementPrefix, fileName);\n+            // '@' must also be escaped in order to resolve properly the path in XWiki\n+            fileName = fileName.replace(\"@\", \"\\\\@\");\n         }\n         return fileName;\n     }\n+\n+    private static String replacePrefix(String replacePrefix, String replacementPrefix, String fileName)\n+    {\n+        String result = fileName;\n+\n+        if (StringUtils.startsWith(fileName, replacePrefix) && replacementPrefix != null) {\n+            result = replacementPrefix + StringUtils.removeStart(fileName, replacePrefix);\n+        }\n+\n+        return result;\n+    }\n }"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/main/java/org/xwiki/officeimporter/internal/splitter/DefaultXDOMOfficeDocumentSplitter.java",
          "status": "modified",
          "additions": 14,
          "deletions": 18,
          "patch": "@@ -19,12 +19,9 @@\n  */\n package org.xwiki.officeimporter.internal.splitter;\n \n-import java.io.File;\n import java.util.HashMap;\n-import java.util.HashSet;\n import java.util.List;\n import java.util.Map;\n-import java.util.Set;\n \n import javax.inject.Inject;\n import javax.inject.Named;\n@@ -35,6 +32,7 @@\n import org.xwiki.component.manager.ComponentLookupException;\n import org.xwiki.component.manager.ComponentManager;\n import org.xwiki.officeimporter.OfficeImporterException;\n+import org.xwiki.officeimporter.document.OfficeDocumentArtifact;\n import org.xwiki.officeimporter.document.XDOMOfficeDocument;\n import org.xwiki.officeimporter.splitter.OfficeDocumentSplitterParameters;\n import org.xwiki.officeimporter.splitter.TargetDocumentDescriptor;\n@@ -105,10 +103,10 @@ public Map<TargetDocumentDescriptor, XDOMOfficeDocument> split(XDOMOfficeDocumen\n             }\n \n             // Rewire artifacts.\n-            Set<File> artifactsFiles = relocateArtifacts(doc, officeDocument);\n+            Map<String, OfficeDocumentArtifact> artifactsMap = relocateArtifacts(doc, officeDocument);\n \n             // Create the resulting XDOMOfficeDocument.\n-            XDOMOfficeDocument splitDocument = new XDOMOfficeDocument(doc.getXdom(), artifactsFiles, componentManager,\n+            XDOMOfficeDocument splitDocument = new XDOMOfficeDocument(doc.getXdom(), artifactsMap, componentManager,\n                 officeDocument.getConverterResult());\n             result.put(targetDocumentDescriptor, splitDocument);\n         }\n@@ -117,27 +115,25 @@ public Map<TargetDocumentDescriptor, XDOMOfficeDocument> split(XDOMOfficeDocumen\n     }\n \n     /**\n-     * Move artifacts (i.e. embedded images) from the original office document to a specific wiki document corresponding\n-     * to a section. Only the artifacts from that section are moved.\n+     * Copy artifacts (i.e. embedded images) from the original office document to a specific wiki document corresponding\n+     * to a section. Only the artifacts from that section are copied.\n      * \n      * @param sectionDoc the newly created wiki document corresponding to a section of the original office document\n      * @param officeDocument the office document being splitted into wiki documents\n      * @return the relocated artifacts\n      */\n-    private Set<File> relocateArtifacts(WikiDocument sectionDoc, XDOMOfficeDocument officeDocument)\n+    private Map<String, OfficeDocumentArtifact> relocateArtifacts(WikiDocument sectionDoc,\n+        XDOMOfficeDocument officeDocument)\n     {\n-        Set<File> artifacts = officeDocument.getArtifactsFiles();\n-        Set<File> result = new HashSet<>();\n+        Map<String, OfficeDocumentArtifact> artifacts = officeDocument.getArtifactsMap();\n+        Map<String, OfficeDocumentArtifact> result = new HashMap<>();\n         List<ImageBlock> imageBlocks =\n             sectionDoc.getXdom().getBlocks(new ClassBlockMatcher(ImageBlock.class), Axes.DESCENDANT);\n-        if (!imageBlocks.isEmpty()) {\n-            Map<String, File> fileMap = new HashMap<>();\n-            artifacts.forEach(item -> fileMap.put(item.getName(), item));\n-            for (ImageBlock imageBlock : imageBlocks) {\n-                String imageReference = imageBlock.getReference().getReference();\n-                File file = fileMap.get(imageReference);\n-                result.add(file);\n-                artifacts.remove(file);\n+        for (ImageBlock imageBlock : imageBlocks) {\n+            String imageReference = imageBlock.getReference().getReference();\n+            OfficeDocumentArtifact artifact = artifacts.get(imageReference);\n+            if (artifact != null) {\n+                result.put(imageReference, artifact);\n             }\n         }\n         return result;"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/test/java/org/xwiki/officeimporter/document/XDOMOfficeDocumentTest.java",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -79,6 +79,6 @@ private XDOMOfficeDocument createOfficeDocument(String content, String syntax) t\n     {\n         Parser parser = this.componentManager.getInstance(Parser.class, syntax);\n         XDOM xdom = parser.parse(new StringReader(content));\n-        return new XDOMOfficeDocument(xdom, Collections.emptySet(), this.componentManager, null);\n+        return new XDOMOfficeDocument(xdom, Collections.emptyMap(), this.componentManager, null);\n     }\n }"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/test/java/org/xwiki/officeimporter/internal/ModelBridgeTest.java",
          "status": "modified",
          "additions": 21,
          "deletions": 3,
          "patch": "@@ -21,7 +21,10 @@\n \n import java.io.File;\n import java.io.FileOutputStream;\n+import java.io.InputStream;\n import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n \n import org.apache.commons.io.IOUtils;\n import org.junit.jupiter.api.Test;\n@@ -30,6 +33,7 @@\n import org.xwiki.model.reference.AttachmentReference;\n import org.xwiki.model.reference.DocumentReference;\n import org.xwiki.officeimporter.document.XDOMOfficeDocument;\n+import org.xwiki.officeimporter.internal.document.FileOfficeDocumentArtifact;\n import org.xwiki.rendering.syntax.Syntax;\n import org.xwiki.rendering.syntax.SyntaxType;\n import org.xwiki.security.authorization.ContextualAuthorizationManager;\n@@ -39,6 +43,10 @@\n import org.xwiki.test.junit5.mockito.InjectMockComponents;\n import org.xwiki.test.junit5.mockito.MockComponent;\n \n+import static org.junit.jupiter.api.Assertions.assertArrayEquals;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.doAnswer;\n import static org.mockito.Mockito.mock;\n import static org.mockito.Mockito.verify;\n import static org.mockito.Mockito.when;\n@@ -81,7 +89,15 @@ void saveWithOverwrite() throws Exception\n \n         when(this.contextualAuthorizationManager.hasAccess(Right.EDIT, documentReference)).thenReturn(true);\n         when(doc.getContentAsString(syntaxId)).thenReturn(content);\n-        when(doc.getArtifactsFiles()).thenReturn(Collections.singleton(artifact));\n+        when(doc.getArtifactsMap())\n+            .thenReturn(Collections.singletonMap(fileName, new FileOfficeDocumentArtifact(fileName, artifact)));\n+        // Store all attachment contents that are set on the mock.\n+        Map<AttachmentReference, byte[]> attachmentContents = new HashMap<>();\n+        doAnswer((invocation) -> attachmentContents.put(\n+            invocation.getArgument(0, AttachmentReference.class),\n+            IOUtils.toByteArray(invocation.getArgument(1, InputStream.class))\n+        )).when(this.documentAccessBridge)\n+            .setAttachmentContent(any(AttachmentReference.class), any(InputStream.class));\n \n         this.modelBridge.save(doc, documentReference, syntaxId, parentReference, title, false);\n \n@@ -90,8 +106,10 @@ void saveWithOverwrite() throws Exception\n             false);\n         verify(documentAccessBridge).setDocumentParentReference(documentReference, parentReference);\n         verify(documentAccessBridge).setDocumentTitle(documentReference, title);\n-        verify(documentAccessBridge).setAttachmentContent(new AttachmentReference(fileName, documentReference),\n-            fileContent);\n+        assertEquals(1, attachmentContents.size());\n+        AttachmentReference expectedAttachmentReference = new AttachmentReference(fileName, documentReference);\n+        assertEquals(expectedAttachmentReference, attachmentContents.keySet().iterator().next());\n+        assertArrayEquals(fileContent, attachmentContents.get(expectedAttachmentReference));\n     }\n \n     @Test"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/test/java/org/xwiki/officeimporter/internal/builder/DefaultPresentationBuilderTest.java",
          "status": "modified",
          "additions": 10,
          "deletions": 4,
          "patch": "@@ -28,7 +28,9 @@\n import java.util.Collections;\n import java.util.HashSet;\n import java.util.List;\n+import java.util.Map;\n import java.util.Set;\n+import java.util.function.Function;\n import java.util.stream.Collectors;\n \n import javax.inject.Named;\n@@ -46,7 +48,9 @@\n import org.xwiki.model.reference.EntityReferenceSerializer;\n import org.xwiki.officeimporter.converter.OfficeConverter;\n import org.xwiki.officeimporter.converter.OfficeConverterResult;\n+import org.xwiki.officeimporter.document.OfficeDocumentArtifact;\n import org.xwiki.officeimporter.document.XDOMOfficeDocument;\n+import org.xwiki.officeimporter.internal.document.FileOfficeDocumentArtifact;\n import org.xwiki.officeimporter.server.OfficeServer;\n import org.xwiki.rendering.block.Block;\n import org.xwiki.rendering.block.ExpandedMacroBlock;\n@@ -151,7 +155,7 @@ void build() throws Exception\n \n         when(officeConverterResult.getAllFiles()).thenReturn(allFiles);\n \n-        when(this.officeConverter.convertDocument(Collections.singletonMap(\"file.odp\", officeFileStream), \"file.odp\",\n+        when(this.officeConverter.convertDocument(Collections.singletonMap(\"input.odp\", officeFileStream), \"input.odp\",\n             \"img0.html\")).thenReturn(officeConverterResult);\n \n         HTMLCleanerConfiguration config = mock(HTMLCleanerConfiguration.class);\n@@ -170,9 +174,11 @@ void build() throws Exception\n         XDOMOfficeDocument result = this.presentationBuilder.build(officeFileStream, \"file.odp\", documentReference);\n \n         verify(config).setParameters(Collections.singletonMap(\"targetDocument\", \"wiki:Path.To.Page\"));\n-        Set<File> expectedArtifacts = slideNumbers.stream().map(slideNumber ->\n-            new File(this.outputDirectory, String.format(\"file-slide%d.jpg\", slideNumber))).collect(Collectors.toSet());\n-        assertEquals(expectedArtifacts, result.getArtifactsFiles());\n+        Map<String, OfficeDocumentArtifact> expectedArtifacts = slideNumbers.stream()\n+            .map(slideNumber -> new FileOfficeDocumentArtifact(String.format(\"file-slide%d.jpg\", slideNumber),\n+                new File(this.outputDirectory, String.format(\"img%d.jpg\", slideNumber))))\n+            .collect(Collectors.toMap(OfficeDocumentArtifact::getName, Function.identity()));\n+        assertEquals(expectedArtifacts, result.getArtifactsMap());\n \n         assertEquals(\"wiki:Path.To.Page\", result.getContentDocument().getMetaData().getMetaData(MetaData.BASE));\n "
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/test/java/org/xwiki/officeimporter/internal/builder/DefaultXDOMOfficeDocumentBuilderTest.java",
          "status": "modified",
          "additions": 7,
          "deletions": 6,
          "patch": "@@ -57,7 +57,7 @@\n  * @since 2.1M1\n  */\n @ComponentTest\n-public class DefaultXDOMOfficeDocumentBuilderTest extends AbstractOfficeImporterTest\n+class DefaultXDOMOfficeDocumentBuilderTest extends AbstractOfficeImporterTest\n {\n     /**\n      * The name of an input file to be used in tests.\n@@ -91,12 +91,13 @@ public void setUp() throws Exception\n      * Test {@link OfficeDocument} building.\n      */\n     @Test\n-    public void xdomOfficeDocumentBuilding() throws Exception\n+    void xdomOfficeDocumentBuilding() throws Exception\n     {\n         // Create & register a mock document converter to by-pass the office server.\n         final InputStream mockOfficeFileStream = new ByteArrayInputStream(new byte[1024]);\n-        final Map<String, InputStream> mockInput = new HashMap<String, InputStream>();\n-        mockInput.put(INPUT_FILE_NAME, mockOfficeFileStream);\n+        final Map<String, InputStream> mockInput = new HashMap<>();\n+        String internalInputFilename = \"input.doc\";\n+        mockInput.put(internalInputFilename, mockOfficeFileStream);\n         OfficeConverterResult converterResult = mock(OfficeConverterResult.class);\n         when(converterResult.getOutputDirectory()).thenReturn(this.outputDirectory);\n         File outputFile = new File(this.outputDirectory, OUTPUT_FILE_NAME);\n@@ -112,7 +113,7 @@ public void xdomOfficeDocumentBuilding() throws Exception\n         final DocumentReference documentReference = new DocumentReference(\"xwiki\", \"Main\", \"Test\");\n \n         when(mockOfficeServer.getConverter()).thenReturn(mockDocumentConverter);\n-        when(mockDocumentConverter.convertDocument(mockInput, INPUT_FILE_NAME, OUTPUT_FILE_NAME))\n+        when(mockDocumentConverter.convertDocument(mockInput, internalInputFilename, \"output.html\"))\n             .thenReturn(converterResult);\n         when(mockDocumentReferenceResolver.resolve(\"xwiki:Main.Test\")).thenReturn(documentReference);\n         when(mockDefaultStringEntityReferenceSerializer.serialize(documentReference)).thenReturn(\"xwiki:Main.Test\");\n@@ -121,7 +122,7 @@ public void xdomOfficeDocumentBuilding() throws Exception\n             xdomOfficeDocumentBuilder.build(mockOfficeFileStream, INPUT_FILE_NAME, documentReference, true);\n         assertEquals(\"xwiki:Main.Test\", document.getContentDocument().getMetaData().getMetaData(MetaData.BASE));\n         assertEquals(\"**Hello There**\", document.getContentAsString());\n-        assertEquals(0, document.getArtifactsFiles().size());\n+        assertEquals(0, document.getArtifactsMap().size());\n \n         verify(mockOfficeServer).getConverter();\n     }"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/test/java/org/xwiki/officeimporter/internal/builder/DefaultXHTMLOfficeDocumentBuilderTest.java",
          "status": "modified",
          "additions": 29,
          "deletions": 11,
          "patch": "@@ -24,6 +24,7 @@\n import java.io.FileOutputStream;\n import java.io.InputStream;\n import java.io.Reader;\n+import java.nio.charset.StandardCharsets;\n import java.nio.file.Files;\n import java.util.Arrays;\n import java.util.Collections;\n@@ -42,6 +43,7 @@\n import org.xwiki.model.reference.EntityReferenceSerializer;\n import org.xwiki.officeimporter.converter.OfficeConverter;\n import org.xwiki.officeimporter.converter.OfficeConverterResult;\n+import org.xwiki.officeimporter.document.OfficeDocumentArtifact;\n import org.xwiki.officeimporter.document.XHTMLOfficeDocument;\n import org.xwiki.officeimporter.server.OfficeServer;\n import org.xwiki.test.junit5.XWikiTempDir;\n@@ -51,9 +53,14 @@\n import org.xwiki.xml.html.HTMLCleaner;\n import org.xwiki.xml.html.HTMLCleanerConfiguration;\n \n+import static org.junit.jupiter.api.Assertions.assertArrayEquals;\n import static org.junit.jupiter.api.Assertions.assertEquals;\n-import static org.mockito.ArgumentMatchers.*;\n-import static org.mockito.Mockito.*;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n \n /**\n  * Test case for {@link DefaultXHTMLOfficeDocumentBuilder}.\n@@ -62,7 +69,7 @@\n  * @since 2.1M1\n  */\n @ComponentTest\n-public class DefaultXHTMLOfficeDocumentBuilderTest\n+class DefaultXHTMLOfficeDocumentBuilderTest\n {\n     @InjectMockComponents\n     private DefaultXHTMLOfficeDocumentBuilder officeDocumentBuilder;\n@@ -90,7 +97,7 @@ public void configure() throws Exception\n     }\n \n     @Test\n-    public void xhtmlOfficeDocumentBuilding() throws Exception\n+    void xhtmlOfficeDocumentBuilding() throws Exception\n     {\n         DocumentReference documentReference = new DocumentReference(\"wiki\", Arrays.asList(\"Path\", \"To\"), \"Page\");\n         when(this.entityReferenceSerializer.serialize(documentReference)).thenReturn(\"wiki:Path.To.Page\");\n@@ -112,12 +119,18 @@ public void xhtmlOfficeDocumentBuilding() throws Exception\n         try (FileOutputStream fos = new FileOutputStream(outputFile)) {\n             IOUtils.write(\"HTML content\".getBytes(), fos);\n         }\n+        String otherArtifactContent = \"Other content\";\n+        try (FileOutputStream fos = new FileOutputStream(otherArtifact)) {\n+            IOUtils.write(otherArtifactContent.getBytes(), fos);\n+        }\n+\n         when(converterResult.getAllFiles()).thenReturn(allFiles);\n \n-        when(this.officeConverter.convertDocument(Collections.singletonMap(\"file.odt\", officeFileStream), \"file.odt\",\n-            \"file.html\")).thenReturn(converterResult);\n+        when(this.officeConverter.convertDocument(Collections.singletonMap(\"input.odt\", officeFileStream), \"input.odt\",\n+            \"output.html\")).thenReturn(converterResult);\n \n-        Map<String, byte[]> embeddedImages = Collections.singletonMap(\"image.png\", \"Image content\".getBytes());\n+        byte[] imageContent = \"Image content\".getBytes();\n+        Map<String, byte[]> embeddedImages = Collections.singletonMap(\"image.png\", imageContent);\n         Document xhtmlDoc = mock(Document.class);\n         when(xhtmlDoc.getUserData(\"embeddedImages\")).thenReturn(embeddedImages);\n \n@@ -132,13 +145,18 @@ public void xhtmlOfficeDocumentBuilding() throws Exception\n         params.put(\"targetDocument\", \"wiki:Path.To.Page\");\n         params.put(\"attachEmbeddedImages\", \"true\");\n         params.put(\"filterStyles\", \"strict\");\n+        params.put(\"replaceImagePrefix\", \"output_html_\");\n+        params.put(\"replacementImagePrefix\", \"file_\");\n         verify(config).setParameters(params);\n \n         assertEquals(xhtmlDoc, result.getContentDocument());\n \n-        Set<File> expectedFileArtifacts = new HashSet<>();\n-        expectedFileArtifacts.add(otherArtifact);\n-        expectedFileArtifacts.add(new File(this.outputDirectory, \"image.png\"));\n-        assertEquals(expectedFileArtifacts, result.getArtifactsFiles());\n+        Map<String, OfficeDocumentArtifact> actualArtifacts = result.getArtifactsMap();\n+        OfficeDocumentArtifact actualOtherArtifact = actualArtifacts.get(\"file.txt\");\n+        assertEquals(otherArtifactContent,\n+            IOUtils.toString(actualOtherArtifact.getContentInputStream(), StandardCharsets.UTF_8));\n+        assertTrue(actualArtifacts.containsKey(\"image.png\"));\n+        OfficeDocumentArtifact imageArtifact = actualArtifacts.get(\"image.png\");\n+        assertArrayEquals(imageContent, IOUtils.toByteArray(imageArtifact.getContentInputStream()));\n     }\n }"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/test/java/org/xwiki/officeimporter/internal/converter/OfficeConverterFileStorageStorageTest.java",
          "status": "added",
          "additions": 79,
          "deletions": 0,
          "patch": "@@ -0,0 +1,79 @@\n+/*\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+package org.xwiki.officeimporter.internal.converter;\n+\n+import java.io.File;\n+import java.io.IOException;\n+\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.xwiki.test.junit5.XWikiTempDir;\n+import org.xwiki.test.junit5.XWikiTempDirExtension;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+/**\n+ * Unit test for {@link OfficeConverterFileStorage}.\n+ *\n+ * @version $Id$\n+ */\n+@ExtendWith(XWikiTempDirExtension.class)\n+class OfficeConverterFileStorageStorageTest\n+{\n+    @XWikiTempDir\n+    private File tmpDir;\n+\n+    @Test\n+    void invalidCharacters() throws IOException\n+    {\n+        OfficeConverterFileStorage storage =\n+            new OfficeConverterFileStorage(this.tmpDir, \"{/in\\\\\u00a7\u00e4.ext\", \"{/out\\\\$\u00e4.out\");\n+\n+        assertEquals(\"{_in_\u00a7a.ext\", storage.getInputFile().getName());\n+        assertEquals(\"{_out_$a.out\", storage.getOutputFile().getName());\n+        assertEquals(storage.getInputDir(), storage.getInputFile().getParentFile());\n+        assertEquals(storage.getOutputDir(), storage.getOutputFile().getParentFile());\n+\n+        assertTrue(storage.getInputDir().isDirectory());\n+        assertTrue(storage.getOutputDir().isDirectory());\n+    }\n+\n+    @Test\n+    void longFilename() throws IOException\n+    {\n+        String longName = \" \".repeat(300) + \".ext\";\n+        OfficeConverterFileStorage storage = new OfficeConverterFileStorage(this.tmpDir, longName, longName);\n+\n+        String expectedName = \" \".repeat(251) + \".ext\";\n+        assertEquals(expectedName, storage.getInputFile().getName());\n+        assertEquals(expectedName, storage.getOutputFile().getName());\n+    }\n+\n+    @Test\n+    void fallback() throws IOException\n+    {\n+        OfficeConverterFileStorage storage = new OfficeConverterFileStorage(this.tmpDir, \"\", \"\");\n+\n+        String fallback = \"fallback\";\n+        assertEquals(fallback, storage.getInputFile().getName());\n+        assertEquals(fallback, storage.getOutputFile().getName());\n+    }\n+}"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/test/java/org/xwiki/officeimporter/internal/filter/ImageFilterTest.java",
          "status": "modified",
          "additions": 27,
          "deletions": 10,
          "patch": "@@ -22,6 +22,7 @@\n import java.io.UnsupportedEncodingException;\n import java.net.URLEncoder;\n import java.nio.charset.Charset;\n+import java.nio.charset.StandardCharsets;\n import java.util.Arrays;\n import java.util.Collections;\n import java.util.HashMap;\n@@ -37,32 +38,31 @@\n import org.xwiki.model.reference.AttachmentReference;\n import org.xwiki.model.reference.DocumentReference;\n import org.xwiki.model.reference.DocumentReferenceResolver;\n+import org.xwiki.rendering.internal.renderer.xhtml.XHTMLMarkerResourceReferenceSerializer;\n import org.xwiki.rendering.listener.reference.ResourceReference;\n import org.xwiki.rendering.listener.reference.ResourceType;\n-import org.xwiki.rendering.renderer.reference.ResourceReferenceSerializer;\n+import org.xwiki.test.annotation.ComponentList;\n import org.xwiki.test.junit5.mockito.ComponentTest;\n import org.xwiki.test.junit5.mockito.MockComponent;\n \n import com.github.ooxi.jdatauri.DataUri;\n \n import static org.junit.jupiter.api.Assertions.assertEquals;\n-import static org.mockito.Mockito.*;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n \n /**\n  * Unit tests for {@link ImageFilter}.\n  * \n  * @version $Id$\n  */\n @ComponentTest\n+@ComponentList({ XHTMLMarkerResourceReferenceSerializer.class })\n public class ImageFilterTest extends AbstractHTMLFilterTest\n {\n     @MockComponent\n     private DocumentAccessBridge dab;\n \n-    @MockComponent\n-    @Named(\"xhtmlmarker\")\n-    private ResourceReferenceSerializer xhtmlMarkerSerializer;\n-\n     @MockComponent\n     @Named(\"currentmixed\")\n     private DocumentReferenceResolver<String> currentMixedResolver;\n@@ -91,7 +91,6 @@ public void filterAddsImageMarkers()\n \n         ResourceReference resourceReference = new ResourceReference(\"-foo--bar.png-\", ResourceType.ATTACHMENT);\n         resourceReference.setTyped(false);\n-        when(this.xhtmlMarkerSerializer.serialize(resourceReference)).thenReturn(\"false|-|attach|-|-foo--bar.png-\");\n \n         filterAndAssertOutput(\"<img src=\\\"../../some/path/-foo--b%61r.png-\\\"/>\",\n             Collections.singletonMap(\"targetDocument\", \"Path.To.Page\"),\n@@ -110,7 +109,6 @@ public void filterAddsImageMarkersSpecialCharacters() throws UnsupportedEncoding\n         ResourceReference resourceReference = new ResourceReference(imageName, ResourceType.ATTACHMENT);\n         resourceReference.setTyped(false);\n         String imageNameEscaped = \"foo&+_bar\\\\\\\\@.png\";\n-        when(this.xhtmlMarkerSerializer.serialize(resourceReference)).thenReturn(\"false|-|attach|-|\" + imageName);\n \n         filterAndAssertOutput(String.format( \"<img src=\\\"../../some/path/%s\\\"/>\", imageNameUrl),\n             Collections.singletonMap(\"targetDocument\", \"Path.To.Page\"),\n@@ -136,7 +134,6 @@ public void filterCollectsEmbeddedImages()\n \n         ResourceReference resourceReference = new ResourceReference(\"foo.png\", ResourceType.ATTACHMENT);\n         resourceReference.setTyped(false);\n-        when(this.xhtmlMarkerSerializer.serialize(resourceReference)).thenReturn(\"false|-|attach|-|foo.png\");\n \n         String fileName =\n             DataUri.parse(\"data:image/jpeg;base64,GgoAAAAN==\", Charset.forName(\"UTF-8\")).hashCode() + \".jpg\";\n@@ -145,7 +142,6 @@ public void filterCollectsEmbeddedImages()\n \n         resourceReference = new ResourceReference(fileName, ResourceType.ATTACHMENT);\n         resourceReference.setTyped(false);\n-        when(this.xhtmlMarkerSerializer.serialize(resourceReference)).thenReturn(\"false|-|attach|-|\" + fileName);\n \n         Map<String, String> parameters = new HashMap<String, String>();\n         parameters.put(\"targetDocument\", \"Path.To.Page\");\n@@ -163,4 +159,25 @@ public void filterCollectsEmbeddedImages()\n         Map<String, byte[]> embeddedImages = (Map<String, byte[]>) document.getUserData(\"embeddedImages\");\n         assertEquals(new HashSet<>(Arrays.asList(\"foo.png\", fileName)), embeddedImages.keySet());\n     }\n+\n+    @Test\n+    void rewriteImagePrefix() throws UnsupportedEncodingException\n+    {\n+        Map<String, String> configuration = Map.of(\n+            \"targetDocument\", \"Path.To.Page\",\n+            \"replaceImagePrefix\", \"output_\",\n+            \"replacementImagePrefix\", \"re@placement_\"\n+        );\n+\n+        String imageName = \"re\\\\@placement_image.png\";\n+        String encodedImageName = URLEncoder.encode(imageName.replace(\"\\\\@\", \"@\"), StandardCharsets.UTF_8);\n+        AttachmentReference attachmentReference = new AttachmentReference(imageName, this.documentReference);\n+        when(this.dab.getAttachmentURL(attachmentReference, false)).thenReturn(\"/path/to/\" + encodedImageName);\n+\n+        filterAndAssertOutput(\"<img src=\\\"output_image.png\\\" />\", configuration,\n+            \"<!--startimage:false|-|attach|-|re\\\\\\\\@placement_image.png-->\"\n+                + \"<img src=\\\"/path/to/re%40placement_image.png\\\"/><!--stopimage-->\");\n+\n+        verify(this.dab).getAttachmentURL(attachmentReference, false);\n+    }\n }"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-importer/src/test/java/org/xwiki/officeimporter/internal/splitter/DefaultXDOMOfficeDocumentSplitterTest.java",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -87,7 +87,7 @@ void documentSplitting() throws Exception\n \n         // Create xdom office document.\n         XDOMOfficeDocument officeDocument =\n-            new XDOMOfficeDocument(xdom, Collections.emptySet(), this.componentManager, null);\n+            new XDOMOfficeDocument(xdom, Collections.emptyMap(), this.componentManager, null);\n         final DocumentReference baseDocument = new DocumentReference(\"xwiki\", \"Test\", \"Test\");\n \n         // Add expectations to mock document name serializer."
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-test/xwiki-platform-office-test-docker/src/test/it/org/xwiki/officeimporter/test/ui/OfficeImporterIT.java",
          "status": "modified",
          "additions": 11,
          "deletions": 10,
          "patch": "@@ -129,7 +129,7 @@ private void verifyImports(TestInfo info)\n         resultPage = importFile(testName, \"ooffice.3.0/Test.odt\");\n         assertTrue(StringUtils.contains(resultPage.getContent(), \"This is a test document.\"));\n         WikiEditPage wikiEditPage = resultPage.editWiki();\n-        String regex = \"(?<imageName>Test_html_[\\\\w]+\\\\.png)\";\n+        String regex = \"(?<imageName>Test_[\\\\w]+\\\\.png)\";\n         Pattern pattern = Pattern.compile(regex, Pattern.MULTILINE);\n         Matcher matcher = pattern.matcher(wikiEditPage.getContent());\n         assertTrue(matcher.find());\n@@ -159,27 +159,28 @@ private void verifyImports(TestInfo info)\n         resultPage = importFile(testName, \"ooffice.3.0/Test_accents & \u00e9$\u00f9 !-_.+();@=.odt\");\n         assertTrue(StringUtils.contains(resultPage.getContent(), \"This is a test document.\"));\n         wikiEditPage = resultPage.editWiki();\n-        regex = \"(?<imageName>Test_accents & e\\\\$u !-_\\\\.\\\\+\\\\(\\\\);\\\\\\\\@=_html_[\\\\w]+\\\\.png)\";\n+        regex = \"(?<imageName>Test_accents & \u00e9\\\\$\u00f9 !-_\\\\.\\\\+\\\\(\\\\);\\\\\\\\@=_\\\\w+\\\\.png)\";\n         pattern = Pattern.compile(regex, Pattern.MULTILINE);\n-        matcher = pattern.matcher(wikiEditPage.getContent());\n-        assertTrue(matcher.find());\n+        String wikiContent = wikiEditPage.getContent();\n+        matcher = pattern.matcher(wikiContent);\n+        assertTrue(matcher.find(), String.format(\"Pattern [%s] not found in [%s]\", regex, wikiContent));\n         imageName = matcher.group(\"imageName\");\n         resultPage = wikiEditPage.clickCancel();\n         attachmentsPane = new AttachmentsViewPage().openAttachmentsDocExtraPane();\n         assertEquals(4, attachmentsPane.getNumberOfAttachments());\n         // the \\ before the @ needs to be removed as it's not in the filename\n-        assertTrue(attachmentsPane.attachmentExistsByFileName(imageName.replaceAll(\"\\\\\\\\@\", \"@\")));\n+        assertTrue(attachmentsPane.attachmentExistsByFileName(imageName.replace(\"\\\\@\", \"@\")));\n         deletePage(testName);\n \n         // Test power point file with accents\n         resultPage = importFile(testName, \"msoffice.97-2003/Test_accents & \u00e9$\u00f9 !-_.+();@=.ppt\");\n         attachmentsPane = new AttachmentsViewPage().openAttachmentsDocExtraPane();\n-        assertTrue(attachmentsPane.attachmentExistsByFileName(\"Test_accents & e$u !-_.+();@=-slide0.jpg\"));\n-        assertTrue(attachmentsPane.attachmentExistsByFileName(\"Test_accents & e$u !-_.+();@=-slide1.jpg\"));\n-        assertTrue(attachmentsPane.attachmentExistsByFileName(\"Test_accents & e$u !-_.+();@=-slide2.jpg\"));\n-        assertTrue(attachmentsPane.attachmentExistsByFileName(\"Test_accents & e$u !-_.+();@=-slide3.jpg\"));\n+        assertTrue(attachmentsPane.attachmentExistsByFileName(\"Test_accents & \u00e9$\u00f9 !-_.+();@=-slide0.jpg\"));\n+        assertTrue(attachmentsPane.attachmentExistsByFileName(\"Test_accents & \u00e9$\u00f9 !-_.+();@=-slide1.jpg\"));\n+        assertTrue(attachmentsPane.attachmentExistsByFileName(\"Test_accents & \u00e9$\u00f9 !-_.+();@=-slide2.jpg\"));\n+        assertTrue(attachmentsPane.attachmentExistsByFileName(\"Test_accents & \u00e9$\u00f9 !-_.+();@=-slide3.jpg\"));\n         wikiEditPage = resultPage.editWiki();\n-        assertTrue(wikiEditPage.getContent().contains(\"[[image:Test_accents & e$u !-_.+();\\\\@=-slide0.jpg]]\"));\n+        assertTrue(wikiEditPage.getContent().contains(\"[[image:Test_accents & \u00e9$\u00f9 !-_.+();\\\\@=-slide0.jpg]]\"));\n         resultPage = wikiEditPage.clickCancel();\n         deletePage(testName);\n     }"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-viewer/src/main/java/org/xwiki/office/viewer/internal/DefaultOfficeResourceViewer.java",
          "status": "modified",
          "additions": 13,
          "deletions": 16,
          "patch": "@@ -20,12 +20,10 @@\n package org.xwiki.office.viewer.internal;\n \n import java.io.File;\n-import java.io.FileInputStream;\n import java.io.InputStream;\n import java.net.URL;\n import java.util.Arrays;\n import java.util.Collections;\n-import java.util.HashMap;\n import java.util.HashSet;\n import java.util.List;\n import java.util.Map;\n@@ -60,6 +58,7 @@\n import org.xwiki.officeimporter.builder.PresentationBuilder;\n import org.xwiki.officeimporter.builder.XDOMOfficeDocumentBuilder;\n import org.xwiki.officeimporter.converter.OfficeConverter;\n+import org.xwiki.officeimporter.document.OfficeDocumentArtifact;\n import org.xwiki.officeimporter.document.XDOMOfficeDocument;\n import org.xwiki.officeimporter.server.OfficeServer;\n import org.xwiki.properties.ConverterManager;\n@@ -200,41 +199,39 @@ public class DefaultOfficeResourceViewer implements OfficeResourceViewer, Initia\n      * images that are view artifacts.\n      * \n      * @param xdom the XDOM whose image blocks are to be processed\n-     * @param artifactFiles specify which of the image blocks should be processed; only the image blocks\n+     * @param artifactMap specify which of the image blocks should be processed; only the image blocks\n      *          that were generated during the office import process should be processed\n      * @param ownerDocumentReference specifies the document that owns the office file\n      * @param parameters the build parameters. Note that currently only {@code filterStyles} is supported and if \"true\"\n      *            it means that styles will be filtered to the maximum and the focus will be put on importing only the\n      * @return the set of temporary files corresponding to image artifacts\n      */\n-    private Set<File> processImages(XDOM xdom, Set<File> artifactFiles, DocumentReference ownerDocumentReference,\n-        Map<String, ?> parameters)\n+    private Set<File> processImages(XDOM xdom, Map<String, OfficeDocumentArtifact> artifactMap,\n+        DocumentReference ownerDocumentReference, Map<String, ?> parameters)\n     {\n         // Process all image blocks.\n         Set<File> temporaryFiles = new HashSet<>();\n         List<ImageBlock> imgBlocks = xdom.getBlocks(new ClassBlockMatcher(ImageBlock.class), Block.Axes.DESCENDANT);\n         if (!imgBlocks.isEmpty()) {\n-            Map<String, File> fileMap = new HashMap<>();\n-            for (File file : artifactFiles) {\n-                fileMap.put(file.getName(), file);\n-            }\n-\n             for (ImageBlock imgBlock : imgBlocks) {\n                 String imageReference = imgBlock.getReference().getReference();\n \n                 // Check whether there is a corresponding artifact.\n-                if (fileMap.containsKey(imageReference)) {\n+                if (artifactMap.containsKey(imageReference)) {\n                     try {\n                         List<String> resourcePath =\n                             Arrays.asList(String.valueOf(parameters.hashCode()), imageReference);\n                         TemporaryResourceReference temporaryResourceReference =\n                             new TemporaryResourceReference(MODULE_NAME, resourcePath, ownerDocumentReference);\n \n                         // Write the image into a temporary file.\n-                        File artifact = fileMap.get(imageReference);\n+                        OfficeDocumentArtifact artifact = artifactMap.get(imageReference);\n \n-                        File tempFile = this.temporaryResourceStore.createTemporaryFile(temporaryResourceReference,\n-                            new FileInputStream(artifact));\n+                        File tempFile;\n+                        try (InputStream inputStream = artifact.getContentInputStream()) {\n+                            tempFile = this.temporaryResourceStore.createTemporaryFile(temporaryResourceReference,\n+                                inputStream);\n+                        }\n \n                         // Create a URL image reference which links to above temporary image file.\n                         String temporaryResourceURL =\n@@ -429,7 +426,7 @@ private OfficeDocumentView getView(ResourceReference reference, AttachmentRefere\n                 // specified by the owner document reference. This way we ensure the path to the temporary files\n                 // doesn't contain redundant information and so it remains as small as possible (considering that the\n                 // path length is limited on some environments).\n-                Set<File> temporaryFiles = processImages(xdom, xdomOfficeDocument.getArtifactsFiles(),\n+                Set<File> temporaryFiles = processImages(xdom, xdomOfficeDocument.getArtifactsMap(),\n                     attachmentReference.getDocumentReference(), parameters);\n                 view = new AttachmentOfficeDocumentView(reference, attachmentReference, attachmentVersion, xdom,\n                     temporaryFiles);\n@@ -457,7 +454,7 @@ private OfficeDocumentView getView(ResourceReference resourceReference, Map<Stri\n             try (XDOMOfficeDocument xdomOfficeDocument = createXDOM(ownerDocument, resourceReference, parameters))\n             {\n                 XDOM xdom = xdomOfficeDocument.getContentDocument();\n-                Set<File> temporaryFiles = processImages(xdom, xdomOfficeDocument.getArtifactsFiles(), ownerDocument,\n+                Set<File> temporaryFiles = processImages(xdom, xdomOfficeDocument.getArtifactsMap(), ownerDocument,\n                     parameters);\n                 view = new OfficeDocumentView(resourceReference, xdom, temporaryFiles);\n "
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-office/xwiki-platform-office-viewer/src/test/java/org/xwiki/office/viewer/internal/DefaultOfficeResourceViewerTest.java",
          "status": "modified",
          "additions": 11,
          "deletions": 15,
          "patch": "@@ -21,7 +21,6 @@\n \n import java.io.ByteArrayInputStream;\n import java.io.File;\n-import java.io.FileOutputStream;\n import java.io.InputStream;\n import java.net.URL;\n import java.util.ArrayList;\n@@ -34,7 +33,6 @@\n import javax.inject.Named;\n import javax.inject.Provider;\n \n-import org.apache.commons.io.IOUtils;\n import org.junit.jupiter.api.BeforeEach;\n import org.junit.jupiter.api.Test;\n import org.xwiki.bridge.DocumentAccessBridge;\n@@ -50,6 +48,7 @@\n import org.xwiki.officeimporter.converter.OfficeConverter;\n import org.xwiki.officeimporter.converter.OfficeConverterResult;\n import org.xwiki.officeimporter.document.XDOMOfficeDocument;\n+import org.xwiki.officeimporter.internal.document.ByteArrayOfficeDocumentArtifact;\n import org.xwiki.officeimporter.server.OfficeServer;\n import org.xwiki.properties.ConverterManager;\n import org.xwiki.rendering.block.Block;\n@@ -281,7 +280,7 @@ void viewExistingOfficeAttachmentWithCacheMiss(MockitoComponentManager component\n         when(documentAccessBridge.getAttachmentContent(ATTACHMENT_REFERENCE)).thenReturn(attachmentContent);\n \n         XDOMOfficeDocument xdomOfficeDocument =\n-            new XDOMOfficeDocument(new XDOM(new ArrayList<Block>()), Collections.emptySet(), componentManager, null);\n+            new XDOMOfficeDocument(new XDOM(new ArrayList<Block>()), Collections.emptyMap(), componentManager, null);\n         when(\n             officeDocumentBuilder.build(attachmentContent, ATTACHMENT_REFERENCE.getName(),\n                 ATTACHMENT_REFERENCE.getDocumentReference(), false)).thenReturn(xdomOfficeDocument);\n@@ -311,7 +310,7 @@ void viewTemporaryUploadedOfficeAttachmentWithCacheMiss(MockitoComponentManager\n         when(attachment.getContentInputStream(this.context)).thenReturn(attachmentContent);\n \n         XDOMOfficeDocument xdomOfficeDocument =\n-            new XDOMOfficeDocument(new XDOM(new ArrayList<Block>()), Collections.emptySet(), componentManager, null);\n+            new XDOMOfficeDocument(new XDOM(new ArrayList<Block>()), Collections.emptyMap(), componentManager, null);\n         when(\n             officeDocumentBuilder.build(attachmentContent, ATTACHMENT_REFERENCE.getName(),\n                 ATTACHMENT_REFERENCE.getDocumentReference(), false)).thenReturn(xdomOfficeDocument);\n@@ -365,7 +364,7 @@ void viewTemporaryUploadedOfficeAttachmentWithCacheHit(MockitoComponentManager c\n         when(attachment.getContentInputStream(this.context)).thenReturn(attachmentContent);\n \n         XDOMOfficeDocument xdomOfficeDocument =\n-            new XDOMOfficeDocument(new XDOM(new ArrayList<Block>()), Collections.emptySet(), componentManager, null);\n+            new XDOMOfficeDocument(new XDOM(new ArrayList<Block>()), Collections.emptyMap(), componentManager, null);\n         when(\n             officeDocumentBuilder.build(attachmentContent, ATTACHMENT_REFERENCE.getName(),\n                 ATTACHMENT_REFERENCE.getDocumentReference(), false)).thenReturn(xdomOfficeDocument);\n@@ -440,7 +439,7 @@ void viewANewVersionOfAnExistingOfficeAttachment(MockitoComponentManager compone\n         when(documentAccessBridge.getAttachmentContent(ATTACHMENT_REFERENCE)).thenReturn(attachmentContent);\n \n         XDOMOfficeDocument xdomOfficeDocument =\n-            new XDOMOfficeDocument(new XDOM(new ArrayList<Block>()), Collections.emptySet(), componentManager, null);\n+            new XDOMOfficeDocument(new XDOM(new ArrayList<Block>()), Collections.emptyMap(), componentManager, null);\n         when(\n             officeDocumentBuilder.build(attachmentContent, ATTACHMENT_REFERENCE.getName(),\n                 ATTACHMENT_REFERENCE.getDocumentReference(), false)).thenReturn(xdomOfficeDocument);\n@@ -471,28 +470,25 @@ void viewPresentation(MockitoComponentManager componentManager) throws Exception\n         ByteArrayInputStream attachmentContent = new ByteArrayInputStream(new byte[256]);\n         when(documentAccessBridge.getAttachmentContent(attachmentReference)).thenReturn(attachmentContent);\n \n-        ResourceReference imageReference = new ResourceReference(\"slide0.png\", ResourceType.URL);\n+        String imageName = \"slide0.png\";\n+        ResourceReference imageReference = new ResourceReference(imageName, ResourceType.URL);\n         ExpandedMacroBlock galleryMacro =\n             new ExpandedMacroBlock(\"gallery\", Collections.singletonMap(\"width\", \"300px\"), null, false);\n         galleryMacro.addChild(new ImageBlock(imageReference, true));\n         XDOM xdom = new XDOM(Collections.<Block>singletonList(galleryMacro));\n \n-        File artifact = new File(this.tempDir, \"slide0.png\");\n-        try (FileOutputStream fos = new FileOutputStream(artifact)) {\n-            IOUtils.write(new byte[8], fos);\n-        }\n         OfficeConverterResult converterResult = mock(OfficeConverterResult.class);\n-        XDOMOfficeDocument xdomOfficeDocument = new XDOMOfficeDocument(xdom, Collections.singleton(artifact),\n-            componentManager, converterResult);\n+        XDOMOfficeDocument xdomOfficeDocument = new XDOMOfficeDocument(xdom, Collections.singletonMap(imageName,\n+            new ByteArrayOfficeDocumentArtifact(imageName, new byte[8])), componentManager, converterResult);\n \n         when(presentationBuilder.build(attachmentContent, attachmentReference.getName(), documentReference))\n             .thenReturn(xdomOfficeDocument);\n \n         Map<String, ?> viewParameters = Collections.singletonMap(\"ownerDocument\", documentReference);\n         TemporaryResourceReference temporaryResourceReference = new TemporaryResourceReference(\"officeviewer\",\n-            Arrays.asList(String.valueOf(viewParameters.hashCode()), \"slide0.png\"), documentReference);\n+            Arrays.asList(String.valueOf(viewParameters.hashCode()), imageName), documentReference);\n \n-        ExtendedURL extendedURL = new ExtendedURL(Arrays.asList(\"url\", \"to\", \"slide0.png\"));\n+        ExtendedURL extendedURL = new ExtendedURL(Arrays.asList(\"url\", \"to\", imageName));\n         when(this.resourceReferenceSerializer.serialize(temporaryResourceReference)).thenReturn(extendedURL);\n \n         XDOM output = this.officeResourceViewer.createView(attachResourceRef, viewParameters);"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/doc/DefaultDocumentAccessBridge.java",
          "status": "modified",
          "additions": 19,
          "deletions": 2,
          "patch": "@@ -623,6 +623,17 @@ public void setAttachmentContent(AttachmentReference attachmentReference, byte[]\n         setAttachmentContent(doc, attachmentReference.getName(), attachmentData, xcontext);\n     }\n \n+    @Override\n+    public void setAttachmentContent(AttachmentReference attachmentReference, InputStream attachmentData)\n+        throws Exception\n+    {\n+        XWikiContext xcontext = getContext();\n+        XWikiDocument doc = xcontext.getWiki().getDocument(attachmentReference.getDocumentReference(), xcontext);\n+\n+        setAttachmentContent(doc, attachmentReference.getName(), attachmentData, xcontext);\n+    }\n+\n+\n     @Override\n     @Deprecated\n     public void setAttachmentContent(String documentReference, String attachmentFilename, byte[] attachmentData)\n@@ -636,15 +647,21 @@ public void setAttachmentContent(String documentReference, String attachmentFile\n \n     private void setAttachmentContent(XWikiDocument doc, String attachmentFilename, byte[] attachmentData,\n         XWikiContext xcontext) throws Exception\n+    {\n+        setAttachmentContent(doc, attachmentFilename,\n+            new ByteArrayInputStream(attachmentData != null ? attachmentData : new byte[0]), xcontext);\n+    }\n+\n+    private void setAttachmentContent(XWikiDocument doc, String attachmentFilename, InputStream attachmentData,\n+        XWikiContext xcontext) throws Exception\n     {\n         if (doc.getAttachment(attachmentFilename) == null) {\n             doc.setComment(\"Add new attachment \" + attachmentFilename);\n         } else {\n             doc.setComment(\"Update attachment \" + attachmentFilename);\n         }\n \n-        doc.setAttachment(attachmentFilename,\n-            new ByteArrayInputStream(attachmentData != null ? attachmentData : new byte[0]), xcontext);\n+        doc.setAttachment(attachmentFilename, attachmentData, xcontext);\n \n         doc.setAuthorReference(getCurrentUserReference());\n         if (doc.isNew()) {"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/doc/DefaultDocumentAccessBridgeTest.java",
          "status": "modified",
          "additions": 30,
          "deletions": 0,
          "patch": "@@ -19,14 +19,22 @@\n  */\n package com.xpn.xwiki.doc;\n \n+import java.io.ByteArrayInputStream;\n+\n+import org.apache.commons.io.IOUtils;\n import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.ValueSource;\n+import org.xwiki.model.reference.AttachmentReference;\n import org.xwiki.model.reference.DocumentReference;\n import org.xwiki.test.junit5.mockito.InjectMockComponents;\n \n import com.xpn.xwiki.test.MockitoOldcore;\n import com.xpn.xwiki.test.junit5.mockito.OldcoreTest;\n \n+import static org.junit.jupiter.api.Assertions.assertArrayEquals;\n import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n import static org.mockito.ArgumentMatchers.anyString;\n import static org.mockito.ArgumentMatchers.eq;\n import static org.mockito.Mockito.doReturn;\n@@ -57,4 +65,26 @@ void testGetUrlEmptyDocument(MockitoOldcore oldcore)\n         assertEquals(expectedURL, this.documentAccessBridge.getURL(\"\", action, \"\", \"\"));\n         assertEquals(expectedURL, this.documentAccessBridge.getURL(null, action, \"\", \"\"));\n     }\n+\n+    @ParameterizedTest\n+    @ValueSource(booleans = { true, false })\n+    void setAttachmentContent(boolean useStream, MockitoOldcore oldcore) throws Exception\n+    {\n+        DocumentReference documentReference = new DocumentReference(\"Wiki\", \"Space\", \"Page\");\n+        String fileName = \"image.png\";\n+        AttachmentReference attachmentReference = new AttachmentReference(fileName, documentReference);\n+        byte[] attachmentContent = new byte[] { 42, 23 };\n+        if (useStream) {\n+            this.documentAccessBridge.setAttachmentContent(attachmentReference,\n+                new ByteArrayInputStream(attachmentContent));\n+        } else {\n+            this.documentAccessBridge.setAttachmentContent(attachmentReference, attachmentContent);\n+        }\n+        XWikiDocument document = oldcore.getSpyXWiki().getDocument(documentReference, oldcore.getXWikiContext());\n+        XWikiAttachment attachment = document.getAttachment(fileName);\n+        assertNotNull(attachment);\n+        assertEquals(fileName, attachment.getFilename());\n+        assertArrayEquals(attachmentContent,\n+            IOUtils.toByteArray(attachment.getAttachmentContent(oldcore.getXWikiContext()).getContentInputStream()));\n+    }\n }"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-wysiwyg/xwiki-platform-wysiwyg-api/src/main/java/org/xwiki/wysiwyg/internal/importer/OfficeAttachmentImporter.java",
          "status": "modified",
          "additions": 7,
          "deletions": 8,
          "patch": "@@ -19,8 +19,6 @@\n  */\n package org.xwiki.wysiwyg.internal.importer;\n \n-import java.io.File;\n-import java.io.FileInputStream;\n import java.io.InputStream;\n import java.util.Map;\n import java.util.Optional;\n@@ -30,7 +28,6 @@\n import javax.inject.Provider;\n import javax.inject.Singleton;\n \n-import org.apache.commons.io.IOUtils;\n import org.xwiki.bridge.DocumentAccessBridge;\n import org.xwiki.component.annotation.Component;\n import org.xwiki.model.reference.AttachmentReference;\n@@ -39,6 +36,7 @@\n import org.xwiki.officeimporter.OfficeImporterException;\n import org.xwiki.officeimporter.builder.PresentationBuilder;\n import org.xwiki.officeimporter.builder.XDOMOfficeDocumentBuilder;\n+import org.xwiki.officeimporter.document.OfficeDocumentArtifact;\n import org.xwiki.officeimporter.document.XDOMOfficeDocument;\n import org.xwiki.officeimporter.server.OfficeServer;\n import org.xwiki.officeimporter.server.OfficeServer.ServerState;\n@@ -167,11 +165,12 @@ private String convertAttachmentContent(AttachmentReference attachmentReference,\n             xdomOfficeDocument = documentBuilder.build(officeFileStream, officeFileName, targetDocRef, filterStyles);\n         }\n         // Attach the images extracted from the imported office document to the target wiki document.\n-        for (File artifact : xdomOfficeDocument.getArtifactsFiles()) {\n-\n-            AttachmentReference artifactReference = new AttachmentReference(artifact.getName(), targetDocRef);\n-            try (FileInputStream fis = new FileInputStream(artifact)) {\n-                documentAccessBridge.setAttachmentContent(artifactReference, IOUtils.toByteArray(fis));\n+        for (Map.Entry<String, OfficeDocumentArtifact> entry : xdomOfficeDocument.getArtifactsMap().entrySet()) {\n+            String filename = entry.getKey();\n+            OfficeDocumentArtifact artifact = entry.getValue();\n+            AttachmentReference artifactReference = new AttachmentReference(filename, targetDocRef);\n+            try (InputStream is = artifact.getContentInputStream()) {\n+                this.documentAccessBridge.setAttachmentContent(artifactReference, is);\n             }\n         }\n         String result = xdomOfficeDocument.getContentAsString(\"annotatedxhtml/1.0\");"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-wysiwyg/xwiki-platform-wysiwyg-api/src/test/java/org/xwiki/wysiwyg/internal/importer/OfficeAttachmentImporterTest.java",
          "status": "modified",
          "additions": 4,
          "deletions": 3,
          "patch": "@@ -49,7 +49,8 @@\n \n import static org.junit.jupiter.api.Assertions.assertEquals;\n import static org.junit.jupiter.api.Assertions.assertThrows;\n-import static org.mockito.Mockito.*;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n \n /**\n  * Unit tests for {@link OfficeAttachmentImporter}.\n@@ -155,7 +156,7 @@ void toHTML() throws Exception\n         XDOMOfficeDocument xdomOfficeDocument = mock(XDOMOfficeDocument.class);\n         when(documentBuilder.build(attachmentContent, \"my.doc\", ATTACHMENT_REFERENCE.getDocumentReference(), true))\n             .thenReturn(xdomOfficeDocument);\n-        when(xdomOfficeDocument.getArtifactsFiles()).thenReturn(Collections.emptySet());\n+        when(xdomOfficeDocument.getArtifactsMap()).thenReturn(Collections.emptyMap());\n         when(xdomOfficeDocument.getContentAsString(\"annotatedxhtml/1.0\")).thenReturn(\"test\");\n \n         Map<String, Object> parameters = Collections.singletonMap(\"filterStyles\", \"true\");\n@@ -179,7 +180,7 @@ void toHTMLTemporaryUploadedAttachment() throws Exception\n         XDOMOfficeDocument xdomOfficeDocument = mock(XDOMOfficeDocument.class);\n         when(documentBuilder.build(attachmentContent, \"my.doc\", ATTACHMENT_REFERENCE.getDocumentReference(), true))\n             .thenReturn(xdomOfficeDocument);\n-        when(xdomOfficeDocument.getArtifactsFiles()).thenReturn(Collections.emptySet());\n+        when(xdomOfficeDocument.getArtifactsMap()).thenReturn(Collections.emptyMap());\n         when(xdomOfficeDocument.getContentAsString(\"annotatedxhtml/1.0\")).thenReturn(\"test\");\n \n         Map<String, Object> parameters = Collections.singletonMap(\"filterStyles\", \"true\");"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 12,
        "unique_directories": 22,
        "max_directory_depth": 12
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "88e3e7d23cbd3e6ed059dbcd6532f94016d42678",
            "date": "2025-01-13T16:58:06Z",
            "author_login": "Sereza7"
          },
          {
            "sha": "9b506ab2bed52744b52699ea05cde15986d42abb",
            "date": "2025-01-13T16:36:24Z",
            "author_login": "mflorea"
          },
          {
            "sha": "d53d6e347b97ac20f60e21fb2bae381f4aaf10f4",
            "date": "2025-01-13T13:25:24Z",
            "author_login": "tmortagne"
          },
          {
            "sha": "d85bd8f9c67c412e0cfb45fb4695b8d4e759bab6",
            "date": "2025-01-13T12:03:22Z",
            "author_login": "tmortagne"
          },
          {
            "sha": "6f210dabc99167cf9f020a048c88325eca34ceea",
            "date": "2025-01-13T08:54:32Z",
            "author_login": "tmortagne"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 9.9,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H",
    "cwe_id": "CWE-22",
    "description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. Starting in version 3.5-milestone-1 and prior to versions 14.10.8 and 15.3-rc-1, triggering the office converter with a specially crafted file name allows writing the attachment's content to an attacker-controlled location on the server as long as the Java process has write access to that location. In particular in the combination with attachment moving, a feature introduced in XWiki 14.0, this is easy to reproduce but it also possible to reproduce in versions as old as XWiki 3.5 by uploading the attachment through the REST API which doesn't remove `/` or `\\` from the filename. As the mime type of the attachment doesn't matter for the exploitation, this could e.g., be used to replace the `jar`-file of an extension which would allow executing arbitrary Java code and thus impact the confidentiality, integrity and availability of the XWiki installation. This vulnerability has been patched in XWiki 14.10.8 and 15.3RC1. There are no known workarounds apart from disabling the office converter.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-10-25T18:17:28.687",
    "last_modified": "2024-11-21T08:12:27.470",
    "fix_date": "2023-03-10T16:26:25Z"
  },
  "references": [
    {
      "url": "https://github.com/xwiki/xwiki-platform/commit/45d182a4141ff22f3ff289cf71e4669bdc714544",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/security/advisories/GHSA-vcvr-v426-3m3m",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://jira.xwiki.org/browse/XWIKI-20715",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/commit/45d182a4141ff22f3ff289cf71e4669bdc714544",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/security/advisories/GHSA-vcvr-v426-3m3m",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://jira.xwiki.org/browse/XWIKI-20715",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Patch",
        "Vendor Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:06:36.927743",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "xwiki-platform",
    "owner": "xwiki",
    "created_at": "2011-03-10T13:26:41Z",
    "updated_at": "2025-01-13T16:58:10Z",
    "pushed_at": "2025-01-14T12:32:03Z",
    "size": 561595,
    "stars": 1030,
    "forks": 554,
    "open_issues": 136,
    "watchers": 1030,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "Java": 34276921,
      "JavaScript": 2392892,
      "HTML": 388086,
      "Less": 318945,
      "AspectJ": 280487,
      "Vue": 222987,
      "CSS": 115460,
      "XSLT": 109285,
      "Clean": 44054,
      "Shell": 32569,
      "Batchfile": 14604,
      "Python": 5046,
      "Groovy": 3012,
      "AMPL": 1296
    },
    "commit_activity": {
      "total_commits_last_year": 1723,
      "avg_commits_per_week": 33.13461538461539,
      "days_active_last_year": 263
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "lgpl-2.1"
    },
    "collected_at": "2025-01-14T12:58:58.685838"
  }
}