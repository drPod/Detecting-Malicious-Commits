{
  "cve_id": "CVE-2023-37918",
  "github_data": {
    "repository": "dapr/dapr",
    "fix_commit": "83ca1abb11ffe34211db55dcd36d96b94252827a",
    "related_commits": [
      "83ca1abb11ffe34211db55dcd36d96b94252827a",
      "83ca1abb11ffe34211db55dcd36d96b94252827a"
    ],
    "patch_url": "https://github.com/dapr/dapr/commit/83ca1abb11ffe34211db55dcd36d96b94252827a.patch",
    "fix_commit_details": {
      "sha": "83ca1abb11ffe34211db55dcd36d96b94252827a",
      "commit_date": "2023-07-19T20:59:48Z",
      "author": {
        "login": "ItalyPaleAle",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Fixed API token authentication bypassed when path contains `/healthz`",
        "length": 777,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 75,
        "additions": 43,
        "deletions": 32
      },
      "files": [
        {
          "filename": "docs/release_notes/v1.11.2.md",
          "status": "modified",
          "additions": 22,
          "deletions": 1,
          "patch": "@@ -2,14 +2,35 @@\n \n This update contains security fixes:\n \n-  - [Security: Potential DoS in avro dependency (CVE-2023-37475)](#security-potential-dos-in-avro-dependency-cve-2023-37475)\n+  - [Security: API token authentication bypass in HTTP endpoints](#security-api-token-authentication-bypass-in-http-endpoints) ([Security advisory](https://github.com/dapr/dapr/security/advisories/GHSA-59m6-82qm-vqgj))\n+  - [Security: Potential DoS in avro dependency](#security-potential-dos-in-avro-dependency-cve-2023-37475) ([CVE-2023-37475](https://github.com/hamba/avro/security/advisories/GHSA-9x44-9pgq-cf45))\n \n Additionally, this patch release contains bug fixes:\n \n   - [Fixed: unbounded history batch save in Workflows](#fixed-unbounded-history-batch-save-in-workflows)\n   - [Fixed: Workflows not working in some Kubernetes clusters](#fixed-workflows-not-working-in-some-kubernetes-clusters)\n   - [Fixed a number of bugs in the gRPC Configuration Subscribe API](#fixed-a-number-of-bugs-in-the-grpc-configuration-subscribe-api)\n \n+## Security: API token authentication bypass in HTTP endpoints\n+\n+### Problem\n+\n+[Security advisory](https://github.com/dapr/dapr/security/advisories/GHSA-59m6-82qm-vqgj)\n+\n+A high-severity vulnerability has been found in Dapr that allows bypassing [API token authentication](https://docs.dapr.io/operations/security/api-token/), which is used by the Dapr sidecar to authenticate calls coming from the application, with a well-crafted HTTP request.\n+\n+### Impact\n+\n+The vulnerability impacts all users on Dapr <=1.10.9 and <=1.11.2 who are using API token authentication.\n+\n+### Root cause\n+\n+The Dapr sidecar allowed all requests containing `/healthz` in the URL (including query string) to bypass API token authentication.\n+\n+### Solution\n+\n+We have changed the API token authentication middleware to allow bypassing the authentication only for healthcheck endpoints more strictly.\n+\n ## Security: Potential DoS in avro dependency (CVE-2023-37475)\n \n ### Problem"
        },
        {
          "filename": "pkg/http/server.go",
          "status": "modified",
          "additions": 21,
          "deletions": 4,
          "patch": "@@ -287,12 +287,29 @@ func useAPIAuthentication(next fasthttp.RequestHandler) fasthttp.RequestHandler\n \n \treturn func(ctx *fasthttp.RequestCtx) {\n \t\tv := ctx.Request.Header.Peek(authConsts.APITokenHeader)\n-\t\tif auth.ExcludedRoute(string(ctx.Request.URI().FullURI())) || string(v) == token {\n-\t\t\tctx.Request.Header.Del(authConsts.APITokenHeader)\n-\t\t\tnext(ctx)\n-\t\t} else {\n+\t\tif string(v) != token && !isRouteExcludedFromAPITokenAuth(string(ctx.Request.Header.Method()), string(ctx.Request.URI().FullURI())) {\n \t\t\tctx.Error(\"invalid api token\", http.StatusUnauthorized)\n+\t\t\treturn\n \t\t}\n+\n+\t\tctx.Request.Header.Del(authConsts.APITokenHeader)\n+\t\tnext(ctx)\n+\t}\n+}\n+\n+func isRouteExcludedFromAPITokenAuth(method string, urlString string) bool {\n+\tu, err := url.Parse(urlString)\n+\tif err != nil {\n+\t\treturn false\n+\t}\n+\tpath := strings.Trim(u.Path, \"/\")\n+\tswitch path {\n+\tcase apiVersionV1 + \"/healthz\":\n+\t\treturn method == http.MethodGet\n+\tcase apiVersionV1 + \"/healthz/outbound\":\n+\t\treturn method == http.MethodGet\n+\tdefault:\n+\t\treturn false\n \t}\n }\n "
        },
        {
          "filename": "pkg/runtime/security/token.go",
          "status": "modified",
          "additions": 0,
          "deletions": 13,
          "patch": "@@ -15,13 +15,10 @@ package security\n \n import (\n \t\"os\"\n-\t\"strings\"\n \n \t\"github.com/dapr/dapr/pkg/runtime/security/consts\"\n )\n \n-var excludedRoutes = []string{\"/healthz\"}\n-\n // GetAPIToken returns the value of the api token from an environment variable.\n func GetAPIToken() string {\n \treturn os.Getenv(consts.APITokenEnvVar)\n@@ -31,13 +28,3 @@ func GetAPIToken() string {\n func GetAppToken() string {\n \treturn os.Getenv(consts.AppAPITokenEnvVar)\n }\n-\n-// ExcludedRoute returns whether a given route should be excluded from a token check.\n-func ExcludedRoute(route string) bool {\n-\tfor _, r := range excludedRoutes {\n-\t\tif strings.Contains(route, r) {\n-\t\t\treturn true\n-\t\t}\n-\t}\n-\treturn false\n-}"
        },
        {
          "filename": "pkg/runtime/security/token_test.go",
          "status": "modified",
          "additions": 0,
          "deletions": 14,
          "patch": "@@ -54,17 +54,3 @@ func TestAppToken(t *testing.T) {\n \t\tassert.Equal(t, \"\", token)\n \t})\n }\n-\n-func TestExcludedRoute(t *testing.T) {\n-\tt.Run(\"healthz route is excluded\", func(t *testing.T) {\n-\t\troute := \"v1.0/healthz\"\n-\t\texcluded := ExcludedRoute(route)\n-\t\tassert.True(t, excluded)\n-\t})\n-\n-\tt.Run(\"custom route is not excluded\", func(t *testing.T) {\n-\t\troute := \"v1.0/state\"\n-\t\texcluded := ExcludedRoute(route)\n-\t\tassert.False(t, excluded)\n-\t})\n-}"
        }
      ],
      "file_patterns": {
        "security_files": 2,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 3,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "3a0f55154984ae9c6b6b703081806be7e9523164",
            "date": "2025-01-10T15:17:07Z",
            "author_login": "Gallardot"
          },
          {
            "sha": "b618e8d1071eab4a96bc3603b4df6c22623b5e9c",
            "date": "2025-01-09T19:31:45Z",
            "author_login": "antontroshin"
          },
          {
            "sha": "6c488fdf7d2995d074413c875fc2e3fb4134a33b",
            "date": "2024-12-02T14:51:59Z",
            "author_login": "JoshVanL"
          },
          {
            "sha": "34f0b8765c1ad4eab025b21f8302cae29b935199",
            "date": "2024-12-02T03:04:13Z",
            "author_login": "artursouza"
          },
          {
            "sha": "24ac3b84a96c399e998e797a0a09719ec98ad1bc",
            "date": "2024-11-28T14:39:02Z",
            "author_login": "lrascao"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.8,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:C/C:H/I:N/A:N",
    "cwe_id": "CWE-287",
    "description": "Dapr is a portable, event-driven, runtime for building distributed applications across cloud and edge. A vulnerability has been found in Dapr that allows bypassing API token authentication, which is used by the Dapr sidecar to authenticate calls coming from the application, with a well-crafted HTTP request. Users who leverage API token authentication are encouraged to upgrade Dapr to 1.10.9 or to 1.11.2. This vulnerability impacts Dapr users who have configured API token authentication. An attacker could craft a request that is always allowed by the Dapr sidecar over HTTP, even if the `dapr-api-token` in the request is invalid or missing. The issue has been fixed in Dapr 1.10.9 or to 1.11.2. There are no known workarounds for this vulnerability.\n",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-07-21T21:15:11.657",
    "last_modified": "2024-11-21T08:12:28.140",
    "fix_date": "2023-07-19T20:59:48Z"
  },
  "references": [
    {
      "url": "https://docs.dapr.io/operations/security/api-token/",
      "source": "security-advisories@github.com",
      "tags": [
        "Product"
      ]
    },
    {
      "url": "https://github.com/dapr/dapr/commit/83ca1abb11ffe34211db55dcd36d96b94252827a",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/dapr/dapr/security/advisories/GHSA-59m6-82qm-vqgj",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://docs.dapr.io/operations/security/api-token/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Product"
      ]
    },
    {
      "url": "https://github.com/dapr/dapr/commit/83ca1abb11ffe34211db55dcd36d96b94252827a",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/dapr/dapr/security/advisories/GHSA-59m6-82qm-vqgj",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Vendor Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:06:04.263642",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "dapr",
    "owner": "dapr",
    "created_at": "2019-06-19T00:49:06Z",
    "updated_at": "2025-01-14T12:22:07Z",
    "pushed_at": "2025-01-14T00:40:09Z",
    "size": 124744,
    "stars": 24310,
    "forks": 1913,
    "open_issues": 427,
    "watchers": 24310,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "master",
      "release-0.1",
      "release-0.2",
      "release-0.3",
      "release-0.4",
      "release-0.5",
      "release-0.6",
      "release-0.7",
      "release-0.8",
      "release-0.9",
      "release-0.10",
      "release-0.11",
      "release-1.0-rc4_merge_master",
      "release-1.0",
      "release-1.1",
      "release-1.2",
      "release-1.3",
      "release-1.4",
      "release-1.5",
      "release-1.6",
      "release-1.7",
      "release-1.8",
      "release-1.9",
      "release-1.10",
      "release-1.11",
      "release-1.12"
    ],
    "languages": {
      "Go": 8421049,
      "Shell": 77924,
      "Makefile": 75429,
      "JavaScript": 26814,
      "Bicep": 26690,
      "C#": 20676,
      "Java": 17757,
      "Python": 13029,
      "Dockerfile": 9034,
      "Mustache": 7525,
      "Smarty": 4268,
      "PHP": 2600,
      "Batchfile": 1187
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "apache-2.0"
    },
    "collected_at": "2025-01-14T14:28:49.244398"
  }
}