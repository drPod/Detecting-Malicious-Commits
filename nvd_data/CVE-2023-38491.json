{
  "cve_id": "CVE-2023-38491",
  "github_data": {
    "repository": "getkirby/kirby",
    "fix_commit": "2f06ba1c026bc91cb0702bc16b7d505642536d15",
    "related_commits": [
      "2f06ba1c026bc91cb0702bc16b7d505642536d15",
      "2f06ba1c026bc91cb0702bc16b7d505642536d15"
    ],
    "patch_url": "https://github.com/getkirby/kirby/commit/2f06ba1c026bc91cb0702bc16b7d505642536d15.patch",
    "fix_commit_details": {
      "sha": "2f06ba1c026bc91cb0702bc16b7d505642536d15",
      "commit_date": "2023-07-23T20:17:50Z",
      "author": {
        "login": "lukasbestle",
        "type": "User",
        "stats": {
          "total_commits": 1397,
          "average_weekly_commits": 4.449044585987261,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 202
        }
      },
      "commit_message": {
        "title": "Fix MIME detection vulnerability",
        "length": 107,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 46,
        "additions": 44,
        "deletions": 2
      },
      "files": [
        {
          "filename": "src/Http/Response.php",
          "status": "modified",
          "additions": 12,
          "deletions": 0,
          "patch": "@@ -176,6 +176,18 @@ public static function file(string $file, array $props = []): static\n \t\t\t'type' => F::extensionToMime(F::extension($file))\n \t\t], $props);\n \n+\t\t// if we couldn't serve a correct MIME type, force\n+\t\t// the browser to display the file as plain text to\n+\t\t// harden against attacks from malicious file uploads\n+\t\tif ($props['type'] === null) {\n+\t\t\tif (isset($props['headers']) !== true) {\n+\t\t\t\t$props['headers'] = [];\n+\t\t\t}\n+\n+\t\t\t$props['type'] = 'text/plain';\n+\t\t\t$props['headers']['X-Content-Type-Options'] = 'nosniff';\n+\t\t}\n+\n \t\treturn new static($props);\n \t}\n "
        },
        {
          "filename": "tests/Http/ResponseTest.php",
          "status": "modified",
          "additions": 31,
          "deletions": 2,
          "patch": "@@ -188,13 +188,41 @@ public function testJsonWithPrettyArray()\n \n \tpublic function testFile()\n \t{\n-\t\t$file = __DIR__ . '/fixtures/download.txt';\n+\t\t$file = __DIR__ . '/fixtures/download.json';\n+\n+\t\t$response = Response::file($file);\n+\n+\t\t$this->assertSame('application/json', $response->type());\n+\t\t$this->assertSame(200, $response->code());\n+\t\t$this->assertSame('{\"foo\": \"bar\"}', $response->body());\n+\n+\t\t$response = Response::file($file, [\n+\t\t\t'code'    => '201',\n+\t\t\t'headers' => [\n+\t\t\t\t'Pragma' => 'no-cache'\n+\t\t\t]\n+\t\t]);\n+\n+\t\t$this->assertSame('application/json', $response->type());\n+\t\t$this->assertSame(201, $response->code());\n+\t\t$this->assertSame('{\"foo\": \"bar\"}', $response->body());\n+\t\t$this->assertSame([\n+\t\t\t'Pragma' => 'no-cache'\n+\t\t], $response->headers());\n+\t}\n+\n+\tpublic function testFileInvalid()\n+\t{\n+\t\t$file = __DIR__ . '/fixtures/download.xyz';\n \n \t\t$response = Response::file($file);\n \n \t\t$this->assertSame('text/plain', $response->type());\n \t\t$this->assertSame(200, $response->code());\n \t\t$this->assertSame('test', $response->body());\n+\t\t$this->assertSame([\n+\t\t\t'X-Content-Type-Options' => 'nosniff',\n+\t\t], $response->headers());\n \n \t\t$response = Response::file($file, [\n \t\t\t'code'    => '201',\n@@ -207,7 +235,8 @@ public function testFile()\n \t\t$this->assertSame(201, $response->code());\n \t\t$this->assertSame('test', $response->body());\n \t\t$this->assertSame([\n-\t\t\t'Pragma' => 'no-cache'\n+\t\t\t'Pragma' => 'no-cache',\n+\t\t\t'X-Content-Type-Options' => 'nosniff',\n \t\t], $response->headers());\n \t}\n "
        },
        {
          "filename": "tests/Http/fixtures/download.json",
          "status": "added",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -0,0 +1 @@\n+{\"foo\": \"bar\"}\n\\ No newline at end of file"
        },
        {
          "filename": "tests/Http/fixtures/download.xyz",
          "status": "renamed",
          "additions": 0,
          "deletions": 0,
          "patch": null
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 1,
        "dependency_files": 0,
        "test_files": 3,
        "unique_directories": 3,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "94cc37ee7c3004ebb4950a53f14e1329ed4d28d3",
            "date": "2024-11-28T10:10:23Z",
            "author_login": "bastianallgeier"
          },
          {
            "sha": "7512f22b46f8a065af3e22ba8ef942d6a0b21c9a",
            "date": "2024-11-27T13:20:40Z",
            "author_login": "bastianallgeier"
          },
          {
            "sha": "470b395c27d7dc79b457ca7b854a27d455398e10",
            "date": "2024-11-27T13:20:04Z",
            "author_login": "bastianallgeier"
          },
          {
            "sha": "24bba50eecfcfbe5316b51bc08e167e336b1cab9",
            "date": "2024-11-27T13:14:11Z",
            "author_login": "bastianallgeier"
          },
          {
            "sha": "41353f79c838270f0e82f5a87992ebd83704ce8d",
            "date": "2024-11-26T10:31:52Z",
            "author_login": "bastianallgeier"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 5.7,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:U/C:H/I:N/A:N",
    "cwe_id": "CWE-79",
    "description": "Kirby is a content management system. A vulnerability in versions prior to 3.5.8.3, 3.6.6.3, 3.7.5.2, 3.8.4.1, and 3.9.6 affects all Kirby sites that might have potential attackers in the group of authenticated Panel users or that allow external visitors to upload an arbitrary file to the content folder. Kirby sites are not affected if they don't allow file uploads for untrusted users or visitors or if the file extensions of uploaded files are limited to a fixed safe list. The attack requires user interaction by another user or visitor and cannot be automated.\n\nAn editor with write access to the Kirby Panel could upload a file with an unknown file extension like `.xyz` that contains HTML code including harmful content like `<script>` tags. The direct link to that file could be sent to other users or visitors of the site. If the victim opened that link in a browser where they are logged in to Kirby and the file had not been opened by anyone since the upload, Kirby would not be able to send the correct MIME content type, instead falling back to `text/html`. The browser would then run the script, which could for example trigger requests to Kirby's API with the permissions of the victim.\n\nThe issue was caused by the underlying `Kirby\\Http\\Response::file()` method, which didn't have an explicit fallback if the MIME type could not be determined from the file extension. If you use this method in site or plugin code, these uses may be affected by the same vulnerability.\n\nThe problem has been patched in Kirby 3.5.8.3, 3.6.6.3, 3.7.5.2, 3.8.4.1, and 3.9.6. In all of the mentioned releases, the maintainers have fixed the affected method to use a fallback MIME type of `text/plain` and set the `X-Content-Type-Options: nosniff` header if the MIME type of the file is unknown.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-07-27T16:15:10.810",
    "last_modified": "2024-11-21T08:13:40.917",
    "fix_date": "2023-07-23T20:17:50Z"
  },
  "references": [
    {
      "url": "https://github.com/getkirby/kirby/commit/2f06ba1c026bc91cb0702bc16b7d505642536d15",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/getkirby/kirby/releases/tag/3.5.8.3",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/getkirby/kirby/releases/tag/3.6.6.3",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/getkirby/kirby/releases/tag/3.7.5.2",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/getkirby/kirby/releases/tag/3.8.4.1",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/getkirby/kirby/releases/tag/3.9.6",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/getkirby/kirby/security/advisories/GHSA-8fv7-wq38-f5c9",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/getkirby/kirby/commit/2f06ba1c026bc91cb0702bc16b7d505642536d15",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/getkirby/kirby/releases/tag/3.5.8.3",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/getkirby/kirby/releases/tag/3.6.6.3",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/getkirby/kirby/releases/tag/3.7.5.2",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/getkirby/kirby/releases/tag/3.8.4.1",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/getkirby/kirby/releases/tag/3.9.6",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/getkirby/kirby/security/advisories/GHSA-8fv7-wq38-f5c9",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:06:04.277222",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "kirby",
    "owner": "getkirby",
    "created_at": "2017-10-06T11:35:25Z",
    "updated_at": "2025-01-13T22:44:14Z",
    "pushed_at": "2025-01-14T08:52:45Z",
    "size": 48636,
    "stars": 1335,
    "forks": 173,
    "open_issues": 173,
    "watchers": 1335,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [
      "develop-minor",
      "develop-patch",
      "main"
    ],
    "languages": {
      "PHP": 4627131,
      "Vue": 996369,
      "JavaScript": 426063,
      "CSS": 33910,
      "HTML": 11552,
      "Shell": 1881,
      "Hack": 901
    },
    "commit_activity": {
      "total_commits_last_year": 1670,
      "avg_commits_per_week": 32.11538461538461,
      "days_active_last_year": 194
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T13:53:49.566873"
  }
}