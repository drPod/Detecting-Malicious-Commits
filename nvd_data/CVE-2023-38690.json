{
  "cve_id": "CVE-2023-38690",
  "github_data": {
    "repository": "matrix-org/matrix-appservice-irc",
    "fix_commit": "0afb064635d37e039067b5b3d6423448b93026d3",
    "related_commits": [
      "0afb064635d37e039067b5b3d6423448b93026d3",
      "0afb064635d37e039067b5b3d6423448b93026d3"
    ],
    "patch_url": "https://github.com/matrix-org/matrix-appservice-irc/commit/0afb064635d37e039067b5b3d6423448b93026d3.patch",
    "fix_commit_details": {
      "sha": "0afb064635d37e039067b5b3d6423448b93026d3",
      "commit_date": "2023-07-28T09:06:42Z",
      "author": {
        "login": "Half-Shot",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Add a test to ensure that the irc client state doesn't bloat on VERSION (#1753)",
        "length": 203,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 127,
        "additions": 113,
        "deletions": 14
      },
      "files": [
        {
          "filename": ".eslintrc",
          "status": "modified",
          "additions": 15,
          "deletions": 2,
          "patch": "@@ -10,8 +10,7 @@\n   },\n   \"env\": {\n     \"node\": true,\n-    \"es6\": true,\n-    \"jasmine\": true\n+    \"es6\": true\n   },\n   \"extends\": [\n     \"eslint:recommended\",\n@@ -102,6 +101,11 @@\n       \"files\": [\n         \"spec/**/*.js\"\n       ],\n+      \"env\": {\n+        \"node\": true,\n+        \"es6\": true,\n+        \"jasmine\": true\n+      },\n       \"rules\": {\n         \"@typescript-eslint/no-this-alias\": \"off\", // I'm unsure if we should disallow this.\n         \"@typescript-eslint/no-empty-function\": \"off\",\n@@ -113,6 +117,15 @@\n         \"prefer-const\": \"off\",\n         \"no-var\": \"off\",\n       }\n+    },\n+    {\n+      \"extends\": [\"plugin:jest/recommended\"],\n+      \"files\": [\n+        \"spec/e2e/*.spec.ts\"\n+      ],\n+      \"rules\": {\n+        \"jest/expect-expect\": \"off\" // E2E tests don't always assert\n+      }\n     }\n   ],\n   \"ignorePatterns\": [\"widget/**/*\"]"
        },
        {
          "filename": "changelog.d/1753.bugfix",
          "status": "added",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -0,0 +1 @@\n+Ensure we don't bloat irc supported state."
        },
        {
          "filename": "package.json",
          "status": "modified",
          "additions": 4,
          "deletions": 3,
          "patch": "@@ -17,7 +17,7 @@\n     \"dev:widget\": \"vite dev --config widget/vite.config.ts\",\n     \"test\": \"ts-node --project spec/tsconfig.json node_modules/jasmine/bin/jasmine --stop-on-failure=true\",\n     \"test:e2e\": \"jest --config spec/e2e/jest.config.js --forceExit\",\n-    \"lint\": \"eslint -c .eslintrc --max-warnings 0 'spec/**/*.js' 'src/**/*.ts' && eslint -c ./widget/.eslintrc.js 'widget/src/**/*.{ts,tsx}'\",\n+    \"lint\": \"eslint -c .eslintrc --max-warnings 0 'spec/**/*.js' 'spec/**/*.ts' 'src/**/*.ts' && eslint -c ./widget/.eslintrc.js 'widget/src/**/*.{ts,tsx}'\",\n     \"check\": \"yarn test && yarn lint\",\n     \"ci-test\": \"nyc --report text jasmine\",\n     \"ci\": \"yarn lint && yarn ci-test\"\n@@ -45,7 +45,7 @@\n     \"logform\": \"^2.4.2\",\n     \"matrix-appservice-bridge\": \"^9.0.0\",\n     \"matrix-bot-sdk\": \"npm:@vector-im/matrix-bot-sdk@^0.6.6-element.1\",\n-    \"matrix-org-irc\": \"^2.0.1\",\n+    \"matrix-org-irc\": \"^2.1.0\",\n     \"matrix-widget-api\": \"^1.4.0\",\n     \"nopt\": \"^6.0.0\",\n     \"p-queue\": \"^6.6.2\",\n@@ -54,8 +54,8 @@\n     \"react\": \"^18.2.0\",\n     \"react-dom\": \"^18.2.0\",\n     \"sanitize-html\": \"^2.7.2\",\n-    \"typescript\": \"^5.0.4\",\n     \"typed-emitter\": \"^2.1.0\",\n+    \"typescript\": \"^5.0.4\",\n     \"url-join\": \"^5.0.0\",\n     \"winston\": \"^3.8.2\",\n     \"winston-daily-rotate-file\": \"^4.7.1\"\n@@ -82,6 +82,7 @@\n     \"@vitejs/plugin-react\": \"^3.0.1\",\n     \"autoprefixer\": \"^10.4.13\",\n     \"eslint\": \"^8.24.0\",\n+    \"eslint-plugin-jest\": \"^27.2.3\",\n     \"eslint-plugin-react\": \"^7.32.2\",\n     \"eslint-plugin-react-hooks\": \"^4.6.0\",\n     \"homerunner-client\": \"^0.0.6\","
        },
        {
          "filename": "spec/e2e/pooling.spec.ts",
          "status": "modified",
          "additions": 27,
          "deletions": 0,
          "patch": "@@ -72,4 +72,31 @@ describeif('Connection pooling', () => {\n         bob.say(channel, \"Hi alice!\");\n         await bobMsg;\n     });\n+\n+    it('should store the IRC client state once', async () => {\n+        const channel = `#${TestIrcServer.generateUniqueNick(\"test\")}`;\n+        const { homeserver, ircBridge } = testEnv;\n+        const { client, userId } = homeserver.users[0];\n+        const adminRoomId = await testEnv.createAdminRoomHelper(client);\n+\n+        // Ensure we join IRC.\n+        const cRoomId = await testEnv.joinChannelHelper(client, adminRoomId, channel);\n+        await client.sendText(cRoomId, \"Hello bob!\");\n+\n+\n+        const bridgedClient = await ircBridge.getBridgedClient(ircBridge.getServers()[0], userId);\n+        await bridgedClient.waitForConnected();\n+        const ircClient = await bridgedClient.assertConnected();\n+\n+        // This is the original state of supported. We clone the object to be safe.\n+        const expectedState = JSON.parse(JSON.stringify(ircClient.supported));\n+\n+        // Request VERSION to re-request state.\n+        await bridgedClient.sendCommands('VERSION');\n+        await new Promise<void>(resolve => setTimeout(resolve, 2000));\n+        const newState = { ...ircClient.supported };\n+\n+        expect(expectedState).toEqual(newState);\n+    });\n+\n });"
        },
        {
          "filename": "spec/e2e/powerlevels.spec.ts",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -46,6 +46,6 @@ describe('Ensure powerlevels are appropriately applied', () => {\n \n         await charlieJoinPromise;\n         await bob.send('MODE', channel, '+o', charlie.nick);\n-        await plEvent;\n+        expect(await plEvent).toBeDefined();\n     });\n });"
        },
        {
          "filename": "spec/integ/provisioning.spec.ts",
          "status": "modified",
          "additions": 4,
          "deletions": 3,
          "patch": "@@ -1,3 +1,4 @@\n+/* eslint-disable @typescript-eslint/no-explicit-any */\n import { ErrCode } from \"matrix-appservice-bridge\";\n \n import { defer } from \"../../src/promiseutil\";\n@@ -137,7 +138,7 @@ describe(\"Provisioning API\", function() {\n         let sentReply = false;\n         if (shouldOpRespond) {\n             // Listen for message from bot\n-            env.ircMock._whenClient(config._server, config._botnick, \"say\", (self: any, message: any) => {\n+            env.ircMock._whenClient(config._server, config._botnick, \"say\", (self: any) => {\n                 // Say yes back to the bot\n                 if (sentReply) {\n                     return;\n@@ -537,7 +538,7 @@ describe(\"Provisioning API\", function() {\n                 linkBody.remote_room_server,\n                 nickForDisplayName,\n                 \"say\",\n-                (client, channel, text) => {\n+                (client, channel) => {\n                     expect(client.nick).toEqual(nickForDisplayName);\n                     expect(client.addr).toEqual(linkBody.remote_room_server);\n                     expect(channel).toEqual(linkBody.remote_room_channel);\n@@ -583,7 +584,7 @@ describe(\"Provisioning API\", function() {\n                 linkBody.remote_room_server,\n                 nickForDisplayName,\n                 \"say\",\n-                (client, channel, text) => {\n+                (client, channel) => {\n                     expect(client.nick).toEqual(nickForDisplayName);\n                     expect(client.addr).toEqual(linkBody.remote_room_server);\n                     expect(channel).toEqual(linkBody.remote_room_channel);"
        },
        {
          "filename": "spec/unit/pool-service/IrcClientRedisState.ts",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -3,6 +3,7 @@ import { IrcClientRedisState, IrcClientStateDehydrated } from \"../../../src/pool\n \n const userId = \"@foo:bar\";\n \n+// eslint-disable-next-line @typescript-eslint/no-explicit-any\n function fakeRedis(existingData: string|null = null): any {\n     return {\n         async hget(key, clientId) {"
        },
        {
          "filename": "src/irc/BridgedClient.ts",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -1169,7 +1169,7 @@ export class BridgedClient extends EventEmitter {\n         return this.connectDefer.promise;\n     }\n \n-    private assertConnected(): Client {\n+    public assertConnected(): Client {\n         if (this.state.status !== BridgedClientStatus.CONNECTED) {\n             throw Error('Client is not connected');\n         }"
        },
        {
          "filename": "yarn.lock",
          "status": "modified",
          "additions": 59,
          "deletions": 4,
          "patch": "@@ -1202,6 +1202,14 @@\n     \"@typescript-eslint/types\" \"5.59.1\"\n     \"@typescript-eslint/visitor-keys\" \"5.59.1\"\n \n+\"@typescript-eslint/scope-manager@5.62.0\":\n+  version \"5.62.0\"\n+  resolved \"https://registry.yarnpkg.com/@typescript-eslint/scope-manager/-/scope-manager-5.62.0.tgz#d9457ccc6a0b8d6b37d0eb252a23022478c5460c\"\n+  integrity sha512-VXuvVvZeQCQb5Zgf4HAxc04q5j+WrNAtNh9OwCsCgpKqESMTu3tF/jhZ3xG6T4NZwWl65Bg8KuS2uEvhSfLl0w==\n+  dependencies:\n+    \"@typescript-eslint/types\" \"5.62.0\"\n+    \"@typescript-eslint/visitor-keys\" \"5.62.0\"\n+\n \"@typescript-eslint/type-utils@5.59.1\":\n   version \"5.59.1\"\n   resolved \"https://registry.yarnpkg.com/@typescript-eslint/type-utils/-/type-utils-5.59.1.tgz#63981d61684fd24eda2f9f08c0a47ecb000a2111\"\n@@ -1217,6 +1225,11 @@\n   resolved \"https://registry.yarnpkg.com/@typescript-eslint/types/-/types-5.59.1.tgz#03f3fedd1c044cb336ebc34cc7855f121991f41d\"\n   integrity sha512-dg0ICB+RZwHlysIy/Dh1SP+gnXNzwd/KS0JprD3Lmgmdq+dJAJnUPe1gNG34p0U19HvRlGX733d/KqscrGC1Pg==\n \n+\"@typescript-eslint/types@5.62.0\":\n+  version \"5.62.0\"\n+  resolved \"https://registry.yarnpkg.com/@typescript-eslint/types/-/types-5.62.0.tgz#258607e60effa309f067608931c3df6fed41fd2f\"\n+  integrity sha512-87NVngcbVXUahrRTqIK27gD2t5Cu1yuCXxbLcFtCzZGlfyVWWh8mLHkoxzjsB6DDNnvdL+fW8MiwPEJyGJQDgQ==\n+\n \"@typescript-eslint/typescript-estree@5.59.1\":\n   version \"5.59.1\"\n   resolved \"https://registry.yarnpkg.com/@typescript-eslint/typescript-estree/-/typescript-estree-5.59.1.tgz#4aa546d27fd0d477c618f0ca00b483f0ec84c43c\"\n@@ -1230,6 +1243,19 @@\n     semver \"^7.3.7\"\n     tsutils \"^3.21.0\"\n \n+\"@typescript-eslint/typescript-estree@5.62.0\":\n+  version \"5.62.0\"\n+  resolved \"https://registry.yarnpkg.com/@typescript-eslint/typescript-estree/-/typescript-estree-5.62.0.tgz#7d17794b77fabcac615d6a48fb143330d962eb9b\"\n+  integrity sha512-CmcQ6uY7b9y694lKdRB8FEel7JbU/40iSAPomu++SjLMntB+2Leay2LO6i8VnJk58MtE9/nQSFIH6jpyRWyYzA==\n+  dependencies:\n+    \"@typescript-eslint/types\" \"5.62.0\"\n+    \"@typescript-eslint/visitor-keys\" \"5.62.0\"\n+    debug \"^4.3.4\"\n+    globby \"^11.1.0\"\n+    is-glob \"^4.0.3\"\n+    semver \"^7.3.7\"\n+    tsutils \"^3.21.0\"\n+\n \"@typescript-eslint/utils@5.59.1\":\n   version \"5.59.1\"\n   resolved \"https://registry.yarnpkg.com/@typescript-eslint/utils/-/utils-5.59.1.tgz#d89fc758ad23d2157cfae53f0b429bdf15db9473\"\n@@ -1244,6 +1270,20 @@\n     eslint-scope \"^5.1.1\"\n     semver \"^7.3.7\"\n \n+\"@typescript-eslint/utils@^5.10.0\":\n+  version \"5.62.0\"\n+  resolved \"https://registry.yarnpkg.com/@typescript-eslint/utils/-/utils-5.62.0.tgz#141e809c71636e4a75daa39faed2fb5f4b10df86\"\n+  integrity sha512-n8oxjeb5aIbPFEtmQxQYOLI0i9n5ySBEY/ZEHHZqKQSFnxio1rv6dthascc9dLuwrL0RC5mPCxB7vnAVGAYWAQ==\n+  dependencies:\n+    \"@eslint-community/eslint-utils\" \"^4.2.0\"\n+    \"@types/json-schema\" \"^7.0.9\"\n+    \"@types/semver\" \"^7.3.12\"\n+    \"@typescript-eslint/scope-manager\" \"5.62.0\"\n+    \"@typescript-eslint/types\" \"5.62.0\"\n+    \"@typescript-eslint/typescript-estree\" \"5.62.0\"\n+    eslint-scope \"^5.1.1\"\n+    semver \"^7.3.7\"\n+\n \"@typescript-eslint/visitor-keys@5.59.1\":\n   version \"5.59.1\"\n   resolved \"https://registry.yarnpkg.com/@typescript-eslint/visitor-keys/-/visitor-keys-5.59.1.tgz#0d96c36efb6560d7fb8eb85de10442c10d8f6058\"\n@@ -1252,6 +1292,14 @@\n     \"@typescript-eslint/types\" \"5.59.1\"\n     eslint-visitor-keys \"^3.3.0\"\n \n+\"@typescript-eslint/visitor-keys@5.62.0\":\n+  version \"5.62.0\"\n+  resolved \"https://registry.yarnpkg.com/@typescript-eslint/visitor-keys/-/visitor-keys-5.62.0.tgz#2174011917ce582875954ffe2f6912d5931e353e\"\n+  integrity sha512-07ny+LHRzQXepkGg6w0mFY41fVUNBrL2Roj/++7V1txKugfjm/Ci/qSND03r2RhlJhJYMcTn9AhhSSqQp0Ysyw==\n+  dependencies:\n+    \"@typescript-eslint/types\" \"5.62.0\"\n+    eslint-visitor-keys \"^3.3.0\"\n+\n \"@vitejs/plugin-react@^3.0.1\":\n   version \"3.1.0\"\n   resolved \"https://registry.yarnpkg.com/@vitejs/plugin-react/-/plugin-react-3.1.0.tgz#d1091f535eab8b83d6e74034d01e27d73c773240\"\n@@ -2378,6 +2426,13 @@ escape-string-regexp@^4.0.0:\n   resolved \"https://registry.yarnpkg.com/escape-string-regexp/-/escape-string-regexp-4.0.0.tgz#14ba83a5d373e3d311e5afca29cf5bfad965bf34\"\n   integrity sha512-TtpcNJ3XAzx3Gq8sWRzJaVajRs0uVxA2YAkdb1jm2YkPz4G6egUFAyA3n5vtEIZefPk5Wa4UXbKuS5fKkJWdgA==\n \n+eslint-plugin-jest@^27.2.3:\n+  version \"27.2.3\"\n+  resolved \"https://registry.yarnpkg.com/eslint-plugin-jest/-/eslint-plugin-jest-27.2.3.tgz#6f8a4bb2ca82c0c5d481d1b3be256ab001f5a3ec\"\n+  integrity sha512-sRLlSCpICzWuje66Gl9zvdF6mwD5X86I4u55hJyFBsxYOsBCmT5+kSUjf+fkFWVMMgpzNEupjW8WzUqi83hJAQ==\n+  dependencies:\n+    \"@typescript-eslint/utils\" \"^5.10.0\"\n+\n eslint-plugin-react-hooks@^4.6.0:\n   version \"4.6.0\"\n   resolved \"https://registry.yarnpkg.com/eslint-plugin-react-hooks/-/eslint-plugin-react-hooks-4.6.0.tgz#4c3e697ad95b77e93f8646aaa1630c1ba607edd3\"\n@@ -4249,10 +4304,10 @@ matrix-appservice@^2.0.0:\n     request-promise \"^4.2.6\"\n     sanitize-html \"^2.8.0\"\n \n-matrix-org-irc@^2.0.1:\n-  version \"2.0.1\"\n-  resolved \"https://registry.yarnpkg.com/matrix-org-irc/-/matrix-org-irc-2.0.1.tgz#80cc1ce3abb3e8f240bbc3b4acf1a0fe0f1057e7\"\n-  integrity sha512-Qnzx1r5QjTtm63oGUY/XyE3t+1xH43CaC8r3QifkKmBihrYyhHq4bpMsnxNYb558sc2j52pixJ5CUsQ8zMediQ==\n+matrix-org-irc@^2.1.0:\n+  version \"2.1.0\"\n+  resolved \"https://registry.yarnpkg.com/matrix-org-irc/-/matrix-org-irc-2.1.0.tgz#513d284d081a01ef752a29cd410c11fce0c5d2c5\"\n+  integrity sha512-MV9Q8Mt8RTKf72U0D5zNbBL9P4JQJzU63HTeomguq6a+Zb5QZJvnBHfrdLJXtJyTsWGCtSbJ6rcSFJVrFmKUxA==\n   dependencies:\n     chardet \"^1.5.1\"\n     iconv-lite \"^0.6.3\""
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 1,
        "dependency_files": 1,
        "test_files": 0,
        "unique_directories": 6,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "062f3ace8b08e86e9f63c004ffdb85942af1b94e",
            "date": "2024-11-14T12:39:22Z",
            "author_login": "tadzik"
          },
          {
            "sha": "b4377c3ebe408d6cbe6ec0308fdf0097f73f5dbf",
            "date": "2024-11-14T09:31:36Z",
            "author_login": "tadzik"
          },
          {
            "sha": "b91b4c88c0ec1c50ccd27fa18f553896e484bb0a",
            "date": "2024-11-12T11:58:31Z",
            "author_login": "tadzik"
          },
          {
            "sha": "dddca422fe2236491327452735cc42343b344dbf",
            "date": "2024-11-12T11:58:02Z",
            "author_login": "tadzik"
          },
          {
            "sha": "7f6c8ea75bea9e92ecc81e2b9b9e877979b0ff01",
            "date": "2024-11-12T09:45:56Z",
            "author_login": "tadzik"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 5.8,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:N/I:L/A:N",
    "cwe_id": "CWE-20",
    "description": "matrix-appservice-irc is a Node.js IRC bridge for Matrix. Prior to version 1.0.1, it is possible to craft a command with newlines which would not be properly parsed. This would mean you could pass a string of commands as a channel name, which would then be run by the IRC bridge bot. Versions 1.0.1 and above are patched. There are no robust workarounds to the bug. One may disable dynamic channels in the config to disable the most common execution method but others may exist.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-08-04T17:15:10.783",
    "last_modified": "2024-11-21T08:14:03.810",
    "fix_date": "2023-07-28T09:06:42Z"
  },
  "references": [
    {
      "url": "https://github.com/matrix-org/matrix-appservice-irc/commit/0afb064635d37e039067b5b3d6423448b93026d3",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/matrix-org/matrix-appservice-irc/releases/tag/1.0.1",
      "source": "security-advisories@github.com",
      "tags": [
        "Release Notes"
      ]
    },
    {
      "url": "https://github.com/matrix-org/matrix-appservice-irc/security/advisories/GHSA-3pmj-jqqp-2mj3",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/matrix-org/matrix-appservice-irc/commit/0afb064635d37e039067b5b3d6423448b93026d3",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/matrix-org/matrix-appservice-irc/releases/tag/1.0.1",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes"
      ]
    },
    {
      "url": "https://github.com/matrix-org/matrix-appservice-irc/security/advisories/GHSA-3pmj-jqqp-2mj3",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:06:04.296362",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "matrix-appservice-irc",
    "owner": "matrix-org",
    "created_at": "2015-03-10T14:42:06Z",
    "updated_at": "2025-01-11T05:33:00Z",
    "pushed_at": "2025-01-08T15:47:53Z",
    "size": 10309,
    "stars": 468,
    "forks": 152,
    "open_issues": 497,
    "watchers": 468,
    "has_security_policy": false,
    "default_branch": "develop",
    "protected_branches": [
      "develop"
    ],
    "languages": {
      "TypeScript": 859555,
      "JavaScript": 312817,
      "CSS": 3243,
      "Shell": 2167,
      "Dockerfile": 1168,
      "HTML": 298
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "apache-2.0"
    },
    "collected_at": "2025-01-14T13:35:16.048239"
  }
}