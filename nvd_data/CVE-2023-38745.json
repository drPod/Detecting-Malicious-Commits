{
  "cve_id": "CVE-2023-38745",
  "github_data": {
    "repository": "jgm/pandoc",
    "fix_commit": "eddedbfc14916aa06fc01ff04b38aeb30ae2e625",
    "related_commits": [
      "eddedbfc14916aa06fc01ff04b38aeb30ae2e625",
      "eddedbfc14916aa06fc01ff04b38aeb30ae2e625"
    ],
    "patch_url": "https://github.com/jgm/pandoc/commit/eddedbfc14916aa06fc01ff04b38aeb30ae2e625.patch",
    "fix_commit_details": {
      "sha": "eddedbfc14916aa06fc01ff04b38aeb30ae2e625",
      "commit_date": "2023-07-20T16:26:38Z",
      "author": {
        "login": "jgm",
        "type": "User",
        "stats": {
          "total_commits": 12078,
          "average_weekly_commits": 15.584516129032258,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 724
        }
      },
      "commit_message": {
        "title": "Fix new variant of the vulnerability in CVE-2023-35936.",
        "length": 913,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 21,
        "additions": 17,
        "deletions": 4
      },
      "files": [
        {
          "filename": "src/Text/Pandoc/Class/IO.hs",
          "status": "modified",
          "additions": 2,
          "deletions": 0,
          "patch": "@@ -224,6 +224,8 @@ writeMedia :: (PandocMonad m, MonadIO m)\n            -> m ()\n writeMedia dir (fp, _mt, bs) = do\n   -- we normalize to get proper path separators for the platform\n+  -- we unescape URI encoding, but given how insertMedia\n+  -- is written, we shouldn't have any % in a canonical media name...\n   let fullpath = normalise $ dir </> unEscapeString fp\n   liftIOError (createDirectoryIfMissing True) (takeDirectory fullpath)\n   report $ Extracting (T.pack fullpath)"
        },
        {
          "filename": "src/Text/Pandoc/MediaBag.hs",
          "status": "modified",
          "additions": 4,
          "deletions": 3,
          "patch": "@@ -90,16 +90,17 @@ insertMedia fp mbMime contents (MediaBag mediamap) =\n                        && Windows.isRelative fp''\n                        && isNothing uri\n                        && not (\"..\" `isInfixOf` fp'')\n+                       && '%' `notElem` fp''\n                      then fp''\n-                     else showDigest (sha1 contents) <> \".\" <> ext\n+                     else showDigest (sha1 contents) <> ext\n         fallback = case takeExtension fp'' of\n                         \".gz\" -> getMimeTypeDef $ dropExtension fp''\n                         _     -> getMimeTypeDef fp''\n         mt = fromMaybe fallback mbMime\n         path = maybe fp'' (unEscapeString . uriPath) uri\n         ext = case takeExtension path of\n-                '.':e -> e\n-                _ -> maybe \"\" T.unpack $ extensionFromMimeType mt\n+                '.':e | '%' `notElem` e -> '.':e\n+                _ -> maybe \"\" (\\x -> '.':T.unpack x) $ extensionFromMimeType mt\n \n -- | Lookup a media item in a 'MediaBag', returning mime type and contents.\n lookupMedia :: FilePath"
        },
        {
          "filename": "test/Tests/MediaBag.hs",
          "status": "modified",
          "additions": 11,
          "deletions": 1,
          "patch": "@@ -20,7 +20,7 @@ tests = [\n         let d = B.doc $\n                   B.para (B.image \"../../test/lalune.jpg\" \"\" mempty) <>\n                   B.para (B.image \"moon.jpg\" \"\" mempty) <>\n-                  B.para (B.image \"data://image/png;base64,cHJpbnQgImhlbGxvIgo=;.lua+%2f%2e%2e%2f%2e%2e%2fa%2elua\" \"\" mempty) <>\n+                  B.para (B.image \"data:image/png;base64,cHJpbnQgImhlbGxvIgo=;.lua+%2f%2e%2e%2f%2e%2e%2fa%2elua\" \"\" mempty) <>\n                   B.para (B.image \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\" \"\" mempty)\n         runIOorExplode $ do\n           fillMediaBag d\n@@ -35,4 +35,14 @@ tests = [\n           (exists3 && not exists4)\n         exists5 <- doesFileExist (\"foo\" </> \"d5fceb6532643d0d84ffe09c40c481ecdf59e15a.gif\")\n         assertBool \"data uri with gif is not properly decoded\" exists5\n+        -- double-encoded version:\n+        let e = B.doc $\n+                  B.para (B.image \"data:image/png;base64,cHJpbnQgInB3bmVkIgo=;.lua+%252f%252e%252e%252f%252e%252e%252fb%252elua\" \"\" mempty)\n+        runIOorExplode $ do\n+          fillMediaBag e\n+          extractMedia \"bar\" e\n+        exists6 <- doesFileExist (\"bar\" </> \"772ceca21a2751863ec46cb23db0e7fc35b9cff8.png\")\n+        exists7 <- doesFileExist \"b.lua\"\n+        assertBool \"data uri with double-encoded malicious payload gets written outside of destination dir\"\n+          (exists6 && not exists7)\n   ]"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 3,
        "max_directory_depth": 4
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "2b6554c475e6e6e500b8cbb39c90b28cc122c423",
            "date": "2025-01-14T17:21:16Z",
            "author_login": "jgm"
          },
          {
            "sha": "0a2e8dd1d648df460e3dcb7361f1dc09b4ad3551",
            "date": "2025-01-14T17:19:42Z",
            "author_login": "nathanlesage"
          },
          {
            "sha": "244156c8ee94a9515daca76aacd80d6b33ff5a71",
            "date": "2025-01-13T16:42:39Z",
            "author_login": "mjgardner"
          },
          {
            "sha": "fd496848d8a9799edc5095ed3134522a9c14ad11",
            "date": "2025-01-12T22:25:14Z",
            "author_login": "jgm"
          },
          {
            "sha": "73f2a675e9d8f4aaf3f585d5d74b5e7f04c17319",
            "date": "2025-01-12T19:11:54Z",
            "author_login": "jgm"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.3,
    "cvss_vector": "CVSS:3.1/AV:L/AC:H/PR:N/UI:R/S:U/C:N/I:H/A:H",
    "cwe_id": null,
    "description": "Pandoc before 3.1.6 allows arbitrary file write: this can be triggered by providing a crafted image element in the input when generating files via the --extract-media option or outputting to PDF format. This allows an attacker to create or overwrite arbitrary files, depending on the privileges of the process running Pandoc. It only affects systems that pass untrusted user input to Pandoc and allow Pandoc to be used to produce a PDF or with the --extract-media option. NOTE: this issue exists because of an incomplete fix for CVE-2023-35936 (failure to properly account for double encoded path names).",
    "attack_vector": "LOCAL",
    "attack_complexity": "HIGH"
  },
  "temporal_data": {
    "published_date": "2023-07-25T04:15:10.633",
    "last_modified": "2024-11-21T08:14:09.810",
    "fix_date": "2023-07-20T16:26:38Z"
  },
  "references": [
    {
      "url": "https://github.com/jgm/pandoc/commit/eddedbfc14916aa06fc01ff04b38aeb30ae2e625",
      "source": "cve@mitre.org",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/jgm/pandoc/compare/3.1.5...3.1.6",
      "source": "cve@mitre.org",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2023/07/msg00029.html",
      "source": "cve@mitre.org",
      "tags": [
        "Mailing List"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/JGRJHU2FTSGTHHRTNDF7STEKLKKA25JN/",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/LYP3FKDS3KAYMQUZVVL73IUI4CWSKLKP/",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/QI6RBP6ZKVC2OOCV6SU2FUHPMAXDDJFU/",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "https://github.com/jgm/pandoc/commit/eddedbfc14916aa06fc01ff04b38aeb30ae2e625",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/jgm/pandoc/compare/3.1.5...3.1.6",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2023/07/msg00029.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/JGRJHU2FTSGTHHRTNDF7STEKLKKA25JN/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/LYP3FKDS3KAYMQUZVVL73IUI4CWSKLKP/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/QI6RBP6ZKVC2OOCV6SU2FUHPMAXDDJFU/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:06:04.267929",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "pandoc",
    "owner": "jgm",
    "created_at": "2010-03-20T20:34:23Z",
    "updated_at": "2025-01-14T19:42:41Z",
    "pushed_at": "2025-01-14T17:28:31Z",
    "size": 64799,
    "stars": 35412,
    "forks": 3419,
    "open_issues": 1116,
    "watchers": 35412,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [],
    "languages": {
      "Haskell": 4233281,
      "Roff": 329670,
      "Rich Text Format": 259644,
      "Lua": 102689,
      "HTML": 56660,
      "Jupyter Notebook": 33428,
      "Typst": 17210,
      "Makefile": 12998,
      "Python": 12819,
      "Shell": 11782,
      "TeX": 5119,
      "Nix": 4132,
      "CSS": 3813,
      "Perl": 3182,
      "Smarty": 2753,
      "Emacs Lisp": 2217
    },
    "commit_activity": {
      "total_commits_last_year": 847,
      "avg_commits_per_week": 16.28846153846154,
      "days_active_last_year": 238
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T19:44:51.647460"
  }
}