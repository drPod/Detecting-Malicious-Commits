{
  "cve_id": "CVE-2023-40027",
  "github_data": {
    "repository": "keystonejs/keystone",
    "fix_commit": "650e27e6e9b42abfb94c340c8470faf61f0ff284",
    "related_commits": [
      "650e27e6e9b42abfb94c340c8470faf61f0ff284",
      "650e27e6e9b42abfb94c340c8470faf61f0ff284"
    ],
    "patch_url": "https://github.com/keystonejs/keystone/commit/650e27e6e9b42abfb94c340c8470faf61f0ff284.patch",
    "fix_commit_details": {
      "sha": "650e27e6e9b42abfb94c340c8470faf61f0ff284",
      "commit_date": "2023-08-15T02:03:06Z",
      "author": {
        "login": "dcousens",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Fix `ui.isAccessAllowed` when `undefined` to prevent access (#8771)",
        "length": 135,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 49,
        "additions": 30,
        "deletions": 19
      },
      "files": [
        {
          "filename": ".changeset/fix-admin-meta-access.md",
          "status": "added",
          "additions": 5,
          "deletions": 0,
          "patch": "@@ -0,0 +1,5 @@\n+---\n+'@keystone-6/core': patch\n+---\n+\n+Fixes `ui.isAccessAllowed` when `undefined`, to prevent access to the `adminMeta` GraphQL query, akin to the behaviour for the default AdminUI `pageMiddleware`"
        },
        {
          "filename": "packages/core/src/admin-ui/system/generateAdminUI.ts",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -7,7 +7,7 @@ import { Entry, walk as _walk } from '@nodelib/fs.walk';\n import type { KeystoneConfig, AdminFileToWrite } from '../../types';\n import { writeAdminFiles } from '../templates';\n import { serializePathForImport } from '../utils/serializePathForImport';\n-import type { AdminMetaRootVal } from './createAdminMeta';\n+import type { AdminMetaRootVal } from '../../lib/create-admin-meta';\n \n const walk = promisify(_walk);\n "
        },
        {
          "filename": "packages/core/src/admin-ui/system/index.ts",
          "status": "modified",
          "additions": 0,
          "deletions": 1,
          "patch": "@@ -1,2 +1 @@\n export { generateAdminUI } from './generateAdminUI';\n-export { KeystoneMeta } from './adminMetaSchema';"
        },
        {
          "filename": "packages/core/src/admin-ui/templates/app.ts",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -12,7 +12,7 @@ import {\n   Kind,\n } from 'graphql';\n import { staticAdminMetaQuery, StaticAdminMetaQuery } from '../admin-meta-graphql';\n-import type { AdminMetaRootVal } from '../system/createAdminMeta';\n+import type { AdminMetaRootVal } from '../../lib/create-admin-meta';\n \n type AppTemplateOptions = { configFileExists: boolean };\n "
        },
        {
          "filename": "packages/core/src/admin-ui/templates/index.ts",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -1,7 +1,7 @@\n import * as Path from 'path';\n import type { GraphQLSchema } from 'graphql';\n import type { KeystoneConfig, AdminFileToWrite } from '../../types';\n-import type { AdminMetaRootVal } from '../system/createAdminMeta';\n+import type { AdminMetaRootVal } from '../../lib/create-admin-meta';\n import { appTemplate } from './app';\n import { homeTemplate } from './home';\n import { listTemplate } from './list';"
        },
        {
          "filename": "packages/core/src/fields/types/relationship/index.ts",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -1,6 +1,6 @@\n import { BaseListTypeInfo, FieldTypeFunc, CommonFieldConfig, fieldType } from '../../../types';\n import { graphql } from '../../..';\n-import { getAdminMetaForRelationshipField } from '../../../admin-ui/system/createAdminMeta';\n+import { getAdminMetaForRelationshipField } from '../../../lib/create-admin-meta';\n \n // This is the default display mode for Relationships\n type SelectDisplayConfig = {"
        },
        {
          "filename": "packages/core/src/lib/admin-meta-resolver.ts",
          "status": "renamed",
          "additions": 12,
          "deletions": 6,
          "patch": "@@ -7,7 +7,7 @@ import type {\n   ListMetaRootVal,\n   AdminMetaRootVal,\n   FieldGroupMeta,\n-} from './createAdminMeta';\n+} from './create-admin-meta';\n \n type Context = KeystoneContext | { isAdminUIBuildProcess: true };\n \n@@ -228,19 +228,25 @@ const adminMeta = graphql.object<AdminMetaRootVal>()({\n   },\n });\n \n+function defaultIsAccessAllowed({ session, sessionStrategy }: KeystoneContext) {\n+  if (!sessionStrategy) return true;\n+  return session !== undefined;\n+}\n+\n export const KeystoneMeta = graphql.object<{ adminMeta: AdminMetaRootVal }>()({\n   name: 'KeystoneMeta',\n   fields: {\n     adminMeta: graphql.field({\n       type: graphql.nonNull(adminMeta),\n       resolve({ adminMeta }, args, context) {\n-        if ('isAdminUIBuildProcess' in context || adminMeta.isAccessAllowed === undefined) {\n+        if ('isAdminUIBuildProcess' in context) {\n           return adminMeta;\n         }\n-        return Promise.resolve(adminMeta.isAccessAllowed(context)).then(isAllowed => {\n-          if (isAllowed) {\n-            return adminMeta;\n-          }\n+\n+        const isAccessAllowed = adminMeta?.isAccessAllowed ?? defaultIsAccessAllowed;\n+        return Promise.resolve(isAccessAllowed(context)).then(isAllowed => {\n+          if (isAllowed) return adminMeta;\n+\n           // TODO: ughhhhhh, we really need to talk about errors.\n           // mostly unrelated to above: error or return null here(+ make field nullable)?s\n           throw new Error('Access denied');"
        },
        {
          "filename": "packages/core/src/lib/create-admin-meta.ts",
          "status": "renamed",
          "additions": 4,
          "deletions": 3,
          "patch": "@@ -8,9 +8,10 @@ import type {\n   JSONValue,\n   MaybeItemFunction,\n } from '../../types';\n-import { humanize } from '../../lib/utils';\n-import type { InitialisedList } from '../../lib/core/initialise-lists';\n-import type { FilterOrderArgs } from '../../types/config/fields';\n+import type { FilterOrderArgs } from '../types/config/fields';\n+\n+import { humanize } from './utils';\n+import type { InitialisedList } from './core/initialise-lists';\n \n type ContextFunction<Return> = (context: KeystoneContext) => MaybePromise<Return>;\n "
        },
        {
          "filename": "packages/core/src/lib/createGraphQLSchema.ts",
          "status": "modified",
          "additions": 3,
          "deletions": 3,
          "patch": "@@ -1,9 +1,9 @@\n import { GraphQLNamedType, GraphQLSchema } from 'graphql';\n \n-import type { KeystoneConfig } from '../types';\n-import { KeystoneMeta } from '../admin-ui/system/adminMetaSchema';\n import { graphql } from '../types/schema';\n-import type { AdminMetaRootVal } from '../admin-ui/system/createAdminMeta';\n+import type { KeystoneConfig } from '../types';\n+import { KeystoneMeta } from './admin-meta-resolver';\n+import type { AdminMetaRootVal } from './create-admin-meta';\n import type { InitialisedList } from './core/initialise-lists';\n \n import { getMutationsForList } from './core/mutations';"
        },
        {
          "filename": "packages/core/src/lib/createSystem.ts",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -2,9 +2,9 @@ import { randomBytes } from 'node:crypto';\n import pLimit from 'p-limit';\n import type { FieldData, KeystoneConfig } from '../types';\n \n-import { createAdminMeta } from '../admin-ui/system/createAdminMeta';\n import type { PrismaModule } from '../artifacts';\n import { allowAll } from '../access';\n+import { createAdminMeta } from './create-admin-meta';\n import { createGraphQLSchema } from './createGraphQLSchema';\n import { createContext } from './context/createContext';\n import { initialiseLists, InitialisedList } from './core/initialise-lists';"
        },
        {
          "filename": "packages/core/src/scripts/dev.ts",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -25,7 +25,7 @@ import {\n import type { KeystoneConfig } from '../types';\n import { initialiseLists } from '../lib/core/initialise-lists';\n import { printPrismaSchema } from '../lib/core/prisma-schema-printer';\n-import type { AdminMetaRootVal } from '../admin-ui/system/createAdminMeta';\n+import type { AdminMetaRootVal } from '../lib/create-admin-meta';\n import { pkgDir } from '../pkg-dir';\n import { ExitError } from './utils';\n import type { Flags } from './cli';"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 6,
        "max_directory_depth": 6
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "f610d86f410d52990c4711ef10eca6a0097a6391",
            "date": "2025-01-13T23:57:39Z",
            "author_login": "renovate[bot]"
          },
          {
            "sha": "b080ac958f09b66024031434ca0b75bb3b4b86c5",
            "date": "2025-01-12T22:12:00Z",
            "author_login": "renovate[bot]"
          },
          {
            "sha": "a554a85a588b958dc571680a4232df768629e375",
            "date": "2025-01-06T03:05:15Z",
            "author_login": "renovate[bot]"
          },
          {
            "sha": "747a497c5d4718d494c36e80937f01b6f733c781",
            "date": "2024-12-30T23:19:17Z",
            "author_login": "renovate[bot]"
          },
          {
            "sha": "56372cb1279dc5c8e7c125e82e23c6ff61250fff",
            "date": "2024-12-30T07:20:26Z",
            "author_login": "renovate[bot]"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 3.7,
    "cvss_vector": "CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:L/I:N/A:N",
    "cwe_id": "CWE-862",
    "description": "Keystone is an open source headless CMS for Node.js \u2014 built with GraphQL and React. When `ui.isAccessAllowed` is set as `undefined`, the `adminMeta` GraphQL query is publicly accessible (no session required). This is different to the behaviour of the default AdminUI middleware, which by default will only be publicly accessible (no session required) if a `session` strategy is not defined. This vulnerability does not affect developers using the `@keystone-6/auth` package, or any users that have written their own `ui.isAccessAllowed` (that is to say, `isAccessAllowed` is not `undefined`). This vulnerability does affect users who believed that their `session` strategy will, by default, enforce that `adminMeta` is inaccessible by the public in accordance with that strategy; akin to the behaviour of the AdminUI middleware. This vulnerability has been patched in `@keystone-6/core` version `5.5.1`. Users are advised to upgrade. Users unable to upgrade may opt to write their own `isAccessAllowed` functionality to work-around this vulnerability.",
    "attack_vector": "NETWORK",
    "attack_complexity": "HIGH"
  },
  "temporal_data": {
    "published_date": "2023-08-15T18:15:10.297",
    "last_modified": "2024-11-21T08:18:33.157",
    "fix_date": "2023-08-15T02:03:06Z"
  },
  "references": [
    {
      "url": "https://github.com/keystonejs/keystone/commit/650e27e6e9b42abfb94c340c8470faf61f0ff284",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/keystonejs/keystone/pull/8771",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/keystonejs/keystone/security/advisories/GHSA-9cvc-v7wm-992c",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/keystonejs/keystone/commit/650e27e6e9b42abfb94c340c8470faf61f0ff284",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/keystonejs/keystone/pull/8771",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/keystonejs/keystone/security/advisories/GHSA-9cvc-v7wm-992c",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:06:06.433654",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "keystone",
    "owner": "keystonejs",
    "created_at": "2018-04-05T10:48:37Z",
    "updated_at": "2025-01-13T23:57:44Z",
    "pushed_at": "2025-01-13T23:57:40Z",
    "size": 377252,
    "stars": 9361,
    "forks": 1172,
    "open_issues": 144,
    "watchers": 9361,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [
      "main"
    ],
    "languages": {
      "TypeScript": 2696347,
      "JavaScript": 25563,
      "HTML": 5172
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-14T13:19:52.767266"
  }
}