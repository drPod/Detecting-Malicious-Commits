{
  "cve_id": "CVE-2023-40177",
  "github_data": {
    "repository": "xwiki/xwiki-platform",
    "fix_commit": "dfb1cde173e363ca5c12eb3654869f9719820262",
    "related_commits": [
      "dfb1cde173e363ca5c12eb3654869f9719820262",
      "dfb1cde173e363ca5c12eb3654869f9719820262"
    ],
    "patch_url": "https://github.com/xwiki/xwiki-platform/commit/dfb1cde173e363ca5c12eb3654869f9719820262.patch",
    "fix_commit_details": {
      "sha": "dfb1cde173e363ca5c12eb3654869f9719820262",
      "commit_date": "2023-02-15T10:44:00Z",
      "author": {
        "login": "mflorea",
        "type": "User",
        "stats": {
          "total_commits": 5187,
          "average_weekly_commits": 5.437106918238993,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 692
        }
      },
      "commit_message": {
        "title": "XWIKI-19906: Render the AppWithinMinutes Content field as its author",
        "length": 68,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 56,
        "additions": 41,
        "deletions": 15
      },
      "files": [
        {
          "filename": "xwiki-platform-core/xwiki-platform-appwithinminutes/xwiki-platform-appwithinminutes-test/xwiki-platform-appwithinminutes-test-docker/src/test/it/org/xwiki/appwithinminutes/test/ui/DocumentFieldsIT.java",
          "status": "modified",
          "additions": 34,
          "deletions": 11,
          "patch": "@@ -23,6 +23,7 @@\n \n import org.apache.commons.lang3.RandomStringUtils;\n import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Order;\n import org.junit.jupiter.api.Test;\n import org.xwiki.appwithinminutes.test.po.ApplicationClassEditPage;\n import org.xwiki.appwithinminutes.test.po.ApplicationCreatePage;\n@@ -51,14 +52,15 @@\n  * @since 13.10RC1\n  */\n @UITest(properties = {\n-    // Exclude the AppWithinMinutes.ClassEditSheet and AppWithinMinutes.DynamicMessageTool from the PR checker since \n+    // Exclude the AppWithinMinutes.ClassEditSheet and AppWithinMinutes.DynamicMessageTool from the PR checker since\n     // they use the groovy macro which requires PR rights.\n     // TODO: Should be removed once XWIKI-20529 is closed.\n     // Exclude AppWithinMinutes.LiveTableEditSheet because it calls com.xpn.xwiki.api.Document.saveWithProgrammingRights\n-    \"xwikiPropertiesAdditionalProperties=test.prchecker.excludePattern=.*:AppWithinMinutes\\\\.(ClassEditSheet|DynamicMessageTool|LiveTableEditSheet)\"\n-})\n+    \"xwikiPropertiesAdditionalProperties=test.prchecker.excludePattern=.*:AppWithinMinutes\\\\.(ClassEditSheet|DynamicMessageTool|LiveTableEditSheet)\"})\n class DocumentFieldsIT\n {\n+    private String appName = RandomStringUtils.randomAlphabetic(6);\n+\n     @BeforeAll\n     static void beforeAll(TestUtils setup)\n     {\n@@ -73,14 +75,12 @@ static void beforeAll(TestUtils setup)\n     }\n \n     @Test\n+    @Order(1)\n     void titleAndContent(TestUtils setup)\n     {\n-        setup.loginAsAdmin();\n-\n         // Create a new application.\n-        String appName = RandomStringUtils.randomAlphabetic(6);\n         ApplicationCreatePage appCreatePage = ApplicationCreatePage.gotoPage();\n-        appCreatePage.setApplicationName(appName);\n+        appCreatePage.setApplicationName(this.appName);\n         ApplicationClassEditPage classEditPage = appCreatePage.clickNextStep();\n \n         // Add a standard field.\n@@ -126,30 +126,53 @@ void titleAndContent(TestUtils setup)\n         assertTrue(entryViewPage.getContent().contains(\"Bar\"));\n \n         // Verify that we can edit the document fields in-place.\n-        String propertyReference = String.format(\"%s.Code.%1$sClass[0].title1\", appName);\n+        String propertyReference = String.format(\"%s.Code.%1$sClass[0].title1\", this.appName);\n         EditablePropertyPane<String> titleProperty = new EditablePropertyPane<>(propertyReference);\n         assertEquals(\"Foo\", titleProperty.clickEdit().getValue());\n         titleProperty.setValue(\"Book\").clickSave();\n         assertEquals(\"Book\", titleProperty.getDisplayValue());\n \n         // Check the entries live table.\n-        entryViewPage.clickBreadcrumbLink(appName);\n+        entryViewPage.clickBreadcrumbLink(this.appName);\n         LiveTableElement liveTable = new ApplicationHomePage().getEntriesLiveTable();\n         liveTable.waitUntilReady();\n         assertEquals(1, liveTable.getRowCount());\n         assertTrue(liveTable.hasRow(\"My Title\", \"Book\"));\n         assertTrue(liveTable.hasRow(\"My Content\", \"Bar\"));\n \n         // Check that the title and the content of the class have not been changed.\n-        setup.gotoPage(new LocalDocumentReference(Arrays.asList(appName, \"Code\"), appName + \"Class\"), \"edit\",\n+        setup.gotoPage(new LocalDocumentReference(Arrays.asList(this.appName, \"Code\"), this.appName + \"Class\"), \"edit\",\n             \"editor=wiki\");\n         WikiEditPage editPage = new WikiEditPage();\n-        assertEquals(appName + \" Class\", editPage.getTitle());\n+        assertEquals(this.appName + \" Class\", editPage.getTitle());\n         assertEquals(\"\", editPage.getContent());\n \n         // Now edit the class and check if the default values for title and content are taken from the template.\n         editPage.edit();\n         assertEquals(defaultTitle, new ClassFieldEditPane(\"title1\").getDefaultValue());\n         assertEquals(defaultContent, new ClassFieldEditPane(\"content1\").getDefaultValue());\n     }\n+\n+    @Test\n+    @Order(2)\n+    void contentFromSimpleUser(TestUtils setup)\n+    {\n+        // Create an application entry with a simple user that doesn't have script rights.\n+        setup.createUserAndLogin(\"Alice\", \"pass\");\n+\n+        ApplicationHomePage appHomePage = ApplicationHomePage.gotoPage(this.appName);\n+        appHomePage.getEntriesLiveTable().waitUntilReady();\n+\n+        EntryNamePane entryNamePage = appHomePage.clickAddNewEntry();\n+        entryNamePage.setName(\"ByAlice\");\n+\n+        EntryEditPage entryEditPage = entryNamePage.clickAdd();\n+        entryEditPage.setTitle(\"Title by $services.localization.render('Alice')\");\n+        entryEditPage.setContent(\"Content by {{velocity}}$services.localization.render('Alice'){{/velocity}}\");\n+\n+        ViewPage entryViewPage = entryEditPage.clickSaveAndView();\n+        assertEquals(\"Title by $services.localization.render('Alice')\", entryViewPage.getDocumentTitle());\n+        assertTrue(entryViewPage.getContent().contains(\"Content by\"));\n+        assertTrue(entryViewPage.getContent().contains(\"The execution of the [velocity] script macro is not allowed\"));\n+    }\n }"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-appwithinminutes/xwiki-platform-appwithinminutes-ui/src/main/resources/AppWithinMinutes/Content.xml",
          "status": "modified",
          "additions": 7,
          "deletions": 4,
          "patch": "@@ -20,7 +20,7 @@\n  * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n -->\n \n-<xwikidoc version=\"1.2\" reference=\"AppWithinMinutes.Content\" locale=\"\">\n+<xwikidoc version=\"1.5\" reference=\"AppWithinMinutes.Content\" locale=\"\">\n   <web>AppWithinMinutes</web>\n   <name>Content</name>\n   <language/>\n@@ -76,9 +76,12 @@\n   #end\n   {{/html}}\n #elseif (\"$!type\" != '')\n-  ## Include the content of the current document.\n-  ## Escape {{ in the rendered content to be sure that the HTML macro is not closed unintentionally.\n-  {{html}}$tdoc.getRenderedContent($tdoc.content, $tdoc.syntax.toIdString()).replace('{{', '&amp;amp;#123;&amp;amp;#123;'){{/html}}\n+  ## Display the content of the current document without using any sheet. We can't use the include macro here (with the\n+  ## author parameter) because the content may have unsaved changes (e.g. on preview action). We make sure that the HTML\n+  ## macro is not closed unintentionally, even though the XHTML printer protects us against this, just to be extra safe.\n+  {{html}}$services.display.content($tdoc, {\n+    'displayerHint': 'default'\n+  }).replace('{{/html}}', '&amp;amp;#123;&amp;amp;#123;/html&amp;amp;#125;&amp;amp;#125;'){{/html}}\n #else\n   The display mode is not specified!\n #end"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 2,
        "max_directory_depth": 12
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "88e3e7d23cbd3e6ed059dbcd6532f94016d42678",
            "date": "2025-01-13T16:58:06Z",
            "author_login": "Sereza7"
          },
          {
            "sha": "9b506ab2bed52744b52699ea05cde15986d42abb",
            "date": "2025-01-13T16:36:24Z",
            "author_login": "mflorea"
          },
          {
            "sha": "d53d6e347b97ac20f60e21fb2bae381f4aaf10f4",
            "date": "2025-01-13T13:25:24Z",
            "author_login": "tmortagne"
          },
          {
            "sha": "d85bd8f9c67c412e0cfb45fb4695b8d4e759bab6",
            "date": "2025-01-13T12:03:22Z",
            "author_login": "tmortagne"
          },
          {
            "sha": "6f210dabc99167cf9f020a048c88325eca34ceea",
            "date": "2025-01-13T08:54:32Z",
            "author_login": "tmortagne"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 9.9,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:L",
    "cwe_id": "CWE-95",
    "description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. Any registered user can use the content field of their user profile page to execute arbitrary scripts with programming rights, thus effectively performing rights escalation. This issue is present since version 4.3M2 when AppWithinMinutes Application added support for the Content field, allowing any wiki page (including the user profile page) to use its content as an AWM Content field, which has a custom displayer that executes the content with the rights of the ``AppWithinMinutes.Content`` author, rather than the rights of the content author. The vulnerability has been fixed in XWiki 14.10.5 and 15.1RC1. The fix is in the content of the AppWithinMinutes.Content page that defines the custom displayer. By using the ``display`` script service to render the content we make sure that the proper author is used for access rights checks.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-08-23T21:15:08.670",
    "last_modified": "2024-11-21T08:18:56.180",
    "fix_date": "2023-02-15T10:44:00Z"
  },
  "references": [
    {
      "url": "https://github.com/xwiki/xwiki-platform/commit/dfb1cde173e363ca5c12eb3654869f9719820262",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/security/advisories/GHSA-5mf8-v43w-mfxp",
      "source": "security-advisories@github.com",
      "tags": [
        "Mitigation",
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://jira.xwiki.org/browse/XWIKI-7369",
      "source": "security-advisories@github.com",
      "tags": [
        "Issue Tracking",
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/commit/dfb1cde173e363ca5c12eb3654869f9719820262",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/security/advisories/GHSA-5mf8-v43w-mfxp",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mitigation",
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://jira.xwiki.org/browse/XWIKI-7369",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Issue Tracking",
        "Patch",
        "Vendor Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:06:06.465599",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "xwiki-platform",
    "owner": "xwiki",
    "created_at": "2011-03-10T13:26:41Z",
    "updated_at": "2025-01-13T16:58:10Z",
    "pushed_at": "2025-01-14T12:32:03Z",
    "size": 561595,
    "stars": 1030,
    "forks": 554,
    "open_issues": 136,
    "watchers": 1030,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "Java": 34276921,
      "JavaScript": 2392892,
      "HTML": 388086,
      "Less": 318945,
      "AspectJ": 280487,
      "Vue": 222987,
      "CSS": 115460,
      "XSLT": 109285,
      "Clean": 44054,
      "Shell": 32569,
      "Batchfile": 14604,
      "Python": 5046,
      "Groovy": 3012,
      "AMPL": 1296
    },
    "commit_activity": {
      "total_commits_last_year": 1723,
      "avg_commits_per_week": 33.13461538461539,
      "days_active_last_year": 263
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "lgpl-2.1"
    },
    "collected_at": "2025-01-14T12:58:58.685838"
  }
}