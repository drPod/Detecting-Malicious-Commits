{
  "cve_id": "CVE-2023-41034",
  "github_data": {
    "repository": "eclipse-leshan/leshan",
    "fix_commit": "29577d2879ba8e7674c3b216a7f01193fc7ae013",
    "related_commits": [
      "29577d2879ba8e7674c3b216a7f01193fc7ae013",
      "4d3e63ac271a817f81fba3e3229c519af7a3049c",
      "29577d2879ba8e7674c3b216a7f01193fc7ae013",
      "4d3e63ac271a817f81fba3e3229c519af7a3049c"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "29577d2879ba8e7674c3b216a7f01193fc7ae013",
      "commit_date": "2023-08-18T14:47:58Z",
      "author": {
        "login": "sbernard31",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Make DDFFileParser and DefaultDDFFileValidator safer.",
        "length": 53,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 59,
        "additions": 56,
        "deletions": 3
      },
      "files": [
        {
          "filename": "leshan-core/src/main/java/org/eclipse/leshan/core/model/DDFFileParser.java",
          "status": "modified",
          "additions": 30,
          "deletions": 2,
          "patch": "@@ -24,6 +24,7 @@\n import java.util.List;\n import java.util.Map;\n \n+import javax.xml.XMLConstants;\n import javax.xml.parsers.DocumentBuilder;\n import javax.xml.parsers.DocumentBuilderFactory;\n import javax.xml.parsers.ParserConfigurationException;\n@@ -75,12 +76,39 @@ public DDFFileParser(DDFFileValidatorFactory ddfFileValidatorFactory) {\n     }\n \n     private DDFFileParser(DDFFileValidator ddfValidator, DDFFileValidatorFactory ddfFileValidatorFactory) {\n-        factory = DocumentBuilderFactory.newInstance();\n-        factory.setNamespaceAware(true);\n+        this.factory = createDocumentBuilderFactory();\n         this.ddfValidator = ddfValidator;\n         this.ddfValidatorFactory = ddfFileValidatorFactory;\n     }\n \n+    protected DocumentBuilderFactory createDocumentBuilderFactory() {\n+        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n+        try {\n+            // Create Safe DocumentBuilderFactory (not vulnerable to XXE Attacks)\n+            // -----------------------------------------------------------------\n+            // There is several recommendation from different source we try to apply all, even if some are maybe\n+            // redundant.\n+\n+            // from :\n+            // https://semgrep.dev/docs/cheat-sheets/java-xxe/\n+            factory.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true);\n+\n+            // from :\n+            // https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html#jaxp-documentbuilderfactory-saxparserfactory-and-dom4j\n+            factory.setFeature(\"http://apache.org/xml/features/disallow-doctype-decl\", true); // Disable DTDs\n+            factory.setXIncludeAware(false); // Disable XML Inclusions\n+\n+            // from :\n+            // https://community.veracode.com/s/article/Java-Remediation-Guidance-for-XXE\n+            factory.setExpandEntityReferences(false); // disable expand entity reference nodes\n+\n+        } catch (ParserConfigurationException e) {\n+            throw new IllegalStateException(\"Unable to create DocumentBuilderFactory\", e);\n+        }\n+        factory.setNamespaceAware(true);\n+        return factory;\n+    }\n+\n     /**\n      * Parse a DDF file.\n      *"
        },
        {
          "filename": "leshan-core/src/main/java/org/eclipse/leshan/core/model/DefaultDDFFileValidator.java",
          "status": "modified",
          "additions": 26,
          "deletions": 1,
          "patch": "@@ -30,6 +30,8 @@\n import org.eclipse.leshan.core.util.Validate;\n import org.w3c.dom.Node;\n import org.xml.sax.SAXException;\n+import org.xml.sax.SAXNotRecognizedException;\n+import org.xml.sax.SAXNotSupportedException;\n \n /**\n  * A DDF File Validator.\n@@ -95,7 +97,30 @@ public void validate(Source xmlToValidate) throws SAXException, IOException {\n     protected Schema getEmbeddedLwM2mSchema() throws SAXException {\n         InputStream inputStream = DDFFileValidator.class.getResourceAsStream(schema);\n         Source source = new StreamSource(inputStream);\n-        SchemaFactory schemaFactory = SchemaFactory.newInstance(XMLConstants.W3C_XML_SCHEMA_NS_URI);\n+        SchemaFactory schemaFactory = createSchemaFactory();\n         return schemaFactory.newSchema(source);\n     }\n+\n+    protected SchemaFactory createSchemaFactory() {\n+        SchemaFactory factory = SchemaFactory.newInstance(XMLConstants.W3C_XML_SCHEMA_NS_URI);\n+        try {\n+            // Create Safe SchemaFactory (not vulnerable to XXE Attacks)\n+            // --------------------------------------------------------\n+            // There is several recommendation from different source we try to apply all, even if some are maybe\n+            // redundant.\n+\n+            // from :\n+            // https://semgrep.dev/docs/cheat-sheets/java-xxe/\n+            factory.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true);\n+\n+            // from :\n+            // https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html#schemafactory\n+            factory.setProperty(XMLConstants.ACCESS_EXTERNAL_DTD, \"\");\n+            factory.setProperty(XMLConstants.ACCESS_EXTERNAL_SCHEMA, \"\");\n+\n+        } catch (SAXNotRecognizedException | SAXNotSupportedException e) {\n+            throw new IllegalStateException(\"Unable to create SchemaFactory\", e);\n+        }\n+        return factory;\n+    }\n }"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 1,
        "max_directory_depth": 9
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "9fc2e3c2fe6675ad9c7b8d77862526073ee3b581",
            "date": "2025-01-22T15:21:06Z",
            "author_login": "JaroslawLegierski"
          },
          {
            "sha": "c923e358fa395342f7adf086907ca33995089852",
            "date": "2025-01-15T14:55:44Z",
            "author_login": "JaroslawLegierski"
          },
          {
            "sha": "62b1de9593c87a0aabbd9a85d25b8ff5f20fed9f",
            "date": "2025-01-17T15:29:12Z",
            "author_login": "sbernard31"
          },
          {
            "sha": "f173b80dad48991be6918b26290f24643c796d6f",
            "date": "2025-01-17T13:57:39Z",
            "author_login": "sbernard31"
          },
          {
            "sha": "7aeac15055b6612c4b3bc78a1f3f5c782dd9e8a4",
            "date": "2025-01-14T14:44:07Z",
            "author_login": "sbernard31"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.5,
    "cvss_vector": "CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:L/A:N",
    "cwe_id": "CWE-611",
    "description": "Eclipse Leshan is a device management server and client Java implementation. In affected versions DDFFileParser` and `DefaultDDFFileValidator` (and so `ObjectLoader`) are vulnerable to `XXE Attacks`. A DDF file is a LWM2M format used to store LWM2M object description. Leshan users are impacted only if they parse untrusted DDF files (e.g. if they let external users provide their own model), in that case they MUST upgrade to fixed version. If you parse only trusted DDF file and validate only with trusted xml schema, upgrading is not mandatory.  This issue has been fixed in versions 1.5.0 and 2.0.0-M13. Users are advised to upgrade. There are no known workarounds for this vulnerability.",
    "attack_vector": "NETWORK",
    "attack_complexity": "HIGH"
  },
  "temporal_data": {
    "published_date": "2023-08-31T18:15:09.020",
    "last_modified": "2024-11-21T08:20:25.577",
    "fix_date": "2023-08-18T14:47:58Z"
  },
  "references": [
    {
      "url": "https://github.com/eclipse-leshan/leshan/commit/29577d2879ba8e7674c3b216a7f01193fc7ae013",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/eclipse-leshan/leshan/commit/4d3e63ac271a817f81fba3e3229c519af7a3049c",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/eclipse-leshan/leshan/security/advisories/GHSA-wc9j-gc65-3cm7",
      "source": "security-advisories@github.com",
      "tags": [
        "Mitigation",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/eclipse-leshan/leshan/wiki/Adding-new-objects#the-lwm2m-model",
      "source": "security-advisories@github.com",
      "tags": [
        "Product"
      ]
    },
    {
      "url": "https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing",
      "source": "security-advisories@github.com",
      "tags": [
        "Not Applicable"
      ]
    },
    {
      "url": "https://github.com/eclipse-leshan/leshan/commit/29577d2879ba8e7674c3b216a7f01193fc7ae013",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/eclipse-leshan/leshan/commit/4d3e63ac271a817f81fba3e3229c519af7a3049c",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/eclipse-leshan/leshan/security/advisories/GHSA-wc9j-gc65-3cm7",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mitigation",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/eclipse-leshan/leshan/wiki/Adding-new-objects#the-lwm2m-model",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Product"
      ]
    },
    {
      "url": "https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Not Applicable"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:06:06.494514",
    "processing_status": "enhanced"
  },
  "repository_context": {
    "name": "leshan",
    "owner": "eclipse-leshan",
    "created_at": "2015-02-06T15:44:24Z",
    "updated_at": "2025-01-24T17:33:58Z",
    "pushed_at": "2025-01-24T17:22:44Z",
    "size": 13429,
    "stars": 656,
    "forks": 408,
    "open_issues": 83,
    "watchers": 656,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "Java": 5067255,
      "Vue": 236518,
      "JavaScript": 56127,
      "Shell": 17447,
      "HTML": 14353
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "bsd-3-clause"
    },
    "collected_at": "2025-01-26T08:19:10.181108"
  }
}