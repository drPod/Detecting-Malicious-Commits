{
  "cve_id": "CVE-2023-41879",
  "github_data": {
    "repository": "OpenMage/magento-lts",
    "fix_commit": "2a2a2fb504247e8966f8ffc2e17d614be5d43128",
    "related_commits": [
      "2a2a2fb504247e8966f8ffc2e17d614be5d43128",
      "31e74ac5d670b10001f88f038046b62367f15877",
      "2a2a2fb504247e8966f8ffc2e17d614be5d43128",
      "31e74ac5d670b10001f88f038046b62367f15877"
    ],
    "patch_url": "https://github.com/OpenMage/magento-lts/commit/2a2a2fb504247e8966f8ffc2e17d614be5d43128.patch",
    "fix_commit_details": {
      "sha": "2a2a2fb504247e8966f8ffc2e17d614be5d43128",
      "commit_date": "2023-08-29T15:35:03Z",
      "author": {
        "login": "colinmollenhour",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Merge pull request from GHSA-9358-cpvx-c2qp",
        "length": 108,
        "has_description": true,
        "references_issue": false
      },
      "stats": {
        "total": 111,
        "additions": 73,
        "deletions": 38
      },
      "files": [
        {
          "filename": "app/code/core/Mage/Core/Helper/Data.php",
          "status": "modified",
          "additions": 35,
          "deletions": 0,
          "patch": "@@ -1000,4 +1000,39 @@ public function unEscapeCSVData($data)\n         }\n         return $data;\n     }\n+\n+    /**\n+     * @param bool $setErrorMessage Adds a predefined error message to the 'core/session' object\n+     * @return bool\n+     */\n+    public function isRateLimitExceeded($setErrorMessage = true, $recordRateLimitHit = true): bool\n+    {\n+        $active = Mage::getStoreConfigFlag('system/rate_limit/active');\n+        if ($active && $remoteAddr = Mage::helper('core/http')->getRemoteAddr()) {\n+            $cacheTag = 'rate_limit_' . $remoteAddr;\n+            if (Mage::app()->testCache($cacheTag)) {\n+                $errorMessage = \"Too Soon: You are trying to perform this operation too frequently. Please wait a few seconds and try again.\";\n+                Mage::getSingleton('core/session')->addError($this->__($errorMessage));\n+                return true;\n+            }\n+\n+            if ($recordRateLimitHit) {\n+                $this->recordRateLimitHit();\n+            }\n+        }\n+\n+        return false;\n+    }\n+\n+    /**\n+     * @return void\n+     */\n+    public function recordRateLimitHit(): void\n+    {\n+        $active = Mage::getStoreConfigFlag('system/rate_limit/active');\n+        if ($active && $remoteAddr = Mage::helper('core/http')->getRemoteAddr()) {\n+            $cacheTag = 'rate_limit_' . $remoteAddr;\n+            Mage::app()->saveCache(1, $cacheTag, ['brute_force'], Mage::getStoreConfig('system/rate_limit/timeframe'));\n+        }\n+    }\n }"
        },
        {
          "filename": "app/code/core/Mage/Core/etc/config.xml",
          "status": "modified",
          "additions": 4,
          "deletions": 0,
          "patch": "@@ -315,6 +315,10 @@\n             <csrf>\n                 <use_form_key>1</use_form_key>\n             </csrf>\n+            <rate_limit>\n+                <active>1</active>\n+                <timeframe>30</timeframe>\n+            </rate_limit>\n             <cache>\n                 <flush_cron_expr>30 2 * * *</flush_cron_expr>\n             </cache>"
        },
        {
          "filename": "app/code/core/Mage/Core/etc/system.xml",
          "status": "modified",
          "additions": 27,
          "deletions": 36,
          "patch": "@@ -50,6 +50,33 @@\n                         </use_form_key>\n                     </fields>\n                 </csrf>\n+                <rate_limit translate=\"label comment\" module=\"core\">\n+                    <label>Rate limit</label>\n+                    <sort_order>10</sort_order>\n+                    <show_in_default>1</show_in_default>\n+                    <show_in_website>1</show_in_website>\n+                    <show_in_store>1</show_in_store>\n+                    <comment>This functionality limits the number of requests a user (identified by IP address) can perform within a specific time frame, preventing excessive resources usage and maintaining system performance, stability and security.</comment>\n+                    <fields>\n+                        <active translate=\"label\">\n+                            <label>Enabled</label>\n+                            <frontend_type>select</frontend_type>\n+                            <source_model>adminhtml/system_config_source_yesno</source_model>\n+                            <sort_order>10</sort_order>\n+                            <show_in_default>1</show_in_default>\n+                            <show_in_website>1</show_in_website>\n+                            <show_in_store>1</show_in_store>\n+                        </active>\n+                        <timeframe translate=\"label comment\">\n+                            <label>Timeframe</label>\n+                            <sort_order>20</sort_order>\n+                            <show_in_default>1</show_in_default>\n+                            <show_in_website>1</show_in_website>\n+                            <show_in_store>1</show_in_store>\n+                            <comment>Number of seconds between each allowed request.</comment>\n+                        </timeframe>\n+                    </fields>\n+                </rate_limit>\n                 <cache translate=\"label\" module=\"core\">\n                     <label>Advanced Cache Settings</label>\n                     <sort_order>1000</sort_order>\n@@ -69,13 +96,6 @@\n                 </cache>\n             </groups>\n         </system>\n-        <!--<web_track translate=\"label\" module=\"core\">\n-            <label>Web Tracking</label>\n-            <sort_order>180</sort_order>\n-            <show_in_default>1</show_in_default>\n-            <show_in_website>1</show_in_website>\n-            <show_in_store>1</show_in_store>\n-        </web_track>-->\n         <advanced translate=\"label\" module=\"core\">\n             <label>Advanced</label>\n             <tab>advanced</tab>\n@@ -84,35 +104,6 @@\n             <show_in_website>1</show_in_website>\n             <show_in_store>1</show_in_store>\n             <groups>\n-                <!--datashare translate=\"label\">\n-                    <label>Datasharing</label>\n-                    <sort_order>1</sort_order>\n-                    <show_in_default>1</show_in_default>\n-                    <show_in_website>1</show_in_website>\n-                    <show_in_store>0</show_in_store>\n-                    <fields>\n-                        <default translate=\"label\">\n-                            <label>Default</label>\n-                            <frontend_type>multiselect</frontend_type>\n-                            <backend_model>adminhtml/system_config_backend_datashare</backend_model>\n-                            <source_model>adminhtml/system_config_source_store</source_model>\n-                            <sort_order>1</sort_order>\n-                            <show_in_default>1</show_in_default>\n-                            <show_in_website>1</show_in_website>\n-                            <show_in_store>1</show_in_store>\n-                        </default>\n-                        <default translate=\"label\">\n-                            <label>Default</label>\n-                            <frontend_type>multiselect</frontend_type>\n-                            <backend_model>adminhtml/system_config_backend_datashare</backend_model>\n-                            <source_model>adminhtml/system_config_source_store</source_model>\n-                            <sort_order>1</sort_order>\n-                            <show_in_default>1</show_in_default>\n-                            <show_in_website>1</show_in_website>\n-                            <show_in_store>1</show_in_store>\n-                        </default>\n-                    </fields>\n-                </datashare-->\n                 <modules_disable_output translate=\"label\">\n                     <label>Disable Modules Output</label>\n                     <frontend_model>adminhtml/system_config_form_fieldset_modules_disableOutput</frontend_model>"
        },
        {
          "filename": "app/code/core/Mage/Sales/Helper/Guest.php",
          "status": "modified",
          "additions": 5,
          "deletions": 1,
          "patch": "@@ -105,6 +105,7 @@ public function loadValidOrder()\n                     $errors = true;\n                 }\n             } else {\n+                Mage::helper('core')->recordRateLimitHit();\n                 $errors = true;\n             }\n         }\n@@ -114,7 +115,10 @@ public function loadValidOrder()\n             return true;\n         }\n \n-        Mage::getSingleton('core/session')->addError($this->__($errorMessage));\n+        if (!Mage::helper('core')->isRateLimitExceeded(true, false)) {\n+            Mage::getSingleton('core/session')->addError($this->__($errorMessage));\n+        }\n+\n         Mage::app()->getResponse()->setRedirect(Mage::getUrl('sales/guest/form'));\n         return false;\n     }"
        },
        {
          "filename": "app/code/core/Mage/Sales/Model/Order.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -2372,7 +2372,7 @@ protected function _beforeSave()\n         }\n \n         if (!$this->getId()) {\n-            $this->setData('protect_code', substr(md5(uniqid(mt_rand(), true) . ':' . microtime(true)), 5, 6));\n+            $this->setData('protect_code', Mage::helper('core')->getRandomString(16));\n         }\n \n         if ($this->getStatus() !== $this->getOrigData('status')) {"
        },
        {
          "filename": "app/locale/en_US/Mage_Core.csv",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -384,6 +384,7 @@\n \"Timezone\",\"Timezone\"\n \"Title Prefix\",\"Title Prefix\"\n \"Title Suffix\",\"Title Suffix\"\n+\"Too Soon: You are trying to perform this operation too frequently. Please wait a few seconds and try again.\",\"Too Soon: You are trying to perform this operation too frequently. Please wait a few seconds and try again.\"\n \"Transactional Emails\",\"Transactional Emails\"\n \"Translate Inline\",\"Translate Inline\"\n \"Translate, blocks and other output caches should be disabled for both frontend and admin inline translations.\",\"Translate, blocks and other output caches should be disabled for both frontend and admin inline translations.\""
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 1,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 5,
        "max_directory_depth": 6
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "1dabe2dd07232f4e08a23de898d8b0f845df6a21",
            "date": "2025-01-14T16:39:56Z",
            "author_login": "allcontributors[bot]"
          },
          {
            "sha": "29ae988e30dcaf33b9348a9128710ad2ac6b68d6",
            "date": "2025-01-14T15:35:41Z",
            "author_login": "sreichel"
          },
          {
            "sha": "d1d63586e3d0de327858d4ce122481bb0ffe2b75",
            "date": "2025-01-14T15:35:08Z",
            "author_login": "sreichel"
          },
          {
            "sha": "360b6f546a561e53168880015f8c3c9a12242e4d",
            "date": "2025-01-14T15:34:10Z",
            "author_login": "sreichel"
          },
          {
            "sha": "4e2711135c6bba674a7ae14c8a063f2290580c16",
            "date": "2025-01-14T15:32:57Z",
            "author_login": "sreichel"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 7.5,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N",
    "cwe_id": "CWE-330",
    "description": "Magento LTS is the official OpenMage LTS codebase. Guest orders may be viewed without authentication using a \"guest-view\" cookie which contains the order's \"protect_code\". This code is 6 hexadecimal characters which is arguably not enough to prevent a brute-force attack. Exposing each order would require a separate brute force attack. This issue has been patched in versions 19.5.1 and 20.1.1.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-09-11T22:15:08.267",
    "last_modified": "2024-11-21T08:21:50.350",
    "fix_date": "2023-08-29T15:35:03Z"
  },
  "references": [
    {
      "url": "https://github.com/OpenMage/magento-lts/commit/2a2a2fb504247e8966f8ffc2e17d614be5d43128",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/OpenMage/magento-lts/commit/31e74ac5d670b10001f88f038046b62367f15877",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/OpenMage/magento-lts/releases/tag/v19.5.1",
      "source": "security-advisories@github.com",
      "tags": [
        "Release Notes"
      ]
    },
    {
      "url": "https://github.com/OpenMage/magento-lts/releases/tag/v20.1.1",
      "source": "security-advisories@github.com",
      "tags": [
        "Release Notes"
      ]
    },
    {
      "url": "https://github.com/OpenMage/magento-lts/security/advisories/GHSA-9358-cpvx-c2qp",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/OpenMage/magento-lts/commit/2a2a2fb504247e8966f8ffc2e17d614be5d43128",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/OpenMage/magento-lts/commit/31e74ac5d670b10001f88f038046b62367f15877",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/OpenMage/magento-lts/releases/tag/v19.5.1",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes"
      ]
    },
    {
      "url": "https://github.com/OpenMage/magento-lts/releases/tag/v20.1.1",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes"
      ]
    },
    {
      "url": "https://github.com/OpenMage/magento-lts/security/advisories/GHSA-9358-cpvx-c2qp",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:06:08.401400",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "magento-lts",
    "owner": "OpenMage",
    "created_at": "2014-10-17T14:23:00Z",
    "updated_at": "2025-01-14T07:25:14Z",
    "pushed_at": "2025-01-14T07:25:10Z",
    "size": 135363,
    "stars": 875,
    "forks": 436,
    "open_issues": 207,
    "watchers": 875,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [
      "main",
      "next",
      "v19"
    ],
    "languages": {
      "PHP": 26801624,
      "HTML": 4073323,
      "JavaScript": 957533,
      "CSS": 494354,
      "SCSS": 346314,
      "Shell": 15885,
      "Ruby": 288
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "osl-3.0"
    },
    "collected_at": "2025-01-14T14:10:18.125518"
  }
}