{
  "cve_id": "CVE-2023-41892",
  "github_data": {
    "repository": "craftcms/cms",
    "fix_commit": "7359d18d46389ffac86c2af1e0cd59e37c298857",
    "related_commits": [
      "7359d18d46389ffac86c2af1e0cd59e37c298857",
      "a270b928f3d34ad3bd953b81c304424edd57355e",
      "c0a37e15cc925c473e60e27fe64054993b867ac1",
      "c0a37e15cc925c473e60e27fe64054993b867ac1",
      "7359d18d46389ffac86c2af1e0cd59e37c298857",
      "a270b928f3d34ad3bd953b81c304424edd57355e",
      "c0a37e15cc925c473e60e27fe64054993b867ac1",
      "c0a37e15cc925c473e60e27fe64054993b867ac1"
    ],
    "patch_url": "https://github.com/craftcms/cms/commit/7359d18d46389ffac86c2af1e0cd59e37c298857.patch",
    "fix_commit_details": {
      "sha": "7359d18d46389ffac86c2af1e0cd59e37c298857",
      "commit_date": "2023-06-27T23:35:52Z",
      "author": {
        "login": "brandonkelly",
        "type": "User",
        "stats": {
          "total_commits": 33712,
          "average_weekly_commits": 46.692520775623265,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 657
        }
      },
      "commit_message": {
        "title": "Fixed an RCE vulnerability",
        "length": 26,
        "has_description": false,
        "references_issue": true
      },
      "stats": {
        "total": 53,
        "additions": 52,
        "deletions": 1
      },
      "files": [
        {
          "filename": "CHANGELOG.md",
          "status": "modified",
          "additions": 2,
          "deletions": 0,
          "patch": "@@ -6,8 +6,10 @@\n - The `up`, `migrate/up`, and `migrate/all` commands now revert any project config changes created by migrations on failure.\n - The `up`, `migrate/up`, and `migrate/all` commands now prompt to restore the backup created at the outset of the command, or recommend restoring a backup, on failure.\n - Added `craft\\console\\controllers\\BackupTrait::restore()`.\n+- Added `craft\\helpers\\Component::cleanseConfig()`.\n - Fixed a bug where Single entries weren\u2019t getting preloaded for template macros, if the template body wasn\u2018t rendered. ([#13312](https://github.com/craftcms/cms/issues/13312))\n - Fixed a bug where asset folders could get dynamically created for elements with temporary slugs. ([#13311](https://github.com/craftcms/cms/issues/13311))\n+- Fixed an RCE vulnerability.\n \n ## 4.4.14 - 2023-06-13\n "
        },
        {
          "filename": "src/controllers/ConditionsController.php",
          "status": "modified",
          "additions": 2,
          "deletions": 1,
          "patch": "@@ -11,6 +11,7 @@\n use craft\\base\\conditions\\ConditionInterface;\n use craft\\base\\conditions\\ConditionRuleInterface;\n use craft\\helpers\\ArrayHelper;\n+use craft\\helpers\\Component;\n use craft\\helpers\\Json;\n use craft\\web\\Controller;\n use Illuminate\\Support\\Collection;\n@@ -41,7 +42,7 @@ public function beforeAction($action): bool\n         $this->requireCpRequest();\n \n         $baseConfig = Json::decodeIfJson($this->request->getBodyParam('config'));\n-        $config = $this->request->getBodyParam($baseConfig['name']);\n+        $config = Component::cleanseConfig($this->request->getBodyParam($baseConfig['name']));\n         $newRuleType = ArrayHelper::remove($config, 'new-rule-type');\n         $conditionsService = Craft::$app->getConditions();\n         $this->_condition = $conditionsService->createCondition($config);"
        },
        {
          "filename": "src/helpers/Component.php",
          "status": "modified",
          "additions": 21,
          "deletions": 0,
          "patch": "@@ -81,6 +81,27 @@ public static function validateComponentClass(string $class, ?string $instanceOf\n         return true;\n     }\n \n+    /**\n+     * Cleanses a component config of any `on X` or `as X` keys.\n+     *\n+     * @param array $config\n+     * @return array\n+     * @since 4.4.15\n+     */\n+    public static function cleanseConfig(array $config): array\n+    {\n+        foreach ($config as $key => $value) {\n+            if (is_string($key) && (str_starts_with($key, 'on ') || str_starts_with($key, 'as '))) {\n+                unset($config[$key]);\n+                continue;\n+            }\n+            if (is_array($value)) {\n+                $config[$key] = static::cleanseConfig($value);\n+            }\n+        }\n+        return $config;\n+    }\n+\n     /**\n      * Instantiates and populates a component, and ensures that it is an instance of a given interface.\n      *"
        },
        {
          "filename": "tests/unit/helpers/ComponentHelperTest.php",
          "status": "modified",
          "additions": 27,
          "deletions": 0,
          "patch": "@@ -115,6 +115,16 @@ public function testIconSvg(string $needle, ?string $icon, string $label): void\n         self::assertStringContainsString($needle, Component::iconSvg($icon, $label));\n     }\n \n+    /**\n+     * @dataProvider cleanseConfigDataProvider\n+     * @param array $expected\n+     * @param array $config\n+     */\n+    public function testCleanseConfig(array $expected, array $config)\n+    {\n+        self::assertSame($expected, Component::cleanseConfig($config));\n+    }\n+\n     /**\n      * @return array\n      */\n@@ -304,4 +314,21 @@ public function iconSvgDataProvider(): array\n             'aria-hidden' => ['aria-hidden=\"true\"', '<svg width=\"100px\" height=\"100px\" viewBox=\"0 0 100 100\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\"></svg>', 'Default'],\n         ];\n     }\n+\n+    /**\n+     * @return array\n+     */\n+    public function cleanseConfigDataProvider(): array\n+    {\n+        return [\n+            [\n+                ['f' => 'foo', 'b' => 'bar'],\n+                ['f' => 'foo', 'b' => 'bar', 'as f' => 'f', 'on b' => 'b'],\n+            ],\n+            [\n+                ['nested' => ['f' => 'foo', 'b' => 'bar']],\n+                ['nested' => ['f' => 'foo', 'b' => 'bar', 'as f' => 'f', 'on b' => 'b']],\n+            ],\n+        ];\n+    }\n }"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 4,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "2461d9d2fe461c57d038675083470b5b7f7fff15",
            "date": "2025-01-13T19:29:56Z",
            "author_login": "brandonkelly"
          },
          {
            "sha": "28fca2b5b66c55e489e784c2f5fef2d4b179dce2",
            "date": "2025-01-13T19:27:35Z",
            "author_login": "brandonkelly"
          },
          {
            "sha": "80f5b0643c35111a22f63dcea4838c0ecbe2c666",
            "date": "2025-01-13T19:27:00Z",
            "author_login": "brandonkelly"
          },
          {
            "sha": "0dccb7d72bec5ca84b5a2994e8ff4f7454e5541b",
            "date": "2025-01-11T03:22:11Z",
            "author_login": "brandonkelly"
          },
          {
            "sha": "da08dc0686f4b19c6fc1ae82ce4635e7e3fe4ff2",
            "date": "2025-01-11T03:21:30Z",
            "author_login": "brandonkelly"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 10.0,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:L",
    "cwe_id": "CWE-94",
    "description": "Craft CMS is a platform for creating digital experiences. This is a high-impact, low-complexity attack vector. Users running Craft installations before 4.4.15 are encouraged to update to at least that version to mitigate the issue. This issue has been fixed in Craft CMS 4.4.15.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-09-13T20:15:08.187",
    "last_modified": "2024-11-21T08:21:52.050",
    "fix_date": "2023-06-27T23:35:52Z"
  },
  "references": [
    {
      "url": "http://packetstormsecurity.com/files/176303/Craft-CMS-4.4.14-Remote-Code-Execution.html",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/craftcms/cms/blob/develop/CHANGELOG.md#4415---2023-07-03-critical",
      "source": "security-advisories@github.com",
      "tags": [
        "Release Notes"
      ]
    },
    {
      "url": "https://github.com/craftcms/cms/commit/7359d18d46389ffac86c2af1e0cd59e37c298857",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/craftcms/cms/commit/a270b928f3d34ad3bd953b81c304424edd57355e",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/craftcms/cms/commit/c0a37e15cc925c473e60e27fe64054993b867ac1",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/craftcms/cms/commit/c0a37e15cc925c473e60e27fe64054993b867ac1#diff-47dd43d86f85161944dfcce2e41d31955c4184672d9bd9d82b948c6b01b86476",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/craftcms/cms/security/advisories/GHSA-4w8r-3xrw-v25g",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "http://packetstormsecurity.com/files/176303/Craft-CMS-4.4.14-Remote-Code-Execution.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://github.com/craftcms/cms/blob/develop/CHANGELOG.md#4415---2023-07-03-critical",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes"
      ]
    },
    {
      "url": "https://github.com/craftcms/cms/commit/7359d18d46389ffac86c2af1e0cd59e37c298857",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/craftcms/cms/commit/a270b928f3d34ad3bd953b81c304424edd57355e",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/craftcms/cms/commit/c0a37e15cc925c473e60e27fe64054993b867ac1",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/craftcms/cms/commit/c0a37e15cc925c473e60e27fe64054993b867ac1#diff-47dd43d86f85161944dfcce2e41d31955c4184672d9bd9d82b948c6b01b86476",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/craftcms/cms/security/advisories/GHSA-4w8r-3xrw-v25g",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:06:08.405981",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "cms",
    "owner": "craftcms",
    "created_at": "2017-01-27T21:52:45Z",
    "updated_at": "2025-01-14T04:17:39Z",
    "pushed_at": "2025-01-14T14:42:16Z",
    "size": 724660,
    "stars": 3304,
    "forks": 638,
    "open_issues": 462,
    "watchers": 3304,
    "has_security_policy": false,
    "default_branch": "5.x",
    "protected_branches": [
      "3.x",
      "4.x",
      "5.x"
    ],
    "languages": {
      "PHP": 9942975,
      "JavaScript": 1780122,
      "Twig": 525694,
      "SCSS": 336616,
      "Vue": 258380,
      "TypeScript": 26958,
      "Smarty": 2123,
      "HTML": 623,
      "PLpgSQL": 477,
      "Shell": 174,
      "CSS": 16
    },
    "commit_activity": {
      "total_commits_last_year": 8094,
      "avg_commits_per_week": 155.65384615384616,
      "days_active_last_year": 319
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T14:59:01.089030"
  }
}