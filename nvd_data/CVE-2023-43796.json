{
  "cve_id": "CVE-2023-43796",
  "github_data": {
    "repository": "matrix-org/synapse",
    "fix_commit": "daec55e1fe120c564240c5386e77941372bf458f",
    "related_commits": [
      "daec55e1fe120c564240c5386e77941372bf458f",
      "daec55e1fe120c564240c5386e77941372bf458f"
    ],
    "patch_url": "https://github.com/matrix-org/synapse/commit/daec55e1fe120c564240c5386e77941372bf458f.patch",
    "fix_commit_details": {
      "sha": "daec55e1fe120c564240c5386e77941372bf458f",
      "commit_date": "2023-10-31T13:58:30Z",
      "author": {
        "login": "clokep",
        "type": "User",
        "stats": {
          "total_commits": 1430,
          "average_weekly_commits": 2.623853211009174,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 192
        }
      },
      "commit_message": {
        "title": "Merge pull request from GHSA-mp92-3jfm-3575",
        "length": 43,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 17,
        "additions": 16,
        "deletions": 1
      },
      "files": [
        {
          "filename": "synapse/federation/federation_server.py",
          "status": "modified",
          "additions": 7,
          "deletions": 1,
          "patch": "@@ -84,7 +84,7 @@\n from synapse.storage.databases.main.lock import Lock\n from synapse.storage.databases.main.roommember import extract_heroes_from_room_summary\n from synapse.storage.roommember import MemberSummary\n-from synapse.types import JsonDict, StateMap, get_domain_from_id\n+from synapse.types import JsonDict, StateMap, get_domain_from_id, UserID\n from synapse.util import unwrapFirstError\n from synapse.util.async_helpers import Linearizer, concurrently_execute, gather_results\n from synapse.util.caches.response_cache import ResponseCache\n@@ -999,6 +999,12 @@ async def on_query_user_devices(\n     async def on_claim_client_keys(\n         self, query: List[Tuple[str, str, str, int]], always_include_fallback_keys: bool\n     ) -> Dict[str, Any]:\n+        if any(\n+            not self.hs.is_mine(UserID.from_string(user_id))\n+            for user_id, _, _, _ in query\n+        ):\n+            raise SynapseError(400, \"User is not hosted on this homeserver\")\n+\n         log_kv({\"message\": \"Claiming one time keys.\", \"user, device pairs\": query})\n         results = await self._e2e_keys_handler.claim_local_one_time_keys(\n             query, always_include_fallback_keys=always_include_fallback_keys"
        },
        {
          "filename": "synapse/handlers/device.py",
          "status": "modified",
          "additions": 3,
          "deletions": 0,
          "patch": "@@ -328,6 +328,9 @@ async def get_user_ids_changed(\n         return result\n \n     async def on_federation_query_user_devices(self, user_id: str) -> JsonDict:\n+        if not self.hs.is_mine(UserID.from_string(user_id)):\n+            raise SynapseError(400, \"User is not hosted on this homeserver\")\n+\n         stream_id, devices = await self.store.get_e2e_device_keys_for_federation_query(\n             user_id\n         )"
        },
        {
          "filename": "synapse/handlers/e2e_keys.py",
          "status": "modified",
          "additions": 6,
          "deletions": 0,
          "patch": "@@ -542,6 +542,12 @@ async def on_federation_query_client_keys(\n         device_keys_query: Dict[str, Optional[List[str]]] = query_body.get(\n             \"device_keys\", {}\n         )\n+        if any(\n+            not self.is_mine(UserID.from_string(user_id))\n+            for user_id in device_keys_query\n+        ):\n+            raise SynapseError(400, \"User is not hosted on this homeserver\")\n+\n         res = await self.query_local_devices(\n             device_keys_query,\n             include_displaynames=("
        }
      ],
      "file_patterns": {
        "security_files": 1,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 2,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "be65a8ec0195955c15fdb179c9158b187638e39a",
            "date": "2023-12-13T14:50:56Z",
            "author_login": "wrjlewis"
          },
          {
            "sha": "66fc265578f4501307edcac2514892ecdf791fc9",
            "date": "2023-12-13T14:47:34Z",
            "author_login": "wrjlewis"
          },
          {
            "sha": "025951bc3b6ddc0a6487ac045cc00a35a9d7eaaa",
            "date": "2023-12-13T14:46:11Z",
            "author_login": "erikjohnston"
          },
          {
            "sha": "70c020b532821f898aaa07c35c5d5ab59055ae1c",
            "date": "2023-12-12T20:32:48Z",
            "author_login": "erikjohnston"
          },
          {
            "sha": "e1f8440c8959719a417fbf1bdda11406cfdf523d",
            "date": "2023-11-21T19:26:47Z",
            "author_login": "clokep"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 5.3,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:N",
    "cwe_id": "CWE-200",
    "description": "Synapse is an open-source Matrix homeserver Prior to versions 1.95.1 and 1.96.0rc1, cached device information of remote users can be queried from Synapse. This can be used to enumerate the remote users known to a homeserver. System administrators are encouraged to upgrade to Synapse 1.95.1 or 1.96.0rc1 to receive a patch. As a workaround, the `federation_domain_whitelist` can be used to limit federation traffic with a homeserver.\n",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-10-31T17:15:23.270",
    "last_modified": "2024-11-21T08:24:48.137",
    "fix_date": "2023-10-31T13:58:30Z"
  },
  "references": [
    {
      "url": "https://github.com/matrix-org/synapse/commit/daec55e1fe120c564240c5386e77941372bf458f",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/matrix-org/synapse/security/advisories/GHSA-mp92-3jfm-3575",
      "source": "security-advisories@github.com",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce@lists.fedoraproject.org/message/2IDEEZMFJBDLTFHQUTZRJJNCOZGQ2ZVS/",
      "source": "security-advisories@github.com",
      "tags": [
        "Mailing List"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce@lists.fedoraproject.org/message/VH3RNC5ZPQZ4OKPSL4E6BBJSZOQLGDEY/",
      "source": "security-advisories@github.com",
      "tags": [
        "Mailing List"
      ]
    },
    {
      "url": "https://security.gentoo.org/glsa/202401-12",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/matrix-org/synapse/commit/daec55e1fe120c564240c5386e77941372bf458f",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/matrix-org/synapse/security/advisories/GHSA-mp92-3jfm-3575",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce@lists.fedoraproject.org/message/2IDEEZMFJBDLTFHQUTZRJJNCOZGQ2ZVS/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce@lists.fedoraproject.org/message/VH3RNC5ZPQZ4OKPSL4E6BBJSZOQLGDEY/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List"
      ]
    },
    {
      "url": "https://security.gentoo.org/glsa/202401-12",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:06:36.973449",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "synapse",
    "owner": "matrix-org",
    "created_at": "2014-08-11T15:51:42Z",
    "updated_at": "2025-01-14T04:04:49Z",
    "pushed_at": "2024-04-26T15:47:23Z",
    "size": 429495,
    "stars": 11851,
    "forks": 2122,
    "open_issues": 1529,
    "watchers": 11851,
    "has_security_policy": false,
    "default_branch": "develop",
    "protected_branches": [],
    "languages": {
      "Python": 11907179,
      "Rust": 95720,
      "HTML": 64571,
      "Shell": 59187,
      "Perl": 28191,
      "Nix": 12267,
      "Dockerfile": 12096,
      "JavaScript": 11988,
      "Jinja": 7942,
      "CSS": 6211,
      "Makefile": 634,
      "Gherkin": 308,
      "Lua": 241
    },
    "commit_activity": {
      "total_commits_last_year": 1,
      "avg_commits_per_week": 0.019230769230769232,
      "days_active_last_year": 1
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "apache-2.0"
    },
    "collected_at": "2025-01-14T13:52:33.725944"
  }
}