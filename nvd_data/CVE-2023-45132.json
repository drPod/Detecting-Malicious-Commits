{
  "cve_id": "CVE-2023-45132",
  "github_data": {
    "repository": "wargio/naxsi",
    "fix_commit": "1b712526ed3314dd6be7e8b0259eabda63c19537",
    "related_commits": [
      "1b712526ed3314dd6be7e8b0259eabda63c19537",
      "1b712526ed3314dd6be7e8b0259eabda63c19537"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "1b712526ed3314dd6be7e8b0259eabda63c19537",
      "commit_date": "2023-10-09T06:20:20Z",
      "author": {
        "login": "lubomudr",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Remove X-Forwarded-For header special processing (#103)",
        "length": 353,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 191,
        "additions": 152,
        "deletions": 39
      },
      "files": [
        {
          "filename": ".scripts/ci-build.sh",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -49,6 +49,7 @@ if $NEW_BUILD ; then\n                 --without-mail_pop3_module \\\n                 --without-mail_smtp_module \\\n                 --without-mail_imap_module \\\n+                --with-http_realip_module \\\n                 --with-http_v2_module \\\n                 --without-http_uwsgi_module \\\n                 --without-http_scgi_module \\"
        },
        {
          "filename": "naxsi_src/naxsi_runtime.c",
          "status": "modified",
          "additions": 0,
          "deletions": 31,
          "patch": "@@ -2912,36 +2912,6 @@ ngx_http_naxsi_update_current_ctx_status(ngx_http_request_ctx_t*    ctx,\n   NX_DEBUG(_debug_custom_score, NGX_LOG_DEBUG_HTTP, r->connection->log, 0, \"XX-custom check rules\");\n \n   if (!ctx->ignore && (cf->ignore_ips || cf->ignore_cidrs)) {\n-#if (NGX_HTTP_X_FORWARDED_FOR)\n-#if (nginx_version < 1023000)\n-    ngx_table_elt_t** h;\n-    if (r->headers_in.x_forwarded_for.nelts >= 1) {\n-      h = r->headers_in.x_forwarded_for.elts;\n-      NX_DEBUG(_debug_whitelist_ignore,\n-               NGX_LOG_DEBUG_HTTP,\n-               r->connection->log,\n-               0,\n-               \"XX- lookup ignore X-Forwarded-For: %V\",\n-               h[0]->value);\n-      ngx_str_t* ip = &h[0]->value;\n-      ctx->ignore   = naxsi_can_ignore_ip(ip, cf) || naxsi_can_ignore_cidr(ip, cf);\n-    } else\n-#else\n-    ngx_table_elt_t* xff;\n-    if (r->headers_in.x_forwarded_for != NULL) {\n-      xff = r->headers_in.x_forwarded_for;\n-      NX_DEBUG(_debug_whitelist_ignore,\n-               NGX_LOG_DEBUG_HTTP,\n-               r->connection->log,\n-               0,\n-               \"XX- lookup ignore X-Forwarded-For: %V\",\n-               xff->value);\n-      ngx_str_t* ip = &xff->value;\n-      ctx->ignore   = naxsi_can_ignore_ip(ip, cf) || naxsi_can_ignore_cidr(ip, cf);\n-    } else\n-#endif\n-#endif\n-    {\n       ngx_str_t* ip = &r->connection->addr_text;\n       NX_DEBUG(_debug_whitelist_ignore,\n                NGX_LOG_DEBUG_HTTP,\n@@ -2950,7 +2920,6 @@ ngx_http_naxsi_update_current_ctx_status(ngx_http_request_ctx_t*    ctx,\n                \"XX- lookup ignore client ip: %V\",\n                ip);\n       ctx->ignore = naxsi_can_ignore_ip(ip, cf) || naxsi_can_ignore_cidr(ip, cf);\n-    }\n   }\n \n   if (cf->check_rules && ctx->special_scores) {"
        },
        {
          "filename": "unit-tests/tests/33ignoreip.t",
          "status": "modified",
          "additions": 61,
          "deletions": 4,
          "patch": "@@ -60,7 +60,7 @@ location /RequestDenied {\n GET /?a=buibui\n --- error_code: 200\n \n-=== TEST 1.2: IgnoreIP request with X-Forwarded-For allow (ipv4) \n+=== TEST 1.2.1: IgnoreIP request with X-Forwarded-For allow without real_ip config (ipv4) \n --- main_config\n load_module $TEST_NGINX_NAXSI_MODULE_SO;\n --- http_config\n@@ -83,10 +83,38 @@ location /RequestDenied {\n --- more_headers\n X-Forwarded-For: 1.1.1.1\n --- request\n-GET /?a=buibui\n+GET /?a=<>\n+--- error_code: 412\n+\n+=== TEST 1.2.2: IgnoreIP request with X-Forwarded-For allow with real_ip config (ipv4) \n+--- main_config\n+load_module $TEST_NGINX_NAXSI_MODULE_SO;\n+--- http_config\n+include $TEST_NGINX_NAXSI_RULES;\n+set_real_ip_from 127.0.0.1;\n+real_ip_header X-Forwarded-For;\n+--- config\n+location / {\n+     SecRulesEnabled;\n+     IgnoreIP  \"1.1.1.1\";\n+     DeniedUrl \"/RequestDenied\";\n+     CheckRule \"$SQL >= 8\" BLOCK;\n+     CheckRule \"$RFI >= 8\" BLOCK;\n+     CheckRule \"$TRAVERSAL >= 4\" BLOCK;\n+     CheckRule \"$XSS >= 8\" BLOCK;\n+     root $TEST_NGINX_SERVROOT/html/;\n+     index index.html index.htm;\n+}\n+location /RequestDenied {\n+     return 412;\n+}\n+--- more_headers\n+X-Forwarded-For: 1.1.1.1\n+--- request\n+GET /?a=<>\n --- error_code: 200\n \n-=== TEST 1.3: IgnoreIP request with X-Forwarded-For allow (ipv6)\n+=== TEST 1.3.1: IgnoreIP request with X-Forwarded-For allow without reaL_ip config (ipv6)\n --- main_config\n load_module $TEST_NGINX_NAXSI_MODULE_SO;\n --- http_config\n@@ -109,7 +137,36 @@ location /RequestDenied {\n --- more_headers\n X-Forwarded-For: 2001:4860:4860::8844\n --- request\n-GET /?a=buibui\n+GET /?a=<>\n+--- error_code: 412\n+\n+=== TEST 1.3.2: IgnoreIP request with X-Forwarded-For allow with real_ip config (ipv6)\n+--- main_config\n+load_module $TEST_NGINX_NAXSI_MODULE_SO;\n+--- http_config\n+include $TEST_NGINX_NAXSI_RULES;\n+set_real_ip_from 127.0.0.1;\n+set_real_ip_from ::1/128;\n+real_ip_header X-Forwarded-For;\n+--- config\n+location / {\n+     SecRulesEnabled;\n+     IgnoreIP \"2001:4860:4860::8844\";\n+     DeniedUrl \"/RequestDenied\";\n+     CheckRule \"$SQL >= 8\" BLOCK;\n+     CheckRule \"$RFI >= 8\" BLOCK;\n+     CheckRule \"$TRAVERSAL >= 4\" BLOCK;\n+     CheckRule \"$XSS >= 8\" BLOCK;\n+     root $TEST_NGINX_SERVROOT/html/;\n+     index index.html index.htm;\n+}\n+location /RequestDenied {\n+     return 412;\n+}\n+--- more_headers\n+X-Forwarded-For: 2001:4860:4860::8844\n+--- request\n+GET /?a=<>\n --- error_code: 200\n \n === TEST 1.4: IgnoreIP request with X-Forwarded-For deny (ipv4)"
        },
        {
          "filename": "unit-tests/tests/34ignorecidr.t",
          "status": "modified",
          "additions": 90,
          "deletions": 4,
          "patch": "@@ -60,7 +60,7 @@ location /RequestDenied {\n GET /?a=buibui\n --- error_code: 200\n \n-=== TEST 1.2: IgnoreCIDR request with X-Forwarded-For allow (no file) \n+=== TEST 1.2.1: IgnoreCIDR request with X-Forwarded-For allow without real_ip config (no file)\n --- main_config\n load_module $TEST_NGINX_NAXSI_MODULE_SO;\n --- http_config\n@@ -83,7 +83,35 @@ location /RequestDenied {\n --- more_headers\n X-Forwarded-For: 1.1.1.1\n --- request\n-GET /?a=buibui\n+GET /?a=<>\n+--- error_code: 412\n+\n+=== TEST 1.2.2: IgnoreCIDR request with X-Forwarded-For allow with real_ip config (no file)\n+--- main_config\n+load_module $TEST_NGINX_NAXSI_MODULE_SO;\n+--- http_config\n+include $TEST_NGINX_NAXSI_RULES;\n+set_real_ip_from 127.0.0.1;\n+real_ip_header X-Forwarded-For;\n+--- config\n+location / {\n+     SecRulesEnabled;\n+     IgnoreCIDR \"1.1.1.0/24\";\n+     DeniedUrl \"/RequestDenied\";\n+     CheckRule \"$SQL >= 8\" BLOCK;\n+     CheckRule \"$RFI >= 8\" BLOCK;\n+     CheckRule \"$TRAVERSAL >= 4\" BLOCK;\n+     CheckRule \"$XSS >= 8\" BLOCK;\n+     root $TEST_NGINX_SERVROOT/html/;\n+         index index.html index.htm;\n+}\n+location /RequestDenied {\n+     return 412;\n+}\n+--- more_headers\n+X-Forwarded-For: 1.1.1.1\n+--- request\n+GET /?a=<>\n --- error_code: 200\n \n === TEST 1.3: IgnoreCIDR request with X-Forwarded-For deny (no file)\n@@ -163,7 +191,7 @@ location /RequestDenied {\n GET /foobar\n --- error_code: 200\n \n-=== TEST 1.6: IgnoreCIDR request with X-Forwarded-For allow (ipv6)\n+=== TEST 1.6.1: IgnoreCIDR request with X-Forwarded-For allow without real_ip config (ipv6)\n --- main_config\n load_module $TEST_NGINX_NAXSI_MODULE_SO;\n --- http_config\n@@ -187,13 +215,71 @@ location /RequestDenied {\n X-Forwarded-For: 2001:4860:4860::8888\n --- request\n GET /?a=<>\n+--- error_code: 412\n+\n+=== TEST 1.6.2: IgnoreCIDR request with X-Forwarded-For allow with real_ip config (ipv6)\n+--- main_config\n+load_module $TEST_NGINX_NAXSI_MODULE_SO;\n+--- http_config\n+include $TEST_NGINX_NAXSI_RULES;\n+set_real_ip_from 127.0.0.1;\n+set_real_ip_from ::1/128;\n+real_ip_header X-Forwarded-For;\n+--- config\n+location / {\n+     SecRulesEnabled;\n+     IgnoreCIDR \"2001:4860:4860::/112\";\n+     DeniedUrl \"/RequestDenied\";\n+     CheckRule \"$SQL >= 8\" BLOCK;\n+     CheckRule \"$RFI >= 8\" BLOCK;\n+     CheckRule \"$TRAVERSAL >= 4\" BLOCK;\n+     CheckRule \"$XSS >= 8\" BLOCK;\n+     root $TEST_NGINX_SERVROOT/html/;\n+     index index.html index.htm;\n+}\n+location /RequestDenied {\n+     return 412;\n+}\n+--- more_headers\n+X-Forwarded-For: 2001:4860:4860::8888\n+--- request\n+GET /?a=<>\n --- error_code: 200\n \n-=== TEST 1.7: Verify IgnoreCIDR 2001:4860:4860::8888/128 is converted to IgnoreIP\n+=== TEST 1.7.1: Verify IgnoreCIDR 2001:4860:4860::8888/128 is converted to IgnoreIP without real_ip config\n+--- main_config\n+load_module $TEST_NGINX_NAXSI_MODULE_SO;\n+--- http_config\n+include $TEST_NGINX_NAXSI_RULES;\n+--- config\n+location / {\n+     SecRulesEnabled;\n+     IgnoreCIDR \"2001:4860:4860::8888/128\";\n+     DeniedUrl \"/RequestDenied\";\n+     CheckRule \"$SQL >= 8\" BLOCK;\n+     CheckRule \"$RFI >= 8\" BLOCK;\n+     CheckRule \"$TRAVERSAL >= 4\" BLOCK;\n+     CheckRule \"$XSS >= 8\" BLOCK;\n+     root $TEST_NGINX_SERVROOT/html/;\n+     index index.html index.htm;\n+}\n+location /RequestDenied {\n+     return 412;\n+}\n+--- more_headers\n+X-Forwarded-For: 2001:4860:4860::8888\n+--- request\n+GET /?a=<>\n+--- error_code: 412\n+\n+=== TEST 1.7.2: Verify IgnoreCIDR 2001:4860:4860::8888/128 is converted to IgnoreIP with real_ip config\n --- main_config\n load_module $TEST_NGINX_NAXSI_MODULE_SO;\n --- http_config\n include $TEST_NGINX_NAXSI_RULES;\n+set_real_ip_from 127.0.0.1;\n+set_real_ip_from ::1/128;\n+real_ip_header X-Forwarded-For;\n --- config\n location / {\n      SecRulesEnabled;"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 2,
        "unique_directories": 3,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "b61ba37b3666b386c7a6d83fbcdf6ca3377395a1",
            "date": "2025-01-05T11:51:56Z",
            "author_login": "wargio"
          },
          {
            "sha": "ad7c4adddb1db1e0bf6980d499385fd6c60d253b",
            "date": "2025-01-05T11:49:31Z",
            "author_login": "wargio"
          },
          {
            "sha": "be166fb36d2c1984fc65e8a95dc3d8d4e6e9b782",
            "date": "2025-01-05T11:45:24Z",
            "author_login": "wargio"
          },
          {
            "sha": "994572e6a074a6b3a290c28f5e0ac68b8ec3d893",
            "date": "2025-01-05T11:25:59Z",
            "author_login": "wargio"
          },
          {
            "sha": "ff21d44cd853b0d85a093fe18d0ca950dd0a6f00",
            "date": "2025-01-05T08:26:27Z",
            "author_login": "wargio"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 9.1,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:H",
    "cwe_id": "CWE-693",
    "description": "NAXSI is an open-source maintenance web application firewall (WAF) for NGINX. An issue present starting in version 1.3 and prior to version 1.6 allows someone to bypass the WAF when a malicious `X-Forwarded-For` IP matches `IgnoreIP` `IgnoreCIDR` rules. This old code was arranged to allow older NGINX versions to also support `IgnoreIP` `IgnoreCIDR` when multiple reverse proxies were present. The issue is patched in version 1.6. As a workaround, do not set any `IgnoreIP` `IgnoreCIDR` for older versions.\n",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-10-11T21:15:10.207",
    "last_modified": "2024-11-21T08:26:24.447",
    "fix_date": "2023-10-09T06:20:20Z"
  },
  "references": [
    {
      "url": "https://github.com/wargio/naxsi/commit/1b712526ed3314dd6be7e8b0259eabda63c19537",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/wargio/naxsi/pull/103",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/wargio/naxsi/security/advisories/GHSA-7qjc-q4j9-pc8x",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/wargio/naxsi/commit/1b712526ed3314dd6be7e8b0259eabda63c19537",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/wargio/naxsi/pull/103",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/wargio/naxsi/security/advisories/GHSA-7qjc-q4j9-pc8x",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:06:10.593164",
    "processing_status": "enhanced"
  },
  "repository_context": {
    "name": "naxsi",
    "owner": "wargio",
    "created_at": "2022-03-05T12:51:54Z",
    "updated_at": "2025-01-26T03:20:37Z",
    "pushed_at": "2025-01-05T11:52:17Z",
    "size": 3465,
    "stars": 336,
    "forks": 38,
    "open_issues": 12,
    "watchers": 336,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [
      "main"
    ],
    "languages": {
      "C": 268134,
      "Shell": 53095,
      "Batchfile": 1407
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "gpl-3.0"
    },
    "collected_at": "2025-01-26T08:23:47.742486"
  }
}