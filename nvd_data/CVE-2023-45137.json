{
  "cve_id": "CVE-2023-45137",
  "github_data": {
    "repository": "xwiki/xwiki-platform",
    "fix_commit": "ed8ec747967f8a16434806e727a57214a8843581",
    "related_commits": [
      "ed8ec747967f8a16434806e727a57214a8843581",
      "ed8ec747967f8a16434806e727a57214a8843581"
    ],
    "patch_url": "https://github.com/xwiki/xwiki-platform/commit/ed8ec747967f8a16434806e727a57214a8843581.patch",
    "fix_commit_details": {
      "sha": "ed8ec747967f8a16434806e727a57214a8843581",
      "commit_date": "2023-06-05T10:03:05Z",
      "author": {
        "login": "michitux",
        "type": "User",
        "stats": {
          "total_commits": 378,
          "average_weekly_commits": 0.39622641509433965,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 108
        }
      },
      "commit_message": {
        "title": "XWIKI-20961: Improve escaping for document exists error",
        "length": 114,
        "has_description": true,
        "references_issue": false
      },
      "stats": {
        "total": 45,
        "additions": 38,
        "deletions": 7
      },
      "files": [
        {
          "filename": "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -79,7 +79,7 @@\n   <div class='box errormessage'>\n       ## Use the 'existingDocumentReference' context binding set by the create action for this case.\n       $services.localization.render('core.create.page.error.docalreadyexists',\n-        [\"${existingDocumentReference}\",\n+        [$escapetool.xml(\"${existingDocumentReference}\"),\n          $xwiki.getURL($existingDocumentReference, 'view', ''),\n          $xwiki.getURL($existingDocumentReference, 'edit', '')\n         ]"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java",
          "status": "modified",
          "additions": 37,
          "deletions": 6,
          "patch": "@@ -51,6 +51,12 @@ class CreateInlinePageTest extends PageTest\n      */\n     private static final String CREATE_INLINE_VM = \"createinline.vm\";\n \n+    private static final String DOCUMENT_REFERENCE = \"xwiki:space.</div>page\";\n+\n+    private static final String CREATE_EXCEPTION_VELOCITY_KEY = \"createException\";\n+\n+    private static final String ERROR_MESSAGE_CLASS = \"errormessage\";\n+\n     private VelocityManager velocityManager;\n \n     @Inject\n@@ -71,20 +77,45 @@ void setup() throws Exception\n     void testNameValidationError() throws Exception\n     {\n         // Set \"createException\" to an XWikiException to simulate a validation error.\n-        String documentReference = \"xwiki:space.</div>page\";\n-        Object[] args = { documentReference };\n+        Object[] args = { DOCUMENT_REFERENCE };\n         XWikiException invalidNameException = new XWikiException(XWikiException.MODULE_XWIKI_STORE,\n             XWikiException.ERROR_XWIKI_APP_DOCUMENT_NAME_INVALID,\n             \"Cannot create document {0} because its name does not respect the name strategy of the wiki.\", null,\n             args);\n-        this.velocityManager.getVelocityContext().put(\"createException\", invalidNameException);\n-        this.velocityManager.getVelocityContext().put(\"invalidNameReference\", documentReference);\n+        this.velocityManager.getVelocityContext().put(CREATE_EXCEPTION_VELOCITY_KEY, invalidNameException);\n+        this.velocityManager.getVelocityContext().put(\"invalidNameReference\", DOCUMENT_REFERENCE);\n+\n+        // Render the template.\n+        Document document = Jsoup.parse(this.templateManager.render(CREATE_INLINE_VM));\n+        Element errormessage = document.getElementsByClass(ERROR_MESSAGE_CLASS).first();\n+        assertNotNull(errormessage);\n+        String expectedMessage = String.format(\"entitynamevalidation.create.invalidname [%s]\", DOCUMENT_REFERENCE);\n+        assertEquals(expectedMessage, errormessage.text());\n+    }\n+\n+    /**\n+     * Test that when there is an exception about the document already existing, the name is correctly escaped.\n+     */\n+    @Test\n+    void testDocumentAlreadyExistsError() throws Exception\n+    {\n+        // Set \"createException\" to an XWikiException to simulate a document exists already error.\n+        String urlToDocument = \"space/%3C%2Fdiv%3Epage\";\n+        Object[] args = { DOCUMENT_REFERENCE };\n+        XWikiException documentAlreadyExistsException = new XWikiException(XWikiException.MODULE_XWIKI_STORE,\n+            XWikiException.ERROR_XWIKI_APP_DOCUMENT_NOT_EMPTY,\n+            \"Cannot create document {0} because it already has content\", null, args);\n+        this.velocityManager.getVelocityContext().put(CREATE_EXCEPTION_VELOCITY_KEY, documentAlreadyExistsException);\n+        this.velocityManager.getVelocityContext().put(\"existingDocumentReference\", DOCUMENT_REFERENCE);\n \n         // Render the template.\n         Document document = Jsoup.parse(this.templateManager.render(CREATE_INLINE_VM));\n-        Element errormessage = document.getElementsByClass(\"errormessage\").first();\n+        Element errormessage = document.getElementsByClass(ERROR_MESSAGE_CLASS).first();\n         assertNotNull(errormessage);\n-        String expectedMessage = String.format(\"entitynamevalidation.create.invalidname [%s]\", documentReference);\n+        String viewURL = String.format(\"/xwiki/bin/view/%s\", urlToDocument);\n+        String editURL = String.format(\"/xwiki/bin/edit/%s\", urlToDocument);\n+        String expectedMessage = String.format(\"core.create.page.error.docalreadyexists [%s, %s, %s]\",\n+            DOCUMENT_REFERENCE, viewURL, editURL);\n         assertEquals(expectedMessage, errormessage.text());\n     }\n }"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 2,
        "max_directory_depth": 9
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "88e3e7d23cbd3e6ed059dbcd6532f94016d42678",
            "date": "2025-01-13T16:58:06Z",
            "author_login": "Sereza7"
          },
          {
            "sha": "9b506ab2bed52744b52699ea05cde15986d42abb",
            "date": "2025-01-13T16:36:24Z",
            "author_login": "mflorea"
          },
          {
            "sha": "d53d6e347b97ac20f60e21fb2bae381f4aaf10f4",
            "date": "2025-01-13T13:25:24Z",
            "author_login": "tmortagne"
          },
          {
            "sha": "d85bd8f9c67c412e0cfb45fb4695b8d4e759bab6",
            "date": "2025-01-13T12:03:22Z",
            "author_login": "tmortagne"
          },
          {
            "sha": "6f210dabc99167cf9f020a048c88325eca34ceea",
            "date": "2025-01-13T08:54:32Z",
            "author_login": "tmortagne"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 9.0,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:H/I:H/A:H",
    "cwe_id": "CWE-79",
    "description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. `org.xwiki.platform:xwiki-platform-web` starting in version 3.1-milestone-2 and prior to version 13.4-rc-1, as well as `org.xwiki.platform:xwiki-platform-web-templates` prior to versions 14.10.12 and 15.5-rc-1, are vulnerable to cross-site scripting. When trying to create a document that already exists, XWiki displays an error message in the form for creating it. Due to missing escaping, this error message is vulnerable to raw HTML injection and thus XSS. The injected code is the document reference of the existing document so this requires that the attacker first creates a non-empty document whose name contains the attack code. This has been patched in `org.xwiki.platform:xwiki-platform-web` version 13.4-rc-1 and `org.xwiki.platform:xwiki-platform-web-templates` versions 14.10.12 and 15.5-rc-1 by adding the appropriate escaping. The vulnerable template file `createinline.vm` is part of XWiki's WAR and can be patched by manually applying the changes from the fix.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-10-25T21:15:10.017",
    "last_modified": "2024-11-21T08:26:25.237",
    "fix_date": "2023-06-05T10:03:05Z"
  },
  "references": [
    {
      "url": "https://github.com/xwiki/xwiki-platform/commit/ed8ec747967f8a16434806e727a57214a8843581",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/security/advisories/GHSA-93gh-jgjj-r929",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://jira.xwiki.org/browse/XWIKI-20961",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/commit/ed8ec747967f8a16434806e727a57214a8843581",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/security/advisories/GHSA-93gh-jgjj-r929",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://jira.xwiki.org/browse/XWIKI-20961",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Patch",
        "Vendor Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:06:36.951371",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "xwiki-platform",
    "owner": "xwiki",
    "created_at": "2011-03-10T13:26:41Z",
    "updated_at": "2025-01-13T16:58:10Z",
    "pushed_at": "2025-01-14T12:32:03Z",
    "size": 561595,
    "stars": 1030,
    "forks": 554,
    "open_issues": 136,
    "watchers": 1030,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "Java": 34276921,
      "JavaScript": 2392892,
      "HTML": 388086,
      "Less": 318945,
      "AspectJ": 280487,
      "Vue": 222987,
      "CSS": 115460,
      "XSLT": 109285,
      "Clean": 44054,
      "Shell": 32569,
      "Batchfile": 14604,
      "Python": 5046,
      "Groovy": 3012,
      "AMPL": 1296
    },
    "commit_activity": {
      "total_commits_last_year": 1723,
      "avg_commits_per_week": 33.13461538461539,
      "days_active_last_year": 263
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "lgpl-2.1"
    },
    "collected_at": "2025-01-14T12:58:58.685838"
  }
}