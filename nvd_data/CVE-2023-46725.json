{
  "cve_id": "CVE-2023-46725",
  "github_data": {
    "repository": "foodcoopshop/foodcoopshop",
    "fix_commit": "0d5bec5c4c22e1affe7fd321a30e3f3a4d99e808",
    "related_commits": [
      "0d5bec5c4c22e1affe7fd321a30e3f3a4d99e808",
      "0d5bec5c4c22e1affe7fd321a30e3f3a4d99e808"
    ],
    "patch_url": "https://github.com/foodcoopshop/foodcoopshop/commit/0d5bec5c4c22e1affe7fd321a30e3f3a4d99e808.patch",
    "fix_commit_details": {
      "sha": "0d5bec5c4c22e1affe7fd321a30e3f3a4d99e808",
      "commit_date": "2023-11-02T13:04:14Z",
      "author": {
        "login": "mrothauer",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Merge pull request #972 from foodcoopshop/remotefile",
        "length": 77,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 60,
        "additions": 48,
        "deletions": 12
      },
      "files": [
        {
          "filename": "CHANGELOG.md",
          "status": "modified",
          "additions": 7,
          "deletions": 0,
          "patch": "@@ -6,6 +6,13 @@\n \n Das Format basiert auf [keepachangelog.com](http://keepachangelog.com) und verwendet [Semantic Versioning](http://semver.org/).\n \n+## v3.6.1\n+\n+### Security fix\n+- Security-Fix f\u00fcr das Netzwerk-Modul [PR#972](https://github.com/foodcoopshop/foodcoopshop/pull/972)\n+\n+Datum: 02.11.2023 / [Alle \u00c4nderungen anzeigen](https://github.com/foodcoopshop/foodcoopshop/compare/v3.6.0...v3.6.1)\n+\n ## v3.6.0\n \n ### Neue Datenschutz-Funktionen"
        },
        {
          "filename": "VERSION.txt",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -1 +1 @@\n-3.6.0\n\\ No newline at end of file\n+3.6.1\n\\ No newline at end of file"
        },
        {
          "filename": "plugins/Admin/tests/TestCase/src/Model/Table/ProductsTableTest.php",
          "status": "modified",
          "additions": 18,
          "deletions": 6,
          "patch": "@@ -88,19 +88,31 @@ public function testChangeImageValidImageAndDeleteImage()\n \n     public function testChangeImageInvalidImage()\n     {\n+        $file = WWW_ROOT . '/css/global.css';\n         $productId = 346;\n         $products = [\n-            [$productId => Configure::read('App.fullBaseUrl') . '/css/global.css']\n+            [$productId => $file]\n         ];\n-        $exceptionThrown = false;\n \n         try {\n             $this->Product->changeImage($products);\n-        } catch (InvalidParameterException $e) {\n-            $exceptionThrown = true;\n+        } catch (Exception $e) {\n+            $this->assertEquals('file is not an image: ' . $file, $e->getMessage());\n         }\n+    }\n \n-        $this->assertSame(true, $exceptionThrown);\n+    public function testChangeImageInvalidDomain()\n+    {\n+        $productId = 346;\n+        $products = [\n+            [$productId => 'https://localhost:8080/img/tests/test-image.jpg']\n+        ];\n+\n+        try {\n+            $this->Product->changeImage($products);\n+        } catch (Exception $e) {\n+            $this->assertEquals('invalid host', $e->getMessage());\n+        }\n     }\n \n     public function testChangeImageNonExistingFile()\n@@ -113,7 +125,7 @@ public function testChangeImageNonExistingFile()\n \n         try {\n             $this->Product->changeImage($products);\n-        } catch (InvalidParameterException $e) {\n+        } catch (Exception $e) {\n             $exceptionThrown = true;\n         }\n "
        },
        {
          "filename": "src/Lib/RemoteFile/RemoteFile.php",
          "status": "modified",
          "additions": 15,
          "deletions": 1,
          "patch": "@@ -18,9 +18,11 @@\n \n class RemoteFile\n {\n-    public static function exists(string $remoteFile): bool\n+    public static function exists(string $remoteFile, $allowedHosts = []): bool\n     {\n \n+        self::verifyAllowedHosts($allowedHosts, $remoteFile);\n+\n         $ch = curl_init($remoteFile);\n         curl_setopt($ch, CURLOPT_NOBODY, true);\n         curl_exec($ch);\n@@ -35,4 +37,16 @@ public static function exists(string $remoteFile): bool\n \n     }\n \n+    private static function verifyAllowedHosts($allowedHosts, $remoteFile)\n+    {\n+        if (empty($allowedHosts)) {\n+            throw new \\Exception('allowedHosts must be set');\n+        } else {\n+            $host = parse_url($remoteFile, PHP_URL_HOST);\n+            if (!in_array($host, $allowedHosts)) {\n+                throw new \\Exception('invalid host');\n+             }\n+        }\n+    }\n+\n }"
        },
        {
          "filename": "src/Model/Table/ProductsTable.php",
          "status": "modified",
          "additions": 7,
          "deletions": 4,
          "patch": "@@ -1370,7 +1370,10 @@ public function changeImage($products)\n             }\n \n             if (filter_var($imageFromRemoteServer, FILTER_VALIDATE_URL)) {\n-                if (!RemoteFile::exists($imageFromRemoteServer)) {\n+                $syncDomainsTable = FactoryLocator::get('Table')->get('Network.SyncDomains');\n+                $syncDomains = $syncDomainsTable->getActiveSyncDomains()->toArray();\n+                $syncDomains = Hash::extract($syncDomains, '{n}.domain');\n+                if (!RemoteFile::exists($imageFromRemoteServer, $syncDomains)) {\n                     throw new InvalidParameterException('remote image not existing: ' . $imageFromRemoteServer);\n                 }\n             } else {\n@@ -1380,9 +1383,9 @@ public function changeImage($products)\n                 }\n             }\n \n-            $imageSize = getimagesize($imageFromRemoteServer);\n-            if ($imageSize === false) {\n-                throw new InvalidParameterException('file is not not an image: ' . $imageFromRemoteServer);\n+            $mimeContentType = mime_content_type($imageFromRemoteServer);\n+            if (!in_array($mimeContentType, Configure::read('app.allowedImageMimeTypes'))) {\n+                throw new InvalidParameterException('file is not an image: ' . $imageFromRemoteServer);\n             }\n         }\n "
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 4,
        "max_directory_depth": 7
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "c30cfea1332f0ee6f1813c727670f11b145f3d48",
            "date": "2025-01-13T16:30:52Z",
            "author_login": "mrothauer"
          },
          {
            "sha": "b9b75d25c22e1853d671092023a03368d4be2fd0",
            "date": "2025-01-10T10:52:37Z",
            "author_login": "mrothauer"
          },
          {
            "sha": "55e0dba49a89b580cbb7b4793d20adb35867f9a6",
            "date": "2025-01-08T20:41:47Z",
            "author_login": "mrothauer"
          },
          {
            "sha": "502ae3f9dec38e2e0d2a2feda4afd7795ee6f679",
            "date": "2025-01-08T08:15:08Z",
            "author_login": "mrothauer"
          },
          {
            "sha": "5152e1988de784f7b432d447d5b539b2813c26a6",
            "date": "2025-01-06T11:08:14Z",
            "author_login": "mrothauer"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 8.1,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:N",
    "cwe_id": "CWE-918",
    "description": "FoodCoopShop is open source software for food coops and local shops. Versions starting with 3.2.0 prior to 3.6.1 are vulnerable to server-side request forgery. In the Network module, a manufacturer account can use the `/api/updateProducts.json` endpoint to make the server send a request to an arbitrary host. This means that the server can be used as a proxy into the internal network where the server is. Furthermore, the checks on a valid image are not adequate, leading to a time of check time of use issue. For example, by using a custom server that returns 200 on HEAD requests, then return a valid image on first GET request and then a 302 redirect to final target on second GET request, the server will copy whatever file is at the redirect destination, making this a full SSRF. Version 3.6.1 fixes this vulnerability.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-11-02T15:15:08.847",
    "last_modified": "2024-11-21T08:29:09.810",
    "fix_date": "2023-11-02T13:04:14Z"
  },
  "references": [
    {
      "url": "https://github.com/foodcoopshop/foodcoopshop/commit/0d5bec5c4c22e1affe7fd321a30e3f3a4d99e808",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/foodcoopshop/foodcoopshop/pull/972",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/foodcoopshop/foodcoopshop/security/advisories/GHSA-jhww-fx2j-3rf7",
      "source": "security-advisories@github.com",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://pastebin.com/8K5Brwbq",
      "source": "security-advisories@github.com",
      "tags": [
        "Not Applicable"
      ]
    },
    {
      "url": "https://github.com/foodcoopshop/foodcoopshop/commit/0d5bec5c4c22e1affe7fd321a30e3f3a4d99e808",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/foodcoopshop/foodcoopshop/pull/972",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/foodcoopshop/foodcoopshop/security/advisories/GHSA-jhww-fx2j-3rf7",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://pastebin.com/8K5Brwbq",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Not Applicable"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:06:36.980905",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "foodcoopshop",
    "owner": "foodcoopshop",
    "created_at": "2016-08-25T18:45:12Z",
    "updated_at": "2025-01-14T06:22:10Z",
    "pushed_at": "2025-01-14T19:49:22Z",
    "size": 64297,
    "stars": 96,
    "forks": 26,
    "open_issues": 78,
    "watchers": 96,
    "has_security_policy": false,
    "default_branch": "develop",
    "protected_branches": [
      "develop",
      "main"
    ],
    "languages": {
      "PHP": 3183106,
      "JavaScript": 432780,
      "CSS": 147881,
      "HTML": 88582,
      "Shell": 5589,
      "Batchfile": 834,
      "Dockerfile": 813
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "agpl-3.0"
    },
    "collected_at": "2025-01-14T20:19:46.605404"
  }
}