{
  "cve_id": "CVE-2023-46736",
  "github_data": {
    "repository": "espocrm/espocrm",
    "fix_commit": "c536cee6375e2088f961af13db7aaa652c983072",
    "related_commits": [
      "c536cee6375e2088f961af13db7aaa652c983072",
      "c536cee6375e2088f961af13db7aaa652c983072"
    ],
    "patch_url": "https://github.com/espocrm/espocrm/commit/c536cee6375e2088f961af13db7aaa652c983072.patch",
    "fix_commit_details": {
      "sha": "c536cee6375e2088f961af13db7aaa652c983072",
      "commit_date": "2023-11-06T14:02:13Z",
      "author": {
        "login": "yurikuzn",
        "type": "User",
        "stats": {
          "total_commits": 17806,
          "average_weekly_commits": 30.437606837606836,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 566
        }
      },
      "commit_message": {
        "title": "image upload url check",
        "length": 22,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 109,
        "additions": 107,
        "deletions": 2
      },
      "files": [
        {
          "filename": "application/Espo/Core/Utils/Security/UrlCheck.php",
          "status": "added",
          "additions": 95,
          "deletions": 0,
          "patch": "@@ -0,0 +1,95 @@\n+<?php\n+/************************************************************************\n+ * This file is part of EspoCRM.\n+ *\n+ * EspoCRM - Open Source CRM application.\n+ * Copyright (C) 2014-2023 Yurii Kuznietsov, Taras Machyshyn, Oleksii Avramenko\n+ * Website: https://www.espocrm.com\n+ *\n+ * EspoCRM is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * EspoCRM is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with EspoCRM. If not, see http://www.gnu.org/licenses/.\n+ *\n+ * The interactive user interfaces in modified source and object code versions\n+ * of this program must display Appropriate Legal Notices, as required under\n+ * Section 5 of the GNU General Public License version 3.\n+ *\n+ * In accordance with Section 7(b) of the GNU General Public License version 3,\n+ * these Appropriate Legal Notices must retain the display of the \"EspoCRM\" word.\n+ ************************************************************************/\n+\n+namespace Espo\\Core\\Utils\\Security;\n+\n+use const DNS_A;\n+use const FILTER_FLAG_NO_PRIV_RANGE;\n+use const FILTER_FLAG_NO_RES_RANGE;\n+use const FILTER_VALIDATE_IP;\n+use const FILTER_VALIDATE_URL;\n+use const PHP_URL_HOST;\n+\n+class UrlCheck\n+{\n+    public function isUrl(string $url): bool\n+    {\n+        return filter_var($url, FILTER_VALIDATE_URL) !== false;\n+    }\n+\n+    /**\n+     * Checks whether a URL does not follow to an internal host.\n+     */\n+    public function isNotInternalUrl(string $url): bool\n+    {\n+        if (!$this->isUrl($url)) {\n+            return false;\n+        }\n+\n+        $host = parse_url($url, PHP_URL_HOST);\n+\n+        if (!is_string($host)) {\n+            return false;\n+        }\n+\n+        $records = dns_get_record($host, DNS_A);\n+\n+        if (filter_var($host, FILTER_VALIDATE_IP)) {\n+            return $this->ipAddressIsNotInternal($host);\n+        }\n+\n+        if (!$records) {\n+            return false;\n+        }\n+\n+        foreach ($records as $record) {\n+            /** @var ?string $idAddress */\n+            $idAddress = $record['ip'] ?? null;\n+\n+            if (!$idAddress) {\n+                return false;\n+            }\n+\n+            if (!$this->ipAddressIsNotInternal($idAddress)) {\n+                return false;\n+            }\n+        }\n+\n+        return true;\n+    }\n+\n+    private function ipAddressIsNotInternal(string $ipAddress): bool\n+    {\n+        return (bool) filter_var(\n+            $ipAddress,\n+            FILTER_VALIDATE_IP,\n+            FILTER_FLAG_NO_PRIV_RANGE | FILTER_FLAG_NO_RES_RANGE\n+        );\n+    }\n+}"
        },
        {
          "filename": "application/Espo/Tools/Attachment/UploadUrlService.php",
          "status": "modified",
          "additions": 12,
          "deletions": 2,
          "patch": "@@ -32,8 +32,10 @@\n use Espo\\Core\\Exceptions\\Error;\n use Espo\\Core\\Exceptions\\ErrorSilent;\n use Espo\\Core\\Exceptions\\Forbidden;\n+use Espo\\Core\\Exceptions\\ForbiddenSilent;\n use Espo\\Core\\Utils\\File\\MimeType;\n use Espo\\Core\\Utils\\Metadata;\n+use Espo\\Core\\Utils\\Security\\UrlCheck;\n use Espo\\Entities\\Attachment as Attachment;\n use Espo\\ORM\\EntityManager;\n use Espo\\Repositories\\Attachment as AttachmentRepository;\n@@ -51,7 +53,8 @@ public function __construct(\n         Metadata $metadata,\n         EntityManager $entityManager,\n         MimeType $mimeType,\n-        DetailsObtainer $detailsObtainer\n+        DetailsObtainer $detailsObtainer,\n+        private UrlCheck $urlCheck\n     ) {\n         $this->accessChecker = $accessChecker;\n         $this->metadata = $metadata;\n@@ -68,6 +71,10 @@ public function __construct(\n      */\n     public function uploadImage(string $url, FieldData $data): Attachment\n     {\n+        if (!$this->urlCheck->isNotInternalUrl($url)) {\n+            throw new ForbiddenSilent(\"Not allowed URL.\");\n+        }\n+\n         $attachment = $this->getAttachmentRepository()->getNew();\n \n         $this->accessChecker->check($data);\n@@ -130,9 +137,12 @@ private function getImageDataByUrl(string $url): ?array\n         $opts[\\CURLOPT_SSL_VERIFYPEER] = true;\n         $opts[\\CURLOPT_SSL_VERIFYHOST] = 2;\n         $opts[\\CURLOPT_RETURNTRANSFER] = true;\n-        $opts[\\CURLOPT_FOLLOWLOCATION] = true;\n+        // Prevents Server Side Request Forgery by redirecting to an internal host.\n+        $opts[\\CURLOPT_FOLLOWLOCATION] = false;\n         $opts[\\CURLOPT_MAXREDIRS] = 2;\n         $opts[\\CURLOPT_IPRESOLVE] = \\CURL_IPRESOLVE_V4;\n+        $opts[\\CURLOPT_PROTOCOLS] = \\CURLPROTO_HTTPS | \\CURLPROTO_HTTP;\n+        $opts[\\CURLOPT_REDIR_PROTOCOLS] = \\CURLPROTO_HTTPS;\n \n         $ch = curl_init();\n "
        }
      ],
      "file_patterns": {
        "security_files": 1,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 2,
        "max_directory_depth": 5
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "980b1cc40185a862096d6424086bc25c0451ae56",
            "date": "2025-01-14T18:45:13Z",
            "author_login": "yurikuzn"
          },
          {
            "sha": "a0c0b7cd5709654a38ae4b492cc1d6b6ba9f3f4f",
            "date": "2025-01-14T13:03:42Z",
            "author_login": "yurikuzn"
          },
          {
            "sha": "8675478b0a9301415d2afd3d8951bc33036a25b8",
            "date": "2025-01-14T11:44:01Z",
            "author_login": "yurikuzn"
          },
          {
            "sha": "c021466de94a10150a3319e46e56199b2ad43359",
            "date": "2025-01-14T11:01:20Z",
            "author_login": "yurikuzn"
          },
          {
            "sha": "758430ad38120ee39a16fe5fcaf4291e6f5877b2",
            "date": "2025-01-14T10:49:19Z",
            "author_login": "yurikuzn"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 5.3,
    "cvss_vector": "CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:U/C:H/I:N/A:N",
    "cwe_id": "CWE-918",
    "description": "EspoCRM is an Open Source CRM (Customer Relationship Management) software. In affected versions there is Server-Side Request Forgery (SSRF) vulnerability via the upload image from url api. Users who have access to `the /Attachment/fromImageUrl` endpoint can specify URL to point to an internal host. Even though there is check for content type, it can be bypassed by redirects in some cases. This SSRF can be leveraged to disclose internal information (in some cases), target internal hosts and bypass firewalls. This vulnerability has been addressed in commit `c536cee63` which is included in release version 8.0.5. Users are advised to upgrade. There are no known workarounds for this vulnerability.",
    "attack_vector": "NETWORK",
    "attack_complexity": "HIGH"
  },
  "temporal_data": {
    "published_date": "2023-12-05T21:15:07.243",
    "last_modified": "2024-11-21T08:29:11.650",
    "fix_date": "2023-11-06T14:02:13Z"
  },
  "references": [
    {
      "url": "https://github.com/espocrm/espocrm/commit/c536cee6375e2088f961af13db7aaa652c983072",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/espocrm/espocrm/security/advisories/GHSA-g955-rwxx-jvf6",
      "source": "security-advisories@github.com",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://owasp.org/Top10/A10_2021-Server-Side_Request_Forgery_%28SSRF%29/",
      "source": "security-advisories@github.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/espocrm/espocrm/commit/c536cee6375e2088f961af13db7aaa652c983072",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/espocrm/espocrm/security/advisories/GHSA-g955-rwxx-jvf6",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://owasp.org/Top10/A10_2021-Server-Side_Request_Forgery_%28SSRF%29/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:06:41.535089",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "espocrm",
    "owner": "espocrm",
    "created_at": "2014-09-25T13:38:46Z",
    "updated_at": "2025-01-14T13:03:51Z",
    "pushed_at": "2025-01-14T13:03:47Z",
    "size": 79790,
    "stars": 1940,
    "forks": 592,
    "open_issues": 50,
    "watchers": 1940,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "fix",
      "master",
      "stable"
    ],
    "languages": {
      "PHP": 11934707,
      "JavaScript": 5561169,
      "Less": 550393,
      "Smarty": 377691,
      "CSS": 40861,
      "HTML": 2102
    },
    "commit_activity": {
      "total_commits_last_year": 2712,
      "avg_commits_per_week": 52.15384615384615,
      "days_active_last_year": 331
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "agpl-3.0"
    },
    "collected_at": "2025-01-14T13:38:45.084907"
  }
}