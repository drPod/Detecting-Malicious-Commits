{
  "cve_id": "CVE-2023-47272",
  "github_data": {
    "repository": "roundcube/roundcubemail",
    "fix_commit": "5ec496885e18ec6af956e8c0d627856c2257ba2d",
    "related_commits": [
      "5ec496885e18ec6af956e8c0d627856c2257ba2d",
      "5ec496885e18ec6af956e8c0d627856c2257ba2d"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "5ec496885e18ec6af956e8c0d627856c2257ba2d",
      "commit_date": "2023-11-04T16:52:00Z",
      "author": {
        "login": "alecpl",
        "type": "User",
        "stats": {
          "total_commits": 8982,
          "average_weekly_commits": 8.893069306930693,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 825
        }
      },
      "commit_message": {
        "title": "Fix cross-site scripting (XSS) vulnerability in setting Content-Type/Content-Disposition for attachment preview/download",
        "length": 171,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 123,
        "additions": 98,
        "deletions": 25
      },
      "files": [
        {
          "filename": "CHANGELOG.md",
          "status": "modified",
          "additions": 4,
          "deletions": 0,
          "patch": "@@ -2,6 +2,10 @@\n \n ## Unreleased\n \n+- Fix cross-site scripting (XSS) vulnerability in setting Content-Type/Content-Disposition for attachment preview/download\n+\n+## Release 1.5.5\n+\n - Fix cross-site scripting (XSS) vulnerability in handling of SVG in HTML messages (#9168)\n \n ## Release 1.5.4"
        },
        {
          "filename": "program/actions/mail/viewsource.php",
          "status": "modified",
          "additions": 11,
          "deletions": 7,
          "patch": "@@ -45,23 +45,27 @@ public function run($args = [])\n                 $headers = $rcmail->storage->get_message_headers($uid);\n             }\n \n-            $charset = $headers->charset ?: $rcmail->config->get('default_charset');\n+            $charset  = $headers->charset ?: $rcmail->config->get('default_charset');\n+            $filename = '';\n+            $params   = [\n+                'type'         => 'text/plain',\n+                'type_charset' => $charset,\n+            ];\n \n             if (!empty($_GET['_save'])) {\n                 $subject  = rcube_mime::decode_header($headers->subject, $headers->charset);\n                 $filename = self::filename_from_subject(mb_substr($subject, 0, 128));\n                 $filename = ($filename ?: $uid)  . '.eml';\n \n-                $rcmail->output->download_headers($filename, [\n-                        'length'       => $headers->size,\n-                        'type'         => 'text/plain',\n-                        'type_charset' => $charset,\n-                ]);\n+                $params['length'] = $headers->size;\n+                $params['disposition'] = 'attachment';\n             }\n             else {\n-                header(\"Content-Type: text/plain; charset={$charset}\");\n+                $params['disposition'] = 'inline';\n             }\n \n+            $rcmail->output->download_headers($filename, $params);\n+\n             if (isset($part_id) && isset($message)) {\n                 $message->get_part_body($part_id, empty($_GET['_save']), 0, -1);\n             }"
        },
        {
          "filename": "program/lib/Roundcube/rcube_charset.php",
          "status": "modified",
          "additions": 12,
          "deletions": 0,
          "patch": "@@ -177,6 +177,18 @@ class rcube_charset\n         65001 => 'UTF-8',\n     ];\n \n+    /**\n+     * Validate character set identifier.\n+     *\n+     * @param string $input Character set identifier\n+     *\n+     * @return bool True if valid, False if not valid\n+     */\n+    public static function is_valid($input)\n+    {\n+        return is_string($input) && preg_match('|^[a-zA-Z0-9_./:#-]{2,32}$|', $input) > 0;\n+    }\n+\n     /**\n      * Parse and validate charset name string.\n      * Sometimes charset string is malformed, there are also charset aliases,"
        },
        {
          "filename": "program/lib/Roundcube/rcube_imap.php",
          "status": "modified",
          "additions": 5,
          "deletions": 0,
          "patch": "@@ -2156,6 +2156,11 @@ protected function structure_part($part, $count = 0, $parent = '', $mime_headers\n             $struct->charset = $mime_headers->charset;\n         }\n \n+        // Sanitize charset for security\n+        if ($struct->charset && !rcube_charset::is_valid($struct->charset)) {\n+            $struct->charset = '';\n+        }\n+\n         // read content encoding\n         if (!empty($part[5])) {\n             $struct->encoding = strtolower($part[5]);"
        },
        {
          "filename": "program/lib/Roundcube/rcube_output.php",
          "status": "modified",
          "additions": 37,
          "deletions": 17,
          "patch": "@@ -212,7 +212,7 @@ public function common_headers($privacy = true)\n     }\n \n     /**\n-     * Send headers related to file downloads\n+     * Send headers related to file downloads.\n      *\n      * @param string $filename File name\n      * @param array  $params   Optional parameters:\n@@ -225,34 +225,54 @@ public function common_headers($privacy = true)\n      */\n     public function download_headers($filename, $params = [])\n     {\n+        // For security reasons we validate type, filename and charset params.\n+        // Some HTTP servers might drop a header that is malformed or very long, this then\n+        // can lead to web browsers unintentionally executing javascript code in the body.\n+\n         if (empty($params['disposition'])) {\n             $params['disposition'] = 'attachment';\n         }\n \n-        if ($params['disposition'] == 'inline' && stripos($params['type'], 'text') === 0) {\n-            $params['type'] .= '; charset=' . ($params['type_charset'] ?: $this->charset);\n+        $ctype       = 'application/octet-stream';\n+        $disposition = $params['disposition'];\n+\n+        if (!empty($params['type']) && is_string($params['type']) && strlen($params['type']) < 256\n+            && preg_match('/^[a-z0-9!#$&.+^_-]+\\/[a-z0-9!#$&.+^_-]+$/i', $params['type'])\n+        ) {\n+            $ctype = $params['type'];\n         }\n \n-        header(\"Content-Type: \" . (!empty($params['type']) ? $params['type'] : \"application/octet-stream\"));\n+        if ($disposition == 'inline' && stripos($ctype, 'text') === 0) {\n+            $charset = $this->charset;\n+            if (!empty($params['type_charset']) && rcube_charset::is_valid($params['type_charset'])) {\n+                $charset = $params['type_charset'];\n+            }\n \n-        if ($params['disposition'] == 'attachment' && $this->browser->ie) {\n-            header(\"Content-Type: application/force-download\");\n+            $ctype .= \"; charset={$charset}\";\n         }\n \n-        $disposition = \"Content-Disposition: \" . $params['disposition'];\n+        if (is_string($filename) && strlen($filename) > 0 && strlen($filename) <= 1024) {\n+            // For non-ascii characters we'll use RFC2231 syntax\n+            if (!preg_match('/[^a-zA-Z0-9_.:,?;@+ -]/', $filename)) {\n+                $disposition .= \"; filename=\\\"{$filename}\\\"\";\n+            }\n+            else {\n+                $filename = rawurlencode($filename);\n+                $charset  = $this->charset;\n+                if (!empty($params['charset']) && rcube_charset::is_valid($params['charset'])) {\n+                    $charset = $params['charset'];\n+                }\n \n-        // For non-ascii characters we'll use RFC2231 syntax\n-        if (!preg_match('/[^a-zA-Z0-9_.:,?;@+ -]/', $filename)) {\n-            $disposition .= sprintf(\"; filename=\\\"%s\\\"\", $filename);\n-        }\n-        else {\n-            $disposition .= sprintf(\"; filename*=%s''%s\",\n-                !empty($params['charset']) ? $params['charset'] : $this->charset,\n-                rawurlencode($filename)\n-            );\n+                $disposition .= \"; filename*={$charset}''{$filename}\";\n+            }\n         }\n \n-        header($disposition);\n+        header(\"Content-Disposition: {$disposition}\");\n+        header(\"Content-Type: {$ctype}\");\n+\n+        if ($params['disposition'] == 'attachment' && $this->browser->ie) {\n+            header(\"Content-Type: application/force-download\");\n+        }\n \n         if (isset($params['length'])) {\n             header(\"Content-Length: \" . $params['length']);"
        },
        {
          "filename": "tests/Framework/Charset.php",
          "status": "modified",
          "additions": 29,
          "deletions": 1,
          "patch": "@@ -8,7 +8,6 @@\n  */\n class Framework_Charset extends PHPUnit\\Framework\\TestCase\n {\n-\n     /**\n      * Data for test_clean()\n      */\n@@ -33,6 +32,35 @@ function test_clean($input, $output)\n         $this->assertSame($output, rcube_charset::clean($input));\n     }\n \n+    /**\n+     * Data for test_is_valid()\n+     */\n+    function data_is_valid()\n+    {\n+        $list = [];\n+        foreach (mb_list_encodings() as $charset) {\n+            $list[] = [$charset, true];\n+        }\n+\n+        return array_merge($list, [\n+            ['', false],\n+            ['a', false],\n+            ['aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa', false],\n+            [null, false],\n+\n+            ['TCVN5712-1:1993', true],\n+            ['JUS_I.B1.002', true],\n+        ]);\n+    }\n+\n+    /**\n+     * @dataProvider data_is_valid\n+     */\n+    function test_is_valid($input, $result)\n+    {\n+        $this->assertSame($result, rcube_charset::is_valid($input));\n+    }\n+\n     /**\n      * Data for test_parse_charset()\n      */"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 4,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "2f051c015418e1f4f6ad3bc6d0b5d1b3f5c7f58b",
            "date": "2025-01-17T12:22:47Z",
            "author_login": "alecpl"
          },
          {
            "sha": "dbbde7584e8125fcdeb424021bb7a78d507d473b",
            "date": "2025-01-16T09:58:20Z",
            "author_login": "alecpl"
          },
          {
            "sha": "d877302e50dabf6b00aad811bfd6fec5b466859d",
            "date": "2025-01-15T17:27:05Z",
            "author_login": "pabzm"
          },
          {
            "sha": "a677d26a27b9248da19dd4c3037e7bd737f103c7",
            "date": "2025-01-14T11:17:37Z",
            "author_login": "alecpl"
          },
          {
            "sha": "6e216b588a6f7797f4365fd8c57d46eff2671e39",
            "date": "2025-01-08T10:33:56Z",
            "author_login": "alecpl"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.1,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N",
    "cwe_id": "CWE-79",
    "description": "Roundcube 1.5.x before 1.5.6 and 1.6.x before 1.6.5 allows XSS via a Content-Type or Content-Disposition header (used for attachment preview or download).",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-11-06T00:15:09.380",
    "last_modified": "2024-11-21T08:30:05.950",
    "fix_date": "2023-11-04T16:52:00Z"
  },
  "references": [
    {
      "url": "https://github.com/roundcube/roundcubemail/commit/5ec496885e18ec6af956e8c0d627856c2257ba2d",
      "source": "cve@mitre.org",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/roundcube/roundcubemail/releases/tag/1.5.6",
      "source": "cve@mitre.org",
      "tags": [
        "Release Notes"
      ]
    },
    {
      "url": "https://github.com/roundcube/roundcubemail/releases/tag/1.6.5",
      "source": "cve@mitre.org",
      "tags": [
        "Release Notes"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2023/12/msg00005.html",
      "source": "cve@mitre.org",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/GILSR762MJB3BNJOVOCMW2JXEPV46IIQ/",
      "source": "cve@mitre.org",
      "tags": [
        "Mailing List"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/YFRGBPET73URF6364CI547ZVWQESJLGK/",
      "source": "cve@mitre.org",
      "tags": [
        "Mailing List"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/Z4F4DUA3Q46ZVB2RD7BFP4XMNS4RYFFQ/",
      "source": "cve@mitre.org",
      "tags": [
        "Mailing List"
      ]
    },
    {
      "url": "https://www.debian.org/security/2023/dsa-5572",
      "source": "cve@mitre.org",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/roundcube/roundcubemail/commit/5ec496885e18ec6af956e8c0d627856c2257ba2d",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/roundcube/roundcubemail/releases/tag/1.5.6",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes"
      ]
    },
    {
      "url": "https://github.com/roundcube/roundcubemail/releases/tag/1.6.5",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Release Notes"
      ]
    },
    {
      "url": "https://lists.debian.org/debian-lts-announce/2023/12/msg00005.html",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/GILSR762MJB3BNJOVOCMW2JXEPV46IIQ/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/YFRGBPET73URF6364CI547ZVWQESJLGK/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List"
      ]
    },
    {
      "url": "https://lists.fedoraproject.org/archives/list/package-announce%40lists.fedoraproject.org/message/Z4F4DUA3Q46ZVB2RD7BFP4XMNS4RYFFQ/",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Mailing List"
      ]
    },
    {
      "url": "https://www.debian.org/security/2023/dsa-5572",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:06:36.988295",
    "processing_status": "enhanced"
  },
  "repository_context": {
    "name": "roundcubemail",
    "owner": "roundcube",
    "created_at": "2012-05-04T11:19:01Z",
    "updated_at": "2025-01-25T19:16:15Z",
    "pushed_at": "2025-01-17T12:23:44Z",
    "size": 63779,
    "stars": 6028,
    "forks": 1654,
    "open_issues": 432,
    "watchers": 6028,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "master"
    ],
    "languages": {
      "PHP": 11751774,
      "JavaScript": 897068,
      "Less": 203586,
      "HTML": 108454,
      "CSS": 15056,
      "Shell": 8435,
      "Makefile": 4920,
      "Perl": 2649,
      "Rich Text Format": 1958,
      "C": 1603,
      "Dockerfile": 1175,
      "Python": 749
    },
    "commit_activity": {
      "total_commits_last_year": 289,
      "avg_commits_per_week": 5.5576923076923075,
      "days_active_last_year": 115
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "gpl-3.0"
    },
    "collected_at": "2025-01-26T07:43:27.713204"
  }
}