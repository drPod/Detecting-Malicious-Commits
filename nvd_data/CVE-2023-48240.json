{
  "cve_id": "CVE-2023-48240",
  "github_data": {
    "repository": "xwiki/xwiki-platform",
    "fix_commit": "bff0203e739b6e3eb90af5736f04278c73c2a8bb",
    "related_commits": [
      "bff0203e739b6e3eb90af5736f04278c73c2a8bb",
      "bff0203e739b6e3eb90af5736f04278c73c2a8bb"
    ],
    "patch_url": "https://github.com/xwiki/xwiki-platform/commit/bff0203e739b6e3eb90af5736f04278c73c2a8bb.patch",
    "fix_commit_details": {
      "sha": "bff0203e739b6e3eb90af5736f04278c73c2a8bb",
      "commit_date": "2023-04-25T13:42:05Z",
      "author": {
        "login": "michitux",
        "type": "User",
        "stats": {
          "total_commits": 378,
          "average_weekly_commits": 0.39622641509433965,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 108
        }
      },
      "commit_message": {
        "title": "XWIKI-20818: Improve data URI converter",
        "length": 451,
        "has_description": true,
        "references_issue": false
      },
      "stats": {
        "total": 1362,
        "additions": 1305,
        "deletions": 57
      },
      "files": [
        {
          "filename": "xwiki-platform-core/xwiki-platform-diff/xwiki-platform-diff-xml/pom.xml",
          "status": "modified",
          "additions": 23,
          "deletions": 1,
          "patch": "@@ -31,9 +31,13 @@\n   <name>XWiki Platform - Diff - XML</name>\n   <description>XWiki Platform - Diff - XML</description>\n   <properties>\n-    <xwiki.jacoco.instructionRatio>0.00</xwiki.jacoco.instructionRatio>\n+    <xwiki.jacoco.instructionRatio>0.77</xwiki.jacoco.instructionRatio>\n   </properties>\n   <dependencies>\n+    <dependency>\n+      <groupId>org.apache.httpcomponents.client5</groupId>\n+      <artifactId>httpclient5</artifactId>\n+    </dependency>\n     <dependency>\n       <groupId>org.xwiki.commons</groupId>\n       <artifactId>xwiki-commons-diff-xml</artifactId>\n@@ -44,9 +48,27 @@\n       <artifactId>xwiki-platform-oldcore</artifactId>\n       <version>${project.version}</version>\n     </dependency>\n+    <dependency>\n+      <groupId>org.xwiki.platform</groupId>\n+      <artifactId>xwiki-platform-security-authentication-api</artifactId>\n+      <version>${project.version}</version>\n+    </dependency>\n     <dependency>\n       <groupId>javax.servlet</groupId>\n       <artifactId>javax.servlet-api</artifactId>\n     </dependency>\n+    <dependency>\n+      <groupId>org.xwiki.commons</groupId>\n+      <artifactId>xwiki-commons-tool-test-component</artifactId>\n+      <version>${commons.version}</version>\n+      <scope>test</scope>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.xwiki.platform</groupId>\n+      <artifactId>xwiki-platform-oldcore</artifactId>\n+      <version>${project.version}</version>\n+      <scope>test</scope>\n+      <type>test-jar</type>\n+    </dependency>\n   </dependencies>\n </project>\n\\ No newline at end of file"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-diff/xwiki-platform-diff-xml/src/main/java/org/xwiki/diff/xml/XMLDiffDataURIConverterConfiguration.java",
          "status": "added",
          "additions": 51,
          "deletions": 0,
          "patch": "@@ -0,0 +1,51 @@\n+/*\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+package org.xwiki.diff.xml;\n+\n+import org.xwiki.component.annotation.Role;\n+import org.xwiki.stability.Unstable;\n+\n+/**\n+ * Configuration for the data URI converter in the XML diff module.\n+ *\n+ * @since 14.10.15\n+ * @since 15.5.1\n+ * @since 15.6\n+ * @version $Id$\n+ */\n+@Unstable\n+@Role\n+public interface XMLDiffDataURIConverterConfiguration\n+{\n+    /**\n+     * @return the timeout to use when fetching data from the web to embed as data URI\n+     */\n+    int getHTTPTimeout();\n+\n+    /**\n+     * @return the maximum size of the data to embed as data URI\n+     */\n+    long getMaximumContentSize();\n+\n+    /**\n+     * @return true if the data URI converter is enabled\n+     */\n+    boolean isEnabled();\n+}"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-diff/xwiki-platform-diff-xml/src/main/java/org/xwiki/diff/xml/internal/DefaultDataURIConverter.java",
          "status": "modified",
          "additions": 130,
          "deletions": 56,
          "patch": "@@ -21,7 +21,6 @@\n \n import java.io.IOException;\n import java.net.MalformedURLException;\n-import java.net.URI;\n import java.net.URISyntaxException;\n import java.net.URL;\n import java.util.Base64;\n@@ -30,121 +29,196 @@\n import javax.inject.Provider;\n import javax.inject.Singleton;\n \n-import org.apache.commons.io.IOUtils;\n-import org.apache.commons.lang3.StringUtils;\n-import org.apache.http.HttpEntity;\n-import org.apache.http.HttpStatus;\n-import org.apache.http.StatusLine;\n-import org.apache.http.client.methods.CloseableHttpResponse;\n-import org.apache.http.client.methods.HttpGet;\n-import org.apache.http.impl.client.CloseableHttpClient;\n-import org.apache.http.impl.client.HttpClientBuilder;\n import org.xwiki.cache.Cache;\n import org.xwiki.cache.CacheManager;\n import org.xwiki.cache.config.CacheConfiguration;\n+import org.xwiki.cache.eviction.EntryEvictionConfiguration;\n import org.xwiki.cache.eviction.LRUEvictionConfiguration;\n import org.xwiki.component.annotation.Component;\n+import org.xwiki.component.phase.Disposable;\n import org.xwiki.component.phase.Initializable;\n import org.xwiki.component.phase.InitializationException;\n import org.xwiki.diff.DiffException;\n+import org.xwiki.diff.xml.XMLDiffDataURIConverterConfiguration;\n+import org.xwiki.url.URLSecurityManager;\n+import org.xwiki.user.CurrentUserReference;\n+import org.xwiki.user.UserReferenceSerializer;\n \n+import com.xpn.xwiki.XWiki;\n import com.xpn.xwiki.XWikiContext;\n-import com.xpn.xwiki.web.XWikiRequest;\n+import com.xpn.xwiki.XWikiException;\n \n /**\n- * Default implementation of {@link DataURIConverter}.\n- * \n+ * Default Implementation of {@link DataURIConverter} that uses an HTTP client to embed images.\n+ *\n  * @version $Id$\n  * @since 11.10.1\n  * @since 12.0RC1\n  */\n @Component\n @Singleton\n-public class DefaultDataURIConverter implements DataURIConverter, Initializable\n+public class DefaultDataURIConverter implements Initializable, Disposable, DataURIConverter\n {\n-    private static final String HEADER_COOKIE = \"Cookie\";\n-\n     @Inject\n     private Provider<XWikiContext> xcontextProvider;\n \n     @Inject\n     private CacheManager cacheManager;\n \n+    @Inject\n+    private URLSecurityManager urlSecurityManager;\n+\n+    @Inject\n+    private UserReferenceSerializer<String> userReferenceSerializer;\n+\n+    @Inject\n+    private ImageDownloader imageDownloader;\n+\n+    @Inject\n+    private XMLDiffDataURIConverterConfiguration configuration;\n+\n     private Cache<String> cache;\n \n+    private Cache<DiffException> failureCache;\n+\n     @Override\n     public void initialize() throws InitializationException\n     {\n+        if (!this.configuration.isEnabled()) {\n+            return;\n+        }\n+\n         CacheConfiguration cacheConfig = new CacheConfiguration();\n         cacheConfig.setConfigurationId(\"diff.html.dataURI\");\n         LRUEvictionConfiguration lru = new LRUEvictionConfiguration();\n         lru.setMaxEntries(100);\n-        cacheConfig.put(LRUEvictionConfiguration.CONFIGURATIONID, lru);\n+        cacheConfig.put(EntryEvictionConfiguration.CONFIGURATIONID, lru);\n+\n+        CacheConfiguration failureCacheConfiguration = new CacheConfiguration();\n+        failureCacheConfiguration.setConfigurationId(\"diff.html.dataURIFailureCache\");\n+        LRUEvictionConfiguration failureLRU = new LRUEvictionConfiguration();\n+        failureLRU.setMaxEntries(1000);\n+        // Cache failures for an hour. This is to avoid hammering the server with requests for images that don't\n+        // exist or are inaccessible or too large.\n+        failureLRU.setLifespan(3600);\n+        failureCacheConfiguration.put(EntryEvictionConfiguration.CONFIGURATIONID, failureLRU);\n+\n         try {\n             this.cache = this.cacheManager.createNewCache(cacheConfig);\n+            this.failureCache = this.cacheManager.createNewCache(failureCacheConfiguration);\n         } catch (Exception e) {\n+            // Dispose the cache if it has been created.\n+            if (this.cache != null) {\n+                this.cache.dispose();\n+            }\n             throw new InitializationException(\"Failed to create the Data URI cache.\", e);\n         }\n     }\n \n     @Override\n-    public String convert(String url) throws DiffException\n+    public void dispose()\n     {\n-        if (url.startsWith(\"data:\")) {\n-            // Already data URI.\n-            return url;\n+        if (this.cache != null) {\n+            this.cache.dispose();\n+        }\n+        if (this.failureCache != null) {\n+            this.failureCache.dispose();\n         }\n+    }\n \n-        String cachedDataURI = this.cache.get(url);\n-        if (cachedDataURI == null) {\n-            try {\n-                cachedDataURI = convert(getAbsoluteURI(url));\n-                this.cache.set(url, cachedDataURI);\n-            } catch (IOException | URISyntaxException e) {\n-                throw new DiffException(\"Failed to convert [\" + url + \"] to data URI.\", e);\n+    /**\n+     * Convert the given URL to an absolute URL using the request URL from the given context.\n+     *\n+     * @param url the URL to convert\n+     * @param xcontext the XWiki context\n+     * @return the absolute URL\n+     * @throws DiffException if the URL cannot be converted due to being malformed\n+     */\n+    protected URL getAbsoluteURL(String url, XWikiContext xcontext) throws DiffException\n+    {\n+        URL absoluteURL;\n+        try {\n+            if (xcontext.getRequest() != null) {\n+                URL requestURL = XWiki.getRequestURL(xcontext.getRequest());\n+                absoluteURL = new URL(requestURL, url);\n+            } else {\n+                absoluteURL = new URL(url);\n             }\n+        } catch (MalformedURLException | XWikiException e) {\n+            throw new DiffException(String.format(\"Failed to resolve [%s] to an absolute URL.\", url), e);\n         }\n-\n-        return cachedDataURI;\n+        return absoluteURL;\n     }\n \n-    private URL getAbsoluteURI(String relativeURL) throws MalformedURLException\n+    /**\n+     * Get a data URI for the given content and content type.\n+     *\n+     * @param contentType the content type\n+     * @param content the content\n+     * @return the data URI\n+     */\n+    protected static String getDataURI(String contentType, byte[] content)\n     {\n-        XWikiContext xcontext = this.xcontextProvider.get();\n-        URL baseURL = xcontext.getURLFactory().getServerURL(xcontext);\n-        return new URL(baseURL, relativeURL);\n+        return String.format(\"data:%s;base64,%s\", contentType, Base64.getEncoder().encodeToString(content));\n     }\n \n-    private String convert(URL url) throws IOException, URISyntaxException\n+    /**\n+     * Compute a cache key based on the current user and the URL.\n+     *\n+     * @param url the url\n+     * @return the cache key\n+     */\n+    private String getCacheKey(URL url)\n     {\n-        HttpEntity entity = fetch(url.toURI());\n-        // Remove the content type parameters, such as the charset, so they don't influence the diff.\n-        String contentType = StringUtils.substringBefore(entity.getContentType().getValue(), \";\");\n-        byte[] content = IOUtils.toByteArray(entity.getContent());\n-        return String.format(\"data:%s;base64,%s\", contentType, Base64.getEncoder().encodeToString(content));\n+        String userPart = this.userReferenceSerializer.serialize(CurrentUserReference.INSTANCE);\n+        // Prepend the length of the user part to avoid any kind of confusion between user and URL.\n+        return String.format(\"%d:%s:%s\", userPart.length(), userPart, url.toString());\n     }\n \n-    private HttpEntity fetch(URI uri) throws IOException\n+    @Override\n+    public String convert(String url) throws DiffException\n     {\n-        HttpClientBuilder httpClientBuilder = HttpClientBuilder.create();\n-        httpClientBuilder.useSystemProperties();\n-        httpClientBuilder.setUserAgent(\"XWikiHTMLDiff\");\n+        if (url.startsWith(\"data:\") || !this.configuration.isEnabled()) {\n+            // Already data URI.\n+            return url;\n+        }\n+\n+        // Convert URL to absolute URL to avoid issues with relative URLs that might reference different images\n+        // in different subwikis.\n+        URL absoluteURL = getAbsoluteURL(url, this.xcontextProvider.get());\n \n-        CloseableHttpClient httpClient = httpClientBuilder.build();\n-        HttpGet getMethod = new HttpGet(uri);\n+        String cacheKey = getCacheKey(absoluteURL);\n \n-        XWikiRequest request = this.xcontextProvider.get().getRequest();\n-        if (request != null) {\n-            // Copy the cookies from the current request.\n-            getMethod.setHeader(HEADER_COOKIE, request.getHeader(HEADER_COOKIE));\n+        try {\n+            String dataURI = this.cache.get(cacheKey);\n+\n+            if (dataURI == null) {\n+                DiffException failure = this.failureCache.get(cacheKey);\n+\n+                if (failure != null) {\n+                    throw failure;\n+                }\n+\n+                dataURI = convert(absoluteURL);\n+                this.cache.set(cacheKey, dataURI);\n+            }\n+\n+            return dataURI;\n+        } catch (IOException | URISyntaxException e) {\n+            DiffException diffException = new DiffException(\"Failed to convert [\" + url + \"] to data URI.\", e);\n+            this.failureCache.set(cacheKey, diffException);\n+            throw diffException;\n         }\n+    }\n \n-        CloseableHttpResponse response = httpClient.execute(getMethod);\n-        StatusLine statusLine = response.getStatusLine();\n-        if (statusLine.getStatusCode() == HttpStatus.SC_OK) {\n-            return response.getEntity();\n-        } else {\n-            throw new IOException(statusLine.getStatusCode() + \" \" + statusLine.getReasonPhrase());\n+    private String convert(URL url) throws IOException, URISyntaxException\n+    {\n+        if (!this.urlSecurityManager.isDomainTrusted(url)) {\n+            throw new IOException(String.format(\"The URL [%s] is not trusted.\", url));\n         }\n+\n+        ImageDownloader.DownloadResult downloadResult = this.imageDownloader.download(url.toURI());\n+\n+        return getDataURI(downloadResult.getContentType(), downloadResult.getData());\n     }\n }"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-diff/xwiki-platform-diff-xml/src/main/java/org/xwiki/diff/xml/internal/DefaultXMLDiffDataURIConverterConfiguration.java",
          "status": "added",
          "additions": 71,
          "deletions": 0,
          "patch": "@@ -0,0 +1,71 @@\n+/*\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+package org.xwiki.diff.xml.internal;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+import javax.inject.Singleton;\n+\n+import org.xwiki.component.annotation.Component;\n+import org.xwiki.configuration.ConfigurationSource;\n+import org.xwiki.diff.xml.XMLDiffDataURIConverterConfiguration;\n+\n+/**\n+ * Configuration for the XML diff.\n+ *\n+ * @version $Id$\n+ * @since 14.10.15\n+ * @since 15.5.1\n+ * @since 15.6\n+ */\n+@Component\n+@Singleton\n+public class DefaultXMLDiffDataURIConverterConfiguration implements XMLDiffDataURIConverterConfiguration\n+{\n+    private static final String PREFIX = \"diff.xml.dataURI\";\n+\n+    @Inject\n+    @Named(\"xwikiproperties\")\n+    private ConfigurationSource configurationSource;\n+\n+    @Override\n+    public int getHTTPTimeout()\n+    {\n+        return this.configurationSource.getProperty(getFullKeyName(\"httpTimeout\"), Integer.class, 10);\n+    }\n+\n+    @Override\n+    public long getMaximumContentSize()\n+    {\n+        return this.configurationSource.getProperty(getFullKeyName(\"maximumContentSize\"), Long.class, 1024L * 1024L);\n+    }\n+\n+    @Override\n+    public boolean isEnabled()\n+    {\n+        return this.configurationSource.getProperty(getFullKeyName(\"enabled\"), Boolean.class, true);\n+    }\n+\n+    private String getFullKeyName(String shortKeyName)\n+    {\n+        return String.format(\"%s.%s\", PREFIX, shortKeyName);\n+    }\n+\n+}"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-diff/xwiki-platform-diff-xml/src/main/java/org/xwiki/diff/xml/internal/HttpClientBuilderFactory.java",
          "status": "added",
          "additions": 73,
          "deletions": 0,
          "patch": "@@ -0,0 +1,73 @@\n+/*\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+package org.xwiki.diff.xml.internal;\n+\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+import org.apache.hc.client5.http.config.ConnectionConfig;\n+import org.apache.hc.client5.http.config.RequestConfig;\n+import org.apache.hc.client5.http.impl.classic.HttpClientBuilder;\n+import org.apache.hc.client5.http.impl.io.BasicHttpClientConnectionManager;\n+import org.apache.hc.core5.util.Timeout;\n+import org.xwiki.component.annotation.Component;\n+import org.xwiki.diff.xml.XMLDiffDataURIConverterConfiguration;\n+\n+/**\n+ * Simple factory for HttpClientBuilder to help testing and set basic properties including user agent and timeouts.\n+ *\n+ * @since 14.10.15\n+ * @since 15.5.1\n+ * @since 15.6\n+ * @version $Id$\n+ */\n+@Component(roles = HttpClientBuilderFactory.class)\n+@Singleton\n+public class HttpClientBuilderFactory\n+{\n+    @Inject\n+    private XMLDiffDataURIConverterConfiguration configuration;\n+\n+    /**\n+     * @return a new HTTPClientBuilder\n+     */\n+    public HttpClientBuilder create()\n+    {\n+        HttpClientBuilder result = HttpClientBuilder.create();\n+        result.useSystemProperties();\n+        result.setUserAgent(\"XWikiHTMLDiff\");\n+\n+        // Set the connection timeout.\n+        Timeout timeout = Timeout.ofSeconds(this.configuration.getHTTPTimeout());\n+        ConnectionConfig connectionConfig = ConnectionConfig.custom()\n+            .setConnectTimeout(timeout)\n+            .setSocketTimeout(timeout)\n+            .build();\n+\n+        BasicHttpClientConnectionManager cm = new BasicHttpClientConnectionManager();\n+        cm.setConnectionConfig(connectionConfig);\n+        result.setConnectionManager(cm);\n+\n+        // Set the response timeout.\n+        result.setDefaultRequestConfig(RequestConfig.custom().setResponseTimeout(timeout).build());\n+\n+        return result;\n+    }\n+}"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-diff/xwiki-platform-diff-xml/src/main/java/org/xwiki/diff/xml/internal/ImageDownloader.java",
          "status": "added",
          "additions": 205,
          "deletions": 0,
          "patch": "@@ -0,0 +1,205 @@\n+/*\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+package org.xwiki.diff.xml.internal;\n+\n+import java.io.IOException;\n+import java.net.URI;\n+import java.util.Optional;\n+\n+import javax.inject.Inject;\n+import javax.inject.Provider;\n+import javax.inject.Singleton;\n+import javax.servlet.http.HttpServletRequest;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.io.input.BoundedInputStream;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.hc.client5.http.classic.methods.HttpGet;\n+import org.apache.hc.client5.http.impl.classic.CloseableHttpClient;\n+import org.apache.hc.client5.http.impl.classic.HttpClientBuilder;\n+import org.apache.hc.core5.http.ClassicHttpResponse;\n+import org.apache.hc.core5.http.HttpEntity;\n+import org.apache.hc.core5.http.HttpStatus;\n+import org.xwiki.component.annotation.Component;\n+import org.xwiki.diff.xml.XMLDiffDataURIConverterConfiguration;\n+import org.xwiki.security.authentication.AuthenticationConfiguration;\n+\n+import com.xpn.xwiki.XWikiContext;\n+import com.xpn.xwiki.web.XWikiRequest;\n+\n+/**\n+ * Component for downloading images from a URL with the given cookies.\n+ *\n+ * @since 14.10.15\n+ * @since 15.5.1\n+ * @since 15.6\n+ * @version $Id$\n+ */\n+@Component(roles = ImageDownloader.class)\n+@Singleton\n+public class ImageDownloader\n+{\n+    private static final String COOKIE_DOMAIN_PREFIX = \".\";\n+\n+    private static final String HEADER_COOKIE = \"Cookie\";\n+\n+    @Inject\n+    private HttpClientBuilderFactory httpClientBuilderFactory;\n+\n+    @Inject\n+    private Provider<XWikiContext> xcontextProvider;\n+\n+    @Inject\n+    private XMLDiffDataURIConverterConfiguration configuration;\n+\n+    @Inject\n+    private AuthenticationConfiguration authenticationConfiguration;\n+\n+    /**\n+     * The result of a download request.\n+     */\n+    public static class DownloadResult\n+    {\n+        private final byte[] data;\n+\n+        private final String contentType;\n+\n+        /**\n+         * @param data the downloaded data\n+         * @param contentType the MIME type of the downloaded data\n+         */\n+        public DownloadResult(byte[] data, String contentType)\n+        {\n+            this.data = data;\n+            this.contentType = contentType;\n+        }\n+\n+        /**\n+         * @return the downloaded data\n+         */\n+        public byte[] getData()\n+        {\n+            return this.data;\n+        }\n+\n+        /**\n+         * @return the MIME type of the downloaded data\n+         */\n+        public String getContentType()\n+        {\n+            return this.contentType;\n+        }\n+    }\n+\n+    /**\n+     * Download the image from the given URL with the cookies from the current request.\n+     *\n+     * @param uri the URL of the image\n+     * @return the image as a byte array\n+     * @throws IOException if there was an error downloading the image\n+     */\n+    public DownloadResult download(URI uri) throws IOException\n+    {\n+        HttpClientBuilder httpClientBuilder = this.httpClientBuilderFactory.create();\n+\n+        HttpGet getMethod = initializeGetMethod(uri);\n+\n+        try (CloseableHttpClient httpClient = httpClientBuilder.build()) {\n+            return httpClient.execute(getMethod, response -> handleResponse(uri, response));\n+        }\n+    }\n+\n+    private DownloadResult handleResponse(URI uri, ClassicHttpResponse response) throws IOException\n+    {\n+        if (response.getCode() == HttpStatus.SC_OK) {\n+            HttpEntity entity = response.getEntity();\n+            // Remove the content type parameters, such as the charset, so they don't influence the diff.\n+            String contentType = entity.getContentType();\n+            contentType = StringUtils.substringBefore(contentType, \";\");\n+\n+            if (!StringUtils.startsWith(contentType, \"image/\")) {\n+                throw new IOException(String.format(\"The content of [%s] is not an image.\", uri));\n+            }\n+\n+            long maximumSize = this.configuration.getMaximumContentSize();\n+            if (maximumSize > 0 && entity.getContentLength() > maximumSize) {\n+                throw new IOException(String.format(\"The content length of [%s] is too big.\", uri));\n+            }\n+\n+            byte[] content;\n+            if (maximumSize > 0) {\n+                // The content length is not always available (then it is negative), so we need to use a bounded\n+                // input stream to make sure we don't read more than the maximum size.\n+                try (BoundedInputStream boundedInputStream = new BoundedInputStream(entity.getContent(),\n+                    maximumSize))\n+                {\n+                    content = IOUtils.toByteArray(boundedInputStream);\n+                }\n+\n+                if (content.length == maximumSize) {\n+                    throw new IOException(String.format(\"The content of [%s] is too big.\", uri));\n+                }\n+            } else {\n+                content = IOUtils.toByteArray(entity.getContent());\n+            }\n+\n+            return new DownloadResult(content, contentType);\n+        } else {\n+            throw new IOException(response.getCode() + \" \" + response.getReasonPhrase());\n+        }\n+    }\n+\n+    private HttpGet initializeGetMethod(URI uri)\n+    {\n+        HttpGet getMethod = new HttpGet(uri);\n+\n+        XWikiRequest request = this.xcontextProvider.get().getRequest();\n+        if (request != null && matchesCookieDomain(uri.getHost(), request)) {\n+            // Copy the cookie header from the current request.\n+            getMethod.setHeader(HEADER_COOKIE, request.getHeader(HEADER_COOKIE));\n+        }\n+\n+        return getMethod;\n+    }\n+\n+    /**\n+     * @return if the host matches the cookie domain of the current request\n+     */\n+    private boolean matchesCookieDomain(String host, HttpServletRequest request)\n+    {\n+        String serverName = request.getServerName();\n+        // Add a leading dot to avoid matching domains that are longer versions of the cookie domain and to ensure\n+        // that the cookie domain itself is matched as the cookie domain also contains the leading dot. Always add\n+        // the dot as two dots will still match.\n+        String prefixedServerName = COOKIE_DOMAIN_PREFIX + serverName;\n+\n+        Optional<String> cookieDomain =\n+            this.authenticationConfiguration.getCookieDomains().stream()\n+                .filter(prefixedServerName::endsWith)\n+                .findFirst();\n+\n+        // If there is a cookie domain, check if the host also matches it.\n+        return cookieDomain.map((COOKIE_DOMAIN_PREFIX + host)::endsWith)\n+            // If no cookie domain is configured, check for an exact match with the server name as no domain is sent in\n+            // this case and thus the cookie isn't valid for subdomains.\n+            .orElseGet(() -> host.equals(serverName));\n+    }\n+\n+}"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-diff/xwiki-platform-diff-xml/src/main/resources/META-INF/components.txt",
          "status": "modified",
          "additions": 3,
          "deletions": 0,
          "patch": "@@ -1 +1,4 @@\n org.xwiki.diff.xml.internal.DefaultDataURIConverter\n+org.xwiki.diff.xml.internal.HttpClientBuilderFactory\n+org.xwiki.diff.xml.internal.ImageDownloader\n+org.xwiki.diff.xml.internal.DefaultXMLDiffDataURIConverterConfiguration"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-diff/xwiki-platform-diff-xml/src/test/java/org/xwiki/diff/xml/internal/DefaultDataURIConverterTest.java",
          "status": "added",
          "additions": 239,
          "deletions": 0,
          "patch": "@@ -0,0 +1,239 @@\n+/*\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+package org.xwiki.diff.xml.internal;\n+\n+import java.io.IOException;\n+import java.net.MalformedURLException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.util.List;\n+import java.util.Map;\n+\n+import javax.inject.Provider;\n+\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.xwiki.cache.Cache;\n+import org.xwiki.cache.CacheException;\n+import org.xwiki.cache.CacheManager;\n+import org.xwiki.cache.config.CacheConfiguration;\n+import org.xwiki.diff.DiffException;\n+import org.xwiki.diff.xml.XMLDiffDataURIConverterConfiguration;\n+import org.xwiki.test.annotation.BeforeComponent;\n+import org.xwiki.test.junit5.mockito.ComponentTest;\n+import org.xwiki.test.junit5.mockito.InjectMockComponents;\n+import org.xwiki.test.junit5.mockito.MockComponent;\n+import org.xwiki.url.URLSecurityManager;\n+import org.xwiki.user.CurrentUserReference;\n+import org.xwiki.user.UserReferenceSerializer;\n+\n+import com.xpn.xwiki.XWikiContext;\n+import com.xpn.xwiki.web.XWikiServletRequestStub;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertThrows;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+/**\n+ * Unit tests for {@link DefaultDataURIConverter}.\n+ *\n+ * @version $Id$\n+ */\n+@ComponentTest\n+class DefaultDataURIConverterTest\n+{\n+    private static final String CURRENT_USER = \"XWiki.CurrentUser\";\n+\n+    private static final String CACHE_PREFIX = CURRENT_USER.length() + \":\" + CURRENT_USER + \":\";\n+\n+    private static final String URL_PREFIX = \"http://localhost:8080\";\n+\n+    @MockComponent\n+    private ImageDownloader imageDownloader;\n+\n+    @MockComponent\n+    private CacheManager cacheManager;\n+\n+    @MockComponent\n+    private Provider<XWikiContext> xwikiContextProvider;\n+\n+    @MockComponent\n+    private URLSecurityManager urlSecurityManager;\n+\n+    private Cache<String> cache;\n+\n+    private Cache<DiffException> failureCache;\n+\n+    @MockComponent\n+    private UserReferenceSerializer<String> userReferenceSerializer;\n+\n+    @MockComponent\n+    private XMLDiffDataURIConverterConfiguration configuration;\n+\n+    @InjectMockComponents\n+    private DefaultDataURIConverter converter;\n+\n+    @BeforeComponent\n+    public void configureCacheManager() throws CacheException\n+    {\n+        this.cache = mock();\n+        this.failureCache = mock();\n+\n+        when(this.configuration.isEnabled()).thenReturn(true);\n+\n+        when(this.cacheManager.createNewCache(any())).then(invocationOnMock -> {\n+            CacheConfiguration cacheConfiguration = invocationOnMock.getArgument(0);\n+            if (\"diff.html.dataURI\".equals(cacheConfiguration.getConfigurationId())) {\n+                return this.cache;\n+            } else if (\"diff.html.dataURIFailureCache\".equals(cacheConfiguration.getConfigurationId())) {\n+                return this.failureCache;\n+            }\n+\n+            return null;\n+        });\n+    }\n+\n+    @BeforeEach\n+    public void setUp()\n+    {\n+        when(this.userReferenceSerializer.serialize(CurrentUserReference.INSTANCE)).thenReturn(CURRENT_USER);\n+\n+        XWikiContext xwikiContext = mock();\n+        when(this.xwikiContextProvider.get()).thenReturn(xwikiContext);\n+        XWikiServletRequestStub request = new XWikiServletRequestStub.Builder()\n+            .setHeaders(Map.of(\"forwarded\", List.of(\"host=localhost:8080;proto=http\")))\n+            .build();\n+        request.setRequestURI(\"/xwiki\");\n+        when(xwikiContext.getRequest()).thenReturn(request);\n+    }\n+\n+    @Test\n+    void returnsURLWhenDisabled() throws DiffException\n+    {\n+        when(this.configuration.isEnabled()).thenReturn(false);\n+        String url = \"http://www.example.com\";\n+        assertEquals(url, this.converter.convert(url));\n+    }\n+\n+    @Test\n+    void dataURIIsKept() throws DiffException\n+    {\n+        String dataURI = \"data:image/png;base64,abc\";\n+        assertEquals(dataURI, this.converter.convert(dataURI));\n+    }\n+\n+    @Test\n+    void throwsExceptionWhenURLIsMalFormed() throws IOException\n+    {\n+        String url = \"http://w w w.example.com\";\n+        when(this.urlSecurityManager.isDomainTrusted(new URL(url))).thenReturn(true);\n+        DiffException exception = assertThrows(DiffException.class, () -> this.converter.convert(url));\n+        assertEquals(getFailureMessage(url), exception.getMessage());\n+        assertEquals(\"Illegal character in authority at index 7: http://w w w.example.com\",\n+            exception.getCause().getMessage());\n+\n+        verify(this.imageDownloader, never()).download(any());\n+        verify(this.cache, never()).set(any(), any());\n+        verify(this.failureCache).set(CACHE_PREFIX + url,\n+            exception);\n+    }\n+\n+    @Test\n+    void usesCacheWhenAvailable() throws DiffException\n+    {\n+        String dataURI = \"data:image/png;base64,def\";\n+        String url = \"/image.png\";\n+        when(this.cache.get(CACHE_PREFIX + URL_PREFIX + url)).thenReturn(dataURI);\n+\n+        assertEquals(dataURI, this.converter.convert(url));\n+    }\n+\n+    @Test\n+    void throwsCachedFailure()\n+    {\n+        String url = \"/image.png\";\n+        DiffException exception = new DiffException(\"Failed to convert url to absolute URL.\");\n+        when(this.failureCache.get(CACHE_PREFIX + URL_PREFIX + url)).thenReturn(exception);\n+\n+        DiffException thrown = assertThrows(DiffException.class, () -> this.converter.convert(url));\n+        assertEquals(exception, thrown);\n+    }\n+\n+    @Test\n+    void throwsWhenURLIsNotTrusted() throws MalformedURLException\n+    {\n+        String url = \"http://example.com/image.png\";\n+        when(this.urlSecurityManager.isDomainTrusted(new URL(url))).thenReturn(false);\n+\n+        DiffException thrown = assertThrows(DiffException.class, () -> this.converter.convert(url));\n+        assertEquals(getFailureMessage(url), thrown.getMessage());\n+        assertEquals(String.format(\"The URL [%s] is not trusted.\", url), thrown.getCause().getMessage());\n+\n+        // Make sure that the failure is cached.\n+        verify(this.failureCache).set(CACHE_PREFIX + url, thrown);\n+    }\n+\n+    @Test\n+    void throwsExceptionWhenImageDownloaderFails() throws URISyntaxException, IOException\n+    {\n+        String url = \"/image.png\";\n+        URI uri = new URI(URL_PREFIX + url);\n+        when(this.urlSecurityManager.isDomainTrusted(uri.toURL())).thenReturn(true);\n+        IOException exception = new IOException(\"Failed to download image.\");\n+        when(this.imageDownloader.download(uri)).thenThrow(exception);\n+\n+        DiffException thrown = assertThrows(DiffException.class, () -> this.converter.convert(url));\n+        assertEquals(getFailureMessage(url), thrown.getMessage());\n+        assertEquals(exception, thrown.getCause());\n+\n+        // Make sure the failure is cached.\n+        verify(this.failureCache).set(CACHE_PREFIX + URL_PREFIX + url, thrown);\n+        // Make sure nothing is stored in the data cache.\n+        verify(this.cache, never()).set(any(), any());\n+    }\n+\n+    @Test\n+    void returnsDataURIForReturnedDataAndMimeType() throws IOException, DiffException\n+    {\n+        String url = \"/image.png\";\n+        URI uri = URI.create(URL_PREFIX + url);\n+        when(this.urlSecurityManager.isDomainTrusted(uri.toURL())).thenReturn(true);\n+        String dataURI = \"data:image/jpeg;base64,ZGVm\";\n+        when(this.imageDownloader.download(uri))\n+            .thenReturn(new ImageDownloader.DownloadResult(new byte[] { 'd', 'e', 'f' }, \"image/jpeg\"));\n+\n+        assertEquals(dataURI, this.converter.convert(url));\n+\n+        // Make sure the data is cached.\n+        verify(this.cache).set(CACHE_PREFIX + URL_PREFIX + url, dataURI);\n+        // Make sure nothing is stored in the failure cache.\n+        verify(this.failureCache, never()).set(any(), any());\n+    }\n+\n+    private static String getFailureMessage(String url)\n+    {\n+        return String.format(\"Failed to convert [%s] to data URI.\", url);\n+    }\n+}"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-diff/xwiki-platform-diff-xml/src/test/java/org/xwiki/diff/xml/internal/ImageDownloaderTest.java",
          "status": "added",
          "additions": 237,
          "deletions": 0,
          "patch": "@@ -0,0 +1,237 @@\n+/*\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+package org.xwiki.diff.xml.internal;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URI;\n+import java.util.List;\n+\n+import javax.inject.Provider;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.hc.client5.http.impl.classic.CloseableHttpClient;\n+import org.apache.hc.client5.http.impl.classic.CloseableHttpResponse;\n+import org.apache.hc.client5.http.impl.classic.HttpClientBuilder;\n+import org.apache.hc.core5.http.ClassicHttpRequest;\n+import org.apache.hc.core5.http.Header;\n+import org.apache.hc.core5.http.HttpEntity;\n+import org.apache.hc.core5.http.HttpStatus;\n+import org.apache.hc.core5.http.ProtocolVersion;\n+import org.apache.hc.core5.http.io.HttpClientResponseHandler;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.CsvSource;\n+import org.junit.jupiter.params.provider.ValueSource;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Mock;\n+import org.xwiki.diff.xml.XMLDiffDataURIConverterConfiguration;\n+import org.xwiki.security.authentication.AuthenticationConfiguration;\n+import org.xwiki.test.junit5.mockito.ComponentTest;\n+import org.xwiki.test.junit5.mockito.InjectMockComponents;\n+import org.xwiki.test.junit5.mockito.MockComponent;\n+\n+import com.xpn.xwiki.XWikiContext;\n+import com.xpn.xwiki.web.XWikiRequest;\n+\n+import static org.junit.jupiter.api.Assertions.assertArrayEquals;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertThrows;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+/**\n+ * Unit tests for {@link ImageDownloader}.\n+ *\n+ * @version $Id$\n+ */\n+@ComponentTest\n+class ImageDownloaderTest\n+{\n+    private static final ProtocolVersion HTTP_VERSION = new ProtocolVersion(\"HTTP\", 1, 1);\n+\n+    private static final URI IMAGE_URI = URI.create(\"https://www.example.com/image.png\");\n+\n+    private static final String IMAGE_CONTENT_TYPE = \"image/png\";\n+\n+    @MockComponent\n+    private HttpClientBuilderFactory httpClientBuilderFactory;\n+\n+    @MockComponent\n+    private Provider<XWikiContext> xwikiContextProvider;\n+\n+    @MockComponent\n+    private XMLDiffDataURIConverterConfiguration configuration;\n+\n+    @MockComponent\n+    private AuthenticationConfiguration authenticationConfiguration;\n+\n+    @InjectMockComponents\n+    private ImageDownloader imageDownloader;\n+\n+    @Mock\n+    private HttpClientBuilder httpClientBuilder;\n+\n+    @Mock\n+    private CloseableHttpClient httpClient;\n+\n+    @Mock\n+    private CloseableHttpResponse httpResponse;\n+\n+    @Mock\n+    private XWikiContext xwikiContext;\n+\n+    @Mock\n+    private HttpEntity httpEntity;\n+\n+    @BeforeEach\n+    public void setupMocks() throws IOException\n+    {\n+        when(this.httpClientBuilderFactory.create()).thenReturn(this.httpClientBuilder);\n+        when(this.httpClientBuilder.build()).thenReturn(this.httpClient);\n+        when(this.httpClient.execute(any(ClassicHttpRequest.class), any(HttpClientResponseHandler.class)))\n+            .then(invocation ->\n+            {\n+                HttpClientResponseHandler<?> responseHandler = invocation.getArgument(1);\n+                return responseHandler.handleResponse(this.httpResponse);\n+            });\n+        when(this.xwikiContextProvider.get()).thenReturn(this.xwikiContext);\n+        when(this.httpResponse.getEntity()).thenReturn(this.httpEntity);\n+        when(this.httpResponse.getCode()).thenReturn(HttpStatus.SC_OK);\n+        when(this.httpResponse.getReasonPhrase()).thenReturn(\"OK\");\n+        when(this.httpEntity.getContentType()).thenReturn(IMAGE_CONTENT_TYPE);\n+    }\n+\n+    @Test\n+    void throwsOnNon200Status()\n+    {\n+        when(this.httpResponse.getCode()).thenReturn(HttpStatus.SC_NOT_FOUND);\n+        when(this.httpResponse.getReasonPhrase()).thenReturn(\"Not Found\");\n+        IOException ioException = assertThrows(IOException.class, () -> this.imageDownloader.download(IMAGE_URI));\n+        assertEquals(\"404 Not Found\", ioException.getMessage());\n+    }\n+\n+    @Test\n+    void throwsWhenNonImageContentType()\n+    {\n+        when(this.httpEntity.getContentType()).thenReturn(\"text/html\");\n+        IOException ioException = assertThrows(IOException.class, () -> this.imageDownloader.download(IMAGE_URI));\n+        assertEquals(String.format(\"The content of [%s] is not an image.\", IMAGE_URI), ioException.getMessage());\n+    }\n+\n+    @Test\n+    void throwsWhenContentTypeHeaderMissing()\n+    {\n+        when(this.httpEntity.getContentType()).thenReturn(null);\n+        IOException ioException = assertThrows(IOException.class, () -> this.imageDownloader.download(IMAGE_URI));\n+        assertEquals(String.format(\"The content of [%s] is not an image.\", IMAGE_URI), ioException.getMessage());\n+    }\n+\n+    @Test\n+    void throwsWhenContentLengthTooBig()\n+    {\n+        when(this.httpEntity.getContentLength()).thenReturn(1000000000L);\n+        when(this.configuration.getMaximumContentSize()).thenReturn(100L);\n+        IOException ioException = assertThrows(IOException.class, () -> this.imageDownloader.download(IMAGE_URI));\n+        assertEquals(String.format(\"The content length of [%s] is too big.\", IMAGE_URI), ioException.getMessage());\n+    }\n+\n+    @Test\n+    void throwsWhenContentLengthUnknownAndTooBig() throws IOException\n+    {\n+        when(this.httpEntity.getContentLength()).thenReturn(-1L);\n+        InputStream inputStream = new InputStream()\n+        {\n+            @Override\n+            public int read()\n+            {\n+                return 1;\n+            }\n+        };\n+        when(this.configuration.getMaximumContentSize()).thenReturn(100L);\n+\n+        when(this.httpEntity.getContent()).thenReturn(inputStream);\n+        IOException ioException = assertThrows(IOException.class, () -> this.imageDownloader.download(IMAGE_URI));\n+        assertEquals(String.format(\"The content of [%s] is too big.\", IMAGE_URI), ioException.getMessage());\n+    }\n+\n+    @ParameterizedTest\n+    @ValueSource(longs = { -1, 1, 100, 200 })\n+    void returnsContent(long contentLength) throws IOException\n+    {\n+        // Set different content lengths to test the different code paths.\n+        when(this.httpEntity.getContentLength()).thenReturn(contentLength);\n+        if (contentLength < 200) {\n+            when(this.configuration.getMaximumContentSize()).thenReturn(200L);\n+        } else {\n+            // Test unlimited size.\n+            when(this.configuration.getMaximumContentSize()).thenReturn(0L);\n+        }\n+        byte[] content = new byte[] { 1, 2, 3 };\n+        when(this.httpEntity.getContent()).thenReturn(new ByteArrayInputStream(content));\n+        ImageDownloader.DownloadResult result = this.imageDownloader.download(IMAGE_URI);\n+        assertArrayEquals(content, result.getData());\n+        assertEquals(IMAGE_CONTENT_TYPE, result.getContentType());\n+    }\n+\n+    @ParameterizedTest\n+    @CsvSource({\n+        \"www.example.com, true, \",\n+        \"www.xwiki.org, false, \",\n+        \"test.example.com, false, \",\n+        \"matches.example.com, true, .example.com\"\n+    })\n+    void passesCookiesFromRequest(String requestDomain, boolean shouldSendCookie, String cookieDomain)\n+        throws IOException\n+    {\n+        // Set a mock request in the context.\n+        XWikiRequest request = mock();\n+        when(request.getServerName()).thenReturn(requestDomain);\n+        String cookieHeader = \"cookie1=value1; cookie2=value2\";\n+        when(request.getHeader(\"Cookie\")).thenReturn(cookieHeader);\n+        when(this.xwikiContext.getRequest()).thenReturn(request);\n+\n+        if (StringUtils.isNotBlank(cookieDomain)) {\n+            when(this.authenticationConfiguration.getCookieDomains()).thenReturn(List.of(cookieDomain));\n+        }\n+\n+        // Trigger the download.\n+        byte[] content = new byte[] { 1, 2, 3 };\n+        when(this.httpEntity.getContent()).thenReturn(new ByteArrayInputStream(content));\n+        this.imageDownloader.download(IMAGE_URI);\n+\n+        ArgumentCaptor<ClassicHttpRequest> requestCaptor = ArgumentCaptor.forClass(ClassicHttpRequest.class);\n+        verify(this.httpClient).execute(requestCaptor.capture(), any(HttpClientResponseHandler.class));\n+\n+        // Verify that the cookies are passed to the HTTP client if it should do so.\n+        ClassicHttpRequest httpRequest = requestCaptor.getValue();\n+        Header[] headers = httpRequest.getHeaders(\"Cookie\");\n+        if (shouldSendCookie) {\n+            assertEquals(1, headers.length);\n+            assertEquals(cookieHeader, headers[0].getValue());\n+        } else {\n+            assertEquals(0, headers.length);\n+        }\n+    }\n+}"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/pom.xml",
          "status": "modified",
          "additions": 6,
          "deletions": 0,
          "patch": "@@ -134,6 +134,12 @@\n       <version>${project.version}</version>\n       <type>xar</type>\n     </dependency>\n+    <!-- Needed for CompareIT -->\n+    <dependency>\n+      <groupId>org.xwiki.platform</groupId>\n+      <artifactId>xwiki-platform-diff-xml</artifactId>\n+      <version>${project.version}</version>\n+    </dependency>\n     <!-- ================================\n          Test only dependencies\n          ================================ -->"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/AllIT.java",
          "status": "modified",
          "additions": 6,
          "deletions": 0,
          "patch": "@@ -200,4 +200,10 @@ class NestedFormTokenInjectionIT extends FormTokenInjectionIT\n     class NestedPagePickerIT extends PagePickerIT\n     {\n     }\n+\n+    @Nested\n+    @DisplayName(\"Compare Tests\")\n+    class NestedCompareIT extends CompareIT\n+    {\n+    }\n }"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/CompareIT.java",
          "status": "added",
          "additions": 131,
          "deletions": 0,
          "patch": "@@ -0,0 +1,131 @@\n+/*\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+package org.xwiki.flamingo.test.docker;\n+\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.util.Base64;\n+import java.util.List;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.junit.jupiter.api.Order;\n+import org.junit.jupiter.api.Test;\n+import org.openqa.selenium.By;\n+import org.openqa.selenium.WebElement;\n+import org.xwiki.model.reference.AttachmentReference;\n+import org.xwiki.test.docker.junit5.TestReference;\n+import org.xwiki.test.docker.junit5.UITest;\n+import org.xwiki.test.ui.TestUtils;\n+import org.xwiki.test.ui.po.ComparePage;\n+import org.xwiki.test.ui.po.ViewPage;\n+import org.xwiki.test.ui.po.diff.RenderedChanges;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertFalse;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+/**\n+ * Tests related to the compare versions feature.\n+ *\n+ * @version $Id$\n+ */\n+@UITest(properties = {\n+    // Trust picsum.photos to allow the rendered diff to download images from it\n+    \"xwikiPropertiesAdditionalProperties=url.trustedDomains=picsum.photos\"\n+})\n+class CompareIT\n+{\n+    private static final String ATTACHMENT_NAME_1 = \"image.gif\";\n+\n+    private static final String ATTACHMENT_NAME_2 = \"image2.gif\";\n+\n+    private static final String ATTACHMENT_NAME_3 = \"image.png\";\n+\n+    private static final String IMAGE_SYNTAX = \"[[image:%s]]\";\n+\n+    private String getLocalAttachmentURL(TestUtils setup, TestReference testReference, String attachmentName)\n+        throws URISyntaxException\n+    {\n+        AttachmentReference attachmentReference = new AttachmentReference(attachmentName, testReference);\n+        URI attachmentURL = new URI(setup.getURL(attachmentReference, \"download\", null));\n+        // Replace host and port with localhost and 8080 to make the URL usable from the container.\n+        return (new URI(\"http\", null, \"localhost\", 8080, attachmentURL.getPath(),\n+            attachmentURL.getQuery(), attachmentURL.getFragment())).toString();\n+    }\n+\n+    @Test\n+    @Order(1)\n+    void compareRenderedImageChanges(TestUtils setup, TestReference testReference) throws Exception\n+    {\n+        setup.loginAsSuperAdmin();\n+        setup.attachFile(testReference, ATTACHMENT_NAME_1,\n+            getClass().getResourceAsStream(\"/AttachmentIT/image.gif\"), false);\n+        // Upload the image a second time under a different name to check that the content and not the URL is used\n+        // for comparison when changing the URL to the second image.\n+        setup.attachFile(testReference, ATTACHMENT_NAME_2,\n+            getClass().getResourceAsStream(\"/AttachmentIT/image.gif\"), false);\n+        String url1 = getLocalAttachmentURL(setup, testReference, ATTACHMENT_NAME_1);\n+        ViewPage viewPage = setup.createPage(testReference, String.format(IMAGE_SYNTAX, url1));\n+        String firstRevision = viewPage.getMetaDataValue(\"version\");\n+        // Create a second revision with the new image.\n+        String url2 = getLocalAttachmentURL(setup, testReference, ATTACHMENT_NAME_2);\n+        viewPage = setup.createPage(testReference, String.format(IMAGE_SYNTAX, url2));\n+        String secondRevision = viewPage.getMetaDataValue(\"version\");\n+\n+        // Open the history pane.\n+        ComparePage compare = viewPage.openHistoryDocExtraPane().compare(firstRevision, secondRevision);\n+        RenderedChanges renderedChanges = compare.getChangesPane().getRenderedChanges();\n+        assertTrue(renderedChanges.hasNoChanges());\n+\n+        // Upload a new image with different content to verify that the changes are detected.\n+        setup.attachFile(testReference, ATTACHMENT_NAME_3,\n+            getClass().getResourceAsStream(\"/AttachmentIT/SmallSizeAttachment.png\"), false);\n+\n+        // Create a third revision with the new image.\n+        String url3 = getLocalAttachmentURL(setup, testReference, ATTACHMENT_NAME_3);\n+        viewPage = setup.createPage(testReference, String.format(IMAGE_SYNTAX, url3));\n+        String thirdRevision = viewPage.getMetaDataValue(\"version\");\n+\n+        // Open the history pane.\n+        compare = viewPage.openHistoryDocExtraPane().compare(secondRevision, thirdRevision);\n+        renderedChanges = compare.getChangesPane().getRenderedChanges();\n+        assertFalse(renderedChanges.hasNoChanges());\n+        List<WebElement> changes = renderedChanges.getChangedBlocks();\n+        assertEquals(2, changes.size());\n+\n+        // Check that the first change is the deletion and the second change the insertion of the new image.\n+        WebElement firstChange = changes.get(0);\n+        WebElement secondChange = changes.get(1);\n+        assertEquals(\"deleted\", firstChange.getAttribute(\"data-xwiki-html-diff-block\"));\n+        assertEquals(\"inserted\", secondChange.getAttribute(\"data-xwiki-html-diff-block\"));\n+        WebElement deletedImage = firstChange.findElement(By.tagName(\"img\"));\n+        WebElement insertedImage = secondChange.findElement(By.tagName(\"img\"));\n+\n+        // Check that the src attribute of the deleted image ends with the image2 (don't check the start as it\n+        // depends on the container setup and the nested/non-nested test execution).\n+        assertEquals(url2, deletedImage.getAttribute(\"src\"));\n+\n+        // Compute the expected base64-encoded content of the inserted image. The HTML diff embeds both images but\n+        // replaces the deleted image by the original URL again after the diff computation.\n+        String expectedInsertedImageContent = Base64.getEncoder().encodeToString(\n+            IOUtils.toByteArray(getClass().getResourceAsStream(\"/AttachmentIT/SmallSizeAttachment.png\")));\n+        assertEquals(\"data:image/png;base64,\" + expectedInsertedImageContent, insertedImage.getAttribute(\"src\"));\n+    }\n+}"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-api/src/main/java/org/xwiki/security/authentication/AuthenticationConfiguration.java",
          "status": "modified",
          "additions": 15,
          "deletions": 0,
          "patch": "@@ -19,7 +19,10 @@\n  */\n package org.xwiki.security.authentication;\n \n+import java.util.List;\n+\n import org.xwiki.component.annotation.Role;\n+import org.xwiki.stability.Unstable;\n \n /**\n  * Configuration of the authentication properties.\n@@ -54,4 +57,16 @@ default boolean isAuthenticationSecurityEnabled()\n     {\n         return true;\n     }\n+\n+    /**\n+     * @return the list of cookie domains to use for the authentication cookies. Domains are prefix with a dot.\n+     * @since 14.10.15\n+     * @since 15.5.1\n+     * @since 15.6\n+     */\n+    @Unstable\n+    default List<String> getCookieDomains()\n+    {\n+        return List.of();\n+    }\n }"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/DefaultAuthenticationConfiguration.java",
          "status": "modified",
          "additions": 21,
          "deletions": 0,
          "patch": "@@ -19,6 +19,8 @@\n  */\n package org.xwiki.security.authentication.internal;\n \n+import java.util.List;\n+\n import javax.inject.Inject;\n import javax.inject.Named;\n import javax.inject.Singleton;\n@@ -28,6 +30,8 @@\n import org.xwiki.configuration.ConfigurationSource;\n import org.xwiki.security.authentication.AuthenticationConfiguration;\n \n+import static java.util.stream.Collectors.toList;\n+\n /**\n  * Default implementation for {@link AuthenticationConfiguration}.\n  *\n@@ -38,13 +42,19 @@\n @Singleton\n public class DefaultAuthenticationConfiguration implements AuthenticationConfiguration\n {\n+    private static final String COOKIE_PREFIX = \".\";\n+\n     /**\n      * Defines from where to read the Resource configuration data.\n      */\n     @Inject\n     @Named(\"authentication\")\n     private ConfigurationSource configuration;\n \n+    @Inject\n+    @Named(\"xwikicfg\")\n+    private ConfigurationSource xwikiCfgConfiguration;\n+\n     @Override\n     public int getMaxAuthorizedAttempts()\n     {\n@@ -73,4 +83,15 @@ public boolean isAuthenticationSecurityEnabled()\n     {\n         return configuration.getProperty(\"isAuthenticationSecurityEnabled\", true);\n     }\n+\n+    @Override\n+    public List<String> getCookieDomains()\n+    {\n+        List<?> rawValues = this.xwikiCfgConfiguration.getProperty(\"xwiki.authentication.cookiedomains\", List.class,\n+            List.of());\n+        return rawValues.stream()\n+            .map(Object::toString)\n+            .map(cookie -> StringUtils.startsWith(cookie, COOKIE_PREFIX) ? cookie : COOKIE_PREFIX + cookie)\n+            .collect(toList());\n+    }\n }"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/DefaultAuthenticationConfigurationTest.java",
          "status": "added",
          "additions": 71,
          "deletions": 0,
          "patch": "@@ -0,0 +1,71 @@\n+/*\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+package org.xwiki.security.authentication.internal;\n+\n+import java.util.List;\n+\n+import javax.inject.Named;\n+\n+import org.junit.jupiter.api.Test;\n+import org.xwiki.configuration.ConfigurationSource;\n+import org.xwiki.test.junit5.mockito.ComponentTest;\n+import org.xwiki.test.junit5.mockito.InjectMockComponents;\n+import org.xwiki.test.junit5.mockito.MockComponent;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.mockito.Mockito.when;\n+\n+/**\n+ * Unit test of {@link DefaultAuthenticationConfiguration}.\n+ */\n+@ComponentTest\n+class DefaultAuthenticationConfigurationTest\n+{\n+    @MockComponent\n+    @Named(\"xwikicfg\")\n+    private ConfigurationSource xwikiCfgConfiguration;\n+\n+    @InjectMockComponents\n+    private DefaultAuthenticationConfiguration configuration;\n+\n+    @Test\n+    void getCookieDomains()\n+    {\n+        // Test with empty configuration.\n+        String configurationKey = \"xwiki.authentication.cookiedomains\";\n+        when(this.xwikiCfgConfiguration.getProperty(configurationKey, List.class, List.of()))\n+            .thenReturn(List.of());\n+\n+        assertEquals(List.of(), this.configuration.getCookieDomains());\n+\n+        // Test with domains without prefix.\n+        when(this.xwikiCfgConfiguration.getProperty(configurationKey, List.class, List.of()))\n+            .thenReturn(List.of(\"xwiki.org\", \"xwiki.com\"));\n+\n+        String xwikiComWithPrefix = \".xwiki.com\";\n+        assertEquals(List.of(\".xwiki.org\", xwikiComWithPrefix), this.configuration.getCookieDomains());\n+\n+        // Test with domains where some have a prefix already.\n+        when(this.xwikiCfgConfiguration.getProperty(configurationKey, List.class, List.of()))\n+            .thenReturn(List.of(\"example.com\", xwikiComWithPrefix));\n+\n+        assertEquals(List.of(\".example.com\", xwikiComWithPrefix), this.configuration.getCookieDomains());\n+    }\n+}"
        },
        {
          "filename": "xwiki-platform-tools/xwiki-platform-tool-configuration-resources/src/main/resources/xwiki.properties.vm",
          "status": "modified",
          "additions": 23,
          "deletions": 0,
          "patch": "@@ -1556,4 +1556,27 @@ edit.defaultEditor.org.xwiki.rendering.block.XDOM#wysiwyg=$xwikiPropertiesDefaul\n # whatsnew.sources = xwikisas = xwikiblog\n # whatsnew.sources.xwikisas.rssURL = https://xwiki.com/news\n \n+#-------------------------------------------------------------------------------------\n+# XML Diff\n+#-------------------------------------------------------------------------------------\n+\n+#-# [Since 14.10.15, 15.5.1, 15.6]\n+#-# If the compared documents contain images, they can be embedded as data URI to compare the images themselves\n+#-# instead of their URLs. For this, images are downloaded via HTTP and embedded as data URI. Images are only\n+#-# downloaded from trusted domains when enabled above. Still, this can be a security and stability risk as\n+#-# downloading images can easily increase the server load. If this option is set to \"false\", no images are\n+#-# downloaded by the diff and images are compared by URL instead.\n+#-# Default is \"true\".\n+# diff.xml.dataURI.enabled = true\n+\n+#-# [Since 14.10.15, 15.5.1, 15.6]\n+#-# Configure the maximum size in bytes of an image to be embedded into the XML diff output as data URI.\n+#-# Default is 1MB.\n+# diff.xml.dataURI.maximumContentSize = 1048576\n+\n+#-# [Since 14.10.15, 15.5.1, 15.6]\n+#-# Configure the timeout in seconds for downloading an image via HTTP to embed it into the XML diff output as data URI.\n+#-# Default is 10 seconds.\n+# diff.xml.dataURI.httpTimeout = 10\n+\n $!xwikiPropertiesAdditionalProperties"
        }
      ],
      "file_patterns": {
        "security_files": 3,
        "config_files": 6,
        "dependency_files": 0,
        "test_files": 6,
        "unique_directories": 11,
        "max_directory_depth": 13
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "88e3e7d23cbd3e6ed059dbcd6532f94016d42678",
            "date": "2025-01-13T16:58:06Z",
            "author_login": "Sereza7"
          },
          {
            "sha": "9b506ab2bed52744b52699ea05cde15986d42abb",
            "date": "2025-01-13T16:36:24Z",
            "author_login": "mflorea"
          },
          {
            "sha": "d53d6e347b97ac20f60e21fb2bae381f4aaf10f4",
            "date": "2025-01-13T13:25:24Z",
            "author_login": "tmortagne"
          },
          {
            "sha": "d85bd8f9c67c412e0cfb45fb4695b8d4e759bab6",
            "date": "2025-01-13T12:03:22Z",
            "author_login": "tmortagne"
          },
          {
            "sha": "6f210dabc99167cf9f020a048c88325eca34ceea",
            "date": "2025-01-13T08:54:32Z",
            "author_login": "tmortagne"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 9.0,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:H/I:H/A:H",
    "cwe_id": "CWE-201",
    "description": "XWiki Platform is a generic wiki platform. The rendered diff in XWiki embeds images to be able to compare the contents and not display a difference for an actually unchanged image. For this, XWiki requests all embedded images on the server side. These requests are also sent for images from other domains and include all cookies that were sent in the original request to ensure that images with restricted view right can be compared. Starting in version 11.10.1 and prior to versions 14.10.15, 15.5.1, and 15.6, this allows an attacker to steal login and session cookies that allow impersonating the current user who views the diff. The attack can be triggered with an image that references the rendered diff, thus making it easy to trigger. Apart from stealing login cookies, this also allows server-side request forgery (the result of any successful request is returned in the image's source) and viewing protected content as once a resource is cached, it is returned for all users. As only successful requests are cached, the cache will be filled by the first user who is allowed to access the resource. This has been patched in XWiki 14.10.15, 15.5.1 and 15.6. The rendered diff now only downloads images from trusted domains. Further, cookies are only sent when the image's domain is the same the requested domain. The cache has been changed to be specific for each user. As a workaround, the image embedding feature can be disabled by deleting `xwiki-platform-diff-xml-<version>.jar` in `WEB-INF/lib/`.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-11-20T18:15:07.233",
    "last_modified": "2024-11-21T08:31:17.120",
    "fix_date": "2023-04-25T13:42:05Z"
  },
  "references": [
    {
      "url": "https://github.com/xwiki/xwiki-platform/commit/bff0203e739b6e3eb90af5736f04278c73c2a8bb",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/security/advisories/GHSA-7rfg-6273-f5wp",
      "source": "security-advisories@github.com",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://jira.xwiki.org/browse/XWIKI-20818",
      "source": "security-advisories@github.com",
      "tags": [
        "Issue Tracking",
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/commit/bff0203e739b6e3eb90af5736f04278c73c2a8bb",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/security/advisories/GHSA-7rfg-6273-f5wp",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://jira.xwiki.org/browse/XWIKI-20818",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Issue Tracking",
        "Patch",
        "Vendor Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:06:39.273077",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "xwiki-platform",
    "owner": "xwiki",
    "created_at": "2011-03-10T13:26:41Z",
    "updated_at": "2025-01-13T16:58:10Z",
    "pushed_at": "2025-01-14T12:32:03Z",
    "size": 561595,
    "stars": 1030,
    "forks": 554,
    "open_issues": 136,
    "watchers": 1030,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "Java": 34276921,
      "JavaScript": 2392892,
      "HTML": 388086,
      "Less": 318945,
      "AspectJ": 280487,
      "Vue": 222987,
      "CSS": 115460,
      "XSLT": 109285,
      "Clean": 44054,
      "Shell": 32569,
      "Batchfile": 14604,
      "Python": 5046,
      "Groovy": 3012,
      "AMPL": 1296
    },
    "commit_activity": {
      "total_commits_last_year": 1723,
      "avg_commits_per_week": 33.13461538461539,
      "days_active_last_year": 263
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "lgpl-2.1"
    },
    "collected_at": "2025-01-14T12:58:58.685838"
  }
}