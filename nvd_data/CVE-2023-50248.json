{
  "cve_id": "CVE-2023-50248",
  "github_data": {
    "repository": "ckan/ckan",
    "fix_commit": "bd02018b65c5b81d7ede195d00d0fcbac3aa33be",
    "related_commits": [
      "bd02018b65c5b81d7ede195d00d0fcbac3aa33be",
      "bd02018b65c5b81d7ede195d00d0fcbac3aa33be"
    ],
    "patch_url": "https://github.com/ckan/ckan/commit/bd02018b65c5b81d7ede195d00d0fcbac3aa33be.patch",
    "fix_commit_details": {
      "sha": "bd02018b65c5b81d7ede195d00d0fcbac3aa33be",
      "commit_date": "2023-12-13T13:12:02Z",
      "author": {
        "login": "amercader",
        "type": "User",
        "stats": {
          "total_commits": 3832,
          "average_weekly_commits": 4.076595744680851,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 532
        }
      },
      "commit_message": {
        "title": "Merge pull request from GHSA-7fgc-89cx-w8j5",
        "length": 97,
        "has_description": true,
        "references_issue": false
      },
      "stats": {
        "total": 119,
        "additions": 117,
        "deletions": 2
      },
      "files": [
        {
          "filename": "ckan/logic/__init__.py",
          "status": "modified",
          "additions": 31,
          "deletions": 2,
          "patch": "@@ -25,7 +25,8 @@\n from ckan.types import (\n     Action, ChainedAction,\n     ChainedAuthFunction, DataDict, ErrorDict, Context, FlattenDataDict,\n-    Schema, Validator, ValidatorFactory)\n+    FlattenKey, Schema, Validator, ValidatorFactory\n+)\n \n Decorated = TypeVar(\"Decorated\")\n \n@@ -255,7 +256,35 @@ def tuplize_dict(data_dict: dict[str, Any]) -> FlattenDataDict:\n                 except ValueError:\n                     raise df.DataError('Bad key')\n         tuplized_dict[tuple(key_list)] = value\n-    return tuplized_dict\n+\n+    # Sanitize key indexes to make sure they are sequential\n+    seq_tuplized_dict: FlattenDataDict = {}\n+    # sequential field indexes grouped by common prefix\n+    groups: dict[FlattenKey, dict[FlattenKey, int]] = defaultdict(dict)\n+    for key in sorted(tuplized_dict.keys()):\n+        new_key = key\n+\n+        # iterate over even(numeric) parts of the key\n+        for idx in range(1, len(key), 2):\n+            # narrow down scope by common prefix\n+            group = groups[key[:idx]]\n+\n+            # if the identifier(i.e `(extra, 123)`, `(resource, 9)`) is met for\n+            # the first time, generate for it next number in the index\n+            # sequence. Index of the latest added item is always equals to the\n+            # number of unique identifiers minus one(because list indexation\n+            # starts from 0 in Python). If identifier already present(i.e, we\n+            # process `(extra, 10, VALUE)` after processing `(extra, 10,\n+            # KEY)`), reuse sequential index of this identifier\n+            seq_index = group.setdefault(key[idx-1:idx+1], len(group))\n+\n+            # replace the currently processed key segment with computed\n+            # sequential index\n+            new_key = new_key[:idx] + (seq_index,) + new_key[idx+1:]\n+\n+        seq_tuplized_dict[new_key] = tuplized_dict[key]\n+\n+    return seq_tuplized_dict\n \n \n def untuplize_dict(tuplized_dict: FlattenDataDict) -> dict[str, Any]:"
        },
        {
          "filename": "ckan/tests/logic/test_logic.py",
          "status": "modified",
          "additions": 86,
          "deletions": 0,
          "patch": "@@ -3,6 +3,8 @@\n from unittest import mock\n import pytest\n from ckan import logic, model\n+import ckan.lib.navl.dictization_functions as df\n+\n from ckan.types import Context\n import ckan.tests.factories as factories\n \n@@ -100,3 +102,87 @@ def test_check_access_auth_user_for_different_objects():\n     with pytest.raises(logic.NotAuthorized):\n         for dataset in dataset3:\n             logic.check_access(\"package_show\", context, {'id': dataset[\"id\"]})\n+\n+\n+def test_tuplize_dict():\n+\n+    data_dict = {\n+        \"author\": \"Test Author\",\n+        \"extras__0__key\": \"extra1\",\n+        \"extras__0__value\": \"value1\",\n+        \"extras__1__key\": \"extra2\",\n+        \"extras__1__value\": \"value2\",\n+        \"extras__2__key\": \"extra3\",\n+        \"extras__2__value\": \"value3\",\n+        \"extras__3__key\": \"\",\n+        \"extras__3__value\": \"\",\n+        \"groups__0__id\": \"5a65eae8-ef2b-4a85-8022-d9e5a71ad074\",\n+        \"name\": \"test-title\",\n+        \"notes\": \"Test desc\",\n+        \"owner_org\": \"5a65eae8-ef2b-4a85-8022-d9e5a71ad074\",\n+        \"private\": \"True\",\n+        \"tag_string\": \"economy,climate\",\n+        \"title\": \"Test title\",\n+    }\n+\n+    expected = {\n+        (\"author\",): \"Test Author\",\n+        (\"extras\", 0, \"key\"): \"extra1\",\n+        (\"extras\", 0, \"value\"): \"value1\",\n+        (\"extras\", 1, \"key\"): \"extra2\",\n+        (\"extras\", 1, \"value\"): \"value2\",\n+        (\"extras\", 2, \"key\"): \"extra3\",\n+        (\"extras\", 2, \"value\"): \"value3\",\n+        (\"extras\", 3, \"key\"): \"\",\n+        (\"extras\", 3, \"value\"): \"\",\n+        (\"groups\", 0, \"id\"): \"5a65eae8-ef2b-4a85-8022-d9e5a71ad074\",\n+        (\"name\",): \"test-title\",\n+        (\"notes\",): \"Test desc\",\n+        (\"owner_org\",): \"5a65eae8-ef2b-4a85-8022-d9e5a71ad074\",\n+        (\"private\",): \"True\",\n+        (\"tag_string\",): \"economy,climate\",\n+        (\"title\",): \"Test title\",\n+    }\n+\n+    assert logic.tuplize_dict(data_dict) == expected\n+\n+\n+def test_tuplize_dict_random_indexes():\n+\n+    data_dict = {\n+        \"extras__22__key\": \"extra2\",\n+        \"extras__22__value\": \"value2\",\n+        \"extras__1__key\": \"extra1\",\n+        \"extras__1__value\": \"value1\",\n+        \"extras__245566546__key\": \"extra3\",\n+        \"extras__245566546__value\": \"value3\",\n+        \"groups__13__id\": \"group2\",\n+        \"groups__1__id\": \"group1\",\n+        \"groups__13__nested__7__name\": \"latter\",\n+        \"groups__13__nested__2__name\": \"former\",\n+\n+    }\n+\n+    expected = {\n+        (\"extras\", 0, \"key\"): \"extra1\",\n+        (\"extras\", 0, \"value\"): \"value1\",\n+        (\"extras\", 1, \"key\"): \"extra2\",\n+        (\"extras\", 1, \"value\"): \"value2\",\n+        (\"extras\", 2, \"key\"): \"extra3\",\n+        (\"extras\", 2, \"value\"): \"value3\",\n+        (\"groups\", 0, \"id\"): \"group1\",\n+        (\"groups\", 1, \"id\"): \"group2\",\n+        (\"groups\", 1, \"nested\", 0, \"name\"): \"former\",\n+        (\"groups\", 1, \"nested\", 1, \"name\"): \"latter\",\n+    }\n+\n+    assert logic.tuplize_dict(data_dict) == expected\n+\n+\n+def test_tuplize_dict_wrong_index():\n+\n+    with pytest.raises(df.DataError):\n+        data_dict = {\n+            \"extras__2a__key\": \"extra\",\n+        }\n+        logic.tuplize_dict(data_dict)"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 2,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "de8c1ecb68ed6f746ca4b95cc133f3078d6c5f5a",
            "date": "2025-01-14T12:36:43Z",
            "author_login": "amercader"
          },
          {
            "sha": "b1f1795ed377b23f481aba74022934535e5111a3",
            "date": "2025-01-13T18:07:15Z",
            "author_login": "amercader"
          },
          {
            "sha": "c4ce8b8a332453d52fe63983c30105a753b3dcd4",
            "date": "2025-01-13T13:09:24Z",
            "author_login": "mutantsan"
          },
          {
            "sha": "2334e7fd502874eb5be73002bdbaeb326bae1113",
            "date": "2024-12-29T20:13:35Z",
            "author_login": "aleeexgreeen"
          },
          {
            "sha": "e6470f72418914fa510171aa85a263cbb455ced3",
            "date": "2024-12-29T20:02:31Z",
            "author_login": "aleeexgreeen"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 4.5,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:H/UI:R/S:U/C:N/I:N/A:H",
    "cwe_id": "CWE-130",
    "description": "CKAN is an open-source data management system for powering data hubs and data portals. Starting in version 2.0.0 and prior to versions 2.9.10 and 2.10.3, when submitting a POST request to the `/dataset/new` endpoint (including either the auth cookie or the `Authorization` header) with a specially-crafted field, an attacker can create an out-of-memory error in the hosting server. To trigger this error, the attacker need to have permissions to create or edit datasets. This vulnerability has been patched in CKAN 2.10.3 and 2.9.10.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-12-13T21:15:08.660",
    "last_modified": "2024-11-21T08:36:44.680",
    "fix_date": "2023-12-13T13:12:02Z"
  },
  "references": [
    {
      "url": "https://github.com/ckan/ckan/commit/bd02018b65c5b81d7ede195d00d0fcbac3aa33be",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/ckan/ckan/security/advisories/GHSA-7fgc-89cx-w8j5",
      "source": "security-advisories@github.com",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/ckan/ckan/commit/bd02018b65c5b81d7ede195d00d0fcbac3aa33be",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/ckan/ckan/security/advisories/GHSA-7fgc-89cx-w8j5",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Vendor Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:06:41.567467",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "ckan",
    "owner": "ckan",
    "created_at": "2011-11-10T18:42:17Z",
    "updated_at": "2025-01-14T12:36:48Z",
    "pushed_at": "2025-01-14T12:50:06Z",
    "size": 217197,
    "stars": 4529,
    "forks": 2003,
    "open_issues": 756,
    "watchers": 4529,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "Python": 4151360,
      "CSS": 1322183,
      "HTML": 752447,
      "JavaScript": 600231,
      "SCSS": 281824,
      "Shell": 7827,
      "PLpgSQL": 4227,
      "Mako": 4140,
      "Gherkin": 3242,
      "Dockerfile": 1045,
      "Smarty": 516
    },
    "commit_activity": {
      "total_commits_last_year": 882,
      "avg_commits_per_week": 16.96153846153846,
      "days_active_last_year": 211
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T13:17:14.608738"
  }
}