{
  "cve_id": "CVE-2023-50721",
  "github_data": {
    "repository": "xwiki/xwiki-platform",
    "fix_commit": "62863736d78ffd60d822279c5fb7fb9593042766",
    "related_commits": [
      "62863736d78ffd60d822279c5fb7fb9593042766",
      "62863736d78ffd60d822279c5fb7fb9593042766"
    ],
    "patch_url": "https://github.com/xwiki/xwiki-platform/commit/62863736d78ffd60d822279c5fb7fb9593042766.patch",
    "fix_commit_details": {
      "sha": "62863736d78ffd60d822279c5fb7fb9593042766",
      "commit_date": "2023-08-09T14:21:01Z",
      "author": {
        "login": "michitux",
        "type": "User",
        "stats": {
          "total_commits": 378,
          "average_weekly_commits": 0.39622641509433965,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 108
        }
      },
      "commit_message": {
        "title": "XWIKI-21200: Improve escaping in SearchAdmin",
        "length": 63,
        "has_description": true,
        "references_issue": false
      },
      "stats": {
        "total": 190,
        "additions": 184,
        "deletions": 6
      },
      "files": [
        {
          "filename": "xwiki-platform-core/xwiki-platform-search/xwiki-platform-search-ui/pom.xml",
          "status": "modified",
          "additions": 29,
          "deletions": 0,
          "patch": "@@ -50,5 +50,34 @@\n       <groupId>org.webjars</groupId>\n       <artifactId>jquery</artifactId>\n     </dependency>\n+    <!-- Test dependencies. -->\n+    <dependency>\n+      <groupId>org.xwiki.platform</groupId>\n+      <artifactId>xwiki-platform-test-page</artifactId>\n+      <version>${project.version}</version>\n+      <scope>test</scope>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.xwiki.platform</groupId>\n+      <artifactId>xwiki-platform-uiextension-api</artifactId>\n+      <version>${project.version}</version>\n+      <scope>test</scope>\n+      <type>test-jar</type>\n+    </dependency>\n+    <!-- Provides the component list for RenderingScriptService. -->\n+    <dependency>\n+      <groupId>org.xwiki.platform</groupId>\n+      <artifactId>xwiki-platform-rendering-xwiki</artifactId>\n+      <version>${project.version}</version>\n+      <type>test-jar</type>\n+      <scope>test</scope>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.xwiki.platform</groupId>\n+      <artifactId>xwiki-platform-rendering-configuration-default</artifactId>\n+      <version>${project.version}</version>\n+      <type>test-jar</type>\n+      <scope>test</scope>\n+    </dependency>\n   </dependencies>\n </project>"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-search/xwiki-platform-search-ui/src/main/resources/XWiki/SearchAdmin.xml",
          "status": "modified",
          "additions": 10,
          "deletions": 6,
          "patch": "@@ -34,7 +34,7 @@\n   <title>Search administration</title>\n   <comment/>\n   <minorEdit>false</minorEdit>\n-  <syntaxId>xwiki/2.0</syntaxId>\n+  <syntaxId>xwiki/2.1</syntaxId>\n   <hidden>true</hidden>\n   <content>{{include reference='XWiki.SearchCode' /}}\n \n@@ -55,7 +55,8 @@\n     &lt;dd&gt;\n       &lt;select name='XWiki.SearchConfigClass_0_engine'&gt;\n       #foreach ($availableSearchExtension in $availableSearchExtensions)\n-        &lt;option value=\"$availableSearchExtension.id\" #if($availableSearchExtension.id == $searchEngine)selected='selected'#end&gt;$availableSearchExtension.parameters.label&lt;/option&gt;\n+        &lt;option value=\"$escapetool.xml($availableSearchExtension.id)\" #if($availableSearchExtension.id == $searchEngine)\n+        selected='selected'#end &gt;$escapetool.xml($availableSearchExtension.parameters.label)&lt;/option&gt;\n       #end\n       &lt;/select&gt;\n     &lt;/dd&gt;\n@@ -76,17 +77,20 @@\n     {{html clean=\"false\"}}\n     &lt;ul class=\"nav nav-tabs\" role=\"tablist\"&gt;\n       &lt;li role=\"presentation\" class=\"active\"&gt;\n-        &lt;a href=\"#${searchEngine}Config\" aria-controls=\"${searchEngine}Config\" role=\"tab\" data-toggle=\"tab\"&gt;\n-          $searchExtension.parameters.label\n+        &lt;a href=\"#${escapetool.xml($searchEngine)}Config\" aria-controls=\"${escapetool.xml($searchEngine)}Config\"\n+          role=\"tab\"\n+          data-toggle=\"tab\"&gt;\n+          $escapetool.xml($searchExtension.parameters.label)\n         &lt;/a&gt;\n       &lt;/li&gt;\n     &lt;/ul&gt;\n     {{/html}}\n \n     (% class=\"tab-content\" %)(((\n-      (% role=\"tabpanel\" class=\"tab-pane active\" id=\"${searchEngine}Config\" %)(((\n+      (% role=\"tabpanel\" class=\"tab-pane active\" id=\"${services.rendering.escape($searchEngine, 'xwiki/2.1')}Config\"\n+      %)(((\n         ## Use context='new' in the include so that we can use PR.\n-        {{include reference=\"$searchAdminPage\" context='new'}}\n+        {{include reference=\"$services.rendering.escape($searchAdminPage, 'xwiki/2.1')\" context='new'}}\n       )))\n     )))\n   #end"
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-search/xwiki-platform-search-ui/src/test/java/org/xwiki/search/ui/SearchAdminPageTest.java",
          "status": "added",
          "additions": 145,
          "deletions": 0,
          "patch": "@@ -0,0 +1,145 @@\n+/*\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+package org.xwiki.search.ui;\n+\n+import org.jsoup.nodes.Document;\n+import org.jsoup.nodes.Element;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.xwiki.bridge.event.DocumentCreatedEvent;\n+import org.xwiki.component.manager.ComponentManager;\n+import org.xwiki.component.wiki.internal.bridge.DefaultWikiObjectComponentManagerEventListener;\n+import org.xwiki.context.internal.concurrent.DefaultContextStoreManager;\n+import org.xwiki.model.reference.DocumentReference;\n+import org.xwiki.observation.EventListener;\n+import org.xwiki.rendering.RenderingScriptServiceComponentList;\n+import org.xwiki.rendering.internal.configuration.DefaultRenderingConfigurationComponentList;\n+import org.xwiki.test.annotation.ComponentList;\n+import org.xwiki.test.page.HTML50ComponentList;\n+import org.xwiki.test.page.PageTest;\n+import org.xwiki.test.page.TestNoScriptMacro;\n+import org.xwiki.test.page.XWikiSyntax21ComponentList;\n+import org.xwiki.uiextension.internal.UIExtensionClassDocumentInitializer;\n+import org.xwiki.uiextension.internal.WikiUIExtensionConstants;\n+import org.xwiki.uiextension.script.UIExtensionScriptServiceComponentList;\n+\n+import com.xpn.xwiki.doc.XWikiDocument;\n+import com.xpn.xwiki.objects.BaseObject;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.when;\n+\n+/**\n+ * Page test for {@code XWiki.SearchAdmin}.\n+ *\n+ * @version $Id$\n+ */\n+@ComponentList({ UIExtensionClassDocumentInitializer.class, DefaultContextStoreManager.class, TestNoScriptMacro.class })\n+@UIExtensionScriptServiceComponentList\n+@RenderingScriptServiceComponentList\n+@DefaultRenderingConfigurationComponentList\n+@HTML50ComponentList\n+@XWikiSyntax21ComponentList\n+class SearchAdminPageTest extends PageTest\n+{\n+    private static final String WIKI_NAME = \"xwiki\";\n+\n+    private static final String XWIKI_SPACE = \"XWiki\";\n+\n+    private static final DocumentReference SEARCH_ADMIN_SHEET =\n+        new DocumentReference(WIKI_NAME, XWIKI_SPACE, \"SearchAdmin\");\n+\n+    private static final DocumentReference ADMIN_REFERENCE = new DocumentReference(WIKI_NAME, XWIKI_SPACE, \"Admin\");\n+\n+    @BeforeEach\n+    void setUp() throws Exception\n+    {\n+        // Initialize the UIExtension class.\n+        this.xwiki.initializeMandatoryDocuments(this.context);\n+\n+        when(this.oldcore.getMockAuthorizationManager().hasAccess(any(), eq(ADMIN_REFERENCE), any())).thenReturn(true);\n+\n+        // Register the component manager as wiki component manager so that the UIX can be registered on the wiki.\n+        this.componentManager.registerComponent(ComponentManager.class, \"wiki\", this.componentManager);\n+    }\n+\n+    @Test\n+    void escapesExtensionProperties() throws Exception\n+    {\n+        // Create a document with a UI extension to test on.\n+        DocumentReference docRef = new DocumentReference(WIKI_NAME, XWIKI_SPACE, \"Test\");\n+        XWikiDocument document = new XWikiDocument(docRef);\n+        // Set the author to admin so the UIX can be registered at wiki level.\n+        document.setAuthorReference(ADMIN_REFERENCE);\n+        BaseObject uiExtensionObject =\n+            document.newXObject(WikiUIExtensionConstants.UI_EXTENSION_CLASS, this.context);\n+        uiExtensionObject.setStringValue(WikiUIExtensionConstants.EXTENSION_POINT_ID_PROPERTY,\n+            \"org.xwiki.platform.search\");\n+        String id = \"\\\")}}{{noscript /}}\";\n+        uiExtensionObject.setStringValue(WikiUIExtensionConstants.ID_PROPERTY, id);\n+        String label = \"Label {{noscript /}}\";\n+        String adminPageName = \"\\\"}}{{noscript /}}Admin\";\n+        String adminPage = XWIKI_SPACE + \".\" + adminPageName;\n+        uiExtensionObject.setLargeStringValue(WikiUIExtensionConstants.PARAMETERS_PROPERTY, \"label=\" + label + \"\\n\"\n+            + \"admin=\" + adminPage);\n+        uiExtensionObject.setStringValue(WikiUIExtensionConstants.SCOPE_PROPERTY, \"wiki\");\n+        this.xwiki.saveDocument(document, this.context);\n+\n+        // The event listeners are not registered by default. We trigger it manually so that the UIX is registered and\n+        // can be found and rendered.\n+        this.componentManager\n+            .<EventListener>getInstance(EventListener.class,\n+                DefaultWikiObjectComponentManagerEventListener.EVENT_LISTENER_NAME)\n+            .onEvent(new DocumentCreatedEvent(), document, null);\n+\n+        // Create the fake search admin page.\n+        DocumentReference searchAdminReference = new DocumentReference(WIKI_NAME, XWIKI_SPACE, adminPageName);\n+        XWikiDocument searchAdminDocument = new XWikiDocument(searchAdminReference);\n+        String searchAdminPageContent = \"Search Admin Page Content\";\n+        searchAdminDocument.setContent(searchAdminPageContent);\n+        this.xwiki.saveDocument(searchAdminDocument, this.context);\n+\n+        // Load XWiki.SearchCode and XWiki.SearchConfigClass as the SearchAdmin page uses them.\n+        loadPage(new DocumentReference(WIKI_NAME, XWIKI_SPACE, \"SearchCode\"));\n+        loadPage(new DocumentReference(WIKI_NAME, XWIKI_SPACE, \"SearchConfigClass\"));\n+\n+        Document htmlPage = renderHTMLPage(SEARCH_ADMIN_SHEET);\n+\n+        Element optionElement = htmlPage.selectFirst(\"select option\");\n+        assertNotNull(optionElement);\n+        assertEquals(id, optionElement.attr(\"value\"));\n+        assertEquals(label, optionElement.text());\n+\n+        Element tabLink = htmlPage.selectFirst(\"ul.nav-tabs li a\");\n+        assertNotNull(tabLink);\n+        String tabId = String.format(\"%sConfig\", id);\n+        assertEquals(\"#\" + tabId, tabLink.attr(\"href\"));\n+        assertEquals(tabId, tabLink.attr(\"aria-controls\"));\n+        assertEquals(label, tabLink.text());\n+\n+        Element tabContent = htmlPage.selectFirst(\"div.tab-content div.tab-pane\");\n+        assertNotNull(tabContent);\n+        assertEquals(tabId, tabContent.attr(\"id\"));\n+        assertEquals(searchAdminPageContent, tabContent.text());\n+    }\n+}"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 3,
        "max_directory_depth": 10
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "88e3e7d23cbd3e6ed059dbcd6532f94016d42678",
            "date": "2025-01-13T16:58:06Z",
            "author_login": "Sereza7"
          },
          {
            "sha": "9b506ab2bed52744b52699ea05cde15986d42abb",
            "date": "2025-01-13T16:36:24Z",
            "author_login": "mflorea"
          },
          {
            "sha": "d53d6e347b97ac20f60e21fb2bae381f4aaf10f4",
            "date": "2025-01-13T13:25:24Z",
            "author_login": "tmortagne"
          },
          {
            "sha": "d85bd8f9c67c412e0cfb45fb4695b8d4e759bab6",
            "date": "2025-01-13T12:03:22Z",
            "author_login": "tmortagne"
          },
          {
            "sha": "6f210dabc99167cf9f020a048c88325eca34ceea",
            "date": "2025-01-13T08:54:32Z",
            "author_login": "tmortagne"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 9.9,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H",
    "cwe_id": "CWE-94",
    "description": "XWiki Platform is a generic wiki platform. Starting in 4.5-rc-1 and prior to versions 14.10.15, 15.5.2, and 15.7-rc-1, the search administration interface doesn't properly escape the id and label of search user interface extensions, allowing the injection of XWiki syntax containing script macros including Groovy macros that allow remote code execution, impacting the confidentiality, integrity and availability of the whole XWiki instance. This attack can be executed by any user who can edit some wiki page like the user's profile (editable by default) as user interface extensions that will be displayed in the search administration can be added on any document by any user.  The necessary escaping has been added in XWiki 14.10.15, 15.5.2 and 15.7RC1. As a workaround, the patch can be applied manually applied to the page `XWiki.SearchAdmin`.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2023-12-15T19:15:09.667",
    "last_modified": "2024-11-21T08:37:12.550",
    "fix_date": "2023-08-09T14:21:01Z"
  },
  "references": [
    {
      "url": "https://github.com/xwiki/xwiki-platform/commit/62863736d78ffd60d822279c5fb7fb9593042766",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/security/advisories/GHSA-7654-vfh6-rw6x",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://jira.xwiki.org/browse/XWIKI-21200",
      "source": "security-advisories@github.com",
      "tags": [
        "Issue Tracking",
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/commit/62863736d78ffd60d822279c5fb7fb9593042766",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/security/advisories/GHSA-7654-vfh6-rw6x",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://jira.xwiki.org/browse/XWIKI-21200",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Issue Tracking",
        "Patch",
        "Vendor Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:06:41.577055",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "xwiki-platform",
    "owner": "xwiki",
    "created_at": "2011-03-10T13:26:41Z",
    "updated_at": "2025-01-13T16:58:10Z",
    "pushed_at": "2025-01-14T12:32:03Z",
    "size": 561595,
    "stars": 1030,
    "forks": 554,
    "open_issues": 136,
    "watchers": 1030,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "Java": 34276921,
      "JavaScript": 2392892,
      "HTML": 388086,
      "Less": 318945,
      "AspectJ": 280487,
      "Vue": 222987,
      "CSS": 115460,
      "XSLT": 109285,
      "Clean": 44054,
      "Shell": 32569,
      "Batchfile": 14604,
      "Python": 5046,
      "Groovy": 3012,
      "AMPL": 1296
    },
    "commit_activity": {
      "total_commits_last_year": 1723,
      "avg_commits_per_week": 33.13461538461539,
      "days_active_last_year": 263
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "lgpl-2.1"
    },
    "collected_at": "2025-01-14T12:58:58.685838"
  }
}