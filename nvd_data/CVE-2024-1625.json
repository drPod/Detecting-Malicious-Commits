{
  "cve_id": "CVE-2024-1625",
  "github_data": {
    "repository": "lunary-ai/lunary",
    "fix_commit": "88f98e29f19da9d1f5de45c5b163fd5b48e0bcec",
    "related_commits": [
      "88f98e29f19da9d1f5de45c5b163fd5b48e0bcec",
      "88f98e29f19da9d1f5de45c5b163fd5b48e0bcec"
    ],
    "patch_url": "https://github.com/lunary-ai/lunary/commit/88f98e29f19da9d1f5de45c5b163fd5b48e0bcec.patch",
    "fix_commit_details": {
      "sha": "88f98e29f19da9d1f5de45c5b163fd5b48e0bcec",
      "commit_date": "2024-02-19T12:32:01Z",
      "author": {
        "login": "hughcrt",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "fix: project deletion safeguard",
        "length": 31,
        "has_description": false,
        "references_issue": true
      },
      "stats": {
        "total": 29,
        "additions": 28,
        "deletions": 1
      },
      "files": [
        {
          "filename": "packages/backend/src/api/v1/projects/index.ts",
          "status": "modified",
          "additions": 15,
          "deletions": 1,
          "patch": "@@ -1,3 +1,4 @@\n+import { verifyProjectAccess } from \"@/src/utils/authorization\"\n import sql from \"@/src/utils/db\"\n import Context from \"@/src/utils/koa\"\n import Router from \"koa-router\"\n@@ -69,14 +70,27 @@ projects.post(\"/\", async (ctx: Context) => {\n \n projects.delete(\"/:projectId\", async (ctx: Context) => {\n   const { projectId } = ctx.params\n-  const { orgId } = ctx.state\n+  const { orgId, userId } = ctx.state\n+  console.log(ctx.state)\n+\n+  const hasProjectAccess = await verifyProjectAccess(projectId, userId)\n+  const [user] = await sql`select * from account where id = ${userId}`\n+\n+  if (!hasProjectAccess) {\n+    ctx.throw(401, \"Not allowed\")\n+  }\n+\n+  if (user.role !== \"admin\") {\n+    ctx.throw(403, \"You must be an admin to delete a project\")\n+  }\n \n   const [{ count }] =\n     await sql`select count(*)::int from  project where org_id = ${orgId}`\n \n   if (count > 1) {\n     await sql`delete from project where id = ${projectId}`\n     ctx.status = 200\n+    ctx.body = {}\n   } else {\n     ctx.status = 422\n "
        },
        {
          "filename": "packages/backend/src/utils/authorization.ts",
          "status": "added",
          "additions": 13,
          "deletions": 0,
          "patch": "@@ -0,0 +1,13 @@\n+import sql from \"./db\"\n+\n+export async function verifyProjectAccess(projectId: string, userId: string) {\n+  const [{ exists: hasAccess }] = await sql`\n+      select exists (\n+        select 1 \n+        from project \n+        where org_id = (select org_id from account where id = ${userId}) \n+          and id = ${projectId}\n+      )\n+    `\n+  return hasAccess\n+}"
        }
      ],
      "file_patterns": {
        "security_files": 1,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 2,
        "max_directory_depth": 6
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "a4c1a889ecc4329f4b8fc976904d08cd57636546",
            "date": "2025-01-13T15:25:14Z",
            "author_login": "hughcrt"
          },
          {
            "sha": "2447a7cc873d1f96fcc150a00f3d46ff13f4964c",
            "date": "2025-01-12T16:53:00Z",
            "author_login": "hughcrt"
          },
          {
            "sha": "a3211170ffe39424c54a102d4afa27cec99c362d",
            "date": "2025-01-12T16:48:23Z",
            "author_login": "hughcrt"
          },
          {
            "sha": "ea73f8db2ec427defadb4d70c56ebfc65964b677",
            "date": "2025-01-11T00:32:52Z",
            "author_login": "hughcrt"
          },
          {
            "sha": "32974c788404aa69fd55709231e8834777dee7ab",
            "date": "2025-01-10T22:45:01Z",
            "author_login": "hughcrt"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.5,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:H/A:N",
    "cwe_id": "CWE-863",
    "description": "An Insecure Direct Object Reference (IDOR) vulnerability exists in the lunary-ai/lunary application version 0.3.0, allowing unauthorized deletion of any organization's project. The vulnerability is due to insufficient authorization checks in the project deletion endpoint, where the endpoint fails to verify if the project ID provided in the request belongs to the requesting user's organization. As a result, an attacker can delete projects belonging to any organization by sending a crafted DELETE request with the target project's ID. This issue affects the project deletion functionality implemented in the projects.delete route.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2024-04-10T17:15:52.727",
    "last_modified": "2025-01-08T18:58:39.100",
    "fix_date": "2024-02-19T12:32:01Z"
  },
  "references": [
    {
      "url": "https://github.com/lunary-ai/lunary/commit/88f98e29f19da9d1f5de45c5b163fd5b48e0bcec",
      "source": "security@huntr.dev",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://huntr.com/bounties/cf6dd625-e6c9-44df-a072-13686816de21",
      "source": "security@huntr.dev",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Patch",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/lunary-ai/lunary/commit/88f98e29f19da9d1f5de45c5b163fd5b48e0bcec",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://huntr.com/bounties/cf6dd625-e6c9-44df-a072-13686816de21",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Patch",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:08:04.464989",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "lunary",
    "owner": "lunary-ai",
    "created_at": "2023-05-12T10:03:05Z",
    "updated_at": "2025-01-13T15:25:18Z",
    "pushed_at": "2025-01-13T15:25:16Z",
    "size": 5319,
    "stars": 1133,
    "forks": 139,
    "open_issues": 0,
    "watchers": 1133,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [
      "llm-1533-allow-filtering-by-feedback-in-thread-and-trace-page",
      "llm-1666-improve-exports-for-traces-enable-export-for-threads",
      "llm-1708-when-clicking-on-a-trace-row-theres-a-quick-render-bug-that",
      "llm-1711-save-row-sorting-in-views",
      "llm-1906-allow-a-team-owner-to-make-another-user-owner-instead-of",
      "llm-1910-prompts-settings-bug",
      "llm-1911-invite-button-doesnt-show-a-success-notification",
      "llm-1922-button-next-to-metadata-that-redirects-to-search",
      "llm-1939-integer-out-of-range-error-on-lunary-app",
      "llm-1942-implement-streaming-from-database-for-csvjsonl-exports",
      "llm-1966-long-project-names-are-croped-in-project-drowndopre",
      "llm-2101-sign-in-with-github",
      "main",
      "playwright_test_feedback_comment_dataset_user"
    ],
    "languages": {
      "TypeScript": 1181050,
      "Python": 112937,
      "CSS": 8238,
      "JavaScript": 3378,
      "Shell": 522
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "apache-2.0"
    },
    "collected_at": "2025-01-14T13:04:58.689247"
  }
}