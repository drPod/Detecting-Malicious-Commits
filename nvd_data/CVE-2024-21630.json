{
  "cve_id": "CVE-2024-21630",
  "github_data": {
    "repository": "zulip/zulip",
    "fix_commit": "0df7bd71f32f3b772e2646c6ab0d60c9b610addf",
    "related_commits": [
      "0df7bd71f32f3b772e2646c6ab0d60c9b610addf",
      "0df7bd71f32f3b772e2646c6ab0d60c9b610addf"
    ],
    "patch_url": "https://github.com/zulip/zulip/commit/0df7bd71f32f3b772e2646c6ab0d60c9b610addf.patch",
    "fix_commit_details": {
      "sha": "0df7bd71f32f3b772e2646c6ab0d60c9b610addf",
      "commit_date": "2024-01-05T03:58:39Z",
      "author": {
        "login": "sahil839",
        "type": "User",
        "stats": {
          "total_commits": 1966,
          "average_weekly_commits": 3.038639876352396,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 234
        }
      },
      "commit_message": {
        "title": "CVE-2024-21630: Check permission to subscribe others using invite link.",
        "length": 577,
        "has_description": true,
        "references_issue": false
      },
      "stats": {
        "total": 62,
        "additions": 62,
        "deletions": 0
      },
      "files": [
        {
          "filename": "zerver/tests/test_invite.py",
          "status": "modified",
          "additions": 59,
          "deletions": 0,
          "patch": "@@ -2463,6 +2463,65 @@ def test_create_multiuse_link_with_specified_streams_api_call(self) -> None:\n         self.assert_length(get_default_streams_for_realm_as_dicts(self.realm.id), 1)\n         self.check_user_subscribed_only_to_streams(\"alice\", [])\n \n+    def test_multiuse_invite_without_permission_to_subscribe_others(self) -> None:\n+        realm = get_realm(\"zulip\")\n+        members_group = UserGroup.objects.get(\n+            name=SystemGroups.MEMBERS, realm=realm, is_system_group=True\n+        )\n+        do_change_realm_permission_group_setting(\n+            realm, \"create_multiuse_invite_group\", members_group, acting_user=None\n+        )\n+        do_set_realm_property(\n+            realm, \"invite_to_stream_policy\", Realm.POLICY_ADMINS_ONLY, acting_user=None\n+        )\n+\n+        self.login(\"hamlet\")\n+        stream_names = [\"Rome\", \"Scotland\", \"Venice\"]\n+        streams = [get_stream(stream_name, self.realm) for stream_name in stream_names]\n+        stream_ids = [stream.id for stream in streams]\n+        result = self.client_post(\n+            \"/json/invites/multiuse\",\n+            {\n+                \"stream_ids\": orjson.dumps(stream_ids).decode(),\n+                \"invite_expires_in_minutes\": 2 * 24 * 60,\n+            },\n+        )\n+        self.assert_json_error(\n+            result, \"You do not have permission to subscribe other users to streams.\"\n+        )\n+\n+        result = self.client_post(\n+            \"/json/invites/multiuse\",\n+            {\n+                \"stream_ids\": orjson.dumps([]).decode(),\n+                \"invite_expires_in_minutes\": 2 * 24 * 60,\n+            },\n+        )\n+        self.assert_json_success(result)\n+\n+        self.login(\"iago\")\n+        result = self.client_post(\n+            \"/json/invites/multiuse\",\n+            {\n+                \"stream_ids\": orjson.dumps(stream_ids).decode(),\n+                \"invite_expires_in_minutes\": 2 * 24 * 60,\n+            },\n+        )\n+        self.assert_json_success(result)\n+\n+        do_set_realm_property(\n+            realm, \"invite_to_stream_policy\", Realm.POLICY_MEMBERS_ONLY, acting_user=None\n+        )\n+        self.login(\"hamlet\")\n+        result = self.client_post(\n+            \"/json/invites/multiuse\",\n+            {\n+                \"stream_ids\": orjson.dumps(stream_ids).decode(),\n+                \"invite_expires_in_minutes\": 2 * 24 * 60,\n+            },\n+        )\n+        self.assert_json_success(result)\n+\n     def test_create_multiuse_invite_group_setting(self) -> None:\n         realm = get_realm(\"zulip\")\n         full_members_system_group = UserGroup.objects.get("
        },
        {
          "filename": "zerver/views/invite.py",
          "status": "modified",
          "additions": 3,
          "deletions": 0,
          "patch": "@@ -227,6 +227,9 @@ def generate_multiuse_invite_backend(\n             )\n         streams.append(stream)\n \n+    if len(streams) and not user_profile.can_subscribe_other_users():\n+        raise JsonableError(_(\"You do not have permission to subscribe other users to streams.\"))\n+\n     invite_link = do_create_multiuse_invite_link(\n         user_profile, invite_as, invite_expires_in_minutes, streams\n     )"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 2,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "6a44364a69e5c00d7f5aa1f80ea0afdc1128c901",
            "date": "2025-01-14T06:21:14Z",
            "author_login": "amanagr"
          },
          {
            "sha": "6d495a270ef54806e24db3a6d28f3aba69f3f134",
            "date": "2025-01-14T14:12:45Z",
            "author_login": "amanagr"
          },
          {
            "sha": "2aff7ce9b5e114d25dd09d1d7ca464f2a12822e5",
            "date": "2025-01-13T23:34:39Z",
            "author_login": "andersk"
          },
          {
            "sha": "f223251ffe5ffb5044d3a1d285198d3e056d137f",
            "date": "2025-01-13T23:26:37Z",
            "author_login": "andersk"
          },
          {
            "sha": "653b0b0436baca494b5a794270b6637ac7c9827a",
            "date": "2025-01-13T23:31:03Z",
            "author_login": "andersk"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 4.3,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N",
    "cwe_id": "CWE-862",
    "description": "Zulip is an open-source team collaboration tool. A vulnerability in version 8.0 is similar to CVE-2023-32677, but applies to multi-use invitations, not single-use invitation links as in the prior CVE. Specifically, it applies when the installation has configured non-admins to be able to invite users and create multi-use invitations, and has also configured only admins to be able to invite users to streams. As in CVE-2023-32677, this does not let users invite new users to arbitrary streams, only to streams that the inviter can already see. Version 8.1 fixes this issue. As a workaround, administrators can limit sending of invitations down to users who also have the permission to add users to streams.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2024-01-25T20:15:40.423",
    "last_modified": "2024-11-21T08:54:45.760",
    "fix_date": "2024-01-05T03:58:39Z"
  },
  "references": [
    {
      "url": "https://github.com/zulip/zulip/commit/0df7bd71f32f3b772e2646c6ab0d60c9b610addf",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/zulip/zulip/security/advisories/GHSA-87p9-wprh-7rm6",
      "source": "security-advisories@github.com",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/zulip/zulip/security/advisories/GHSA-mrvp-96q6-jpvc",
      "source": "security-advisories@github.com",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://zulip.com/help/configure-who-can-invite-to-streams",
      "source": "security-advisories@github.com",
      "tags": [
        "Product"
      ]
    },
    {
      "url": "https://zulip.com/help/restrict-account-creation#change-who-can-send-invitations",
      "source": "security-advisories@github.com",
      "tags": [
        "Product"
      ]
    },
    {
      "url": "https://github.com/zulip/zulip/commit/0df7bd71f32f3b772e2646c6ab0d60c9b610addf",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/zulip/zulip/security/advisories/GHSA-87p9-wprh-7rm6",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/zulip/zulip/security/advisories/GHSA-mrvp-96q6-jpvc",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://zulip.com/help/configure-who-can-invite-to-streams",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Product"
      ]
    },
    {
      "url": "https://zulip.com/help/restrict-account-creation#change-who-can-send-invitations",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Product"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:07:05.529795",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "zulip",
    "owner": "zulip",
    "created_at": "2015-09-25T16:37:25Z",
    "updated_at": "2025-01-14T13:31:30Z",
    "pushed_at": "2025-01-14T02:34:21Z",
    "size": 495185,
    "stars": 21946,
    "forks": 8107,
    "open_issues": 2487,
    "watchers": 21946,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [
      "1.4.x",
      "1.5.x",
      "1.8.x",
      "1.9.x",
      "2.0.x",
      "2.1.x",
      "3.x",
      "3.1-with-bmemcached",
      "4.x",
      "4.0-rc1-branch",
      "5.x",
      "5.x-user-sharding",
      "5.0-rc1-branch",
      "5.0-rc2-branch",
      "6.x",
      "6.0-beta1-branch",
      "6.0-rc1-branch",
      "7.x",
      "7.0-beta1-branch",
      "7.0-beta2-branch",
      "8.x",
      "9.x",
      "buddy-list-prep",
      "chat.zulip.org",
      "dockertest",
      "main",
      "s3-compatible-uploads",
      "zulip-cloud-current"
    ],
    "languages": {
      "Python": 14193798,
      "TypeScript": 4055572,
      "JavaScript": 2278673,
      "HTML": 957053,
      "CSS": 942085,
      "Handlebars": 597145,
      "Shell": 161466,
      "Puppet": 137563,
      "Perl": 10353,
      "Dockerfile": 4219,
      "Ruby": 3794,
      "Emacs Lisp": 157
    },
    "commit_activity": {
      "total_commits_last_year": 6397,
      "avg_commits_per_week": 123.01923076923077,
      "days_active_last_year": 356
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "apache-2.0"
    },
    "collected_at": "2025-01-14T13:44:17.890508"
  }
}