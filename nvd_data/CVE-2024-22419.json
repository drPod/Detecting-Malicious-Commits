{
  "cve_id": "CVE-2024-22419",
  "github_data": {
    "repository": "vyperlang/vyper",
    "fix_commit": "55e18f6d128b2da8986adbbcccf1cd59a4b9ad6f",
    "related_commits": [
      "55e18f6d128b2da8986adbbcccf1cd59a4b9ad6f",
      "55e18f6d128b2da8986adbbcccf1cd59a4b9ad6f"
    ],
    "patch_url": "https://github.com/vyperlang/vyper/commit/55e18f6d128b2da8986adbbcccf1cd59a4b9ad6f.patch",
    "fix_commit_details": {
      "sha": "55e18f6d128b2da8986adbbcccf1cd59a4b9ad6f",
      "commit_date": "2024-01-18T18:08:03Z",
      "author": {
        "login": "charles-cooper",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "fix: concat buffer bug (#3738)",
        "length": 269,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 75,
        "additions": 69,
        "deletions": 6
      },
      "files": [
        {
          "filename": "tests/functional/builtins/codegen/test_concat.py",
          "status": "modified",
          "additions": 64,
          "deletions": 0,
          "patch": "@@ -55,6 +55,70 @@ def krazykonkat(z: Bytes[10]) -> Bytes[25]:\n     print(\"Passed third concat test\")\n \n \n+def test_concat_buffer(get_contract):\n+    # GHSA-2q8v-3gqq-4f8p\n+    code = \"\"\"\n+@internal\n+def bar() -> uint256:\n+    sss: String[2] = concat(\"a\", \"b\")\n+    return 1\n+\n+\n+@external\n+def foo() -> int256:\n+    a: int256 = -1\n+    b: uint256 = self.bar()\n+    return a\n+    \"\"\"\n+    c = get_contract(code)\n+    assert c.foo() == -1\n+\n+\n+def test_concat_buffer2(get_contract):\n+    # GHSA-2q8v-3gqq-4f8p\n+    code = \"\"\"\n+i: immutable(int256)\n+\n+@external\n+def __init__():\n+    i = -1\n+    s: String[2] = concat(\"a\", \"b\")\n+\n+@external\n+def foo() -> int256:\n+    return i\n+    \"\"\"\n+    c = get_contract(code)\n+    assert c.foo() == -1\n+\n+\n+def test_concat_buffer3(get_contract):\n+    # GHSA-2q8v-3gqq-4f8p\n+    code = \"\"\"\n+s: String[1]\n+s2: String[33]\n+s3: String[34]\n+\n+@external\n+def __init__():\n+    self.s = \"a\"\n+    self.s2 = \"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\" # 33*'a'\n+\n+@internal\n+def bar() -> uint256:\n+    self.s3 = concat(self.s, self.s2)\n+    return 1\n+\n+@external\n+def foo() -> int256:\n+    i: int256 = -1\n+    b: uint256 = self.bar()\n+    return i\n+    \"\"\"\n+    c = get_contract(code)\n+    assert c.foo() == -1\n+\n+\n def test_concat_bytes32(get_contract_with_gas_estimation):\n     test_concat_bytes32 = \"\"\"\n @external"
        },
        {
          "filename": "vyper/builtins/functions.py",
          "status": "modified",
          "additions": 5,
          "deletions": 6,
          "patch": "@@ -543,13 +543,12 @@ def build_IR(self, expr, context):\n         else:\n             ret_typ = BytesT(dst_maxlen)\n \n+        # respect API of copy_bytes\n+        bufsize = dst_maxlen + 32\n+        buf = context.new_internal_variable(BytesT(bufsize))\n+\n         # Node representing the position of the output in memory\n-        dst = IRnode.from_list(\n-            context.new_internal_variable(ret_typ),\n-            typ=ret_typ,\n-            location=MEMORY,\n-            annotation=\"concat destination\",\n-        )\n+        dst = IRnode.from_list(buf, typ=ret_typ, location=MEMORY, annotation=\"concat destination\")\n \n         ret = [\"seq\"]\n         # stack item representing our current offset in the dst buffer"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 2,
        "max_directory_depth": 4
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "c208b954564e8fffdd4c86cc3c497e0c3df1aeec",
            "date": "2025-01-14T17:09:31Z",
            "author_login": "charles-cooper"
          },
          {
            "sha": "db8dcc713168b16977b5b07267653c9024f6acea",
            "date": "2025-01-12T17:01:49Z",
            "author_login": "charles-cooper"
          },
          {
            "sha": "10e91d5a2ba6eaab2f7194fd86cefb7a0ff19964",
            "date": "2025-01-12T16:34:14Z",
            "author_login": "tserg"
          },
          {
            "sha": "43259f8953672ef7a19167c6c048d020d82e05da",
            "date": "2025-01-12T16:32:46Z",
            "author_login": "charles-cooper"
          },
          {
            "sha": "9b5523e6131335c81714e7e8af63cc49404f5ce7",
            "date": "2025-01-12T16:19:30Z",
            "author_login": "charles-cooper"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 7.3,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:L/A:L",
    "cwe_id": "CWE-120",
    "description": "Vyper is a Pythonic Smart Contract Language for the Ethereum Virtual Machine. The `concat` built-in can write over the bounds of the memory buffer that was allocated for it and thus overwrite existing valid data. The root cause is that the `build_IR` for `concat` doesn't properly adhere to the API of copy functions (for `>=0.3.2` the `copy_bytes` function). A contract search was performed and no vulnerable contracts were found in production. The buffer overflow can result in the change of semantics of the contract. The overflow is length-dependent and thus it might go unnoticed during contract testing. However, certainly not all usages of concat will result in overwritten valid data as we require it to be in an internal function and close to the return statement where other memory allocations don't occur. This issue has been addressed in 0.4.0.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2024-01-18T19:15:10.550",
    "last_modified": "2024-11-21T08:56:15.020",
    "fix_date": "2024-01-18T18:08:03Z"
  },
  "references": [
    {
      "url": "https://github.com/vyperlang/vyper/commit/55e18f6d128b2da8986adbbcccf1cd59a4b9ad6f",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/vyperlang/vyper/issues/3737",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/vyperlang/vyper/security/advisories/GHSA-2q8v-3gqq-4f8p",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/vyperlang/vyper/commit/55e18f6d128b2da8986adbbcccf1cd59a4b9ad6f",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/vyperlang/vyper/issues/3737",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Issue Tracking",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/vyperlang/vyper/security/advisories/GHSA-2q8v-3gqq-4f8p",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Vendor Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:07:05.502538",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "vyper",
    "owner": "vyperlang",
    "created_at": "2016-11-11T08:56:41Z",
    "updated_at": "2025-01-13T17:32:27Z",
    "pushed_at": "2025-01-12T17:01:50Z",
    "size": 11939,
    "stars": 4948,
    "forks": 817,
    "open_issues": 489,
    "watchers": 4948,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "master"
    ],
    "languages": {
      "Python": 2662211,
      "Makefile": 2222,
      "Batchfile": 1614,
      "Dockerfile": 1145,
      "Shell": 472
    },
    "commit_activity": {
      "total_commits_last_year": 317,
      "avg_commits_per_week": 6.096153846153846,
      "days_active_last_year": 154
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T13:48:09.728520"
  }
}