{
  "cve_id": "CVE-2024-23679",
  "github_data": {
    "repository": "enonic/xp",
    "fix_commit": "0189975691e9e6407a9fee87006f730e84f734ff",
    "related_commits": [
      "0189975691e9e6407a9fee87006f730e84f734ff",
      "1f44674eb9ab3fbab7103e8d08067846e88bace4",
      "2abac31cec8679074debc4f1fb69c25930e40842",
      "0189975691e9e6407a9fee87006f730e84f734ff",
      "1f44674eb9ab3fbab7103e8d08067846e88bace4",
      "2abac31cec8679074debc4f1fb69c25930e40842"
    ],
    "patch_url": "https://github.com/enonic/xp/commit/0189975691e9e6407a9fee87006f730e84f734ff.patch",
    "fix_commit_details": {
      "sha": "0189975691e9e6407a9fee87006f730e84f734ff",
      "commit_date": "2021-12-03T12:31:24Z",
      "author": {
        "login": "vbradnitski",
        "type": "User",
        "stats": {
          "total_commits": 891,
          "average_weekly_commits": 1.3398496240601503,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 247
        }
      },
      "commit_message": {
        "title": "Invalidate old session after login #9253",
        "length": 40,
        "has_description": false,
        "references_issue": true
      },
      "stats": {
        "total": 71,
        "additions": 52,
        "deletions": 19
      },
      "files": [
        {
          "filename": "modules/lib/lib-auth/src/main/java/com/enonic/xp/lib/auth/LoginHandler.java",
          "status": "modified",
          "additions": 31,
          "deletions": 19,
          "patch": "@@ -9,6 +9,7 @@\n \n import com.enonic.xp.context.Context;\n import com.enonic.xp.context.ContextBuilder;\n+import com.enonic.xp.context.LocalScope;\n import com.enonic.xp.portal.PortalRequest;\n import com.enonic.xp.script.bean.BeanContext;\n import com.enonic.xp.script.bean.ScriptBean;\n@@ -30,11 +31,6 @@\n public final class LoginHandler\n     implements ScriptBean\n {\n-    private enum Scope\n-    {\n-        SESSION, REQUEST, NONE\n-    }\n-\n     private String user;\n \n     private String password;\n@@ -113,15 +109,26 @@ public LoginResultMapper login()\n \n     private void createSession( final AuthenticationInfo authInfo )\n     {\n-        final Session session = this.context.get().getLocalScope().getSession();\n+        final LocalScope localScope = this.context.get().getLocalScope();\n+        final Session session = localScope.getSession();\n+\n         if ( session != null )\n         {\n-            session.setAttribute( authInfo );\n-        }\n+            final var attributes = session.getAttributes();\n+            session.invalidate();\n \n-        if ( this.sessionTimeout != null )\n-        {\n-            setSessionTimeout();\n+            final Session newSession = localScope.getSession();\n+\n+            if ( newSession != null )\n+            {\n+                attributes.forEach( newSession::setAttribute );\n+                session.setAttribute( authInfo );\n+\n+                if ( this.sessionTimeout != null )\n+                {\n+                    setSessionTimeout();\n+                }\n+            }\n         }\n     }\n \n@@ -149,9 +156,8 @@ private AuthenticationInfo attemptLoginWithAllExistingIdProviders()\n     private IdProviders getSortedIdProviders()\n     {\n         IdProviders idProviders = securityService.get().getIdProviders();\n-        return IdProviders.from( idProviders.stream().\n-            sorted( Comparator.comparing( u -> u.getKey().toString() ) ).\n-            collect( Collectors.toList() ) );\n+        return IdProviders.from(\n+            idProviders.stream().sorted( Comparator.comparing( u -> u.getKey().toString() ) ).collect( Collectors.toList() ) );\n     }\n \n     private AuthenticationInfo attemptLogin()\n@@ -221,11 +227,12 @@ private AuthenticationInfo authenticate( IdProviderKey idProvider )\n     private <T> T runAsAuthenticated( Callable<T> runnable )\n     {\n         final AuthenticationInfo authInfo = AuthenticationInfo.create().principals( RoleKeys.AUTHENTICATED ).user( User.ANONYMOUS ).build();\n-        return ContextBuilder.from( this.context.get() ).\n-            authInfo( authInfo ).\n-            repositoryId( SystemConstants.SYSTEM_REPO_ID ).\n-            branch( SecurityConstants.BRANCH_SECURITY ).build().\n-            callWith( runnable );\n+        return ContextBuilder.from( this.context.get() )\n+            .authInfo( authInfo )\n+            .repositoryId( SystemConstants.SYSTEM_REPO_ID )\n+            .branch( SecurityConstants.BRANCH_SECURITY )\n+            .build()\n+            .callWith( runnable );\n     }\n \n     private boolean isValidEmail( final String value )\n@@ -253,4 +260,9 @@ public void initialize( final BeanContext context )\n         this.context = context.getBinding( Context.class );\n         this.portalRequestSupplier = context.getBinding( PortalRequest.class );\n     }\n+\n+    private enum Scope\n+    {\n+        SESSION, REQUEST, NONE\n+    }\n }"
        },
        {
          "filename": "modules/lib/lib-auth/src/test/java/com/enonic/xp/lib/auth/LoginHandlerTest.java",
          "status": "modified",
          "additions": 21,
          "deletions": 0,
          "patch": "@@ -23,6 +23,8 @@\n \n import static org.junit.jupiter.api.Assertions.assertEquals;\n import static org.junit.jupiter.api.Assertions.assertNull;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n \n public class LoginHandlerTest\n     extends ScriptTestSupport\n@@ -192,6 +194,25 @@ public void testLoginMultipleIdProvidersInOrder()\n         assertEquals( \"idprovider3\", matcher.loginIdProviderAttempts.get( 2 ).toString() );\n     }\n \n+    @Test\n+    public void testSessionInvalidatedOnLogin()\n+    {\n+        final AuthenticationInfo authInfo = TestDataFixtures.createAuthenticationInfo();\n+\n+        final IdProviders idProviders =\n+            IdProviders.from( IdProvider.create().displayName( \"system\" ).key( IdProviderKey.from( \"system\" ) ).build() );\n+\n+        Mockito.when( this.securityService.authenticate( Mockito.any() ) ).thenReturn( authInfo );\n+        Mockito.when( this.securityService.getIdProviders() ).thenReturn( idProviders );\n+\n+        final SessionMock session = Mockito.spy( new SessionMock() );\n+        ContextAccessor.current().getLocalScope().setSession( session );\n+\n+        runScript( \"/lib/xp/examples/auth/login.js\" );\n+\n+        verify( session, times( 5 ) ).invalidate();\n+    }\n+\n     private static class AuthTokenMatcher\n         implements ArgumentMatcher<AuthenticationToken>\n     {"
        }
      ],
      "file_patterns": {
        "security_files": 2,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 2,
        "max_directory_depth": 11
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "70fb4da93c8ca6e39069164d3970201e8fe36f3c",
            "date": "2025-01-14T12:40:13Z",
            "author_login": "ashklianko"
          },
          {
            "sha": "f1add0bd70cb5000d6eea7e09ea69a8d6e77b33d",
            "date": "2025-01-14T07:05:19Z",
            "author_login": "ashklianko"
          },
          {
            "sha": "c94c217757336eb68c08cd60a781d45abe062f05",
            "date": "2025-01-13T02:04:54Z",
            "author_login": "dependabot[bot]"
          },
          {
            "sha": "51d3aaca7566ef7cc43839ad49aae601c85e6f90",
            "date": "2025-01-13T02:04:42Z",
            "author_login": "dependabot[bot]"
          },
          {
            "sha": "28f08989c5a482a2da91221a43d082133e9c9cec",
            "date": "2024-12-09T02:10:03Z",
            "author_login": "dependabot[bot]"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 9.8,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
    "cwe_id": "CWE-384",
    "description": "Enonic XP versions less than 7.7.4 are vulnerable to a session fixation issue. An remote and unauthenticated attacker can use prior sessions due to the lack of invalidating session attributes.\n\n",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2024-01-19T21:15:10.073",
    "last_modified": "2024-11-21T08:58:09.460",
    "fix_date": "2021-12-03T12:31:24Z"
  },
  "references": [
    {
      "url": "https://github.com/advisories/GHSA-4m5p-5w5w-3jcf",
      "source": "disclosure@vulncheck.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/enonic/xp/commit/0189975691e9e6407a9fee87006f730e84f734ff",
      "source": "disclosure@vulncheck.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/enonic/xp/commit/1f44674eb9ab3fbab7103e8d08067846e88bace4",
      "source": "disclosure@vulncheck.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/enonic/xp/commit/2abac31cec8679074debc4f1fb69c25930e40842",
      "source": "disclosure@vulncheck.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/enonic/xp/issues/9253",
      "source": "disclosure@vulncheck.com",
      "tags": [
        "Issue Tracking"
      ]
    },
    {
      "url": "https://github.com/enonic/xp/security/advisories/GHSA-4m5p-5w5w-3jcf",
      "source": "disclosure@vulncheck.com",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://vulncheck.com/advisories/vc-advisory-GHSA-4m5p-5w5w-3jcf",
      "source": "disclosure@vulncheck.com",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/advisories/GHSA-4m5p-5w5w-3jcf",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/enonic/xp/commit/0189975691e9e6407a9fee87006f730e84f734ff",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/enonic/xp/commit/1f44674eb9ab3fbab7103e8d08067846e88bace4",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/enonic/xp/commit/2abac31cec8679074debc4f1fb69c25930e40842",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/enonic/xp/issues/9253",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Issue Tracking"
      ]
    },
    {
      "url": "https://github.com/enonic/xp/security/advisories/GHSA-4m5p-5w5w-3jcf",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://vulncheck.com/advisories/vc-advisory-GHSA-4m5p-5w5w-3jcf",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:07:05.511153",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "xp",
    "owner": "enonic",
    "created_at": "2012-04-26T12:06:41Z",
    "updated_at": "2025-01-14T13:46:18Z",
    "pushed_at": "2025-01-14T13:46:14Z",
    "size": 292726,
    "stars": 203,
    "forks": 34,
    "open_issues": 257,
    "watchers": 203,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "6.14",
      "6.15",
      "7.0",
      "7.1",
      "7.2",
      "7.3",
      "7.4",
      "7.5",
      "7.6",
      "7.7",
      "7.8",
      "7.9",
      "7.10",
      "7.11",
      "7.12",
      "7.13",
      "7.14",
      "7.15"
    ],
    "languages": {
      "Java": 12154556,
      "JavaScript": 469336,
      "TypeScript": 320168,
      "HTML": 13545,
      "CSS": 11957,
      "XSLT": 3336,
      "Shell": 2237,
      "Batchfile": 1814
    },
    "commit_activity": {
      "total_commits_last_year": 233,
      "avg_commits_per_week": 4.480769230769231,
      "days_active_last_year": 119
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "gpl-3.0"
    },
    "collected_at": "2025-01-14T18:25:15.809099"
  }
}