{
  "cve_id": "CVE-2024-24761",
  "github_data": {
    "repository": "galette/galette",
    "fix_commit": "a5c18bb9819b8da1b3ef58f3e79577083c657fbb",
    "related_commits": [
      "a5c18bb9819b8da1b3ef58f3e79577083c657fbb",
      "a5c18bb9819b8da1b3ef58f3e79577083c657fbb"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "a5c18bb9819b8da1b3ef58f3e79577083c657fbb",
      "commit_date": "2024-02-02T22:05:44Z",
      "author": {
        "login": "trasher",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Merge pull request from GHSA-jrqg-mpwv-pxpv",
        "length": 43,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 143,
        "additions": 116,
        "deletions": 27
      },
      "files": [
        {
          "filename": "galette/includes/main.inc.php",
          "status": "modified",
          "additions": 2,
          "deletions": 26,
          "patch": "@@ -134,32 +134,8 @@\n  */\n $authenticate = new Authenticate($container);\n \n-/**\n- * Show public pages middleware\n- *\n- * @param $request\n- * @param $response\n- * @param $next\n- * @return mixed\n- */\n-$showPublicPages = function (Request $request, RequestHandler $handler) use ($container) {\n-    $response = $handler->handle($request);\n-    $login = $container->get('login');\n-    $preferences = $container->get('preferences');\n-\n-    if (!$preferences->showPublicPages($login)) {\n-        $this->get('flash')->addMessage('error', _T(\"Unauthorized\"));\n-\n-        return $response\n-            ->withStatus(403)\n-            ->withHeader(\n-                'Location',\n-                $this->get(RouteParser::class)->urlFor('slash')\n-            );\n-    }\n-\n-    return $response;\n-};\n+//FIXME: remove in 1.1.0; routes/groups should call middleware directly\n+$showPublicPages = new \\Galette\\Middleware\\PublicPages($container);\n \n //Maintenance middleware\n if (Galette::MODE_MAINT === GALETTE_MODE && !$container->get('login')->isSuperAdmin()) {"
        },
        {
          "filename": "galette/includes/routes/public_pages.routes.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -73,4 +73,4 @@ function ($request, $response) use ($routeparser) {\n                 ->withHeader('Location', $routeparser->urlFor('publicList', $args));\n         }\n     );\n-})->add($showPublicPages);\n+})->add(\\Galette\\Middleware\\PublicPages::class);"
        },
        {
          "filename": "galette/lib/Galette/Middleware/PublicPages.php",
          "status": "added",
          "additions": 113,
          "deletions": 0,
          "patch": "@@ -0,0 +1,113 @@\n+<?php\n+\n+/**\n+ * Copyright \u00a9 2003-2024 The Galette Team\n+ *\n+ * This file is part of Galette (https://galette.eu).\n+ *\n+ * Galette is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Galette is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ *  GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Galette. If not, see <http://www.gnu.org/licenses/>.\n+ *\n+ * @category  Core\n+ * @package   Galette\n+ *\n+ * @author    Johan Cwiklinski <johan@x-tnd.be>\n+ * @copyright 2024 The Galette Team\n+ * @license   http://www.gnu.org/licenses/gpl-3.0.html GPL License 3.0 or (at your option) any later version\n+ * @link      https://galette.eu\n+ */\n+\n+namespace Galette\\Middleware;\n+\n+use Galette\\Core\\Login;\n+use Galette\\Core\\Preferences;\n+use Psr\\Http\\Message\\ServerRequestInterface as Request;\n+use Psr\\Http\\Message\\ResponseInterface as Response;\n+use Psr\\Http\\Server\\RequestHandlerInterface as RequestHandler;\n+use Analog\\Analog;\n+use DI\\Container;\n+use RKA\\Session;\n+use Slim\\Flash\\Messages;\n+use Slim\\Routing\\RouteContext;\n+use Slim\\Routing\\RouteParser;\n+\n+/**\n+ * Galette Slim middleware for public pages access\n+ *\n+ * @category  Core\n+ * @package   Galette\n+ *\n+ * @author    Johan Cwiklinski <johan@x-tnd.be>\n+ * @copyright 2024 The Galette Team\n+ * @license   http://www.gnu.org/licenses/gpl-3.0.html GPL License 3.0 or (at your option) any later version\n+ * @link      https://galette.eu\n+ */\n+class PublicPages\n+{\n+    /**\n+     * @var Messages\n+     */\n+    protected Messages $flash;\n+\n+    /**\n+     * @var Login\n+     */\n+    private Login $login;\n+\n+    /**\n+     * @var RouteParser\n+     */\n+    private RouteParser $routeparser;\n+\n+    /**\n+     * @var Preferences\n+     */\n+    private Preferences $preferences;\n+\n+    /**\n+     * Constructor\n+     *\n+     * @param Container $container Container instance\n+     */\n+    public function __construct(Container $container)\n+    {\n+        $this->login = $container->get('login');\n+        $this->flash = $container->get('flash');\n+        $this->routeparser = $container->get(RouteParser::class);\n+        $this->preferences = $container->get('preferences');\n+    }\n+\n+    /**\n+     * Middleware invokable class\n+     *\n+     * @param Request        $request PSR7 request\n+     * @param RequestHandler $handler PSR7 request handler\n+     *\n+     * @return Response\n+     */\n+    public function __invoke(Request $request, RequestHandler $handler): Response\n+    {\n+        $response = new \\Slim\\Psr7\\Response();\n+\n+        if (!$this->preferences->showPublicPages($this->login)) {\n+            $this->flash->addMessage('error_detected', _T(\"Unauthorized\"));\n+            return $response\n+                ->withHeader(\n+                    'Location',\n+                    $this->routeparser->urlFor('slash')\n+                )->withStatus(302);\n+        }\n+\n+        return $handler->handle($request);\n+    }\n+}"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 3,
        "max_directory_depth": 4
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "828cdaf3f716565f5f9e6f19f32624f04e5ea378",
            "date": "2025-01-24T20:41:36Z",
            "author_login": "trasher"
          },
          {
            "sha": "fe5d5718c166e84ef99d6e11c124ff5a89aa0d6d",
            "date": "2025-01-24T19:54:27Z",
            "author_login": "trasher"
          },
          {
            "sha": "4b62ed2c622c7a052f723698cd530f64b2a8cfc2",
            "date": "2025-01-24T18:29:18Z",
            "author_login": "weblate"
          },
          {
            "sha": "42837fc671accaa2b3e9d0645e72b9897633e76f",
            "date": "2025-01-24T18:51:20Z",
            "author_login": "trasher"
          },
          {
            "sha": "7614d8c0251fba745c0f2dff9ad0c6336722f6ad",
            "date": "2025-01-24T16:20:25Z",
            "author_login": "gagnieray"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 7.5,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N",
    "cwe_id": "CWE-863",
    "description": "Galette is a membership management web application for non profit organizations. Starting in version 1.0.0 and prior to version 1.0.2, public pages are per default restricted to only administrators and staff members. From configuration, it is possible to restrict to up-to-date members or to everyone. Version 1.0.2 fixes this issue.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2024-03-06T18:15:46.620",
    "last_modified": "2024-12-17T20:06:11.133",
    "fix_date": "2024-02-02T22:05:44Z"
  },
  "references": [
    {
      "url": "https://github.com/galette/galette/commit/a5c18bb9819b8da1b3ef58f3e79577083c657fbb",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/galette/galette/security/advisories/GHSA-jrqg-mpwv-pxpv",
      "source": "security-advisories@github.com",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/galette/galette/commit/a5c18bb9819b8da1b3ef58f3e79577083c657fbb",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/galette/galette/security/advisories/GHSA-jrqg-mpwv-pxpv",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Vendor Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:07:38.466820",
    "processing_status": "enhanced"
  },
  "repository_context": {
    "name": "galette",
    "owner": "galette",
    "created_at": "2013-01-14T22:48:07Z",
    "updated_at": "2025-01-24T23:31:53Z",
    "pushed_at": "2025-01-25T07:36:33Z",
    "size": 92508,
    "stars": 55,
    "forks": 33,
    "open_issues": 3,
    "watchers": 55,
    "has_security_policy": false,
    "default_branch": "develop",
    "protected_branches": [],
    "languages": {
      "PHP": 2910353,
      "Twig": 878352,
      "CSS": 72148,
      "Python": 24966,
      "JavaScript": 16960,
      "Makefile": 2637,
      "HTML": 2127,
      "Batchfile": 794,
      "Smarty": 368,
      "Shell": 187
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "gpl-3.0"
    },
    "collected_at": "2025-01-26T08:09:43.679467"
  }
}