{
  "cve_id": "CVE-2024-25130",
  "github_data": {
    "repository": "Enalean/tuleap",
    "fix_commit": "57978a32508f5c6d0365419b6eaeb368aee20667",
    "related_commits": [
      "57978a32508f5c6d0365419b6eaeb368aee20667",
      "57978a32508f5c6d0365419b6eaeb368aee20667"
    ],
    "patch_url": "https://github.com/Enalean/tuleap/commit/57978a32508f5c6d0365419b6eaeb368aee20667.patch",
    "fix_commit_details": {
      "sha": "57978a32508f5c6d0365419b6eaeb368aee20667",
      "commit_date": "2024-02-13T09:38:51Z",
      "author": {
        "login": "LeSuisse",
        "type": "User",
        "stats": {
          "total_commits": 13553,
          "average_weekly_commits": 13.158252427184467,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 479
        }
      },
      "commit_message": {
        "title": "fix: request #36803 Mass update clears permissions on artifact",
        "length": 223,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 211,
        "additions": 128,
        "deletions": 83
      },
      "files": [
        {
          "filename": "plugins/tracker/include/Tracker/FormElement/Tracker_FormElement_Field_PermissionsOnArtifact.php",
          "status": "modified",
          "additions": 26,
          "deletions": 22,
          "patch": "@@ -36,10 +36,11 @@\n //phpcs:ignore PSR1.Classes.ClassDeclaration.MissingNamespace, Squiz.Classes.ValidClassName.NotCamelCaps\n class Tracker_FormElement_Field_PermissionsOnArtifact extends Tracker_FormElement_Field\n {\n-    public const GRANTED_GROUPS     = 'granted_groups';\n-    public const USE_IT             = 'use_artifact_permissions';\n-    public const IS_USED_BY_DEFAULT = false;\n-    public const PERMISSION_TYPE    = 'PLUGIN_TRACKER_ARTIFACT_ACCESS';\n+    public const GRANTED_GROUPS      = 'granted_groups';\n+    public const USE_IT              = 'use_artifact_permissions';\n+    public const DO_MASS_UPDATE_FLAG = 'do_mass_update';\n+    public const IS_USED_BY_DEFAULT  = false;\n+    public const PERMISSION_TYPE     = 'PLUGIN_TRACKER_ARTIFACT_ACCESS';\n \n     public $default_properties = [];\n \n@@ -154,15 +155,18 @@ protected function fetchSubmitValue(array $submitted_values)\n         return $this->getArtifactValueHTML($this->getId(), $is_checked, $is_disabled);\n     }\n \n-    /**\n-     * @return string\n-     */\n-    protected function fetchSubmitValueMasschange()\n+    protected function fetchSubmitValueMasschange(): string\n     {\n+        $mass_change_input_html = TemplateRendererFactory::build()->getRenderer(__DIR__ . '/../../../templates/form-element/')\n+            ->renderToString(\n+                'permissions_on_artifact_massupdate',\n+                ['field_id' => $this->getId(), 'flag_mass_update' => self::DO_MASS_UPDATE_FLAG]\n+            );\n+\n         $is_checked  = false;\n         $is_disabled = false;\n \n-        return $this->getArtifactValueHTML($this->getId(), $is_checked, $is_disabled);\n+        return $mass_change_input_html . $this->getArtifactValueHTML($this->getId(), $is_checked, $is_disabled);\n     }\n \n     /**\n@@ -262,15 +266,15 @@ private function getArtifactValueHTML($artifact_id, $can_user_restrict_permissio\n         return $html;\n     }\n \n-    private function fetchUserGroupList($is_read_only, array $changeset_values)\n+    private function fetchUserGroupList($is_read_only, array $changeset_values): string\n     {\n         $field_id     = $this->getId();\n         $element_name = 'artifact[' . $field_id . '][u_groups][]';\n \n         $hp    = Codendi_HTMLPurifier::instance();\n         $html  = '<select '\n             . 'name=\"' . $hp->purify($element_name) . '\" '\n-            . 'id=\"' . $hp->purify(str_replace('[]', '', $element_name)) . '\" '\n+            . 'id=\"' . $hp->purify('artifact_' . $field_id . '_perms_ugroups' . ($is_read_only ? '_ro' : '')) . '\" '\n             . 'multiple '\n             . 'size=\"8\" '\n             . (($this->isRequired()) ? 'required=\"required\"' : '' )\n@@ -852,32 +856,32 @@ public function getRESTAvailableValues()\n     /**\n      * @param bool $can_user_restrict_permissions_to_nobody\n      * @param bool $disabled\n-     *\n-     * @return string\n      */\n-    private function fetchRestrictCheckbox($can_user_restrict_permissions_to_nobody, $disabled, $is_expecting_input)\n+    private function fetchRestrictCheckbox($can_user_restrict_permissions_to_nobody, $disabled, $is_expecting_input): string\n     {\n         $empty_value_class = '';\n         if ($is_expecting_input) {\n             $empty_value_class = 'empty_value';\n         }\n \n-        $html = '<p class=\"tracker_field_permissionsonartifact ' . $empty_value_class . '\">';\n+        $field_id = Codendi_HTMLPurifier::instance()->purify($this->getId());\n+\n+        $html = '<p class=\"tracker_field_permissionsonartifact ' . $empty_value_class . '\" data-field-id=\"' . $field_id . '\">';\n         if ($this->isRequired() == false) {\n             if (! $disabled) {\n-                $html .= '<input type=\"hidden\" name=\"artifact[' . $this->getId() . '][use_artifact_permissions]\" value=\"0\" />';\n+                $html .= '<input type=\"hidden\" name=\"artifact[' . $field_id . '][use_artifact_permissions]\" value=\"0\" />';\n             }\n-            $html .= '<label class=\"checkbox\" for=\"artifact_' . $this->getId() . '_use_artifact_permissions\">';\n-            $html .= '<input type=\"checkbox\"\n-                        name=\"artifact[' . $this->getId() . '][use_artifact_permissions]\"\n-                        id=\"artifact_' . $this->getId() . '_use_artifact_permissions\"\n+            $read_only_id = $disabled ? '_ro' : '';\n+            $html        .= '<label class=\"checkbox\" for=\"artifact_' . $field_id . '_use_artifact_permissions' . $read_only_id . '\">';\n+            $html        .= '<input type=\"checkbox\"\n+                        name=\"artifact[' . $field_id . '][use_artifact_permissions]\"\n+                        id=\"artifact_' . $field_id . '_use_artifact_permissions' . $read_only_id . '\"\n                         value=\"1\" ' .\n                 (($can_user_restrict_permissions_to_nobody == true) ? 'checked=\"checked\"' : '') .\n                 (($disabled == true) ? 'disabled=\"disabled\"' : '') .\n                 '/>';\n         } else {\n-            $html .= '<input type=\"hidden\" name=\"artifact[' . $this->getId(\n-            ) . '][use_artifact_permissions]\" value=\"1\" />';\n+            $html .= '<input type=\"hidden\" name=\"artifact[' . $field_id . '][use_artifact_permissions]\" value=\"1\" />';\n         }\n \n         $html .= dgettext('tuleap-tracker', 'Restrict access to this artifact for the following user groups:') . '</label>';"
        },
        {
          "filename": "plugins/tracker/include/Tracker/MasschangeDataValueExtractor.class.php",
          "status": "modified",
          "additions": 3,
          "deletions": 0,
          "patch": "@@ -50,6 +50,9 @@ private function hasDataChanged(int $field_id, $data): bool\n         $field = $this->form_element_factory->getFieldById($field_id);\n         if ($field instanceof Tracker_FormElement_Field_List) {\n             return $this->isValueInData($data, (string) BindStaticValueUnchanged::VALUE_ID);\n+        } elseif ($field instanceof Tracker_FormElement_Field_PermissionsOnArtifact) {\n+            return isset($data[Tracker_FormElement_Field_PermissionsOnArtifact::DO_MASS_UPDATE_FLAG]) &&\n+                $data[Tracker_FormElement_Field_PermissionsOnArtifact::DO_MASS_UPDATE_FLAG] === '1';\n         }\n \n         return $this->isValueInData($data, $GLOBALS['Language']->getText('global', 'unchanged'));"
        },
        {
          "filename": "plugins/tracker/scripts/legacy/src/TrackerFormElementFieldPermissions.js",
          "status": "modified",
          "additions": 36,
          "deletions": 29,
          "patch": "@@ -1,58 +1,65 @@\n /**\n+ * Copyright (c) Enalean, 2024 - present. All Rights Reserved.\n  * Copyright (c) Xerox Corporation, Codendi Team, 2001-2008. All rights reserved\n  *\n  * Originally written by Nicolas Terray, 2008\n  *\n- * This file is a part of Codendi.\n+ * This file is a part of Tuleap.\n  *\n- * Codendi is free software; you can redistribute it and/or modify\n+ * Tuleap is free software; you can redistribute it and/or modify\n  * it under the terms of the GNU General Public License as published by\n  * the Free Software Foundation; either version 2 of the License, or\n  * (at your option) any later version.\n  *\n- * Codendi is distributed in the hope that it will be useful,\n+ * Tuleap is distributed in the hope that it will be useful,\n  * but WITHOUT ANY WARRANTY; without even the implied warranty of\n  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n  * GNU General Public License for more details.\n  *\n  * You should have received a copy of the GNU General Public License\n- * along with Codendi; if not, write to the Free Software\n+ * along with Tuleap; if not, write to the Free Software\n  * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA\n  *\n  *\n  */\n \n-/* global jQuery:readonly */\n-\n-(function ($) {\n+document.addEventListener(\"DOMContentLoaded\", function () {\n     function init() {\n-        $(\".tracker_field_permissionsonartifact\").each(function (index, element) {\n-            disablePermissionsFieldIfNeeded(element);\n-            bindSwitch(element);\n-        });\n+        const elements = document.getElementsByClassName(\"tracker_field_permissionsonartifact\");\n+        for (const element of elements) {\n+            const field_id = element.dataset.fieldId;\n+            const select_ugroups = document.getElementById(`artifact_${field_id}_perms_ugroups`);\n+            const checkbox_use_perms = document.getElementById(\n+                `artifact_${field_id}_use_artifact_permissions`,\n+            );\n+            if (select_ugroups === null || checkbox_use_perms === null) {\n+                continue;\n+            }\n+            disablePermissionsFieldIfNeeded(checkbox_use_perms, select_ugroups);\n+            bindSwitch(checkbox_use_perms, select_ugroups);\n+            const checkbox_activate_masschange_update = document.getElementById(\n+                `artifact_${field_id}_perms_mass_update`,\n+            );\n+            if (checkbox_activate_masschange_update) {\n+                checkbox_use_perms.disabled = true;\n+                checkbox_activate_masschange_update.addEventListener(\"change\", () => {\n+                    checkbox_use_perms.disabled = !checkbox_activate_masschange_update.checked;\n+                });\n+            }\n+        }\n     }\n \n-    function disablePermissionsFieldIfNeeded(element) {\n-        if ($(\"input[type='checkbox']\", element).is(\":not(:checked)\")) {\n-            $(element).siblings(\"select\").attr(\"disabled\", \"disabled\");\n+    function disablePermissionsFieldIfNeeded(checkbox_use_perms, select_ugroups) {\n+        if (!checkbox_use_perms.checked) {\n+            select_ugroups.disabled = true;\n         }\n     }\n \n-    function bindSwitch(element) {\n-        $(\"input[type='checkbox']\", element).bind(\"change\", function () {\n-            togglePermissionsField(element);\n+    function bindSwitch(checkbox_use_perms, select_ugroups) {\n+        checkbox_use_perms.addEventListener(\"change\", () => {\n+            select_ugroups.disabled = !checkbox_use_perms.checked;\n         });\n     }\n \n-    function togglePermissionsField(element) {\n-        if ($(\"input[type='checkbox']\", element).is(\":not(:checked)\")) {\n-            $(element).siblings(\"select\").attr(\"disabled\", \"disabled\");\n-        } else {\n-            $(element).siblings(\"select\").removeAttr(\"disabled\");\n-        }\n-    }\n-\n-    $(document).ready(function () {\n-        init();\n-    });\n-})(jQuery);\n+    init();\n+});"
        },
        {
          "filename": "plugins/tracker/site-content/fr_FR/LC_MESSAGES/tuleap-tracker.po",
          "status": "modified",
          "additions": 3,
          "deletions": 0,
          "patch": "@@ -4294,6 +4294,9 @@ msgstr \"Modifier le rappel\"\n msgid \"Update semantic\"\n msgstr \"Mettre \u00e0 jour la s\u00e9mantique\"\n \n+msgid \"Update the permissions, by default nothing is changed\"\n+msgstr \"Mettre \u00e0 jour les permissions, par d\u00e9faut rien ne change\"\n+\n msgid \"Update to overridable computed field\"\n msgstr \"Mettre \u00e0 jour vers champ calcul\u00e9 modifiable\"\n "
        },
        {
          "filename": "plugins/tracker/site-content/pt_BR/LC_MESSAGES/tuleap-tracker.po",
          "status": "modified",
          "additions": 3,
          "deletions": 0,
          "patch": "@@ -3786,6 +3786,9 @@ msgstr \"\"\n msgid \"Update semantic\"\n msgstr \"\"\n \n+msgid \"Update the permissions, by default nothing is changed\"\n+msgstr \"\"\n+\n msgid \"Update to overridable computed field\"\n msgstr \"\"\n "
        },
        {
          "filename": "plugins/tracker/templates/form-element/permissions_on_artifact_massupdate.mustache",
          "status": "added",
          "additions": 8,
          "deletions": 0,
          "patch": "@@ -0,0 +1,8 @@\n+<label class=\"checkbox\" for=\"artifact_{{ field_id }}_perms_mass_update\">\n+    <input type=\"checkbox\"\n+        name=\"artifact[{{ field_id }}][{{ flag_mass_update }}]\"\n+        id=\"artifact_{{ field_id }}_perms_mass_update\"\n+        value=\"1\"\n+    />\n+    {{# dgettext }} tuleap-tracker | Update the permissions, by default nothing is changed {{/ dgettext }}\n+</label>"
        },
        {
          "filename": "plugins/tracker/tests/unit/Tracker/MasschangeDataValueExtractorTest.php",
          "status": "modified",
          "additions": 49,
          "deletions": 32,
          "patch": "@@ -22,58 +22,75 @@\n \n namespace Tuleap\\Tracker;\n \n-use Mockery;\n-use Mockery\\Adapter\\Phpunit\\MockeryPHPUnitIntegration;\n use Tracker_FormElement_Field_List;\n+use Tracker_FormElement_Field_PermissionsOnArtifact;\n use Tracker_FormElement_Field_Text;\n use Tracker_FormElementFactory;\n use Tracker_MasschangeDataValueExtractor;\n use Tuleap\\GlobalLanguageMock;\n \n final class MasschangeDataValueExtractorTest extends \\Tuleap\\Test\\PHPUnit\\TestCase\n {\n-    use MockeryPHPUnitIntegration;\n     use GlobalLanguageMock;\n \n-    public function testItReturnsFieldWithItNewValue(): void\n+    /**\n+     * @dataProvider dataProviderFields\n+     * @param class-string $field_class\n+     */\n+    public function testReturnsFieldWithNewValue(string $field_class, mixed $value, bool $is_expected_to_set_value): void\n     {\n-        $form_element_factory           = Mockery::mock(Tracker_FormElementFactory::class);\n-        $masschange_data_values_manager = new Tracker_MasschangeDataValueExtractor($form_element_factory);\n+        $field = $this->createStub($field_class);\n \n-        $text_field_1    = Mockery::mock(Tracker_FormElement_Field_Text::class);\n-        $text_field_1_id = 1;\n+        $form_element_factory = $this->createStub(Tracker_FormElementFactory::class);\n+        $form_element_factory->method('getFieldById')->willReturn($field);\n \n-        $text_field_2    = Mockery::mock(Tracker_FormElement_Field_Text::class);\n-        $text_field_2_id = 2;\n+        $masschange_data = [12 => $value];\n \n-        $list_field_1    = Mockery::mock(Tracker_FormElement_Field_List::class);\n-        $list_field_1_id = 3;\n-\n-        $list_field_2    = Mockery::mock(Tracker_FormElement_Field_List::class);\n-        $list_field_2_id = 4;\n-\n-        $form_element_factory->shouldReceive('getFieldById')->withArgs([$text_field_1_id])->andReturn($text_field_1);\n-        $form_element_factory->shouldReceive('getFieldById')->withArgs([$text_field_2_id])->andReturn($text_field_2);\n-        $form_element_factory->shouldReceive('getFieldById')->withArgs([$list_field_1_id])->andReturn($list_field_1);\n-        $form_element_factory->shouldReceive('getFieldById')->withArgs([$list_field_2_id])->andReturn($list_field_2);\n+        $expected_result = $is_expected_to_set_value ? $masschange_data : [];\n \n         $GLOBALS['Language']->method('getText')->willReturn('Unchanged');\n \n-        $masschange_data = [\n-            $text_field_1_id => 'Unchanged',\n-            $text_field_2_id => 'Value01',\n-            $list_field_1_id => ['-1'],\n-            $list_field_2_id => ['Value02'],\n-        ];\n-\n-        $expected_result = [\n-            $text_field_2_id => 'Value01',\n-            $list_field_2_id => ['Value02'],\n-        ];\n+        $masschange_data_values_extractor = new Tracker_MasschangeDataValueExtractor($form_element_factory);\n \n         $this->assertEquals(\n             $expected_result,\n-            $masschange_data_values_manager->getNewValues($masschange_data)\n+            $masschange_data_values_extractor->getNewValues($masschange_data)\n         );\n     }\n+\n+    public function dataProviderFields(): array\n+    {\n+        return [\n+            'Field with an update' => [\n+                Tracker_FormElement_Field_Text::class,\n+                'Value01',\n+                true,\n+            ],\n+            'Field without an update' => [\n+                Tracker_FormElement_Field_Text::class,\n+                'Unchanged',\n+                false,\n+            ],\n+            'List field with an update' => [\n+                Tracker_FormElement_Field_List::class,\n+                ['Value02'],\n+                true,\n+            ],\n+            'List field without an update' => [\n+                Tracker_FormElement_Field_List::class,\n+                ['-1'],\n+                false,\n+            ],\n+            'Permissions on artifact field with an update' => [\n+                Tracker_FormElement_Field_PermissionsOnArtifact::class,\n+                ['do_mass_update' => '1', 'use_artifact_permissions' => '1'],\n+                true,\n+            ],\n+            'Permissions on artifact field without an update' => [\n+                Tracker_FormElement_Field_PermissionsOnArtifact::class,\n+                ['use_artifact_permissions' => '1'],\n+                false,\n+            ],\n+        ];\n+    }\n }"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 7,
        "max_directory_depth": 5
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "9853bbe9eefcf4ad385b6e8474c59bd1aa8a6545",
            "date": "2025-01-14T16:07:28Z",
            "author_login": "magarnier"
          },
          {
            "sha": "f0aaaefd3ef209c794869a752a86b4f174d53d16",
            "date": "2025-01-14T16:07:20Z",
            "author_login": "magarnier"
          },
          {
            "sha": "e0da8b7336dcef7fb38b41cfee101f34f9249442",
            "date": "2025-01-14T14:59:51Z",
            "author_login": "nterray"
          },
          {
            "sha": "336f9ed6a3e16d12c03792f0764bbe06da36ced9",
            "date": "2025-01-14T14:59:12Z",
            "author_login": "nterray"
          },
          {
            "sha": "a4a770f2f7a401e471fde4bc167c5973d97dbd81",
            "date": "2025-01-14T13:19:55Z",
            "author_login": "Gashmob"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 5.4,
    "cvss_vector": "CVSS:3.1/AV:N/AC:H/PR:L/UI:R/S:U/C:H/I:L/A:N",
    "cwe_id": "CWE-200",
    "description": "Tuleap is an open source suite to improve management of software developments and collaboration. Prior to version 15.5.99.76 of Tuleap Community Edition and prior to versions 15.5-4 and 15.4-7 of Tuleap Enterprise Edition, users with a read access to a tracker where the mass update feature is used might get access to restricted information. Tuleap Community Edition 15.5.99.76, Tuleap Enterprise Edition 15.5-4, and Tuleap Enterprise Edition 15.4-7 contain a patch for this issue.",
    "attack_vector": "NETWORK",
    "attack_complexity": "HIGH"
  },
  "temporal_data": {
    "published_date": "2024-02-22T19:15:08.823",
    "last_modified": "2024-11-21T09:00:19.023",
    "fix_date": "2024-02-13T09:38:51Z"
  },
  "references": [
    {
      "url": "https://github.com/Enalean/tuleap/commit/57978a32508f5c6d0365419b6eaeb368aee20667",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/Enalean/tuleap/security/advisories/GHSA-mq7f-m6mj-hjj5",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://tuleap.net/plugins/git/tuleap/tuleap/stable?a=commit&h=57978a32508f5c6d0365419b6eaeb368aee20667",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://tuleap.net/plugins/tracker/?aid=36803",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/Enalean/tuleap/commit/57978a32508f5c6d0365419b6eaeb368aee20667",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://github.com/Enalean/tuleap/security/advisories/GHSA-mq7f-m6mj-hjj5",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://tuleap.net/plugins/git/tuleap/tuleap/stable?a=commit&h=57978a32508f5c6d0365419b6eaeb368aee20667",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://tuleap.net/plugins/tracker/?aid=36803",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:07:28.150984",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "tuleap",
    "owner": "Enalean",
    "created_at": "2012-06-12T15:48:54Z",
    "updated_at": "2025-01-14T09:23:28Z",
    "pushed_at": "2025-01-14T09:23:22Z",
    "size": 382430,
    "stars": 1043,
    "forks": 285,
    "open_issues": 3,
    "watchers": 1043,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "PHP": 64309783,
      "TypeScript": 12164261,
      "JavaScript": 4302645,
      "Vue": 3161023,
      "Mustache": 2174238,
      "SCSS": 1603030,
      "HTML": 502284,
      "CSS": 281155,
      "Shell": 126767,
      "Smarty": 121199,
      "MDX": 89474,
      "Nix": 48015,
      "Go": 44709,
      "Makefile": 41978,
      "Rust": 27741,
      "Groovy": 13947,
      "PEG.js": 12394,
      "Perl": 11384,
      "Dockerfile": 10302,
      "Python": 3977,
      "XSLT": 1077,
      "Awk": 597
    },
    "commit_activity": {
      "total_commits_last_year": 5447,
      "avg_commits_per_week": 104.75,
      "days_active_last_year": 255
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T13:46:56.606881"
  }
}