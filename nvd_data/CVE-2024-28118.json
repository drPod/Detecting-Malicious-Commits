{
  "cve_id": "CVE-2024-28118",
  "github_data": {
    "repository": "getgrav/grav",
    "fix_commit": "de1ccfa12dbcbf526104d68c1a6bc202a98698fe",
    "related_commits": [
      "de1ccfa12dbcbf526104d68c1a6bc202a98698fe",
      "de1ccfa12dbcbf526104d68c1a6bc202a98698fe"
    ],
    "patch_url": "https://github.com/getgrav/grav/commit/de1ccfa12dbcbf526104d68c1a6bc202a98698fe.patch",
    "fix_commit_details": {
      "sha": "de1ccfa12dbcbf526104d68c1a6bc202a98698fe",
      "commit_date": "2024-03-04T22:41:30Z",
      "author": {
        "login": "rhukster",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Mitigate various SSTI injections",
        "length": 32,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 33,
        "additions": 30,
        "deletions": 3
      },
      "files": [
        {
          "filename": "CHANGELOG.md",
          "status": "modified",
          "additions": 2,
          "deletions": 1,
          "patch": "@@ -6,7 +6,8 @@\n 1. [](#bugfix)\n    * Fixed some multibyte issues in Inflector class [#732](https://github.com/getgrav/grav/issues/732)\n    * Fallback to page modified date if Page date provided is invalid and can't be parsed [getgrav/grav-plugin-admin#2394](https://github.com/getgrav/grav-plugin-admin/issues/2394)\n-   * Fixed a path traversal vulnerability with file uploads [GHSA-m7hx-hw6h-mqmc](https://github.com/getgrav/grav/security/advisories/GHSA-m7hx-hw6h-mqmc)\n+   * Fixed a path traversal vulnerability with file uploads [#GHSA-m7hx-hw6h-mqmc](https://github.com/getgrav/grav/security/advisories/GHSA-m7hx-hw6h-mqmc)\n+   * Fixed a security issue with insecure Twig functions be processed [#GHSA-2m7x-c7px-hp58](https://github.com/getgrav/grav/security/advisories/GHSA-2m7x-c7px-hp58) [#GHSA-r6vw-8v8r-pmp4](https://github.com/getgrav/grav/security/advisories/GHSA-r6vw-8v8r-pmp4) [#GHSA-qfv4-q44r-g7rv](https://github.com/getgrav/grav/security/advisories/GHSA-qfv4-q44r-g7rv)\n \n # v1.7.44\n ## 01/05/2024"
        },
        {
          "filename": "system/src/Grav/Common/Security.php",
          "status": "modified",
          "additions": 19,
          "deletions": 0,
          "patch": "@@ -263,4 +263,23 @@ public static function getXssDefaults(): array\n             'invalid_protocols' => array_map('trim', $config->get('security.xss_invalid_protocols')),\n         ];\n     }\n+\n+    public static function cleanDangerousTwig(string $string): string\n+    {\n+        if ($string === '') {\n+            return $string;\n+        }\n+\n+        $bad_twig = [\n+            'twig_array_map',\n+            'twig_array_filter',\n+            'call_user_func',\n+            'registerUndefinedFunctionCallback',\n+            'undefined_functions',\n+            'twig.getFunction',\n+            'core.setEscaper',\n+        ];\n+        $string = preg_replace('/(({{\\s*|{%\\s*)[^}]*?(' . implode('|', $bad_twig) . ')[^}]*?(\\s*}}|\\s*%}))/i', '{# $1 #}', $string);\n+        return $string;\n+    }\n }"
        },
        {
          "filename": "system/src/Grav/Common/Twig/Twig.php",
          "status": "modified",
          "additions": 9,
          "deletions": 2,
          "patch": "@@ -16,6 +16,7 @@\n use Grav\\Common\\Language\\LanguageCodes;\n use Grav\\Common\\Page\\Interfaces\\PageInterface;\n use Grav\\Common\\Page\\Pages;\n+use Grav\\Common\\Security;\n use Grav\\Common\\Twig\\Exception\\TwigException;\n use Grav\\Common\\Twig\\Extension\\FilesystemExtension;\n use Grav\\Common\\Twig\\Extension\\GravExtension;\n@@ -319,6 +320,7 @@ public function setTemplate($name, $template)\n     public function processPage(PageInterface $item, $content = null)\n     {\n         $content = $content ?? $item->content();\n+        $content = Security::cleanDangerousTwig($content);\n \n         // override the twig header vars for local resolution\n         $this->grav->fireEvent('onTwigPageVariables', new Event(['page' => $item]));\n@@ -392,6 +394,8 @@ public function processString($string, array $vars = [])\n         $this->grav->fireEvent('onTwigStringVariables');\n         $vars += $this->twig_vars;\n \n+        $string = Security::cleanDangerousTwig($string);\n+\n         $name = '@Var:' . $string;\n         $this->setTemplate($name, $string);\n \n@@ -418,7 +422,7 @@ public function processSite($format = null, array $vars = [])\n         try {\n             $grav = $this->grav;\n \n-            // set the page now its been processed\n+            // set the page now it's been processed\n             $grav->fireEvent('onTwigSiteVariables');\n \n             /** @var Pages $pages */\n@@ -427,13 +431,15 @@ public function processSite($format = null, array $vars = [])\n             /** @var PageInterface $page */\n             $page = $grav['page'];\n \n+            $content = Security::cleanDangerousTwig($page->content());\n+\n             $twig_vars = $this->twig_vars;\n             $twig_vars['theme'] = $grav['config']->get('theme');\n             $twig_vars['pages'] = $pages->root();\n             $twig_vars['page'] = $page;\n             $twig_vars['header'] = $page->header();\n             $twig_vars['media'] = $page->media();\n-            $twig_vars['content'] = $page->content();\n+            $twig_vars['content'] = $content;\n \n             // determine if params are set, if so disable twig cache\n             $params = $grav['uri']->params(null, true);\n@@ -568,4 +574,5 @@ public function setAutoescape($state)\n \n         $this->autoescape = (bool) $state;\n     }\n+\n }"
        }
      ],
      "file_patterns": {
        "security_files": 1,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 3,
        "max_directory_depth": 5
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "7e723eb7f57414e8236ccd08804895d75a827990",
            "date": "2025-01-13T12:30:17Z",
            "author_login": "rhukster"
          },
          {
            "sha": "1d1d8da431ec0f63b38685ef0e911603dcf7a804",
            "date": "2025-01-07T13:53:09Z",
            "author_login": "Rotzbua"
          },
          {
            "sha": "4097d85daa4597acef44451416d42a8c671f5226",
            "date": "2025-01-06T14:14:42Z",
            "author_login": "rhukster"
          },
          {
            "sha": "2e975dfa90712e8c84667a4841f2a630ef4b1e48",
            "date": "2024-12-03T22:33:32Z",
            "author_login": "rhukster"
          },
          {
            "sha": "a1e583f657f28305e5cbaa4c6b73aa70e1706d62",
            "date": "2024-11-13T21:01:07Z",
            "author_login": "NicholasWilsonDEV"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 8.8,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H",
    "cwe_id": "CWE-94",
    "description": "Grav is an open-source, flat-file content management system. Prior to version 1.7.45, due to the unrestricted access to twig extension class from Grav context, an attacker can redefine config variable. As a result, attacker can bypass a previous SSTI mitigation. Twig processing of static pages can be enabled in the front matter by any administrative user allowed to create or edit pages. As the Twig processor runs unsandboxed, this behavior can be used to gain arbitrary code execution and elevate privileges on the instance. Version 1.7.45 contains a fix for this issue.\n",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2024-03-21T22:15:12.037",
    "last_modified": "2025-01-02T22:59:47.963",
    "fix_date": "2024-03-04T22:41:30Z"
  },
  "references": [
    {
      "url": "https://github.com/getgrav/grav/commit/de1ccfa12dbcbf526104d68c1a6bc202a98698fe",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/getgrav/grav/security/advisories/GHSA-r6vw-8v8r-pmp4",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/getgrav/grav/commit/de1ccfa12dbcbf526104d68c1a6bc202a98698fe",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/getgrav/grav/security/advisories/GHSA-r6vw-8v8r-pmp4",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Vendor Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:07:52.886346",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "grav",
    "owner": "getgrav",
    "created_at": "2014-08-02T18:29:10Z",
    "updated_at": "2025-01-13T21:59:40Z",
    "pushed_at": "2025-01-13T12:30:23Z",
    "size": 29213,
    "stars": 14651,
    "forks": 1420,
    "open_issues": 428,
    "watchers": 14651,
    "has_security_policy": false,
    "default_branch": "develop",
    "protected_branches": [],
    "languages": {
      "PHP": 2924876,
      "CSS": 8627,
      "Twig": 1772,
      "JavaScript": 1393,
      "Logos": 908
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-14T13:18:52.449936"
  }
}