{
  "cve_id": "CVE-2024-31219",
  "github_data": {
    "repository": "discourse/discourse-reactions",
    "fix_commit": "6a5a8dacd7e5cbbbbe7d2288b1df9c1062994dbe",
    "related_commits": [
      "6a5a8dacd7e5cbbbbe7d2288b1df9c1062994dbe",
      "6a5a8dacd7e5cbbbbe7d2288b1df9c1062994dbe"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "6a5a8dacd7e5cbbbbe7d2288b1df9c1062994dbe",
      "commit_date": "2024-04-15T03:40:26Z",
      "author": {
        "login": "martin-brennan",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "SECURITY: Hide whisper posts in reactions given endpoint (#286)",
        "length": 170,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 43,
        "additions": 38,
        "deletions": 5
      },
      "files": [
        {
          "filename": "app/controllers/discourse_reactions/custom_reactions_controller.rb",
          "status": "modified",
          "additions": 7,
          "deletions": 4,
          "patch": "@@ -48,8 +48,12 @@ def reactions_given\n \n     reaction_users =\n       DiscourseReactions::ReactionUser\n-        .joins(:reaction, :post)\n-        .joins(\"INNER JOIN topics t ON t.id = posts.topic_id AND t.deleted_at IS NULL\")\n+        .joins(\n+          \"INNER JOIN discourse_reactions_reactions ON discourse_reactions_reactions.id = discourse_reactions_reaction_users.reaction_id\",\n+        )\n+        .joins(\"INNER JOIN posts p ON p.id = discourse_reactions_reaction_users.post_id\")\n+        .joins(\"INNER JOIN topics t ON t.id = p.topic_id AND t.deleted_at IS NULL\")\n+        .joins(\"INNER JOIN posts p2 ON p2.topic_id = t.id AND p2.post_number = 1\")\n         .joins(\"LEFT JOIN categories c ON c.id = t.category_id\")\n         .includes(:user, :post, :reaction)\n         .where(user_id: user.id)\n@@ -271,8 +275,7 @@ def publish_change_to_clients!(post, reaction: nil, previous_reaction: nil)\n \n   def secure_reaction_users!(reaction_users)\n     builder = DB.build(\"/*where*/\")\n-    UserAction.filter_private_messages(builder, current_user.id, guardian)\n-    UserAction.filter_categories(builder, guardian)\n+    UserAction.apply_common_filters(builder, current_user.id, guardian)\n     reaction_users.where(builder.to_sql.delete_prefix(\"/*where*/\").delete_prefix(\"WHERE\"))\n   end\n "
        },
        {
          "filename": "plugin.rb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -3,7 +3,7 @@\n # name: discourse-reactions\n # about: Allows users to react to a post with emojis.\n # meta_topic_id: 183261\n-# version: 0.3\n+# version: 0.5\n # author: Ahmed Gagan, Rafael dos Santos Silva, Kris Aubuchon, Joffrey Jaffeux, Kris Kotlarek, Jordan Vidrine\n # url: https://github.com/discourse/discourse-reactions\n "
        },
        {
          "filename": "spec/requests/custom_reactions_controller_spec.rb",
          "status": "modified",
          "additions": 30,
          "deletions": 0,
          "patch": "@@ -13,10 +13,16 @@\n   fab!(:post_2) { Fabricate(:post, user: user_1) }\n   fab!(:private_topic) { Fabricate(:private_message_topic, user: user_2, recipient: admin) }\n   fab!(:private_post) { Fabricate(:post, topic: private_topic) }\n+  fab!(:whisper_post) do\n+    Fabricate(:post, topic: Fabricate(:topic), post_type: Post.types[:whisper])\n+  end\n   fab!(:laughing_reaction) { Fabricate(:reaction, post: post_2, reaction_value: \"laughing\") }\n   fab!(:open_mouth_reaction) { Fabricate(:reaction, post: post_2, reaction_value: \"open_mouth\") }\n   fab!(:hugs_reaction) { Fabricate(:reaction, post: post_2, reaction_value: \"hugs\") }\n   fab!(:hugs_reaction_private) { Fabricate(:reaction, post: private_post, reaction_value: \"hugs\") }\n+  fab!(:laughing_reaction_whisper) do\n+    Fabricate(:reaction, post: whisper_post, reaction_value: \"laughing\")\n+  end\n   fab!(:like) do\n     Fabricate(\n       :post_action,\n@@ -40,6 +46,9 @@\n   fab!(:reaction_user_5) do\n     Fabricate(:reaction_user, reaction: hugs_reaction_private, user: admin, post: private_post)\n   end\n+  fab!(:reaction_user_6) do\n+    Fabricate(:reaction_user, reaction: laughing_reaction_whisper, user: user_2, post: whisper_post)\n+  end\n \n   before do\n     SiteSetting.discourse_reactions_enabled = true\n@@ -225,6 +234,27 @@\n       expect(response.parsed_body.map { |reaction| reaction[\"post_id\"] }).to include(secure_post.id)\n     end\n \n+    it \"does not return reactions for whispers if the user is not in whispers_allowed_groups\" do\n+      sign_in(user_1)\n+\n+      get \"/discourse-reactions/posts/reactions.json\", params: { username: user_2.username }\n+\n+      parsed = response.parsed_body\n+      expect(response.parsed_body.map { |reaction| reaction[\"post_id\"] }).not_to include(\n+        whisper_post.id,\n+      )\n+\n+      SiteSetting.whispers_allowed_groups = Group::AUTO_GROUPS[:trust_level_0].to_s\n+      Group.refresh_automatic_groups!\n+\n+      get \"/discourse-reactions/posts/reactions.json\", params: { username: user_2.username }\n+\n+      parsed = response.parsed_body\n+      expect(response.parsed_body.map { |reaction| reaction[\"post_id\"] }).to include(\n+        whisper_post.id,\n+      )\n+    end\n+\n     describe \"a post with one of your reactions has been deleted\" do\n       fab!(:deleted_post) { Fabricate(:post) }\n       fab!(:kept_post) { Fabricate(:post) }"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 3,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "67879118f40bd3af97ae494d7b9096ee2bd14787",
            "date": "2025-01-23T06:58:34Z",
            "author_login": "tyb-talks"
          },
          {
            "sha": "d34356646221897bdb9cffa11613a802fe1c93d6",
            "date": "2025-01-09T16:42:43Z",
            "author_login": "davidtaylorhq"
          },
          {
            "sha": "c754dc988b243cecea8f82f413f1037a62537237",
            "date": "2025-01-03T13:02:29Z",
            "author_login": "discourse-translator-bot"
          },
          {
            "sha": "fac3464f47008e20c96bd08b1bfaf13131a38db0",
            "date": "2024-12-30T19:22:49Z",
            "author_login": "megothss"
          },
          {
            "sha": "9ed228b02da0297a29d902abab37c5f34626c691",
            "date": "2024-12-09T08:27:55Z",
            "author_login": "OsamaSayegh"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 4.3,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N",
    "cwe_id": "CWE-200",
    "description": "Discourse-reactions is a plugin that allows user to add their reactions to the post. When whispers are enabled on a site via `whispers_allowed_groups` and reactions are made on whispers on public topics, the contents of the whisper and the reaction data are shown on the `/u/:username/activity/reactions` endpoint.\n",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2024-04-15T18:15:11.103",
    "last_modified": "2024-11-21T09:13:04.083",
    "fix_date": "2024-04-15T03:40:26Z"
  },
  "references": [
    {
      "url": "https://github.com/discourse/discourse-reactions/commit/6a5a8dacd7e5cbbbbe7d2288b1df9c1062994dbe",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/discourse/discourse-reactions/security/advisories/GHSA-7cqc-5xrw-xh67",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/discourse/discourse-reactions/commit/6a5a8dacd7e5cbbbbe7d2288b1df9c1062994dbe",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://github.com/discourse/discourse-reactions/security/advisories/GHSA-7cqc-5xrw-xh67",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:08:04.487161",
    "processing_status": "enhanced"
  },
  "repository_context": {
    "name": "discourse-reactions",
    "owner": "discourse",
    "created_at": "2020-12-01T19:35:29Z",
    "updated_at": "2025-01-23T06:58:38Z",
    "pushed_at": "2025-01-23T06:58:36Z",
    "size": 1256,
    "stars": 37,
    "forks": 19,
    "open_issues": 3,
    "watchers": 37,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [
      "main"
    ],
    "languages": {
      "Ruby": 164795,
      "JavaScript": 97692,
      "SCSS": 10233,
      "Handlebars": 1832
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-26T07:35:52.568150"
  }
}