{
  "cve_id": "CVE-2024-31447",
  "github_data": {
    "repository": "shopware/shopware",
    "fix_commit": "5cc84ddd817ad0c1d07f9b3c79ab346d50514a77",
    "related_commits": [
      "5cc84ddd817ad0c1d07f9b3c79ab346d50514a77",
      "d29775aa758f70d08e0c5999795c7c26d230e7d3",
      "5cc84ddd817ad0c1d07f9b3c79ab346d50514a77",
      "d29775aa758f70d08e0c5999795c7c26d230e7d3"
    ],
    "patch_url": "https://github.com/shopware/shopware/commit/5cc84ddd817ad0c1d07f9b3c79ab346d50514a77.patch",
    "fix_commit_details": {
      "sha": "5cc84ddd817ad0c1d07f9b3c79ab346d50514a77",
      "commit_date": "2024-04-03T08:16:51Z",
      "author": {
        "login": "shyim",
        "type": "User",
        "stats": {
          "total_commits": 2463,
          "average_weekly_commits": 6.331619537275064,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 240
        }
      },
      "commit_message": {
        "title": "NEXT-34608 - Improve account logout",
        "length": 35,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 18,
        "additions": 13,
        "deletions": 5
      },
      "files": [
        {
          "filename": "changelog/_unreleased/2024-04-03-improve-account-logout.md",
          "status": "added",
          "additions": 8,
          "deletions": 0,
          "patch": "@@ -0,0 +1,8 @@\n+---\n+title: Improve account logout\n+issue: NEXT-34608\n+---\n+\n+# Core\n+\n+* Changed `LogoutRoute` to always logout the user regardless of the configurations."
        },
        {
          "filename": "src/Core/Checkout/Customer/SalesChannel/LogoutRoute.php",
          "status": "modified",
          "additions": 2,
          "deletions": 0,
          "patch": "@@ -39,6 +39,8 @@ public function getDecorated(): AbstractLogoutRoute\n     #[Route(path: '/store-api/account/logout', name: 'store-api.account.logout', methods: ['POST'], defaults: ['_loginRequired' => true, '_loginRequiredAllowGuest' => true])]\n     public function logout(SalesChannelContext $context, RequestDataBag $data): ContextTokenResponse\n     {\n+        $this->contextPersister->save($context->getToken(), ['customerId' => null], $context->getSalesChannelId());\n+\n         /** @var CustomerEntity $customer */\n         $customer = $context->getCustomer();\n         if ($this->shouldDelete($context)) {"
        },
        {
          "filename": "tests/integration/Core/Checkout/Customer/SalesChannel/LogoutRouteTest.php",
          "status": "modified",
          "additions": 2,
          "deletions": 4,
          "patch": "@@ -166,7 +166,7 @@ public function testLoggedOutUpdateCustomerContextWithReplaceTokenParameter(): v\n \n         $newCustomerContextToken = $this->getContainer()->get(Connection::class)->fetchOne('SELECT token FROM sales_channel_api_context WHERE customer_id = ?', [$currentCustomerId]);\n \n-        static::assertNotEmpty($newCustomerContextToken);\n+        static::assertEmpty($newCustomerContextToken);\n         static::assertNotEquals($currentCustomerToken, $newCustomerContextToken);\n     }\n \n@@ -193,7 +193,6 @@ public function testLoggedOutKeepCustomerContextWithoutReplaceTokenParameter():\n         $response = $this->browser->getResponse();\n \n         $currentCustomerToken = $response->headers->get(PlatformRequest::HEADER_CONTEXT_TOKEN) ?: '';\n-        $currentCustomerId = $this->getContainer()->get(Connection::class)->fetchOne('SELECT customer_id FROM sales_channel_api_context WHERE token = ?', [$currentCustomerToken]);\n \n         $this->browser->setServerParameter('HTTP_SW_CONTEXT_TOKEN', $currentCustomerToken);\n \n@@ -208,8 +207,7 @@ public function testLoggedOutKeepCustomerContextWithoutReplaceTokenParameter():\n             );\n \n         $customerIdWithOldToken = $this->getContainer()->get(Connection::class)->fetchOne('SELECT customer_id FROM sales_channel_api_context WHERE token = ?', [$currentCustomerToken]);\n-\n-        static::assertEquals($currentCustomerId, $customerIdWithOldToken);\n+        static::assertEmpty($customerIdWithOldToken);\n     }\n \n     public function testLogoutRouteReturnContextTokenResponse(): void"
        },
        {
          "filename": "tests/integration/Storefront/Controller/AuthControllerTest.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -262,7 +262,7 @@ public function testOneUserUseOneContextAcrossSessions(): void\n         $secondTimeLoginContextToken = $secondTimeLogin->get(PlatformRequest::HEADER_CONTEXT_TOKEN);\n \n         static::assertNotEquals($firstTimeLoginSessionId, $secondTimeLoginSessionId);\n-        static::assertEquals($firstTimeLoginContextToken, $secondTimeLoginContextToken);\n+        static::assertNotEquals($firstTimeLoginContextToken, $secondTimeLoginContextToken);\n     }\n \n     public function testMergedHintIsAdded(): void"
        }
      ],
      "file_patterns": {
        "security_files": 1,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 2,
        "unique_directories": 4,
        "max_directory_depth": 6
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "a87d38f4e4ab920afb728d396a4fdff6dd1ed893",
            "date": "2025-01-14T12:59:02Z",
            "author_login": "Bird87ZA"
          },
          {
            "sha": "e957d7150a872944c008a7169bf5f8d97889b355",
            "date": "2025-01-14T11:55:14Z",
            "author_login": "shyim"
          },
          {
            "sha": "02af717865eb1d240850314ad103fc276dbb56f8",
            "date": "2025-01-14T10:50:49Z",
            "author_login": "akf-bw"
          },
          {
            "sha": "17723a093f9cf2c4617a471091ef4607da1d8769",
            "date": "2025-01-14T10:29:25Z",
            "author_login": "jleifeld"
          },
          {
            "sha": "9b977d57e54a9275be40804a7dd7cca05c0f748c",
            "date": "2025-01-14T10:24:01Z",
            "author_login": "frobel"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 5.3,
    "cvss_vector": "CVSS:3.1/AV:N/AC:H/PR:N/UI:R/S:U/C:N/I:H/A:N",
    "cwe_id": "CWE-613",
    "description": "Shopware 6 is an open commerce platform based on Symfony Framework and Vue. Starting in version 6.3.5.0 and prior to versions 6.6.1.0 and 6.5.8.8, when a authenticated request is made to `POST /store-api/account/logout`, the cart will be cleared, but the User won't be logged out. This affects only the direct store-api usage, as the PHP Storefront listens additionally on `CustomerLogoutEvent` and invalidates the session additionally. The problem has been fixed in Shopware 6.6.1.0 and 6.5.8.8. Those who are unable to update can install the latest version of the Shopware Security Plugin as a workaround.\n",
    "attack_vector": "NETWORK",
    "attack_complexity": "HIGH"
  },
  "temporal_data": {
    "published_date": "2024-04-08T16:15:08.190",
    "last_modified": "2024-11-21T09:13:32.320",
    "fix_date": "2024-04-03T08:16:51Z"
  },
  "references": [
    {
      "url": "https://github.com/shopware/shopware/commit/5cc84ddd817ad0c1d07f9b3c79ab346d50514a77",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/shopware/shopware/commit/d29775aa758f70d08e0c5999795c7c26d230e7d3",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/shopware/shopware/security/advisories/GHSA-5297-wrrp-rcj7",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/shopware/shopware/commit/5cc84ddd817ad0c1d07f9b3c79ab346d50514a77",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://github.com/shopware/shopware/commit/d29775aa758f70d08e0c5999795c7c26d230e7d3",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://github.com/shopware/shopware/security/advisories/GHSA-5297-wrrp-rcj7",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:08:04.449161",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "shopware",
    "owner": "shopware",
    "created_at": "2018-05-03T13:00:31Z",
    "updated_at": "2025-01-14T12:59:07Z",
    "pushed_at": "2025-01-14T13:55:49Z",
    "size": 289467,
    "stars": 2894,
    "forks": 1042,
    "open_issues": 912,
    "watchers": 2894,
    "has_security_policy": false,
    "default_branch": "trunk",
    "protected_branches": [
      "6.4",
      "6.5.x"
    ],
    "languages": {
      "PHP": 33467815,
      "JavaScript": 12727064,
      "Twig": 5566016,
      "TypeScript": 1850093,
      "SCSS": 1033491,
      "CSS": 135217,
      "Vue": 32178,
      "Shell": 30871,
      "HTML": 26015,
      "Nix": 4972,
      "Groovy": 3900,
      "Dockerfile": 2862,
      "Smarty": 1216
    },
    "commit_activity": {
      "total_commits_last_year": 4219,
      "avg_commits_per_week": 81.13461538461539,
      "days_active_last_year": 285
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-14T13:59:19.166659"
  }
}