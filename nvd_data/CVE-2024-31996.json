{
  "cve_id": "CVE-2024-31996",
  "github_data": {
    "repository": "xwiki/xwiki-commons",
    "fix_commit": "b0805160ec7b01ee12417e79cb384e60ae4817aa",
    "related_commits": [
      "b0805160ec7b01ee12417e79cb384e60ae4817aa",
      "b94142e2a66ec32e89eacab67c3da8d91f5ef93a",
      "ed7ff515a2436a1c6dcbd0c6ca0c41e434d58915",
      "b0805160ec7b01ee12417e79cb384e60ae4817aa",
      "b94142e2a66ec32e89eacab67c3da8d91f5ef93a",
      "ed7ff515a2436a1c6dcbd0c6ca0c41e434d58915"
    ],
    "patch_url": "https://github.com/xwiki/xwiki-commons/commit/b0805160ec7b01ee12417e79cb384e60ae4817aa.patch",
    "fix_commit_details": {
      "sha": "b0805160ec7b01ee12417e79cb384e60ae4817aa",
      "commit_date": "2023-10-20T15:01:41Z",
      "author": {
        "login": "pjeanjean",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "XCOMMONS-2828: Support curly braces in `EscapeTool.html()`",
        "length": 128,
        "has_description": true,
        "references_issue": false
      },
      "stats": {
        "total": 35,
        "additions": 35,
        "deletions": 0
      },
      "files": [
        {
          "filename": "xwiki-commons-core/xwiki-commons-velocity/src/main/java/org/xwiki/velocity/tools/EscapeTool.java",
          "status": "modified",
          "additions": 27,
          "deletions": 0,
          "patch": "@@ -30,6 +30,8 @@\n import org.apache.commons.codec.net.QCodec;\n import org.apache.commons.codec.net.QuotedPrintableCodec;\n import org.apache.commons.text.StringEscapeUtils;\n+import org.apache.commons.text.translate.CharSequenceTranslator;\n+import org.apache.commons.text.translate.LookupTranslator;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import org.xwiki.xml.XMLUtils;\n@@ -66,6 +68,13 @@ public class EscapeTool extends org.apache.velocity.tools.generic.EscapeTool\n     /** And sign. */\n     private static final String AND = \"&\";\n \n+    private static final CharSequenceTranslator XWIKI_ESCAPE_HTML4 = StringEscapeUtils.ESCAPE_HTML4.with(\n+        new LookupTranslator(Map.ofEntries(\n+            Map.entry(\"{\", \"&lcub;\"),\n+            Map.entry(\"}\", \"&rcub;\")\n+        ))\n+    );\n+\n     /**\n      * Change the default key defined in {@link org.apache.velocity.tools.generic.EscapeTool}.\n      */\n@@ -74,6 +83,24 @@ public EscapeTool()\n         setKey(DEFAULT_KEY);\n     }\n \n+    /**\n+     * Escapes the HTML special characters in a <code>String</code> using HTML entities. This overrides the base\n+     * implementation from Velocity in order to also escape characters potentially harmful in the context of XWiki,\n+     * such as curly brackets.\n+     *\n+     * @param content the string to escape, may be {@code null}\n+     * @return a new escaped {@code String}, {@code null} if {@code null} input\n+     */\n+    @Override\n+    public String html(Object content)\n+    {\n+        if (content == null)\n+        {\n+            return null;\n+        }\n+        return XWIKI_ESCAPE_HTML4.translate(String.valueOf(content));\n+    }\n+\n     /**\n      * Escapes the XML special characters in a <code>String</code> using numerical XML entities. This overrides the base\n      * implementation from Velocity, which is over-zealous and escapes any non-ASCII character. Since XWiki works with"
        },
        {
          "filename": "xwiki-commons-core/xwiki-commons-velocity/src/test/java/org/xwiki/velocity/tools/EscapeToolTest.java",
          "status": "modified",
          "additions": 8,
          "deletions": 0,
          "patch": "@@ -259,4 +259,12 @@ void velocity()\n     {\n         assertEquals(\"one${escapetool.h}${escapetool.h}two\", this.tool.velocity(\"one##two\"));        \n     }\n+\n+    @Test\n+    void html()\n+    {\n+        assertEquals(\"&lt;script&gt;alert(&quot;Hello, &amp;lt;World&amp;gt;!&quot;);&lt;/script&gt;&lcub;&lcub;\"\n+                + \"/html&rcub;&rcub;\",\n+            this.tool.html(\"<script>alert(\\\"Hello, &lt;World&gt;!\\\");</script>{{/html}}\"));\n+    }\n }"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 2,
        "max_directory_depth": 9
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "85b59159bb4fb19b6419bac3169b4d40f3d348b2",
            "date": "2025-01-13T15:52:46Z",
            "author_login": "tmortagne"
          },
          {
            "sha": "f3fd1088356deb08a7ef9f13100339111922fc82",
            "date": "2025-01-13T15:51:12Z",
            "author_login": "tmortagne"
          },
          {
            "sha": "0ecc68313bbc332ad0920eb13df5036bee737b02",
            "date": "2025-01-10T16:43:17Z",
            "author_login": "tmortagne"
          },
          {
            "sha": "c6c8a421e5ce215f3e62c8ea7d12254e5483f3b5",
            "date": "2025-01-10T14:52:33Z",
            "author_login": "tmortagne"
          },
          {
            "sha": "eaf8b5b360fd57d5c262f0830766b92fcf334d04",
            "date": "2025-01-10T14:08:59Z",
            "author_login": "tmortagne"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 10.0,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H",
    "cwe_id": "CWE-95",
    "description": "XWiki Platform is a generic wiki platform. Starting in version 3.0.1 and prior to versions 4.10.19, 15.5.4, and 15.10-rc-1, the HTML escaping of escaping tool that is used in XWiki doesn't escape `{`, which, when used in certain places, allows XWiki syntax injection and thereby remote code execution. The vulnerability has been fixed in XWiki 14.10.19, 15.5.5, and 15.9 RC1. Apart from upgrading, there is no generic workaround. However, replacing `$escapetool.html` by `$escapetool.xml` in XWiki documents fixes the vulnerability. In a standard XWiki installation, the maintainers are only aware of the document `Panels.PanelLayoutUpdate` that exposes this vulnerability, patching this document is thus a workaround. Any extension could expose this vulnerability and might thus require patching, too.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2024-04-10T21:15:07.510",
    "last_modified": "2025-01-09T18:50:19.793",
    "fix_date": "2023-10-20T15:01:41Z"
  },
  "references": [
    {
      "url": "https://github.com/xwiki/xwiki-commons/commit/b0805160ec7b01ee12417e79cb384e60ae4817aa",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-commons/commit/b94142e2a66ec32e89eacab67c3da8d91f5ef93a",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-commons/commit/ed7ff515a2436a1c6dcbd0c6ca0c41e434d58915",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-commons/security/advisories/GHSA-hf43-47q4-fhq5",
      "source": "security-advisories@github.com",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://jira.xwiki.org/browse/XCOMMONS-2828",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://jira.xwiki.org/browse/XWIKI-21438",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-commons/commit/b0805160ec7b01ee12417e79cb384e60ae4817aa",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-commons/commit/b94142e2a66ec32e89eacab67c3da8d91f5ef93a",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-commons/commit/ed7ff515a2436a1c6dcbd0c6ca0c41e434d58915",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/xwiki/xwiki-commons/security/advisories/GHSA-hf43-47q4-fhq5",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://jira.xwiki.org/browse/XCOMMONS-2828",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://jira.xwiki.org/browse/XWIKI-21438",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Vendor Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:08:04.470653",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "xwiki-commons",
    "owner": "xwiki",
    "created_at": "2011-03-04T21:31:54Z",
    "updated_at": "2025-01-13T15:52:59Z",
    "pushed_at": "2025-01-13T15:52:55Z",
    "size": 38500,
    "stars": 85,
    "forks": 123,
    "open_issues": 27,
    "watchers": 85,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "master",
      "stable-14.10.x",
      "stable-15.10.x",
      "stable-16.4.x",
      "stable-16.10.x"
    ],
    "languages": {
      "Java": 7553862,
      "AspectJ": 6773,
      "AMPL": 4949,
      "Groovy": 1367,
      "JavaScript": 911,
      "CSS": 21
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "lgpl-2.1"
    },
    "collected_at": "2025-01-14T16:59:29.086917"
  }
}