{
  "cve_id": "CVE-2024-32964",
  "github_data": {
    "repository": "lobehub/lobe-chat",
    "fix_commit": "465665a735556669ee30446c7ea9049a20cc7c37",
    "related_commits": [
      "465665a735556669ee30446c7ea9049a20cc7c37",
      "465665a735556669ee30446c7ea9049a20cc7c37"
    ],
    "patch_url": "https://github.com/lobehub/lobe-chat/commit/465665a735556669ee30446c7ea9049a20cc7c37.patch",
    "fix_commit_details": {
      "sha": "465665a735556669ee30446c7ea9049a20cc7c37",
      "commit_date": "2024-04-28T09:03:58Z",
      "author": {
        "login": "arvinxx",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "\ud83d\udc1b fix: fix `/api/proxy` internal proxy attack (#2255)",
        "length": 53,
        "has_description": false,
        "references_issue": true
      },
      "stats": {
        "total": 30,
        "additions": 27,
        "deletions": 3
      },
      "files": [
        {
          "filename": "package.json",
          "status": "modified",
          "additions": 2,
          "deletions": 0,
          "patch": "@@ -118,6 +118,7 @@\n     \"i18next-resources-to-backend\": \"^1.2.1\",\n     \"idb-keyval\": \"^6.2.1\",\n     \"immer\": \"^10.0.4\",\n+    \"ip\": \"^2.0.1\",\n     \"jose\": \"^5.2.4\",\n     \"langfuse\": \"^3.7.0\",\n     \"langfuse-core\": \"^3.7.0\",\n@@ -183,6 +184,7 @@\n     \"@types/chroma-js\": \"^2.4.4\",\n     \"@types/debug\": \"^4.1.12\",\n     \"@types/diff\": \"^5.2.0\",\n+    \"@types/ip\": \"^1.1.3\",\n     \"@types/json-schema\": \"^7.0.15\",\n     \"@types/lodash\": \"^4.17.0\",\n     \"@types/lodash-es\": \"^4.17.12\","
        },
        {
          "filename": "src/app/api/proxy/route.ts",
          "status": "modified",
          "additions": 25,
          "deletions": 3,
          "patch": "@@ -1,12 +1,34 @@\n-export const runtime = 'edge';\n+import { isPrivate } from 'ip';\n+import { NextResponse } from 'next/server';\n+import dns from 'node:dns';\n+import { promisify } from 'node:util';\n+\n+const lookupAsync = promisify(dns.lookup);\n+\n+export const runtime = 'nodejs';\n \n /**\n  * just for a proxy\n  */\n export const POST = async (req: Request) => {\n-  const url = await req.text();\n+  const url = new URL(await req.text());\n+  let address;\n+\n+  try {\n+    const lookupResult = await lookupAsync(url.hostname);\n+    address = lookupResult.address;\n+  } catch (err) {\n+    console.error(`${url.hostname} DNS parser error:`, err);\n+\n+    return NextResponse.json({ error: 'DNS parser error' }, { status: 504 });\n+  }\n+\n+  const isInternalHost = isPrivate(address);\n+\n+  if (isInternalHost)\n+    return NextResponse.json({ error: 'Not support internal host proxy' }, { status: 400 });\n \n-  const res = await fetch(url);\n+  const res = await fetch(url.toString());\n \n   return new Response(res.body, { headers: res.headers });\n };"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 1,
        "dependency_files": 1,
        "test_files": 0,
        "unique_directories": 2,
        "max_directory_depth": 4
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "7c4f0f202d371583d1027f621fff706b1ab118f8",
            "date": "2025-01-14T17:59:06Z",
            "author_login": "lobehubbot"
          },
          {
            "sha": "78fac8bbad5c689f40b1bbfe4cf028586881c703",
            "date": "2025-01-14T17:58:10Z",
            "author_login": "semantic-release-bot"
          },
          {
            "sha": "1726d8523e70ede2e866e3144efe6dfe651753db",
            "date": "2025-01-14T17:50:24Z",
            "author_login": "arvinxx"
          },
          {
            "sha": "b49e6239b43e17b0073ee35b4ddb87e9b64b073a",
            "date": "2025-01-14T17:26:55Z",
            "author_login": "lobehubbot"
          },
          {
            "sha": "47870a42e28164f75222325cacefa287c0abae86",
            "date": "2025-01-14T17:25:57Z",
            "author_login": "semantic-release-bot"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 9.0,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:C/C:H/I:L/A:H",
    "cwe_id": "CWE-918",
    "description": "Lobe Chat is a chatbot framework that supports speech synthesis, multimodal, and extensible Function Call plugin system. Prior to 0.150.6, lobe-chat had an unauthorized Server-Side Request Forgery vulnerability in the /api/proxy endpoint. An attacker can construct malicious requests to cause Server-Side Request Forgery without logging in, attack intranet services, and leak sensitive information.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2024-05-14T15:37:18.180",
    "last_modified": "2024-11-21T09:16:07.637",
    "fix_date": "2024-04-28T09:03:58Z"
  },
  "references": [
    {
      "url": "https://github.com/lobehub/lobe-chat/commit/465665a735556669ee30446c7ea9049a20cc7c37",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/lobehub/lobe-chat/security/advisories/GHSA-mxhq-xw3g-rphc",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/lobehub/lobe-chat/commit/465665a735556669ee30446c7ea9049a20cc7c37",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://github.com/lobehub/lobe-chat/security/advisories/GHSA-mxhq-xw3g-rphc",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:08:20.888836",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "lobe-chat",
    "owner": "lobehub",
    "created_at": "2023-05-21T07:19:12Z",
    "updated_at": "2025-01-14T17:59:22Z",
    "pushed_at": "2025-01-14T17:59:18Z",
    "size": 311821,
    "stars": 51600,
    "forks": 11147,
    "open_issues": 536,
    "watchers": 51600,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [],
    "languages": {
      "TypeScript": 5578907,
      "MDX": 11645,
      "JavaScript": 10584,
      "Shell": 9656,
      "Dockerfile": 7552,
      "CSS": 4903,
      "TeX": 1797
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T18:01:24.365688"
  }
}