{
  "cve_id": "CVE-2024-34074",
  "github_data": {
    "repository": "frappe/frappe",
    "fix_commit": "65b3c42635038cdff17d3109be6c373bac004829",
    "related_commits": [
      "65b3c42635038cdff17d3109be6c373bac004829",
      "65b3c42635038cdff17d3109be6c373bac004829"
    ],
    "patch_url": "https://github.com/frappe/frappe/commit/65b3c42635038cdff17d3109be6c373bac004829.patch",
    "fix_commit_details": {
      "sha": "65b3c42635038cdff17d3109be6c373bac004829",
      "commit_date": "2024-05-02T12:32:18Z",
      "author": {
        "login": "ankush",
        "type": "User",
        "stats": {
          "total_commits": 3032,
          "average_weekly_commits": 4.2644163150492265,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 176
        }
      },
      "commit_message": {
        "title": "fix: only redirect to same domain (#26304)",
        "length": 129,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 40,
        "additions": 39,
        "deletions": 1
      },
      "files": [
        {
          "filename": "frappe/tests/test_api.py",
          "status": "modified",
          "additions": 14,
          "deletions": 1,
          "patch": "@@ -7,7 +7,7 @@\n from threading import Thread\n from time import time\n from unittest.mock import patch\n-from urllib.parse import urljoin\n+from urllib.parse import urlencode, urljoin\n \n import requests\n from filetype import guess_mime\n@@ -454,6 +454,19 @@ def test_download_private_file_with_unique_url(self):\n \t\tself.assertEqual(self.get(file.unique_url, {\"sid\": self.sid}).text, test_content)\n \t\tself.assertEqual(self.get(file.file_url, {\"sid\": self.sid}).text, test_content)\n \n+\tdef test_login_redirects(self):\n+\t\texpected_redirects = {\n+\t\t\t\"/app/user\": \"/app/user\",\n+\t\t\t\"/app/user?enabled=1\": \"/app/user?enabled=1\",\n+\t\t\t\"http://example.com\": \"/app\",  # No external redirect\n+\t\t\t\"https://google.com\": \"/app\",\n+\t\t\t\"http://localhost:8000\": \"/app\",\n+\t\t\t\"http://localhost/app\": \"http://localhost/app\",\n+\t\t}\n+\t\tfor redirect, expected_redirect in expected_redirects.items():\n+\t\t\tresponse = self.get(f\"/login?{urlencode({'redirect-to':redirect})}\", {\"sid\": self.sid})\n+\t\t\tself.assertEqual(response.location, expected_redirect)\n+\n \n def generate_admin_keys():\n \tfrom frappe.core.doctype.user.user import generate_keys"
        },
        {
          "filename": "frappe/www/login.py",
          "status": "modified",
          "additions": 25,
          "deletions": 0,
          "patch": "@@ -1,6 +1,9 @@\n # Copyright (c) 2015, Frappe Technologies Pvt. Ltd. and Contributors\n # License: MIT. See LICENSE\n \n+\n+from urllib.parse import urlparse\n+\n import frappe\n import frappe.utils\n from frappe import _\n@@ -19,6 +22,7 @@\n \n def get_context(context):\n \tredirect_to = frappe.local.request.args.get(\"redirect-to\")\n+\tredirect_to = sanitize_redirect(redirect_to)\n \n \tif frappe.session.user != \"Guest\":\n \t\tif not redirect_to:\n@@ -179,3 +183,24 @@ def login_via_key(key: str):\n \t\t\thttp_status_code=403,\n \t\t\tindicator_color=\"red\",\n \t\t)\n+\n+\n+def sanitize_redirect(redirect: str | None) -> str | None:\n+\t\"\"\"Only allow redirect on same domain.\n+\n+\tAllowed redirects:\n+\t- Same host e.g. https://frappe.localhost/path\n+\t- Just path e.g. /app\n+\t\"\"\"\n+\tif not redirect:\n+\t\treturn redirect\n+\n+\tparsed_redirect = urlparse(redirect)\n+\tif not parsed_redirect.netloc:\n+\t\treturn redirect\n+\n+\tparsed_request_host = urlparse(frappe.local.request.url)\n+\tif parsed_request_host.netloc == parsed_redirect.netloc:\n+\t\treturn redirect\n+\n+\treturn None"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 2,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "2e3b6c9031225b3e3b3cd3dca3ec8fc4ffc0f4b6",
            "date": "2025-01-14T22:02:24Z",
            "author_login": "mahsem"
          },
          {
            "sha": "3b7df82a805eec866a02411cba1848e2e45713d7",
            "date": "2025-01-14T21:39:09Z",
            "author_login": "barredterra"
          },
          {
            "sha": "c72e91f4653d639300c4d8d8a7951c2aa8a95c2c",
            "date": "2025-01-14T11:05:55Z",
            "author_login": "ankush"
          },
          {
            "sha": "7f30905b109e7f7a51ab7c77962da20b6392e215",
            "date": "2025-01-14T10:17:58Z",
            "author_login": "ankush"
          },
          {
            "sha": "b32f74e6af1f9e689be1de790e328be273d5359b",
            "date": "2025-01-14T10:00:24Z",
            "author_login": "ankush"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.1,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N",
    "cwe_id": "CWE-601",
    "description": "Frappe is a full-stack web application framework. Prior to 15.26.0 and 14.74.0, the login page accepts redirect argument and it allowed redirect to untrusted external URls. This behaviour can be used by malicious actors for phishing. This vulnerability is fixed in 15.26.0 and 14.74.0.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2024-05-14T15:38:27.850",
    "last_modified": "2024-11-21T09:18:02.237",
    "fix_date": "2024-05-02T12:32:18Z"
  },
  "references": [
    {
      "url": "https://github.com/frappe/frappe/commit/65b3c42635038cdff17d3109be6c373bac004829",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/frappe/frappe/pull/26304",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/frappe/frappe/security/advisories/GHSA-7g27-q225-j894",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/frappe/frappe/commit/65b3c42635038cdff17d3109be6c373bac004829",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://github.com/frappe/frappe/pull/26304",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://github.com/frappe/frappe/security/advisories/GHSA-7g27-q225-j894",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:08:20.890533",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "frappe",
    "owner": "frappe",
    "created_at": "2011-06-08T08:14:16Z",
    "updated_at": "2025-01-14T13:25:34Z",
    "pushed_at": "2025-01-14T12:31:11Z",
    "size": 464470,
    "stars": 7527,
    "forks": 3571,
    "open_issues": 1942,
    "watchers": 7527,
    "has_security_policy": false,
    "default_branch": "develop",
    "protected_branches": [
      "develop",
      "master"
    ],
    "languages": {
      "Python": 4621672,
      "JavaScript": 2663656,
      "Vue": 311920,
      "SCSS": 301077,
      "HTML": 266935,
      "CSS": 54096,
      "Less": 10921,
      "Jinja": 388
    },
    "commit_activity": {
      "total_commits_last_year": 3404,
      "avg_commits_per_week": 65.46153846153847,
      "days_active_last_year": 338
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-14T13:33:16.848558"
  }
}