{
  "cve_id": "CVE-2024-34709",
  "github_data": {
    "repository": "directus/directus",
    "fix_commit": "a6172f8a6a0f31a6bf4305a090de172ebfb63bcf",
    "related_commits": [
      "a6172f8a6a0f31a6bf4305a090de172ebfb63bcf",
      "a6172f8a6a0f31a6bf4305a090de172ebfb63bcf"
    ],
    "patch_url": "https://github.com/directus/directus/commit/a6172f8a6a0f31a6bf4305a090de172ebfb63bcf.patch",
    "fix_commit_details": {
      "sha": "a6172f8a6a0f31a6bf4305a090de172ebfb63bcf",
      "commit_date": "2024-05-02T12:53:41Z",
      "author": {
        "login": "br41nslug",
        "type": "User",
        "stats": {
          "total_commits": 418,
          "average_weekly_commits": 1.613899613899614,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 127
        }
      },
      "commit_message": {
        "title": "Improved session token validation (#22353)",
        "length": 98,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 36,
        "additions": 36,
        "deletions": 0
      },
      "files": [
        {
          "filename": ".changeset/late-lions-pump.md",
          "status": "added",
          "additions": 5,
          "deletions": 0,
          "patch": "@@ -0,0 +1,5 @@\n+---\n+\"@directus/api\": patch\n+---\n+\n+Improved session token validation"
        },
        {
          "filename": "api/src/utils/get-accountability-for-token.ts",
          "status": "modified",
          "additions": 5,
          "deletions": 0,
          "patch": "@@ -3,6 +3,7 @@ import { InvalidCredentialsError } from '@directus/errors';\n import type { Accountability } from '@directus/types';\n import getDatabase from '../database/index.js';\n import isDirectusJWT from './is-directus-jwt.js';\n+import { verifySessionJWT } from './verify-session-jwt.js';\n import { verifyAccessJWT } from './jwt.js';\n \n export async function getAccountabilityForToken(\n@@ -24,6 +25,10 @@ export async function getAccountabilityForToken(\n \t\tif (isDirectusJWT(token)) {\n \t\t\tconst payload = verifyAccessJWT(token, env['SECRET'] as string);\n \n+\t\t\tif ('session' in payload) {\n+\t\t\t\tawait verifySessionJWT(payload);\n+\t\t\t}\n+\n \t\t\taccountability.role = payload.role;\n \t\t\taccountability.admin = payload.admin_access === true || payload.admin_access == 1;\n \t\t\taccountability.app = payload.app_access === true || payload.app_access == 1;"
        },
        {
          "filename": "api/src/utils/verify-session-jwt.ts",
          "status": "added",
          "additions": 26,
          "deletions": 0,
          "patch": "@@ -0,0 +1,26 @@\n+import getDatabase from '../database/index.js';\n+import { InvalidTokenError } from '@directus/errors';\n+import type { DirectusTokenPayload } from '../types/index.js';\n+\n+/**\n+ * Verifies the associated session is still available and valid.\n+ *\n+ * @throws If session not found.\n+ */\n+export async function verifySessionJWT(payload: DirectusTokenPayload) {\n+\tconst database = getDatabase();\n+\n+\tconst session = await database\n+\t\t.select(1)\n+\t\t.from('directus_sessions')\n+\t\t.where({\n+\t\t\ttoken: payload['session'],\n+\t\t\tuser: payload['id'],\n+\t\t})\n+\t\t.andWhere('expires', '>=', new Date())\n+\t\t.first();\n+\n+\tif (!session) {\n+\t\tthrow new InvalidTokenError();\n+\t}\n+}"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 2,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "28f7dc1c87793e5404c11a7d771760d772171108",
            "date": "2025-01-14T16:53:02Z",
            "author_login": "SP12893678"
          },
          {
            "sha": "3d6f6b5a84cddcfff8bc77fd17b66622732f6847",
            "date": "2025-01-14T14:24:03Z",
            "author_login": "ComfortablyCoding"
          },
          {
            "sha": "95687907fe6abdc2102fece5c9a0c4f637a48cda",
            "date": "2025-01-13T18:35:02Z",
            "author_login": "Dominic-Marcelino"
          },
          {
            "sha": "f6e54ecfc937f519d8cdf44cf10d110c5bbb14d1",
            "date": "2025-01-13T15:24:41Z",
            "author_login": "joselcvarela"
          },
          {
            "sha": "c2b35c42341ec304a83d7175360141e654a50912",
            "date": "2025-01-13T14:33:43Z",
            "author_login": "connorwinston"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 5.4,
    "cvss_vector": "CVSS:3.1/AV:N/AC:H/PR:L/UI:R/S:U/C:H/I:L/A:N",
    "cwe_id": "CWE-613",
    "description": "Directus is a real-time API and App dashboard for managing SQL database content. Prior to 10.11.0, session tokens function like the other JWT tokens where they are not actually invalidated when logging out. The `directus_session` gets destroyed and the cookie gets deleted but if the cookie value is captured, it will still work for the entire expiry time which is set to 1 day by default. Making it effectively a long lived unrevokable stateless token instead of the stateful session token it was meant to be. This vulnerability is fixed in 10.11.0.",
    "attack_vector": "NETWORK",
    "attack_complexity": "HIGH"
  },
  "temporal_data": {
    "published_date": "2024-05-14T15:39:31.547",
    "last_modified": "2025-01-03T16:20:01.927",
    "fix_date": "2024-05-02T12:53:41Z"
  },
  "references": [
    {
      "url": "https://github.com/directus/directus/commit/a6172f8a6a0f31a6bf4305a090de172ebfb63bcf",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/directus/directus/security/advisories/GHSA-g65h-35f3-x2w3",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Vendor Advisory"
      ]
    },
    {
      "url": "https://github.com/directus/directus/commit/a6172f8a6a0f31a6bf4305a090de172ebfb63bcf",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/directus/directus/security/advisories/GHSA-g65h-35f3-x2w3",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Vendor Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:08:20.898234",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "directus",
    "owner": "directus",
    "created_at": "2012-12-12T01:35:36Z",
    "updated_at": "2025-01-14T12:22:36Z",
    "pushed_at": "2025-01-14T01:57:44Z",
    "size": 402534,
    "stars": 28706,
    "forks": 4004,
    "open_issues": 560,
    "watchers": 28706,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [],
    "languages": {
      "TypeScript": 5077921,
      "Vue": 1872125,
      "SCSS": 55791,
      "Liquid": 28677,
      "CSS": 28575,
      "JavaScript": 26426,
      "Dockerfile": 1905,
      "HTML": 1189
    },
    "commit_activity": {
      "total_commits_last_year": 1775,
      "avg_commits_per_week": 34.13461538461539,
      "days_active_last_year": 258
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T14:01:10.212039"
  }
}