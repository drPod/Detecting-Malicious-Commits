{
  "cve_id": "CVE-2024-3574",
  "github_data": {
    "repository": "scrapy/scrapy",
    "fix_commit": "5bcb8fd5019c72d05c4a96da78a7fcb6ecb55b75",
    "related_commits": [
      "5bcb8fd5019c72d05c4a96da78a7fcb6ecb55b75",
      "5bcb8fd5019c72d05c4a96da78a7fcb6ecb55b75"
    ],
    "patch_url": "https://github.com/scrapy/scrapy/commit/5bcb8fd5019c72d05c4a96da78a7fcb6ecb55b75.patch",
    "fix_commit_details": {
      "sha": "5bcb8fd5019c72d05c4a96da78a7fcb6ecb55b75",
      "commit_date": "2024-02-14T16:14:29Z",
      "author": {
        "login": "Gallaecio",
        "type": "User",
        "stats": {
          "total_commits": 665,
          "average_weekly_commits": 0.7687861271676301,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 167
        }
      },
      "commit_message": {
        "title": "Merge branch '2.11-authorization' into 2.11",
        "length": 43,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 68,
        "additions": 65,
        "deletions": 3
      },
      "files": [
        {
          "filename": "docs/news.rst",
          "status": "modified",
          "additions": 26,
          "deletions": 1,
          "patch": "@@ -5,15 +5,26 @@ Release notes\n \n .. _release-2.11.1:\n \n-Scrapy 2.11.1 (YYYY-MM-DD)\n+Scrapy 2.11.1 (unreleased)\n --------------------------\n \n Highlights:\n \n+-   Security bug fixes.\n+\n -   Support for Twisted >= 23.8.0.\n \n -   Documentation improvements.\n \n+Security bug fixes\n+~~~~~~~~~~~~~~~~~~\n+\n+-   The ``Authorization`` header is now dropped on redirects to a different\n+    domain. Please, see the `cw9j-q3vf-hrrv security advisory`_ for more\n+    information.\n+\n+    .. _cw9j-q3vf-hrrv security advisory: https://github.com/scrapy/scrapy/security/advisories/GHSA-cw9j-q3vf-hrrv\n+\n Modified requirements\n ~~~~~~~~~~~~~~~~~~~~~\n \n@@ -61,6 +72,7 @@ Quality assurance\n \n -   Fixed a test issue on PyPy 7.3.14. (:issue:`6204`, :issue:`6205`)\n \n+\n .. _release-2.11.0:\n \n Scrapy 2.11.0 (2023-09-18)\n@@ -2929,6 +2941,19 @@ affect subclasses:\n \n (:issue:`3884`)\n \n+.. _release-1.8.4:\n+\n+Scrapy 1.8.4 (unreleased)\n+-------------------------\n+\n+**Security bug fixes:**\n+\n+-   The ``Authorization`` header is now dropped on redirects to a different\n+    domain. Please, see the `cw9j-q3vf-hrrv security advisory`_ for more\n+    information.\n+\n+    .. _cw9j-q3vf-hrrv security advisory: https://github.com/scrapy/scrapy/security/advisories/GHSA-cw9j-q3vf-hrrv\n+\n \n .. _release-1.8.3:\n "
        },
        {
          "filename": "scrapy/downloadermiddlewares/redirect.py",
          "status": "modified",
          "additions": 8,
          "deletions": 2,
          "patch": "@@ -17,11 +17,17 @@ def _build_redirect_request(source_request, *, url, **kwargs):\n         **kwargs,\n         cookies=None,\n     )\n-    if \"Cookie\" in redirect_request.headers:\n+    has_cookie_header = \"Cookie\" in redirect_request.headers\n+    has_authorization_header = \"Authorization\" in redirect_request.headers\n+    if has_cookie_header or has_authorization_header:\n         source_request_netloc = urlparse_cached(source_request).netloc\n         redirect_request_netloc = urlparse_cached(redirect_request).netloc\n         if source_request_netloc != redirect_request_netloc:\n-            del redirect_request.headers[\"Cookie\"]\n+            if has_cookie_header:\n+                del redirect_request.headers[\"Cookie\"]\n+            # https://fetch.spec.whatwg.org/#ref-for-cors-non-wildcard-request-header-name\n+            if has_authorization_header:\n+                del redirect_request.headers[\"Authorization\"]\n     return redirect_request\n \n "
        },
        {
          "filename": "tests/test_downloadermiddleware_redirect.py",
          "status": "modified",
          "additions": 31,
          "deletions": 0,
          "patch": "@@ -247,6 +247,37 @@ def test_utf8_location(self):\n         perc_encoded_utf8_url = \"http://scrapytest.org/a%C3%A7%C3%A3o\"\n         self.assertEqual(perc_encoded_utf8_url, req_result.url)\n \n+    def test_cross_domain_header_dropping(self):\n+        safe_headers = {\"A\": \"B\"}\n+        original_request = Request(\n+            \"https://example.com\",\n+            headers={\"Cookie\": \"a=b\", \"Authorization\": \"a\", **safe_headers},\n+        )\n+\n+        internal_response = Response(\n+            \"https://example.com\",\n+            headers={\"Location\": \"https://example.com/a\"},\n+            status=301,\n+        )\n+        internal_redirect_request = self.mw.process_response(\n+            original_request, internal_response, self.spider\n+        )\n+        self.assertIsInstance(internal_redirect_request, Request)\n+        self.assertEqual(original_request.headers, internal_redirect_request.headers)\n+\n+        external_response = Response(\n+            \"https://example.com\",\n+            headers={\"Location\": \"https://example.org/a\"},\n+            status=301,\n+        )\n+        external_redirect_request = self.mw.process_response(\n+            original_request, external_response, self.spider\n+        )\n+        self.assertIsInstance(external_redirect_request, Request)\n+        self.assertEqual(\n+            safe_headers, external_redirect_request.headers.to_unicode_dict()\n+        )\n+\n \n class MetaRefreshMiddlewareTest(unittest.TestCase):\n     def setUp(self):"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 3,
        "max_directory_depth": 2
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "98ba61256deceba7b04b938a97005258f4ef5c66",
            "date": "2025-01-14T14:36:56Z",
            "author_login": "Gallaecio"
          },
          {
            "sha": "402500b164efc01257679247d3dd1628a5f90f5e",
            "date": "2025-01-10T18:08:27Z",
            "author_login": "ionut-ciubotariu"
          },
          {
            "sha": "1fc91bb46262118c9ff7aa2b4719d880f727699f",
            "date": "2025-01-08T16:28:51Z",
            "author_login": "BurnzZ"
          },
          {
            "sha": "b6d69e389576c137a33d14c9e9319891dce68442",
            "date": "2025-01-07T17:29:31Z",
            "author_login": "Gallaecio"
          },
          {
            "sha": "3154b08e90d9777dfe2879b8686b6fc63a793c84",
            "date": "2025-01-07T14:40:25Z",
            "author_login": "wRAR"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": null,
    "cvss_vector": null,
    "cwe_id": "CWE-200",
    "description": "In scrapy version 2.10.1, an issue was identified where the Authorization header, containing credentials for server authentication, is leaked to a third-party site during a cross-domain redirect. This vulnerability arises from the failure to remove the Authorization header when redirecting across domains. The exposure of the Authorization header to unauthorized actors could potentially allow for account hijacking.",
    "attack_vector": null,
    "attack_complexity": null
  },
  "temporal_data": {
    "published_date": "2024-04-16T00:15:12.750",
    "last_modified": "2024-11-21T09:29:54.513",
    "fix_date": "2024-02-14T16:14:29Z"
  },
  "references": [
    {
      "url": "https://github.com/scrapy/scrapy/commit/5bcb8fd5019c72d05c4a96da78a7fcb6ecb55b75",
      "source": "security@huntr.dev",
      "tags": []
    },
    {
      "url": "https://huntr.com/bounties/49974321-2718-43e3-a152-62b16eed72a9",
      "source": "security@huntr.dev",
      "tags": []
    },
    {
      "url": "https://github.com/scrapy/scrapy/commit/5bcb8fd5019c72d05c4a96da78a7fcb6ecb55b75",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://huntr.com/bounties/49974321-2718-43e3-a152-62b16eed72a9",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:08:04.493162",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "scrapy",
    "owner": "scrapy",
    "created_at": "2010-02-22T02:01:14Z",
    "updated_at": "2025-01-14T12:03:42Z",
    "pushed_at": "2025-01-10T18:08:27Z",
    "size": 26971,
    "stars": 53789,
    "forks": 10611,
    "open_issues": 611,
    "watchers": 53789,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "Python": 2367474,
      "HTML": 3290,
      "Roff": 2010,
      "Shell": 252
    },
    "commit_activity": {
      "total_commits_last_year": 389,
      "avg_commits_per_week": 7.480769230769231,
      "days_active_last_year": 122
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "bsd-3-clause"
    },
    "collected_at": "2025-01-14T13:18:23.407520"
  }
}