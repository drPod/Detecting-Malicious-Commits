{
  "cve_id": "CVE-2024-39305",
  "github_data": {
    "repository": "envoyproxy/envoy",
    "fix_commit": "02a06681fbe0e039b1c7a9215257a7537eddb518",
    "related_commits": [
      "02a06681fbe0e039b1c7a9215257a7537eddb518",
      "50b384cb203a1f2894324cbae64b6d9bc44cce45",
      "99b6e525fb9f6f6f19a0425f779bc776f121c7e5",
      "b7f509607ad860fd6a63cde4f7d6f0197f9f63bb",
      "02a06681fbe0e039b1c7a9215257a7537eddb518",
      "50b384cb203a1f2894324cbae64b6d9bc44cce45",
      "99b6e525fb9f6f6f19a0425f779bc776f121c7e5",
      "b7f509607ad860fd6a63cde4f7d6f0197f9f63bb"
    ],
    "patch_url": "https://github.com/envoyproxy/envoy/commit/02a06681fbe0e039b1c7a9215257a7537eddb518.patch",
    "fix_commit_details": {
      "sha": "02a06681fbe0e039b1c7a9215257a7537eddb518",
      "commit_date": "2024-06-27T19:06:14Z",
      "author": {
        "login": "ramaraochavali",
        "type": "User",
        "stats": {
          "total_commits": 221,
          "average_weekly_commits": 0.5011337868480725,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 138
        }
      },
      "commit_message": {
        "title": "http: fix cookie attributes (#34885)",
        "length": 102,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 57,
        "additions": 54,
        "deletions": 3
      },
      "files": [
        {
          "filename": "changelogs/current.yaml",
          "status": "modified",
          "additions": 4,
          "deletions": 0,
          "patch": "@@ -8,6 +8,10 @@ minor_behavior_changes:\n \n bug_fixes:\n # *Changes expected to improve the state of the world and are unlikely to have negative effects*\n+- area: http\n+  change: |\n+    Fixed a bug where additional :ref:`cookie attributes <envoy_v3_api_msg_config.route.v3.RouteAction.HashPolicy.cookie>`\n+    are not sent properly to clients.\n \n removed_config_or_runtime:\n # *Normally occurs at the end of the* :ref:`deprecation period <deprecated>`"
        },
        {
          "filename": "source/common/http/hash_policy.cc",
          "status": "modified",
          "additions": 11,
          "deletions": 3,
          "patch": "@@ -82,7 +82,11 @@ class CookieHashMethod : public HashMethodImplBase {\n   CookieHashMethod(const std::string& key, const std::string& path,\n                    const absl::optional<std::chrono::seconds>& ttl, bool terminal,\n                    const CookieAttributeRefVector attributes)\n-      : HashMethodImplBase(terminal), key_(key), path_(path), ttl_(ttl), attributes_(attributes) {}\n+      : HashMethodImplBase(terminal), key_(key), path_(path), ttl_(ttl) {\n+    for (const auto& attribute : attributes) {\n+      attributes_.push_back(attribute);\n+    }\n+  }\n \n   absl::optional<uint64_t> evaluate(const Network::Address::Instance*,\n                                     const RequestHeaderMap& headers,\n@@ -91,7 +95,11 @@ class CookieHashMethod : public HashMethodImplBase {\n     absl::optional<uint64_t> hash;\n     std::string value = Utility::parseCookieValue(headers, key_);\n     if (value.empty() && ttl_.has_value()) {\n-      value = add_cookie(key_, path_, ttl_.value(), attributes_);\n+      CookieAttributeRefVector attributes;\n+      for (const auto& attribute : attributes_) {\n+        attributes.push_back(attribute);\n+      }\n+      value = add_cookie(key_, path_, ttl_.value(), attributes);\n       hash = HashUtil::xxHash64(value);\n \n     } else if (!value.empty()) {\n@@ -104,7 +112,7 @@ class CookieHashMethod : public HashMethodImplBase {\n   const std::string key_;\n   const std::string path_;\n   const absl::optional<std::chrono::seconds> ttl_;\n-  const CookieAttributeRefVector attributes_;\n+  std::vector<CookieAttribute> attributes_;\n };\n \n class IpHashMethod : public HashMethodImplBase {"
        },
        {
          "filename": "test/integration/multiplexed_integration_test.cc",
          "status": "modified",
          "additions": 39,
          "deletions": 0,
          "patch": "@@ -1819,6 +1819,45 @@ TEST_P(MultiplexedRingHashIntegrationTest, CookieRoutingNoCookieWithNonzeroTtlSe\n   EXPECT_EQ(set_cookies.size(), 1);\n }\n \n+TEST_P(MultiplexedRingHashIntegrationTest,\n+       CookieRoutingNoCookieWithNonzeroTtlSetAndWithAttributes) {\n+  config_helper_.addConfigModifier(\n+      [&](envoy::extensions::filters::network::http_connection_manager::v3::HttpConnectionManager&\n+              hcm) -> void {\n+        auto* hash_policy = hcm.mutable_route_config()\n+                                ->mutable_virtual_hosts(0)\n+                                ->mutable_routes(0)\n+                                ->mutable_route()\n+                                ->add_hash_policy();\n+        auto* cookie = hash_policy->mutable_cookie();\n+        cookie->set_name(\"foo\");\n+        cookie->mutable_ttl()->set_seconds(15);\n+        auto* attribute_1 = cookie->mutable_attributes()->Add();\n+        attribute_1->set_name(\"test1\");\n+        attribute_1->set_value(\"value1\");\n+        auto* attribute_2 = cookie->mutable_attributes()->Add();\n+        attribute_2->set_name(\"test2\");\n+        attribute_2->set_value(\"value2\");\n+      });\n+\n+  std::set<std::string> set_cookies;\n+  sendMultipleRequests(\n+      1024,\n+      Http::TestRequestHeaderMapImpl{{\":method\", \"POST\"},\n+                                     {\":path\", \"/test/long/url\"},\n+                                     {\":scheme\", \"http\"},\n+                                     {\":authority\", \"host\"}},\n+      [&](IntegrationStreamDecoder& response) {\n+        EXPECT_EQ(\"200\", response.headers().getStatusValue());\n+        std::string value(\n+            response.headers().get(Http::Headers::get().SetCookie)[0]->value().getStringView());\n+        set_cookies.insert(value);\n+        EXPECT_THAT(value,\n+                    MatchesRegex(\"foo=.*; Max-Age=15; test1=value1; test2=value2; HttpOnly\"));\n+      });\n+  EXPECT_EQ(set_cookies.size(), 1);\n+}\n+\n TEST_P(MultiplexedRingHashIntegrationTest, CookieRoutingNoCookieWithZeroTtlSet) {\n   config_helper_.addConfigModifier(\n       [&](envoy::extensions::filters::network::http_connection_manager::v3::HttpConnectionManager&"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 3,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "03cb8d59f80a2a75d9e1289c909e5979a79ace91",
            "date": "2025-01-13T06:31:54Z",
            "author_login": "dependabot[bot]"
          },
          {
            "sha": "3487b225f48717dd5a2babb5f921df4353633cee",
            "date": "2025-01-13T06:10:11Z",
            "author_login": "dependabot[bot]"
          },
          {
            "sha": "acdcfc6ac262ee4087a652532b93922550efb061",
            "date": "2025-01-10T07:01:57Z",
            "author_login": "dependabot[bot]"
          },
          {
            "sha": "02633ec5db8d6a3f24fa6752dff36b4fb5f0800e",
            "date": "2025-01-10T07:02:42Z",
            "author_login": "dependabot[bot]"
          },
          {
            "sha": "e62004f8710e90e255495ae44caab1a778f01b9e",
            "date": "2025-01-10T07:03:28Z",
            "author_login": "dependabot[bot]"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 6.5,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:L",
    "cwe_id": "CWE-416",
    "description": "Envoy is a cloud-native, open source edge and service proxy. Prior to versions 1.30.4, 1.29.7, 1.28.5, and 1.27.7. Envoy references already freed memory when route hash policy is configured with cookie attributes. Note that this vulnerability has been fixed in the open as the effect would be immediately apparent if it was configured. Memory allocated for holding attribute values is freed after configuration was parsed. During request processing Envoy will attempt to copy content of de-allocated memory into request cookie header. This can lead to arbitrary content of Envoy's memory to be sent to the upstream service or abnormal process termination. This vulnerability is fixed in Envoy versions v1.30.4, v1.29.7, v1.28.5, and v1.27.7. As a workaround, do not use cookie attributes in route action hash policy.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2024-07-01T21:15:04.520",
    "last_modified": "2024-11-21T09:27:25.570",
    "fix_date": "2024-06-27T19:06:14Z"
  },
  "references": [
    {
      "url": "https://github.com/envoyproxy/envoy/commit/02a06681fbe0e039b1c7a9215257a7537eddb518",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/envoyproxy/envoy/commit/50b384cb203a1f2894324cbae64b6d9bc44cce45",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/envoyproxy/envoy/commit/99b6e525fb9f6f6f19a0425f779bc776f121c7e5",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/envoyproxy/envoy/commit/b7f509607ad860fd6a63cde4f7d6f0197f9f63bb",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/envoyproxy/envoy/security/advisories/GHSA-fp35-g349-h66f",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/envoyproxy/envoy/commit/02a06681fbe0e039b1c7a9215257a7537eddb518",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://github.com/envoyproxy/envoy/commit/50b384cb203a1f2894324cbae64b6d9bc44cce45",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://github.com/envoyproxy/envoy/commit/99b6e525fb9f6f6f19a0425f779bc776f121c7e5",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://github.com/envoyproxy/envoy/commit/b7f509607ad860fd6a63cde4f7d6f0197f9f63bb",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://github.com/envoyproxy/envoy/security/advisories/GHSA-fp35-g349-h66f",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:08:28.881654",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "envoy",
    "owner": "envoyproxy",
    "created_at": "2016-08-08T15:07:24Z",
    "updated_at": "2025-01-14T12:22:22Z",
    "pushed_at": "2025-01-14T05:36:17Z",
    "size": 240648,
    "stars": 25321,
    "forks": 4848,
    "open_issues": 1639,
    "watchers": 25321,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [],
    "languages": {
      "C++": 48293036,
      "Starlark": 3105942,
      "Java": 1320095,
      "Python": 605206,
      "Assembly": 327095,
      "Kotlin": 309606,
      "Swift": 250537,
      "Shell": 229801,
      "Go": 183281,
      "Rust": 107190,
      "JavaScript": 66339,
      "C": 61597,
      "Objective-C++": 55490,
      "Objective-C": 48840,
      "Jinja": 47798,
      "Smarty": 3528,
      "CSS": 2927,
      "HTML": 1522,
      "Emacs Lisp": 966,
      "Dockerfile": 960,
      "Thrift": 748,
      "PureBasic": 472,
      "Batchfile": 439,
      "Makefile": 303
    },
    "commit_activity": {
      "total_commits_last_year": 3286,
      "avg_commits_per_week": 63.19230769230769,
      "days_active_last_year": 303
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "apache-2.0"
    },
    "collected_at": "2025-01-14T12:55:59.245540"
  }
}