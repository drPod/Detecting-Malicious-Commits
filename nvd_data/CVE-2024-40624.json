{
  "cve_id": "CVE-2024-40624",
  "github_data": {
    "repository": "torrentpier/torrentpier",
    "fix_commit": "ed37e6e522f345f2b46147c6f53c1ab6dec1db9e",
    "related_commits": [
      "ed37e6e522f345f2b46147c6f53c1ab6dec1db9e",
      "ed37e6e522f345f2b46147c6f53c1ab6dec1db9e"
    ],
    "patch_url": "https://github.com/torrentpier/torrentpier/commit/ed37e6e522f345f2b46147c6f53c1ab6dec1db9e.patch",
    "fix_commit_details": {
      "sha": "ed37e6e522f345f2b46147c6f53c1ab6dec1db9e",
      "commit_date": "2024-07-13T12:26:57Z",
      "author": {
        "login": "belomaxorka",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Merge commit from fork",
        "length": 22,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 10,
        "additions": 4,
        "deletions": 6
      },
      "files": [
        {
          "filename": "library/includes/functions.php",
          "status": "modified",
          "additions": 2,
          "deletions": 4,
          "patch": "@@ -40,8 +40,6 @@ function delete_avatar($user_id, $avatar_ext_id)\n \n function get_tracks($type)\n {\n-    static $pattern = '#^a:\\d+:{[i:;\\d]+}$#';\n-\n     switch ($type) {\n         case 'topic':\n             $c_name = COOKIE_TOPIC;\n@@ -55,7 +53,7 @@ function get_tracks($type)\n         default:\n             trigger_error(__FUNCTION__ . \": invalid type '$type'\", E_USER_ERROR);\n     }\n-    $tracks = !empty($_COOKIE[$c_name]) ? @unserialize($_COOKIE[$c_name]) : false;\n+    $tracks = !empty($_COOKIE[$c_name]) ? json_decode($_COOKIE[$c_name], true) : false;\n     return $tracks ?: [];\n }\n \n@@ -113,7 +111,7 @@ function set_tracks($cookie_name, &$tracking_ary, $tracks = null, $val = TIMENOW\n     }\n \n     if (array_diff($tracking_ary, $prev_tracking_ary)) {\n-        bb_setcookie($cookie_name, serialize($tracking_ary));\n+        bb_setcookie($cookie_name, json_encode($tracking_ary));\n     }\n }\n "
        },
        {
          "filename": "src/Legacy/Common/User.php",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -453,7 +453,7 @@ public function login(array $args, bool $mod_admin_login = false): array\n      */\n     public function get_sessiondata()\n     {\n-        $sd_resv = !empty($_COOKIE[COOKIE_DATA]) ? unserialize($_COOKIE[COOKIE_DATA], ['allowed_classes' => false]) : [];\n+        $sd_resv = !empty($_COOKIE[COOKIE_DATA]) ? json_decode($_COOKIE[COOKIE_DATA], true) : [];\n \n         // autologin_id\n         if (!empty($sd_resv['uk']) && verify_id($sd_resv['uk'], LOGIN_KEY_LENGTH)) {\n@@ -486,7 +486,7 @@ public function set_session_cookies($user_id)\n             }\n         } else {\n             $c_sdata_resv = !empty($_COOKIE[COOKIE_DATA]) ? $_COOKIE[COOKIE_DATA] : null;\n-            $c_sdata_curr = ($this->sessiondata) ? serialize($this->sessiondata) : '';\n+            $c_sdata_curr = ($this->sessiondata) ? json_encode($this->sessiondata) : '';\n \n             if ($c_sdata_curr !== $c_sdata_resv) {\n                 bb_setcookie(COOKIE_DATA, $c_sdata_curr, httponly: true);"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 2,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "1122c603ddbc3750d41fe0eff5bdaee08088e375",
            "date": "2025-01-14T08:26:50Z",
            "author_login": "belomaxorka"
          },
          {
            "sha": "262b8872a5b14068eb73d745adea6203c557e192",
            "date": "2025-01-14T08:26:30Z",
            "author_login": "belomaxorka"
          },
          {
            "sha": "800e87e7c0fc62a9864e2ad61e58d64b4e5b5123",
            "date": "2025-01-14T06:57:02Z",
            "author_login": "belomaxorka"
          },
          {
            "sha": "55d467048370b51cd592982c8026702dca8813d5",
            "date": "2025-01-14T06:56:47Z",
            "author_login": "belomaxorka"
          },
          {
            "sha": "208c55a3d048b6f712d280d5d06f0e52845683b5",
            "date": "2025-01-14T06:51:04Z",
            "author_login": "belomaxorka"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 9.8,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
    "cwe_id": "CWE-502",
    "description": "TorrentPier is an open source BitTorrent Public/Private tracker engine, written in php. In `torrentpier/library/includes/functions.php`, `get_tracks()` uses the unsafe native PHP serialization format to deserialize user-controlled cookies. One can use phpggc and the chain Guzzle/FW1 to write PHP code to an arbitrary file, and execute commands on the system. For instance, the cookie bb_t will be deserialized when browsing to viewforum.php. This issue has been addressed in commit `ed37e6e52` which is expected to be included in release version 2.4.4. Users are advised to upgrade as soon as the new release is available. There are no known workarounds for this vulnerability.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2024-07-15T20:15:04.810",
    "last_modified": "2024-11-21T09:31:23.177",
    "fix_date": "2024-07-13T12:26:57Z"
  },
  "references": [
    {
      "url": "https://github.com/torrentpier/torrentpier/blob/84f6c9f4a081d9ffff4c233098758280304bf50f/library/includes/functions.php#L41-L60",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/torrentpier/torrentpier/commit/ed37e6e522f345f2b46147c6f53c1ab6dec1db9e",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/torrentpier/torrentpier/security/advisories/GHSA-fg86-4c2r-7wxw",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/torrentpier/torrentpier/blob/84f6c9f4a081d9ffff4c233098758280304bf50f/library/includes/functions.php#L41-L60",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://github.com/torrentpier/torrentpier/commit/ed37e6e522f345f2b46147c6f53c1ab6dec1db9e",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://github.com/torrentpier/torrentpier/security/advisories/GHSA-fg86-4c2r-7wxw",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:08:31.484767",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "torrentpier",
    "owner": "torrentpier",
    "created_at": "2014-07-23T14:38:23Z",
    "updated_at": "2025-01-14T08:26:54Z",
    "pushed_at": "2025-01-14T08:26:51Z",
    "size": 41683,
    "stars": 298,
    "forks": 81,
    "open_issues": 7,
    "watchers": 298,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "legacy-develop",
      "legacy-experimental",
      "master"
    ],
    "languages": {
      "PHP": 10472940,
      "HTML": 908188,
      "Smarty": 541147,
      "CSS": 59400,
      "JavaScript": 31563
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-14T13:10:05.727974"
  }
}