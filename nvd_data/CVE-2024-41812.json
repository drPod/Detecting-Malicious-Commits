{
  "cve_id": "CVE-2024-41812",
  "github_data": {
    "repository": "TxtDot/txtdot",
    "fix_commit": "7c72d985f7a26ec1fd3cf628444717ca54986d2d",
    "related_commits": [
      "7c72d985f7a26ec1fd3cf628444717ca54986d2d",
      "7c72d985f7a26ec1fd3cf628444717ca54986d2d"
    ],
    "patch_url": "https://github.com/TxtDot/txtdot/commit/7c72d985f7a26ec1fd3cf628444717ca54986d2d.patch",
    "fix_commit_details": {
      "sha": "7c72d985f7a26ec1fd3cf628444717ca54986d2d",
      "commit_date": "2024-03-07T11:49:54Z",
      "author": {
        "login": "artegoser",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Merge pull request from GHSA-4gj5-xj97-j8fp",
        "length": 1542,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 1018,
        "additions": 932,
        "deletions": 86
      },
      "files": [
        {
          "filename": ".env.example",
          "status": "modified",
          "additions": 14,
          "deletions": 8,
          "patch": "@@ -1,14 +1,20 @@\n-HOST=127.0.0.1  # 0.0.0.0 if txtdot is not behind reverse proxy\n-PORT=8080\n+# Server settings\n \n-TIMEOUT=0 # Connection timout 0 (no timout)\n+HOST=0.0.0.0\n+PORT=8080\n+TIMEOUT=0  # 0 means no timeout\n+REVERSE_PROXY=false  # only with reverse proxy; see docs\n \n-REVERSE_PROXY=true  # only for reverse proxy; see docs\n+# Features\n \n+## Proxy\n PROXY_RES=true\n-SWAGGER=false  # whether to add API docs route or not\n \n-# Search\n+IMG_COMPRESS=true  # enable image compressing; proxy_res is required\n+\n+## Documentation\n+SWAGGER=false  # whether to add API docs route\n \n-SEARCH_ENABLED=false # If enabled then you need >\n-SEARX_URL=\"\" # Base url of searxng instance without /search, etc\n+## Search\n+SEARCH_ENABLED=false  # searx_url is required when enabled\n+SEARX_URL=\"\"  # SearXNG base URL, e.g. https://searx.dc09.ru\n\\ No newline at end of file"
        },
        {
          "filename": ".github/workflows/build.yml",
          "status": "added",
          "additions": 19,
          "deletions": 0,
          "patch": "@@ -0,0 +1,19 @@\n+name: build-check\n+on: pull_request\n+jobs:\n+  build-check:\n+    runs-on: ubuntu-latest\n+    steps:\n+      - name: Checkout code\n+        uses: actions/checkout@v2\n+\n+      - name: Set up Node.js\n+        uses: actions/setup-node@v2\n+        with:\n+          node-version: '14'\n+\n+      - name: Install dependencies\n+        run: npm install\n+\n+      - name: Start build\n+        run: npm run build"
        },
        {
          "filename": ".github/workflows/format-check.yml",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -1,7 +1,7 @@\n name: format-check\n on: pull_request\n jobs:\n-  check-formatting:\n+  format-check:\n     runs-on: ubuntu-latest\n     steps:\n       - name: Checkout code"
        },
        {
          "filename": "README.md",
          "status": "modified",
          "additions": 72,
          "deletions": 11,
          "patch": "@@ -11,35 +11,96 @@\n \n HTTP proxy that parses only text, links and pictures from pages\n reducing internet traffic, removing ads and heavy scripts.\n+Mozilla's Readability library is used under the hood.\n \n-Uses [Mozilla's readability.js](https://github.com/mozilla/readability),\n-[\ud83d\udd17 linkedom](https://github.com/WebReflection/linkedom),\n-[Fastify web framework](https://github.com/fastify/fastify).\n+## Features\n \n-## Installation\n-\n-```bash\n-npm install\n-```\n+- Server-side page simplification\n+- Media proxy\n+- Image compression with Sharp\n+- Search with SearXNG\n+- Custom parsers for StackOverflow and SearXNG\n+- Handy API endpoints\n+- No client JavaScript\n+- Some kind of Material Design 3\n \n ## Running\n \n-### Dev\n+### Development\n \n ```bash\n+npm install\n npm run dev\n ```\n \n-### Prod\n+### Production\n \n ```bash\n+npm install\n npm run build\n npm run start\n ```\n \n ### Docker\n \n ```bash\n-docker compose build\n docker compose up -d\n ```\n+\n+## Screenshots\n+\n+<div align=\"center\">\n+<img src=\"https://raw.githubusercontent.com/TxtDot/.github/main/imgs/ui_url_input.png\" alt=\"Main page with URL input field\">\n+<img src=\"https://raw.githubusercontent.com/TxtDot/.github/main/imgs/ui_search_page.png\" alt=\"SearXNG search results page\">\n+</div>\n+\n+## Performance tests\n+\n+txtdot is a great tool in case of slow internet connection or weak signal.\n+Here is the comparision of performance metrics from pagespeed.web.dev\n+between original page and proxied one.\n+\n+\"Mobile\" test includes \"Slow 4G\" artificial network throttling.\n+\n+<details>\n+<summary>Expand</summary>\n+\n+|                                  |     Original page     | Proxied through txtdot |\n+| :------------------------------- | :-------------------: | :--------------------: |\n+| [Habr][habr-link] Desktop        |  ![56%][habr-do-img]  |  ![99%][habr-dt-img]   |\n+| [Habr][habr-link] Mobile         |  ![21%][habr-mo-img]  |  ![100%][habr-mt-img]  |\n+| [Medium][medium-link] Desktop    | ![44%][medium-do-img] | ![100%][medium-dt-img] |\n+| [Medium][medium-link] Mobile     | ![36%][medium-mo-img] | ![100%][medium-mt-img] |\n+| [Nginx Blog][nginx-link] Desktop | ![53%][nginx-do-img]  | ![100%][nginx-dt-img]  |\n+| [Nginx Blog][nginx-link] Mobile  | ![26%][nginx-mo-img]  | ![100%][nginx-mt-img]  |\n+\n+[habr-link]: https://habr.com/ru/articles/780692/\n+[habr-do-img]: https://raw.githubusercontent.com/TxtDot/.github/main/tests/habr/desktop_orig.png\n+[habr-dt-img]: https://raw.githubusercontent.com/TxtDot/.github/main/tests/habr/desktop_txtdot.png\n+[habr-mo-img]: https://raw.githubusercontent.com/TxtDot/.github/main/tests/habr/mobile_orig.png\n+[habr-mt-img]: https://raw.githubusercontent.com/TxtDot/.github/main/tests/habr/mobile_txtdot.png\n+[medium-link]: https://levelup.gitconnected.com/proxy-servers-how-proxies-work-0ec083fc1030\n+[medium-do-img]: https://raw.githubusercontent.com/TxtDot/.github/main/tests/medium/desktop_orig.png\n+[medium-dt-img]: https://raw.githubusercontent.com/TxtDot/.github/main/tests/medium/desktop_txtdot.png\n+[medium-mo-img]: https://raw.githubusercontent.com/TxtDot/.github/main/tests/medium/mobile_orig.png\n+[medium-mt-img]: https://raw.githubusercontent.com/TxtDot/.github/main/tests/medium/mobile_txtdot.png\n+[nginx-link]: https://www.nginx.com/blog/rate-limiting-nginx/\n+[nginx-do-img]: https://raw.githubusercontent.com/TxtDot/.github/main/tests/nginx-blog/desktop_orig.png\n+[nginx-dt-img]: https://raw.githubusercontent.com/TxtDot/.github/main/tests/nginx-blog/desktop_txtdot.png\n+[nginx-mo-img]: https://raw.githubusercontent.com/TxtDot/.github/main/tests/nginx-blog/mobile_orig.png\n+[nginx-mt-img]: https://raw.githubusercontent.com/TxtDot/.github/main/tests/nginx-blog/mobile_txtdot.png\n+\n+</details>\n+\n+## Credits\n+\n+- [Readability.js](https://github.com/mozilla/readability)\n+- [\ud83d\udd17 LinkeDOM](https://github.com/WebReflection/linkedom)\n+- [Fastify web framework](https://github.com/fastify/fastify)\n+- [EJS](https://github.com/mde/ejs)\n+- [Axios](https://github.com/axios/axios)\n+- [DOMPurify](https://github.com/cure53/DOMPurify)\n+- [Sharp](https://github.com/lovell/sharp)\n+- [MicroMatch](https://github.com/micromatch/micromatch)\n+- [RouteParser](https://github.com/rcs/route-parser)\n+- [IconvLite](https://github.com/ashtuchkin/iconv-lite)"
        },
        {
          "filename": "package-lock.json",
          "status": "modified",
          "additions": 535,
          "deletions": 7,
          "patch": "@@ -1,12 +1,12 @@\n {\n   \"name\": \"txtdot\",\n-  \"version\": \"1.6.1\",\n+  \"version\": \"1.7.0\",\n   \"lockfileVersion\": 3,\n   \"requires\": true,\n   \"packages\": {\n     \"\": {\n       \"name\": \"txtdot\",\n-      \"version\": \"1.6.1\",\n+      \"version\": \"1.7.0\",\n       \"license\": \"MIT\",\n       \"dependencies\": {\n         \"@fastify/static\": \"^6.12.0\",\n@@ -24,14 +24,15 @@\n         \"json-schema-to-ts\": \"^3.0.0\",\n         \"linkedom\": \"^0.16.8\",\n         \"micromatch\": \"^4.0.5\",\n-        \"route-parser\": \"^0.0.5\"\n+        \"route-parser\": \"^0.0.5\",\n+        \"sharp\": \"^0.33.2\"\n       },\n       \"devDependencies\": {\n         \"@types/dompurify\": \"^3.0.5\",\n         \"@types/ejs\": \"^3.1.5\",\n         \"@types/jsdom\": \"^21.1.6\",\n         \"@types/micromatch\": \"^4.0.6\",\n-        \"@types/node\": \"^20.11.20\",\n+        \"@types/node\": \"^20.11.24\",\n         \"@types/route-parser\": \"^0.1.7\",\n         \"@typescript-eslint/eslint-plugin\": \"^7.1.0\",\n         \"@typescript-eslint/parser\": \"^7.1.0\",\n@@ -63,6 +64,15 @@\n         \"node\": \">=6.9.0\"\n       }\n     },\n+    \"node_modules/@emnapi/runtime\": {\n+      \"version\": \"0.45.0\",\n+      \"resolved\": \"https://registry.npmjs.org/@emnapi/runtime/-/runtime-0.45.0.tgz\",\n+      \"integrity\": \"sha512-Txumi3td7J4A/xTTwlssKieHKTGl3j4A1tglBx72auZ49YK7ePY6XZricgIg9mnZT4xPfA+UPCUdnhRuEFDL+w==\",\n+      \"optional\": true,\n+      \"dependencies\": {\n+        \"tslib\": \"^2.4.0\"\n+      }\n+    },\n     \"node_modules/@eslint-community/eslint-utils\": {\n       \"version\": \"4.4.0\",\n       \"resolved\": \"https://registry.npmjs.org/@eslint-community/eslint-utils/-/eslint-utils-4.4.0.tgz\",\n@@ -313,6 +323,437 @@\n       \"integrity\": \"sha512-6EwiSjwWYP7pTckG6I5eyFANjPhmPjUX9JRLUSfNPC7FX7zK9gyZAfUEaECL6ALTpGX5AjnBq3C9XmVWPitNpw==\",\n       \"dev\": true\n     },\n+    \"node_modules/@img/sharp-darwin-arm64\": {\n+      \"version\": \"0.33.2\",\n+      \"resolved\": \"https://registry.npmjs.org/@img/sharp-darwin-arm64/-/sharp-darwin-arm64-0.33.2.tgz\",\n+      \"integrity\": \"sha512-itHBs1rPmsmGF9p4qRe++CzCgd+kFYktnsoR1sbIAfsRMrJZau0Tt1AH9KVnufc2/tU02Gf6Ibujx+15qRE03w==\",\n+      \"cpu\": [\n+        \"arm64\"\n+      ],\n+      \"optional\": true,\n+      \"os\": [\n+        \"darwin\"\n+      ],\n+      \"engines\": {\n+        \"glibc\": \">=2.26\",\n+        \"node\": \"^18.17.0 || ^20.3.0 || >=21.0.0\",\n+        \"npm\": \">=9.6.5\",\n+        \"pnpm\": \">=7.1.0\",\n+        \"yarn\": \">=3.2.0\"\n+      },\n+      \"funding\": {\n+        \"url\": \"https://opencollective.com/libvips\"\n+      },\n+      \"optionalDependencies\": {\n+        \"@img/sharp-libvips-darwin-arm64\": \"1.0.1\"\n+      }\n+    },\n+    \"node_modules/@img/sharp-darwin-x64\": {\n+      \"version\": \"0.33.2\",\n+      \"resolved\": \"https://registry.npmjs.org/@img/sharp-darwin-x64/-/sharp-darwin-x64-0.33.2.tgz\",\n+      \"integrity\": \"sha512-/rK/69Rrp9x5kaWBjVN07KixZanRr+W1OiyKdXcbjQD6KbW+obaTeBBtLUAtbBsnlTTmWthw99xqoOS7SsySDg==\",\n+      \"cpu\": [\n+        \"x64\"\n+      ],\n+      \"optional\": true,\n+      \"os\": [\n+        \"darwin\"\n+      ],\n+      \"engines\": {\n+        \"glibc\": \">=2.26\",\n+        \"node\": \"^18.17.0 || ^20.3.0 || >=21.0.0\",\n+        \"npm\": \">=9.6.5\",\n+        \"pnpm\": \">=7.1.0\",\n+        \"yarn\": \">=3.2.0\"\n+      },\n+      \"funding\": {\n+        \"url\": \"https://opencollective.com/libvips\"\n+      },\n+      \"optionalDependencies\": {\n+        \"@img/sharp-libvips-darwin-x64\": \"1.0.1\"\n+      }\n+    },\n+    \"node_modules/@img/sharp-libvips-darwin-arm64\": {\n+      \"version\": \"1.0.1\",\n+      \"resolved\": \"https://registry.npmjs.org/@img/sharp-libvips-darwin-arm64/-/sharp-libvips-darwin-arm64-1.0.1.tgz\",\n+      \"integrity\": \"sha512-kQyrSNd6lmBV7O0BUiyu/OEw9yeNGFbQhbxswS1i6rMDwBBSX+e+rPzu3S+MwAiGU3HdLze3PanQ4Xkfemgzcw==\",\n+      \"cpu\": [\n+        \"arm64\"\n+      ],\n+      \"optional\": true,\n+      \"os\": [\n+        \"darwin\"\n+      ],\n+      \"engines\": {\n+        \"macos\": \">=11\",\n+        \"npm\": \">=9.6.5\",\n+        \"pnpm\": \">=7.1.0\",\n+        \"yarn\": \">=3.2.0\"\n+      },\n+      \"funding\": {\n+        \"url\": \"https://opencollective.com/libvips\"\n+      }\n+    },\n+    \"node_modules/@img/sharp-libvips-darwin-x64\": {\n+      \"version\": \"1.0.1\",\n+      \"resolved\": \"https://registry.npmjs.org/@img/sharp-libvips-darwin-x64/-/sharp-libvips-darwin-x64-1.0.1.tgz\",\n+      \"integrity\": \"sha512-eVU/JYLPVjhhrd8Tk6gosl5pVlvsqiFlt50wotCvdkFGf+mDNBJxMh+bvav+Wt3EBnNZWq8Sp2I7XfSjm8siog==\",\n+      \"cpu\": [\n+        \"x64\"\n+      ],\n+      \"optional\": true,\n+      \"os\": [\n+        \"darwin\"\n+      ],\n+      \"engines\": {\n+        \"macos\": \">=10.13\",\n+        \"npm\": \">=9.6.5\",\n+        \"pnpm\": \">=7.1.0\",\n+        \"yarn\": \">=3.2.0\"\n+      },\n+      \"funding\": {\n+        \"url\": \"https://opencollective.com/libvips\"\n+      }\n+    },\n+    \"node_modules/@img/sharp-libvips-linux-arm\": {\n+      \"version\": \"1.0.1\",\n+      \"resolved\": \"https://registry.npmjs.org/@img/sharp-libvips-linux-arm/-/sharp-libvips-linux-arm-1.0.1.tgz\",\n+      \"integrity\": \"sha512-FtdMvR4R99FTsD53IA3LxYGghQ82t3yt0ZQ93WMZ2xV3dqrb0E8zq4VHaTOuLEAuA83oDawHV3fd+BsAPadHIQ==\",\n+      \"cpu\": [\n+        \"arm\"\n+      ],\n+      \"optional\": true,\n+      \"os\": [\n+        \"linux\"\n+      ],\n+      \"engines\": {\n+        \"glibc\": \">=2.28\",\n+        \"npm\": \">=9.6.5\",\n+        \"pnpm\": \">=7.1.0\",\n+        \"yarn\": \">=3.2.0\"\n+      },\n+      \"funding\": {\n+        \"url\": \"https://opencollective.com/libvips\"\n+      }\n+    },\n+    \"node_modules/@img/sharp-libvips-linux-arm64\": {\n+      \"version\": \"1.0.1\",\n+      \"resolved\": \"https://registry.npmjs.org/@img/sharp-libvips-linux-arm64/-/sharp-libvips-linux-arm64-1.0.1.tgz\",\n+      \"integrity\": \"sha512-bnGG+MJjdX70mAQcSLxgeJco11G+MxTz+ebxlz8Y3dxyeb3Nkl7LgLI0mXupoO+u1wRNx/iRj5yHtzA4sde1yA==\",\n+      \"cpu\": [\n+        \"arm64\"\n+      ],\n+      \"optional\": true,\n+      \"os\": [\n+        \"linux\"\n+      ],\n+      \"engines\": {\n+        \"glibc\": \">=2.26\",\n+        \"npm\": \">=9.6.5\",\n+        \"pnpm\": \">=7.1.0\",\n+        \"yarn\": \">=3.2.0\"\n+      },\n+      \"funding\": {\n+        \"url\": \"https://opencollective.com/libvips\"\n+      }\n+    },\n+    \"node_modules/@img/sharp-libvips-linux-s390x\": {\n+      \"version\": \"1.0.1\",\n+      \"resolved\": \"https://registry.npmjs.org/@img/sharp-libvips-linux-s390x/-/sharp-libvips-linux-s390x-1.0.1.tgz\",\n+      \"integrity\": \"sha512-3+rzfAR1YpMOeA2zZNp+aYEzGNWK4zF3+sdMxuCS3ey9HhDbJ66w6hDSHDMoap32DueFwhhs3vwooAB2MaK4XQ==\",\n+      \"cpu\": [\n+        \"s390x\"\n+      ],\n+      \"optional\": true,\n+      \"os\": [\n+        \"linux\"\n+      ],\n+      \"engines\": {\n+        \"glibc\": \">=2.28\",\n+        \"npm\": \">=9.6.5\",\n+        \"pnpm\": \">=7.1.0\",\n+        \"yarn\": \">=3.2.0\"\n+      },\n+      \"funding\": {\n+        \"url\": \"https://opencollective.com/libvips\"\n+      }\n+    },\n+    \"node_modules/@img/sharp-libvips-linux-x64\": {\n+      \"version\": \"1.0.1\",\n+      \"resolved\": \"https://registry.npmjs.org/@img/sharp-libvips-linux-x64/-/sharp-libvips-linux-x64-1.0.1.tgz\",\n+      \"integrity\": \"sha512-3NR1mxFsaSgMMzz1bAnnKbSAI+lHXVTqAHgc1bgzjHuXjo4hlscpUxc0vFSAPKI3yuzdzcZOkq7nDPrP2F8Jgw==\",\n+      \"cpu\": [\n+        \"x64\"\n+      ],\n+      \"optional\": true,\n+      \"os\": [\n+        \"linux\"\n+      ],\n+      \"engines\": {\n+        \"glibc\": \">=2.26\",\n+        \"npm\": \">=9.6.5\",\n+        \"pnpm\": \">=7.1.0\",\n+        \"yarn\": \">=3.2.0\"\n+      },\n+      \"funding\": {\n+        \"url\": \"https://opencollective.com/libvips\"\n+      }\n+    },\n+    \"node_modules/@img/sharp-libvips-linuxmusl-arm64\": {\n+      \"version\": \"1.0.1\",\n+      \"resolved\": \"https://registry.npmjs.org/@img/sharp-libvips-linuxmusl-arm64/-/sharp-libvips-linuxmusl-arm64-1.0.1.tgz\",\n+      \"integrity\": \"sha512-5aBRcjHDG/T6jwC3Edl3lP8nl9U2Yo8+oTl5drd1dh9Z1EBfzUKAJFUDTDisDjUwc7N4AjnPGfCA3jl3hY8uDg==\",\n+      \"cpu\": [\n+        \"arm64\"\n+      ],\n+      \"optional\": true,\n+      \"os\": [\n+        \"linux\"\n+      ],\n+      \"engines\": {\n+        \"musl\": \">=1.2.2\",\n+        \"npm\": \">=9.6.5\",\n+        \"pnpm\": \">=7.1.0\",\n+        \"yarn\": \">=3.2.0\"\n+      },\n+      \"funding\": {\n+        \"url\": \"https://opencollective.com/libvips\"\n+      }\n+    },\n+    \"node_modules/@img/sharp-libvips-linuxmusl-x64\": {\n+      \"version\": \"1.0.1\",\n+      \"resolved\": \"https://registry.npmjs.org/@img/sharp-libvips-linuxmusl-x64/-/sharp-libvips-linuxmusl-x64-1.0.1.tgz\",\n+      \"integrity\": \"sha512-dcT7inI9DBFK6ovfeWRe3hG30h51cBAP5JXlZfx6pzc/Mnf9HFCQDLtYf4MCBjxaaTfjCCjkBxcy3XzOAo5txw==\",\n+      \"cpu\": [\n+        \"x64\"\n+      ],\n+      \"optional\": true,\n+      \"os\": [\n+        \"linux\"\n+      ],\n+      \"engines\": {\n+        \"musl\": \">=1.2.2\",\n+        \"npm\": \">=9.6.5\",\n+        \"pnpm\": \">=7.1.0\",\n+        \"yarn\": \">=3.2.0\"\n+      },\n+      \"funding\": {\n+        \"url\": \"https://opencollective.com/libvips\"\n+      }\n+    },\n+    \"node_modules/@img/sharp-linux-arm\": {\n+      \"version\": \"0.33.2\",\n+      \"resolved\": \"https://registry.npmjs.org/@img/sharp-linux-arm/-/sharp-linux-arm-0.33.2.tgz\",\n+      \"integrity\": \"sha512-Fndk/4Zq3vAc4G/qyfXASbS3HBZbKrlnKZLEJzPLrXoJuipFNNwTes71+Ki1hwYW5lch26niRYoZFAtZVf3EGA==\",\n+      \"cpu\": [\n+        \"arm\"\n+      ],\n+      \"optional\": true,\n+      \"os\": [\n+        \"linux\"\n+      ],\n+      \"engines\": {\n+        \"glibc\": \">=2.28\",\n+        \"node\": \"^18.17.0 || ^20.3.0 || >=21.0.0\",\n+        \"npm\": \">=9.6.5\",\n+        \"pnpm\": \">=7.1.0\",\n+        \"yarn\": \">=3.2.0\"\n+      },\n+      \"funding\": {\n+        \"url\": \"https://opencollective.com/libvips\"\n+      },\n+      \"optionalDependencies\": {\n+        \"@img/sharp-libvips-linux-arm\": \"1.0.1\"\n+      }\n+    },\n+    \"node_modules/@img/sharp-linux-arm64\": {\n+      \"version\": \"0.33.2\",\n+      \"resolved\": \"https://registry.npmjs.org/@img/sharp-linux-arm64/-/sharp-linux-arm64-0.33.2.tgz\",\n+      \"integrity\": \"sha512-pz0NNo882vVfqJ0yNInuG9YH71smP4gRSdeL09ukC2YLE6ZyZePAlWKEHgAzJGTiOh8Qkaov6mMIMlEhmLdKew==\",\n+      \"cpu\": [\n+        \"arm64\"\n+      ],\n+      \"optional\": true,\n+      \"os\": [\n+        \"linux\"\n+      ],\n+      \"engines\": {\n+        \"glibc\": \">=2.26\",\n+        \"node\": \"^18.17.0 || ^20.3.0 || >=21.0.0\",\n+        \"npm\": \">=9.6.5\",\n+        \"pnpm\": \">=7.1.0\",\n+        \"yarn\": \">=3.2.0\"\n+      },\n+      \"funding\": {\n+        \"url\": \"https://opencollective.com/libvips\"\n+      },\n+      \"optionalDependencies\": {\n+        \"@img/sharp-libvips-linux-arm64\": \"1.0.1\"\n+      }\n+    },\n+    \"node_modules/@img/sharp-linux-s390x\": {\n+      \"version\": \"0.33.2\",\n+      \"resolved\": \"https://registry.npmjs.org/@img/sharp-linux-s390x/-/sharp-linux-s390x-0.33.2.tgz\",\n+      \"integrity\": \"sha512-MBoInDXDppMfhSzbMmOQtGfloVAflS2rP1qPcUIiITMi36Mm5YR7r0ASND99razjQUpHTzjrU1flO76hKvP5RA==\",\n+      \"cpu\": [\n+        \"s390x\"\n+      ],\n+      \"optional\": true,\n+      \"os\": [\n+        \"linux\"\n+      ],\n+      \"engines\": {\n+        \"glibc\": \">=2.28\",\n+        \"node\": \"^18.17.0 || ^20.3.0 || >=21.0.0\",\n+        \"npm\": \">=9.6.5\",\n+        \"pnpm\": \">=7.1.0\",\n+        \"yarn\": \">=3.2.0\"\n+      },\n+      \"funding\": {\n+        \"url\": \"https://opencollective.com/libvips\"\n+      },\n+      \"optionalDependencies\": {\n+        \"@img/sharp-libvips-linux-s390x\": \"1.0.1\"\n+      }\n+    },\n+    \"node_modules/@img/sharp-linux-x64\": {\n+      \"version\": \"0.33.2\",\n+      \"resolved\": \"https://registry.npmjs.org/@img/sharp-linux-x64/-/sharp-linux-x64-0.33.2.tgz\",\n+      \"integrity\": \"sha512-xUT82H5IbXewKkeF5aiooajoO1tQV4PnKfS/OZtb5DDdxS/FCI/uXTVZ35GQ97RZXsycojz/AJ0asoz6p2/H/A==\",\n+      \"cpu\": [\n+        \"x64\"\n+      ],\n+      \"optional\": true,\n+      \"os\": [\n+        \"linux\"\n+      ],\n+      \"engines\": {\n+        \"glibc\": \">=2.26\",\n+        \"node\": \"^18.17.0 || ^20.3.0 || >=21.0.0\",\n+        \"npm\": \">=9.6.5\",\n+        \"pnpm\": \">=7.1.0\",\n+        \"yarn\": \">=3.2.0\"\n+      },\n+      \"funding\": {\n+        \"url\": \"https://opencollective.com/libvips\"\n+      },\n+      \"optionalDependencies\": {\n+        \"@img/sharp-libvips-linux-x64\": \"1.0.1\"\n+      }\n+    },\n+    \"node_modules/@img/sharp-linuxmusl-arm64\": {\n+      \"version\": \"0.33.2\",\n+      \"resolved\": \"https://registry.npmjs.org/@img/sharp-linuxmusl-arm64/-/sharp-linuxmusl-arm64-0.33.2.tgz\",\n+      \"integrity\": \"sha512-F+0z8JCu/UnMzg8IYW1TMeiViIWBVg7IWP6nE0p5S5EPQxlLd76c8jYemG21X99UzFwgkRo5yz2DS+zbrnxZeA==\",\n+      \"cpu\": [\n+        \"arm64\"\n+      ],\n+      \"optional\": true,\n+      \"os\": [\n+        \"linux\"\n+      ],\n+      \"engines\": {\n+        \"musl\": \">=1.2.2\",\n+        \"node\": \"^18.17.0 || ^20.3.0 || >=21.0.0\",\n+        \"npm\": \">=9.6.5\",\n+        \"pnpm\": \">=7.1.0\",\n+        \"yarn\": \">=3.2.0\"\n+      },\n+      \"funding\": {\n+        \"url\": \"https://opencollective.com/libvips\"\n+      },\n+      \"optionalDependencies\": {\n+        \"@img/sharp-libvips-linuxmusl-arm64\": \"1.0.1\"\n+      }\n+    },\n+    \"node_modules/@img/sharp-linuxmusl-x64\": {\n+      \"version\": \"0.33.2\",\n+      \"resolved\": \"https://registry.npmjs.org/@img/sharp-linuxmusl-x64/-/sharp-linuxmusl-x64-0.33.2.tgz\",\n+      \"integrity\": \"sha512-+ZLE3SQmSL+Fn1gmSaM8uFusW5Y3J9VOf+wMGNnTtJUMUxFhv+P4UPaYEYT8tqnyYVaOVGgMN/zsOxn9pSsO2A==\",\n+      \"cpu\": [\n+        \"x64\"\n+      ],\n+      \"optional\": true,\n+      \"os\": [\n+        \"linux\"\n+      ],\n+      \"engines\": {\n+        \"musl\": \">=1.2.2\",\n+        \"node\": \"^18.17.0 || ^20.3.0 || >=21.0.0\",\n+        \"npm\": \">=9.6.5\",\n+        \"pnpm\": \">=7.1.0\",\n+        \"yarn\": \">=3.2.0\"\n+      },\n+      \"funding\": {\n+        \"url\": \"https://opencollective.com/libvips\"\n+      },\n+      \"optionalDependencies\": {\n+        \"@img/sharp-libvips-linuxmusl-x64\": \"1.0.1\"\n+      }\n+    },\n+    \"node_modules/@img/sharp-wasm32\": {\n+      \"version\": \"0.33.2\",\n+      \"resolved\": \"https://registry.npmjs.org/@img/sharp-wasm32/-/sharp-wasm32-0.33.2.tgz\",\n+      \"integrity\": \"sha512-fLbTaESVKuQcpm8ffgBD7jLb/CQLcATju/jxtTXR1XCLwbOQt+OL5zPHSDMmp2JZIeq82e18yE0Vv7zh6+6BfQ==\",\n+      \"cpu\": [\n+        \"wasm32\"\n+      ],\n+      \"optional\": true,\n+      \"dependencies\": {\n+        \"@emnapi/runtime\": \"^0.45.0\"\n+      },\n+      \"engines\": {\n+        \"node\": \"^18.17.0 || ^20.3.0 || >=21.0.0\",\n+        \"npm\": \">=9.6.5\",\n+        \"pnpm\": \">=7.1.0\",\n+        \"yarn\": \">=3.2.0\"\n+      },\n+      \"funding\": {\n+        \"url\": \"https://opencollective.com/libvips\"\n+      }\n+    },\n+    \"node_modules/@img/sharp-win32-ia32\": {\n+      \"version\": \"0.33.2\",\n+      \"resolved\": \"https://registry.npmjs.org/@img/sharp-win32-ia32/-/sharp-win32-ia32-0.33.2.tgz\",\n+      \"integrity\": \"sha512-okBpql96hIGuZ4lN3+nsAjGeggxKm7hIRu9zyec0lnfB8E7Z6p95BuRZzDDXZOl2e8UmR4RhYt631i7mfmKU8g==\",\n+      \"cpu\": [\n+        \"ia32\"\n+      ],\n+      \"optional\": true,\n+      \"os\": [\n+        \"win32\"\n+      ],\n+      \"engines\": {\n+        \"node\": \"^18.17.0 || ^20.3.0 || >=21.0.0\",\n+        \"npm\": \">=9.6.5\",\n+        \"pnpm\": \">=7.1.0\",\n+        \"yarn\": \">=3.2.0\"\n+      },\n+      \"funding\": {\n+        \"url\": \"https://opencollective.com/libvips\"\n+      }\n+    },\n+    \"node_modules/@img/sharp-win32-x64\": {\n+      \"version\": \"0.33.2\",\n+      \"resolved\": \"https://registry.npmjs.org/@img/sharp-win32-x64/-/sharp-win32-x64-0.33.2.tgz\",\n+      \"integrity\": \"sha512-E4magOks77DK47FwHUIGH0RYWSgRBfGdK56kIHSVeB9uIS4pPFr4N2kIVsXdQQo4LzOsENKV5KAhRlRL7eMAdg==\",\n+      \"cpu\": [\n+        \"x64\"\n+      ],\n+      \"optional\": true,\n+      \"os\": [\n+        \"win32\"\n+      ],\n+      \"engines\": {\n+        \"node\": \"^18.17.0 || ^20.3.0 || >=21.0.0\",\n+        \"npm\": \">=9.6.5\",\n+        \"pnpm\": \">=7.1.0\",\n+        \"yarn\": \">=3.2.0\"\n+      },\n+      \"funding\": {\n+        \"url\": \"https://opencollective.com/libvips\"\n+      }\n+    },\n     \"node_modules/@lukeed/ms\": {\n       \"version\": \"2.0.2\",\n       \"resolved\": \"https://registry.npmjs.org/@lukeed/ms/-/ms-2.0.2.tgz\",\n@@ -411,9 +852,9 @@\n       }\n     },\n     \"node_modules/@types/node\": {\n-      \"version\": \"20.11.22\",\n-      \"resolved\": \"https://registry.npmjs.org/@types/node/-/node-20.11.22.tgz\",\n-      \"integrity\": \"sha512-/G+IxWxma6V3E+pqK1tSl2Fo1kl41pK1yeCyDsgkF9WlVAme4j5ISYM2zR11bgLFJGLN5sVK40T4RJNuiZbEjA==\",\n+      \"version\": \"20.11.24\",\n+      \"resolved\": \"https://registry.npmjs.org/@types/node/-/node-20.11.24.tgz\",\n+      \"integrity\": \"sha512-Kza43ewS3xoLgCEpQrsT+xRo/EJej1y0kVYGiLFE1NEODXGzTfwiC6tXTLMQskn1X4/Rjlh0MQUvx9W+L9long==\",\n       \"dev\": true,\n       \"dependencies\": {\n         \"undici-types\": \"~5.26.4\"\n@@ -1034,6 +1475,18 @@\n         \"wrap-ansi\": \"^7.0.0\"\n       }\n     },\n+    \"node_modules/color\": {\n+      \"version\": \"4.2.3\",\n+      \"resolved\": \"https://registry.npmjs.org/color/-/color-4.2.3.tgz\",\n+      \"integrity\": \"sha512-1rXeuUUiGGrykh+CeBdu5Ie7OJwinCgQY0bc7GCRxy5xVHy+moaqkpL/jqQq0MtQOeYcrqEz4abc5f0KtU7W4A==\",\n+      \"dependencies\": {\n+        \"color-convert\": \"^2.0.1\",\n+        \"color-string\": \"^1.9.0\"\n+      },\n+      \"engines\": {\n+        \"node\": \">=12.5.0\"\n+      }\n+    },\n     \"node_modules/color-convert\": {\n       \"version\": \"2.0.1\",\n       \"resolved\": \"https://registry.npmjs.org/color-convert/-/color-convert-2.0.1.tgz\",\n@@ -1050,6 +1503,15 @@\n       \"resolved\": \"https://registry.npmjs.org/color-name/-/color-name-1.1.4.tgz\",\n       \"integrity\": \"sha512-dOy+3AuW3a2wNbZHIuMZpTcgjGuLU/uBL/ubcZF9OXbDo8ff4O8yVp5Bf0efS8uEoYo5q4Fx7dY9OgQGXgAsQA==\"\n     },\n+    \"node_modules/color-string\": {\n+      \"version\": \"1.9.1\",\n+      \"resolved\": \"https://registry.npmjs.org/color-string/-/color-string-1.9.1.tgz\",\n+      \"integrity\": \"sha512-shrVawQFojnZv6xM40anx4CkoDP+fZsw/ZerEMsW/pyzsRbElpsL/DBVW7q3ExxwusdNXI3lXpuhEZkzs8p5Eg==\",\n+      \"dependencies\": {\n+        \"color-name\": \"^1.0.0\",\n+        \"simple-swizzle\": \"^0.2.2\"\n+      }\n+    },\n     \"node_modules/combined-stream\": {\n       \"version\": \"1.0.8\",\n       \"resolved\": \"https://registry.npmjs.org/combined-stream/-/combined-stream-1.0.8.tgz\",\n@@ -1244,6 +1706,14 @@\n         \"node\": \">= 0.8\"\n       }\n     },\n+    \"node_modules/detect-libc\": {\n+      \"version\": \"2.0.2\",\n+      \"resolved\": \"https://registry.npmjs.org/detect-libc/-/detect-libc-2.0.2.tgz\",\n+      \"integrity\": \"sha512-UX6sGumvvqSaXgdKGUsgZWqcUyIXZ/vZTrlRT/iobiKhGL0zL4d3osHj3uqllWJK+i+sixDS/3COVEOFbupFyw==\",\n+      \"engines\": {\n+        \"node\": \">=8\"\n+      }\n+    },\n     \"node_modules/dir-glob\": {\n       \"version\": \"3.0.1\",\n       \"resolved\": \"https://registry.npmjs.org/dir-glob/-/dir-glob-3.0.1.tgz\",\n@@ -2141,6 +2611,11 @@\n         \"node\": \">= 0.10\"\n       }\n     },\n+    \"node_modules/is-arrayish\": {\n+      \"version\": \"0.3.2\",\n+      \"resolved\": \"https://registry.npmjs.org/is-arrayish/-/is-arrayish-0.3.2.tgz\",\n+      \"integrity\": \"sha512-eVRqCvVlZbuw3GrM63ovNSNAeA1K16kaR/LRY/92w0zxQ5/1YzwblUX652i4Xs9RwAGjW9d9y6X88t8OaAJfWQ==\"\n+    },\n     \"node_modules/is-binary-path\": {\n       \"version\": \"2.1.0\",\n       \"resolved\": \"https://registry.npmjs.org/is-binary-path/-/is-binary-path-2.1.0.tgz\",\n@@ -3083,6 +3558,45 @@\n       \"resolved\": \"https://registry.npmjs.org/setprototypeof/-/setprototypeof-1.2.0.tgz\",\n       \"integrity\": \"sha512-E5LDX7Wrp85Kil5bhZv46j8jOeboKq5JMmYM3gVGdGH8xFpPWXUMsNrlODCrkoxMEeNi/XZIwuRvY4XNwYMJpw==\"\n     },\n+    \"node_modules/sharp\": {\n+      \"version\": \"0.33.2\",\n+      \"resolved\": \"https://registry.npmjs.org/sharp/-/sharp-0.33.2.tgz\",\n+      \"integrity\": \"sha512-WlYOPyyPDiiM07j/UO+E720ju6gtNtHjEGg5vovUk1Lgxyjm2LFO+37Nt/UI3MMh2l6hxTWQWi7qk3cXJTutcQ==\",\n+      \"hasInstallScript\": true,\n+      \"dependencies\": {\n+        \"color\": \"^4.2.3\",\n+        \"detect-libc\": \"^2.0.2\",\n+        \"semver\": \"^7.5.4\"\n+      },\n+      \"engines\": {\n+        \"libvips\": \">=8.15.1\",\n+        \"node\": \"^18.17.0 || ^20.3.0 || >=21.0.0\"\n+      },\n+      \"funding\": {\n+        \"url\": \"https://opencollective.com/libvips\"\n+      },\n+      \"optionalDependencies\": {\n+        \"@img/sharp-darwin-arm64\": \"0.33.2\",\n+        \"@img/sharp-darwin-x64\": \"0.33.2\",\n+        \"@img/sharp-libvips-darwin-arm64\": \"1.0.1\",\n+        \"@img/sharp-libvips-darwin-x64\": \"1.0.1\",\n+        \"@img/sharp-libvips-linux-arm\": \"1.0.1\",\n+        \"@img/sharp-libvips-linux-arm64\": \"1.0.1\",\n+        \"@img/sharp-libvips-linux-s390x\": \"1.0.1\",\n+        \"@img/sharp-libvips-linux-x64\": \"1.0.1\",\n+        \"@img/sharp-libvips-linuxmusl-arm64\": \"1.0.1\",\n+        \"@img/sharp-libvips-linuxmusl-x64\": \"1.0.1\",\n+        \"@img/sharp-linux-arm\": \"0.33.2\",\n+        \"@img/sharp-linux-arm64\": \"0.33.2\",\n+        \"@img/sharp-linux-s390x\": \"0.33.2\",\n+        \"@img/sharp-linux-x64\": \"0.33.2\",\n+        \"@img/sharp-linuxmusl-arm64\": \"0.33.2\",\n+        \"@img/sharp-linuxmusl-x64\": \"0.33.2\",\n+        \"@img/sharp-wasm32\": \"0.33.2\",\n+        \"@img/sharp-win32-ia32\": \"0.33.2\",\n+        \"@img/sharp-win32-x64\": \"0.33.2\"\n+      }\n+    },\n     \"node_modules/shebang-command\": {\n       \"version\": \"2.0.0\",\n       \"resolved\": \"https://registry.npmjs.org/shebang-command/-/shebang-command-2.0.0.tgz\",\n@@ -3104,6 +3618,14 @@\n         \"node\": \">=8\"\n       }\n     },\n+    \"node_modules/simple-swizzle\": {\n+      \"version\": \"0.2.2\",\n+      \"resolved\": \"https://registry.npmjs.org/simple-swizzle/-/simple-swizzle-0.2.2.tgz\",\n+      \"integrity\": \"sha512-JA//kQgZtbuY83m+xT+tXJkmJncGMTFT+C+g2h2R9uxkYIrE2yy9sgmcLhCnw57/WSD+Eh3J97FPEDFnbXnDUg==\",\n+      \"dependencies\": {\n+        \"is-arrayish\": \"^0.3.1\"\n+      }\n+    },\n     \"node_modules/slash\": {\n       \"version\": \"3.0.0\",\n       \"resolved\": \"https://registry.npmjs.org/slash/-/slash-3.0.0.tgz\",\n@@ -3362,6 +3884,12 @@\n         \"typescript\": \"*\"\n       }\n     },\n+    \"node_modules/tslib\": {\n+      \"version\": \"2.6.2\",\n+      \"resolved\": \"https://registry.npmjs.org/tslib/-/tslib-2.6.2.tgz\",\n+      \"integrity\": \"sha512-AEYxH93jGFPn/a2iVAwW87VuUIkR1FVUKB77NwMF7nBTDkDrrT/Hpt/IrCJ0QXhW27jTBDcf5ZY7w6RiqTMw2Q==\",\n+      \"optional\": true\n+    },\n     \"node_modules/type-check\": {\n       \"version\": \"0.4.0\",\n       \"resolved\": \"https://registry.npmjs.org/type-check/-/type-check-0.4.0.tgz\","
        },
        {
          "filename": "package.json",
          "status": "modified",
          "additions": 4,
          "deletions": 3,
          "patch": "@@ -1,6 +1,6 @@\n {\n   \"name\": \"txtdot\",\n-  \"version\": \"1.6.1\",\n+  \"version\": \"1.7.0\",\n   \"private\": true,\n   \"description\": \"txtdot is an HTTP proxy that parses only text, links and pictures from pages reducing internet bandwidth usage, removing ads and heavy scripts\",\n   \"main\": \"dist/app.js\",\n@@ -20,14 +20,15 @@\n     \"json-schema-to-ts\": \"^3.0.0\",\n     \"linkedom\": \"^0.16.8\",\n     \"micromatch\": \"^4.0.5\",\n-    \"route-parser\": \"^0.0.5\"\n+    \"route-parser\": \"^0.0.5\",\n+    \"sharp\": \"^0.33.2\"\n   },\n   \"devDependencies\": {\n     \"@types/dompurify\": \"^3.0.5\",\n     \"@types/ejs\": \"^3.1.5\",\n     \"@types/jsdom\": \"^21.1.6\",\n     \"@types/micromatch\": \"^4.0.6\",\n-    \"@types/node\": \"^20.11.20\",\n+    \"@types/node\": \"^20.11.24\",\n     \"@types/route-parser\": \"^0.1.7\",\n     \"@typescript-eslint/eslint-plugin\": \"^7.1.0\",\n     \"@typescript-eslint/parser\": \"^7.1.0\","
        },
        {
          "filename": "src/app.ts",
          "status": "modified",
          "additions": 11,
          "deletions": 5,
          "patch": "@@ -18,6 +18,9 @@ import errorHandler from './errors/handler';\n import getConfig from './config/main';\n import redirectRoute from './routes/browser/redirect';\n \n+import dynConfig from './config/dynamic.config';\n+import configurationRoute from './routes/browser/configuration';\n+\n class App {\n   async init() {\n     const config = getConfig();\n@@ -42,6 +45,7 @@ class App {\n     });\n \n     if (config.swagger) {\n+      dynConfig.addRoute('/doc');\n       await fastify.register(fastifySwagger, {\n         swagger: {\n           info: {\n@@ -54,14 +58,16 @@ class App {\n       await fastify.register(fastifySwaggerUi, { routePrefix: '/doc' });\n     }\n \n+    fastify.addHook('onRoute', (route) => {\n+      dynConfig.addRoute(route.url);\n+    });\n+\n     fastify.register(indexRoute);\n     fastify.register(getRoute);\n+    fastify.register(configurationRoute);\n \n-    if (config.search.enabled) {\n-      fastify.register(redirectRoute);\n-    }\n-\n-    if (config.proxy_res) fastify.register(proxyRoute);\n+    config.search.enabled && fastify.register(redirectRoute);\n+    config.proxy.enabled && fastify.register(proxyRoute);\n \n     fastify.register(parseRoute);\n     fastify.register(rawHtml);"
        },
        {
          "filename": "src/config/config.service.ts",
          "status": "modified",
          "additions": 11,
          "deletions": 2,
          "patch": "@@ -5,7 +5,7 @@ export class ConfigService {\n   public readonly port: number;\n   public readonly timeout: number;\n   public readonly reverse_proxy: boolean;\n-  public readonly proxy_res: boolean;\n+  public readonly proxy: ProxyConfig;\n   public readonly swagger: boolean;\n   public readonly search: SearchConfig;\n \n@@ -19,7 +19,11 @@ export class ConfigService {\n \n     this.reverse_proxy = this.parseBool(process.env.REVERSE_PROXY, false);\n \n-    this.proxy_res = this.parseBool(process.env.PROXY_RES, true);\n+    this.proxy = {\n+      enabled: this.parseBool(process.env.PROXY_RES, true),\n+      img_compress: this.parseBool(process.env.IMG_COMPRESS, true),\n+    };\n+\n     this.swagger = this.parseBool(process.env.SWAGGER, false);\n \n     this.search = {\n@@ -34,6 +38,11 @@ export class ConfigService {\n   }\n }\n \n+interface ProxyConfig {\n+  enabled: boolean;\n+  img_compress: boolean;\n+}\n+\n interface SearchConfig {\n   enabled: boolean;\n   searx_url?: string;"
        },
        {
          "filename": "src/config/dynamic.config.ts",
          "status": "added",
          "additions": 10,
          "deletions": 0,
          "patch": "@@ -0,0 +1,10 @@\n+class DynConfigService {\n+  public routes: Set<string> = new Set();\n+  constructor() {}\n+  addRoute(route: string) {\n+    this.routes.add(route);\n+  }\n+}\n+\n+const config = new DynConfigService();\n+export default config;"
        },
        {
          "filename": "src/errors/handler.ts",
          "status": "modified",
          "additions": 2,
          "deletions": 1,
          "patch": "@@ -55,7 +55,8 @@ function htmlErrorHandler(error: Error, reply: FastifyReply, url: string) {\n       url,\n       code: error.code,\n       description: error.description,\n-      proxyBtn: error instanceof NotHtmlMimetypeError && getConfig().proxy_res,\n+      proxyBtn:\n+        error instanceof NotHtmlMimetypeError && getConfig().proxy.enabled,\n     });\n   }\n "
        },
        {
          "filename": "src/errors/main.ts",
          "status": "modified",
          "additions": 11,
          "deletions": 1,
          "patch": "@@ -31,13 +31,23 @@ export class LocalResourceError extends TxtDotError {\n   }\n }\n \n+export class UnsupportedMimetypeError extends TxtDotError {\n+  constructor(expected: string, got?: string) {\n+    super(\n+      415,\n+      'UnsupportedMimetypeError',\n+      `Unsupported mimetype, expected ${expected}, got ${got}`\n+    );\n+  }\n+}\n+\n export class NotHtmlMimetypeError extends TxtDotError {\n   constructor() {\n     super(\n       421,\n       'NotHtmlMimetypeError',\n       'Received non-HTML content, ' +\n-        (getConfig().proxy_res\n+        (getConfig().proxy.enabled\n           ? 'use proxy instead of parser.'\n           : 'proxying is disabled by the instance admin.')\n     );"
        },
        {
          "filename": "src/handlers/distributor.ts",
          "status": "modified",
          "additions": 2,
          "deletions": 7,
          "patch": "@@ -7,9 +7,7 @@ import DOMPurify from 'dompurify';\n \n import { Readable } from 'stream';\n \n-import isLocalResource from '../utils/islocal';\n-\n-import { LocalResourceError, NotHtmlMimetypeError } from '../errors/main';\n+import { NotHtmlMimetypeError } from '../errors/main';\n import { HandlerInput } from './handler-input';\n import { decodeStream, parseEncodingName } from '../utils/http';\n import replaceHref from '../utils/replace-href';\n@@ -40,10 +38,6 @@ export class Distributor {\n   ): Promise<IHandlerOutput> {\n     const urlObj = new URL(remoteUrl);\n \n-    if (await isLocalResource(urlObj)) {\n-      throw new LocalResourceError();\n-    }\n-\n     const response = await axios.get(remoteUrl);\n     const data: Readable = response.data;\n     const mime: string | undefined =\n@@ -76,6 +70,7 @@ export class Distributor {\n     if (specified) {\n       return this.fallback[this.engines_id[specified]];\n     }\n+\n     for (const engine of this.fallback) {\n       if (micromatch.isMatch(host, engine.domains)) {\n         return engine;"
        },
        {
          "filename": "src/handlers/engine.ts",
          "status": "modified",
          "additions": 3,
          "deletions": 1,
          "patch": "@@ -11,12 +11,14 @@ interface IRoute<TParams extends RouteValues> {\n \n export class Engine {\n   name: string;\n+  description: string;\n   domains: string[];\n   // eslint-disable-next-line @typescript-eslint/no-explicit-any\n   routes: IRoute<any>[] = [];\n-  constructor(name: string, domains: string[] = []) {\n+  constructor(name: string, description: string, domains: string[] = []) {\n     this.domains = domains;\n     this.name = name;\n+    this.description = description;\n   }\n \n   route<TParams extends RouteValues>("
        },
        {
          "filename": "src/handlers/engines/readability.ts",
          "status": "modified",
          "additions": 5,
          "deletions": 1,
          "patch": "@@ -3,7 +3,11 @@ import { EngineParseError } from '../../errors/main';\n \n import { Engine } from '../engine';\n \n-const ReadabilityEngine = new Engine('Readability');\n+const ReadabilityEngine = new Engine(\n+  'Readability',\n+  'Engine for parsing content with Readability',\n+  ['*']\n+);\n \n ReadabilityEngine.route('*path', async (input, ro) => {\n   const reader = new Readability(input.parseDom().window.document);"
        },
        {
          "filename": "src/handlers/engines/searx.ts",
          "status": "modified",
          "additions": 3,
          "deletions": 1,
          "patch": "@@ -2,7 +2,9 @@ import { Route } from '../../types/handlers';\n import { Engine } from '../engine';\n import { HandlerInput } from '../handler-input';\n \n-const SearXEngine = new Engine('SearX', ['searx.*']);\n+const SearXEngine = new Engine('SearX', \"Engine for searching with 'SearXNG'\", [\n+  'searx.*',\n+]);\n \n async function search(\n   input: HandlerInput,"
        },
        {
          "filename": "src/handlers/engines/stackoverflow/main.ts",
          "status": "modified",
          "additions": 14,
          "deletions": 10,
          "patch": "@@ -1,16 +1,20 @@\n import { Engine } from '../../engine';\n import questions from './questions';\n import users from './users';\n-const soEngine = new Engine('StackOverflow', [\n-  'stackoverflow.com',\n-  '*.stackoverflow.com',\n-  '*.stackexchange.com',\n-  'askubuntu.com',\n-  'stackapps.com',\n-  'mathoverflow.net',\n-  'superuser.com',\n-  'serverfault.com',\n-]);\n+const soEngine = new Engine(\n+  'StackOverflow',\n+  \"Engine for 'StackOverflow'. Available routes: '/questions/' and '/users/'\",\n+  [\n+    'stackoverflow.com',\n+    '*.stackoverflow.com',\n+    '*.stackexchange.com',\n+    'askubuntu.com',\n+    'stackapps.com',\n+    'mathoverflow.net',\n+    'superuser.com',\n+    'serverfault.com',\n+  ]\n+);\n \n soEngine.route('/questions/:id/*slug', questions);\n soEngine.route('/users/:id/*slug', users);"
        },
        {
          "filename": "src/handlers/main.ts",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -5,9 +5,9 @@ import StackOverflow from './engines/stackoverflow/main';\n \n const distributor = new Distributor();\n \n-distributor.engine(Readability);\n-distributor.engine(SearX);\n distributor.engine(StackOverflow);\n+distributor.engine(SearX);\n+distributor.engine(Readability);\n \n export const engineList = distributor.list;\n export default distributor;"
        },
        {
          "filename": "src/routes/browser/configuration.ts",
          "status": "added",
          "additions": 19,
          "deletions": 0,
          "patch": "@@ -0,0 +1,19 @@\n+import { FastifyInstance } from 'fastify';\n+\n+import packageJSON from '../../package';\n+import distributor from '../../handlers/main';\n+import { indexSchema } from '../../types/requests/browser';\n+\n+import getConfig from '../../config/main';\n+import dynConfig from '../../config/dynamic.config';\n+\n+export default async function configurationRoute(fastify: FastifyInstance) {\n+  fastify.get('/configuration', { schema: indexSchema }, async (_, reply) => {\n+    return reply.view('/templates/configuration.ejs', {\n+      packageJSON,\n+      engines: distributor.fallback,\n+      dynConfig,\n+      config: getConfig(),\n+    });\n+  });\n+}"
        },
        {
          "filename": "src/routes/browser/proxy.ts",
          "status": "modified",
          "additions": 48,
          "deletions": 0,
          "patch": "@@ -1,6 +1,9 @@\n import { FastifyInstance } from 'fastify';\n import { IProxySchema, ProxySchema } from '../../types/requests/browser';\n import axios from '../../types/axios';\n+import sharp from 'sharp';\n+import getConfig from '../../config/main';\n+import { UnsupportedMimetypeError } from '../../errors/main';\n \n import isLocalResource from '../../utils/islocal';\n import { LocalResourceError } from '../../errors/main';\n@@ -24,4 +27,49 @@ export default async function proxyRoute(fastify: FastifyInstance) {\n       return reply.send(response.data);\n     }\n   );\n+\n+  if (getConfig().proxy.img_compress)\n+    fastify.get<IProxySchema>(\n+      '/proxy/img',\n+      { schema: ProxySchema },\n+      async (request, reply) => {\n+        const response = await axios.get(request.query.url, {\n+          responseType: 'arraybuffer',\n+        });\n+\n+        const mime: string | undefined =\n+          response.headers['content-type']?.toString();\n+\n+        if (!(mime && mime.startsWith('image/'))) {\n+          throw new UnsupportedMimetypeError('image/*', mime);\n+        }\n+\n+        const clen: number | undefined = parseInt(\n+          response.headers['content-length']?.toString() || '0'\n+        );\n+\n+        if (mime.startsWith('image/svg')) {\n+          reply.header('Content-Type', mime);\n+          reply.header('Content-Length', clen);\n+          return reply.send(response.data);\n+        }\n+\n+        const buffer = await sharp(response.data)\n+          // .grayscale(true)\n+          .toFormat('webp', {\n+            quality: 25,\n+            progressive: true,\n+            optimizeScans: true,\n+          })\n+          .toBuffer();\n+\n+        reply.header('Content-Type', 'image/webp');\n+        reply.header('Content-Length', buffer.length);\n+\n+        reply.header('x-original-size', clen);\n+        reply.header('x-bytes-saved', clen - buffer.length);\n+\n+        return reply.send(buffer);\n+      }\n+    );\n }"
        },
        {
          "filename": "src/types/axios.ts",
          "status": "modified",
          "additions": 23,
          "deletions": 2,
          "patch": "@@ -1,9 +1,30 @@\n-import axios from 'axios';\n+import origAxios from 'axios';\n+import { isLocalResource, isLocalResourceURL } from '../utils/islocal';\n+import { LocalResourceError } from '../errors/main';\n \n-export default axios.create({\n+const axios = origAxios.create({\n   headers: {\n     'User-Agent':\n       'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/116.0',\n   },\n   responseType: 'stream',\n });\n+\n+axios.interceptors.response.use(\n+  (response) => {\n+    if (isLocalResource(response.request.socket.remoteAddress)) {\n+      throw new LocalResourceError();\n+    }\n+\n+    return response;\n+  },\n+  async (error) => {\n+    if (await isLocalResourceURL(new URL(error.config?.url))) {\n+      throw new LocalResourceError();\n+    }\n+\n+    throw error;\n+  }\n+);\n+\n+export default axios;"
        },
        {
          "filename": "src/utils/generate.ts",
          "status": "modified",
          "additions": 3,
          "deletions": 2,
          "patch": "@@ -27,12 +27,13 @@ export function generateParserUrl(\n export function generateProxyUrl(\n   requestUrl: URL,\n   remoteUrl: URL,\n-  href: string\n+  href: string,\n+  subProxy?: string\n ): string {\n   const realHref = getRealURL(href, remoteUrl);\n \n   const urlParam = `?url=${encodeURIComponent(realHref.href)}`;\n-  return `${requestUrl.origin}/proxy${urlParam}`;\n+  return `${requestUrl.origin}/proxy${subProxy ? `/${subProxy}` : ''}${urlParam}`;\n }\n \n function getRealURL(href: string, remoteUrl: URL) {"
        },
        {
          "filename": "src/utils/islocal.ts",
          "status": "modified",
          "additions": 6,
          "deletions": 2,
          "patch": "@@ -1,5 +1,5 @@\n-import dns from 'dns';\n import ipRangeCheck from 'ip-range-check';\n+import dns from 'dns';\n \n const subnets = [\n   '0.0.0.0/8',\n@@ -35,7 +35,11 @@ const subnets = [\n   'ff00::/8',\n ];\n \n-export default async function isLocalResource(url: URL): Promise<boolean> {\n+export function isLocalResource(addr: string): boolean {\n+  return ipRangeCheck(addr, subnets);\n+}\n+\n+export async function isLocalResourceURL(url: URL): Promise<boolean> {\n   // Resolve domain name\n   const addr = (await dns.promises.lookup(url.hostname)).address;\n "
        },
        {
          "filename": "src/utils/replace-href.ts",
          "status": "modified",
          "additions": 13,
          "deletions": 2,
          "patch": "@@ -15,16 +15,27 @@ export default function replaceHref(\n   const proxyUrl = (href: string) =>\n     generateProxyUrl(requestUrl, remoteUrl, href);\n \n+  const imgProxyUrl = (href: string) =>\n+    generateProxyUrl(requestUrl, remoteUrl, href, 'img');\n+\n   modifyLinks(doc.querySelectorAll('a[href]'), 'href', parserUrl);\n   modifyLinks(doc.querySelectorAll('frame,iframe'), 'src', parserUrl);\n \n-  if (getConfig().proxy_res) {\n+  const config = getConfig();\n+\n+  if (config.proxy.enabled) {\n     modifyLinks(\n-      doc.querySelectorAll('img,image,video,audio,embed,track,source'),\n+      doc.querySelectorAll('video,audio,embed,track,source'),\n       'src',\n       proxyUrl\n     );\n \n+    modifyLinks(\n+      doc.querySelectorAll('img,image'),\n+      'src',\n+      config.proxy.img_compress ? imgProxyUrl : proxyUrl\n+    );\n+\n     modifyLinks(doc.getElementsByTagName('object'), 'data', proxyUrl);\n     const sources = doc.querySelectorAll('source,img');\n     for (const source of sources) {"
        },
        {
          "filename": "static/configuration.css",
          "status": "added",
          "additions": 26,
          "deletions": 0,
          "patch": "@@ -0,0 +1,26 @@\n+main {\n+  display: flex;\n+  flex-direction: column;\n+  align-items: start;\n+  gap: 0.375rem;\n+}\n+\n+h1 {\n+  width: fit-content;\n+  margin: auto;\n+}\n+\n+h1 > .dot {\n+  color: var(--accent);\n+}\n+\n+.menu {\n+  justify-content: center;\n+}\n+\n+.configuration {\n+  display: flex;\n+  flex-direction: column;\n+  align-items: start;\n+  gap: 0.375rem;\n+}"
        },
        {
          "filename": "templates/components/form-main.ejs",
          "status": "modified",
          "additions": 21,
          "deletions": 17,
          "patch": "@@ -1,26 +1,30 @@\n <% search = config.search.enabled %>\n \n-<% if (search) { %>\n+<% \n \n-  <input type=\"checkbox\" id=\"switch-search\" checked>\n+if (search) { \n+  %>\n+    <input type=\"checkbox\" id=\"switch-search\" checked>\n \n-  <label for=\"switch-search\" class=\"switch-label\">\n-    <span>URL</span>\n-    <span class=\"switch-btn\"></span>\n-    <span>Search</span>\n-  </label>\n+    <label for=\"switch-search\" class=\"switch-label\">\n+      <span>URL</span>\n+      <span class=\"switch-btn\"></span>\n+      <span>Search</span>\n+    </label>\n \n-  <form action=\"/redirect\" method=\"get\" class=\"input-grid main-form-search\">\n-    <div class=\"input\">\n-      <input type=\"text\" name=\"q\" id=\"search\" placeholder=\"Search\">\n-    </div>\n-    <div class=\"input\">\n-      <input type=\"submit\" id=\"submit\" class=\"button\" value=\"Go\">\n-    </div>\n-    <input type=\"hidden\" name=\"url\" value=\"<%= config.search.searx_url %>/search\"/>\n-  </form>\n+    <form action=\"/redirect\" method=\"get\" class=\"input-grid main-form-search\">\n+      <div class=\"input\">\n+        <input type=\"text\" name=\"q\" id=\"search\" placeholder=\"Search\">\n+      </div>\n+      <div class=\"input\">\n+        <input type=\"submit\" id=\"submit\" class=\"button\" value=\"Go\">\n+      </div>\n+      <input type=\"hidden\" name=\"url\" value=\"<%= config.search.searx_url %>/search\"/>\n+    </form>\n+  <% \n+}\n \n-<% } %>\n+%>\n \n <form action=\"/get\" method=\"get\" class=\"input-grid <%= search ? \"main-form-url\" : \"\" %>\">\n   <div class=\"input\">"
        },
        {
          "filename": "templates/configuration.ejs",
          "status": "added",
          "additions": 54,
          "deletions": 0,
          "patch": "@@ -0,0 +1,54 @@\n+<% \n+  \n+  // hide private properties from config \n+  const to_hide = [\"host\", \"port\"];\n+  function replacer(key,value) {\n+      if (to_hide.includes(key)) return undefined;\n+      else return value;\n+  }\n+  function to_pretty(obj) {\n+    return JSON.stringify(obj, replacer, 2).replace(/[\\[\\]{}\"]/g, \"\").replace(/,/g, \"\");\n+  }\n+%>\n+\n+<!DOCTYPE html>\n+<html>\n+  <head>\n+    <meta charset=\"utf-8\">\n+    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n+    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n+    <meta name=\"description\" content=\"<%= packageJSON.description %>\">\n+    <title>txt. configuration</title>\n+    <link rel=\"stylesheet\" href=\"/static/common.css\">\n+    <link rel=\"stylesheet\" href=\"/static/configuration.css\">\n+  </head>\n+  <body>\n+    <main>\n+      <header>\n+        <h1>txt<span class=\"dot\">.</span></h1>\n+        <div class=\"menu\">\n+          <a class=\"button secondary\" href=\"/\">Home</a>\n+        </div>\n+        <p><%= packageJSON.description %></p>\n+      </header>\n+      <div class=\"configuration\">\n+        <h2>Configuration</h2>\n+        <pre>  version: <%= packageJSON.version %><%= to_pretty(config) %></pre>\n+        <h2>Available engines</h2>\n+        <ol>\n+          <%\n+            for (const engine of engines) {\n+              %><li><%= engine.name %>: <%= engine.description %></li><%\n+            }\n+          %>\n+        </ol>\n+        <h2>Available routes</h2>\n+        <% \n+          for (const route of dynConfig.routes) {\n+            %><a class=\"button secondary\" href=\"<%= route %>\"><%= route %></a><%\n+          }\n+        %>\n+      </div>\n+    </main>\n+  </body>\n+</html>"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 10,
        "dependency_files": 1,
        "test_files": 0,
        "unique_directories": 14,
        "max_directory_depth": 4
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "3b8c65e576cc253b225da5a1d535f7465afc9b27",
            "date": "2024-11-19T09:32:23Z",
            "author_login": "artegoser"
          },
          {
            "sha": "dc7223243f8e8095b64c9a50fc38108901d2a2a2",
            "date": "2024-11-18T05:00:26Z",
            "author_login": "dependabot[bot]"
          },
          {
            "sha": "4b5b4fd87f767219632d0cc65a4e03666ebd1261",
            "date": "2024-10-28T17:43:35Z",
            "author_login": "artegoser"
          },
          {
            "sha": "d19d3160a849344f3dc76e83be150034b17ce66a",
            "date": "2024-10-28T04:35:15Z",
            "author_login": "dependabot[bot]"
          },
          {
            "sha": "997d24f61c0e6fd87d7eda5ed377c5b81b9c8038",
            "date": "2024-10-25T14:44:07Z",
            "author_login": "artegoser"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 7.5,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N",
    "cwe_id": "CWE-918",
    "description": "txtdot is an HTTP proxy that parses only text, links, and pictures from pages, removing ads and heavy scripts. Prior to version 1.7.0, a Server-Side Request Forgery (SSRF) vulnerability in the `/get` route of txtdot allows remote attackers to use the server as a proxy to send HTTP GET requests to arbitrary targets and retrieve information in the internal network. Version 1.7.0 prevents displaying the response of forged requests, but the requests can still be sent. For complete mitigation, a firewall between txtdot and other internal network resources should be set.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2024-07-26T17:15:12.783",
    "last_modified": "2024-11-21T09:33:07.407",
    "fix_date": "2024-03-07T11:49:54Z"
  },
  "references": [
    {
      "url": "https://github.com/TxtDot/txtdot/blob/a7fdaf80fdf45abefe83b2eb5135ba112142dc74/src/handlers/distributor.ts#L43-L47",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/TxtDot/txtdot/commit/7c72d985f7a26ec1fd3cf628444717ca54986d2d",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/TxtDot/txtdot/security/advisories/GHSA-4gj5-xj97-j8fp",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/TxtDot/txtdot/blob/a7fdaf80fdf45abefe83b2eb5135ba112142dc74/src/handlers/distributor.ts#L43-L47",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/TxtDot/txtdot/commit/7c72d985f7a26ec1fd3cf628444717ca54986d2d",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/TxtDot/txtdot/security/advisories/GHSA-4gj5-xj97-j8fp",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:08:34.480830",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "txtdot",
    "owner": "TxtDot",
    "created_at": "2023-08-13T17:38:48Z",
    "updated_at": "2025-01-05T18:45:55Z",
    "pushed_at": "2025-01-13T04:11:26Z",
    "size": 949,
    "stars": 164,
    "forks": 6,
    "open_issues": 11,
    "watchers": 164,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [
      "main"
    ],
    "languages": {
      "TypeScript": 46201,
      "EJS": 11164,
      "CSS": 4523,
      "Dockerfile": 1285,
      "Shell": 500
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-14T13:26:28.844868"
  }
}