{
  "cve_id": "CVE-2024-45048",
  "github_data": {
    "repository": "PHPOffice/PhpSpreadsheet",
    "fix_commit": "bea2d4b30f24bcc8a7712e208d1359e603b45dda",
    "related_commits": [
      "bea2d4b30f24bcc8a7712e208d1359e603b45dda"
    ],
    "patch_url": "https://github.com/PHPOffice/PhpSpreadsheet/commit/bea2d4b30f24bcc8a7712e208d1359e603b45dda.patch",
    "fix_commit_details": {
      "sha": "bea2d4b30f24bcc8a7712e208d1359e603b45dda",
      "commit_date": "2024-07-29T07:19:27Z",
      "author": {
        "login": "PowerKiKi",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Security: prevent XXE (XML External Entity) when loading files",
        "length": 465,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 34,
        "additions": 28,
        "deletions": 6
      },
      "files": [
        {
          "filename": "CHANGELOG.md",
          "status": "modified",
          "additions": 4,
          "deletions": 0,
          "patch": "@@ -7,6 +7,10 @@ and this project adheres to [Semantic Versioning](https://semver.org).\n \n ## TBD - 3.0.0\n \n+### Security Fix\n+\n+- Prevent XXE when loading files\n+\n ### Added\n \n - Nothing"
        },
        {
          "filename": "src/PhpSpreadsheet/Reader/Security/XmlScanner.php",
          "status": "modified",
          "additions": 18,
          "deletions": 6,
          "patch": "@@ -35,15 +35,11 @@ private static function forceString(mixed $arg): string\n \n     private function toUtf8(string $xml): string\n     {\n-        $pattern = '/encoding=\"(.*?)\"/';\n-        $result = preg_match($pattern, $xml, $matches);\n-        $charset = strtoupper($result ? $matches[1] : 'UTF-8');\n-\n+        $charset = $this->findCharSet($xml);\n         if ($charset !== 'UTF-8') {\n             $xml = self::forceString(mb_convert_encoding($xml, 'UTF-8', $charset));\n \n-            $result = preg_match($pattern, $xml, $matches);\n-            $charset = strtoupper($result ? $matches[1] : 'UTF-8');\n+            $charset = $this->findCharSet($xml);\n             if ($charset !== 'UTF-8') {\n                 throw new Reader\\Exception('Suspicious Double-encoded XML, spreadsheet file load() aborted to prevent XXE/XEE attacks');\n             }\n@@ -52,6 +48,22 @@ private function toUtf8(string $xml): string\n         return $xml;\n     }\n \n+    private function findCharSet(string $xml): string\n+    {\n+        $patterns = [\n+            '/encoding=\"([^\"]*]?)\"/',\n+            \"/encoding='([^']*?)'/\",\n+        ];\n+\n+        foreach ($patterns as $pattern) {\n+            if (preg_match($pattern, $xml, $matches)) {\n+                return strtoupper($matches[1]);\n+            }\n+        }\n+\n+        return 'UTF-8';\n+    }\n+\n     /**\n      * Scan the XML for use of <!ENTITY to prevent XXE/XEE attacks.\n      *"
        },
        {
          "filename": "tests/data/Reader/Xml/XEETestInvalidUTF-7-single-quote.xml",
          "status": "added",
          "additions": 2,
          "deletions": 0,
          "patch": "@@ -0,0 +1,2 @@\n+<?xml version=\"1.0\" encoding='UTF-7' standalone=\"yes\"?>\n+    +ADw-+ACE-DOCTYPE+ACA-foo+ACA-+AFs-+ADw-+ACE-ENTITY+ACA-toreplace+ACA-+ACI-xxe+AF8-test+ACI-+AD4-+ACA-+AF0-+AD4-+AAo-+ADw-sst+ACA-xmlns+AD0-+ACI-http://schemas.openxmlformats.org/spreadsheetml/2006/main+ACI-+ACA-count+AD0-+ACI-2+ACI-+ACA-uniqueCount+AD0-+ACI-1+ACI-+AD4-+ADw-si+AD4-+ADw-t+AD4-+ACY-toreplace+ADs-+ADw-/t+AD4-+ADw-/si+AD4-+ADw-/sst+AD4-"
        },
        {
          "filename": "tests/data/Reader/Xml/XEETestValidUTF-8-single-quote.xml",
          "status": "added",
          "additions": 4,
          "deletions": 0,
          "patch": "@@ -0,0 +1,4 @@\n+<?xml version='1.0' encoding='UTF-8' standalone='yes'?>\n+<root>\n+\ttest: Valid\n+</root>"
        }
      ],
      "file_patterns": {
        "security_files": 1,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 2,
        "unique_directories": 3,
        "max_directory_depth": 4
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "949c799c3538f3158bcf6c5f4d8a403027be0fbd",
            "date": "2025-01-12T03:48:58Z",
            "author_login": "oleibman"
          },
          {
            "sha": "4088381ccfaf241d7d42c333de0dc8c98e338743",
            "date": "2025-01-12T02:00:07Z",
            "author_login": "oleibman"
          },
          {
            "sha": "51b1d1c3a2d2aa71f18cec8e653ad812a4b13621",
            "date": "2025-01-09T20:39:46Z",
            "author_login": "oleibman"
          },
          {
            "sha": "bfcfaeea8ed27fa1a495d6752ec0ec640898c3d5",
            "date": "2025-01-08T23:04:47Z",
            "author_login": "oleibman"
          },
          {
            "sha": "f25502d704c25723793c4657540c81bbaea59918",
            "date": "2025-01-08T22:53:51Z",
            "author_login": "oleibman"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 8.8,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H",
    "cwe_id": "CWE-611",
    "description": "PHPSpreadsheet is a pure PHP library for reading and writing spreadsheet files. Affected versions are subject to a bypassing of a filter which allows for an XXE-attack. This in turn allows attacker to obtain contents of local files, even if error reporting is muted. This vulnerability has been addressed in release version 2.2.1. All users are advised to upgrade. There are no known workarounds for this vulnerability.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2024-08-28T21:15:06.817",
    "last_modified": "2024-09-04T17:27:31.517",
    "fix_date": "2024-07-29T07:19:27Z"
  },
  "references": [
    {
      "url": "https://github.com/PHPOffice/PhpSpreadsheet/commit/bea2d4b30f24bcc8a7712e208d1359e603b45dda",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/PHPOffice/PhpSpreadsheet/security/advisories/GHSA-ghg6-32f9-2jp7",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:08:37.409722",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "PhpSpreadsheet",
    "owner": "PHPOffice",
    "created_at": "2016-06-19T16:58:48Z",
    "updated_at": "2025-01-14T12:22:30Z",
    "pushed_at": "2025-01-12T04:07:04Z",
    "size": 69781,
    "stars": 13446,
    "forks": 3494,
    "open_issues": 186,
    "watchers": 13446,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "master"
    ],
    "languages": {
      "PHP": 8261868,
      "HTML": 7409,
      "Shell": 885
    },
    "commit_activity": {
      "total_commits_last_year": 423,
      "avg_commits_per_week": 8.134615384615385,
      "days_active_last_year": 191
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-14T13:13:00.605279"
  }
}