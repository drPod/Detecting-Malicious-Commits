{
  "cve_id": "CVE-2024-46898",
  "github_data": {
    "repository": "shirasagi/shirasagi",
    "fix_commit": "5ac4685d7e4330f949f13219069107fc5d768934",
    "related_commits": [
      "5ac4685d7e4330f949f13219069107fc5d768934"
    ],
    "patch_url": "https://github.com/shirasagi/shirasagi/commit/5ac4685d7e4330f949f13219069107fc5d768934.patch",
    "fix_commit_details": {
      "sha": "5ac4685d7e4330f949f13219069107fc5d768934",
      "commit_date": "2024-09-25T02:51:10Z",
      "author": {
        "login": "sunny4381",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "[fix] directory traversal possibility (#5427)",
        "length": 123,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 144,
        "additions": 85,
        "deletions": 59
      },
      "files": [
        {
          "filename": "app/controllers/application_controller.rb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -134,7 +134,7 @@ def request_host\n   end\n \n   def request_path\n-    request.env[\"REQUEST_PATH\"] || request.path\n+    @request_path ||= SS.request_path(request)\n   end\n \n   def protect_csrf?"
        },
        {
          "filename": "app/controllers/cms/form/columns_controller.rb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -153,7 +153,7 @@ def destroy_all\n     raise '403' unless @cur_form.allowed?(:delete, @cur_user, site: @cur_site, node: @cur_node)\n \n     if params[:destroy_all]\n-      render_destroy_all(destroy_items, location: request.path)\n+      render_destroy_all(destroy_items, location: SS.request_path(request))\n       return\n     end\n "
        },
        {
          "filename": "app/controllers/cms/search_contents/pages_controller.rb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -83,7 +83,7 @@ def destroy_all\n     raise \"400\" if @selected_items.blank?\n \n     if params[:destroy_all]\n-      render_confirmed_all(destroy_items, location: request.path)\n+      render_confirmed_all(destroy_items, location: SS.request_path(request))\n       return\n     end\n "
        },
        {
          "filename": "app/controllers/cms/users_controller.rb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -70,7 +70,7 @@ def destroy_all\n     raise \"400\" if @selected_items.blank?\n \n     if params[:destroy_all]\n-      render_destroy_all(disable_all, location: request.path)\n+      render_destroy_all(disable_all, location: SS.request_path(request))\n       return\n     end\n "
        },
        {
          "filename": "app/controllers/concerns/cms/crud_filter.rb",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -137,7 +137,7 @@ def destroy_all\n     raise \"400\" if @selected_items.blank?\n \n     if params[:destroy_all]\n-      render_confirmed_all(destroy_items, location: request.path)\n+      render_confirmed_all(destroy_items, location: SS.request_path(request))\n       return\n     end\n \n@@ -173,7 +173,7 @@ def change_state_all\n \n     @change_state = params[:state]\n     if params[:change_state_all]\n-      render_confirmed_all(change_items_state, location: request.path)\n+      render_confirmed_all(change_items_state, location: SS.request_path(request))\n       return\n     end\n "
        },
        {
          "filename": "app/controllers/concerns/cms/public_filter.rb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -71,7 +71,7 @@ def set_main_path\n \n   def redirect_slash\n     return unless request.get? || request.head?\n-    redirect_to \"#{request.path}/\"\n+    redirect_to \"#{SS.request_path(request)}/\"\n   end\n \n   def deny_path"
        },
        {
          "filename": "app/controllers/concerns/gws/base_filter.rb",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -60,7 +60,7 @@ def set_gws_logged_in\n     gws_session[@cur_site.id.to_s]['last_logged_in'] ||= begin\n       Gws::History.info!(\n         :controller, @cur_user, @cur_site,\n-        path: request.path, controller: self.class.name.underscore, action: action_name,\n+        path: SS.request_path(request), controller: self.class.name.underscore, action: action_name,\n         model: Gws::User.name.underscore, item_id: @cur_user.id, mode: 'login', name: @cur_user.name\n       ) rescue nil\n       Time.zone.now.to_i\n@@ -86,7 +86,7 @@ def rescue_action(exception)\n     if history_method\n       Gws::History.send(\n         history_method, :controller, @cur_user, @cur_site,\n-        path: request.path, controller: self.class.name.underscore, action: action_name,\n+        path: SS.request_path(request), controller: self.class.name.underscore, action: action_name,\n         message: \"#{exception.class} (#{exception.message})\"\n       ) rescue nil\n     end"
        },
        {
          "filename": "app/controllers/concerns/gws/column_filter2.rb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -93,7 +93,7 @@ def create\n     end\n \n     @frame_id = \"item-#{@item.id}\"\n-    locals = { ref: request.path, model: @model, item: @item, new_item: true }\n+    locals = { ref: SS.request_path(request), model: @model, item: @item, new_item: true }\n     render template: \"gws/frames/columns/edit\", locals: locals, layout: \"ss/item_frame\"\n   end\n "
        },
        {
          "filename": "app/controllers/concerns/ss/catch_all_filter.rb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -2,6 +2,6 @@ module SS::CatchAllFilter\n   extend ActiveSupport::Concern\n \n   def index\n-    raise ActionController::RoutingError, \"No route matches #{request.path}\"\n+    raise ActionController::RoutingError, \"No route matches #{SS.request_path(request)}\"\n   end\n end"
        },
        {
          "filename": "app/controllers/concerns/webmail/base_filter.rb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -43,7 +43,7 @@ def set_webmail_logged_in\n     webmail_session['last_logged_in'] ||= begin\n       Webmail::History.info!(\n         :controller, @cur_user,\n-        path: request.path, controller: self.class.name.underscore, action: action_name,\n+        path: SS.request_path(request), controller: self.class.name.underscore, action: action_name,\n         model: Webmail::User.name.underscore, item_id: @cur_user.id, mode: 'login', name: @cur_user.name\n       )\n       Time.zone.now.to_i"
        },
        {
          "filename": "app/controllers/gws/apis/columns_controller.rb",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -18,8 +18,8 @@ def cur_form\n \n   def ref\n     ret = params[:ref]\n-    return request.path if ret.blank?\n-    return request.path unless trusted_url?(ret)\n+    return SS.request_path(request) if ret.blank?\n+    return SS.request_path(request) unless trusted_url?(ret)\n     ret\n   end\n "
        },
        {
          "filename": "app/controllers/gws/workflow/columns2_controller.rb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -89,7 +89,7 @@ def create\n     end\n \n     @frame_id = \"item-#{@item.id}\"\n-    render template: \"gws/frames/columns/edit\", locals: { ref: request.path, model: @model, item: @item }, layout: \"ss/item_frame\"\n+    render template: \"gws/frames/columns/edit\", locals: { ref: SS.request_path(request), model: @model, item: @item }, layout: \"ss/item_frame\"\n   end\n \n   def reorder"
        },
        {
          "filename": "app/controllers/gws/workflow2/form/columns2_controller.rb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -89,7 +89,7 @@ def create\n     end\n \n     @frame_id = \"item-#{@item.id}\"\n-    render template: \"gws/frames/columns/edit\", locals: { ref: request.path, model: @model, item: @item }, layout: \"ss/item_frame\"\n+    render template: \"gws/frames/columns/edit\", locals: { ref: SS.request_path(request), model: @model, item: @item }, layout: \"ss/item_frame\"\n   end\n \n   def reorder"
        },
        {
          "filename": "app/controllers/uploader/files_controller.rb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -157,7 +157,7 @@ def file\n \n   def index\n     raise \"403\" unless @cur_node.allowed?(:read, @cur_user, site: @cur_site)\n-    return redirect_to(\"#{request.path}?do=show\") unless @item.directory?\n+    return redirect_to(\"#{SS.request_path(request)}?do=show\") unless @item.directory?\n     set_items(@item.path)\n     Uploader::File.set_sanitizer_state(@items, { site_id: @cur_site.id })\n     render :index"
        },
        {
          "filename": "app/models/cms/api_token.rb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -42,7 +42,7 @@ def authenticate(request, opts = {})\n       yield api_token.audience if block_given?\n \n       History::Log.create_log!(\n-        request, nil, controller: request.path, action: action,\n+        request, nil, controller: SS.request_path(request), action: action,\n         cur_site: site, cur_user: api_token.audience, item: api_token\n       ) rescue nil\n "
        },
        {
          "filename": "app/models/gws/history.rb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -133,7 +133,7 @@ def create_controller_log!(request, response, options)\n \n       write!(\n         severity, :controller, options[:cur_user], options[:cur_site],\n-        path: request.path, controller: options[:controller], action: options[:action]\n+        path: SS.request_path(request), controller: options[:controller], action: options[:action]\n       )\n     end\n "
        },
        {
          "filename": "app/models/history/log.rb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -67,7 +67,7 @@ def create_log!(request, _response, options)\n       log              = new\n       log.session_id   = request.session.id\n       log.request_id   = request.uuid\n-      log.url          = request.path\n+      log.url          = SS.request_path(request)\n       log.controller   = options[:controller]\n       log.action       = options[:action]\n       log.cur_user     = options[:cur_user]"
        },
        {
          "filename": "app/models/ss.rb",
          "status": "modified",
          "additions": 4,
          "deletions": 0,
          "patch": "@@ -91,4 +91,8 @@ def each_locale_in_order(&block)\n   def deprecator\n     @deprecator ||= ActiveSupport::Deprecation.new(SS.version, \"SHIRASAGI\")\n   end\n+\n+  def request_path(request)\n+    Addressable::URI.parse(request.env[\"REQUEST_PATH\"] || request.path).normalize.request_uri\n+  end\n end"
        },
        {
          "filename": "app/models/ss/oauth2/token_request/jwt_bearer.rb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -112,7 +112,7 @@ def validate_aud\n       return\n     end\n \n-    unless aud.path == @controller.request.path\n+    unless aud.path == SS.request_path(@controller.request)\n       respond_error :bad_request, \"invalid_aud\", \"malformed aud\"\n       return\n     end"
        },
        {
          "filename": "app/models/translate/access_log.rb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -27,7 +27,7 @@ class << self\n     def create_log!(site, request)\n       item = self.new\n       item.cur_site = site\n-      item.path = request.path\n+      item.path = SS.request_path(request)\n       item.user_agent = request.user_agent\n       item.remote_addr = request.remote_addr\n       item.referer = request.referer"
        },
        {
          "filename": "app/models/webmail/history.rb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -126,7 +126,7 @@ def create_controller_log!(request, response, options)\n \n       write!(\n         severity, :controller, options[:cur_user],\n-        path: request.path, controller: options[:controller], action: options[:action]\n+        path: SS.request_path(request), controller: options[:controller], action: options[:action]\n       )\n     end\n "
        },
        {
          "filename": "app/views/article/agents/nodes/map_search/_modal.html.erb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -7,7 +7,7 @@\n   });\n <% end %>\n \n-<%= form_tag request.path, multipart: true, method: \"get\", class: \"map-search-settings\" do %>\n+<%= form_tag SS.request_path(request), multipart: true, method: \"get\", class: \"map-search-settings\" do %>\n   <%= render \"settings\" %>\n   <footer class=\"send\">\n     <%= submit_tag t('facility.submit.search'), name: nil %>"
        },
        {
          "filename": "app/views/chorg/results/show.html.erb",
          "status": "modified",
          "additions": 6,
          "deletions": 3,
          "patch": "@@ -1,12 +1,15 @@\n-<% addons = @addons || @item.try(:addons) || [] %>\n+<%\n+  addons = @addons || @item.try(:addons) || []\n+  request_path = SS.request_path(request)\n+%>\n \n <div class=\"cms-tabs\">\n   <% path = url_for(controller: :run, action: :confirmation) %>\n-  <%= link_to(path, class: [ params[:type], request.path.start_with?(path) ? 'current' : nil ]) do %>\n+  <%= link_to(path, class: [ params[:type], request_path.start_with?(path) ? 'current' : nil ]) do %>\n     <span class=\"tab-name\">\u5b9f\u884c</span>\n   <% end %>\n   <% path = url_for(controller: :results, action: :show) %>\n-  <%= link_to(path, class: [ params[:type], request.path.start_with?(path) ? 'current' : nil ]) do %>\n+  <%= link_to(path, class: [ params[:type], request_path.start_with?(path) ? 'current' : nil ]) do %>\n     <span class=\"tab-name\">\u7d50\u679c</span>\n   <% end %>\n </div>"
        },
        {
          "filename": "app/views/chorg/run/confirmation.html.erb",
          "status": "modified",
          "additions": 3,
          "deletions": 2,
          "patch": "@@ -1,10 +1,11 @@\n <div class=\"cms-tabs\">\n+  <% request_path = SS.request_path(request) %>\n   <% path = url_for(controller: :run, action: :confirmation) %>\n-  <%= link_to(path, class: [ params[:type], request.path.start_with?(path) ? 'current' : nil ]) do %>\n+  <%= link_to(path, class: [ params[:type], request_path.start_with?(path) ? 'current' : nil ]) do %>\n       <span class=\"tab-name\">\u5b9f\u884c</span>\n   <% end %>\n   <% path = url_for(controller: :results, action: :show) %>\n-  <%= link_to(path, class: [ params[:type], request.path.start_with?(path) ? 'current' : nil ]) do %>\n+  <%= link_to(path, class: [ params[:type], request_path.start_with?(path) ? 'current' : nil ]) do %>\n       <span class=\"tab-name\">\u7d50\u679c</span>\n   <% end %>\n </div>"
        },
        {
          "filename": "app/views/cms/agents/addons/opendata_ref/resource/_show_edit.html.erb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -50,7 +50,7 @@\n </div>\n \n <%\n-  update_opendata_resources_path = request.path.dup\n+  update_opendata_resources_path = SS.request_path(request).dup\n   update_opendata_resources_path << \"/\" unless update_opendata_resources_path.end_with?(\"/\")\n   update_opendata_resources_path << \"update_opendata_resources.json\"\n %>"
        },
        {
          "filename": "app/views/cms/apis/preview/workflow/wizard/frame.html.erb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -2,7 +2,7 @@\n   var options = {};\n   options.request_url = SS_Preview.workflowPath.request;\n   if (!options.request_url) {\n-    options.request_url = \"<%= request.path %>\";\n+    options.request_url = \"<%= SS.request_path(request) %>\";\n   }\n   options.workflow_node = \"workflow\" + \"<%= @item.parent ? @item.parent.id : \"\" %>\";\n   options.user_id = <%= @cur_user.id %>;"
        },
        {
          "filename": "app/views/cms/preview/_tool.html.erb",
          "status": "modified",
          "additions": 3,
          "deletions": 2,
          "patch": "@@ -1,5 +1,6 @@\n <%\n   cms_form = nil\n+  request_path = SS.request_path(request)\n %>\n <% head_for(self) do %>\n   <%= stylesheet_link_tag(\"application\", media: \"all\") %>\n@@ -56,7 +57,7 @@\n     <% end %>\n     SS_Preview.mobile_path = <%== @cur_site.mobile_path.to_json %>;\n     <% if @preview_page %>\n-      SS_Preview.request_path = <%== request.path.to_json %>;\n+      SS_Preview.request_path = <%== request_path.to_json %>;\n       SS_Preview.form_item = <%== @preview_item.to_json %>;\n     <% end %>\n     <% if mode == :preview && rendered %>\n@@ -77,7 +78,7 @@\n \n       SS_Preview.workflowPath.wizard = <%== cms_apis_preview_workflow_wizard_path(site: @cur_site, preview_date: params[:preview_date], id: \":id\").to_json %>;\n       SS_Preview.workflowPath.pages = <%== \"/.s#{@cur_site.id}/workflow/pages/:id\".to_json %>;\n-      SS_Preview.workflowPath.request = <%== request.path.to_json %>;\n+      SS_Preview.workflowPath.request = <%== request_path.to_json %>;\n       SS_Preview.previewPath = <%== cms_preview_path(path: \":path\").to_json %>;\n       SS_Preview.redirectorPath.newPage = <%== new_page_cms_apis_preview_node_path(site: @cur_site, cid: \":nodeId\").to_json %>;\n "
        },
        {
          "filename": "app/views/gws/affair/main/_navi.html.erb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -1,6 +1,6 @@\n <%\n   def current_navi\n-    case request.path\n+    case SS.request_path(request)\n     when /affair\\/overtime\\/management\\/aggregate/\n       \"overtime-aggregate\"\n     when /working_time\\/management\\/aggregate/"
        },
        {
          "filename": "app/views/gws/agents/addons/affair/overtime_result/_show.html.erb",
          "status": "modified",
          "additions": 3,
          "deletions": 3,
          "patch": "@@ -157,13 +157,13 @@\n       <%= button_tag t(\"gws/affair.links.closed_results\"), disabled: \"disabled\" %>\n     <% else %>\n       <% if @item.allowed?(:edit, @cur_user, site: @cur_site) %>\n-        <%= link_to t(\"gws/affair.links.edit_results\"), edit_gws_affair_overtime_result_path(id: @item.id, ref: request.path), class: \"ajax-box\" %>\n+        <%= link_to t(\"gws/affair.links.edit_results\"), edit_gws_affair_overtime_result_path(id: @item.id, ref: SS.request_path(request)), class: \"ajax-box\" %>\n       <% end %>\n       <% if @item.result_closeable(@cur_user) %>\n-        <%= link_to t(\"gws/affair.links.close_results\"), close_gws_affair_overtime_result_path(id: @item.id, ref: request.path), method: :post, class: \"btn close-results\", data: { confirm: \"\u7d50\u679c\u3092\u78ba\u8a8d\u6e08\u307f\u306b\u3057\u3066\u3082\u3088\u308d\u3057\u3044\u3067\u3059\u304b\uff1f\" } %>\n+        <%= link_to t(\"gws/affair.links.close_results\"), close_gws_affair_overtime_result_path(id: @item.id, ref: SS.request_path(request)), method: :post, class: \"btn close-results\", data: { confirm: \"\u7d50\u679c\u3092\u78ba\u8a8d\u6e08\u307f\u306b\u3057\u3066\u3082\u3088\u308d\u3057\u3044\u3067\u3059\u304b\uff1f\" } %>\n       <% end %>\n     <% end %>\n   <% else %>\n-    <%= link_to t(\"gws/affair.links.set_results\"), edit_gws_affair_overtime_result_path(id: @item.id, ref: request.path), class: \"ajax-box\" %>\n+    <%= link_to t(\"gws/affair.links.set_results\"), edit_gws_affair_overtime_result_path(id: @item.id, ref: SS.request_path(request)), class: \"ajax-box\" %>\n   <% end %>\n </dl>"
        },
        {
          "filename": "app/views/gws/agents/addons/workflow2/approver/_show.html.erb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -1,5 +1,5 @@\n <% return unless @cur_form %>\n \n-<turbo-frame id=\"workflow-approver-frame\" src=\"<%= gws_workflow2_frames_approver_path(id: @item, ref: request.path) %>\">\n+<turbo-frame id=\"workflow-approver-frame\" src=\"<%= gws_workflow2_frames_approver_path(id: @item, ref: SS.request_path(request)) %>\">\n   <%= loading %>\n </turbo-frame>"
        },
        {
          "filename": "app/views/gws/agents/addons/workflow2/circulation/_show.html.erb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -16,5 +16,5 @@\n %>\n \n <turbo-frame id=\"workflow-circulation-frame\">\n-  <%= render template: \"gws/workflow2/frames/circulations/edit\", locals: local_assigns.merge(ref: request.path, workflow_circulation: workflow_circulation) %>\n+  <%= render template: \"gws/workflow2/frames/circulations/edit\", locals: local_assigns.merge(ref: SS.request_path(request), workflow_circulation: workflow_circulation) %>\n </turbo-frame>"
        },
        {
          "filename": "app/views/gws/agents/addons/workflow2/inspection/_show.html.erb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -11,5 +11,5 @@\n %>\n \n <turbo-frame id=\"workflow-inspection-frame\">\n-  <%= render template: \"gws/workflow2/frames/inspections/edit\", locals: local_assigns.merge(ref: request.path) %>\n+  <%= render template: \"gws/workflow2/frames/inspections/edit\", locals: local_assigns.merge(ref: SS.request_path(request)) %>\n </turbo-frame>"
        },
        {
          "filename": "app/views/gws/chorg/run/confirmation.html.erb",
          "status": "modified",
          "additions": 3,
          "deletions": 2,
          "patch": "@@ -1,10 +1,11 @@\n <div class=\"gws-tabs\">\n+  <% request_path = SS.request_path(request) %>\n   <% path = url_for(action: :confirmation) %>\n-  <%= link_to(path, class: [ params[:type], request.path.start_with?(path) ? 'current' : nil ]) do %>\n+  <%= link_to(path, class: [ params[:type], request_path.start_with?(path) ? 'current' : nil ]) do %>\n     <span class=\"tab-name\">\u5b9f\u884c</span>\n   <% end %>\n   <% path = url_for(controller: :results, action: :show) %>\n-  <%= link_to(path, class: [ params[:type], request.path.start_with?(path) ? 'current' : nil ]) do %>\n+  <%= link_to(path, class: [ params[:type], request_path.start_with?(path) ? 'current' : nil ]) do %>\n     <span class=\"tab-name\">\u7d50\u679c</span>\n   <% end %>\n </div>"
        },
        {
          "filename": "app/views/gws/columns2/index.html.erb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -37,7 +37,7 @@\n <%= ss_stimulus_tag({ \"gws/column/drag_drop\" => { reorder: url_for(action: :reorder) } }, class: \"gws-column-item-list\") do %>\n   <% items.each do |item| %>\n     <turbo-frame id=\"item-<%= item.id %>\">\n-      <%= render template: \"gws/frames/columns/show\", locals: { ref: request.path, model: item.class, item: item } %>\n+      <%= render template: \"gws/frames/columns/show\", locals: { ref: SS.request_path(request), model: item.class, item: item } %>\n     </turbo-frame>\n   <% end %>\n <% end %>"
        },
        {
          "filename": "app/views/gws/elasticsearch/search/main/_tabs.html.erb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -14,7 +14,7 @@ end\n     <% setting = \"Gws::Elasticsearch::Setting::#{type.classify}\".constantize.new(cur_site: @cur_site, cur_user: @cur_user) %>\n     <% if setting.search_types.present? %>\n       <% path = gws_elasticsearch_search_search_path(type: type) %>\n-      <%= link_to \"#{path}#{params}\", class: [ type, (::File.basename(request.path) == type) ? 'current' : nil ] do %>\n+      <%= link_to \"#{path}#{params}\", class: [ type, (::File.basename(SS.request_path(request)) == type) ? 'current' : nil ] do %>\n         <span class=\"tab-name\"><%= setting.menu_label %></span>\n       <% end %>\n     <% end %>"
        },
        {
          "filename": "app/views/gws/schedule/todo/main/_category_navi.html.erb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -4,7 +4,7 @@\n   <% render_tree_item = proc do |cate| %>\n     <% url = url_for(category: cate.id) %>\n     <% css_class = %w(tree-item is-open) %>\n-    <% css_class << \"is-current\" if request.path.start_with?(url) %>\n+    <% css_class << \"is-current\" if SS.request_path(request).start_with?(url) %>\n     <%= content_tag(\"div\", class: css_class, data: { id: cate.id, filename: cate.name }) do %>\n       <%= link_to cate.trailing_name, url, class: \"item-name\" %>\n     <% end %>"
        },
        {
          "filename": "app/views/gws/workload/graphs/index.html.erb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -8,7 +8,7 @@\n       <% render_tree_item = proc do |cate| %>\n         <% url = url_for(action: :index, category: cate.id) %>\n         <% css_class = %w(tree-item is-open) %>\n-        <% css_class << \"is-current\" if request.path.start_with?(url) %>\n+        <% css_class << \"is-current\" if SS.request_path(request).start_with?(url) %>\n         <%= content_tag(\"div\", class: css_class, data: { id: cate.id, filename: cate.id }) do %>\n           <%= link_to cate.name, url, class: \"item-name\" %>\n         <% end %>"
        },
        {
          "filename": "app/views/history/agents/addons/backup/_show.html.erb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -1,6 +1,6 @@\n <%\n   return render(plain: \"\") if @item.backups.size == 0\n-  source = ERB::Util.url_encode(request.path)\n+  source = ERB::Util.url_encode(SS.request_path(request))\n   top_backups = @item.backups.limit(History.max_histories).to_a\n %>\n <dl class=\"see\">"
        },
        {
          "filename": "app/views/opendata/agents/nodes/dataset/resource/graph/bar_content.html.erb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -32,7 +32,7 @@ graph.render(\"bar\", name, labels, datasets);\n var types = <%== @item.preview_graph_types.to_json %>;\n var headers = <%== graph.headers.to_json %>;\n graph.renderController(types, headers, function(type) {\n-  var url = \"<%= request.path %>\";\n+  var url = \"<%= SS.request_path(request) %>\";\n   url += \"?type=\" + type + \"&graph=1\";\n \n   graph.destroy();"
        },
        {
          "filename": "app/views/opendata/agents/nodes/dataset/resource/graph/line_content.html.erb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -32,7 +32,7 @@ graph.render(\"line\", name, labels, datasets);\n var types = <%== @item.preview_graph_types.to_json %>;\n var headers = <%== graph.headers.to_json %>;\n graph.renderController(types, headers, function(type) {\n-  var url = \"<%= request.path %>\";\n+  var url = \"<%= SS.request_path(request) %>\";\n   url += \"?type=\" + type + \"&graph=1\";\n \n   graph.destroy();"
        },
        {
          "filename": "app/views/opendata/agents/nodes/dataset/resource/graph/pie_content.html.erb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -35,7 +35,7 @@ graph.render(\"pie\", name, labels, datasets, { headerIndex: <%== @header_index.to\n var types = <%== @item.preview_graph_types.to_json %>;\n var headers = <%== @headers.to_json %>;\n graph.renderController(types, headers, function(type, headerIndex) {\n-  var url = \"<%= request.path %>\";\n+  var url = \"<%= SS.request_path(request) %>\";\n   url += \"?type=\" + type + \"&graph=1&headerIndex=\" + headerIndex;\n \n   graph.destroy();"
        },
        {
          "filename": "app/views/opendata/dataset/resource_report_main/index.html.erb",
          "status": "modified",
          "additions": 5,
          "deletions": 4,
          "patch": "@@ -1,18 +1,19 @@\n <div class=\"cms-tabs\">\n+  <% request_path = SS.request_path(request) %>\n   <% if Opendata::ResourceDownloadReport.allowed?(:read, @cur_user, site: @cur_site, node: @cur_node) %>\n-    <% css_classes = request.path.start_with?(opendata_dataset_report_downloads_path) ? %w(current) : nil %>\n+    <% css_classes = request_path.start_with?(opendata_dataset_report_downloads_path) ? %w(current) : nil %>\n     <%= link_to opendata_dataset_report_downloads_path, class: css_classes do %>\n       <span class=\"tab-name\"><%= t(\"opendata.reports.download_reports\") %></span>\n     <% end %>\n   <% end %>\n   <% if Opendata::DatasetAccessReport.allowed?(:read, @cur_user, site: @cur_site, node: @cur_node) %>\n-    <% css_classes = request.path.start_with?(opendata_dataset_report_accesses_path) ? %w(current) : nil %>\n+    <% css_classes = request_path.start_with?(opendata_dataset_report_accesses_path) ? %w(current) : nil %>\n     <%= link_to opendata_dataset_report_accesses_path, class: css_classes do %>\n       <span class=\"tab-name\"><%= t(\"opendata.reports.access_reports\") %></span>\n     <% end %>\n   <% end %>\n   <% if Opendata::ResourcePreviewReport.allowed?(:read, @cur_user, site: @cur_site, node: @cur_node) %>\n-    <% css_classes = request.path.start_with?(opendata_dataset_report_previews_path) ? %w(current) : nil %>\n+    <% css_classes = request_path.start_with?(opendata_dataset_report_previews_path) ? %w(current) : nil %>\n     <%= link_to opendata_dataset_report_previews_path, class: css_classes do %>\n       <span class=\"tab-name\"><%= t(\"opendata.reports.preview_reports\") %></span>\n     <% end %>\n@@ -60,7 +61,7 @@\n   <% end %>\n </div>\n \n-<% if request.path.start_with?(opendata_dataset_report_downloads_path) %>\n+<% if request_path.start_with?(opendata_dataset_report_downloads_path) %>\n   <div class=\"main-box\">\n     <div class=\"markdown-body\">\n       <%= SS::Addon::Markdown.text_to_html(t(\"opendata.notice.download_report_notice_md\")) %>"
        },
        {
          "filename": "app/views/sns/login/_notices.html.erb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -9,7 +9,7 @@\n     <li class=\"list-item\">\n       <div class=\"info\">\n         <%= link_to item.name,\n-              sns_public_notice_path(id: item, login_path: request.path),\n+              sns_public_notice_path(id: item, login_path: SS.request_path(request)),\n               class: \"title notice-severity-#{item.notice_severity}\" %>\n         <span class=\"datetime\"><%= ss_time_tag item.released %></span>\n       </div>"
        },
        {
          "filename": "app/views/sns/login/login.html.erb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -49,7 +49,7 @@\n         <% ssos.each do |sso| %>\n           <% sso = sso.becomes_with_model %>\n           <li class=\"<%= sso.filename %>\">\n-            <%= link_to(sso.url(ref: params[:ref].try { |ref| ref.to_s } || default_logged_in_path, login_path: request.path), class: \"btn-default\") do %>\n+            <%= link_to(sso.url(ref: params[:ref].try { |ref| ref.to_s } || default_logged_in_path, login_path: SS.request_path(request)), class: \"btn-default\") do %>\n               <h2 class=\"name\"><%= sso.name %></h2>\n               <p class=\"text\"><%= br sso.text %></p>\n             <% end %>"
        },
        {
          "filename": "app/views/sys/db/colls/index.html.erb",
          "status": "modified",
          "additions": 3,
          "deletions": 2,
          "patch": "@@ -1,10 +1,11 @@\n <div class=\"cms-tabs\">\n+  <% request_path = SS.request_path(request) %>\n   <% path = url_for(action: :index) %>\n-  <%= link_to(path, class: [ params[:type], request.path.start_with?(path) ? 'current' : nil ]) do %>\n+  <%= link_to(path, class: [ params[:type], request_path.start_with?(path) ? 'current' : nil ]) do %>\n     <span class=\"tab-name\">Collections</span>\n   <% end %>\n   <% path = url_for(action: :info) %>\n-  <%= link_to(path, class: [ params[:type], request.path.start_with?(path) ? 'current' : nil ]) do %>\n+  <%= link_to(path, class: [ params[:type], request_path.start_with?(path) ? 'current' : nil ]) do %>\n     <span class=\"tab-name\">Server</span>\n   <% end %>\n </div>"
        },
        {
          "filename": "app/views/workflow/agents/addons/approver/_show.html.erb",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -1,6 +1,6 @@\n <%= jquery do %>\n   var options = {};\n-  options.request_url = \"<%= request.path %>\";\n+  options.request_url = \"<%= SS.request_path(request) %>\";\n   options.workflow_node = \"workflow\" + \"<%= @cur_node? @cur_node.id : \"\" %>\";\n   options.user_id = <%= @cur_user.id %>;\n   options.errors = {};"
        },
        {
          "filename": "spec/requests/cms/public_controller_spec.rb",
          "status": "added",
          "additions": 14,
          "deletions": 0,
          "patch": "@@ -0,0 +1,14 @@\n+require 'spec_helper'\n+\n+describe Cms::PublicController, type: :request, dbscope: :example do\n+  let!(:site) { cms_site }\n+\n+  it do\n+    components = %w(docs)\n+    components += Array.new(site.path.count(\"/\") + 1) { \"..\" }\n+    components << Rails.root.to_s\n+    components << \"README.md\"\n+    path = File.join(*components)\n+    expect { get \"#{site.full_url}#{path}\" }.to raise_error RuntimeError\n+  end\n+end"
        }
      ],
      "file_patterns": {
        "security_files": 1,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 42,
        "max_directory_depth": 8
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "eed9fe3f40a5e48b43d46446cf3e6fc81b33da47",
            "date": "2025-01-09T09:54:20Z",
            "author_login": "itowtips"
          },
          {
            "sha": "3a463634686d8d4cb76b16b078fc862430500736",
            "date": "2025-01-09T05:27:14Z",
            "author_login": "se1987"
          },
          {
            "sha": "8ae5c5c51619b995585074ffc5a1b3979cf750c0",
            "date": "2025-01-09T00:57:40Z",
            "author_login": "itowtips"
          },
          {
            "sha": "0827da20521bcca5a2b05c9e72bb2a02c2d79ecc",
            "date": "2025-01-08T05:10:30Z",
            "author_login": "sunny4381"
          },
          {
            "sha": "2a99789c43bd9d3e85e357bd15314cd846c37c1c",
            "date": "2025-01-08T01:23:57Z",
            "author_login": "sunny4381"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 7.5,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N",
    "cwe_id": "CWE-22",
    "description": "SHIRASAGI prior to v1.19.1 processes URLs in HTTP requests improperly, resulting in a path traversal vulnerability. If this vulnerability is exploited, arbitrary files on the server may be retrieved when processing crafted HTTP requests.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2024-10-15T07:15:02.267",
    "last_modified": "2024-10-17T17:52:00.700",
    "fix_date": "2024-09-25T02:51:10Z"
  },
  "references": [
    {
      "url": "https://github.com/shirasagi/shirasagi/commit/5ac4685d7e4330f949f13219069107fc5d768934",
      "source": "vultures@jpcert.or.jp",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://jvn.jp/en/jp/JVN58721679/",
      "source": "vultures@jpcert.or.jp",
      "tags": [
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://www.ss-proj.org/",
      "source": "vultures@jpcert.or.jp",
      "tags": [
        "Product"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:09:02.146511",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "shirasagi",
    "owner": "shirasagi",
    "created_at": "2014-05-02T07:29:32Z",
    "updated_at": "2025-01-09T09:54:25Z",
    "pushed_at": "2025-01-14T10:53:00Z",
    "size": 142651,
    "stars": 110,
    "forks": 74,
    "open_issues": 475,
    "watchers": 110,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "Ruby": 16647574,
      "JavaScript": 16275682,
      "HTML": 4331653,
      "Fluent": 1483580,
      "CSS": 1110680,
      "SCSS": 840887,
      "Shell": 27583
    },
    "commit_activity": {
      "total_commits_last_year": 354,
      "avg_commits_per_week": 6.8076923076923075,
      "days_active_last_year": 101
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-14T12:59:52.685200"
  }
}