{
  "cve_id": "CVE-2024-48914",
  "github_data": {
    "repository": "vendure-ecommerce/vendure",
    "fix_commit": "e2ee0c43159b3d13b51b78654481094fdd4850c5",
    "related_commits": [
      "e2ee0c43159b3d13b51b78654481094fdd4850c5",
      "e4b58af6822d38a9c92a1d8573e19288b8edaa1c"
    ],
    "patch_url": "https://github.com/vendure-ecommerce/vendure/commit/e2ee0c43159b3d13b51b78654481094fdd4850c5.patch",
    "fix_commit_details": {
      "sha": "e2ee0c43159b3d13b51b78654481094fdd4850c5",
      "commit_date": "2024-10-15T08:54:31Z",
      "author": {
        "login": "michaelbromley",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Merge commit from fork",
        "length": 341,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 60,
        "additions": 54,
        "deletions": 6
      },
      "files": [
        {
          "filename": "packages/asset-server-plugin/e2e/asset-server-plugin.e2e-spec.ts",
          "status": "modified",
          "additions": 38,
          "deletions": 2,
          "patch": "@@ -1,7 +1,8 @@\n /* eslint-disable @typescript-eslint/no-non-null-assertion */\n-import { mergeConfig } from '@vendure/core';\n+import { ConfigService, mergeConfig } from '@vendure/core';\n import { AssetFragment } from '@vendure/core/e2e/graphql/generated-e2e-admin-types';\n import { createTestEnvironment } from '@vendure/testing';\n+import { exec } from 'child_process';\n import fs from 'fs-extra';\n import gql from 'graphql-tag';\n import fetch from 'node-fetch';\n@@ -193,6 +194,41 @@ describe('AssetServerPlugin', () => {\n         it('does not error on non-integer height', async () => {\n             return fetch(`${asset.preview}?h=10.5`);\n         });\n+\n+        // https://github.com/vendure-ecommerce/vendure/security/advisories/GHSA-r9mq-3c9r-fmjq\n+        describe('path traversal', () => {\n+            function curlWithPathAsIs(url: string) {\n+                return new Promise<string>((resolve, reject) => {\n+                    // We use curl here rather than node-fetch or any other fetch-type function because\n+                    // those will automatically perform path normalization which will mask the path traversal\n+                    return exec(`curl --path-as-is ${url}`, (err, stdout, stderr) => {\n+                        if (err) {\n+                            reject(err);\n+                        }\n+                        resolve(stdout);\n+                    });\n+                });\n+            }\n+\n+            function testPathTraversalOnUrl(urlPath: string) {\n+                return async () => {\n+                    const port = server.app.get(ConfigService).apiOptions.port;\n+                    const result = await curlWithPathAsIs(`http://localhost:${port}/assets${urlPath}`);\n+                    expect(result).not.toContain('@vendure/asset-server-plugin');\n+                    expect(result.toLowerCase()).toContain('resource not found');\n+                };\n+            }\n+\n+            it('blocks path traversal 1', testPathTraversalOnUrl(`/../../package.json`));\n+            it('blocks path traversal 2', testPathTraversalOnUrl(`/foo/../../../package.json`));\n+            it('blocks path traversal 3', testPathTraversalOnUrl(`/foo/../../../foo/../package.json`));\n+            it('blocks path traversal 4', testPathTraversalOnUrl(`/%2F..%2F..%2Fpackage.json`));\n+            it('blocks path traversal 5', testPathTraversalOnUrl(`/%2E%2E/%2E%2E/package.json`));\n+            it('blocks path traversal 6', testPathTraversalOnUrl(`/..//..//package.json`));\n+            it('blocks path traversal 7', testPathTraversalOnUrl(`/.%2F.%2F.%2Fpackage.json`));\n+            it('blocks path traversal 8', testPathTraversalOnUrl(`/..\\\\\\\\..\\\\\\\\package.json`));\n+            it('blocks path traversal 9', testPathTraversalOnUrl(`/\\\\\\\\\\\\..\\\\\\\\\\\\..\\\\\\\\\\\\package.json`));\n+        });\n     });\n \n     describe('deletion', () => {\n@@ -268,7 +304,7 @@ describe('AssetServerPlugin', () => {\n     // https://github.com/vendure-ecommerce/vendure/issues/1563\n     it('falls back to binary preview if image file cannot be processed', async () => {\n         const filesToUpload = [path.join(__dirname, 'fixtures/assets/bad-image.jpg')];\n-        const { createAssets }: CreateAssets.Mutation = await adminClient.fileUploadMutation({\n+        const { createAssets }: CreateAssetsMutation = await adminClient.fileUploadMutation({\n             mutation: CREATE_ASSETS,\n             filePaths: filesToUpload,\n             mapVariables: filePaths => ({"
        },
        {
          "filename": "packages/asset-server-plugin/src/plugin.ts",
          "status": "modified",
          "additions": 16,
          "deletions": 4,
          "patch": "@@ -281,7 +281,7 @@ export class AssetServerPlugin implements NestModule, OnApplicationBootstrap {\n         return async (err: any, req: Request, res: Response, next: NextFunction) => {\n             if (err && (err.status === 404 || err.statusCode === 404)) {\n                 if (req.query) {\n-                    const decodedReqPath = decodeURIComponent(req.path);\n+                    const decodedReqPath = this.sanitizeFilePath(req.path);\n                     Logger.debug(`Pre-cached Asset not found: ${decodedReqPath}`, loggerCtx);\n                     let file: Buffer;\n                     try {\n@@ -347,9 +347,7 @@ export class AssetServerPlugin implements NestModule, OnApplicationBootstrap {\n             imageParamsString += quality;\n         }\n \n-        /* eslint-enable @typescript-eslint/restrict-template-expressions */\n-\n-        const decodedReqPath = decodeURIComponent(req.path);\n+        const decodedReqPath = this.sanitizeFilePath(req.path);\n         if (imageParamsString !== '') {\n             const imageParamHash = this.md5(imageParamsString);\n             return path.join(this.cacheDir, this.addSuffix(decodedReqPath, imageParamHash, imageFormat));\n@@ -358,6 +356,20 @@ export class AssetServerPlugin implements NestModule, OnApplicationBootstrap {\n         }\n     }\n \n+    /**\n+     * Sanitize the file path to prevent directory traversal attacks.\n+     */\n+    private sanitizeFilePath(filePath: string): string {\n+        let decodedPath: string;\n+        try {\n+            decodedPath = decodeURIComponent(filePath);\n+        } catch (e: any) {\n+            Logger.error((e.message as string) + ': ' + filePath, loggerCtx);\n+            return '';\n+        }\n+        return path.normalize(decodedPath).replace(/(\\.\\.[\\/\\\\])+/, '');\n+    }\n+\n     private md5(input: string): string {\n         return createHash('md5').update(input).digest('hex');\n     }"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 2,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "fd6a9fd4a27fe5d422f3abc53bdbea1dc1a94994",
            "date": "2025-01-14T07:50:23Z",
            "author_login": "dlhck"
          },
          {
            "sha": "889dd72d1b3032e12017cdb24fd57d3113ff6a99",
            "date": "2025-01-10T20:50:38Z",
            "author_login": "github-actions[bot]"
          },
          {
            "sha": "4349ef8e1dcae341d932a3a6623431179db075ac",
            "date": "2025-01-09T09:27:28Z",
            "author_login": "HerclasNido"
          },
          {
            "sha": "9bb155bb551c44407d0363947e9967d6cb19a15f",
            "date": "2025-01-09T09:19:35Z",
            "author_login": "Winne4r"
          },
          {
            "sha": "779ebd23b57e75886bc0eab16825897a2347db0f",
            "date": "2025-01-09T09:16:10Z",
            "author_login": "oidt"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 9.1,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:H",
    "cwe_id": "CWE-20",
    "description": "Vendure is an open-source headless commerce platform. Prior to versions 3.0.5 and 2.3.3, a vulnerability in Vendure's asset server plugin allows an attacker to craft a request which is able to traverse the server file system and retrieve the contents of arbitrary files, including sensitive data such as configuration files, environment variables, and other critical data stored on the server. In the same code path is an additional vector for crashing the server via a malformed URI. Patches are available in versions 3.0.5 and 2.3.3. Some workarounds are also available. One may use object storage rather than the local file system, e.g. MinIO or S3, or define middleware which detects and blocks requests with urls containing `/../`.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2024-10-15T16:15:06.270",
    "last_modified": "2024-10-16T16:38:43.170",
    "fix_date": "2024-10-15T08:54:31Z"
  },
  "references": [
    {
      "url": "https://github.com/vendure-ecommerce/vendure/blob/801980e8f599c28c5059657a9d85dd03e3827992/packages/asset-server-plugin/src/plugin.ts#L352-L358",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/vendure-ecommerce/vendure/commit/e2ee0c43159b3d13b51b78654481094fdd4850c5",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/vendure-ecommerce/vendure/commit/e4b58af6822d38a9c92a1d8573e19288b8edaa1c",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/vendure-ecommerce/vendure/security/advisories/GHSA-r9mq-3c9r-fmjq",
      "source": "security-advisories@github.com",
      "tags": []
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:09:02.149914",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "vendure",
    "owner": "vendure-ecommerce",
    "created_at": "2018-06-11T14:29:20Z",
    "updated_at": "2025-01-14T12:10:58Z",
    "pushed_at": "2025-01-14T07:50:24Z",
    "size": 65565,
    "stars": 5914,
    "forks": 1052,
    "open_issues": 394,
    "watchers": 5914,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "major",
      "minor"
    ],
    "languages": {
      "TypeScript": 14135610,
      "HTML": 626937,
      "SCSS": 201498,
      "JavaScript": 42179,
      "Handlebars": 19494,
      "Shell": 1233
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T16:47:07.809476"
  }
}