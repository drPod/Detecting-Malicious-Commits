{
  "cve_id": "CVE-2024-50348",
  "github_data": {
    "repository": "instantsoft/icms2",
    "fix_commit": "e02de2fa1850bb40c9b2050b9256c838a0ea7aa3",
    "related_commits": [
      "e02de2fa1850bb40c9b2050b9256c838a0ea7aa3"
    ],
    "patch_url": "https://github.com/instantsoft/icms2/commit/e02de2fa1850bb40c9b2050b9256c838a0ea7aa3.patch",
    "fix_commit_details": {
      "sha": "e02de2fa1850bb40c9b2050b9256c838a0ea7aa3",
      "commit_date": "2024-10-29T21:57:15Z",
      "author": {
        "login": "fuzegit",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "GHSA-f6cf-jg84-fw29",
        "length": 19,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 160,
        "additions": 82,
        "deletions": 78
      },
      "files": [
        {
          "filename": "system/controllers/photos/actions/camera.php",
          "status": "modified",
          "additions": 18,
          "deletions": 14,
          "patch": "@@ -1,11 +1,13 @@\n <?php\n \n-class actionPhotosCamera extends cmsAction{\n+class actionPhotosCamera extends cmsAction {\n \n-    public function run(){\n+    public function run() {\n \n-        $camera = urldecode($this->request->get('name', ''));\n-        if(!$camera){ cmsCore::error404(); }\n+        $camera = trim(strip_tags(urldecode($this->request->get('name', ''))));\n+        if (!$camera) {\n+            return cmsCore::error404();\n+        }\n \n         if (cmsUser::isAllowed('albums', 'view_all')) {\n             $this->model->disablePrivacyFilter();\n@@ -21,36 +23,38 @@ public function run(){\n         $this->model->orderBy($this->options['ordering'], $this->options['orderto']);\n \n         $photos = $this->getPhotosList();\n-        if (!$photos) { cmsCore::error404(); }\n+        if (!$photos) {\n+            return cmsCore::error404();\n+        }\n \n-        if($photos && (count($photos) > $perpage)){\n-            $has_next = true; array_pop($photos);\n+        if ($photos && (count($photos) > $perpage)) {\n+            $has_next = true;\n+            array_pop($photos);\n         } else {\n             $has_next = false;\n         }\n \n         $ctype = cmsCore::getModel('content')->getContentTypeByName('albums');\n \n-        $this->cms_template->render('camera', array(\n+        $this->cms_template->render([\n             'page_title'   => sprintf(LANG_PHOTOS_CAMERA_TITLE, $camera),\n             'ctype'        => $ctype,\n             'page'         => $page,\n             'row_height'   => $this->getRowHeight(),\n             'user'         => $this->cms_user,\n-            'item'         => array(\n+            'item'         => [\n                 'id'         => 0,\n                 'user_id'    => 0,\n-                'url_params' => array('camera' => $camera),\n+                'url_params' => ['camera' => $camera],\n                 'base_url'   => href_to('photos', 'camera-' . urlencode($camera))\n-            ),\n-            'item_type' => 'camera',\n+            ],\n+            'item_type'    => 'camera',\n             'photos'       => $photos,\n             'is_owner'     => cmsUser::isAllowed('albums', 'delete', 'all'),\n             'has_next'     => $has_next,\n             'hooks_html'   => cmsEventsManager::hookAll('photo_camera_html', $camera),\n             'preset_small' => $this->options['preset_small']\n-        ));\n-\n+        ]);\n     }\n \n }"
        },
        {
          "filename": "system/libs/files.helper.php",
          "status": "modified",
          "additions": 55,
          "deletions": 55,
          "patch": "@@ -482,85 +482,85 @@ function img_get_params($path) {\n         return false;\n     }\n \n+    // \u041f\u043e\u043b\u0443\u0447\u0430\u0435\u043c \u0431\u0430\u0437\u043e\u0432\u0443\u044e \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u044e \u043e\u0431 \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u0438\n     $s = getimagesize($path);\n     if ($s === false) {\n         return false;\n     }\n \n     $exif_data = [];\n-\n-    $exif = (function_exists('exif_read_data') && $s['mime'] === 'image/jpeg') ? (@exif_read_data($path, null, true)) : null;\n-\n-    if ($exif) {\n-        if (isset($exif['COMPUTED']['ApertureFNumber'])) {\n-            $exif_data['aperturefnumber'] = $exif['COMPUTED']['ApertureFNumber'];\n-        } elseif (isset($exif['EXIF']['FNumber'])) {\n-            $num = explode('/', $exif['EXIF']['FNumber']);\n-            $exif_data['aperturefnumber'] = 'f/' . ($num[0] / $num[1]);\n-        }\n-        if (isset($exif['EXIF']['ExposureTime'])) {\n-            $num = explode('/', $exif['EXIF']['ExposureTime']);\n-            $exif_data['exposuretime'] = ($num[0] == 1) ? $exif['EXIF']['ExposureTime'] : '1/' . round($num[1] / $num[0]) . 's';\n-        } elseif (isset($exif['IFD0']['ExposureTime'])) {\n-            $exif_data['exposuretime'] = $exif['IFD0']['ExposureTime'];\n-        }\n-        $make = false;\n-        if (isset($exif['IFD0']['Make'])) {\n-            $exif['IFD0']['Make'] = trim($exif['IFD0']['Make']);\n-            if ($exif['IFD0']['Make'] != 'NIKON CORPORATION' && $exif['IFD0']['Make'] != 'Canon' && $exif['IFD0']['Make'] != 'Lenovo ') {\n-                $exif_data['camera'] = $exif['IFD0']['Make'];\n-                $make = true;\n+    // \u041f\u043e\u043b\u0443\u0447\u0430\u0435\u043c EXIF-\u0434\u0430\u043d\u043d\u044b\u0435, \u0435\u0441\u043b\u0438 \u044d\u0442\u043e JPEG\n+    if (function_exists('exif_read_data') && $s['mime'] === 'image/jpeg') {\n+\n+        $exif = @exif_read_data($path, null, true);\n+\n+        if ($exif) {\n+            // \u0414\u0438\u0430\u0444\u0440\u0430\u0433\u043c\u0430\n+            $exif_data['aperturefnumber'] = $exif['COMPUTED']['ApertureFNumber'] ??\n+                (isset($exif['EXIF']['FNumber']) ? 'f/' . eval_fraction($exif['EXIF']['FNumber']) : null);\n+\n+            // \u0412\u044b\u0434\u0435\u0440\u0436\u043a\u0430\n+            $exif_data['exposuretime'] = $exif['EXIF']['ExposureTime'] ??\n+                (isset($exif['EXIF']['ExposureTime']) ? '1/' . round(eval_fraction($exif['EXIF']['ExposureTime'])) . 's' : null);\n+\n+            // \u041a\u0430\u043c\u0435\u0440\u0430\n+            $make = isset($exif['IFD0']['Make']) ? trim($exif['IFD0']['Make']) : null;\n+            $model = $exif['IFD0']['Model'] ?? null;\n+            if ($make && !in_array($make, ['NIKON CORPORATION', 'Canon', 'Lenovo'])) {\n+                $exif_data['camera'] = $model ? \"$make $model\" : $make;\n+            } elseif ($model) {\n+                $exif_data['camera'] = $model;\n             }\n-        }\n-        if (isset($exif['IFD0']['Model'])) {\n-            $exif_data['camera'] = $make ? $exif['IFD0']['Make'] . ' ' . $exif['IFD0']['Model'] : $exif['IFD0']['Model'];\n-        }\n \n-        if (isset($exif['EXIF']['DateTimeOriginal'])) {\n-            $exif_data['date'] = $exif['EXIF']['DateTimeOriginal'];\n-        } elseif (isset($exif['EXIF']['DateTimeDigitized'])) {\n-            $exif_data['date'] = $exif['EXIF']['DateTimeDigitized'];\n-        }\n+            // \u0414\u0430\u0442\u0430 \u0441\u043e\u0437\u0434\u0430\u043d\u0438\u044f\n+            $exif_data['date'] = $exif['EXIF']['DateTimeOriginal'] ?? $exif['EXIF']['DateTimeDigitized'] ?? null;\n \n-        if (isset($exif['EXIF']['ISOSpeedRatings'])) {\n-            $exif_data['isospeedratings'] = $exif['EXIF']['ISOSpeedRatings'];\n-            if (is_array($exif_data['isospeedratings'])) {\n-                $exif_data['isospeedratings'] = current($exif_data['isospeedratings']);\n-            }\n-        }\n+            // ISO\n+            $iso = $exif['EXIF']['ISOSpeedRatings'] ?? null;\n+            $exif_data['isospeedratings'] = is_array($iso) ? current($iso) : $iso;\n \n-        if (isset($exif['EXIF']['FocalLength'])) {\n-            $num = explode('/', $exif['EXIF']['FocalLength']);\n-            $exif_data['focallength'] = floor($num[0] / $num[1]) . 'mm';\n-        }\n+            // \u0424\u043e\u043a\u0443\u0441\u043d\u043e\u0435 \u0440\u0430\u0441\u0441\u0442\u043e\u044f\u043d\u0438\u0435\n+            $exif_data['focallength'] = isset($exif['EXIF']['FocalLength']) ? eval_fraction($exif['EXIF']['FocalLength']) . 'mm' : null;\n+            $exif_data['focallengthin35mmfilm'] = isset($exif['EXIF']['FocalLengthIn35mmFilm']) ? $exif['EXIF']['FocalLengthIn35mmFilm'] . 'mm' : null;\n \n-        if (isset($exif['EXIF']['FocalLengthIn35mmFilm'])) {\n-            $exif_data['focallengthin35mmfilm'] = $exif['EXIF']['FocalLengthIn35mmFilm'] . 'mm';\n-        }\n+            // \u041e\u0440\u0438\u0435\u043d\u0442\u0430\u0446\u0438\u044f\n+            $exif_data['orientation'] = $exif['IFD0']['Orientation'] ?? null;\n \n-        if (isset($exif['IFD0']['Orientation'])) {\n-            $exif_data['orientation'] = $exif['IFD0']['Orientation'];\n+            $exif_data = array_filter($exif_data);\n+\n+            foreach ($exif_data as $key => $value) {\n+                $exif_data[$key] = is_string($value) ? strip_tags($value) : $value;\n+            }\n         }\n     }\n \n-    $orientation = 'square';\n-    if ($s[0] > $s[1]) {\n-        $orientation = 'landscape';\n-    }\n-    if ($s[0] < $s[1]) {\n-        $orientation = 'portrait';\n-    }\n+    // \u041e\u043f\u0440\u0435\u0434\u0435\u043b\u0435\u043d\u0438\u0435 \u043e\u0440\u0438\u0435\u043d\u0442\u0430\u0446\u0438\u0438 \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u044f\n+    $orientation = $s[0] === $s[1] ? 'square' : ($s[0] > $s[1] ? 'landscape' : 'portrait');\n \n     return [\n         'orientation' => $orientation,\n         'width'       => $s[0],\n         'height'      => $s[1],\n         'mime'        => $s['mime'],\n-        'exif'        => $exif_data,\n-        'filesize'    => round(filesize($path))\n+        'exif'        => array_filter($exif_data),\n+        'filesize'    => filesize($path)\n     ];\n }\n \n+/**\n+ * \u0412\u0441\u043f\u043e\u043c\u043e\u0433\u0430\u0442\u0435\u043b\u044c\u043d\u0430\u044f \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u0434\u043b\u044f \u0432\u044b\u0447\u0438\u0441\u043b\u0435\u043d\u0438\u044f \u0434\u0440\u043e\u0431\u043d\u044b\u0445 \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0439 EXIF\n+ *\n+ * @param string $fraction \u0421\u0442\u0440\u043e\u043a\u0430 \u0434\u0440\u043e\u0431\u043d\u043e\u0433\u043e \u0447\u0438\u0441\u043b\u0430 \u0432 \u0444\u043e\u0440\u043c\u0430\u0442\u0435 '\u0447\u0438\u0441\u043b\u0438\u0442\u0435\u043b\u044c/\u0437\u043d\u0430\u043c\u0435\u043d\u0430\u0442\u0435\u043b\u044c'\n+ * @return float\n+ */\n+function eval_fraction($fraction) {\n+    if (strpos($fraction, '/') !== false) {\n+        list($numerator, $denominator) = explode('/', $fraction);\n+        return $denominator == 0 ? 0 : $numerator / $denominator;\n+    }\n+    return (float)$fraction;\n+}\n+\n /**\n  * \u0412\u044b\u043f\u043e\u043b\u043d\u044f\u0435\u0442 \u043a\u043e\u043c\u0430\u043d\u0434\u0443 \u0432 shell \u0438 \u0432\u043e\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u0442 \u043c\u0430\u0441\u0441\u0438\u0432 \u0441\u0442\u0440\u043e\u043a \u043e\u0442\u0432\u0435\u0442\u0430\n  *"
        },
        {
          "filename": "templates/modern/controllers/photos/camera.tpl.php",
          "status": "modified",
          "additions": 9,
          "deletions": 9,
          "patch": "@@ -16,26 +16,26 @@\n \n ?>\n \n-<h1 class=\"mb-3\"><?php echo $page_title; ?></h1>\n+<h1 class=\"mb-3\"><?php html($page_title); ?></h1>\n <?php if ($hooks_html) { ?>\n     <div class=\"camera_hints\">\n         <?php echo html_each($hooks_html); ?>\n     </div>\n <?php } ?>\n \n <div class=\"album-photos-wrap d-flex flex-wrap m-n1\" id=\"album-photos-list\"<?php if ($is_owner) { ?> data-delete-url=\"<?php echo $this->href_to('delete'); ?>\"<?php } ?>>\n-    <?php echo $this->renderChild('photos', array(\n-        'photos'   => $photos,\n-        'is_owner' => $is_owner,\n-        'user'     => $user,\n-        'has_next' => $has_next,\n+    <?php echo $this->renderChild('photos', [\n+        'photos'       => $photos,\n+        'is_owner'     => $is_owner,\n+        'user'         => $user,\n+        'has_next'     => $has_next,\n         'preset_small' => $preset_small,\n-        'page'     => $page\n-    )); ?>\n+        'page'         => $page\n+    ]); ?>\n </div>\n \n <?php if($photos && ($has_next || (!$has_next && $page > 1))){ ?>\n-<a class=\"btn btn-primary btn-block btn-sm mt-2  mb-3 show-more\" href=\"<?php echo $item['base_url'].((strpos($item['base_url'], '?') !== false) ? '&' : '?').'photo_page='.($has_next ? ($page+1) : 1); ?>\" onclick=\"return icms.photos.showMore(this);\" data-url=\"<?php echo href_to('photos', 'more', array($item_type, $item['id'])); ?>\" data-url-params=\"<?php html(json_encode($item['url_params'])); ?>\" data-first-page-url=\"<?php echo $item['base_url']; ?>\">\n+<a class=\"btn btn-primary btn-block btn-sm mt-2  mb-3 show-more\" href=\"<?php echo $item['base_url'].((strpos($item['base_url'], '?') !== false) ? '&' : '?').'photo_page='.($has_next ? ($page+1) : 1); ?>\" onclick=\"return icms.photos.showMore(this);\" data-url=\"<?php echo href_to('photos', 'more', [$item_type, $item['id']]); ?>\" data-url-params=\"<?php html(json_encode($item['url_params'])); ?>\" data-first-page-url=\"<?php echo $item['base_url']; ?>\">\n     <span data-to-first=\"<?php echo LANG_RETURN_TO_FIRST; ?>\">\n         <?php if($has_next){ echo LANG_SHOW_MORE; } else { echo LANG_RETURN_TO_FIRST; } ?>\n     </span>"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 3,
        "max_directory_depth": 4
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "3d29dc5254c4359b4e2472b72b56300fd1d786a6",
            "date": "2025-01-11T13:13:10Z",
            "author_login": "fuzegit"
          },
          {
            "sha": "6bbd3018ab5299661143770da0c8389c2f04072e",
            "date": "2025-01-08T21:35:13Z",
            "author_login": "fuzegit"
          },
          {
            "sha": "a2cbfb0325fa0697a084da5360a0d3b09caa9944",
            "date": "2025-01-08T21:34:30Z",
            "author_login": "fuzegit"
          },
          {
            "sha": "9cb2c6e20d57878c6216b57317c94b713322b51b",
            "date": "2025-01-06T20:33:51Z",
            "author_login": "madromas"
          },
          {
            "sha": "b2dc0530ad5138bfc640c639fd6521937631c398",
            "date": "2025-01-06T15:17:23Z",
            "author_login": "madromas"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 5.4,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N",
    "cwe_id": "CWE-79",
    "description": "InstantCMS is a free and open source content management system. In photo upload function in the photo album page there is no input validation taking place. Due to this attackers are able to inject the XSS (Cross Site Scripting) payload and execute. This vulnerability is fixed in 2.16.3.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2024-10-29T23:15:03.863",
    "last_modified": "2024-11-06T14:49:46.073",
    "fix_date": "2024-10-29T21:57:15Z"
  },
  "references": [
    {
      "url": "https://github.com/instantsoft/icms2/commit/e02de2fa1850bb40c9b2050b9256c838a0ea7aa3",
      "source": "security-advisories@github.com",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://github.com/instantsoft/icms2/security/advisories/GHSA-f6cf-jg84-fw29",
      "source": "security-advisories@github.com",
      "tags": [
        "Exploit",
        "Patch",
        "Vendor Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:09:27.108186",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "icms2",
    "owner": "instantsoft",
    "created_at": "2015-07-13T05:37:31Z",
    "updated_at": "2025-01-11T13:13:24Z",
    "pushed_at": "2025-01-11T17:01:14Z",
    "size": 34631,
    "stars": 296,
    "forks": 121,
    "open_issues": 150,
    "watchers": 296,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "PHP": 7286180,
      "JavaScript": 888369,
      "SCSS": 349558,
      "CSS": 327977,
      "HTML": 1587
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "gpl-2.0"
    },
    "collected_at": "2025-01-14T14:13:03.964948"
  }
}