{
  "cve_id": "CVE-2024-5127",
  "github_data": {
    "repository": "lunary-ai/lunary",
    "fix_commit": "b7bd3a830a0f47ba07d0fd57bf78c4dd8a216297",
    "related_commits": [
      "b7bd3a830a0f47ba07d0fd57bf78c4dd8a216297",
      "b7bd3a830a0f47ba07d0fd57bf78c4dd8a216297"
    ],
    "patch_url": "https://github.com/lunary-ai/lunary/commit/b7bd3a830a0f47ba07d0fd57bf78c4dd8a216297.patch",
    "fix_commit_details": {
      "sha": "b7bd3a830a0f47ba07d0fd57bf78c4dd8a216297",
      "commit_date": "2024-05-19T17:35:54Z",
      "author": {
        "login": "hughcrt",
        "type": "User",
        "stats": {
          "total_commits": 819,
          "average_weekly_commits": 9.202247191011235,
          "total_additions": 146326,
          "total_deletions": 109724,
          "weeks_active": 64
        }
      },
      "commit_message": {
        "title": "fix: backend plan check (#329)",
        "length": 30,
        "has_description": false,
        "references_issue": true
      },
      "stats": {
        "total": 66,
        "additions": 50,
        "deletions": 16
      },
      "files": [
        {
          "filename": "packages/backend/src/api/v1/template-versions.ts",
          "status": "modified",
          "additions": 38,
          "deletions": 16,
          "patch": "@@ -4,6 +4,7 @@ import { Context } from \"koa\"\n import postgres from \"postgres\"\n import { unCamelObject } from \"@/src/utils/misc\"\n import { checkAccess } from \"@/src/utils/authorization\"\n+import { z } from \"zod\"\n \n const versions = new Router({\n   prefix: \"/template_versions\",\n@@ -68,25 +69,46 @@ versions.patch(\n   \"/:id\",\n   checkAccess(\"prompts\", \"update\"),\n   async (ctx: Context) => {\n-    const { content, extra, testValues, isDraft } = ctx.request.body as {\n-      id: string\n-      content: any[]\n-      extra: any\n-      testValues: any\n-      isDraft: boolean\n-    }\n+    const bodySchema = z.object({\n+      content: z.array(z.any()),\n+      extra: z.any(),\n+      testValues: z.any(),\n+      isDraft: z.boolean(),\n+    })\n+\n+    const { content, extra, testValues, isDraft } = bodySchema.parse(\n+      ctx.request.body,\n+    )\n \n     const [templateVersion] = await sql`\n-    update template_version set\n-      content = ${sql.json(content)},\n-      extra = ${sql.json(unCamelObject(extra))},\n-      test_values = ${sql.json(testValues)},\n-      is_draft = ${isDraft}\n-    where id = ${ctx.params.id}\n-    returning *\n-  `\n+      select\n+        *\n+      from\n+        template_version tv\n+        left join template t on tv.template_id = t.id\n+        left join project p on t.project_id = p.id \n+      where\n+        tv.id = ${ctx.params.id}\n+        and p.org_id = ${ctx.state.orgId}\n+    `\n+\n+    if (!templateVersion) {\n+      ctx.throw(401, \"You don't have access to this template\")\n+    }\n \n-    ctx.body = templateVersion\n+    const [updatedTemplateVersion] = await sql`\n+      update template_version \n+      set\n+        content = ${sql.json(content)},\n+        extra = ${sql.json(unCamelObject(extra))},\n+        test_values = ${sql.json(testValues)},\n+        is_draft = ${isDraft}\n+      where \n+        id = ${ctx.params.id}\n+      returning *\n+    `\n+\n+    ctx.body = updatedTemplateVersion\n   },\n )\n "
        },
        {
          "filename": "packages/backend/src/api/v1/users.ts",
          "status": "modified",
          "additions": 12,
          "deletions": 0,
          "patch": "@@ -183,9 +183,21 @@ users.post(\"/\", checkAccess(\"teamMembers\", \"create\"), async (ctx: Context) => {\n     select name, plan from org where id = ${orgId}\n   `\n \n+  if (\n+    role !== \"member\" &&\n+    role !== \"admin\" &&\n+    (org.plan === \"free\" || org.plan === \"pro\")\n+  ) {\n+    ctx.throw(\n+      401,\n+      \"Your plan doesn't allow you to access granular access control.\",\n+    )\n+  }\n+\n   const [orgUserCountResult] = await sql`\n     select count(*) from account where org_id = ${orgId}\n   `\n+\n   const orgUserCount = orgUserCountResult.count\n \n   const token = await signJWT({ email, orgId }, FIFTEEN_DAYS)"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 1,
        "max_directory_depth": 5
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "a4c1a889ecc4329f4b8fc976904d08cd57636546",
            "date": "2025-01-13T15:25:14Z",
            "author_login": "hughcrt"
          },
          {
            "sha": "2447a7cc873d1f96fcc150a00f3d46ff13f4964c",
            "date": "2025-01-12T16:53:00Z",
            "author_login": "hughcrt"
          },
          {
            "sha": "a3211170ffe39424c54a102d4afa27cec99c362d",
            "date": "2025-01-12T16:48:23Z",
            "author_login": "hughcrt"
          },
          {
            "sha": "ea73f8db2ec427defadb4d70c56ebfc65964b677",
            "date": "2025-01-11T00:32:52Z",
            "author_login": "hughcrt"
          },
          {
            "sha": "32974c788404aa69fd55709231e8834777dee7ab",
            "date": "2025-01-10T22:45:01Z",
            "author_login": "hughcrt"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 5.4,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:L/I:L/A:N",
    "cwe_id": "CWE-862",
    "description": "In lunary-ai/lunary versions 1.2.2 through 1.2.25, an improper access control vulnerability allows users on the Free plan to invite other members and assign them any role, including those intended for Paid and Enterprise plans only. This issue arises due to insufficient backend validation of roles and permissions, enabling unauthorized users to join a project and potentially exploit roles and permissions not intended for their use. The vulnerability specifically affects the Team feature, where the backend fails to validate whether a user has paid for a plan before allowing them to send invite links with any role assigned. This could lead to unauthorized access and manipulation of project settings or data.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2024-06-06T18:15:19.000",
    "last_modified": "2024-11-21T09:47:01.833",
    "fix_date": "2024-05-19T17:35:54Z"
  },
  "references": [
    {
      "url": "https://github.com/lunary-ai/lunary/commit/b7bd3a830a0f47ba07d0fd57bf78c4dd8a216297",
      "source": "security@huntr.dev",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://huntr.com/bounties/719a5db3-f943-4100-a660-011cadf1bb32",
      "source": "security@huntr.dev",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    },
    {
      "url": "https://github.com/lunary-ai/lunary/commit/b7bd3a830a0f47ba07d0fd57bf78c4dd8a216297",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://huntr.com/bounties/719a5db3-f943-4100-a660-011cadf1bb32",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Exploit",
        "Third Party Advisory"
      ]
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:08:26.345889",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "lunary",
    "owner": "lunary-ai",
    "created_at": "2023-05-12T10:03:05Z",
    "updated_at": "2025-01-13T15:25:18Z",
    "pushed_at": "2025-01-13T15:25:16Z",
    "size": 5319,
    "stars": 1133,
    "forks": 139,
    "open_issues": 0,
    "watchers": 1133,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [
      "llm-1533-allow-filtering-by-feedback-in-thread-and-trace-page",
      "llm-1666-improve-exports-for-traces-enable-export-for-threads",
      "llm-1708-when-clicking-on-a-trace-row-theres-a-quick-render-bug-that",
      "llm-1711-save-row-sorting-in-views",
      "llm-1906-allow-a-team-owner-to-make-another-user-owner-instead-of",
      "llm-1910-prompts-settings-bug",
      "llm-1911-invite-button-doesnt-show-a-success-notification",
      "llm-1922-button-next-to-metadata-that-redirects-to-search",
      "llm-1939-integer-out-of-range-error-on-lunary-app",
      "llm-1942-implement-streaming-from-database-for-csvjsonl-exports",
      "llm-1966-long-project-names-are-croped-in-project-drowndopre",
      "llm-2101-sign-in-with-github",
      "main",
      "playwright_test_feedback_comment_dataset_user"
    ],
    "languages": {
      "TypeScript": 1181050,
      "Python": 112937,
      "CSS": 8238,
      "JavaScript": 3378,
      "Shell": 522
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "apache-2.0"
    },
    "collected_at": "2025-01-14T13:04:58.689247"
  }
}