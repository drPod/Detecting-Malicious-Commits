{
  "cve_id": "CVE-2024-53930",
  "github_data": {
    "repository": "Zavy86/WikiDocs",
    "fix_commit": "aa264bd046a254522da67600be73791bd4e5dafc",
    "related_commits": [
      "aa264bd046a254522da67600be73791bd4e5dafc"
    ],
    "patch_url": null,
    "fix_commit_details": {
      "sha": "aa264bd046a254522da67600be73791bd4e5dafc",
      "commit_date": "2024-11-13T04:11:25Z",
      "author": {
        "login": "leomoon",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "adds multiple security features #211",
        "length": 271,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 115,
        "additions": 109,
        "deletions": 6
      },
      "files": [
        {
          "filename": "bootstrap.inc.php",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -20,6 +20,7 @@\n require_once(BASE.'classes/Localization.class.php');\r\n require_once(BASE.'classes/Document.class.php');\r\n require_once(BASE.'classes/Session.class.php');\r\n+require_once(BASE.'classes/SecurityFilters.class.php');\r\n \r\n // require external libraries\r\n require_once(BASE.\"libraries/parsedown-1.8.0-beta-6/Parsedown.php\");\r"
        },
        {
          "filename": "classes/SecurityFilters.class.php",
          "status": "added",
          "additions": 68,
          "deletions": 0,
          "patch": "@@ -0,0 +1,68 @@\n+<?php\n+/**\n+ * SecurityFilters\n+ *\n+ * Collection of security filters for content sanitization\n+ */\n+class SecurityFilters {\n+    /**\n+     * Main filter method - applies all content filters\n+     *\n+     * @param string $content Content to filter\n+     * @return string Filtered content\n+     */\n+    public static function filterContent($content) {\n+        // apply katex filter\n+        $content = self::filterKaTeX($content);\n+        // add additional filters here as needed\n+        return $content;\n+    }\n+\n+    /**\n+     * KaTeX Filter\n+     */\n+    private static function filterKaTeX($content) {\n+        $blacklistedCommands = [\n+            '\\html',\n+            '\\htmlStyle',\n+            '\\href',\n+            '\\def',\n+            '\\newcommand',\n+            '\\renewcommand',\n+            '\\mathml',\n+            '\\style'\n+        ];\n+\n+        $blacklistedTags = [\n+            '<script',\n+            '<img',\n+            '<iframe',\n+            '<object',\n+            '<embed',\n+            '<math',\n+            '<svg',\n+            'javascript:',\n+            'data:',\n+            'vbscript:'\n+        ];\n+\n+        // extract and filter all katex blocks\n+        $pattern = '/\\$\\$(.*?)\\$\\$|\\$(.*?)\\$/s';\n+        return preg_replace_callback($pattern, function($matches) use ($blacklistedCommands, $blacklistedTags) {\n+            $math = !empty($matches[1]) ? $matches[1] : $matches[2];\n+            $isDisplay = !empty($matches[1]);\n+            // remove blacklisted commands\n+            foreach ($blacklistedCommands as $command) {\n+                $math = str_replace($command, '\\\\text{BLOCKED}', $math);\n+            }\n+            // remove malicious tags\n+            foreach ($blacklistedTags as $tag) {\n+                $math = str_ireplace($tag, '&lt;blocked&gt;', $math);\n+            }\n+            // prevent math mode escaping\n+            $math = preg_replace('/\\\\\\\\(?![\\w\\s{},\\\\\\\\_^])/u', '\\\\\\\\textbackslash', $math);\n+            // return with appropriate delimiters\n+            return $isDisplay ? \"$$\" . $math . \"$$\" : \"$\" . $math . \"$\";\n+        }, $content);\n+    }\n+}"
        },
        {
          "filename": "classes/Session.class.php",
          "status": "modified",
          "additions": 25,
          "deletions": 3,
          "patch": "@@ -22,6 +22,14 @@ static function getInstance():Session{\n \t}\n \n \tfunction start(){\n+\t\t// set secure session cookie parameters\n+\t\tsession_set_cookie_params([\n+\t\t\t'lifetime' => 0,\n+\t\t\t'path' => '/',\n+\t\t\t'domain' => $_SERVER['HTTP_HOST'],\n+\t\t\t'httponly' => true,                   // prevent javascript access\n+\t\t\t'samesite' => 'Strict'                // restrict to same-site requests\n+\t\t]);\n \t\t// start php session\n \t\tsession_start();\n \t\t// check for application session array\n@@ -30,6 +38,14 @@ function start(){\n \t\tif(!isset($_SESSION['wikidocs']['debug'])){$this->setDebug(false);}\n \t\t// check for application session alerts array\n \t\tif(!isset($_SESSION['wikidocs']['alerts']) || !is_array($_SESSION['wikidocs']['alerts'])){$_SESSION['wikidocs']['alerts']=array();}\n+\t\t// periodically regenerate session id to prevent fixation attacks\n+\t\tif (!isset($_SESSION['last_regeneration'])) {\n+\t\t\t$_SESSION['last_regeneration'] = time();\n+\t\t}\n+\t\tif (time() - $_SESSION['last_regeneration'] > 300) { // regenerate every 5 minutes\n+\t\t\tsession_regenerate_id(true);\n+\t\t\t$_SESSION['last_regeneration'] = time();\n+\t\t}\n \t}\n \n \tpublic function destroy(){\n@@ -57,9 +73,15 @@ public function isDebug():bool{\n \t\treturn boolval($_SESSION['wikidocs']['debug']);\n \t}\n \n-\tpublic function privacyAgreement(bool $value){\n-\t\tsetcookie('privacy',$value,time()+(60*60*24*30),'/');\n-\t\theader('Location:'.PATH.DOC);\n+\tpublic function privacyAgreement(bool $value) {\n+\t\tsetcookie('privacy', $value, [\n+\t\t\t'expires' => time() + (60 * 60 * 24 * 30),\n+\t\t\t'path' => '/',\n+\t\t\t'domain' => $_SERVER['HTTP_HOST'],\n+\t\t\t'httponly' => true,\n+\t\t\t'samesite' => 'Strict'\n+\t\t]);\n+\t\theader('Location:' . PATH . DOC);\n \t}\n \n \tpublic function privacyAgreeded():bool{"
        },
        {
          "filename": "index.php",
          "status": "modified",
          "additions": 5,
          "deletions": 0,
          "patch": "@@ -5,6 +5,10 @@\n  * @package WikiDocs\n  * @repository https://github.com/Zavy86/wikidocs\n  */\n+// additional security headers\n+header(\"X-Content-Type-Options: nosniff\");\n+header(\"X-XSS-Protection: 1; mode=block\");\n+\n require_once('bootstrap.inc.php');\n // mode definition\n $mode='view';\n@@ -27,6 +31,7 @@\n $DOC=new Document(DOC);\n // initialize markdown parser\n $PARSER=new ParsedownPlus([\n+\t'safemode' => true,    // enable parsedown's built-in safe mode\n \t'typographer' => true,\n \t'toc' => true,\n \t'sup' => true,"
        },
        {
          "filename": "submit.php",
          "status": "modified",
          "additions": 2,
          "deletions": 0,
          "patch": "@@ -98,6 +98,8 @@ function content_save(){\n \t\twdf_alert($TXT->SubmitDocumentContentCannotBeEmpty,\"danger\");\r\n \t\twdf_redirect(PATH.$p_document.\"?edit\");\r\n \t}\r\n+\t// apply security filters\r\n+\t$p_content = SecurityFilters::filterContent($p_content);\r\n \t// initialize document\r\n \t$DOC=new Document($p_document);\r\n \t// debug\r"
        },
        {
          "filename": "template.inc.php",
          "status": "modified",
          "additions": 8,
          "deletions": 3,
          "patch": "@@ -347,11 +347,16 @@ function gtag(){dataLayer.push(arguments);}\n <script>renderMathInElement(document.body, {\r\n     delimiters: [\r\n       {left: '$$', right: '$$', display: true}, // math block using $$math$$\r\n-      {left: '\\\\[', right: '\\\\]', display: true}, // math block using \\[math\\]\r\n       {left: '$', right: '$', display: false}, // math inline using $math$\r\n-      {left: '\\\\(', right: '\\\\)', display: false} // math inline using \\(math\\)\r\n     ],\r\n-    throwOnError : false\r\n+    throwOnError: false,\r\n+    trust: false, // disable html extension\r\n+    strict: true, // strict mode\r\n+    maxSize: 500, // limit size of expressions\r\n+    maxExpand: 100, // limit macro expansion\r\n+    errorCallback: function(msg) {\r\n+        console.warn('KaTeX error:', msg);\r\n+    }\r\n   });</script>\r\n <script>hljs.highlightAll();</script>\r\n <script src=\"<?= $APP->PATH ?>helpers/mermaid-9.4.3/mermaid.min.js\"></script>\r"
        }
      ],
      "file_patterns": {
        "security_files": 1,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 2,
        "max_directory_depth": 1
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "e9780990c2f7f1642aa1336730c1079d5b3e48eb",
            "date": "2025-01-23T07:11:41Z",
            "author_login": "Zavy86"
          },
          {
            "sha": "d8c620c093dfe351e9a77b6670421fb016926aa0",
            "date": "2025-01-23T07:11:27Z",
            "author_login": "Zavy86"
          },
          {
            "sha": "27ee132bfdecce43289cb2f2dfbaddabffbb42d1",
            "date": "2025-01-08T06:18:21Z",
            "author_login": "Zavy86"
          },
          {
            "sha": "2c7b8998ccf527cf3efa3fbf092d990f763fff52",
            "date": "2025-01-07T21:48:27Z",
            "author_login": "ffiesta"
          },
          {
            "sha": "918d642aee70f7d6f61a86ea963050537826f491",
            "date": "2025-01-07T20:43:56Z",
            "author_login": "ffiesta"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 5.4,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N",
    "cwe_id": "CWE-79",
    "description": "WikiDocs before 1.0.65 allows stored XSS by authenticated users via data that comes after $$\\\\, which is mishandled by a KaTeX parser.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2024-11-25T03:15:12.327",
    "last_modified": "2024-11-26T16:15:21.150",
    "fix_date": "2024-11-13T04:11:25Z"
  },
  "references": [
    {
      "url": "https://github.com/Zavy86/WikiDocs/commit/aa264bd046a254522da67600be73791bd4e5dafc",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "https://github.com/Zavy86/WikiDocs/compare/1.0.64...1.0.65",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "https://github.com/Zavy86/WikiDocs/issues/211",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "https://github.com/Zavy86/WikiDocs/pull/213",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "https://github.com/Zavy86/WikiDocs/releases/tag/1.0.65",
      "source": "cve@mitre.org",
      "tags": []
    },
    {
      "url": "https://www.xbow.com",
      "source": "cve@mitre.org",
      "tags": []
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:09:31.300129",
    "processing_status": "enhanced"
  },
  "repository_context": {
    "name": "WikiDocs",
    "owner": "Zavy86",
    "created_at": "2019-01-02T08:29:50Z",
    "updated_at": "2025-01-24T11:41:33Z",
    "pushed_at": "2025-01-23T07:11:59Z",
    "size": 15150,
    "stars": 371,
    "forks": 45,
    "open_issues": 21,
    "watchers": 371,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "master"
    ],
    "languages": {
      "JavaScript": 1573291,
      "PHP": 276676,
      "CSS": 56140,
      "Dockerfile": 4732,
      "Makefile": 1181
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-26T07:53:32.228137"
  }
}