{
  "cve_id": "CVE-2024-5549",
  "github_data": {
    "repository": "stitionai/devika",
    "fix_commit": "6acce21fb08c3d1123ef05df6a33912bf0ee77c2",
    "related_commits": [
      "6acce21fb08c3d1123ef05df6a33912bf0ee77c2",
      "6acce21fb08c3d1123ef05df6a33912bf0ee77c2"
    ],
    "patch_url": "https://github.com/stitionai/devika/commit/6acce21fb08c3d1123ef05df6a33912bf0ee77c2.patch",
    "fix_commit_details": {
      "sha": "6acce21fb08c3d1123ef05df6a33912bf0ee77c2",
      "commit_date": "2024-06-08T12:00:55Z",
      "author": {
        "login": "ARajgor",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Fix: Sanitizing HTML inputs and Cors misconfiguration",
        "length": 53,
        "has_description": false,
        "references_issue": true
      },
      "stats": {
        "total": 178,
        "additions": 102,
        "deletions": 76
      },
      "files": [
        {
          "filename": "devika.py",
          "status": "modified",
          "additions": 1,
          "deletions": 9,
          "patch": "@@ -26,7 +26,7 @@\n \n \n app = Flask(__name__)\n-CORS(app)\n+CORS(app, resources={r\"/*\": {\"origins\": [\"https://localhost:3000\"]}}) # Change the origin to your frontend URL\n app.register_blueprint(project_bp)\n socketio.init_app(app)\n \n@@ -116,14 +116,6 @@ def get_agent_state():\n     return jsonify({\"state\": agent_state})\n \n \n-@app.route(\"/api/get-project-files/\", methods=[\"GET\"])\n-@route_logger(logger)\n-def project_files():\n-    project_name = request.args.get(\"project_name\")\n-    files = AgentState.get_project_files(project_name)  \n-    return jsonify({\"files\": files})\n-\n-\n @app.route(\"/api/get-browser-snapshot\", methods=[\"GET\"])\n @route_logger(logger)\n def browser_snapshot():"
        },
        {
          "filename": "src/apis/project.py",
          "status": "modified",
          "additions": 13,
          "deletions": 4,
          "patch": "@@ -1,4 +1,5 @@\n from flask import blueprints, request, jsonify, send_file, make_response\n+from werkzeug.utils import secure_filename\n from src.logger import Logger, route_logger\n from src.config import Config\n from src.project import ProjectManager\n@@ -13,20 +14,28 @@\n \n \n # Project APIs\n+\n+@project_bp.route(\"/api/get-project-files\", methods=[\"GET\"])\n+@route_logger(logger)\n+def project_files():\n+    project_name = secure_filename(request.args.get(\"project_name\"))\n+    files = manager.get_project_files(project_name)  \n+    return jsonify({\"files\": files})\n+\n @project_bp.route(\"/api/create-project\", methods=[\"POST\"])\n @route_logger(logger)\n def create_project():\n     data = request.json\n     project_name = data.get(\"project_name\")\n-    manager.create_project(project_name)\n+    manager.create_project(secure_filename(project_name))\n     return jsonify({\"message\": \"Project created\"})\n \n \n @project_bp.route(\"/api/delete-project\", methods=[\"POST\"])\n @route_logger(logger)\n def delete_project():\n     data = request.json\n-    project_name = data.get(\"project_name\")\n+    project_name = secure_filename(data.get(\"project_name\"))\n     manager.delete_project(project_name)\n     AgentState().delete_state(project_name)\n     return jsonify({\"message\": \"Project deleted\"})\n@@ -35,7 +44,7 @@ def delete_project():\n @project_bp.route(\"/api/download-project\", methods=[\"GET\"])\n @route_logger(logger)\n def download_project():\n-    project_name = request.args.get(\"project_name\")\n+    project_name = secure_filename(request.args.get(\"project_name\"))\n     manager.project_to_zip(project_name)\n     project_path = manager.get_zip_path(project_name)\n     return send_file(project_path, as_attachment=False)\n@@ -44,7 +53,7 @@ def download_project():\n @project_bp.route(\"/api/download-project-pdf\", methods=[\"GET\"])\n @route_logger(logger)\n def download_project_pdf():\n-    project_name = request.args.get(\"project_name\")\n+    project_name = secure_filename(request.args.get(\"project_name\"))\n     pdf_dir = Config().get_pdfs_dir()\n     pdf_path = os.path.join(pdf_dir, f\"{project_name}.pdf\")\n "
        },
        {
          "filename": "src/project.py",
          "status": "modified",
          "additions": 29,
          "deletions": 0,
          "patch": "@@ -144,3 +144,32 @@ def project_to_zip(self, project: str):\n \n     def get_zip_path(self, project: str):\n         return f\"{self.get_project_path(project)}.zip\"\n+    \n+    def get_project_files(self, project_name: str):\n+        if not project_name:\n+            return []\n+\n+        project_directory = \"-\".join(project_name.split(\" \"))\n+        base_path = os.path.abspath(os.path.join(os.getcwd(), 'data', 'projects'))\n+        directory = os.path.join(base_path, project_directory)\n+\n+        # Ensure the directory is within the allowed base path\n+        if not os.path.exists(directory) or not os.path.commonprefix([directory, base_path]) == base_path:\n+            return []\n+\n+        files = []\n+        for root, _, filenames in os.walk(directory):\n+            for filename in filenames:\n+                file_relative_path = os.path.relpath(root, directory)\n+                if file_relative_path == '.':\n+                    file_relative_path = ''\n+                file_path = os.path.join(file_relative_path, filename)\n+                try:\n+                    with open(os.path.join(root, filename), 'r') as file:\n+                        files.append({\n+                            \"file\": file_path,\n+                            \"code\": file.read()\n+                        })\n+                except Exception as e:\n+                    print(f\"Error reading file {filename}: {e}\")\n+        return files"
        },
        {
          "filename": "src/state.py",
          "status": "modified",
          "additions": 1,
          "deletions": 25,
          "patch": "@@ -174,28 +174,4 @@ def get_latest_token_usage(self, project: str):\n             if agent_state:\n                 return json.loads(agent_state.state_stack_json)[-1][\"token_usage\"]\n             return 0\n-\n-    def get_project_files(self, project_name: str):\n-        if not project_name:\n-            return []\n-        project_directory = \"-\".join(project_name.split(\" \"))\n-        directory = os.path.join(os.getcwd(), 'data', 'projects', project_directory) \n-        if(not os.path.exists(directory)):\n-            return []\n-        files = []\n-        for root, _, filenames in os.walk(directory):\n-            for filename in filenames:\n-                file_relative_path = os.path.relpath(root, directory)\n-                if file_relative_path == '.': file_relative_path = ''\n-                file_path = os.path.join(file_relative_path, filename)\n-                print(\"file_path\",file_path)\n-                try:\n-                    with open(os.path.join(root, filename), 'r') as file:\n-                        print(\"File:\", filename)\n-                        files.append({\n-                            \"file\": file_path,\n-                            \"code\": file.read()\n-                        })\n-                except Exception as e:\n-                    print(f\"Error reading file {filename}: {e}\")\n-        return files\n\\ No newline at end of file\n+        \n\\ No newline at end of file"
        },
        {
          "filename": "ui/bun.lockb",
          "status": "modified",
          "additions": 0,
          "deletions": 0,
          "patch": null
        },
        {
          "filename": "ui/package.json",
          "status": "modified",
          "additions": 1,
          "deletions": 0,
          "patch": "@@ -28,6 +28,7 @@\n     \"@xterm/xterm\": \"^5.5.0\",\n     \"bits-ui\": \"^0.21.2\",\n     \"clsx\": \"^2.1.0\",\n+    \"dompurify\": \"^3.1.5\",\n     \"mode-watcher\": \"^0.3.0\",\n     \"paneforge\": \"^0.0.3\",\n     \"socket.io-client\": \"^4.7.5\","
        },
        {
          "filename": "ui/src/lib/components/MessageInput.svelte",
          "status": "modified",
          "additions": 57,
          "deletions": 38,
          "patch": "@@ -1,4 +1,5 @@\n <script>\n+  import DOMPurify from \"dompurify\";\n   import { emitMessage, socketListener } from \"$lib/sockets\";\n   import { agentState, messages, isSending } from \"$lib/store\";\n   import { calculateTokens } from \"$lib/token\";\n@@ -11,12 +12,27 @@\n     if (value !== null && value.agent_is_active == false) {\n       isSending.set(false);\n     }\n-    if (value == null){\n+    if (value == null) {\n       inference_time = 0;\n     }\n   });\n \n   let messageInput = \"\";\n+\n+  // Function to escape HTML\n+  function escapeHTML(input) {\n+    const map = {\n+      \"&\": \"&amp;\",\n+      \"<\": \"&lt;\",\n+      \">\": \"&gt;\",\n+      '\"': \"&quot;\",\n+      \"'\": \"&#039;\",\n+    };\n+    return input.replace(/[&<>\"']/g, function (m) {\n+      return map[m];\n+    });\n+  }\n+\n   async function handleSendMessage() {\n     const projectName = localStorage.getItem(\"selectedProject\");\n     const selectedModel = localStorage.getItem(\"selectedModel\");\n@@ -31,26 +47,29 @@\n       return;\n     }\n \n-    if (messageInput.trim() !== \"\" && isSending) {\n+    const sanitizedMessage = DOMPurify.sanitize(messageInput);\n+    const escapedMessage = escapeHTML(sanitizedMessage);\n+\n+\n+    if (messageInput.trim() !== \"\" && escapedMessage.trim() !== \"\" && isSending) {\n       $isSending = true;\n-      emitMessage(\"user-message\", { \n-        message: messageInput,\n+      emitMessage(\"user-message\", {\n+        message: escapedMessage,\n         base_model: selectedModel,\n         project_name: projectName,\n         search_engine: serachEngine,\n       });\n       messageInput = \"\";\n-      \n     }\n   }\n   onMount(() => {\n     socketListener(\"inference\", function (data) {\n-      if(data['type'] == 'time') {\n+      if (data[\"type\"] == \"time\") {\n         inference_time = data[\"elapsed_time\"];\n       }\n     });\n   });\n-       \n+\n   function setTokenSize(event) {\n     const prompt = event.target.value;\n     let tokens = calculateTokens(prompt);\n@@ -73,41 +92,41 @@\n       {/if}\n     </div>\n     <!-- {#if $agentState !== null} -->\n-      <div class=\"px-1 rounded-md text-xs\">\n-        Model Inference: <span class=\"text-orange-600\">{inference_time} sec</span>\n-      </div>\n+    <div class=\"px-1 rounded-md text-xs\">\n+      Model Inference: <span class=\"text-orange-600\">{inference_time} sec</span>\n+    </div>\n     <!-- {/if} -->\n   </div>\n \n-<div class=\"expandable-input relative\">\n-  <textarea\n-    id=\"message-input\"\n-    class=\"w-full p-4 font-medium focus:text-foreground rounded-xl outline-none h-28 pr-20 bg-secondary\n-    {$isSending ? 'cursor-not-allowed' : ''}\"   \n-    placeholder=\"Type your message...\"\n-    disabled={$isSending}\n-    bind:value={messageInput}\n-    on:input={setTokenSize}\n-    on:keydown={(e) => {\n-      if (e.key === \"Enter\" && !e.shiftKey) {\n-        e.preventDefault();\n-        handleSendMessage();\n-        document.querySelector('.token-count').textContent = 0;\n-      }\n-    }}\n-  ></textarea>\n-  <button \n-    on:click={handleSendMessage}\n-    disabled={$isSending}\n-    class=\"absolute text-secondary bg-primary p-2 right-4 bottom-6 rounded-full\n+  <div class=\"expandable-input relative\">\n+    <textarea\n+      id=\"message-input\"\n+      class=\"w-full p-4 font-medium focus:text-foreground rounded-xl outline-none h-28 pr-20 bg-secondary\n     {$isSending ? 'cursor-not-allowed' : ''}\"\n-  >\n-  {@html Icons.CornerDownLeft} \n-  </button>\n-  <p class=\"absolute text-tertiary p-2 right-4 top-2\">\n-    <span class=\"token-count\">0</span>\n-  </p>\n-</div>\n+      placeholder=\"Type your message...\"\n+      disabled={$isSending}\n+      bind:value={messageInput}\n+      on:input={setTokenSize}\n+      on:keydown={(e) => {\n+        if (e.key === \"Enter\" && !e.shiftKey) {\n+          e.preventDefault();\n+          handleSendMessage();\n+          document.querySelector(\".token-count\").textContent = 0;\n+        }\n+      }}\n+    ></textarea>\n+    <button\n+      on:click={handleSendMessage}\n+      disabled={$isSending}\n+      class=\"absolute text-secondary bg-primary p-2 right-4 bottom-6 rounded-full\n+    {$isSending ? 'cursor-not-allowed' : ''}\"\n+    >\n+      {@html Icons.CornerDownLeft}\n+    </button>\n+    <p class=\"absolute text-tertiary p-2 right-4 top-2\">\n+      <span class=\"token-count\">0</span>\n+    </p>\n+  </div>\n </div>\n \n <style>"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 1,
        "dependency_files": 1,
        "test_files": 0,
        "unique_directories": 5,
        "max_directory_depth": 4
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "3b98ed31e22cd2893563d4b375c2538c72a2e224",
            "date": "2024-09-19T16:11:25Z",
            "author_login": "ayoubachak"
          },
          {
            "sha": "04af76c9ad1459bfeb36d343bb7b409282911c13",
            "date": "2024-08-28T17:04:52Z",
            "author_login": "tosin2013"
          },
          {
            "sha": "e65ac75c277a1059c0ba4555a878c25b31164d9a",
            "date": "2024-08-28T16:59:25Z",
            "author_login": "sts07142"
          },
          {
            "sha": "9efea578c6aa50e774779120eafa026fd833ea12",
            "date": "2024-08-28T16:51:09Z",
            "author_login": "Athulkrishna-S"
          },
          {
            "sha": "7a8c980e1a9c87aac5051047410a4806cb756d66",
            "date": "2024-06-18T16:06:30Z",
            "author_login": "vijayraju111222333"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": null,
    "cvss_vector": null,
    "cwe_id": "CWE-346",
    "description": "A CORS misconfiguration in the stitionai/devika repository allows attackers to steal sensitive information such as logs, browser sessions, and settings containing private API keys from other services. This vulnerability also enables attackers to perform actions on behalf of the user, such as deleting projects or sending messages. The issue arises from the lack of proper origin validation, allowing unauthorized cross-origin requests to be executed. The vulnerability is present in all versions of the repository, as no fixed version has been specified.",
    "attack_vector": null,
    "attack_complexity": null
  },
  "temporal_data": {
    "published_date": "2024-07-09T00:15:02.050",
    "last_modified": "2024-11-21T09:47:54.507",
    "fix_date": "2024-06-08T12:00:55Z"
  },
  "references": [
    {
      "url": "https://github.com/stitionai/devika/commit/6acce21fb08c3d1123ef05df6a33912bf0ee77c2",
      "source": "security@huntr.dev",
      "tags": []
    },
    {
      "url": "https://huntr.com/bounties/7ffeb896-27c8-429d-b241-4f7d6dda0afd",
      "source": "security@huntr.dev",
      "tags": []
    },
    {
      "url": "https://github.com/stitionai/devika/commit/6acce21fb08c3d1123ef05df6a33912bf0ee77c2",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    },
    {
      "url": "https://huntr.com/bounties/7ffeb896-27c8-429d-b241-4f7d6dda0afd",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": []
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:08:31.419459",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "devika",
    "owner": "stitionai",
    "created_at": "2024-03-21T03:03:21Z",
    "updated_at": "2025-01-14T12:32:37Z",
    "pushed_at": "2024-09-19T16:11:25Z",
    "size": 6117,
    "stars": 18750,
    "forks": 2444,
    "open_issues": 180,
    "watchers": 18750,
    "has_security_policy": false,
    "default_branch": "main",
    "protected_branches": [],
    "languages": {
      "Python": 126787,
      "Svelte": 48724,
      "Jinja": 19899,
      "JavaScript": 18737,
      "CSS": 2939,
      "Dockerfile": 2089,
      "Makefile": 798,
      "HTML": 504,
      "Shell": 119
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "mit"
    },
    "collected_at": "2025-01-14T14:01:36.291769"
  }
}