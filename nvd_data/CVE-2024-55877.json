{
  "cve_id": "CVE-2024-55877",
  "github_data": {
    "repository": "xwiki/xwiki-platform",
    "fix_commit": "40e1afe001d61eafdf13f3621b4b597a0e58a3e3",
    "related_commits": [
      "40e1afe001d61eafdf13f3621b4b597a0e58a3e3"
    ],
    "patch_url": "https://github.com/xwiki/xwiki-platform/commit/40e1afe001d61eafdf13f3621b4b597a0e58a3e3.patch",
    "fix_commit_details": {
      "sha": "40e1afe001d61eafdf13f3621b4b597a0e58a3e3",
      "commit_date": "2024-05-07T12:32:36Z",
      "author": {
        "login": "pjeanjean",
        "type": "User",
        "stats": {
          "total_commits": 36,
          "average_weekly_commits": 0.03773584905660377,
          "total_additions": 0,
          "total_deletions": 0,
          "weeks_active": 23
        }
      },
      "commit_message": {
        "title": "XWIKI-22030: Improve escaping in macros list",
        "length": 138,
        "has_description": true,
        "references_issue": false
      },
      "stats": {
        "total": 74,
        "additions": 56,
        "deletions": 18
      },
      "files": [
        {
          "filename": "xwiki-platform-core/xwiki-platform-help/xwiki-platform-help-ui/src/main/resources/XWiki/XWikiSyntaxMacrosList.xml",
          "status": "modified",
          "additions": 2,
          "deletions": 2,
          "patch": "@@ -39,10 +39,10 @@\n   <content>{{velocity}}\n ## If the translation key exists, use its value, otherwise use to the provided fallback value. \n #macro (translateOrElse $translationKey $fallback)\n- #if($services.localization.get($translationKey))\n+  #if($services.localization.get($translationKey))\n     $services.rendering.escape($services.localization.render($translationKey), 'xwiki/2.1')##\n   #else\n-    $fallback##\n+    $services.rendering.escape($fallback, 'xwiki/2.1')##\n   #end\n #end\n "
        },
        {
          "filename": "xwiki-platform-core/xwiki-platform-help/xwiki-platform-help-ui/src/test/java/org/xwiki/help/XWikiSyntaxMacrosListPageTest.java",
          "status": "modified",
          "additions": 54,
          "deletions": 16,
          "patch": "@@ -27,6 +27,7 @@\n import org.jsoup.nodes.Document;\n import org.jsoup.nodes.Element;\n import org.jsoup.select.Elements;\n+import org.junit.jupiter.api.BeforeEach;\n import org.junit.jupiter.api.Test;\n import org.xwiki.context.internal.concurrent.DefaultContextStoreManager;\n import org.xwiki.localization.macro.internal.TranslationMacro;\n@@ -49,13 +50,15 @@\n import org.xwiki.test.annotation.ComponentList;\n import org.xwiki.test.page.HTML50ComponentList;\n import org.xwiki.test.page.PageTest;\n+import org.xwiki.test.page.TestNoScriptMacro;\n import org.xwiki.test.page.XWikiSyntax21ComponentList;\n \n import com.xpn.xwiki.DefaultSkinAccessBridge;\n import com.xpn.xwiki.doc.XWikiDocument;\n import com.xpn.xwiki.objects.BaseObject;\n \n import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n import static org.mockito.ArgumentMatchers.any;\n import static org.mockito.Mockito.mock;\n import static org.mockito.Mockito.when;\n@@ -88,19 +91,30 @@\n     // End of XWikiWikiModel\n     DocumentXHTMLLinkTypeRenderer.class,\n     DocumentResourceReferenceEntityReferenceResolver.class,\n+    TestNoScriptMacro.class,\n     TranslationMacro.class\n })\n class XWikiSyntaxMacrosListPageTest extends PageTest\n {\n     public static final DocumentReference DOCUMENT_REFERENCE =\n         new DocumentReference(\"xwiki\", \"XWiki\", \"XWikiSyntaxMacrosList\");\n \n-    @Test\n-    void renderTable() throws Exception\n+    private DefaultWikiMacro myMacro;\n+\n+    @BeforeEach\n+    void setUp() throws Exception\n     {\n         // Initialize \"WikiMacroClass\"\n         this.xwiki.initializeMandatoryDocuments(this.context);\n \n+        // Mock the database.\n+        Query query = mock(Query.class);\n+        QueryManagerScriptService queryManagerScriptService =\n+            this.componentManager.registerMockComponent(ScriptService.class, \"query\", QueryManagerScriptService.class,\n+                false);\n+        when(queryManagerScriptService.xwql(any())).thenReturn(query);\n+        when(query.execute()).thenReturn(List.of(\"xwiki:XWiki.MyMacro\"));\n+\n         // Create a wiki macro.\n         XWikiDocument myMacroDocument = this.xwiki.getDocument(new DocumentReference(\"xwiki\", \"XWiki\", \"MyMacro\"),\n             this.context);\n@@ -111,20 +125,17 @@ void renderTable() throws Exception\n         this.xwiki.saveDocument(myMacroDocument, this.context);\n \n         // Register the wiki macro component.\n-        DefaultWikiMacro myMacro =\n+        this.myMacro =\n             this.componentManager.registerMockComponent(Macro.class, \"mymacro\", DefaultWikiMacro.class, false);\n-        DefaultMacroDescriptor macroDescriptor =\n-            new DefaultMacroDescriptor(new MacroId(\"mymacro\"), \"My Macro\", \"My Macro Description\");\n-        macroDescriptor.setDefaultCategories(Set.of(\"Category1\", \"Category2\"));\n-        when(myMacro.getDescriptor()).thenReturn(macroDescriptor);\n+    }\n \n-        // Mock the database.\n-        Query query = mock(Query.class);\n-        QueryManagerScriptService queryManagerScriptService =\n-            this.componentManager.registerMockComponent(ScriptService.class, \"query\", QueryManagerScriptService.class,\n-                false);\n-        when(queryManagerScriptService.xwql(any())).thenReturn(query);\n-        when(query.execute()).thenReturn(List.of(\"xwiki:XWiki.MyMacro\"));\n+    @Test\n+    void renderTable() throws Exception\n+    {\n+        DefaultMacroDescriptor macroDescriptor = new DefaultMacroDescriptor(new MacroId(\"mymacro\"), \"My Macro\",\n+            \"My Macro Description\");\n+        macroDescriptor.setDefaultCategories(Set.of(\"Category1\", \"Category2\"));\n+        when(this.myMacro.getDescriptor()).thenReturn(macroDescriptor);\n \n         // Render the page.\n         Document document = renderHTMLPage(DOCUMENT_REFERENCE);\n@@ -144,12 +155,39 @@ void renderTable() throws Exception\n             \"XWiki.WikiMacroClass_visibility_Global\");\n         assertWikiMacro(trs.get(3), \"mymacro\", \"/xwiki/bin/view/XWiki/MyMacro\", \"My Macro\",\n             Set.of(\"Category1\", \"Category2\"), \"My Macro Description\", \"XWiki.WikiMacroClass_visibility_WIKI\");\n-        assertJavaMacro(trs.get(4), \"translation\", \"Translation\", \"Content\",\n+        assertJavaMacro(trs.get(4), \"noscript\", \"NoScript\", \"\", \"No Script!\", \"XWiki.WikiMacroClass_visibility_Global\");\n+        assertJavaMacro(trs.get(5), \"translation\", \"Translation\", \"Content\",\n             \"Display a translation message.\", \"XWiki.WikiMacroClass_visibility_Global\");\n-        assertJavaMacro(trs.get(5), \"velocity\", \"Velocity\", \"Development\", \"Executes a Velocity script.\",\n+        assertJavaMacro(trs.get(6), \"velocity\", \"Velocity\", \"Development\", \"Executes a Velocity script.\",\n             \"XWiki.WikiMacroClass_visibility_Global\");\n     }\n \n+    @Test\n+    void checkTableEscaping() throws Exception\n+    {\n+        String unescapedString = \"{{noscript /}}\";\n+\n+        DefaultMacroDescriptor macroDescriptor = new DefaultMacroDescriptor(new MacroId(\"mymacro\"), unescapedString,\n+            unescapedString);\n+        macroDescriptor.setDefaultCategories(Set.of(unescapedString));\n+        when(this.myMacro.getDescriptor()).thenReturn(macroDescriptor);\n+\n+        Document document = renderHTMLPage(DOCUMENT_REFERENCE);\n+\n+        Elements trs = document.select(\"tr\");\n+        Element myMacroTr = null;\n+        for (Element tr : trs) {\n+            Element th = tr.selectFirst(\"td\");\n+            if (th != null && th.text().equals(\"mymacro\")) {\n+                myMacroTr = tr;\n+            }\n+        }\n+\n+        assertNotNull(myMacroTr);\n+        assertWikiMacro(myMacroTr, \"mymacro\", \"/xwiki/bin/view/XWiki/MyMacro\", unescapedString, Set.of(unescapedString),\n+            unescapedString, \"XWiki.WikiMacroClass_visibility_WIKI\");\n+    }\n+\n     private void assertWikiMacro(Element rowElement, String id, String link, String name, Set<String> categories,\n         String description, String visibility)\n     {"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 1,
        "unique_directories": 2,
        "max_directory_depth": 9
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "88e3e7d23cbd3e6ed059dbcd6532f94016d42678",
            "date": "2025-01-13T16:58:06Z",
            "author_login": "Sereza7"
          },
          {
            "sha": "9b506ab2bed52744b52699ea05cde15986d42abb",
            "date": "2025-01-13T16:36:24Z",
            "author_login": "mflorea"
          },
          {
            "sha": "d53d6e347b97ac20f60e21fb2bae381f4aaf10f4",
            "date": "2025-01-13T13:25:24Z",
            "author_login": "tmortagne"
          },
          {
            "sha": "d85bd8f9c67c412e0cfb45fb4695b8d4e759bab6",
            "date": "2025-01-13T12:03:22Z",
            "author_login": "tmortagne"
          },
          {
            "sha": "6f210dabc99167cf9f020a048c88325eca34ceea",
            "date": "2025-01-13T08:54:32Z",
            "author_login": "tmortagne"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 9.9,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H",
    "cwe_id": "CWE-96",
    "description": "XWiki Platform is a generic wiki platform. Starting in version 9.7-rc-1 and prior to versions 15.10.11, 16.4.1, and 16.5.0, any user with an account can perform arbitrary remote code execution by adding instances of `XWiki.WikiMacroClass` to any page. This compromises the confidentiality, integrity and availability of the whole XWiki installation. This vulnerability has been fixed in XWiki 15.10.11, 16.4.1 and 16.5.0. It is possible to manually apply the patch to the page `XWiki.XWikiSyntaxMacrosList` as a workaround.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2024-12-12T20:15:21.350",
    "last_modified": "2024-12-13T15:15:43.060",
    "fix_date": "2024-05-07T12:32:36Z"
  },
  "references": [
    {
      "url": "https://github.com/xwiki/xwiki-platform/commit/40e1afe001d61eafdf13f3621b4b597a0e58a3e3",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/xwiki/xwiki-platform/security/advisories/GHSA-2r87-74cx-2p7c",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://jira.xwiki.org/browse/XWIKI-22030",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://jira.xwiki.org/browse/XWIKI-22030",
      "source": "134c704f-9b21-4f2e-91b3-4a467353bcc0",
      "tags": []
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:09:33.135232",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "xwiki-platform",
    "owner": "xwiki",
    "created_at": "2011-03-10T13:26:41Z",
    "updated_at": "2025-01-13T16:58:10Z",
    "pushed_at": "2025-01-14T12:32:03Z",
    "size": 561595,
    "stars": 1030,
    "forks": 554,
    "open_issues": 136,
    "watchers": 1030,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "Java": 34276921,
      "JavaScript": 2392892,
      "HTML": 388086,
      "Less": 318945,
      "AspectJ": 280487,
      "Vue": 222987,
      "CSS": 115460,
      "XSLT": 109285,
      "Clean": 44054,
      "Shell": 32569,
      "Batchfile": 14604,
      "Python": 5046,
      "Groovy": 3012,
      "AMPL": 1296
    },
    "commit_activity": {
      "total_commits_last_year": 1723,
      "avg_commits_per_week": 33.13461538461539,
      "days_active_last_year": 263
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": false,
      "has_issues": false,
      "allow_forking": true,
      "is_template": false,
      "license": "lgpl-2.1"
    },
    "collected_at": "2025-01-14T12:58:58.685838"
  }
}