{
  "cve_id": "CVE-2025-21622",
  "github_data": {
    "repository": "MacWarrior/clipbucket-v5",
    "fix_commit": "22329c4675e82c7c95e74024ba247f837ac9e00b",
    "related_commits": [
      "22329c4675e82c7c95e74024ba247f837ac9e00b"
    ],
    "patch_url": "https://github.com/MacWarrior/clipbucket-v5/commit/22329c4675e82c7c95e74024ba247f837ac9e00b.patch",
    "fix_commit_details": {
      "sha": "22329c4675e82c7c95e74024ba247f837ac9e00b",
      "commit_date": "2025-01-05T16:51:23Z",
      "author": {
        "login": "MacWarrior",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Front office : Fix possible arbitrary file deletion (Thanks @kawing-ho !)",
        "length": 102,
        "has_description": true,
        "references_issue": true
      },
      "stats": {
        "total": 55,
        "additions": 30,
        "deletions": 25
      },
      "files": [
        {
          "filename": "upload/changelog/551.json",
          "status": "modified",
          "additions": 2,
          "deletions": 1,
          "patch": "@@ -1,6 +1,6 @@\n {\n   \"version\":\"5.5.1\",\n-  \"revision\":\"236\",\n+  \"revision\":\"237\",\n   \"status\":\"dev\",\n   \"detail\":[\n     {\n@@ -215,6 +215,7 @@\n         ,\"Fix anonymous comments form\"\n         ,\"Fix collection creation on photo upload form\"\n         ,\"Fix video title overflow\"\n+        ,\"Fix possible arbitrary file deletion (Thanks @kawing-ho !)\"\n       ]\n     },\n     {"
        },
        {
          "filename": "upload/includes/classes/upload.class.php",
          "status": "modified",
          "additions": 0,
          "deletions": 2,
          "patch": "@@ -961,7 +961,6 @@ function upload_user_file(string $type, $file, $uid)\n         }\r\n \r\n         switch ($type) {\r\n-            case 'a':\r\n             case 'avatar':\r\n                 if ($file['size'] / 1024 > config('max_profile_pic_size')) {\r\n                     e(lang('file_size_exceeds', config('max_profile_pic_size')));\r\n@@ -995,7 +994,6 @@ function upload_user_file(string $type, $file, $uid)\n                 e(lang('class_error_occured'));\r\n                 return false;\r\n \r\n-            case 'b':\r\n             case 'background':\r\n                 if ($file['size'] / 1024 > config('max_bg_size')) {\r\n                     e(lang('file_size_exceeds', config('max_bg_size')));\r"
        },
        {
          "filename": "upload/includes/classes/user.class.php",
          "status": "modified",
          "additions": 28,
          "deletions": 22,
          "patch": "@@ -918,9 +918,6 @@ function init()\n \r\n         define('AVATAR_SIZE', config('max_profile_pic_width'));\r\n         define('AVATAR_SMALL_SIZE', 40);\r\n-        define('BG_SIZE', config('max_bg_width'));\r\n-        define('BACKGROUND_URL', config('background_url'));\r\n-        define('BACKGROUND_COLOR', config('background_color'));\r\n         if (isSectionEnabled('channels')) {\r\n             ClipBucket::getInstance()->search_types['channels'] = 'userquery';\r\n         }\r\n@@ -2196,11 +2193,11 @@ function getUserBg($udetails, $check = false)\n             return DirPath::getUrl('backgrounds') . $file;\r\n         }\r\n \r\n-        if (!empty($udetails['background_url']) && BACKGROUND_URL == 'yes') {\r\n+        if (!empty($udetails['background_url']) && config('background_url') == 'yes') {\r\n             return $udetails['background_url'];\r\n         }\r\n \r\n-        if (!empty($udetails['background_color']) && BACKGROUND_COLOR == 'yes' && $check) {\r\n+        if (!empty($udetails['background_color']) && config('background_color') == 'yes' && $check) {\r\n             return true;\r\n         }\r\n \r\n@@ -2761,15 +2758,15 @@ function update_user($array)\n             $udetails = $this->get_user_details($array['userid']);\r\n \r\n             $file = DirPath::get('avatars') . $udetails['avatar'];\r\n-            if (file_exists($file) && $udetails['avatar'] != '') {\r\n+            if( file_exists($file) && empty($udetails['avatar_url']) ){\r\n                 unlink($file);\r\n             }\r\n \r\n             $uquery_field[] = 'avatar';\r\n             $uquery_val[] = '';\r\n         } else {\r\n             if (!empty($_FILES['avatar_file']['name'])) {\r\n-                $file = $Upload->upload_user_file('a', $_FILES['avatar_file'], $array['userid']);\r\n+                $file = $Upload->upload_user_file('avatar', $_FILES['avatar_file'], $array['userid']);\r\n                 if ($file) {\r\n                     $uquery_field[] = 'avatar';\r\n                     $uquery_val[] = $file;\r\n@@ -2799,7 +2796,7 @@ function update_user($array)\n         }\r\n \r\n         if (!empty($_FILES['background_file']['name'])) {\r\n-            $file = $Upload->upload_user_file('b', $_FILES['background_file'], $array['userid']);\r\n+            $file = $Upload->upload_user_file('background', $_FILES['background_file'], $array['userid']);\r\n             if ($file) {\r\n                 $uquery_field[] = 'background';\r\n                 $uquery_val[] = $file;\r\n@@ -2868,14 +2865,12 @@ function update_user($array)\n      */\r\n     function update_user_avatar_bg($array)\r\n     {\r\n-        global $Upload;\r\n-\r\n         //Deleting User Avatar\r\n         if ($array['delete_avatar'] == 'yes') {\r\n             $udetails = $this->get_user_details(user_id());\r\n \r\n-            $file = DirPath::get('avatars') . $udetails['avatar_url'];\r\n-            if (file_exists($file) && $udetails['avatar_url'] != '') {\r\n+            $file = DirPath::get('avatars') . $udetails['avatar'];\r\n+            if( file_exists($file) ){\r\n                 unlink($file);\r\n             }\r\n \r\n@@ -2886,29 +2881,39 @@ function update_user_avatar_bg($array)\n             $uquery_val[] = '';\r\n         } else {\r\n             if (config('picture_url') == 'yes') {\r\n-                //Updating User Avatar\r\n-                $uquery_field[] = 'avatar_url';\r\n-                $uquery_val[] = $array['avatar_url'];\r\n+                if( filter_var($array['avatar_url'], FILTER_VALIDATE_URL) || empty($array['avatar_url']) ){\r\n+                    //Updating User Avatar\r\n+                    $uquery_field[] = 'avatar_url';\r\n+                    $uquery_val[] = $array['avatar_url'];\r\n+                } else {\r\n+                    e(lang('incorrect_url'));\r\n+                }\r\n             }\r\n \r\n-            if (isset($_FILES['avatar_file']['name'])) {\r\n-                $file = $Upload->upload_user_file('a', $_FILES['avatar_file'], user_id());\r\n+            if( !empty($_FILES['avatar_file']['name']) ){\r\n+                $file = Upload::getInstance()->upload_user_file('avatar', $_FILES['avatar_file'], user_id());\r\n                 if ($file) {\r\n                     $uquery_field[] = 'avatar';\r\n                     $uquery_val[] = $file;\r\n                 }\r\n             }\r\n         }\r\n \r\n+\r\n+        /* TODO : Re-implement background edition interface or delete this\r\n         //Deleting User Bg\r\n         if ($array['delete_bg'] == 'yes') {\r\n             User::getInstance()->delBackground($array['userid']);\r\n         }\r\n \r\n         if (config('background_url') == 'yes') {\r\n-            //Updating User Background\r\n-            $uquery_field[] = 'background_url';\r\n-            $uquery_val[] = $array['background_url'];\r\n+            if( filter_var($array['background_url'], FILTER_VALIDATE_URL) || empty($array['background_url']) ){\r\n+                //Updating User Background\r\n+                $uquery_field[] = 'background_url';\r\n+                $uquery_val[] = $array['background_url'];\r\n+            } else {\r\n+                e(lang('incorrect_url'));\r\n+            }\r\n         }\r\n \r\n         $uquery_field[] = 'background_color';\r\n@@ -2918,9 +2923,10 @@ function update_user_avatar_bg($array)\n             $uquery_field[] = 'background_repeat';\r\n             $uquery_val[] = $array['background_repeat'];\r\n         }\r\n+        */\r\n \r\n-        if (isset($_FILES['background_file']['name'])) {\r\n-            $file = $Upload->upload_user_file('b', $_FILES['background_file'], user_id());\r\n+        if( !empty($_FILES['background_file']['name']) ){\r\n+            $file = $Upload->upload_user_file('background', $_FILES['background_file'], user_id());\r\n             if ($file) {\r\n                 $uquery_field[] = 'background';\r\n                 $uquery_val[] = $file;\r"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 1,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 2,
        "max_directory_depth": 3
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "477bd07f555c4b5be6dfe0b64ee7d1fddfd5c280",
            "date": "2025-01-10T11:15:47Z",
            "author_login": "clement-sanz"
          },
          {
            "sha": "5ea3b2fcfaf4a1f9a766bf501083ca5706223714",
            "date": "2025-01-08T19:07:04Z",
            "author_login": "clement-sanz"
          },
          {
            "sha": "cdad2d3ace8f0fd70abd8f31aa83ffed5bdb6453",
            "date": "2025-01-07T14:18:10Z",
            "author_login": "MacWarrior"
          },
          {
            "sha": "893bfb0f1236c4a59b5e2843ab8d27a1e491b12b",
            "date": "2025-01-06T18:09:07Z",
            "author_login": "MacWarrior"
          },
          {
            "sha": "75d663f010cd8569eb9e278f030838174fb30188",
            "date": "2025-01-06T17:27:30Z",
            "author_login": "MacWarrior"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 7.5,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H",
    "cwe_id": "CWE-22",
    "description": "ClipBucket V5 provides open source video hosting with PHP. During the user avatar upload workflow, a user can choose to upload and change their avatar at any time. During deletion, ClipBucket checks for the avatar_url as a filepath within the avatars subdirectory. If the URL path exists within the avatars directory, ClipBucket will delete it. There is no check for path traversal sequences in the provided user input (stored in the DB as avatar_url) therefore the final $file variable could be tainted with path traversal sequences. This leads to file deletion outside of the intended scope of the avatars folder. This vulnerability is fixed in 5.5.1 - 237.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2025-01-07T16:15:40.510",
    "last_modified": "2025-01-07T18:15:21.703",
    "fix_date": "2025-01-05T16:51:23Z"
  },
  "references": [
    {
      "url": "https://github.com/MacWarrior/clipbucket-v5/commit/22329c4675e82c7c95e74024ba247f837ac9e00b",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/MacWarrior/clipbucket-v5/security/advisories/GHSA-5qpx-23rw-36gg",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/MacWarrior/clipbucket-v5/security/advisories/GHSA-5qpx-23rw-36gg",
      "source": "134c704f-9b21-4f2e-91b3-4a467353bcc0",
      "tags": []
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:09:58.217953",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "clipbucket-v5",
    "owner": "MacWarrior",
    "created_at": "2018-04-08T14:51:47Z",
    "updated_at": "2025-01-12T22:31:57Z",
    "pushed_at": "2025-01-14T09:24:32Z",
    "size": 81421,
    "stars": 83,
    "forks": 46,
    "open_issues": 46,
    "watchers": 83,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [],
    "languages": {
      "JavaScript": 6271011,
      "PHP": 3369798,
      "HTML": 1143933,
      "CSS": 340077,
      "Shell": 27670,
      "Batchfile": 18078,
      "Hack": 1729,
      "Roff": 2
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": false,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "other"
    },
    "collected_at": "2025-01-14T18:38:02.366061"
  }
}