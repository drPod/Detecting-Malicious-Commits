{
  "cve_id": "CVE-2025-22132",
  "github_data": {
    "repository": "nilsonLazarin/WeGIA",
    "fix_commit": "330f641db43cfb0c8ea8bb6025cc0732de4d4d6b",
    "related_commits": [
      "330f641db43cfb0c8ea8bb6025cc0732de4d4d6b"
    ],
    "patch_url": "https://github.com/nilsonLazarin/WeGIA/commit/330f641db43cfb0c8ea8bb6025cc0732de4d4d6b.patch",
    "fix_commit_details": {
      "sha": "330f641db43cfb0c8ea8bb6025cc0732de4d4d6b",
      "commit_date": "2025-01-07T14:23:17Z",
      "author": {
        "login": "nilsonLazarin",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Ajustes de seguran\u00e7a https://github.com/nilsonLazarin/WeGIA/security/advisories/GHSA-h8hr-jhcx-fcv9",
        "length": 99,
        "has_description": false,
        "references_issue": false
      },
      "stats": {
        "total": 106,
        "additions": 81,
        "deletions": 25
      },
      "files": [
        {
          "filename": "html/socio/sistema/controller/.htaccess",
          "status": "added",
          "additions": 5,
          "deletions": 0,
          "patch": "@@ -0,0 +1,5 @@\n+<Files *>\n+    SetHandler none\n+    SetHandler default-handler\n+    Options -ExecCGI\n+</Files>\n\\ No newline at end of file"
        },
        {
          "filename": "html/socio/sistema/controller/controla_xlsx.php",
          "status": "modified",
          "additions": 76,
          "deletions": 25,
          "patch": "@@ -1,30 +1,81 @@\n <?php\n-    $r = array(\n-        \"resultado\"=> false,\n-        \"url\"=> null\n-    );\n-    if(!is_dir(\"../tabelas/\")){\n-        if(mkdir(\"../tabelas\")){\n-            mkdir(\"../tabelas/cobrancas/\");\n-        }\n+// Inicializa a resposta padr\u00e3o\n+$r = array(\n+    \"resultado\" => false,\n+    \"mensagem\" => \"Ocorreu um erro ao processar o arquivo.\"\n+);\n+\n+// Diret\u00f3rio seguro para armazenamento de arquivos\n+$diretorio = \"../tabelas/\";\n+\n+// Cria os diret\u00f3rios necess\u00e1rios, se n\u00e3o existirem\n+if (!is_dir($diretorio)) {\n+    if (!mkdir($diretorio, 0755, true)) {\n+        $r['mensagem'] = \"Erro ao criar diret\u00f3rio de upload.\";\n+        echo json_encode($r);\n+        exit;\n+    }\n+}\n+\n+if (!empty($_FILES['arquivo']['name'])) {\n+    // Lista de extens\u00f5es e tipos MIME permitidos\n+    $extensoesPermitidas = array('jpg', 'jpeg', 'png', 'gif');\n+    $tiposMimePermitidos = array('image/jpeg', 'image/png', 'image/gif');\n+\n+    // Obt\u00e9m o nome e extens\u00e3o do arquivo\n+    $file_name_original = basename($_FILES['arquivo']['name']);\n+    $extensao = strtolower(pathinfo($file_name_original, PATHINFO_EXTENSION));\n+\n+    // Verifica se a extens\u00e3o \u00e9 permitida\n+    if (!in_array($extensao, $extensoesPermitidas)) {\n+        $r['mensagem'] = \"Extens\u00e3o de arquivo n\u00e3o permitida.\";\n+        echo json_encode($r);\n+        exit;\n     }\n-    if(!empty($_FILES['arquivo']['name'])){\n-        $bloqueados = array('php', 'exe', 'sh', 'bat', 'js', 'html', 'htm');\n-        $extensao = strtolower(pathinfo($_FILES['arquivo']['name'], PATHINFO_EXTENSION));\n-\n-        if (!in_array($extensao, $bloqueados)) {\n-            $file_name = preg_replace(\"/[^a-zA-Z0-9\\._-]/\", \"_\", basename($_FILES['arquivo']['name']));\n-\n-             if (move_uploaded_file($_FILES['arquivo']['tmp_name'], \"../tabelas/\".$file_name)) {\n-                $r['resultado'] = true;\n-                $r['url'] = \"./tabelas/\".htmlspecialchars($file_name, ENT_QUOTES, 'UTF-8');\n-            } else {\n-            $r['url'] = \"Erro ao mover o arquivo.\";\n-            }\n-        } else {\n-        $r['url'] = \"Tipo de arquivo n\u00e3o permitido.\";\n-        }\n+\n+    // Obt\u00e9m o tipo MIME do arquivo\n+    $finfo = finfo_open(FILEINFO_MIME_TYPE);\n+    $tipoMime = finfo_file($finfo, $_FILES['arquivo']['tmp_name']);\n+    finfo_close($finfo);\n+\n+    // Verifica se o tipo MIME \u00e9 permitido\n+    if (!in_array($tipoMime, $tiposMimePermitidos)) {\n+        $r['mensagem'] = \"Tipo de arquivo inv\u00e1lido.\";\n+        echo json_encode($r);\n+        exit;\n+    }\n+\n+    // Sanitiza e gera um nome de arquivo \u00fanico\n+    $file_name_sanitized = preg_replace(\"/[^a-zA-Z0-9\\._-]/\", \"_\", pathinfo($file_name_original, PATHINFO_FILENAME));\n+    $file_name = uniqid() . \"_\" . $file_name_sanitized . '.' . $extensao;\n+\n+    // Verifica se o arquivo j\u00e1 existe (mesmo com nomes \u00fanicos, esta \u00e9 uma garantia extra)\n+    $destino = $diretorio . $file_name;\n+    if (file_exists($destino)) {\n+        $r['mensagem'] = \"Um arquivo com o mesmo nome j\u00e1 existe.\";\n+        echo json_encode($r);\n+        exit;\n+    }\n+\n+    // Verifica se o arquivo \u00e9 realmente uma imagem v\u00e1lida\n+    if (!getimagesize($_FILES['arquivo']['tmp_name'])) {\n+        $r['mensagem'] = \"O arquivo enviado n\u00e3o \u00e9 uma imagem v\u00e1lida.\";\n+        echo json_encode($r);\n+        exit;\n+    }\n+\n+    // Move o arquivo para o diret\u00f3rio seguro\n+    if (move_uploaded_file($_FILES['arquivo']['tmp_name'], $destino)) {\n+        $r['resultado'] = true;\n+        $r['mensagem'] = \"Upload realizado com sucesso.\";\n+        $r['url'] = \"./tabelas/\" . urlencode($file_name); // Codifica a URL para evitar problemas\n+    } else {\n+        $r['mensagem'] = \"Erro ao mover o arquivo para o diret\u00f3rio de destino.\";\n     }\n+} else {\n+    $r['mensagem'] = \"Nenhum arquivo foi enviado.\";\n+}\n \n-    echo(json_encode($r))\n+// Retorna a resposta em JSON\n+echo json_encode($r);\n ?>\n\\ No newline at end of file"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 1,
        "max_directory_depth": 4
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "8d6b3970267476a35a6973dec6f5ca00200fa29b",
            "date": "2025-01-13T20:51:58Z",
            "author_login": "nilsonLazarin"
          },
          {
            "sha": "57334302b178819a9f951dfb13054ff20bae8a63",
            "date": "2025-01-13T10:22:49Z",
            "author_login": "GabrielPintoSouza"
          },
          {
            "sha": "c6ccdec8d7486199744664ff17426d4449f8e805",
            "date": "2025-01-11T22:26:59Z",
            "author_login": "nilsonLazarin"
          },
          {
            "sha": "912d926faac3c03d5499546e95ed97c0931d71fc",
            "date": "2025-01-10T15:23:35Z",
            "author_login": "GabrielPintoSouza"
          },
          {
            "sha": "8c55924d88efc78e2b3fd2167bb928a677195a89",
            "date": "2025-01-10T14:52:51Z",
            "author_login": "GabrielPintoSouza"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 8.3,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:H/UI:R/S:C/C:H/I:H/A:L",
    "cwe_id": "CWE-79",
    "description": "WeGIA is a web manager for charitable institutions. A Cross-Site Scripting (XSS) vulnerability was identified in the file upload functionality of the WeGIA/html/socio/sistema/controller/controla_xlsx.php endpoint. By uploading a file containing malicious JavaScript code, an attacker can execute arbitrary scripts in the context of a victim's browser. This can lead to information theft, session hijacking, and other forms of client-side exploitation. This vulnerability is fixed in 3.2.7.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2025-01-07T22:15:31.590",
    "last_modified": "2025-01-07T22:15:31.590",
    "fix_date": "2025-01-07T14:23:17Z"
  },
  "references": [
    {
      "url": "https://github.com/nilsonLazarin/WeGIA/commit/330f641db43cfb0c8ea8bb6025cc0732de4d4d6b",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/nilsonLazarin/WeGIA/security/advisories/GHSA-h8hr-jhcx-fcv9",
      "source": "security-advisories@github.com",
      "tags": []
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:09:58.225022",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "WeGIA",
    "owner": "nilsonLazarin",
    "created_at": "2019-03-16T03:16:05Z",
    "updated_at": "2025-01-13T20:52:10Z",
    "pushed_at": "2025-01-13T20:56:26Z",
    "size": 103356,
    "stars": 6,
    "forks": 6,
    "open_issues": 333,
    "watchers": 6,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "master"
    ],
    "languages": {
      "PHP": 3149050,
      "HTML": 1596217,
      "CSS": 1249569,
      "JavaScript": 863054,
      "Less": 625377,
      "SCSS": 625102,
      "Hack": 55339
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "cc-by-4.0"
    },
    "collected_at": "2025-01-14T14:22:11.810230"
  }
}