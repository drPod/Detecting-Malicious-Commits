{
  "cve_id": "CVE-2025-22133",
  "github_data": {
    "repository": "nilsonLazarin/WeGIA",
    "fix_commit": "a08f04de96d3caec85496d7a89a5b82d1960d9dd",
    "related_commits": [
      "a08f04de96d3caec85496d7a89a5b82d1960d9dd"
    ],
    "patch_url": "https://github.com/nilsonLazarin/WeGIA/commit/a08f04de96d3caec85496d7a89a5b82d1960d9dd.patch",
    "fix_commit_details": {
      "sha": "a08f04de96d3caec85496d7a89a5b82d1960d9dd",
      "commit_date": "2025-01-07T21:48:12Z",
      "author": {
        "login": "nilsonLazarin",
        "type": "User",
        "stats": null
      },
      "commit_message": {
        "title": "Merge commit from fork",
        "length": 94,
        "has_description": true,
        "references_issue": false
      },
      "stats": {
        "total": 91,
        "additions": 37,
        "deletions": 54
      },
      "files": [
        {
          "filename": "html/socio/sistema/controller/controla_xlsx.php",
          "status": "modified",
          "additions": 33,
          "deletions": 53,
          "patch": "@@ -1,8 +1,9 @@\n <?php\n-//verificar privil\u00e9gios do solicitante\n+// Inicia a sess\u00e3o\n session_start();\n require_once(dirname(__DIR__, 3) . '/permissao/permissao.php');\n \n+// Verifica se o usu\u00e1rio est\u00e1 logado\n if (!isset($_SESSION['id_pessoa'])) {\n     http_response_code(401);\n     echo json_encode(['erro' => 'Acesso n\u00e3o autorizado, usu\u00e1rio n\u00e3o est\u00e1 logado.']);\n@@ -11,66 +12,49 @@\n \n permissao($_SESSION['id_pessoa'], 4, 3);\n \n-    // Inicializa a resposta padr\u00e3o\n-    $r = array(\n-        \"resultado\" => false,\n-        \"mensagem\" => \"Ocorreu um erro ao processar o arquivo.\"\n-    );\n-\n-    // Diret\u00f3rio seguro para armazenamento de arquivos\n-    $diretorio = \"../tabelas/\";\n-\n-    // Cria os diret\u00f3rios necess\u00e1rios, se n\u00e3o existirem\n-    if (!is_dir($diretorio)) {\n-        if (!mkdir($diretorio, 0755, true)) {\n-            $r['mensagem'] = \"Erro ao criar diret\u00f3rio de upload.\";\n-            echo json_encode($r);\n-            exit;\n-        }\n-    }\n+// Inicializa a resposta padr\u00e3o\n+$r = array(\n+    \"resultado\" => false,\n+    \"mensagem\" => \"Ocorreu um erro ao processar o arquivo.\"\n+);\n \n-    if (!empty($_FILES['arquivo']['name'])) {\n-        // Lista de extens\u00f5es e tipos MIME permitidos\n-        $extensoesPermitidas = array('jpg', 'jpeg', 'png', 'gif');\n-        $tiposMimePermitidos = array('image/jpeg', 'image/png', 'image/gif');\n+// Diret\u00f3rio seguro para armazenamento de arquivos\n+$diretorio = \"../tabelas/\";\n \n-        // Obt\u00e9m o nome e extens\u00e3o do arquivo\n-        $file_name_original = basename($_FILES['arquivo']['name']);\n-        $extensao = strtolower(pathinfo($file_name_original, PATHINFO_EXTENSION));\n-\n-        if (in_array($extensao, $permitidos)) {\n-            $file_name = preg_replace(\"/[^a-zA-Z0-9\\._-]/\", \"_\", basename($_FILES['arquivo']['name']));\n-\n-            if (move_uploaded_file($_FILES['arquivo']['tmp_name'], \"../tabelas/\" . $file_name)) {\n-                $r['resultado'] = true;\n-                $r['url'] = \"./tabelas/\" . htmlspecialchars($file_name, ENT_QUOTES, 'UTF-8');\n-            } else {\n-                $r['url'] = \"Erro ao mover o arquivo.\";\n-            }\n-        } else {\n-            $r['url'] = \"Tipo de arquivo n\u00e3o permitido.\";\n-        }\n-    }\n-    // Verifica se a extens\u00e3o \u00e9 permitida\n-    if (!in_array($extensao, $extensoesPermitidas)) {\n-        $r['mensagem'] = \"Extens\u00e3o de arquivo n\u00e3o permitida.\";\n+// Cria o diret\u00f3rio, se n\u00e3o existir\n+if (!is_dir($diretorio)) {\n+    if (!mkdir($diretorio, 0755, true)) {\n+        $r['mensagem'] = \"Erro ao criar diret\u00f3rio de upload.\";\n         echo json_encode($r);\n         exit;\n     }\n+}\n+\n+if (!empty($_FILES['arquivo']['name'])) {\n+    // Tipos MIME permitidos para arquivos Excel (.xls e .xlsx)\n+    $tiposMimePermitidos = array(\n+        'application/vnd.ms-excel', // Para .xls\n+        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' // Para .xlsx\n+    );\n \n     // Obt\u00e9m o tipo MIME do arquivo\n     $finfo = finfo_open(FILEINFO_MIME_TYPE);\n     $tipoMime = finfo_file($finfo, $_FILES['arquivo']['tmp_name']);\n     finfo_close($finfo);\n \n-    // Verifica se o tipo MIME \u00e9 permitido\n+    // Verifica se o tipo MIME do arquivo \u00e9 permitido\n     if (!in_array($tipoMime, $tiposMimePermitidos)) {\n-        $r['mensagem'] = \"Tipo de arquivo inv\u00e1lido.\";\n+        http_response_code(400);\n+        $r['mensagem'] = \"Tipo de arquivo inv\u00e1lido. Apenas arquivos .xls e .xlsx s\u00e3o permitidos.\";\n         echo json_encode($r);\n         exit;\n     }\n \n-    // Sanitiza e gera um nome de arquivo \u00fanico\n+    // Obt\u00e9m o nome e a extens\u00e3o do arquivo\n+    $file_name_original = basename($_FILES['arquivo']['name']);\n+    $extensao = strtolower(pathinfo($file_name_original, PATHINFO_EXTENSION));\n+\n+    // Sanitiza o nome do arquivo para evitar problemas com caracteres especiais\n     $file_name_sanitized = preg_replace(\"/[^a-zA-Z0-9\\._-]/\", \"_\", pathinfo($file_name_original, PATHINFO_FILENAME));\n     $file_name = uniqid() . \"_\" . $file_name_sanitized . '.' . $extensao;\n \n@@ -82,13 +66,6 @@\n         exit;\n     }\n \n-    // Verifica se o arquivo \u00e9 realmente uma imagem v\u00e1lida\n-    if (!getimagesize($_FILES['arquivo']['tmp_name'])) {\n-        $r['mensagem'] = \"O arquivo enviado n\u00e3o \u00e9 uma imagem v\u00e1lida.\";\n-        echo json_encode($r);\n-        exit;\n-    }\n-\n     // Move o arquivo para o diret\u00f3rio seguro\n     if (move_uploaded_file($_FILES['arquivo']['tmp_name'], $destino)) {\n         $r['resultado'] = true;\n@@ -97,5 +74,8 @@\n     } else {\n         $r['mensagem'] = \"Erro ao mover o arquivo para o diret\u00f3rio de destino.\";\n     }\n+}\n \n-echo (json_encode($r));\n+// Retorna a resposta em formato JSON\n+echo json_encode($r);\n+?>"
        },
        {
          "filename": "html/socio/sistema/controller/script/sistema.js",
          "status": "modified",
          "additions": 3,
          "deletions": 0,
          "patch": "@@ -963,7 +963,10 @@ $(document).ready(function(){\n \n                 oReq.send();\n \n+            }else{\n+                request.abort();\n             }\n+            \n       }\n     }\n     // Upload de cobran\u00e7as xlsx"
        },
        {
          "filename": "html/socio/sistema/tabelas/index.php",
          "status": "modified",
          "additions": 1,
          "deletions": 1,
          "patch": "@@ -1,4 +1,4 @@\n <?php\n-require_once '../../../config.php';\n+require_once '../../../../config.php';\n header('Location: ' . WWW);\n exit;"
        }
      ],
      "file_patterns": {
        "security_files": 0,
        "config_files": 0,
        "dependency_files": 0,
        "test_files": 0,
        "unique_directories": 3,
        "max_directory_depth": 5
      },
      "context": {
        "surrounding_commits": [
          {
            "sha": "8d6b3970267476a35a6973dec6f5ca00200fa29b",
            "date": "2025-01-13T20:51:58Z",
            "author_login": "nilsonLazarin"
          },
          {
            "sha": "57334302b178819a9f951dfb13054ff20bae8a63",
            "date": "2025-01-13T10:22:49Z",
            "author_login": "GabrielPintoSouza"
          },
          {
            "sha": "c6ccdec8d7486199744664ff17426d4449f8e805",
            "date": "2025-01-11T22:26:59Z",
            "author_login": "nilsonLazarin"
          },
          {
            "sha": "912d926faac3c03d5499546e95ed97c0931d71fc",
            "date": "2025-01-10T15:23:35Z",
            "author_login": "GabrielPintoSouza"
          },
          {
            "sha": "8c55924d88efc78e2b3fd2167bb928a677195a89",
            "date": "2025-01-10T14:52:51Z",
            "author_login": "GabrielPintoSouza"
          }
        ]
      }
    }
  },
  "vulnerability_details": {
    "cvss_score": 9.9,
    "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H",
    "cwe_id": "CWE-94",
    "description": "WeGIA is a web manager for charitable institutions. Prior to 3.2.8, a critical vulnerability was identified in the /WeGIA/html/socio/sistema/controller/controla_xlsx.php endpoint. The endpoint accepts file uploads without proper validation, allowing the upload of malicious files, such as .phar, which can then be executed by the server. This vulnerability is fixed in 3.2.8.",
    "attack_vector": "NETWORK",
    "attack_complexity": "LOW"
  },
  "temporal_data": {
    "published_date": "2025-01-07T22:15:31.740",
    "last_modified": "2025-01-08T15:15:21.727",
    "fix_date": "2025-01-07T21:48:12Z"
  },
  "references": [
    {
      "url": "https://github.com/nilsonLazarin/WeGIA/commit/a08f04de96d3caec85496d7a89a5b82d1960d9dd",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/nilsonLazarin/WeGIA/security/advisories/GHSA-mjgr-2jxv-v8qf",
      "source": "security-advisories@github.com",
      "tags": []
    },
    {
      "url": "https://github.com/nilsonLazarin/WeGIA/security/advisories/GHSA-mjgr-2jxv-v8qf",
      "source": "134c704f-9b21-4f2e-91b3-4a467353bcc0",
      "tags": []
    }
  ],
  "collection_metadata": {
    "collected_at": "2025-01-11T23:09:58.225288",
    "processing_status": "raw"
  },
  "repository_context": {
    "name": "WeGIA",
    "owner": "nilsonLazarin",
    "created_at": "2019-03-16T03:16:05Z",
    "updated_at": "2025-01-13T20:52:10Z",
    "pushed_at": "2025-01-13T20:56:26Z",
    "size": 103356,
    "stars": 6,
    "forks": 6,
    "open_issues": 333,
    "watchers": 6,
    "has_security_policy": false,
    "default_branch": "master",
    "protected_branches": [
      "master"
    ],
    "languages": {
      "PHP": 3149050,
      "HTML": 1596217,
      "CSS": 1249569,
      "JavaScript": 863054,
      "Less": 625377,
      "SCSS": 625102,
      "Hack": 55339
    },
    "commit_activity": {
      "total_commits_last_year": 0,
      "avg_commits_per_week": 0,
      "days_active_last_year": 0
    },
    "security_features": {
      "has_security_policy": false,
      "has_protected_branches": true,
      "has_wiki": true,
      "has_issues": true,
      "allow_forking": true,
      "is_template": false,
      "license": "cc-by-4.0"
    },
    "collected_at": "2025-01-14T14:22:11.810230"
  }
}